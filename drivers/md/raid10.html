<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › raid10.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>raid10.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * raid10.c : Multiple Devices driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2004 Neil Brown</span>
<span class="cm"> *</span>
<span class="cm"> * RAID-10 support for md.</span>
<span class="cm"> *</span>
<span class="cm"> * Base on code in raid1.c.  See raid1.c for further copyright information.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * (for example /usr/src/linux/COPYING); if not, write to the Free</span>
<span class="cm"> * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;raid10.h&quot;</span>
<span class="cp">#include &quot;raid0.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * RAID10 provides a combination of RAID0 and RAID1 functionality.</span>
<span class="cm"> * The layout of data is defined by</span>
<span class="cm"> *    chunk_size</span>
<span class="cm"> *    raid_disks</span>
<span class="cm"> *    near_copies (stored in low byte of layout)</span>
<span class="cm"> *    far_copies (stored in second byte of layout)</span>
<span class="cm"> *    far_offset (stored in bit 16 of layout )</span>
<span class="cm"> *</span>
<span class="cm"> * The data to be stored is divided into chunks using chunksize.</span>
<span class="cm"> * Each device is divided into far_copies sections.</span>
<span class="cm"> * In each section, chunks are laid out in a style similar to raid0, but</span>
<span class="cm"> * near_copies copies of each chunk is stored (each on a different drive).</span>
<span class="cm"> * The starting device for each section is offset near_copies from the starting</span>
<span class="cm"> * device of the previous section.</span>
<span class="cm"> * Thus they are (near_copies*far_copies) of each chunk, and each is on a different</span>
<span class="cm"> * drive.</span>
<span class="cm"> * near_copies and far_copies must be at least one, and their product is at most</span>
<span class="cm"> * raid_disks.</span>
<span class="cm"> *</span>
<span class="cm"> * If far_offset is true, then the far_copies are handled a bit differently.</span>
<span class="cm"> * The copies are still in different stripes, but instead of be very far apart</span>
<span class="cm"> * on disk, there are adjacent stripes.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Number of guaranteed r10bios in case of extreme VM load:</span>
<span class="cm"> */</span>
<span class="cp">#define	NR_RAID10_BIOS 256</span>

<span class="cm">/* When there are this many requests queue to be written by</span>
<span class="cm"> * the raid10 thread, we become &#39;congested&#39; to provide back-pressure</span>
<span class="cm"> * for writeback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queued_requests</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">allow_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lower_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enough</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">);</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="n">reshape_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reshape_request_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">end_reshape_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">end_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="nf">r10bio_pool_alloc</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span><span class="p">,</span> <span class="n">devs</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">]);</span>

	<span class="cm">/* allocate a r10bio with room for raid_disks entries in the</span>
<span class="cm">	 * bios array */</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r10bio_pool_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Maximum size of each resync request */</span>
<span class="cp">#define RESYNC_BLOCK_SIZE (64*1024)</span>
<span class="cp">#define RESYNC_PAGES ((RESYNC_BLOCK_SIZE + PAGE_SIZE-1) / PAGE_SIZE)</span>
<span class="cm">/* amount of memory to reserve for resync requests */</span>
<span class="cp">#define RESYNC_WINDOW (1024*1024)</span>
<span class="cm">/* maximum number of concurrent requests, memory permitting */</span>
<span class="cp">#define RESYNC_DEPTH (32*1024*1024/RESYNC_BLOCK_SIZE)</span>

<span class="cm">/*</span>
<span class="cm"> * When performing a resync, we need to read and compare, so</span>
<span class="cm"> * we need as many pages are there are copies.</span>
<span class="cm"> * When performing a recovery, we need 2 bios, one for read,</span>
<span class="cm"> * one for write (we recover only one drive per r10buf)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="nf">r10buf_pool_alloc</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nalloc</span><span class="p">;</span>

	<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">r10bio_pool_alloc</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r10_bio</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">nalloc</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="cm">/* resync */</span>
	<span class="k">else</span>
		<span class="n">nalloc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* recovery */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate bios.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">nalloc</span> <span class="p">;</span> <span class="n">j</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">RESYNC_PAGES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_bio</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">have_replacement</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">RESYNC_PAGES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_bio</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate RESYNC_PAGES data pages and attach them</span>
<span class="cm">	 * where needed.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nalloc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">rbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* we can share bv_page&#39;s during recovery</span>
<span class="cm">				 * and reshape */</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">rbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">rbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
				<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_free_pages</span><span class="p">;</span>

			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rbio</span><span class="p">)</span>
				<span class="n">rbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r10_bio</span><span class="p">;</span>

<span class="nl">out_free_pages:</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">safe_put_page</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">safe_put_page</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_bio:</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nalloc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="p">)</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">)</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r10bio_pool_free</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r10buf_pool_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">__r10_bio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10bio</span> <span class="o">=</span> <span class="n">__r10_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">safe_put_page</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r10bio_pool_free</span><span class="p">(</span><span class="n">r10bio</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_all_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">bio</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BIO_SPECIAL</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">))</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BIO_SPECIAL</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">))</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_r10bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">put_all_bios</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">mempool_free</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">);</span>

	<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reschedule_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* wake up frozen array... */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>

	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * raid_end_bio_io() is called when we have finished servicing a mirrored</span>
<span class="cm"> * operation and are ready to return a success/failure code to the buffer</span>
<span class="cm"> * cache layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_end_bio_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">--</span><span class="p">;</span>
		<span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wake up any possible resync thread that waits for the device</span>
<span class="cm">		 * to go idle.</span>
<span class="cm">		 */</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_r10bio</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update disk head position estimator based on IRQ completion info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_head_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">].</span><span class="n">head_position</span> <span class="o">=</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the disk number which triggered given bio</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_bio_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">slotp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">replp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">repl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">==</span> <span class="n">bio</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">==</span> <span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">repl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">);</span>
	<span class="n">update_head_pos</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slotp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">slotp</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">replp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">replp</span> <span class="o">=</span> <span class="n">repl</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10_end_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>


	<span class="n">slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * this branch is our &#39;one mirror IO has finished&#39; event handler:</span>
<span class="cm">	 */</span>
	<span class="n">update_head_pos</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set R10BIO_Uptodate in our master bio, so that</span>
<span class="cm">		 * we will return a good error code to the higher</span>
<span class="cm">		 * levels even if IO on some other mirrored buffer fails.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The &#39;master&#39; represents the composite IO operation to</span>
<span class="cm">		 * user-side. So if something waits for IO, then it will</span>
<span class="cm">		 * wait for the &#39;master&#39; bio.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If all other devices that store this block have</span>
<span class="cm">		 * failed, we want to return the error upwards rather</span>
<span class="cm">		 * than fail the last device.  Here we redefine</span>
<span class="cm">		 * &quot;uptodate&quot; to mean &quot;Don&#39;t want to retry&quot;</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">))</span>
			<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * oops, read error - keep the refcount on the rdev</span>
<span class="cm">		 */</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;md/raid10:%s: %s: rescheduling sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
				   <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear the bitmap if all writes complete successfully */</span>
	<span class="n">bitmap_endwrite</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">);</span>
	<span class="n">md_write_end</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">one_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">close_write</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10_end_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dec_rdev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">repl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_rmb</span><span class="p">();</span>
		<span class="n">repl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * this branch is our &#39;one mirror IO has finished&#39; event handler:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
			<span class="cm">/* Never record new bad blocks to replacement,</span>
<span class="cm">			 * just fail it.</span>
<span class="cm">			 */</span>
			<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">dec_rdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set R10BIO_Uptodate in our master bio, so that</span>
<span class="cm">		 * we will return a good error code for to the higher</span>
<span class="cm">		 * levels even if IO on some other mirrored buffer fails.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The &#39;master&#39; represents the composite IO operation to</span>
<span class="cm">		 * user-side. So if something waits for IO, then it will</span>
<span class="cm">		 * wait for the &#39;master&#39; bio.</span>
<span class="cm">		 */</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* Maybe we can clear some bad blocks. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">=</span> <span class="n">IO_MADE_GOOD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">IO_MADE_GOOD</span><span class="p">;</span>
			<span class="n">dec_rdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *</span>
<span class="cm">	 * Let&#39;s see if all mirrored write operations have finished</span>
<span class="cm">	 * already.</span>
<span class="cm">	 */</span>
	<span class="n">one_write_done</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dec_rdev</span><span class="p">)</span>
		<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RAID10 layout manager</span>
<span class="cm"> * As well as the chunksize and raid_disks count, there are two</span>
<span class="cm"> * parameters: near_copies and far_copies.</span>
<span class="cm"> * near_copies * far_copies must be &lt;= raid_disks.</span>
<span class="cm"> * Normally one of these will be 1.</span>
<span class="cm"> * If both are 1, we get raid0.</span>
<span class="cm"> * If near_copies == raid_disks, we get raid1.</span>
<span class="cm"> *</span>
<span class="cm"> * Chunks are laid out in raid0 style with near_copies copies of the</span>
<span class="cm"> * first chunk, followed by near_copies copies of the next chunk and</span>
<span class="cm"> * so on.</span>
<span class="cm"> * If far_copies &gt; 1, then after 1/far_copies of the array has been assigned</span>
<span class="cm"> * as described above, we start again with a device offset of near_copies.</span>
<span class="cm"> * So we effectively have another copy of the whole array further down all</span>
<span class="cm"> * the drives, but with blocks on different drives.</span>
<span class="cm"> * With this layout, and block is never stored twice on the one device.</span>
<span class="cm"> *</span>
<span class="cm"> * raid10_find_phys finds the sector offset of a given virtual sector</span>
<span class="cm"> * on each device that it is on.</span>
<span class="cm"> *</span>
<span class="cm"> * raid10_find_virt does the reverse mapping, from a device and a</span>
<span class="cm"> * sector offset to a virtual address</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__raid10_find_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">f</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">stripe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* now calculate first sector/dev */</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_mask</span><span class="p">;</span>

	<span class="n">chunk</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
	<span class="n">stripe</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_offset</span><span class="p">)</span>
		<span class="n">stripe</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">+=</span> <span class="n">stripe</span> <span class="o">&lt;&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>

	<span class="cm">/* and calculate all the others */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
		<span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
		<span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">+=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">-=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">+=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">;</span>
			<span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">slot</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sector</span> <span class="o">+=</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10_find_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Previous</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R10BIO_Previous</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">__raid10_find_phys</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">r10bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">raid10_find_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">vchunk</span><span class="p">;</span>
	<span class="cm">/* Never use conf-&gt;prev as this is only called during resync</span>
<span class="cm">	 * or recovery, so reshape isn&#39;t happening</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&amp;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fc</span><span class="p">;</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">-=</span> <span class="n">fc</span> <span class="o">*</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">+=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sector</span> <span class="o">-=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">)</span>
				<span class="n">dev</span> <span class="o">+=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span> <span class="o">-=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">&gt;&gt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vchunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">*</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">vchunk</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vchunk</span> <span class="o">&lt;&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	raid10_mergeable_bvec -- tell bio layer if a two requests can be merged</span>
<span class="cm"> *	@q: request queue</span>
<span class="cm"> *	@bvm: properties of new bio</span>
<span class="cm"> *	@biovec: the request that could be merged to it.</span>
<span class="cm"> *</span>
<span class="cm"> *	Return amount of bytes we can accept at this offset</span>
<span class="cm"> *	This requires checking for end-of-chunk if near_copies != raid_disks,</span>
<span class="cm"> *	and for subordinate merge_bvec_fns if merge_check_needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_mergeable_bvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bvec_merge_data</span> <span class="o">*</span><span class="n">bvm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">biovec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bio_sectors</span> <span class="o">=</span> <span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>

	<span class="n">chunk_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span> <span class="o">&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">))</span>
		<span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span> <span class="o">&lt;</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="p">((</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
					<span class="o">+</span> <span class="n">bio_sectors</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* bio_add cannot handle a negative return */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;&amp;</span> <span class="n">bio_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r10bio</span> <span class="n">r10_bio</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot give any guidance during reshape */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;&amp;</span> <span class="n">bio_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r10_bio</span><span class="p">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
		<span class="n">raid10_find_phys</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">disk</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span>
					<span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">addr</span>
						<span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
					<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">(</span>
							  <span class="n">q</span><span class="p">,</span> <span class="n">bvm</span><span class="p">,</span> <span class="n">biovec</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span>
					<span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">addr</span>
						<span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
					<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">(</span>
							  <span class="n">q</span><span class="p">,</span> <span class="n">bvm</span><span class="p">,</span> <span class="n">biovec</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine returns the disk from which the requested read should</span>
<span class="cm"> * be done. There is a per-array &#39;next expected sequential IO&#39; sector</span>
<span class="cm"> * number - if this matches on the next IO then we use the last disk.</span>
<span class="cm"> * There is also a per-disk &#39;last know head position&#39; sector that is</span>
<span class="cm"> * maintained from IRQ contexts, both the normal and the resync IO</span>
<span class="cm"> * completion handlers update this position correctly. If there is no</span>
<span class="cm"> * perfect sequential match then we pick the disk whose head is closest.</span>
<span class="cm"> *</span>
<span class="cm"> * If there are 2 mirrors in the same 2 devices, performance degrades</span>
<span class="cm"> * because position is mirror, not device based.</span>
<span class="cm"> *</span>
<span class="cm"> * The rdev for the device selected will have nr_pending incremented.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: possibly should rethink readbalancing and do it differently</span>
<span class="cm"> * depending on near_copies / far_copies geometry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="nf">read_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="o">*</span><span class="n">max_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">this_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disk</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_good_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">new_distance</span><span class="p">,</span> <span class="n">best_dist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">best_rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_balance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>

	<span class="n">raid10_find_phys</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
<span class="nl">retry:</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">best_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">best_rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">best_dist</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">do_balance</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if we can balance. We can balance on the whole</span>
<span class="cm">	 * device if no resync is going on (recovery is ok), or below</span>
<span class="cm">	 * the resync window. We take the first readable disk when</span>
<span class="cm">	 * above the resync window.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;</span> <span class="n">MaxSector</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span><span class="p">))</span>
		<span class="n">do_balance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span> <span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">dev_sector</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">==</span> <span class="n">IO_BLOCKED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">disk</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">)</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev_sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">best_dist</span> <span class="o">&lt;</span> <span class="n">MaxSector</span><span class="p">)</span>
				<span class="cm">/* Already have a better slot */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&lt;=</span> <span class="n">dev_sector</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cannot read here.  If this is the</span>
<span class="cm">				 * &#39;primary&#39; device, then we must not read</span>
<span class="cm">				 * beyond &#39;bad_sectors&#39; from another device.</span>
<span class="cm">				 */</span>
				<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">dev_sector</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_balance</span> <span class="o">&amp;&amp;</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">bad_sectors</span><span class="p">)</span>
					<span class="n">sectors</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">best_good_sectors</span> <span class="o">&gt;</span> <span class="n">sectors</span><span class="p">)</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sector_t</span> <span class="n">good_sectors</span> <span class="o">=</span>
					<span class="n">first_bad</span> <span class="o">-</span> <span class="n">dev_sector</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">good_sectors</span> <span class="o">&gt;</span> <span class="n">best_good_sectors</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">good_sectors</span><span class="p">;</span>
					<span class="n">best_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
					<span class="n">best_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_balance</span><span class="p">)</span>
					<span class="cm">/* Must read from here */</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_balance</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* This optimisation is debatable, and completely destroys</span>
<span class="cm">		 * sequential read speed for &#39;far copies&#39; arrays.  So only</span>
<span class="cm">		 * keep it for &#39;near&#39; arrays, and review those later.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* for far &gt; 1 always use the lowest address */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">new_distance</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_distance</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">-</span>
					   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">head_position</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_distance</span> <span class="o">&lt;</span> <span class="n">best_dist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_dist</span> <span class="o">=</span> <span class="n">new_distance</span><span class="p">;</span>
			<span class="n">best_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
			<span class="n">best_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">best_slot</span><span class="p">;</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">best_rdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Cannot risk returning a device that failed</span>
<span class="cm">			 * before we inc&#39;ed nr_pending</span>
<span class="cm">			 */</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">best_good_sectors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_congested</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BDI_async_congested</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&gt;=</span> <span class="n">max_queued_requests</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev_congested</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">|=</span> <span class="n">bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_pending_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Any writes that have been queued but are awaiting</span>
<span class="cm">	 * bitmap updates get flushed here.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="cm">/* flush any pending bitmap writes to disk</span>
<span class="cm">		 * before proceeding w/ I/O */</span>
		<span class="n">bitmap_unplug</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* submit pending writes */</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Barriers....</span>
<span class="cm"> * Sometimes we need to suspend IO while we do something else,</span>
<span class="cm"> * either some resync/recovery, or reconfigure the array.</span>
<span class="cm"> * To do this we raise a &#39;barrier&#39;.</span>
<span class="cm"> * The &#39;barrier&#39; is a counter that can be raised multiple times</span>
<span class="cm"> * to count how many activities are happening which preclude</span>
<span class="cm"> * normal IO.</span>
<span class="cm"> * We can only raise the barrier if there is no pending IO.</span>
<span class="cm"> * i.e. if nr_pending == 0.</span>
<span class="cm"> * We choose only to raise the barrier if no-one is waiting for the</span>
<span class="cm"> * barrier to go down.  This means that as soon as an IO request</span>
<span class="cm"> * is ready, no other operations which require a barrier will start</span>
<span class="cm"> * until the IO request has had a chance.</span>
<span class="cm"> *</span>
<span class="cm"> * So: regular IO calls &#39;wait_barrier&#39;.  When that returns there</span>
<span class="cm"> *    is no backgroup IO happening,  It must arrange to call</span>
<span class="cm"> *    allow_barrier when it has finished its IO.</span>
<span class="cm"> * backgroup IO calls must call raise_barrier.  Once that returns</span>
<span class="cm"> *    there is no normal IO happeing.  It must arrange to call</span>
<span class="cm"> *    lower_barrier when the particular background IO completes.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raise_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>

	<span class="cm">/* Wait until no block IO is waiting (unless &#39;force&#39;) */</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span> <span class="n">force</span> <span class="o">||</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="p">);</span>

	<span class="cm">/* block any new IO from starting */</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Now wait for all pending IO to complete */</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">&lt;</span> <span class="n">RESYNC_DEPTH</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lower_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Wait for the barrier to drop.</span>
<span class="cm">		 * However if there are already pending</span>
<span class="cm">		 * requests (preventing the barrier from</span>
<span class="cm">		 * rising completely), and the</span>
<span class="cm">		 * pre-process bio queue isn&#39;t empty,</span>
<span class="cm">		 * then don&#39;t wait, as we need to empty</span>
<span class="cm">		 * that queue to get the nr_pending</span>
<span class="cm">		 * count down.</span>
<span class="cm">		 */</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
				    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">&amp;&amp;</span>
				     <span class="n">current</span><span class="o">-&gt;</span><span class="n">bio_list</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">bio_list_empty</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">bio_list</span><span class="p">)),</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span>
			<span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">allow_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">freeze_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop syncio and normal IO and wait for everything to</span>
<span class="cm">	 * go quiet.</span>
<span class="cm">	 * We increment barrier and nr_waiting, and then</span>
<span class="cm">	 * wait until nr_pending match nr_queued+1</span>
<span class="cm">	 * This is called in the context of one normal IO request</span>
<span class="cm">	 * that has failed. Thus any sync request that might be pending</span>
<span class="cm">	 * will be blocked by nr_pending, and we need to wait for</span>
<span class="cm">	 * pending IO requests to complete or be queued for re-try.</span>
<span class="cm">	 * Thus the number queued (nr_queued) plus this request (1)</span>
<span class="cm">	 * must match the number of pending IOs (nr_pending) before</span>
<span class="cm">	 * we continue.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">++</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span>
			    <span class="n">flush_pending_writes</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unfreeze_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reverse the effect of the freeze */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">--</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">--</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">choose_data_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Previous</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span> <span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">read_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">chunk_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span> <span class="o">&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chunk_sects</span> <span class="o">=</span> <span class="n">chunk_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_fua</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FUA</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">blocked_rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors_handled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FLUSH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">md_flush_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If this request crosses a chunk boundary, we need to</span>
<span class="cm">	 * split it.  This will only happen for 1 PAGE (or less) requests.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&amp;</span> <span class="n">chunk_mask</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>
		     <span class="o">&gt;</span> <span class="n">chunk_sects</span>
		     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span>
			 <span class="o">||</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">near_copies</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio_pair</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
		<span class="cm">/* Sanity check -- queue functions should prevent this happening */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
		    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad_map</span><span class="p">;</span>
		<span class="cm">/* This is a one page bio that upper layers</span>
<span class="cm">		 * refuse to split for us, so we need to split it.</span>
<span class="cm">		 */</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">bio_split</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span>
			       <span class="n">chunk_sects</span> <span class="o">-</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunk_sects</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">);</span>

		<span class="cm">/* Each of these &#39;make_request&#39; calls will call &#39;wait_barrier&#39;.</span>
<span class="cm">		 * If the first succeeds but the second blocks due to the resync</span>
<span class="cm">		 * thread raising the barrier, we will deadlock because the</span>
<span class="cm">		 * IO to the underlying device will be queued in generic_make_request</span>
<span class="cm">		 * and will never complete, so will never reduce nr_pending.</span>
<span class="cm">		 * So increment nr_waiting here so no new raise_barriers will</span>
<span class="cm">		 * succeed, and so the second wait_barrier cannot block.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>

		<span class="n">make_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio1</span><span class="p">);</span>
		<span class="n">make_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio2</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">--</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>

		<span class="n">bio_pair_release</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">bad_map:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md/raid10:%s: make_request bug: can&#39;t convert block across chunks&quot;</span>
		       <span class="s">&quot; or bigger than %dk %llu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">chunk_sects</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

		<span class="n">bio_io_error</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md_write_start</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the new request and wait if the reconstruction</span>
<span class="cm">	 * thread has put up a bar for new requests.</span>
<span class="cm">	 * Continue immediately if no resync is active currently.</span>
<span class="cm">	 */</span>
	<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">sectors</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IO spans the reshape position.  Need to wait for</span>
<span class="cm">		 * reshape to pass</span>
<span class="cm">		 */</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&lt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">||</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
	     <span class="o">?</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">&amp;&amp;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span>
	     <span class="o">:</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">&amp;&amp;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Need to update reshape_position in metadata */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span>
			   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We might need to issue multiple reads to different</span>
<span class="cm">	 * devices if there are bad blocks around, so we keep</span>
<span class="cm">	 * track of the number of reads in bio-&gt;bi_phys_segments.</span>
<span class="cm">	 * If this is 0, there is only one r10_bio and no locking</span>
<span class="cm">	 * will be needed when the request completes.  If it is</span>
<span class="cm">	 * non-zero, then it is the number of not-completed requests.</span>
<span class="cm">	 */</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_SEG_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * read balancing logic:</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

<span class="nl">read_again:</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">read_balance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>

		<span class="n">read_bio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">read_bio</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
			    <span class="n">max_sectors</span><span class="p">);</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">read_bio</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>

		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
			<span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid10_end_read_request</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">do_sync</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Could not read all from this device, so we will</span>
<span class="cm">			 * need another r10_bio.</span>
<span class="cm">			 */</span>
			<span class="n">sectors_handled</span> <span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">+</span> <span class="n">max_sectors</span>
					   <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="cm">/* Cannot call generic_make_request directly</span>
<span class="cm">			 * as that will be queued in __generic_make_request</span>
<span class="cm">			 * and subsequent mempool_alloc might block</span>
<span class="cm">			 * waiting for it.  so hand bio over to raid10d.</span>
<span class="cm">			 */</span>
			<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>

			<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>
					    <span class="o">-</span> <span class="n">sectors_handled</span><span class="p">);</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">read_again</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">read_bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * WRITE:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&gt;=</span> <span class="n">max_queued_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&lt;</span> <span class="n">max_queued_requests</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* first select target devices under rcu_lock and</span>
<span class="cm">	 * inc refcount on their rdev.  Record them by setting</span>
<span class="cm">	 * bios[x] to bio</span>
<span class="cm">	 * If there are known/acknowledged bad blocks on any device</span>
<span class="cm">	 * on which we have seen a write error, we want to avoid</span>
<span class="cm">	 * writing to those blocks.  This potentially requires several</span>
<span class="cm">	 * writes to write around the bad blocks.  Each set of writes</span>
<span class="cm">	 * gets its own r10_bio with a set of bios attached.  The number</span>
<span class="cm">	 * of r10_bios is recored in bio-&gt;bi_phys_segments just as with</span>
<span class="cm">	 * the read case.</span>
<span class="cm">	 */</span>

	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* make sure repl_bio gets freed */</span>
	<span class="n">raid10_find_phys</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
<span class="nl">retry_write:</span>
	<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rrdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">rrdev</span><span class="p">)</span>
			<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rrdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			      <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
			<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
			<span class="n">sector_t</span> <span class="n">dev_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">is_bad</span><span class="p">;</span>

			<span class="n">is_bad</span> <span class="o">=</span> <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev_sector</span><span class="p">,</span>
					     <span class="n">max_sectors</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Mustn&#39;t write here until the bad block</span>
<span class="cm">				 * is acknowledged</span>
<span class="cm">				 */</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span> <span class="o">&amp;&amp;</span> <span class="n">first_bad</span> <span class="o">&lt;=</span> <span class="n">dev_sector</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cannot write here at all */</span>
				<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">dev_sector</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bad_sectors</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span>
					<span class="cm">/* Mustn&#39;t write more than bad_sectors</span>
<span class="cm">					 * to other devices yet</span>
<span class="cm">					 */</span>
					<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="cm">/* We don&#39;t set R10BIO_Degraded as that</span>
<span class="cm">				 * only applies if the disk is missing,</span>
<span class="cm">				 * so it might be re-added, and we want to</span>
<span class="cm">				 * know to recover this chunk.</span>
<span class="cm">				 * In this case the device is here, and the</span>
<span class="cm">				 * fact that this chunk is not in-sync is</span>
<span class="cm">				 * recorded in the bad block log.</span>
<span class="cm">				 */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">good_sectors</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">dev_sector</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">good_sectors</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span>
					<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">good_sectors</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">blocked_rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Have to wait for this device to get unblocked, then retry */</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Race with remove_disk */</span>
					<span class="n">smp_mb</span><span class="p">();</span>
					<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">md_wait_for_blocked_rdev</span><span class="p">(</span><span class="n">blocked_rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_write</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are splitting this into multiple parts, so</span>
<span class="cm">		 * we need to prepare for allocating another r10_bio.</span>
<span class="cm">		 */</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sectors_handled</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">max_sectors</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bitmap_startwrite</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">mbio</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mbio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">mbio</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
			    <span class="n">max_sectors</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">mbio</span><span class="p">;</span>

		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span>	<span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="o">+</span>
				   <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span>
						      <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">));</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span>	<span class="o">=</span> <span class="n">raid10_end_write_request</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span> <span class="o">|</span> <span class="n">do_sync</span> <span class="o">|</span> <span class="n">do_fua</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">,</span> <span class="n">mbio</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev_check_plugged</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mbio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">mbio</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
			    <span class="n">max_sectors</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">=</span> <span class="n">mbio</span><span class="p">;</span>

		<span class="cm">/* We are actively writing to the original device</span>
<span class="cm">		 * so it cannot disappear, so the replacement cannot</span>
<span class="cm">		 * become NULL here</span>
<span class="cm">		 */</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span>	<span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
				   <span class="n">choose_data_offset</span><span class="p">(</span>
					   <span class="n">r10_bio</span><span class="p">,</span>
					   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">));</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span>	<span class="o">=</span> <span class="n">raid10_end_write_request</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span> <span class="o">|</span> <span class="n">do_sync</span> <span class="o">|</span> <span class="n">do_fua</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">,</span> <span class="n">mbio</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev_check_plugged</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t remove the bias on &#39;remaining&#39; (one_write_done) until</span>
<span class="cm">	 * after checking if we need to go around again.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sectors_handled</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">one_write_done</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="cm">/* We need another r10_bio.  It has already been counted</span>
<span class="cm">		 * in bio-&gt;bi_phys_segments.</span>
<span class="cm">		 */</span>
		<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">sectors_handled</span><span class="p">;</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry_write</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">one_write_done</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>

	<span class="cm">/* In case raid10d snuck in to freeze_array */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %dK chunks&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %d near-copies&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %d offset-copies&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %d far-copies&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; [%d/%d] [&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">,</span>
					<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			      <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			      <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;U&quot;</span> <span class="o">:</span> <span class="s">&quot;_&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* check if there are enough drives for</span>
<span class="cm"> * every block to appear on atleast one.</span>
<span class="cm"> * Don&#39;t consider the device numbered &#39;ignore&#39;</span>
<span class="cm"> * as we might be about to remove it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_enough</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">first</span><span class="p">].</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">first</span> <span class="o">!=</span> <span class="n">ignore</span><span class="p">)</span>
				<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enough</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">_enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">ignore</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If it is not operational, then we have already marked it as dead</span>
<span class="cm">	 * else if it is the last working disks, ignore the error, let the</span>
<span class="cm">	 * next level up know.</span>
<span class="cm">	 * else mark the drive as failed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t fail the drive, just return an IO error.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if recovery is running, make sure it aborts.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
	       <span class="s">&quot;md/raid10:%s: Disk failure on %s, disabling device.</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md/raid10:%s: Operation continuing on %d devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RAID10 conf printout:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(!conf)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; --- wd:%d rd:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; disk %d, wo:%d, o:%d, dev:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
			        <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_spare_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find all non-in_sync disks within the RAID10 configuration</span>
<span class="cm">	 * and mark them in_sync</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span>
		    <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">==</span> <span class="n">MaxSector</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Replacement has just become active */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span>
			    <span class="o">||</span> <span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Replaced device not technically faulty,</span>
<span class="cm">				 * but we need to be sure it gets removed</span>
<span class="cm">				 * and never re-added.</span>
<span class="cm">				 */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span>
					<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span>
			   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sysfs_notify_dirent</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_add_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="cm">/* only hot-add to in-sync arrays, as recovery is</span>
<span class="cm">		 * very different from resync</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&gt;=</span> <span class="n">first</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mirror</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mirror</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">mirror</span> <span class="o">&lt;=</span> <span class="n">last</span> <span class="p">;</span> <span class="n">mirror</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">!=</span> <span class="n">mirror</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Some requests might not have seen this new</span>
<span class="cm">		 * merge_bvec_fn.  We must wait for them to complete</span>
<span class="cm">		 * before merging the device fully.</span>
<span class="cm">		 * First we make sure any code which has tested</span>
<span class="cm">		 * our function has submitted the request, then</span>
<span class="cm">		 * we wait for all outstanding requests to complete.</span>
<span class="cm">		 */</span>
		<span class="n">synchronize_sched</span><span class="p">();</span>
		<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">md_integrity_add_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_remove_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">**</span><span class="n">rdevp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">number</span><span class="p">;</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
		<span class="n">rdevp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span>
		<span class="n">rdevp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Only remove faulty devices if recovery</span>
<span class="cm">	 * is not possible.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">==</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">number</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
	    <span class="n">enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">rdevp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* lost the race, try later */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rdevp</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We must have just cleared &#39;rdev&#39; */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span> <span class="cm">/* Make sure other CPUs may see both as identical</span>
<span class="cm">			   * but will never see neither -- if they are careful.</span>
<span class="cm">			   */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* We might have just remove the Replacement as faulty</span>
<span class="cm">		 * Clear the flag just in case</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">md_integrity_register</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

<span class="nl">abort:</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_sync_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">==</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this is a reshape read */</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span> <span class="cm">/* really the read dev */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* The write handler will notice the lack of</span>
<span class="cm">		 * R10BIO_Uptodate and record any errors etc</span>
<span class="cm">		 */</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">);</span>

	<span class="cm">/* for reconstruct, we always reschedule after a read.</span>
<span class="cm">	 * for resync, only after all reads</span>
<span class="cm">	 */</span>
	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsRecover</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we have read all the blocks,</span>
<span class="cm">		 * do the comparison in process context in raid10d</span>
<span class="cm">		 */</span>
		<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_sync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the primary of several recovery bios */</span>
			<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="p">)</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">r10_bio2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_sync_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">repl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
			<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			     <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
			     <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>

	<span class="n">end_sync_request</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note: sync and recover and handled very differently for raid10</span>
<span class="cm"> * This code is for resync.</span>
<span class="cm"> * For resync, we read through virtual addresses and read all blocks.</span>
<span class="cm"> * If there is any error, we schedule a write.  The lowest numbered</span>
<span class="cm"> * drive is authoritative.</span>
<span class="cm"> * However requests come for physical address, so we need to map.</span>
<span class="cm"> * For every physical address there are raid_disks/copies virtual addresses,</span>
<span class="cm"> * which is always are least one, but is not necessarly an integer.</span>
<span class="cm"> * This means that a physical address can span multiple chunks, so we may</span>
<span class="cm"> * have to submit multiple io requests for a single sync request.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * We check if all blocks are in-sync and only write to blocks that</span>
<span class="cm"> * aren&#39;t in sync</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_request_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">tbio</span><span class="p">,</span> <span class="o">*</span><span class="n">fbio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vcnt</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* find the first device with a block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">fbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>

	<span class="n">vcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
	<span class="cm">/* now find blocks with errors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>  <span class="n">j</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">tbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">!=</span> <span class="n">end_sync_read</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">first</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We know that the bi_io_vec layout is the same for</span>
<span class="cm">			 * both &#39;first&#39; and &#39;i&#39;, so we just compare them.</span>
<span class="cm">			 * All vec entries are PAGE_SIZE;</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">vcnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">fbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
					   <span class="n">page_address</span><span class="p">(</span><span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
					   <span class="n">fbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_len</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">vcnt</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">+=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="cm">/* Don&#39;t fix anything. */</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Ok, we need to write this bio, either to correct an</span>
<span class="cm">		 * inconsistency or to correct an unreadable block.</span>
<span class="cm">		 * First we need to fixup bv_offset, bv_len and</span>
<span class="cm">		 * bi_vecs, as the read request might have corrupted these</span>
<span class="cm">		 */</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="n">vcnt</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">vcnt</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
			       <span class="n">page_address</span><span class="p">(</span><span class="n">fbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
			       <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">tbio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now write out to any replacement devices</span>
<span class="cm">	 * that are active</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">tbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbio</span> <span class="o">||</span> <span class="o">!</span><span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">!=</span> <span class="n">end_sync_write</span>
		    <span class="o">&amp;&amp;</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span> <span class="o">!=</span> <span class="n">fbio</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">vcnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
				       <span class="n">page_address</span><span class="p">(</span><span class="n">fbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
				       <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
			     <span class="n">tbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">tbio</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Now for the recovery code.</span>
<span class="cm"> * Recovery happens across physical sectors.</span>
<span class="cm"> * We recover all non-is_sync drives by finding the virtual address of</span>
<span class="cm"> * each, and then choose a working drive that also has that virt address.</span>
<span class="cm"> * There is a separate r10_bio for each non-in_sync drive.</span>
<span class="cm"> * Only the first two slots are in use. The first for reading,</span>
<span class="cm"> * The second for writing.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_recovery_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We got a read error during recovery.</span>
<span class="cm">	 * We repeat the read in smaller page-sized sections.</span>
<span class="cm">	 * If a read succeeds, write it to the new device or record</span>
<span class="cm">	 * a bad block if we cannot.</span>
<span class="cm">	 * If a read fails, record a bad block on both old and</span>
<span class="cm">	 * new devices.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dr</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sect</span><span class="p">,</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="n">addr</span><span class="p">,</span>
				  <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
				  <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
				  <span class="n">READ</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dw</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sect</span><span class="p">;</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					  <span class="n">addr</span><span class="p">,</span>
					  <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
					  <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
					  <span class="n">WRITE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We don&#39;t worry if we cannot set a bad block -</span>
<span class="cm">			 * it really is bad so there is no loss in not</span>
<span class="cm">			 * recording it yet</span>
<span class="cm">			 */</span>
			<span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dw</span><span class="p">].</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* need bad block on destination too */</span>
				<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dw</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sect</span><span class="p">;</span>
				<span class="n">ok</span> <span class="o">=</span> <span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* just abort the recovery */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
					       <span class="s">&quot;md/raid10:%s: recovery aborted&quot;</span>
					       <span class="s">&quot; due to read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>

					<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dw</span><span class="p">].</span><span class="n">recovery_disabled</span>
						<span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">sect</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recovery_request_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">wbio</span><span class="p">,</span> <span class="o">*</span><span class="n">wbio2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fix_recovery_read_error</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">end_sync_request</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * share the pages with the first bio</span>
<span class="cm">	 * and submit the write request</span>
<span class="cm">	 */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
	<span class="n">wbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">wbio2</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">wbio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbio2</span> <span class="o">&amp;&amp;</span> <span class="n">wbio2</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
			     <span class="n">wbio2</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">wbio2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Used by fix_read_error() to decay the per rdev read_errors.</span>
<span class="cm"> * We halve the read error count for every hour that has elapsed</span>
<span class="cm"> * since the last recorded read error.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_decay_read_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">cur_time_mon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hours_since_last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_errors</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">);</span>

	<span class="n">ktime_get_ts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_time_mon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* first time we&#39;ve seen a read error */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span> <span class="o">=</span> <span class="n">cur_time_mon</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hours_since_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_time_mon</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span> <span class="o">=</span> <span class="n">cur_time_mon</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if hours_since_last is &gt; the number of bits in read_errors</span>
<span class="cm">	 * just set read errors to 0. We do this to avoid</span>
<span class="cm">	 * overflowing the shift of read_errors by hours_since_last.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hours_since_last</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_errors</span><span class="p">))</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">,</span> <span class="n">read_errors</span> <span class="o">&gt;&gt;</span> <span class="n">hours_since_last</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r10_sync_page_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="cm">/* success */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* need to record an error - either for the block or the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a kernel thread which:</span>
<span class="cm"> *</span>
<span class="cm"> *	1.	Retries failed read operations on working mirrors.</span>
<span class="cm"> *	2.	Updates the raid superblock when problems encounter.</span>
<span class="cm"> *	3.	Performs writes following reads for array synchronising.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Offset from r10_bio-&gt;sector */</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span><span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_read_errors</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_corr_read_errors</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>

	<span class="cm">/* still own a reference to this rdev, so it cannot</span>
<span class="cm">	 * have been cleared recently.</span>
<span class="cm">	 */</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* drive has already been failed, just ignore any</span>
<span class="cm">		   more fix_read_error() attempts */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">check_decay_read_errors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_read_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;md/raid10:%s: %s: Raid device exceeded &quot;</span>
		       <span class="s">&quot;read_error threshold [cur %d:max %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span>
		       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">),</span> <span class="n">max_read_errors</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		       <span class="s">&quot;md/raid10:%s: %s: Failing raid device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">IO_BLOCKED</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

			<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="n">success</span> <span class="o">=</span> <span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
						       <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
						       <span class="n">sect</span><span class="p">,</span>
						       <span class="n">s</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span>
						       <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
				<span class="n">rcu_read_lock</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sl</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span>
				<span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">sl</span> <span class="o">!=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot read from anywhere, just mark the block</span>
<span class="cm">			 * as bad on the first device to discourage future</span>
<span class="cm">			 * reads.</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dn</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
				    <span class="n">rdev</span><span class="p">,</span>
				    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">addr</span>
				    <span class="o">+</span> <span class="n">sect</span><span class="p">,</span>
				    <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">bio</span>
					<span class="o">=</span> <span class="n">IO_BLOCKED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">sl</span><span class="p">;</span>
		<span class="cm">/* write it back and re-read */</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sl</span> <span class="o">!=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">sl</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span>
			<span class="n">sl</span><span class="o">--</span><span class="p">;</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r10_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					     <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
					     <span class="n">sect</span><span class="p">,</span>
					     <span class="n">s</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">)</span>
			    <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Well, this device is dead */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				       <span class="s">&quot;md/raid10:%s: read correction &quot;</span>
				       <span class="s">&quot;write failed&quot;</span>
				       <span class="s">&quot; (%d sectors at %llu on %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span>
					       <span class="n">sect</span> <span class="o">+</span>
					       <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span>
								  <span class="n">rdev</span><span class="p">)),</span>
				       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md/raid10:%s: %s: failing &quot;</span>
				       <span class="s">&quot;drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
				       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">sl</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sl</span> <span class="o">!=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">sl</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span>
			<span class="n">sl</span><span class="o">--</span><span class="p">;</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">r10_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					     <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">sl</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span>
					     <span class="n">sect</span><span class="p">,</span>
					     <span class="n">s</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span>
						 <span class="n">READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="cm">/* Well, this device is dead */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				       <span class="s">&quot;md/raid10:%s: unable to read back &quot;</span>
				       <span class="s">&quot;corrected sectors&quot;</span>
				       <span class="s">&quot; (%d sectors at %llu on %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span>
					       <span class="n">sect</span> <span class="o">+</span>
					       <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)),</span>
				       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md/raid10:%s: %s: failing &quot;</span>
				       <span class="s">&quot;drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
				       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;md/raid10:%s: read error corrected&quot;</span>
				       <span class="s">&quot; (%d sectors at %llu on %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span>
					       <span class="n">sect</span> <span class="o">+</span>
					       <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)),</span>
				       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">sect</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bi_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_bio_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_SYNC</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">bi_complete</span><span class="p">;</span>
	<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">narrow_write_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="cm">/* bio has the data to be written to slot &#39;i&#39; where</span>
<span class="cm">	 * we just recently had a write error.</span>
<span class="cm">	 * We repeatedly clone the bio and trim down to one block,</span>
<span class="cm">	 * then try the write.  Where the write fails we record</span>
<span class="cm">	 * a bad block.</span>
<span class="cm">	 * It is conceivable that the bio doesn&#39;t exactly align with</span>
<span class="cm">	 * blocks.  We must handle this.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We currently own a reference to the rdev.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">block_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sect_to_write</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">block_sectors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">block_sectors</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">block_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="o">-</span> <span class="n">sector</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sect_to_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">wbio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">sect_to_write</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">sect_to_write</span><span class="p">;</span>
		<span class="cm">/* Write at &#39;sector&#39; for &#39;sectors&#39; */</span>
		<span class="n">wbio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">wbio</span><span class="p">,</span> <span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="o">+</span>
				   <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">sector</span> <span class="o">-</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">));</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">submit_bio_wait</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">wbio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* Failure! */</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span>
						<span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>

		<span class="n">bio_put</span><span class="p">(</span><span class="n">wbio</span><span class="p">);</span>
		<span class="n">sect_to_write</span> <span class="o">-=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">block_sectors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_sync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span><span class="p">;</span>

	<span class="cm">/* we got a read error. Maybe the drive is bad.  Maybe just</span>
<span class="cm">	 * the block and we can fix it.</span>
<span class="cm">	 * We freeze all other IO, and try reading the block from</span>
<span class="cm">	 * other devices.  When we find one, we re-write</span>
<span class="cm">	 * and check it that fixes the read error.</span>
<span class="cm">	 * This is all done synchronously while the array is</span>
<span class="cm">	 * frozen.</span>
<span class="cm">	 */</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">bdevname</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freeze_array</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">fix_read_error</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">unfreeze_array</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">IO_BLOCKED</span><span class="p">;</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>

<span class="nl">read_more:</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">read_balance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md/raid10:%s: %s: unrecoverable I/O&quot;</span>
		       <span class="s">&quot; read error for block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">do_sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">);</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>
	<span class="n">printk_ratelimited</span><span class="p">(</span>
		<span class="n">KERN_ERR</span>
		<span class="s">&quot;md/raid10:%s: %s: redirecting &quot;</span>
		<span class="s">&quot;sector %llu to another mirror</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">,</span>
			      <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span>
		    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
		    <span class="n">max_sectors</span><span class="p">);</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span>
		<span class="o">+</span> <span class="n">choose_data_offset</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">do_sync</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid10_end_read_request</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drat - have to split this up more */</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">mbio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sectors_handled</span> <span class="o">=</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">max_sectors</span>
			<span class="o">-</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

		<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">,</span>
					<span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">mbio</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="o">-</span> <span class="n">sectors_handled</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_ReadError</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span>
			<span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">read_more</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_write_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Some sort of write request has finished and it</span>
<span class="cm">	 * succeeded in writing where we thought there was a</span>
<span class="cm">	 * bad block.  So forget the bad block.</span>
<span class="cm">	 * Or possibly if failed and we need to record</span>
<span class="cm">	 * a bad block.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsRecover</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">bio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span>
					<span class="n">rdev</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
					    <span class="n">rdev</span><span class="p">,</span>
					    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">repl_bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span>
					<span class="n">rdev</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
					    <span class="n">rdev</span><span class="p">,</span>
					    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">==</span> <span class="n">IO_MADE_GOOD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span>
					<span class="n">rdev</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
				   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">narrow_write_error</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_Degraded</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">dev</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">bio</span> <span class="o">==</span> <span class="n">IO_MADE_GOOD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span>
					<span class="n">rdev</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">close_write</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10d</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>

	<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flush_pending_writes</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span><span class="p">,</span> <span class="n">retry_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">handle_write_completed</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsReshape</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">reshape_request_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">sync_request_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_IsRecover</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">recovery_request_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">handle_read_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* just a partial read to be scheduled from a</span>
<span class="cm">			 * separate context</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">;</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_CHANGE_PENDING</span><span class="p">))</span>
			<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">buffs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">buffs</span> <span class="o">=</span> <span class="n">RESYNC_WINDOW</span> <span class="o">/</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">have_replacement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">have_replacement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">buffs</span><span class="p">,</span> <span class="n">r10buf_pool_alloc</span><span class="p">,</span> <span class="n">r10buf_pool_free</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perform a &quot;sync&quot; on one &quot;block&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * We need to make sure that no normal I/O request - particularly write</span>
<span class="cm"> * requests - conflict with active sync requests.</span>
<span class="cm"> *</span>
<span class="cm"> * This is achieved by tracking pending requests and a &#39;barrier&#39; concept</span>
<span class="cm"> * that can be installed to exclude normal IO requests.</span>
<span class="cm"> *</span>
<span class="cm"> * Resync and recovery are handled very differently.</span>
<span class="cm"> * We differentiate by looking at MD_RECOVERY_SYNC in mddev-&gt;recovery.</span>
<span class="cm"> *</span>
<span class="cm"> * For resync, we iterate over virtual addresses, read all copies,</span>
<span class="cm"> * and update if there are differences.  If only one copy is live,</span>
<span class="cm"> * skip it.</span>
<span class="cm"> * For recovery, we iterate over physical addresses, read a good</span>
<span class="cm"> * value for each non-in_sync drive, and over-write.</span>
<span class="cm"> *</span>
<span class="cm"> * So, for recovery we may have several outstanding complex requests for a</span>
<span class="cm"> * given address, one for each out-of-sync device.  We model this by allocating</span>
<span class="cm"> * a number of r10_bio structures, one for each out-of-sync device.</span>
<span class="cm"> * As we setup these structures, we collect all bio&#39;s together into a list</span>
<span class="cm"> * which we then process collectively to add pages, and then process again</span>
<span class="cm"> * to pass to generic_make_request.</span>
<span class="cm"> *</span>
<span class="cm"> * The r10_bio structures are linked using a borrowed master_bio pointer.</span>
<span class="cm"> * This link is counted in -&gt;remaining.  When the r10_bio that points to NULL</span>
<span class="cm"> * has its remaining count decremented to 0, the whole complex operation</span>
<span class="cm"> * is complete.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">sync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">,</span> <span class="kt">int</span> <span class="n">go_faster</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">biolist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_sector</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sync</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sync_blocks</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors_skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunks_skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">chunk_mask</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_resync</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">skipped:</span>
	<span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">&gt;=</span> <span class="n">max_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we aborted, we need to abort the</span>
<span class="cm">		 * sync on the &#39;current&#39; bitmap chucks (there can</span>
<span class="cm">		 * be several when recovering multiple devices).</span>
<span class="cm">		 * as we may have started syncing it but not finished.</span>
<span class="cm">		 * We can find the current address in</span>
<span class="cm">		 * mddev-&gt;curr_resync, but for recovery,</span>
<span class="cm">		 * we need to convert that to several</span>
<span class="cm">		 * virtual addresses.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">end_reshape</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&lt;</span> <span class="n">max_sector</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* aborted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sector_t</span> <span class="n">sect</span> <span class="o">=</span>
					<span class="n">raid10_find_virt</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* completed sync */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">||</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">have_replacement</span>
			    <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Completed a full sync so the replacements</span>
<span class="cm">				 * are now fully recovered.</span>
<span class="cm">				 */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">)</span>
						<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span>
							<span class="o">-&gt;</span><span class="n">recovery_offset</span>
							<span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bitmap_close_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="n">close_sync</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sectors_skipped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">reshape_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="n">skipped</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chunks_skipped</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if there has been nothing to do on any drive,</span>
<span class="cm">		 * then there is nothing to do at all..</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">)</span> <span class="o">+</span> <span class="n">sectors_skipped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">;</span> <span class="cm">/* Don&#39;t do IO beyond here */</span>

	<span class="cm">/* make sure whole request will fit in a chunk - if chunks</span>
<span class="cm">	 * are meaningful</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
	    <span class="n">max_sector</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">|</span> <span class="n">chunk_mask</span><span class="p">))</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">|</span> <span class="n">chunk_mask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If there is non-resync activity waiting for us then</span>
<span class="cm">	 * put in a delay to throttle resync.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go_faster</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="p">)</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Again, very different code for resync and recovery.</span>
<span class="cm">	 * Both must result in an r10bio with a list of bios that</span>
<span class="cm">	 * have bi_end_io, bi_sector, bi_bdev set,</span>
<span class="cm">	 * and bi_private set to the r10bio.</span>
<span class="cm">	 * For recovery, we may actually create several r10bios</span>
<span class="cm">	 * with 2 bios in each, that correspond to the bios in the main one.</span>
<span class="cm">	 * In this case, the subordinate r10bios link back through a</span>
<span class="cm">	 * borrowed master_bio pointer, and the counter in the master</span>
<span class="cm">	 * includes a ref from each subordinate.</span>
<span class="cm">	 */</span>
	<span class="cm">/* First, we decide what to do and set -&gt;bi_end_io</span>
<span class="cm">	 * To end_sync_read if we want to read, and</span>
<span class="cm">	 * end_sync_write if we will want to write.</span>
<span class="cm">	 */</span>

	<span class="n">max_sync</span> <span class="o">=</span> <span class="n">RESYNC_PAGES</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="o">-</span><span class="mi">9</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* recovery... the complicated one */</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">r10_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">still_degraded</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">rb2</span><span class="p">;</span>
			<span class="n">sector_t</span> <span class="n">sect</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">must_sync</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">any_working</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">mirror</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			     <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			     <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* want to reconstruct this device */</span>
			<span class="n">rb2</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
			<span class="n">sect</span> <span class="o">=</span> <span class="n">raid10_find_virt</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sect</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* last stripe is not complete - don&#39;t</span>
<span class="cm">				 * try to recover this sector.</span>
<span class="cm">				 */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Unless we are doing a full sync, or a replacement</span>
<span class="cm">			 * we only need to recover the block if it is set in</span>
<span class="cm">			 * the bitmap</span>
<span class="cm">			 */</span>
			<span class="n">must_sync</span> <span class="o">=</span> <span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sync_blocks</span> <span class="o">&lt;</span> <span class="n">max_sync</span><span class="p">)</span>
				<span class="n">max_sync</span> <span class="o">=</span> <span class="n">sync_blocks</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">must_sync</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* yep, skip the sync_blocks here, but don&#39;t assume</span>
<span class="cm">				 * that there will never be anything to do here</span>
<span class="cm">				 */</span>
				<span class="n">chunks_skipped</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rb2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bio</span><span class="o">*</span><span class="p">)</span><span class="n">rb2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rb2</span><span class="p">)</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb2</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_IsRecover</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sect</span><span class="p">;</span>

			<span class="n">raid10_find_phys</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>

			<span class="cm">/* Need to check if the array will still be</span>
<span class="cm">			 * degraded</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
				    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="n">must_sync</span> <span class="o">=</span> <span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="n">still_degraded</span><span class="p">);</span>

			<span class="n">any_working</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
				<span class="n">sector_t</span> <span class="n">from_addr</span><span class="p">,</span> <span class="n">to_addr</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="n">first_bad</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* This is where we read from */</span>
				<span class="n">any_working</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">max_sync</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&gt;</span> <span class="n">sector</span><span class="p">)</span>
						<span class="n">max_sync</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">sector</span><span class="p">;</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sector</span>
								<span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">max_sync</span> <span class="o">&gt;</span> <span class="n">bad_sectors</span><span class="p">)</span>
							<span class="n">max_sync</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
				<span class="n">biolist</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_read</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
				<span class="n">from_addr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">from_addr</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
				<span class="cm">/* and we write to &#39;i&#39; (if not in_sync) */</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">devnum</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">);</span>
				<span class="n">to_addr</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">from_addr</span><span class="p">;</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">to_addr</span><span class="p">;</span>

				<span class="n">rdev</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
					<span class="n">biolist</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">to_addr</span>
						<span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="cm">/* and maybe write to replacement */</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
				<span class="cm">/* Note: if rdev != NULL, then bio</span>
<span class="cm">				 * cannot be NULL as r10buf_pool_alloc will</span>
<span class="cm">				 * have allocated it.</span>
<span class="cm">				 * So the second test here is pointless.</span>
<span class="cm">				 * But it keeps semantic-checkers happy, and</span>
<span class="cm">				 * this comment keeps human reviewers</span>
<span class="cm">				 * happy.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bio</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
				    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
				<span class="n">biolist</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">to_addr</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cannot recover, so abort the recovery or</span>
<span class="cm">				 * record a bad block */</span>
				<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rb2</span><span class="p">)</span>
					<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb2</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
				<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">rb2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">any_working</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* problem is that there are bad blocks</span>
<span class="cm">					 * on other device(s)</span>
<span class="cm">					 */</span>
					<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">devnum</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
						    <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span>
						    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						    <span class="n">max_sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
						<span class="n">any_working</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
						    <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">,</span>
						    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						    <span class="n">max_sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
						<span class="n">any_working</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">any_working</span><span class="p">)</span>  <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid10:%s: insufficient &quot;</span>
						       <span class="s">&quot;working devices for recovery.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
					<span class="n">mirror</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span>
						<span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">biolist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">r10_bio</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">rb2</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
				<span class="n">r10_bio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span><span class="o">*</span><span class="p">)</span> <span class="n">rb2</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
				<span class="n">rb2</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">put_buf</span><span class="p">(</span><span class="n">rb2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">giveup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* resync. Schedule a read for every block at this virt offset */</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">bitmap_cond_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We can skip this block */</span>
			<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">sync_blocks</span> <span class="o">+</span> <span class="n">sectors_skipped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sync_blocks</span> <span class="o">&lt;</span> <span class="n">max_sync</span><span class="p">)</span>
			<span class="n">max_sync</span> <span class="o">=</span> <span class="n">sync_blocks</span><span class="p">;</span>
		<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>

		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_IsSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">raid10_find_phys</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">|</span> <span class="n">chunk_mask</span><span class="p">)</span> <span class="o">-</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">,</span> <span class="n">sector</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">)</span>
				<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
					<span class="n">sector</span><span class="p">,</span> <span class="n">max_sync</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&gt;</span> <span class="n">sector</span><span class="p">)</span>
					<span class="n">max_sync</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">sector</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sector</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">max_sync</span> <span class="o">&gt;</span> <span class="n">bad_sectors</span><span class="p">)</span>
						<span class="n">max_sync</span> <span class="o">=</span> <span class="n">max_sync</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
			<span class="n">biolist</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_read</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Need to set up for writing to the replacement */</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>

			<span class="n">sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
			<span class="n">biolist</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span>
					<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
							 <span class="n">mddev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span> <span class="o">&amp;&amp;</span>
				    <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">repl_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span>
					<span class="n">rdev_dec_pending</span><span class="p">(</span>
						<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">,</span>
						<span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
			<span class="n">biolist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">giveup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bio</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span> <span class="n">bio</span> <span class="p">;</span> <span class="n">bio</span><span class="o">=</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="n">max_sync</span> <span class="o">&lt;</span> <span class="n">max_sector</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">max_sync</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_sector</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bio</span><span class="o">=</span> <span class="n">biolist</span> <span class="p">;</span> <span class="n">bio</span> <span class="p">;</span> <span class="n">bio</span><span class="o">=</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio2</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* stop here */</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bio2</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
			     <span class="n">bio2</span> <span class="o">&amp;&amp;</span> <span class="n">bio2</span> <span class="o">!=</span> <span class="n">bio</span><span class="p">;</span>
			     <span class="n">bio2</span> <span class="o">=</span> <span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* remove last page from this bio */</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span> <span class="n">BIO_SEG_VALID</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">bio_full</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nr_sectors</span> <span class="o">+=</span> <span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
		<span class="n">sector_nr</span> <span class="o">+=</span> <span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">biolist</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">);</span>
 <span class="nl">bio_full:</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">nr_sectors</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">biolist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">biolist</span><span class="p">;</span>
		<span class="n">biolist</span> <span class="o">=</span> <span class="n">biolist</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>

		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
		<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">nr_sectors</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_read</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">);</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sectors_skipped</span><span class="p">)</span>
		<span class="cm">/* pretend they weren&#39;t skipped, it makes</span>
<span class="cm">		 * no important difference in this case</span>
<span class="cm">		 */</span>
		<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sectors_skipped</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sectors_skipped</span> <span class="o">+</span> <span class="n">nr_sectors</span><span class="p">;</span>
 <span class="nl">giveup:</span>
	<span class="cm">/* There is nowhere to write, so all non-sync</span>
<span class="cm">	 * drives must be failed or in resync, all drives</span>
<span class="cm">	 * have a bad block, so try the next chunk...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="n">max_sync</span> <span class="o">&lt;</span> <span class="n">max_sector</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">max_sync</span><span class="p">;</span>

	<span class="n">sectors_skipped</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">);</span>
	<span class="n">chunks_skipped</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">max_sector</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">skipped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span>
<span class="nf">raid10_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="n">raid_disks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">,</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sectors</span><span class="p">)</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">sectors</span> <span class="o">&gt;&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Calculate the number of sectors-per-device that will</span>
<span class="cm">	 * actually be used, and set conf-&gt;dev_sectors and</span>
<span class="cm">	 * conf-&gt;stride</span>
<span class="cm">	 */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">);</span>
	<span class="cm">/* &#39;size&#39; is now the number of chunks in the array */</span>
	<span class="cm">/* calculate &quot;used chunks per device&quot; */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">;</span>

	<span class="cm">/* We need to round up when dividing by raid_disks to</span>
<span class="cm">	 * get the stride size.</span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP_SECTOR_T</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sector_div</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">geo_type</span> <span class="p">{</span><span class="n">geo_new</span><span class="p">,</span> <span class="n">geo_old</span><span class="p">,</span> <span class="n">geo_start</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_geo</span><span class="p">(</span><span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">geo_type</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nc</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">fo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">layout</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">disks</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">geo_old</span>:
		<span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="n">disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">geo_new</span>:
		<span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
		<span class="n">disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* avoid &#39;may be unused&#39; warnings */</span>
	<span class="k">case</span> <span class="n">geo_start</span>: <span class="cm">/* new when starting reshape - raid_disks not</span>
<span class="cm">			 * updated yet. */</span>
		<span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
		<span class="n">disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layout</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">nc</span> <span class="o">=</span> <span class="n">layout</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">layout</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">fo</span> <span class="o">=</span> <span class="n">layout</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span> <span class="o">=</span> <span class="n">nc</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_offset</span> <span class="o">=</span> <span class="n">fo</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_mask</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="o">~</span><span class="n">chunk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nc</span><span class="o">*</span><span class="n">fc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="nf">setup_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="n">geo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copies</span><span class="p">;</span>

	<span class="n">copies</span> <span class="o">=</span> <span class="n">setup_geo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">geo_new</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copies</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: chunk size must be &quot;</span>
		       <span class="s">&quot;at least PAGE_SIZE(%ld) and be a power of 2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copies</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">copies</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: unsupported raid10 layout: 0x%8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME calc properly */</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mirror_info</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span>
							    <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span> <span class="o">=</span> <span class="n">geo</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span> <span class="o">=</span> <span class="n">copies</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">NR_RAID10_BIOS</span><span class="p">,</span> <span class="n">r10bio_pool_alloc</span><span class="p">,</span>
					   <span class="n">r10bio_pool_free</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">calc_sectors</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_geo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">geo_old</span><span class="p">)</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* far_copies must be 1 */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">raid10d</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="s">&quot;raid10&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: couldn&#39;t allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">)</span>
			<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
		<span class="n">safe_put_page</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">disk_idx</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">min_offset_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chunk_size</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">blk_queue_io_min</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">%</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">)</span>
		<span class="n">blk_queue_io_opt</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">blk_queue_io_opt</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">*</span>
				 <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">/</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">));</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="kt">long</span> <span class="n">diff</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

		<span class="n">disk_idx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk_idx</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">disk_idx</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">disk_idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">||</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_offset_diff</span><span class="p">)</span>
			<span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>

		<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* need to check that every block has at least one working mirror */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: not enough operational mirrors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* must ensure that shape change is supported */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span>
		     <span class="o">||</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The replacement is all we have - use it */</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md/raid10:%s: not clean&quot;</span>
		       <span class="s">&quot; -- starting background reconstruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;md/raid10:%s: active with %d out of %d devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ok, everything is just fine now</span>
<span class="cm">	 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="n">raid10_congested</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_data</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>

	<span class="cm">/* Calculate max read-ahead size.</span>
<span class="cm">	 * We need to readahead at least twice a whole stripe....</span>
<span class="cm">	 * maybe...</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">stripe</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">*</span>
			<span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">stripe</span> <span class="o">/=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">raid10_mergeable_bvec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md_integrity_register</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before_length</span><span class="p">,</span> <span class="n">after_length</span><span class="p">;</span>

		<span class="n">before_length</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">)</span> <span class="o">*</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
		<span class="n">after_length</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">before_length</span><span class="p">,</span> <span class="n">after_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_offset_diff</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This cannot work */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md/raid10: offset difference not enough to continue reshape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_conf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">offset_diff</span> <span class="o">=</span> <span class="n">min_offset_diff</span><span class="p">;</span>

		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span>
							<span class="s">&quot;reshape&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_conf:</span>
	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">);</span>
	<span class="n">safe_put_page</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">blk_sync_queue</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span> <span class="cm">/* the unplug fn references &#39;conf&#39;*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10bio_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Resize of &#39;far&#39; arrays is not supported.</span>
<span class="cm">	 * For &#39;near&#39; and &#39;offset&#39; arrays we can set the</span>
<span class="cm">	 * number of sectors used to be an appropriate multiple</span>
<span class="cm">	 * of the chunk size.</span>
<span class="cm">	 * For &#39;offset&#39;, this is far_copies*chunksize.</span>
<span class="cm">	 * For &#39;near&#39; the multiplier is the LCM of</span>
<span class="cm">	 * near_copies and raid_disks.</span>
<span class="cm">	 * So if far_copies &gt; 1 &amp;&amp; !far_offset, fail.</span>
<span class="cm">	 * Else find LCM(raid_disks, near_copy)*far_copies and</span>
<span class="cm">	 * multiply by chunk_size.  Then round to this number.</span>
<span class="cm">	 * This is mostly done by raid10_size()</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">oldsize</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">oldsize</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bitmap_resize</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
	<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&gt;</span> <span class="n">oldsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">oldsize</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">calc_sectors</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid10_takeover_raid0</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: Error: degraded raid0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set new parameters */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="cm">/* new layout: far_copies = 1, near_copies = 2 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* make sure it will be not marked as dirty */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid10_takeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r0conf</span> <span class="o">*</span><span class="n">raid0_conf</span><span class="p">;</span>

	<span class="cm">/* raid10 can take over:</span>
<span class="cm">	 *  raid0 - providing it has only two drives</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for raid0 takeover only one zone is supported */</span>
		<span class="n">raid0_conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid0_conf</span><span class="o">-&gt;</span><span class="n">nr_strip_zones</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: cannot takeover raid 0&quot;</span>
			       <span class="s">&quot; with more than one zone.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">raid10_takeover_raid0</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_check_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Called when there is a request to change</span>
<span class="cm">	 * - layout (to -&gt;new_layout)</span>
<span class="cm">	 * - chunk size (to -&gt;new_chunk_sectors)</span>
<span class="cm">	 * - raid_disks (by delta_disks)</span>
<span class="cm">	 * or when trying to restart a reshape that was ongoing.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We need to validate the request and possibly allocate</span>
<span class="cm">	 * space if that might be an issue later.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Currently we reject any reshape of a &#39;far&#39; mode array,</span>
<span class="cm">	 * allow chunk size to change if new is generally acceptable,</span>
<span class="cm">	 * allow raid_disks to increase, and allow</span>
<span class="cm">	 * a switch between &#39;near&#39; mode and &#39;offset&#39; mode.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="n">geo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_geo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">geo_start</span><span class="p">)</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span>
		<span class="cm">/* mustn&#39;t change number of copies */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">geo</span><span class="p">.</span><span class="n">far_offset</span><span class="p">)</span>
		<span class="cm">/* Cannot switch to &#39;far&#39; mode */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&amp;</span> <span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">)</span>
			<span class="cm">/* not factor of array size */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enough</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate new &#39;mirrors&#39; list */</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mirror_info</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span>
			  <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Need to check if array has failed when deciding whether to:</span>
<span class="cm"> *  - start an array</span>
<span class="cm"> *  - remove non-faulty devices</span>
<span class="cm"> *  - add a spare</span>
<span class="cm"> *  - allow a reshape</span>
<span class="cm"> * This determination is simple when no reshape is happening.</span>
<span class="cm"> * However if there is a reshape, we need to carefully check</span>
<span class="cm"> * both the before and after sections.</span>
<span class="cm"> * This is because some failed devices may only affect one</span>
<span class="cm"> * of the two sections, and some non-in_sync devices may</span>
<span class="cm"> * be insync in the section most affected by failed devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_degraded</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">degraded</span><span class="p">,</span> <span class="n">degraded2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* &#39;prev&#39; section first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="cm">/* When we can reduce the number of devices in</span>
<span class="cm">			 * an array, this might not contribute to</span>
<span class="cm">			 * &#39;degraded&#39;.  It does now.</span>
<span class="cm">			 */</span>
			<span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">degraded</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">degraded2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">degraded2</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If reshape is increasing the number of devices,</span>
<span class="cm">			 * this section has already been recovered, so</span>
<span class="cm">			 * it doesn&#39;t contribute to degraded.</span>
<span class="cm">			 * else it does.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">&lt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
				<span class="n">degraded2</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">degraded2</span> <span class="o">&gt;</span> <span class="n">degraded</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">degraded2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">degraded</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid10_start_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* A &#39;reshape&#39; has been requested. This commits</span>
<span class="cm">	 * the various &#39;new&#39; fields and sets MD_RECOVER_RESHAPE</span>
<span class="cm">	 * This also checks if there are enough spares and adds them</span>
<span class="cm">	 * to the array.</span>
<span class="cm">	 * We currently require enough spares to make the final</span>
<span class="cm">	 * array non-degraded.  We also require that the difference</span>
<span class="cm">	 * between old and new data_offset - on each device - is</span>
<span class="cm">	 * enough that we never risk over-writing.</span>
<span class="cm">	 */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before_length</span><span class="p">,</span> <span class="n">after_length</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">min_offset_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">geom</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_geo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">geo_start</span><span class="p">)</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">before_length</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">)</span> <span class="o">*</span>
			 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>
	<span class="n">after_length</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">far_copies</span><span class="p">);</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">spares</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">long</span> <span class="kt">long</span> <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span>
					  <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">||</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_offset_diff</span><span class="p">)</span>
				<span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">before_length</span><span class="p">,</span> <span class="n">after_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_offset_diff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spares</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">offset_diff</span> <span class="o">=</span> <span class="n">min_offset_diff</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mirror_info</span><span class="p">)</span><span class="o">*</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_old</span><span class="p">);</span> <span class="cm">/* FIXME and elsewhere */</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_old</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors_new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">setup_geo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">geo_start</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid10:%s: array size must be reduce before number of disks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bitmap_resize</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span>
				    <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">),</span>
				    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">raid10_add_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span>
					    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
						<span class="cm">/* Failure here  is OK */</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">raid_disks</span>
				   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* This is a spare that was manually added */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* When a reshape changes the number of devices,</span>
<span class="cm">	 * -&gt;degraded is measured against the larger of the</span>
<span class="cm">	 * pre and  post numbers.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span>
						<span class="s">&quot;reshape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">abort:</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate the last device-address that could contain</span>
<span class="cm"> * any block from the chunk that includes the array-address &#39;s&#39;</span>
<span class="cm"> * and report the next address.</span>
<span class="cm"> * i.e. the address returned will be chunk-aligned and after</span>
<span class="cm"> * any data that is in the chunk containing &#39;s&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">last_dev_address</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">|</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_mask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP_SECTOR_T</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">&lt;&lt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate the first device-address that could contain</span>
<span class="cm"> * any block from the chunk that includes the array-address &#39;s&#39;.</span>
<span class="cm"> * This too will be the start of a chunk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">first_dev_address</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">geom</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">near_copies</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">*=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">far_copies</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">&lt;&lt;=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">reshape_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We simply copy at most one chunk (smallest of old and new)</span>
<span class="cm">	 * at a time, possibly less if that exceeds RESYNC_PAGES,</span>
<span class="cm">	 * or we hit a bad block or something.</span>
<span class="cm">	 * This might mean we pause for normal IO in the middle of</span>
<span class="cm">	 * a chunk, but that is not a problem was mddev-&gt;reshape_position</span>
<span class="cm">	 * can record any location.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we will want to write to a location that isn&#39;t</span>
<span class="cm">	 * yet recorded as &#39;safe&#39; (i.e. in metadata on disk) then</span>
<span class="cm">	 * we need to flush all reshape requests and update the metadata.</span>
<span class="cm">	 *</span>
<span class="cm">	 * When reshaping forwards (e.g. to more devices), we interpret</span>
<span class="cm">	 * &#39;safe&#39; as the earliest block which might not have been copied</span>
<span class="cm">	 * down yet.  We divide this by previous stripe size and multiply</span>
<span class="cm">	 * by previous stripe length to get lowest device offset that we</span>
<span class="cm">	 * cannot write to yet.</span>
<span class="cm">	 * We interpret &#39;sector_nr&#39; as an address that we want to write to.</span>
<span class="cm">	 * From this we use last_device_address() to find where we might</span>
<span class="cm">	 * write to, and first_device_address on the  &#39;safe&#39; position.</span>
<span class="cm">	 * If this &#39;next&#39; write position is after the &#39;safe&#39; position,</span>
<span class="cm">	 * we must update the metadata to increase the &#39;safe&#39; position.</span>
<span class="cm">	 *</span>
<span class="cm">	 * When reshaping backwards, we round in the opposite direction</span>
<span class="cm">	 * and perform the reverse test:  next write position must not be</span>
<span class="cm">	 * less than current safe position.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In all this the minimum difference in data offsets</span>
<span class="cm">	 * (conf-&gt;offset_diff - always positive) allows a bit of slack,</span>
<span class="cm">	 * so next can be after &#39;safe&#39;, but not by more than offset_disk</span>
<span class="cm">	 *</span>
<span class="cm">	 * We need to prepare all the bios here before we start any IO</span>
<span class="cm">	 * to ensure the size we choose is acceptable to all devices.</span>
<span class="cm">	 * The means one for each copy for write-out and an extra one for</span>
<span class="cm">	 * read-in.</span>
<span class="cm">	 * We store the read-in bio in -&gt;master_bio and the others in</span>
<span class="cm">	 * -&gt;devs[x].bio and -&gt;devs[x].repl_bio.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">next</span><span class="p">,</span> <span class="n">safe</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">blist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="o">*</span><span class="n">read_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If restarting in the middle, skip the initial sectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&lt;</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sector_nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				     <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t use sector_nr to track where we are up to</span>
<span class="cm">	 * as that doesn&#39;t work well for -&gt;reshape_backwards.</span>
<span class="cm">	 * So just use -&gt;reshape_progress.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;next&#39; is the earliest device address that we might</span>
<span class="cm">		 * write to for this chunk in the new layout</span>
<span class="cm">		 */</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">first_dev_address</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">);</span>

		<span class="cm">/* &#39;safe&#39; is the last device address that we might read from</span>
<span class="cm">		 * in the old layout after a restart</span>
<span class="cm">		 */</span>
		<span class="n">safe</span> <span class="o">=</span> <span class="n">last_dev_address</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">+</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">offset_diff</span> <span class="o">&lt;</span> <span class="n">safe</span><span class="p">)</span>
			<span class="n">need_flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">last</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">last</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span>
					       <span class="o">&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="o">/</span><span class="mi">512</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">)</span>
			<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* &#39;next&#39; is after the last device address that we</span>
<span class="cm">		 * might write to for this chunk in the new layout</span>
<span class="cm">		 */</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">last_dev_address</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">);</span>

		<span class="cm">/* &#39;safe&#39; is the earliest device address that we might</span>
<span class="cm">		 * read from in the old layout after a restart</span>
<span class="cm">		 */</span>
		<span class="n">safe</span> <span class="o">=</span> <span class="n">first_dev_address</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>

		<span class="cm">/* Need to update metadata if &#39;next&#39; might be beyond &#39;safe&#39;</span>
<span class="cm">		 * as that would possibly corrupt data</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">&gt;</span> <span class="n">safe</span> <span class="o">+</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">offset_diff</span><span class="p">)</span>
			<span class="n">need_flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">last</span>  <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">|</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_mask</span>
				     <span class="o">&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">chunk_mask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="o">/</span><span class="mi">512</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">)</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="o">/</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_flush</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Need to update reshape_position in metadata */</span>
		<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">kthread_should_stop</span><span class="p">());</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">read_more:</span>
	<span class="cm">/* Now schedule reads for blocks from sector_nr to last */</span>
	<span class="n">r10_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r10buf_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sectors_done</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R10BIO_IsReshape</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">read_balance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_sectors</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Previous</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cannot read from here, so need to record bad blocks</span>
<span class="cm">		 * on all the target devices.</span>
<span class="cm">		 */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME</p></td><td class="code"><div class="highlight"><pre>		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sectors_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_bio</span> <span class="o">=</span> <span class="n">bio_alloc_mddev</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">RESYNC_PAGES</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>

	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">addr</span>
			       <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_read</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">read_bio</span><span class="p">;</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">read_slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>

	<span class="cm">/* Now find the locations in the new layout */</span>
	<span class="n">__raid10_find_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">);</span>

	<span class="n">blist</span> <span class="o">=</span> <span class="n">read_bio</span><span class="p">;</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev2</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rdev2</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev2</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_reshape_write</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">blist</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">blist</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now add as many pages as possible to all of these bios. */</span>

	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">;</span> <span class="n">s</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)].</span><span class="n">bv_page</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bio</span> <span class="o">=</span> <span class="n">blist</span><span class="p">;</span> <span class="n">bio</span> <span class="p">;</span> <span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Didn&#39;t fit, must stop */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bio2</span> <span class="o">=</span> <span class="n">blist</span><span class="p">;</span>
			     <span class="n">bio2</span> <span class="o">&amp;&amp;</span> <span class="n">bio2</span> <span class="o">!=</span> <span class="n">bio</span><span class="p">;</span>
			     <span class="n">bio2</span> <span class="o">=</span> <span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Remove last page from this bio */</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">bio2</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">BIO_SEG_VALID</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">bio_full</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sector_nr</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">nr_sectors</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">bio_full:</span>
	<span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">nr_sectors</span><span class="p">;</span>

	<span class="cm">/* Now submit the read */</span>
	<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
	<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">generic_make_request</span><span class="p">(</span><span class="n">read_bio</span><span class="p">);</span>
	<span class="n">sector_nr</span> <span class="o">+=</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="n">sectors_done</span> <span class="o">+=</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">read_more</span><span class="p">;</span>

	<span class="cm">/* Now that we have done the whole section we can</span>
<span class="cm">	 * update reshape_progress</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">-=</span> <span class="n">sectors_done</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">+=</span> <span class="n">sectors_done</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sectors_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">end_reshape_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">handle_reshape_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reshape_request_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reshape read completed.  Hopefully we have a block</span>
<span class="cm">	 * to write out.</span>
<span class="cm">	 * If we got a read error then we do sync 1-page reads from</span>
<span class="cm">	 * elsewhere until we find the data - or give up.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R10BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle_reshape_read_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reshape has been aborted */</span>
			<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* We definitely have the data in the pages, schedule the</span>
<span class="cm">	 * writes.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">repl_bio</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">bio</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">end_reshape_request</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">;</span>
	<span class="n">md_finish_reshape</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="cm">/* read-ahead size must cover two whole stripes, which is</span>
<span class="cm">	 * 2 * (datadisks) * chunksize where &#39;n&#39; is the number of raid devices</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">stripe</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">*</span>
			<span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">stripe</span> <span class="o">/=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">near_copies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_reshape_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Use sync reads to get the blocks from somewhere else */</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="n">r10b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">;</span>

	<span class="n">r10b</span><span class="p">.</span><span class="n">sector</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="n">__raid10_find_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r10b</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r10b</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">devnum</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">sector_t</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="n">r10b</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">success</span> <span class="o">=</span> <span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					       <span class="n">addr</span><span class="p">,</span>
					       <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
					       <span class="n">bvec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
					       <span class="n">READ</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">failed:</span>
			<span class="n">slot</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">copies</span><span class="p">)</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">first_slot</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* couldn&#39;t read this block, must give up */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_reshape_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">repl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r10_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">repl</span><span class="p">)</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME should record badblock */</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="n">end_reshape_request</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_reshape_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">r10bio</span> <span class="o">*</span><span class="n">r10_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">md_done_sync</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">r10_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">);</span>
	<span class="n">put_buf</span><span class="p">(</span><span class="n">r10_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid10_finish_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r10conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">raid10_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
		<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="p">;</span>
		     <span class="n">d</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		     <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">chunk_shift</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid10_personality</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raid10&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">level</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_request</span>	<span class="o">=</span> <span class="n">make_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run</span>		<span class="o">=</span> <span class="n">run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span>		<span class="o">=</span> <span class="n">status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>	<span class="o">=</span> <span class="n">error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_add_disk</span>	<span class="o">=</span> <span class="n">raid10_add_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_remove_disk</span><span class="o">=</span> <span class="n">raid10_remove_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spare_active</span>	<span class="o">=</span> <span class="n">raid10_spare_active</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_request</span>	<span class="o">=</span> <span class="n">sync_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quiesce</span>	<span class="o">=</span> <span class="n">raid10_quiesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">raid10_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">raid10_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">takeover</span>	<span class="o">=</span> <span class="n">raid10_takeover</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reshape</span>	<span class="o">=</span> <span class="n">raid10_check_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_reshape</span>	<span class="o">=</span> <span class="n">raid10_start_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish_reshape</span>	<span class="o">=</span> <span class="n">raid10_finish_reshape</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">raid_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid10_personality</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid10_personality</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">raid_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">raid_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RAID10 (striped mirror) personality for MD&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-personality-9&quot;</span><span class="p">);</span> <span class="cm">/* RAID10 */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-raid10&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-level-10&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_queued_requests</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
