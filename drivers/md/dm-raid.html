<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › dm-raid.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dm-raid.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010-2011 Neil Brown</span>
<span class="cm"> * Copyright (C) 2010-2011 Red Hat, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;raid1.h&quot;</span>
<span class="cp">#include &quot;raid5.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="cp">#include &lt;linux/device-mapper.h&gt;</span>

<span class="cp">#define DM_MSG_PREFIX &quot;raid&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The following flags are used by dm-raid.c to set up the array state.</span>
<span class="cm"> * They must be cleared before md_run is called.</span>
<span class="cm"> */</span>
<span class="cp">#define FirstUse 10             </span><span class="cm">/* rdev flag */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">raid_dev</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Two DM devices, one to hold metadata and one to hold the</span>
<span class="cm">	 * actual data/parity.  The reason for this is to not confuse</span>
<span class="cm">	 * ti-&gt;len and give more flexibility in altering size and</span>
<span class="cm">	 * characteristics.</span>
<span class="cm">	 *</span>
<span class="cm">	 * While it is possible for this device to be associated</span>
<span class="cm">	 * with a different physical device than the data_dev, it</span>
<span class="cm">	 * is intended for it to be the same.</span>
<span class="cm">	 *    |--------- Physical Device ---------|</span>
<span class="cm">	 *    |- meta_dev -|------ data_dev ------|</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dm_dev</span> <span class="o">*</span><span class="n">meta_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_dev</span> <span class="o">*</span><span class="n">data_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Flags for rs-&gt;print_flags field.</span>
<span class="cm"> */</span>
<span class="cp">#define DMPF_SYNC              0x1</span>
<span class="cp">#define DMPF_NOSYNC            0x2</span>
<span class="cp">#define DMPF_REBUILD           0x4</span>
<span class="cp">#define DMPF_DAEMON_SLEEP      0x8</span>
<span class="cp">#define DMPF_MIN_RECOVERY_RATE 0x10</span>
<span class="cp">#define DMPF_MAX_RECOVERY_RATE 0x20</span>
<span class="cp">#define DMPF_MAX_WRITE_BEHIND  0x40</span>
<span class="cp">#define DMPF_STRIPE_CACHE      0x80</span>
<span class="cp">#define DMPF_REGION_SIZE       0X100</span>
<span class="k">struct</span> <span class="n">raid_set</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">bitmap_loaded</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">print_flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mddev</span> <span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_type</span> <span class="o">*</span><span class="n">raid_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_callbacks</span> <span class="n">callbacks</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">raid_dev</span> <span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Supported raid types and properties. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">raid_type</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* RAID algorithm. */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>		<span class="cm">/* Descriptor text for logging. */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">parity_devs</span><span class="p">;</span>	<span class="cm">/* # of parity devices. */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">minimal_devs</span><span class="p">;</span>	<span class="cm">/* minimal # of devices in set. */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">level</span><span class="p">;</span>		<span class="cm">/* RAID level. */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">algorithm</span><span class="p">;</span>	<span class="cm">/* RAID algorithm. */</span>
<span class="p">}</span> <span class="n">raid_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;raid1&quot;</span><span class="p">,</span>    <span class="s">&quot;RAID1 (mirroring)&quot;</span><span class="p">,</span>               <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* NONE */</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid4&quot;</span><span class="p">,</span>    <span class="s">&quot;RAID4 (dedicated parity disk)&quot;</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ALGORITHM_PARITY_0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid5_la&quot;</span><span class="p">,</span> <span class="s">&quot;RAID5 (left asymmetric)&quot;</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid5_ra&quot;</span><span class="p">,</span> <span class="s">&quot;RAID5 (right asymmetric)&quot;</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid5_ls&quot;</span><span class="p">,</span> <span class="s">&quot;RAID5 (left symmetric)&quot;</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid5_rs&quot;</span><span class="p">,</span> <span class="s">&quot;RAID5 (right symmetric)&quot;</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid6_zr&quot;</span><span class="p">,</span> <span class="s">&quot;RAID6 (zero restart)&quot;</span><span class="p">,</span>		<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ALGORITHM_ROTATING_ZERO_RESTART</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid6_nr&quot;</span><span class="p">,</span> <span class="s">&quot;RAID6 (N restart)&quot;</span><span class="p">,</span>		<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ALGORITHM_ROTATING_N_RESTART</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;raid6_nc&quot;</span><span class="p">,</span> <span class="s">&quot;RAID6 (N continue)&quot;</span><span class="p">,</span>		<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ALGORITHM_ROTATING_N_CONTINUE</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">raid_type</span> <span class="o">*</span><span class="nf">get_raid_type</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">raid_types</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">raid_types</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">raid_types</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="nf">context_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_type</span> <span class="o">*</span><span class="n">raid_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">raid_devs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors_per_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raid_devs</span> <span class="o">&lt;=</span> <span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">parity_devs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Insufficient number of devices&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sectors_per_dev</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sector_div</span><span class="p">(</span><span class="n">sectors_per_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">raid_devs</span> <span class="o">-</span> <span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">parity_devs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Target length not divisible by number of data devices&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rs</span><span class="p">)</span> <span class="o">+</span> <span class="n">raid_devs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Cannot allocate raid context&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mddev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>

	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span> <span class="o">=</span> <span class="n">ti</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span> <span class="o">=</span> <span class="n">raid_type</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">raid_devs</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">sectors_per_dev</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">raid_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">md_rdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remaining items to be initialized by further RAID params:</span>
<span class="cm">	 *  rs-&gt;md.persistent</span>
<span class="cm">	 *  rs-&gt;md.external</span>
<span class="cm">	 *  rs-&gt;md.chunk_sectors</span>
<span class="cm">	 *  rs-&gt;md.new_chunk_sectors</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">rs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">context_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">)</span>
			<span class="n">dm_put_device</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">);</span>
		<span class="n">md_rdev_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">)</span>
			<span class="n">dm_put_device</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For every device we have two words</span>
<span class="cm"> *  &lt;meta_dev&gt;: meta device name or &#39;-&#39; if missing</span>
<span class="cm"> *  &lt;data_dev&gt;: data device name or &#39;-&#39; if missing</span>
<span class="cm"> *</span>
<span class="cm"> * The following are permitted:</span>
<span class="cm"> *    - -</span>
<span class="cm"> *    - &lt;data_dev&gt;</span>
<span class="cm"> *    &lt;meta_dev&gt; &lt;data_dev&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * The following is not allowed:</span>
<span class="cm"> *    &lt;meta_dev&gt; -</span>
<span class="cm"> *</span>
<span class="cm"> * This code parses those words.  If there is a failure,</span>
<span class="cm"> * the caller must use context_free to unwind the operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_parms</span><span class="p">(</span><span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rebuild</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">metadata_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">argv</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * There are no offsets, since there is a separate device</span>
<span class="cm">		 * for data and metadata.</span>
<span class="cm">		 */</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">mddev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;-&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dm_get_device</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					    <span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">);</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;RAID metadata device lookup failure&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">sb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">sb_page</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">recovery_offset</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Drive designated for rebuild not specified&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;No data device supplied with metadata device&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dm_get_device</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				    <span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">),</span>
				    <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;RAID device lookup failure&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">metadata_available</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">meta_bdev</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">same_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">disks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rebuild</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">metadata_available</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rebuild</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Without metadata, we will not be able to tell if the array</span>
<span class="cm">		 * is in-sync or not - we must assume it is not.  Therefore,</span>
<span class="cm">		 * it is impossible to rebuild a drive.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Even if there is metadata, the on-disk information may</span>
<span class="cm">		 * indicate that the array is not in-sync and it will then</span>
<span class="cm">		 * fail at that time.</span>
<span class="cm">		 *</span>
<span class="cm">		 * User could specify &#39;nosync&#39; option if desperate.</span>
<span class="cm">		 */</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Unable to rebuild drive while array is not in-sync&quot;</span><span class="p">);</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;RAID device lookup failure&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * validate_region_size</span>
<span class="cm"> * @rs</span>
<span class="cm"> * @region_size:  region size in sectors.  If 0, pick a size (4MiB default).</span>
<span class="cm"> *</span>
<span class="cm"> * Set rs-&gt;md.bitmap_info.chunksize (which really refers to &#39;region size&#39;).</span>
<span class="cm"> * Ensure that (ti-&gt;len/region_size &lt; 2^21) - required by MD bitmap.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_region_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">region_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_region_size</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">region_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Choose a reasonable default.  All figures in sectors.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_region_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;Choosing default region size of %lu sectors&quot;</span><span class="p">,</span>
			       <span class="n">region_size</span><span class="p">);</span>
			<span class="n">region_size</span> <span class="o">=</span> <span class="n">min_region_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;Choosing default region size of 4MiB&quot;</span><span class="p">);</span>
			<span class="n">region_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="cm">/* sectors */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Validate user-supplied value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">region_size</span> <span class="o">&gt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Supplied region size is too large&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">region_size</span> <span class="o">&lt;</span> <span class="n">min_region_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Supplied region_size (%lu sectors) below minimum (%lu)&quot;</span><span class="p">,</span>
			      <span class="n">region_size</span><span class="p">,</span> <span class="n">min_region_size</span><span class="p">);</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Supplied region size is too small&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">region_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Region size is not a power of 2&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">region_size</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Region size is smaller than the chunk size&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert sectors to bytes.</span>
<span class="cm">	 */</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Possible arguments are...</span>
<span class="cm"> *	&lt;chunk_size&gt; [optional_args]</span>
<span class="cm"> *</span>
<span class="cm"> * Argument definitions</span>
<span class="cm"> *    &lt;chunk_size&gt;			The number of sectors per disk that</span>
<span class="cm"> *                                      will form the &quot;stripe&quot;</span>
<span class="cm"> *    [[no]sync]			Force or prevent recovery of the</span>
<span class="cm"> *                                      entire array</span>
<span class="cm"> *    [rebuild &lt;idx&gt;]			Rebuild the drive indicated by the index</span>
<span class="cm"> *    [daemon_sleep &lt;ms&gt;]		Time between bitmap daemon work to</span>
<span class="cm"> *                                      clear bits</span>
<span class="cm"> *    [min_recovery_rate &lt;kB/sec/disk&gt;]	Throttle RAID initialization</span>
<span class="cm"> *    [max_recovery_rate &lt;kB/sec/disk&gt;]	Throttle RAID initialization</span>
<span class="cm"> *    [write_mostly &lt;idx&gt;]		Indicate a write mostly drive via index</span>
<span class="cm"> *    [max_write_behind &lt;sectors&gt;]	See &#39;-write-behind=&#39; (man mdadm)</span>
<span class="cm"> *    [stripe_cache &lt;sectors&gt;]		Stripe cache size for higher RAIDs</span>
<span class="cm"> *    [region_size &lt;sectors&gt;]           Defines granularity of bitmap</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_raid_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">num_raid_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">rebuild_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">,</span> <span class="n">region_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, parse the in-order required arguments</span>
<span class="cm">	 * &quot;chunk_size&quot; is the only argument of this type.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Bad chunk size&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Ignoring chunk size parameter for RAID 1&quot;</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Chunk size must be a power of 2&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Chunk size value is too small&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">argv</span><span class="o">++</span><span class="p">;</span>
	<span class="n">num_raid_params</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We set each individual device as In_sync with a completed</span>
<span class="cm">	 * &#39;recovery_offset&#39;.  If there has been a device failure or</span>
<span class="cm">	 * replacement then one of the following cases applies:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   1) User specifies &#39;rebuild&#39;.</span>
<span class="cm">	 *      - Device is reset when param is read.</span>
<span class="cm">	 *   2) A new device is supplied.</span>
<span class="cm">	 *      - No matching superblock found, resets device.</span>
<span class="cm">	 *   3) Device failure was transient and returns on reload.</span>
<span class="cm">	 *      - Failure noticed, resets device for bitmap replay.</span>
<span class="cm">	 *   4) Device hadn&#39;t completed recovery after previous failure.</span>
<span class="cm">	 *      - Superblock is read and overrides recovery_offset.</span>
<span class="cm">	 *</span>
<span class="cm">	 * What is found in the superblocks of the devices is always</span>
<span class="cm">	 * authoritative, unless &#39;rebuild&#39; or &#39;[no]sync&#39; was specified.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Second, parse the unordered optional arguments</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_raid_params</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;nosync&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_NOSYNC</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;sync&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_SYNC</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The rest of the optional arguments come in key/value pairs */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_raid_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Wrong number of raid parameters given&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">key</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Bad numerical argument given in raid params&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;rebuild&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rebuild_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">rebuild_cnt</span> <span class="o">&gt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">parity_devs</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">rebuild_cnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Too many rebuild devices specified for given RAID type&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Invalid rebuild index given&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_REBUILD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;write_mostly&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;write_mostly option is only valid for RAID1&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Invalid write_mostly drive index given&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;max_write_behind&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;max_write_behind option is only valid for RAID1&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_MAX_WRITE_BEHIND</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * In device-mapper, we specify things in sectors, but</span>
<span class="cm">			 * MD records this value in kB</span>
<span class="cm">			 */</span>
			<span class="n">value</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">COUNTER_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Max write-behind limit out of range&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;daemon_sleep&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_DAEMON_SLEEP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span> <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;daemon sleep period out of range&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;stripe_cache&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_STRIPE_CACHE</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * In device-mapper, we specify things in sectors, but</span>
<span class="cm">			 * MD records this value in kB</span>
<span class="cm">			 */</span>
			<span class="n">value</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Inappropriate argument: stripe_cache&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raid5_set_cache_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Bad stripe_cache size&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;min_recovery_rate&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_MIN_RECOVERY_RATE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;min_recovery_rate out of range&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">sync_speed_min</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;max_recovery_rate&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_MAX_RECOVERY_RATE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;max_recovery_rate out of range&quot;</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">sync_speed_max</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;region_size&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">|=</span> <span class="n">DMPF_REGION_SIZE</span><span class="p">;</span>
			<span class="n">region_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Unable to parse RAID parameter: %s&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Unable to parse RAID parameters&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">validate_region_size</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">region_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">split_io</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">split_io</span> <span class="o">=</span> <span class="n">region_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">split_io</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">split_io</span> <span class="o">=</span> <span class="n">region_size</span><span class="p">;</span>

	<span class="cm">/* Assume there are no metadata devices until the drives are parsed */</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">external</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_table_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_set</span><span class="p">,</span> <span class="n">md</span><span class="p">.</span><span class="n">event_work</span><span class="p">);</span>

	<span class="n">dm_table_event</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid_is_congested</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_callbacks</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_set</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">md_raid1_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">md_raid5_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This structure is never routinely used by userspace, unlike md superblocks.</span>
<span class="cm"> * Devices with this superblock should only ever be accessed via device-mapper.</span>
<span class="cm"> */</span>
<span class="cp">#define DM_RAID_MAGIC 0x64526D44</span>
<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">magic</span><span class="p">;</span>		<span class="cm">/* &quot;DmRd&quot; */</span>
	<span class="n">__le32</span> <span class="n">features</span><span class="p">;</span>	<span class="cm">/* Used to indicate possible future changes */</span>

	<span class="n">__le32</span> <span class="n">num_devices</span><span class="p">;</span>	<span class="cm">/* Number of devices in this array. (Max 64) */</span>
	<span class="n">__le32</span> <span class="n">array_position</span><span class="p">;</span>	<span class="cm">/* The position of this drive in the array */</span>

	<span class="n">__le64</span> <span class="n">events</span><span class="p">;</span>		<span class="cm">/* Incremented by md when superblock updated */</span>
	<span class="n">__le64</span> <span class="n">failed_devices</span><span class="p">;</span>	<span class="cm">/* Bit field of devices to indicate failures */</span>

	<span class="cm">/*</span>
<span class="cm">	 * This offset tracks the progress of the repair or replacement of</span>
<span class="cm">	 * an individual drive.</span>
<span class="cm">	 */</span>
	<span class="n">__le64</span> <span class="n">disk_recovery_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This offset tracks the progress of the initial array</span>
<span class="cm">	 * synchronisation/parity calculation.</span>
<span class="cm">	 */</span>
	<span class="n">__le64</span> <span class="n">array_resync_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RAID characteristics</span>
<span class="cm">	 */</span>
	<span class="n">__le32</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">layout</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">stripe_sectors</span><span class="p">;</span>

	<span class="n">__u8</span> <span class="n">pad</span><span class="p">[</span><span class="mi">452</span><span class="p">];</span>		<span class="cm">/* Round struct to 512 bytes. */</span>
				<span class="cm">/* Always set to 0 when writing. */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_disk_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Failed to read superblock of device at position %d&quot;</span><span class="p">,</span>
		      <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">super_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">failed_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_set</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">failed_devices</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">failed_devices</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">)))</span>
			<span class="n">failed_devices</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">));</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DM_RAID_MAGIC</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* No features yet */</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">array_position</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">failed_devices</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">failed_devices</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">disk_recovery_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">array_resync_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">stripe_sectors</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * super_load</span>
<span class="cm"> *</span>
<span class="cm"> * This function creates a superblock if one is not found on the device</span>
<span class="cm"> * and will decide which superblock to use if there&#39;s a choice.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: 1 if use rdev, 0 if use refdev, -Exxx otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">refdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">refsb</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">events_sb</span><span class="p">,</span> <span class="n">events_refsb</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_disk_sb</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Two cases that we want to write new superblocks and rebuild:</span>
<span class="cm">	 * 1) New device (no matching magic number)</span>
<span class="cm">	 * 2) Device specified for rebuild (!In_sync w/ offset == 0)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DM_RAID_MAGIC</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">super_sync</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">FirstUse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Force writing of superblocks to disk */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Any superblock is better than none, choose that if given */</span>
		<span class="k">return</span> <span class="n">refdev</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">refdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">events_sb</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="n">refsb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">events_refsb</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">refsb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">events_sb</span> <span class="o">&gt;</span> <span class="n">events_refsb</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_init_validation</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">role</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_set</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="kt">uint64_t</span> <span class="n">events_sb</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">failed_devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">new_devs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rebuilds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">sb2</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">events_sb</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="n">failed_devices</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">failed_devices</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialise to 1 if this is a new superblock.</span>
<span class="cm">	 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">events_sb</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reshaping is not currently allowed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">stripe_sectors</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Reshaping arrays not yet supported.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We can only change the number of devices in RAID1 right now */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Reshaping arrays not yet supported.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMPF_SYNC</span> <span class="o">|</span> <span class="n">DMPF_NOSYNC</span><span class="p">)))</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">array_resync_offset</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * During load, we set FirstUse if a new superblock was written.</span>
<span class="cm">	 * There are two reasons we might not have a superblock:</span>
<span class="cm">	 * 1) The array is brand new - in which case, all of the</span>
<span class="cm">	 *    devices must have their In_sync bit set.  Also,</span>
<span class="cm">	 *    recovery_cp must be 0, unless forced.</span>
<span class="cm">	 * 2) This is a new device being added to an old array</span>
<span class="cm">	 *    and the new device needs to be rebuilt - in which</span>
<span class="cm">	 *    case the In_sync bit will /not/ be set and</span>
<span class="cm">	 *    recovery_cp must be MaxSector.</span>
<span class="cm">	 */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;Device %d specified for rebuild: &quot;</span>
			       <span class="s">&quot;Clearing superblock&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
			<span class="n">rebuilds</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FirstUse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">new_devs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rebuilds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_devs</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;Superblocks created for new array&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_ARRAY_FIRST_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_devs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;New device injected &quot;</span>
			      <span class="s">&quot;into existing array without &#39;rebuild&#39; &quot;</span>
			      <span class="s">&quot;parameter specified&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_devs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;&#39;rebuild&#39; devices cannot be &quot;</span>
		      <span class="s">&quot;injected into an array with other first-time devices&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;&#39;rebuild&#39; specified while array is not in-sync&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we set the Faulty bit for those devices that are</span>
<span class="cm">	 * recorded in the superblock as failed.</span>
<span class="cm">	 */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sb2</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
		<span class="n">sb2</span><span class="o">-&gt;</span><span class="n">failed_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check for any device re-ordering.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FirstUse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">role</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb2</span><span class="o">-&gt;</span><span class="n">array_position</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Cannot change device &quot;</span>
						<span class="s">&quot;positions in RAID array&quot;</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;RAID1 device #%d now at position #%d&quot;</span><span class="p">,</span>
				       <span class="n">role</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Partial recovery is performed on</span>
<span class="cm">			 * returning failed devices.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">failed_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">role</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_raid_superblock</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If mddev-&gt;events is not set, we know we have not yet initialized</span>
<span class="cm">	 * the array.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="n">super_init_validation</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* Enable bitmap creation */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FirstUse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">disk_recovery_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a device comes back, set it as not In_sync and no longer faulty.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FirstUse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analyse superblocks and select the freshest.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">analyse_superblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">redundancy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">freshest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">redundancy</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">redundancy</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">parity_devs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Unknown RAID type&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">freshest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rdev_for_each_safe</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">super_load</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">freshest</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">freshest</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid_dev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">redundancy</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">meta_dev</span><span class="p">)</span>
					<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">meta_dev</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">meta_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span>
					<span class="n">put_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * We might be able to salvage the data device</span>
<span class="cm">				 * even though the meta device has failed.  For</span>
<span class="cm">				 * now, we behave as though &#39;- -&#39; had been</span>
<span class="cm">				 * set for this device in the table.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_dev</span><span class="p">)</span>
					<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_dev</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">);</span>

				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Failed to load superblock&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freshest</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validation of the freshest device provides the source of</span>
<span class="cm">	 * validation for the remaining devices.</span>
<span class="cm">	 */</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Unable to assemble array: Invalid superblocks&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">super_validate</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">freshest</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span> <span class="o">!=</span> <span class="n">freshest</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">super_validate</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Construct a RAID4/5/6 mapping:</span>
<span class="cm"> * Args:</span>
<span class="cm"> *	&lt;raid_type&gt; &lt;#raid_params&gt; &lt;raid_params&gt;		\</span>
<span class="cm"> *	&lt;#raid_devs&gt; { &lt;meta_dev1&gt; &lt;dev1&gt; .. &lt;meta_devN&gt; &lt;devN&gt; }</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;raid_params&gt; varies by &lt;raid_type&gt;.  See &#39;parse_raid_params&#39; for</span>
<span class="cm"> * details on possible &lt;raid_params&gt;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_type</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_raid_params</span><span class="p">,</span> <span class="n">num_raid_devs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Must have at least &lt;raid_type&gt; &lt;#raid_params&gt; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Too few arguments&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* raid type */</span>
	<span class="n">rt</span> <span class="o">=</span> <span class="n">get_raid_type</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Unrecognised raid_type&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
	<span class="n">argv</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* number of RAID parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_raid_params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Cannot understand number of RAID parameters&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
	<span class="n">argv</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Skip over RAID params for now and find out # of devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_raid_params</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Arguments do not agree with counts given&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">num_raid_params</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_raid_devs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">num_raid_devs</span> <span class="o">&gt;=</span> <span class="n">INT_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Cannot understand number of raid devices&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">context_alloc</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">num_raid_devs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">parse_raid_params</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">num_raid_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">argc</span> <span class="o">-=</span> <span class="n">num_raid_params</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* +1: we already have num_raid_devs */</span>
	<span class="n">argv</span> <span class="o">+=</span> <span class="n">num_raid_params</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="p">(</span><span class="n">num_raid_devs</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Supplied RAID devices does not match the count given&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_parms</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">sync_super</span> <span class="o">=</span> <span class="n">super_sync</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">analyse_superblocks</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">event_work</span><span class="p">,</span> <span class="n">do_table_event</span><span class="p">);</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">rs</span><span class="p">;</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">num_flush_requests</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">reconfig_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">md_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Assume already marked dirty */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">reconfig_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Fail to run raid array&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="n">raid_is_congested</span><span class="p">;</span>
	<span class="n">dm_table_add_target_callbacks</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">);</span>

	<span class="n">mddev_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">context_free</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_dtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">md_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="n">context_free</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">make_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="n">status_type_t</span> <span class="n">type</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">raid_param_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* at least 1 for chunksize */</span>
	<span class="kt">unsigned</span> <span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">array_in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sync</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATUSTYPE_INFO</span>:
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%s %d &quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">sync</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">curr_resync_completed</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sync</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync</span> <span class="o">&gt;=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">array_in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">resync_max_sectors</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The array may be doing an initial sync, or it may</span>
<span class="cm">			 * be rebuilding individual components.  If all the</span>
<span class="cm">			 * devices are In_sync, then it is the array that is</span>
<span class="cm">			 * being initialized.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">array_in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Status characters:</span>
<span class="cm">		 *  &#39;D&#39; = Dead/Failed device</span>
<span class="cm">		 *  &#39;a&#39; = Alive but not in-sync</span>
<span class="cm">		 *  &#39;A&#39; = Alive and in-sync</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">array_in_sync</span> <span class="o">||</span>
				 <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * In-sync ratio:</span>
<span class="cm">		 *  The in-sync ratio shows the progress of:</span>
<span class="cm">		 *   - Initializing the array</span>
<span class="cm">		 *   - Rebuilding a subset of devices of the array</span>
<span class="cm">		 *  The user can distinguish between the two by referring</span>
<span class="cm">		 *  to the status characters.</span>
<span class="cm">		 */</span>
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; %llu/%llu&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sync</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">resync_max_sectors</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATUSTYPE_TABLE</span>:
		<span class="cm">/* The string you would use to construct this array */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_REBUILD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">raid_param_cnt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* for rebuilds */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">raid_param_cnt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">raid_param_cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">hweight32</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMPF_REBUILD</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMPF_SYNC</span> <span class="o">|</span> <span class="n">DMPF_NOSYNC</span><span class="p">))</span>
			<span class="n">raid_param_cnt</span><span class="o">--</span><span class="p">;</span>

		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%s %u %u&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">raid_type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">raid_param_cnt</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_SYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">))</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; sync&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_NOSYNC</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; nosync&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_REBUILD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; rebuild %u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_DAEMON_SLEEP</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; daemon_sleep %lu&quot;</span><span class="p">,</span>
			       <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_MIN_RECOVERY_RATE</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; min_recovery_rate %d&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">sync_speed_min</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_MAX_RECOVERY_RATE</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; max_recovery_rate %d&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">sync_speed_max</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; write_mostly %u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_MAX_WRITE_BEHIND</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; max_write_behind %lu&quot;</span><span class="p">,</span>
			       <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_STRIPE_CACHE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>

			<span class="cm">/* convert from kiB to sectors */</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; stripe_cache %d&quot;</span><span class="p">,</span>
			       <span class="n">conf</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">print_flags</span> <span class="o">&amp;</span> <span class="n">DMPF_REGION_SIZE</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; region_size %lu&quot;</span><span class="p">,</span>
			       <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="p">)</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; -&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">)</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot; -&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid_iterate_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="n">iterate_devices_callout_fn</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span>
				 <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_dev</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="cm">/* No offset on data devs */</span>
				 <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">dev_sectors</span><span class="p">,</span>
				 <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_io_hints</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue_limits</span> <span class="o">*</span><span class="n">limits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>

	<span class="n">blk_limits_io_min</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>
	<span class="n">blk_limits_io_opt</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_presuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">md_stop_writes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_postsuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">mddev_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid_set</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">bitmap_loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">bitmap_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">.</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">mddev_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">target_type</span> <span class="n">raid_target</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;raid&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">raid_ctr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr</span> <span class="o">=</span> <span class="n">raid_dtr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">raid_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">raid_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iterate_devices</span> <span class="o">=</span> <span class="n">raid_iterate_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">io_hints</span> <span class="o">=</span> <span class="n">raid_io_hints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">presuspend</span> <span class="o">=</span> <span class="n">raid_presuspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">postsuspend</span> <span class="o">=</span> <span class="n">raid_postsuspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">raid_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dm_raid_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dm_register_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dm_raid_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dm_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_target</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dm_raid_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dm_raid_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DM_NAME</span> <span class="s">&quot; raid4/5/6 target&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dm-raid4&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dm-raid5&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dm-raid6&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Neil Brown &lt;dm-devel@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
