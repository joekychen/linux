<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › dm-mpath.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dm-mpath.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2003 Sistina Software Limited.</span>
<span class="cm"> * Copyright (C) 2004-2005 Red Hat, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device-mapper.h&gt;</span>

<span class="cp">#include &quot;dm-path-selector.h&quot;</span>
<span class="cp">#include &quot;dm-uevent.h&quot;</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dh.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#define DM_MSG_PREFIX &quot;multipath&quot;</span>
<span class="cp">#define DM_PG_INIT_DELAY_MSECS 2000</span>
<span class="cp">#define DM_PG_INIT_DELAY_DEFAULT ((unsigned) -1)</span>

<span class="cm">/* Path properties */</span>
<span class="k">struct</span> <span class="n">pgpath</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>	<span class="cm">/* Owning PG */</span>
	<span class="kt">unsigned</span> <span class="n">is_active</span><span class="p">;</span>		<span class="cm">/* Path status */</span>
	<span class="kt">unsigned</span> <span class="n">fail_count</span><span class="p">;</span>		<span class="cm">/* Cumulative failure count */</span>

	<span class="k">struct</span> <span class="n">dm_path</span> <span class="n">path</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">activate_path</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define path_to_pgpath(__pgp) container_of((__pgp), struct pgpath, path)</span>

<span class="cm">/*</span>
<span class="cm"> * Paths are grouped into Priority Groups and numbered from 1 upwards.</span>
<span class="cm"> * Each has a path selector which controls which path gets used.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">priority_group</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>		<span class="cm">/* Owning multipath instance */</span>
	<span class="k">struct</span> <span class="n">path_selector</span> <span class="n">ps</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">pg_num</span><span class="p">;</span>		<span class="cm">/* Reference number */</span>
	<span class="kt">unsigned</span> <span class="n">bypassed</span><span class="p">;</span>		<span class="cm">/* Temporarily bypass this PG? */</span>

	<span class="kt">unsigned</span> <span class="n">nr_pgpaths</span><span class="p">;</span>		<span class="cm">/* Number of paths in PG */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">pgpaths</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Multipath context */</span>
<span class="k">struct</span> <span class="n">multipath</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_handler_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">hw_handler_params</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">nr_priority_groups</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">priority_groups</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">pg_init_wait</span><span class="p">;</span>	<span class="cm">/* Wait for pg_init completion */</span>

	<span class="kt">unsigned</span> <span class="n">pg_init_required</span><span class="p">;</span>	<span class="cm">/* pg_init needs calling? */</span>
	<span class="kt">unsigned</span> <span class="n">pg_init_in_progress</span><span class="p">;</span>	<span class="cm">/* Only one pg_init allowed at once */</span>
	<span class="kt">unsigned</span> <span class="n">pg_init_delay_retry</span><span class="p">;</span>	<span class="cm">/* Delay pg_init retry? */</span>

	<span class="kt">unsigned</span> <span class="n">nr_valid_paths</span><span class="p">;</span>	<span class="cm">/* Total number of usable paths */</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">current_pgpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">current_pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">next_pg</span><span class="p">;</span>	<span class="cm">/* Switch to this PG if set */</span>
	<span class="kt">unsigned</span> <span class="n">repeat_count</span><span class="p">;</span>		<span class="cm">/* I/Os left before calling PS again */</span>

	<span class="kt">unsigned</span> <span class="n">queue_io</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Must we queue all I/O? */</span>
	<span class="kt">unsigned</span> <span class="n">queue_if_no_path</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Queue I/O if last path fails? */</span>
	<span class="kt">unsigned</span> <span class="n">saved_queue_if_no_path</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Saved state during suspension */</span>

	<span class="kt">unsigned</span> <span class="n">pg_init_retries</span><span class="p">;</span>	<span class="cm">/* Number of times to retry pg_init */</span>
	<span class="kt">unsigned</span> <span class="n">pg_init_count</span><span class="p">;</span>		<span class="cm">/* Number of times pg_init called */</span>
	<span class="kt">unsigned</span> <span class="n">pg_init_delay_msecs</span><span class="p">;</span>	<span class="cm">/* Number of msecs before pg_init retry */</span>

	<span class="kt">unsigned</span> <span class="n">queue_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">process_queued_ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queued_ios</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">trigger_event</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must use a mempool of dm_mpath_io structs so that we</span>
<span class="cm">	 * can resubmit bios on error.</span>
<span class="cm">	 */</span>
	<span class="n">mempool_t</span> <span class="o">*</span><span class="n">mpio_pool</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">work_mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Context information attached to each bio we process.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nr_bytes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">action_fn</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">);</span>

<span class="cp">#define MIN_IOS 256	</span><span class="cm">/* Mempool size */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">_mpio_cache</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">*</span><span class="n">kmpath_handlerd</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_queued_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">trigger_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">activate_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>


<span class="cm">/*-----------------------------------------------</span>
<span class="cm"> * Allocation routines</span>
<span class="cm"> *-----------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="nf">alloc_pgpath</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pgpath</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">activate_path</span><span class="p">,</span> <span class="n">activate_path</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pgpath</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_pgpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="nf">alloc_priority_group</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

	<span class="n">pg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_pgpaths</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pgpaths</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pgpath</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">)</span>
			<span class="n">scsi_dh_detach</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">));</span>
		<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_pgpath</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_priority_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">path_selector</span> <span class="o">*</span><span class="n">ps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
		<span class="n">dm_put_path_selector</span><span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_pgpaths</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">ti</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="nf">alloc_multipath</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queued_ios</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span> <span class="o">=</span> <span class="n">DM_PG_INIT_DELAY_DEFAULT</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">,</span> <span class="n">process_queued_ios</span><span class="p">);</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">,</span> <span class="n">trigger_event</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_wait</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">work_mutex</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mpio_pool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="n">MIN_IOS</span><span class="p">,</span> <span class="n">_mpio_cache</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mpio_pool</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span> <span class="o">=</span> <span class="n">ti</span><span class="p">;</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_multipath</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">free_priority_group</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_params</span><span class="p">);</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mpio_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mapinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="o">*</span><span class="n">mpio</span><span class="p">;</span>

	<span class="n">mpio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mpio_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpio</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">mpio</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_mapinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="o">*</span><span class="n">mpio</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mpio</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mpio_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------</span>
<span class="cm"> * Path selection</span>
<span class="cm"> *-----------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pg_init_all_paths</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pg_init_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_retry</span><span class="p">)</span>
		<span class="n">pg_init_delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span> <span class="o">!=</span> <span class="n">DM_PG_INIT_DELAY_DEFAULT</span> <span class="o">?</span>
						 <span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span> <span class="o">:</span> <span class="n">DM_PG_INIT_DELAY_MSECS</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pgpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip failed paths */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">kmpath_handlerd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">activate_path</span><span class="p">,</span>
				       <span class="n">pg_init_delay</span><span class="p">))</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__switch_pg</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="p">;</span>

	<span class="cm">/* Must we initialise the PG first, and queue I/O till it&#39;s ready? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__choose_path_in_pg</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">nr_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_path</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">select_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">repeat_count</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="n">path_to_pgpath</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">!=</span> <span class="n">pg</span><span class="p">)</span>
		<span class="n">__switch_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__choose_pgpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">bypassed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* Were we instructed to switch PG? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__choose_path_in_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t change PG until it has no remaining paths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">__choose_path_in_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through priority groups until we find a valid path.</span>
<span class="cm">	 * First time we skip PGs marked &#39;bypassed&#39;.</span>
<span class="cm">	 * Second time we only try the ones we skipped, but set</span>
<span class="cm">	 * pg_init_delay_retry so we do not hammer controllers.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">bypassed</span> <span class="o">==</span> <span class="n">bypassed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__choose_path_in_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bypassed</span><span class="p">)</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bypassed</span><span class="o">--</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether bios must be queued in the device-mapper core rather</span>
<span class="cm"> * than here in the target.</span>
<span class="cm"> *</span>
<span class="cm"> * m-&gt;lock must be held on entry.</span>
<span class="cm"> *</span>
<span class="cm"> * If m-&gt;queue_if_no_path and m-&gt;saved_queue_if_no_path hold the</span>
<span class="cm"> * same value then we are not between multipath_presuspend()</span>
<span class="cm"> * and multipath_resume() calls and we have no need to check</span>
<span class="cm"> * for the DMF_NOFLUSH_SUSPENDING flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__must_push_back</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">saved_queue_if_no_path</span> <span class="o">&amp;&amp;</span>
		<span class="n">dm_noflush_suspending</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">clone</span><span class="p">,</span>
		  <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map_context</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">was_queued</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nr_bytes</span> <span class="o">=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">clone</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="o">*</span><span class="n">mpio</span> <span class="o">=</span> <span class="n">map_context</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Do we need to select a new pgpath? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">repeat_count</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">repeat_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">__choose_pgpath</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">);</span>

	<span class="n">pgpath</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_queued</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_size</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pgpath</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">pgpath</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Queue for the daemon to resubmit */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clone</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queued_ios</span><span class="p">);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_size</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">);</span>
		<span class="n">pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">clone</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">clone</span><span class="o">-&gt;</span><span class="n">rq_disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">__must_push_back</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">DM_MAPIO_REQUEUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>	<span class="cm">/* Failed */</span>

	<span class="n">mpio</span><span class="o">-&gt;</span><span class="n">pgpath</span> <span class="o">=</span> <span class="n">pgpath</span><span class="p">;</span>
	<span class="n">mpio</span><span class="o">-&gt;</span><span class="n">nr_bytes</span> <span class="o">=</span> <span class="n">nr_bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">DM_MAPIO_REMAPPED</span> <span class="o">&amp;&amp;</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">start_io</span><span class="p">)</span>
		<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">start_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
					      <span class="n">nr_bytes</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we run out of usable paths, should we queue I/O or error it?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_if_no_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">queue_if_no_path</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">save_old_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">save_old_value</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">saved_queue_if_no_path</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">saved_queue_if_no_path</span> <span class="o">=</span> <span class="n">queue_if_no_path</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span> <span class="o">=</span> <span class="n">queue_if_no_path</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_size</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * The multipath daemon is responsible for resubmitting queued ios.</span>
<span class="cm"> *---------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispatch_queued_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">clone</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queued_ios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl</span><span class="p">,</span> <span class="n">queuelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clone</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">);</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">dm_get_rq_mapinfo</span><span class="p">(</span><span class="n">clone</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">map_io</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">clone</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_mapinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">dm_kill_unmapped_request</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">DM_MAPIO_REMAPPED</span><span class="p">)</span>
			<span class="n">dm_dispatch_request</span><span class="p">(</span><span class="n">clone</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">DM_MAPIO_REQUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_mapinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">dm_requeue_unmapped_request</span><span class="p">(</span><span class="n">clone</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_queued_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">multipath</span><span class="p">,</span> <span class="n">process_queued_ios</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">must_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">)</span>
		<span class="n">__choose_pgpath</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pgpath</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pgpath</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">pgpath</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span><span class="p">))</span>
		<span class="n">must_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span> <span class="o">&amp;&amp;</span> <span class="n">pgpath</span><span class="p">)</span>
		<span class="n">__pg_init_all_paths</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">must_queue</span><span class="p">)</span>
		<span class="n">dispatch_queued_ios</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An event is triggered whenever a path is taken out of use.</span>
<span class="cm"> * Includes path failure and PG bypass.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">trigger_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">multipath</span><span class="p">,</span> <span class="n">trigger_event</span><span class="p">);</span>

	<span class="n">dm_table_event</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Constructor/argument parsing:</span>
<span class="cm"> * &lt;#multipath feature args&gt; [&lt;arg&gt;]*</span>
<span class="cm"> * &lt;#hw_handler args&gt; [hw_handler [&lt;arg&gt;]*]</span>
<span class="cm"> * &lt;#priority groups&gt;</span>
<span class="cm"> * &lt;initial priority group&gt;</span>
<span class="cm"> *     [&lt;selector&gt; &lt;#selector args&gt; [&lt;arg&gt;]*</span>
<span class="cm"> *      &lt;#paths&gt; &lt;#per-path selector args&gt;</span>
<span class="cm"> *         [&lt;path&gt; [&lt;arg&gt;]* ]+ ]+</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_path_selector</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">path_selector_type</span> <span class="o">*</span><span class="n">pst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ps_argc</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_arg</span> <span class="n">_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid number of path selector args&quot;</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">pst</span> <span class="o">=</span> <span class="n">dm_get_path_selector</span><span class="p">(</span><span class="n">dm_shift_arg</span><span class="p">(</span><span class="n">as</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;unknown path selector type&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg_group</span><span class="p">(</span><span class="n">_args</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps_argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put_path_selector</span><span class="p">(</span><span class="n">pst</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pst</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="n">ps_argc</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put_path_selector</span><span class="p">(</span><span class="n">pst</span><span class="p">);</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;path selector constructor failed&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pst</span><span class="p">;</span>
	<span class="n">dm_consume_args</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">ps_argc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="nf">parse_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path_selector</span> <span class="o">*</span><span class="n">ps</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* we need at least a path arg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;no device given&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">alloc_pgpath</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_get_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">dm_shift_arg</span><span class="p">(</span><span class="n">as</span><span class="p">),</span> <span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;error getting device&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_dh_attach</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Already attached to different hw_handler,</span>
<span class="cm">			 * try to reattach with correct one.</span>
<span class="cm">			 */</span>
			<span class="n">scsi_dh_detach</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_dh_attach</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;error attaching hardware handler&quot;</span><span class="p">;</span>
			<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_dh_set_params</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_params</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;unable to set hardware &quot;</span>
							<span class="s">&quot;handler parameters&quot;</span><span class="p">;</span>
				<span class="n">scsi_dh_detach</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
				<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">add_path</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>

 <span class="nl">bad:</span>
	<span class="n">free_pgpath</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="nf">parse_priority_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_arg</span> <span class="n">_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid number of paths&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid number of selector args&quot;</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_selector_args</span><span class="p">,</span> <span class="n">nr_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;not enough priority group arguments&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pg</span> <span class="o">=</span> <span class="n">alloc_priority_group</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;couldn&#39;t allocate priority group&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">parse_path_selector</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">ti</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * read the paths</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">nr_pgpaths</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_selector_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">nr_args</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nr_selector_args</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">nr_pgpaths</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="n">path_args</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="n">nr_args</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;not enough path parameters&quot;</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">path_args</span><span class="p">.</span><span class="n">argc</span> <span class="o">=</span> <span class="n">nr_args</span><span class="p">;</span>
		<span class="n">path_args</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">;</span>

		<span class="n">pgpath</span> <span class="o">=</span> <span class="n">parse_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="n">ti</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pgpath</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span> <span class="o">=</span> <span class="n">pg</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">);</span>
		<span class="n">dm_consume_args</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">nr_args</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pg</span><span class="p">;</span>

 <span class="nl">bad:</span>
	<span class="n">free_priority_group</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">ti</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_hw_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">hw_argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_arg</span> <span class="n">_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid number of hardware handler args&quot;</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_read_arg_group</span><span class="p">(</span><span class="n">_args</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">dm_shift_arg</span><span class="p">(</span><span class="n">as</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_then_request_module</span><span class="p">(</span><span class="n">scsi_dh_handler_exist</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">),</span>
				     <span class="s">&quot;scsi_dh_%s&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;unknown hardware handler type&quot;</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hw_argc</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_params</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;memory allocation failed&quot;</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">hw_argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">+=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hw_argc</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">+=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">dm_consume_args</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">hw_argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">argc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg_name</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_arg</span> <span class="n">_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;invalid number of feature args&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s">&quot;pg_init_retries must be between 1 and 50&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="s">&quot;pg_init_delay_msecs must be between 0 and 60000&quot;</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg_group</span><span class="p">(</span><span class="n">_args</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">arg_name</span> <span class="o">=</span> <span class="n">dm_shift_arg</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
		<span class="n">argc</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="s">&quot;queue_if_no_path&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">queue_if_no_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="s">&quot;pg_init_retries&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_retries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="s">&quot;pg_init_delay_msecs&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Unrecognised multipath feature request&quot;</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* target arguments */</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_arg</span> <span class="n">_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid number of priority groups&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">&quot;invalid initial priority group number&quot;</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_arg_set</span> <span class="n">as</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">next_pg_num</span><span class="p">;</span>

	<span class="n">as</span><span class="p">.</span><span class="n">argc</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
	<span class="n">as</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">alloc_multipath</span><span class="p">(</span><span class="n">ti</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;can&#39;t allocate multipath&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">parse_features</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">parse_hw_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_read_arg</span><span class="p">(</span><span class="n">_args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_pg_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span> <span class="o">&amp;&amp;</span> <span class="n">next_pg_num</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">next_pg_num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;invalid initial priority group&quot;</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* parse the priority groups */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">as</span><span class="p">.</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

		<span class="n">pg</span> <span class="o">=</span> <span class="n">parse_priority_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span> <span class="o">+=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">nr_pgpaths</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">);</span>
		<span class="n">pg_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg_num</span> <span class="o">=</span> <span class="n">pg_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">next_pg_num</span><span class="p">)</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span> <span class="o">=</span> <span class="n">pg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg_count</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ti</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="s">&quot;priority group count mismatch&quot;</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">num_flush_requests</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ti</span><span class="o">-&gt;</span><span class="n">num_discard_requests</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">bad:</span>
	<span class="n">free_multipath</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">multipath_wait_for_pg_init_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">io_schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_multipath_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">kmpath_handlerd</span><span class="p">);</span>
	<span class="n">multipath_wait_for_pg_init_completion</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">multipath_dtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">flush_multipath_work</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="n">free_multipath</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map cloned requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">clone</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="p">)</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_mapinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">map_context</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* ENOMEM, requeue */</span>
		<span class="k">return</span> <span class="n">DM_MAPIO_REQUEUE</span><span class="p">;</span>

	<span class="n">clone</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_FAILFAST_TRANSPORT</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">map_io</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">clone</span><span class="p">,</span> <span class="n">map_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="n">DM_MAPIO_REQUEUE</span><span class="p">)</span>
		<span class="n">clear_mapinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">map_context</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Take a path out of use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fail_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Failing path %s.&quot;</span><span class="p">,</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">fail_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
	<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">fail_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dm_path_uevent</span><span class="p">(</span><span class="n">DM_UEVENT_PATH_FAILED</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span>
		      <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reinstate a previously-failed path</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reinstate_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">reinstate_path</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Reinstate path not supported by path selector %s&quot;</span><span class="p">,</span>
		       <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">reinstate_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="o">++</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">==</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_work</span><span class="p">(</span><span class="n">kmpath_handlerd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">activate_path</span><span class="p">.</span><span class="n">work</span><span class="p">))</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dm_path_uevent</span><span class="p">(</span><span class="n">DM_UEVENT_PATH_REINSTATED</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ti</span><span class="p">,</span>
		      <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fail or reinstate all paths that match the provided struct dm_dev.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">action_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">action_fn</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pgpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Temporarily try to avoid having to use the specified PG</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bypass_pg</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">bypassed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pg</span><span class="o">-&gt;</span><span class="n">bypassed</span> <span class="o">=</span> <span class="n">bypassed</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch to using the specified PG from the next I/O that gets mapped</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">switch_pg_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pgstr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pgnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgstr</span> <span class="o">||</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">pgstr</span><span class="p">,</span> <span class="s">&quot;%u%c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pgnum</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pgnum</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;invalid PG number supplied to switch_pg_num&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">bypassed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pgnum</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span> <span class="o">=</span> <span class="n">pg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">trigger_event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set/clear bypassed status of a PG.</span>
<span class="cm"> * PGs are numbered upwards from 1 in the order they were declared.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bypass_pg_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pgstr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bypassed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pgnum</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pgstr</span> <span class="o">||</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">pgstr</span><span class="p">,</span> <span class="s">&quot;%u%c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pgnum</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pgnum</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;invalid PG number supplied to bypass_pg&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">pgnum</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bypass_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">bypassed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Should we retry pg_init immediately?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pg_init_limit_reached</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit_reached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_count</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_retries</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit_reached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">limit_reached</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pg_init_done</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">delay_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* device or driver problems */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_DH_OK</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_DH_NOSYS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Could not failover the device: Handler scsi_dh_%s &quot;</span>
		      <span class="s">&quot;Error %d.&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">,</span> <span class="n">errors</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fail path for now, so we do not ping pong</span>
<span class="cm">		 */</span>
		<span class="n">fail_path</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_DH_DEV_TEMP_BUSY</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Probably doing something like FW upgrade on the</span>
<span class="cm">		 * controller so try the other pg.</span>
<span class="cm">		 */</span>
		<span class="n">bypass_pg</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_DH_RETRY</span>:
		<span class="cm">/* Wait before retrying. */</span>
		<span class="n">delay_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_DH_IMM_RETRY</span>:
	<span class="k">case</span> <span class="n">SCSI_DH_RES_TEMP_UNAVAIL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pg_init_limit_reached</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pgpath</span><span class="p">))</span>
			<span class="n">fail_path</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * We probably do not want to fail the path for a device</span>
<span class="cm">		 * error, but this is what the old dm did. In future</span>
<span class="cm">		 * patches we can do more advanced handling.</span>
<span class="cm">		 */</span>
		<span class="n">fail_path</span><span class="p">(</span><span class="n">pgpath</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;Could not failover device. Error %d.&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="p">);</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span><span class="p">)</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">bypassed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_in_progress</span><span class="p">)</span>
		<span class="cm">/* Activations of other paths are still on going */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_required</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_retry</span> <span class="o">=</span> <span class="n">delay_retry</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up any thread waiting to suspend.</span>
<span class="cm">	 */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_wait</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pgpath</span><span class="p">,</span> <span class="n">activate_path</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">scsi_dh_activate</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">),</span>
				<span class="n">pg_init_done</span><span class="p">,</span> <span class="n">pgpath</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * end_io handling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_end_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">clone</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="o">*</span><span class="n">mpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t queue any clone request inside the multipath target</span>
<span class="cm">	 * during end I/O handling, since those clone requests don&#39;t have</span>
<span class="cm">	 * bio clones.  If we queue them inside the multipath target,</span>
<span class="cm">	 * we need to make bio clones, that requires memory allocation.</span>
<span class="cm">	 * (See drivers/md/dm.c:end_clone_bio() about why the clone requests</span>
<span class="cm">	 *  don&#39;t have bio clones.)</span>
<span class="cm">	 * Instead of queueing the clone request here, we queue the original</span>
<span class="cm">	 * request into dm core, which will remake a clone request and</span>
<span class="cm">	 * clone bios for it and resubmit it later.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">DM_ENDIO_REQUEUE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">clone</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* I/O complete */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span> <span class="o">||</span> <span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">||</span> <span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpio</span><span class="o">-&gt;</span><span class="n">pgpath</span><span class="p">)</span>
		<span class="n">fail_path</span><span class="p">(</span><span class="n">mpio</span><span class="o">-&gt;</span><span class="n">pgpath</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_valid_paths</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__must_push_back</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBADE</span><span class="p">)</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_end_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">clone</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="k">union</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_mpath_io</span> <span class="o">*</span><span class="n">mpio</span> <span class="o">=</span> <span class="n">map_context</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span> <span class="o">=</span> <span class="n">mpio</span><span class="o">-&gt;</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">path_selector</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mpio</span><span class="p">);</span>

	<span class="n">r</span>  <span class="o">=</span> <span class="n">do_end_io</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">clone</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">mpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">end_io</span><span class="p">)</span>
			<span class="n">ps</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">end_io</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">mpio</span><span class="o">-&gt;</span><span class="n">nr_bytes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_mapinfo</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">map_context</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Suspend can&#39;t complete until all the I/O is processed so if</span>
<span class="cm"> * the last path fails we must error any remaining I/O.</span>
<span class="cm"> * Note that if the freeze_bdev fails while suspending, the</span>
<span class="cm"> * queue_if_no_path state is lost - userspace should reset it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">multipath_presuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="p">)</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">queue_if_no_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">multipath_postsuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">work_mutex</span><span class="p">);</span>
	<span class="n">flush_multipath_work</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">work_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Restore the queue_if_no_path setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">multipath_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="p">)</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">saved_queue_if_no_path</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Info output has the following format:</span>
<span class="cm"> * num_multipath_feature_args [multipath_feature_args]*</span>
<span class="cm"> * num_handler_status_args [handler_status_args]*</span>
<span class="cm"> * num_groups init_group_number</span>
<span class="cm"> *            [A|D|E num_ps_status_args [ps_status_args]*</span>
<span class="cm"> *             num_paths num_selector_args</span>
<span class="cm"> *             [path_dev A|F fail_count [selector_args]* ]+ ]+</span>
<span class="cm"> *</span>
<span class="cm"> * Table output has the following format (identical to the constructor string):</span>
<span class="cm"> * num_feature_args [features_args]*</span>
<span class="cm"> * num_handler_args hw_handler [hw_handler_args]*</span>
<span class="cm"> * num_groups init_group_number</span>
<span class="cm"> *     [priority selector-name num_ps_args [ps_args]*</span>
<span class="cm"> *      num_paths num_selector_args [path_dev [selector_args]* ]+ ]+</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="n">status_type_t</span> <span class="n">type</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="p">)</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pg_num</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Features */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">STATUSTYPE_INFO</span><span class="p">)</span>
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;2 %u %u &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_size</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_count</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span> <span class="o">!=</span> <span class="n">DM_PG_INIT_DELAY_DEFAULT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_if_no_path</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;queue_if_no_path &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_retries</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;pg_init_retries %u &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_retries</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span> <span class="o">!=</span> <span class="n">DM_PG_INIT_DELAY_DEFAULT</span><span class="p">)</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;pg_init_delay_msecs %u &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pg_init_delay_msecs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">STATUSTYPE_INFO</span><span class="p">)</span>
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;0 &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;1 %s &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hw_handler_name</span><span class="p">);</span>

	<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="p">)</span>
		<span class="n">pg_num</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="o">-&gt;</span><span class="n">pg_num</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="p">)</span>
		<span class="n">pg_num</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="o">-&gt;</span><span class="n">pg_num</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pg_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">nr_priority_groups</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">pg_num</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATUSTYPE_INFO</span>:
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">bypassed</span><span class="p">)</span>
				<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>	<span class="cm">/* Disabled */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pg</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="p">)</span>
				<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>	<span class="cm">/* Currently Active */</span>
			<span class="k">else</span>
				<span class="n">state</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>	<span class="cm">/* Enabled */</span>

			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%c &quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				<span class="n">sz</span> <span class="o">+=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
							  <span class="n">result</span> <span class="o">+</span> <span class="n">sz</span><span class="p">,</span>
							  <span class="n">maxlen</span> <span class="o">-</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;0 &quot;</span><span class="p">);</span>

			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%u %u &quot;</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">nr_pgpaths</span><span class="p">,</span>
			       <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">info_args</span><span class="p">);</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%s %s %u &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">?</span> <span class="s">&quot;A&quot;</span> <span class="o">:</span> <span class="s">&quot;F&quot;</span><span class="p">,</span>
				       <span class="n">p</span><span class="o">-&gt;</span><span class="n">fail_count</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
					<span class="n">sz</span> <span class="o">+=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">result</span> <span class="o">+</span> <span class="n">sz</span><span class="p">,</span>
					      <span class="n">maxlen</span> <span class="o">-</span> <span class="n">sz</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATUSTYPE_TABLE</span>:
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				<span class="n">sz</span> <span class="o">+=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
							  <span class="n">result</span> <span class="o">+</span> <span class="n">sz</span><span class="p">,</span>
							  <span class="n">maxlen</span> <span class="o">-</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;0 &quot;</span><span class="p">);</span>

			<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%u %u &quot;</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">nr_pgpaths</span><span class="p">,</span>
			       <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">table_args</span><span class="p">);</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DMEMIT</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
					<span class="n">sz</span> <span class="o">+=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">result</span> <span class="o">+</span> <span class="n">sz</span><span class="p">,</span>
					      <span class="n">maxlen</span> <span class="o">-</span> <span class="n">sz</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="p">)</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">action_fn</span> <span class="n">action</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">work_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_suspended</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;queue_if_no_path&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">queue_if_no_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;fail_if_no_path&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">queue_if_no_path</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unrecognised multipath message received.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;disable_group&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">bypass_pg_num</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;enable_group&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">bypass_pg_num</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;switch_group&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">switch_pg_num</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;reinstate_path&quot;</span><span class="p">))</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">reinstate_path</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;fail_path&quot;</span><span class="p">))</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">fail_path</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unrecognised multipath message received.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_get_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;message: error getting device %s&quot;</span><span class="p">,</span>
		       <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">action_dev</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

	<span class="n">dm_put_device</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">work_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">)</span>
		<span class="n">__choose_pgpath</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_io</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only pass ioctls through if the device sizes match exactly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SECTOR_SHIFT</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">scsi_verify_blk_ioctl</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fatal_signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">process_queued_ios</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">?</span> <span class="o">:</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_iterate_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">,</span>
				     <span class="n">iterate_devices_callout_fn</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">priority_groups</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pgpath_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dm_underlying_device_busy</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We return &quot;busy&quot;, only when we can map I/Os but underlying devices</span>
<span class="cm"> * are busy (so even if we map I/Os now, the I/Os will wait on</span>
<span class="cm"> * the underlying queue).</span>
<span class="cm"> * In other words, if we want to kill I/Os or queue them inside us</span>
<span class="cm"> * due to map unavailability, we don&#39;t return &quot;busy&quot;.  Otherwise,</span>
<span class="cm"> * dm core won&#39;t give us the I/Os and we can&#39;t do what we want.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">multipath_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">has_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">multipath</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_group</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pgpath</span> <span class="o">*</span><span class="n">pgpath</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Guess which priority_group will be used at next mapping time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pgpath</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="p">))</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">next_pg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="p">))</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_pg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t know which pg will be used at next mapping time.</span>
<span class="cm">		 * We don&#39;t call __choose_pgpath() here to avoid to trigger</span>
<span class="cm">		 * pg_init just by busy checking.</span>
<span class="cm">		 * So we don&#39;t know whether underlying devices we will be using</span>
<span class="cm">		 * at next mapping time are busy or not. Just try mapping.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is one non-busy active path at least, the path selector</span>
<span class="cm">	 * will be able to select it. So we consider such a pg as not busy.</span>
<span class="cm">	 */</span>
	<span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pgpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pgpaths</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgpath</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">has_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__pgpath_busy</span><span class="p">(</span><span class="n">pgpath</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_active</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * No active path in this pg, so this pg won&#39;t be used and</span>
<span class="cm">		 * the current_pg will be changed at next mapping time.</span>
<span class="cm">		 * We need to try mapping to determine it.</span>
<span class="cm">		 */</span>
		<span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">busy</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Module setup</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">target_type</span> <span class="n">multipath_target</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;multipath&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">multipath_ctr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr</span> <span class="o">=</span> <span class="n">multipath_dtr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_rq</span> <span class="o">=</span> <span class="n">multipath_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rq_end_io</span> <span class="o">=</span> <span class="n">multipath_end_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">presuspend</span> <span class="o">=</span> <span class="n">multipath_presuspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">postsuspend</span> <span class="o">=</span> <span class="n">multipath_postsuspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">multipath_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">multipath_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">multipath_message</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>  <span class="o">=</span> <span class="n">multipath_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iterate_devices</span> <span class="o">=</span> <span class="n">multipath_iterate_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="n">multipath_busy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dm_multipath_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* allocate a slab for the dm_ios */</span>
	<span class="n">_mpio_cache</span> <span class="o">=</span> <span class="n">KMEM_CACHE</span><span class="p">(</span><span class="n">dm_mpath_io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_mpio_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_register_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">multipath_target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;register failed %d&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">_mpio_cache</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kmultipathd</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;kmpathd&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kmultipathd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;failed to create workqueue kmpathd&quot;</span><span class="p">);</span>
		<span class="n">dm_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">multipath_target</span><span class="p">);</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">_mpio_cache</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * A separate workqueue is used to handle the device handlers</span>
<span class="cm">	 * to avoid overloading existing workqueue. Overloading the</span>
<span class="cm">	 * old workqueue would also create a bottleneck in the</span>
<span class="cm">	 * path of the storage hardware device activation.</span>
<span class="cm">	 */</span>
	<span class="n">kmpath_handlerd</span> <span class="o">=</span> <span class="n">alloc_ordered_workqueue</span><span class="p">(</span><span class="s">&quot;kmpath_handlerd&quot;</span><span class="p">,</span>
						  <span class="n">WQ_MEM_RECLAIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kmpath_handlerd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;failed to create workqueue kmpath_handlerd&quot;</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">);</span>
		<span class="n">dm_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">multipath_target</span><span class="p">);</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">_mpio_cache</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;version %u.%u.%u loaded&quot;</span><span class="p">,</span>
	       <span class="n">multipath_target</span><span class="p">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">multipath_target</span><span class="p">.</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">multipath_target</span><span class="p">.</span><span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dm_multipath_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kmpath_handlerd</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kmultipathd</span><span class="p">);</span>

	<span class="n">dm_unregister_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">multipath_target</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">_mpio_cache</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dm_multipath_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dm_multipath_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DM_NAME</span> <span class="s">&quot; multipath target&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sistina Software &lt;dm-devel@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
