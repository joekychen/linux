<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › bitmap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bitmap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * bitmap.c two-level bitmap (C) Peter T. Breuer (ptb@ot.uc3m.es) 2003</span>
<span class="cm"> *</span>
<span class="cm"> * bitmap_create  - sets up the bitmap structure</span>
<span class="cm"> * bitmap_destroy - destroys the bitmap structure</span>
<span class="cm"> *</span>
<span class="cm"> * additions, Copyright (C) 2003-2004, Paul Clements, SteelEye Technology, Inc.:</span>
<span class="cm"> * - added disk storage for bitmap</span>
<span class="cm"> * - changes to allow various bitmap chunk sizes</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Still to do:</span>
<span class="cm"> *</span>
<span class="cm"> * flush after percent set rather than just time based. (maybe both).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">bmname</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">?</span> <span class="n">mdname</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;mdX&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check a page and, if necessary, allocate it (or hijack it if the alloc fails)</span>
<span class="cm"> *</span>
<span class="cm"> * 1) check to see if this page is allocated, if it&#39;s not then try to alloc</span>
<span class="cm"> * 2) if the alloc fails, set the page&#39;s hijacked flag so we&#39;ll use the</span>
<span class="cm"> *    page pointer directly as a counter</span>
<span class="cm"> *</span>
<span class="cm"> * if we find our page, we increment the page&#39;s refcount so that it stays</span>
<span class="cm"> * allocated while we&#39;re using it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bitmap_checkpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mappage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This can happen if bitmap_start_sync goes beyond</span>
<span class="cm">		 * End-of-device while looking for a whole page.</span>
<span class="cm">		 * It is harmless.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span><span class="p">)</span> <span class="cm">/* it&#39;s hijacked, don&#39;t try to alloc */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span><span class="p">)</span> <span class="cm">/* page is already allocated, just return */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/* this page has not been allocated yet */</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mappage</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mappage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md/bitmap: map page allocation failed, hijacking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* failed - set the hijacked flag so that we can use the</span>
<span class="cm">		 * pointer as a counter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span><span class="p">)</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span> <span class="o">||</span>
		   <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* somebody beat us to getting the page */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mappage</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* no page was in place and we have one, so install it */</span>

		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="n">mappage</span><span class="p">;</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">missing_pages</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* if page is completely empty, put it back on the free list, or dealloc it */</span>
<span class="cm">/* if page was hijacked, unmark the flag so it might get alloced next time */</span>
<span class="cm">/* Note: lock should be held when calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_checkfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="cm">/* page is still busy */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* page is no longer in use, it can be released */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* page was hijacked, undo this now */</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* normal case, free the page */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span><span class="p">;</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">missing_pages</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bitmap file handling - read and write the bitmap file and its superblock</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * basic page I/O operations</span>
<span class="cm"> */</span>

<span class="cm">/* IO operations when bitmap is stored near all superblocks */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_sb_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* choose a good rdev and read the page from there */</span>

	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">target</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
				 <span class="n">roundup</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)),</span>
				 <span class="n">page</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="nf">next_active_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Iterate the disks of an mddev, using rcu to protect access to the</span>
<span class="cm">	 * linked list, and raising the refcount of devices we return to ensure</span>
<span class="cm">	 * they don&#39;t disappear while in use.</span>
<span class="cm">	 * As devices are only added or removed when raid_disk is &lt; 0 and</span>
<span class="cm">	 * nr_pending is 0 and In_sync is clear, the entries we return will</span>
<span class="cm">	 * still be in the same position on the list when we re-enter</span>
<span class="cm">	 * list_for_each_continue_rcu.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* start at the beginning */</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* release the previous rdev and start from there. */</span>
		<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_continue_rcu</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">same_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this is a usable devices */</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_sb_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">next_active_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">loff_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">bdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span><span class="p">)</span> <span class="o">?</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span> <span class="o">:</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">last_page_size</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_page_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">last_page_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">last_page_size</span><span class="p">,</span>
				       <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Just make sure we aren&#39;t corrupting data or</span>
<span class="cm">		 * metadata</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bitmap could be anywhere. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span>
						       <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">))</span>
			    <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span>
			    <span class="o">&amp;&amp;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">offset</span>
			    <span class="o">&lt;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span>
			     <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">bad_alignment</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DATA  BITMAP METADATA  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span>
			    <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">))</span>
			    <span class="o">+</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* bitmap runs in to metadata */</span>
				<span class="k">goto</span> <span class="n">bad_alignment</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span>
			    <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
				<span class="cm">/* data runs in to bitmap */</span>
				<span class="k">goto</span> <span class="n">bad_alignment</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* METADATA BITMAP DATA */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span>
			    <span class="o">+</span> <span class="n">offset</span>
			    <span class="o">+</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">*</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span>
			    <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span>
				<span class="cm">/* bitmap runs in to data */</span>
				<span class="k">goto</span> <span class="n">bad_alignment</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DATA METADATA BITMAP - no problems */</span>
		<span class="p">}</span>
		<span class="n">md_super_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span>
			       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">offset</span>
			       <span class="o">+</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">),</span>
			       <span class="n">size</span><span class="p">,</span>
			       <span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">md_super_wait</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">bad_alignment:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bitmap_file_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * write out a page to a file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">write_sb_page</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">bh</span> <span class="o">&amp;&amp;</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">);</span>
			<span class="n">set_buffer_locked</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">set_buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">submit_bh</span><span class="p">(</span><span class="n">WRITE</span> <span class="o">|</span> <span class="n">REQ_SYNC</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
			<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span>
				   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">bitmap_file_kick</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_bitmap_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uptodate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* copied from buffer.c */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__clear_page_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ClearPagePrivate</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">set_page_private</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PagePrivate</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
		<span class="n">free_buffer_head</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__clear_page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read a page from a file.</span>
<span class="cm"> * We both read the page, and attach buffers to the page to record the</span>
<span class="cm"> * address of each block (using bmap).  These addresses will be used</span>
<span class="cm"> * to write the block later, completely bypassing the filesystem.</span>
<span class="cm"> * This usage is similar to how swap files are handled, and allows us</span>
<span class="cm"> * to write to a file with no concerns of memory allocation failing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">block</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read bitmap file (%dB @ %llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">PAGE_SIZE</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">alloc_page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">attach_page_buffers</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span> <span class="o">=</span> <span class="n">bmap</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cannot use this file! */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">))</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">count</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blkbits</span><span class="p">);</span>

			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_end_io</span> <span class="o">=</span> <span class="n">end_bitmap_write</span><span class="p">;</span>
			<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_private</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">);</span>
			<span class="n">set_buffer_locked</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">set_buffer_mapped</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
			<span class="n">submit_bh</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">block</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bh</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_this_page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md: bitmap read error: (%dB @ %llu): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bitmap file superblock operations</span>
<span class="cm"> */</span>

<span class="cm">/* update the event counter and sync the superblock to disk */</span>
<span class="kt">void</span> <span class="nf">bitmap_update_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span> <span class="o">||</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span> <span class="cm">/* no bitmap for this array */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">)</span> <span class="cm">/* no superblock */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">)</span>
		<span class="cm">/* rocking back to read-only */</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Just in case these have been changed via sysfs: */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">write_behind</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">);</span>
	<span class="cm">/* This might have been changed by a reshape */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sync_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sectors_reserved</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span>
					   <span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">write_page</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* print out the bitmap file superblock */</span>
<span class="kt">void</span> <span class="nf">bitmap_print_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span> <span class="o">||</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: bitmap file superblock:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;         magic: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;       version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;          uuid: %08x.%08x.%08x.%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span>
					<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
					<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">8</span><span class="p">),</span>
					<span class="o">*</span><span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">12</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;        events: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;events cleared: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;         state: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;     chunksize: %d B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  daemon sleep: %ds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">daemon_sleep</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;     sync size: %llu KB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">sync_size</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;max write behind: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">write_behind</span><span class="p">));</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bitmap_new_disk_sb</span>
<span class="cm"> * @bitmap</span>
<span class="cm"> *</span>
<span class="cm"> * This function is somewhat the reverse of bitmap_read_sb.  bitmap_read_sb</span>
<span class="cm"> * reads and verifies the on-disk bitmap superblock and populates bitmap_info.</span>
<span class="cm"> * This function verifies &#39;bitmap_info&#39; and populates the on-disk bitmap</span>
<span class="cm"> * structure, which is to be written to disk.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -Exxx on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bitmap_new_disk_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">daemon_sleep</span><span class="p">,</span> <span class="n">write_behind</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">);</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BITMAP_MAGIC</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BITMAP_MAJOR_HI</span><span class="p">);</span>

	<span class="n">chunksize</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chunksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">chunksize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bitmap chunksize not a power of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chunksize</span><span class="p">);</span>

	<span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daemon_sleep</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">daemon_sleep</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">daemon_sleep</span> <span class="o">&gt;</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Choosing daemon_sleep default (5 sec)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">daemon_sleep</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">daemon_sleep</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">daemon_sleep</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: write_behind for RAID1.  If not specified, what</span>
<span class="cm">	 * is a good choice?  We choose COUNTER_MAX / 2 arbitrarily.</span>
<span class="cm">	 */</span>
	<span class="n">write_behind</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_behind</span> <span class="o">&gt;</span> <span class="n">COUNTER_MAX</span><span class="p">)</span>
		<span class="n">write_behind</span> <span class="o">=</span> <span class="n">COUNTER_MAX</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">write_behind</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">write_behind</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span> <span class="o">=</span> <span class="n">write_behind</span><span class="p">;</span>

	<span class="cm">/* keep the array size field of the bitmap superblock up to date */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sync_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read the superblock from the bitmap file and initialize some bitmap fields */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bitmap_read_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reason</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bitmap_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">daemon_sleep</span><span class="p">,</span> <span class="n">write_behind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sectors_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">sb_page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunksize</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">daemon_sleep</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">write_behind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_no_sb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* page 0 is the superblock, read it... */</span>
	<span class="n">sb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span> <span class="o">=</span> <span class="n">sb_page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">isize</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">isize</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">isize</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">read_page</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">bitmap</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">sb_page</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">read_sb_page</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span>
				   <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
				   <span class="n">sb_page</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="n">chunksize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span><span class="p">);</span>
	<span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">daemon_sleep</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">write_behind</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">write_behind</span><span class="p">);</span>
	<span class="n">sectors_reserved</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">sectors_reserved</span><span class="p">);</span>

	<span class="cm">/* verify that the bitmap-specific fields are valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BITMAP_MAGIC</span><span class="p">))</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;bad magic&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">BITMAP_MAJOR_LO</span> <span class="o">||</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BITMAP_MAJOR_HI</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;unrecognized superblock version&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chunksize</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;bitmap chunksize too small&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">chunksize</span><span class="p">))</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;bitmap chunksize not a power of 2&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">daemon_sleep</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">daemon_sleep</span> <span class="o">&gt;</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;daemon sleep period out of range&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">write_behind</span> <span class="o">&gt;</span> <span class="n">COUNTER_MAX</span><span class="p">)</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;write-behind limit out of range (0 - 16383)&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: invalid bitmap file superblock: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* keep the array size field of the bitmap superblock up to date */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sync_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have a persistent array superblock, so compare the</span>
<span class="cm">		 * bitmap&#39;s UUID and event counter to the mddev&#39;s</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;%s: bitmap superblock UUID mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;%s: bitmap file is out of date (%llu &lt; %llu) &quot;</span>
			       <span class="s">&quot;-- forcing full recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">events</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* assign fields using values from superblock */</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="n">BITMAP_MAJOR_HOSTENDIAN</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BITMAP_HOSTENDIAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="nl">out_no_sb:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">daemon_sleep</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span> <span class="o">=</span> <span class="n">write_behind</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">&gt;</span> <span class="n">sectors_reserved</span><span class="p">)</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">sectors_reserved</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">bitmap_print_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * general bitmap file operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * on-disk bitmap:</span>
<span class="cm"> *</span>
<span class="cm"> * Use one bit per &quot;chunk&quot; (block set). We do the disk I/O on the bitmap</span>
<span class="cm"> * file a page at a time. There&#39;s a superblock at the start of the file.</span>
<span class="cm"> */</span>
<span class="cm">/* calculate the index of the page that contains this bit */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">file_page_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="n">chunk</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chunk</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_BIT_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calculate the (bit) offset of this bit within a page */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">file_page_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="n">chunk</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chunk</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return a pointer to the page in the filemap that contains the given bit</span>
<span class="cm"> *</span>
<span class="cm"> * this lookup is complicated by the fact that the bitmap sb might be exactly</span>
<span class="cm"> * 1 page (e.g., x86) or less than 1 page -- so the bitmap might start on page</span>
<span class="cm"> * 0 or page 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">filemap_get_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_page_index</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="n">file_page_index</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
			      <span class="o">-</span> <span class="n">file_page_index</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="mi">0</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bitmap_storage_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunks</span><span class="p">,</span> <span class="kt">int</span> <span class="n">with_super</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">with_super</span><span class="p">)</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">);</span>

	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span>
				 <span class="o">*</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">with_super</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">;</span>
		<span class="n">pnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">pnum</span> <span class="o">&lt;</span> <span class="n">num_pages</span><span class="p">;</span> <span class="n">pnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="n">pnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="n">pnum</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span> <span class="o">=</span> <span class="n">pnum</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="n">pnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">pnum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span> <span class="o">=</span> <span class="n">pnum</span><span class="p">;</span>

	<span class="cm">/* We need 4 bits per page, rounded up to a multiple</span>
<span class="cm">	 * of sizeof(unsigned long) */</span>
	<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
		<span class="n">roundup</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">num_pages</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap_attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">store</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_file_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="o">*</span><span class="n">sb_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">file</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">;</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span><span class="p">;</span>
	<span class="n">sb_page</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pages</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sb_page</span><span class="p">)</span> <span class="cm">/* 0 is sb_page, release it below */</span>
			<span class="n">free_buffers</span><span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">pages</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="n">free_buffers</span><span class="p">(</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="n">invalidate_mapping_pages</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bitmap_file_kick - if an error occurs while manipulating the bitmap file</span>
<span class="cm"> * then it is no longer reliable, so we stop using it and we mark the file</span>
<span class="cm"> * as failed in the superblock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_file_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bitmap_update_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span>
					     <span class="n">path</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
			      <span class="s">&quot;%s: kicking failed bitmap file %s from array!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
			       <span class="s">&quot;%s: disabling internal bitmap due to errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">bitmap_page_attr</span> <span class="p">{</span>
	<span class="n">BITMAP_PAGE_DIRTY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>     <span class="cm">/* there are set bits that need to be synced */</span>
	<span class="n">BITMAP_PAGE_PENDING</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>   <span class="cm">/* there are bits that are being cleaned.</span>
<span class="cm">				    * i.e. counter is 1 or 2. */</span>
	<span class="n">BITMAP_PAGE_NEEDWRITE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* there are cleared bits that need to be synced */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_page_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnum</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bitmap_page_attr</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">((</span><span class="n">pnum</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_page_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnum</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">bitmap_page_attr</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">((</span><span class="n">pnum</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">test_page_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnum</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">bitmap_page_attr</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">((</span><span class="n">pnum</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">test_and_clear_page_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnum</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">bitmap_page_attr</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_and_clear_bit</span><span class="p">((</span><span class="n">pnum</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span>
				  <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap_attr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * bitmap_file_set_bit -- called before performing a write to the md device</span>
<span class="cm"> * to set (and eventually sync) a particular bit in the bitmap file</span>
<span class="cm"> *</span>
<span class="cm"> * we set the bit immediately, then we record the page number so that</span>
<span class="cm"> * when an unplug occurs, we can flush the dirty pages out to disk</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_file_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">filemap_get_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">file_page_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>

	<span class="cm">/* set the bit */</span>
	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_HOSTENDIAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">test_and_set_bit_le</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;set file bit %lu page %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="cm">/* record page number so it gets flushed to disk when unplug occurs */</span>
	<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">BITMAP_PAGE_DIRTY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_file_clear_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">filemap_get_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">file_page_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_HOSTENDIAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">test_and_clear_bit_le</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">BITMAP_PAGE_PENDING</span><span class="p">);</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this gets called when the md device is ready to unplug its underlying</span>
<span class="cm"> * (slave) device queues -- before we let any writes go down, we need to</span>
<span class="cm"> * sync the dirty pages of the bitmap file to disk */</span>
<span class="kt">void</span> <span class="nf">bitmap_unplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dirty</span><span class="p">,</span> <span class="n">need_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span> <span class="o">||</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* look at each page to see if there are any set bits that need to be</span>
<span class="cm">	 * flushed out to disk */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">dirty</span> <span class="o">=</span> <span class="n">test_and_clear_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">BITMAP_PAGE_DIRTY</span><span class="p">);</span>
		<span class="n">need_write</span> <span class="o">=</span> <span class="n">test_and_clear_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						      <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">||</span> <span class="n">need_write</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">BITMAP_PAGE_PENDING</span><span class="p">);</span>
			<span class="n">write_page</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
			<span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* if any writes were performed, we need to wait on them */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
			<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span>
				   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">md_super_wait</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">bitmap_file_kick</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_unplug</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bitmap_set_memory_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">needed</span><span class="p">);</span>
<span class="cm">/* * bitmap_init_from_disk -- called at bitmap_create time to initialize</span>
<span class="cm"> * the in-memory bitmap from the on-disk bitmap -- also, sets up the</span>
<span class="cm"> * memory mapping of the bitmap file</span>
<span class="cm"> * Special cases:</span>
<span class="cm"> *   if there&#39;s no bitmap file, or if the bitmap file had been</span>
<span class="cm"> *   previously kicked from the array, we mark all the bits as</span>
<span class="cm"> *   1&#39;s in order to cause a full resync.</span>
<span class="cm"> *</span>
<span class="cm"> * We ignore all bits for sectors that end earlier than &#39;start&#39;.</span>
<span class="cm"> * This is used when reading an out-of-date bitmap...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bitmap_init_from_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">oldindex</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">outofdate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="o">*</span><span class="n">store</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">;</span>

	<span class="n">chunks</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunks</span><span class="p">;</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No permanent bitmap - fill with &#39;1s&#39;. */</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chunks</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if the disk bit is set, set the memory bit */</span>
			<span class="kt">int</span> <span class="n">needed</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">)</span>
				      <span class="o">&gt;=</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">bitmap_set_memory_bits</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">,</span>
					       <span class="n">needed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outofdate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outofdate</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: bitmap file is out of date, doing full &quot;</span>
			<span class="s">&quot;recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: bitmap file too short %lu &lt; %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
		       <span class="n">store</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oldindex</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0L</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chunks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">file_page_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">file_page_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">oldindex</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* this is a new page, read it in */</span>
			<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
			<span class="cm">/* unmap the old page, we&#39;re done with it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">-</span> <span class="n">index</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">filemap</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">read_page</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span>
						<span class="n">count</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">read_sb_page</span><span class="p">(</span>
					<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span>
					<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
					<span class="n">page</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">oldindex</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">outofdate</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * if bitmap is out of date, dirty the</span>
<span class="cm">				 * whole page and write it out</span>
<span class="cm">				 */</span>
				<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">paddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
				<span class="n">write_page</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_HOSTENDIAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">test_bit_le</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if the disk bit is set, set the memory bit */</span>
			<span class="kt">int</span> <span class="n">needed</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span>
				      <span class="o">&gt;=</span> <span class="n">start</span><span class="p">);</span>
			<span class="n">bitmap_set_memory_bits</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">,</span>
					       <span class="n">needed</span><span class="p">);</span>
			<span class="n">bit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: bitmap initialized from disk: &quot;</span>
	       <span class="s">&quot;read %lu pages, set %lu of %lu bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">store</span><span class="o">-&gt;</span><span class="n">file_pages</span><span class="p">,</span>
	       <span class="n">bit_cnt</span><span class="p">,</span> <span class="n">chunks</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: bitmap initialisation failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bitmap_write_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We don&#39;t actually write all bitmap blocks here,</span>
<span class="cm">	 * just flag them as needing to be written</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span> <span class="o">||</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
		<span class="cm">/* Only one copy, so nothing needed */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			      <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_count_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
			      <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">chunkshift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_COUNTER_SHIFT</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">count</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="n">bitmap_checkfree</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_set_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">chunkshift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_COUNTER_SHIFT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_page</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bitmap_get_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
					    <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">create</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * bitmap daemon -- periodically wakes up to clean bits and flush pages</span>
<span class="cm"> *			out to disk</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">bitmap_daemon_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextpage</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">counts</span><span class="p">;</span>

	<span class="cm">/* Use a mutex to guard daemon_work against</span>
<span class="cm">	 * bitmap_destroy.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span>
			<span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Any file-page which is PENDING now needs to be written.</span>
<span class="cm">	 * So set NEEDWRITE now, then after we make any last-minute changes</span>
<span class="cm">	 * we will write it.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					     <span class="n">BITMAP_PAGE_PENDING</span><span class="p">))</span>
			<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
				      <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Arrange for superblock update as well as</span>
<span class="cm">		 * other changes */</span>
		<span class="n">bitmap_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sb</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span>
				<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Now look at the bitmap counters and if any are &#39;2&#39; or &#39;1&#39;,</span>
<span class="cm">	 * decrement and handle accordingly.</span>
<span class="cm">	 */</span>
	<span class="n">counts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nextpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>
		<span class="n">sector_t</span>  <span class="n">block</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">chunkshift</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">nextpage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nextpage</span> <span class="o">+=</span> <span class="n">PAGE_COUNTER_RATIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_COUNTER_SHIFT</span><span class="p">].</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">j</span> <span class="o">|=</span> <span class="n">PAGE_COUNTER_MASK</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">counts</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_COUNTER_SHIFT</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span>
					 <span class="n">block</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">|=</span> <span class="n">PAGE_COUNTER_MASK</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We can clear the bit */</span>
			<span class="o">*</span><span class="n">bmc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bitmap_count_page</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">bitmap_file_clear_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">bmc</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bmc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Now start writeout on any page in NEEDWRITE that isn&#39;t DIRTY.</span>
<span class="cm">	 * DIRTY pages need to be written by bitmap_unplug so it can wait</span>
<span class="cm">	 * for them.</span>
<span class="cm">	 * If we find any DIRTY page we stop there and let bitmap_unplug</span>
<span class="cm">	 * handle all the rest.  This is important in the case where</span>
<span class="cm">	 * the first blocking holds the superblock and it has been updated.</span>
<span class="cm">	 * We mustn&#39;t write any other blocks before the superblock.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span>
		     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	     <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
				   <span class="n">BITMAP_PAGE_DIRTY</span><span class="p">))</span>
			<span class="cm">/* bitmap_unplug will handle the rest */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					     <span class="n">BITMAP_PAGE_NEEDWRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">write_page</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">filemap</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="nf">bitmap_get_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span>
					    <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">create</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If &#39;create&#39;, we might release the lock and reclaim it.</span>
<span class="cm">	 * The lock must have been taken with interrupts enabled.</span>
<span class="cm">	 * If !create, we don&#39;t release the lock.</span>
<span class="cm">	 */</span>
	<span class="n">sector_t</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">chunkshift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_COUNTER_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pageoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&amp;</span> <span class="n">PAGE_COUNTER_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">COUNTER_BYTE_SHIFT</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">csize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_checkpage</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">create</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span> <span class="o">||</span>
	    <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">csize</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">chunkshift</span> <span class="o">+</span>
					  <span class="n">PAGE_COUNTER_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">csize</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">chunkshift</span><span class="p">;</span>
	<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">csize</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">csize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* now locked ... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">hijacked</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* hijacked pointer */</span>
		<span class="cm">/* should we use the first or second counter field</span>
<span class="cm">		 * of the hijacked pointer? */</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">pageoff</span> <span class="o">&gt;</span> <span class="n">PAGE_COUNTER_MASK</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">&amp;</span><span class="p">((</span><span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="p">)</span>
			  <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span><span class="p">)[</span><span class="n">hi</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* page is allocated */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">[</span><span class="n">page</span><span class="p">].</span><span class="n">map</span><span class="p">[</span><span class="n">pageoff</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bitmap_startwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">behind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">behind</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bw</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">);</span>
		<span class="n">bw</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&gt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes_used</span><span class="p">)</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes_used</span> <span class="o">=</span> <span class="n">bw</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;inc write-behind count %d/%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bw</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">COUNTER</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span> <span class="o">==</span> <span class="n">COUNTER_MAX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">__wait</span><span class="p">);</span>
			<span class="cm">/* note that it is safe to do the prepare_to_wait</span>
<span class="cm">			 * after the test as long as we do it before dropping</span>
<span class="cm">			 * the spinlock.</span>
<span class="cm">			 */</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">overflow_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">io_schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">overflow_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">bitmap_file_set_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">bitmap_count_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="n">bmc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">blocks</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">-=</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_startwrite</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">bitmap_endwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sectors</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">success</span><span class="p">,</span> <span class="kt">int</span> <span class="n">behind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">behind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">))</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_wait</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dec write-behind count %d/%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">),</span>
			 <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">sysfs_can_clear</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">NEEDED</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">))</span>
			<span class="o">*</span><span class="n">bmc</span> <span class="o">|=</span> <span class="n">NEEDED_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">COUNTER</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span> <span class="o">==</span> <span class="n">COUNTER_MAX</span><span class="p">)</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">overflow_wait</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">blocks</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">-=</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_endwrite</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__bitmap_start_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">degraded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* FIXME or bitmap set as &#39;failed&#39; */</span>
		<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* always resync if no bitmap */</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* locked */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RESYNC</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">))</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NEEDED</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">degraded</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* don&#39;t set/clear bits if degraded */</span>
				<span class="o">*</span><span class="n">bmc</span> <span class="o">|=</span> <span class="n">RESYNC_MASK</span><span class="p">;</span>
				<span class="o">*</span><span class="n">bmc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NEEDED_MASK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bitmap_start_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">degraded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* bitmap_start_sync must always report on multiples of whole</span>
<span class="cm">	 * pages, otherwise resync (which is very PAGE_SIZE based) will</span>
<span class="cm">	 * get confused.</span>
<span class="cm">	 * So call __bitmap_start_sync repeatedly (if needed) until</span>
<span class="cm">	 * At least PAGE_SIZE&gt;&gt;9 blocks are covered.</span>
<span class="cm">	 * Return the &#39;or&#39; of the result.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">blocks1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">blocks</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">|=</span> <span class="n">__bitmap_start_sync</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">blocks1</span><span class="p">,</span> <span class="n">degraded</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">blocks1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">blocks</span> <span class="o">+=</span> <span class="n">blocks1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_start_sync</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">bitmap_end_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aborted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="cm">/* locked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RESYNC</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bmc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RESYNC_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NEEDED</span><span class="p">(</span><span class="o">*</span><span class="n">bmc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aborted</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bmc</span> <span class="o">|=</span> <span class="n">NEEDED_MASK</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_end_sync</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">bitmap_close_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Sync has finished, and any bitmap chunks that weren&#39;t synced</span>
<span class="cm">	 * properly have been aborted.  It remains to us to clear the</span>
<span class="cm">	 * RESYNC bit wherever it is still on</span>
<span class="cm">	 */</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_close_sync</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">bitmap_cond_end_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">last_end_sync</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">last_end_sync</span>
				  <span class="o">+</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">sector</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">sector</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">last_end_sync</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bitmap_cond_end_sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_set_memory_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">needed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For each chunk covered by any of these sectors, set the</span>
<span class="cm">	 * counter to 2 and possibly set resync_needed.  They should all</span>
<span class="cm">	 * be 0 at this point</span>
<span class="cm">	 */</span>

	<span class="n">sector_t</span> <span class="n">secs</span><span class="p">;</span>
	<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bmc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">|</span> <span class="p">(</span><span class="n">needed</span> <span class="o">?</span> <span class="n">NEEDED_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bitmap_count_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">allclean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dirty the memory and file bits for bitmap chunks &quot;s&quot; to &quot;e&quot; */</span>
<span class="kt">void</span> <span class="nf">bitmap_dirty_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="n">chunk</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">;</span> <span class="n">chunk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">chunk</span> <span class="o">&lt;&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">;</span>
		<span class="n">bitmap_set_memory_bits</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bitmap_file_set_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">)</span>
			<span class="cm">/* We are asserting that the array is dirty,</span>
<span class="cm">			 * so move the recovery_cp address back so</span>
<span class="cm">			 * that it is obvious that it is dirty</span>
<span class="cm">			 */</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * flush out any pending updates</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bitmap_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">sleep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span> <span class="cm">/* there was no bitmap */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* run the daemon_work three time to ensure everything is flushed</span>
<span class="cm">	 * that can be</span>
<span class="cm">	 */</span>
	<span class="n">sleep</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span> <span class="o">-=</span> <span class="n">sleep</span><span class="p">;</span>
	<span class="n">bitmap_daemon_work</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span> <span class="o">-=</span> <span class="n">sleep</span><span class="p">;</span>
	<span class="n">bitmap_daemon_work</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span> <span class="o">-=</span> <span class="n">sleep</span><span class="p">;</span>
	<span class="n">bitmap_daemon_work</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">bitmap_update_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free memory that was allocated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitmap_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">k</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_page</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span> <span class="cm">/* there was no bitmap */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Shouldn&#39;t be needed - but just in case.... */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* release the bitmap file  */</span>
	<span class="n">bitmap_file_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">);</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">pages</span><span class="p">;</span>

	<span class="cm">/* free all allocated memory */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="cm">/* deallocate the page memory */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">map</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bp</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">hijacked</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bitmap_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span> <span class="cm">/* there was no bitmap */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* disconnect from the md device */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">sysfs_can_clear</span><span class="p">)</span>
		<span class="n">sysfs_put</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">sysfs_can_clear</span><span class="p">);</span>

	<span class="n">bitmap_free</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the bitmap structure</span>
<span class="cm"> * if this returns an error, bitmap_destroy must be called to do clean up</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bitmap_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sysfs_dirent</span> <span class="o">*</span><span class="n">bm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bitmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">overflow_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_wait</span><span class="p">);</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">)</span>
		<span class="n">bm</span> <span class="o">=</span> <span class="n">sysfs_get_dirent</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;bitmap&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">sysfs_can_clear</span> <span class="o">=</span> <span class="n">sysfs_get_dirent</span><span class="p">(</span><span class="n">bm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;can_clear&quot;</span><span class="p">);</span>
		<span class="n">sysfs_put</span><span class="p">(</span><span class="n">bm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">sysfs_can_clear</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
		<span class="cm">/* As future accesses to this file will use bmap,</span>
<span class="cm">		 * and bypass the page cache, we must sync the file</span>
<span class="cm">		 * first.</span>
<span class="cm">		 */</span>
		<span class="n">vfs_fsync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* read superblock from bitmap file (this sets mddev-&gt;bitmap_info.chunksize) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If &#39;MD_ARRAY_FIRST_USE&#39; is set, then device-mapper is</span>
<span class="cm">		 * instructing us to create a new on-disk bitmap instance.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_ARRAY_FIRST_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_new_disk_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_read_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* chunksize and time_base need to be</span>
<span class="cm">			 * set first. */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">daemon_lastrun</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_resize</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;created bitmap (%lu pages) for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">bmname</span><span class="p">(</span><span class="n">bitmap</span><span class="p">));</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">bitmap_free</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bitmap_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Clear out old bitmap info first:  Either there is none, or we</span>
<span class="cm">	 * are resuming after someone else has possibly changed things,</span>
<span class="cm">	 * so we should forget old cached info.</span>
<span class="cm">	 * All chunks should be clean, but some might need_sync.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">blocks</span><span class="p">;</span>
		<span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap_close_sync</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="cm">/* no need to keep dirty bits to optimise a</span>
<span class="cm">		 * re-add of a missing device */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_init_from_disk</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BITMAP_STALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Kick recovery in case any bits were set */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span><span class="p">;</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">bitmap_update_sb</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BITMAP_WRITE_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bitmap_load</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">bitmap_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk_kb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="o">*</span><span class="n">counts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">counts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">;</span>

	<span class="n">chunk_kb</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;bitmap: %lu/%lu pages [%luKB], &quot;</span>
		   <span class="s">&quot;%lu%s chunk&quot;</span><span class="p">,</span>
		   <span class="n">counts</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">-</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">missing_pages</span><span class="p">,</span>
		   <span class="n">counts</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">counts</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">-</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">missing_pages</span><span class="p">)</span>
		   <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">10</span><span class="p">),</span>
		   <span class="n">chunk_kb</span> <span class="o">?</span> <span class="n">chunk_kb</span> <span class="o">:</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span><span class="p">,</span>
		   <span class="n">chunk_kb</span> <span class="o">?</span> <span class="s">&quot;KB&quot;</span> <span class="o">:</span> <span class="s">&quot;B&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;, file: &quot;</span><span class="p">);</span>
		<span class="n">seq_path</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bitmap_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">blocks</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">chunksize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If chunk_size is 0, choose an appropriate chunk size.</span>
<span class="cm">	 * Then possibly allocate new storage space.</span>
<span class="cm">	 * Then quiesce, copy bits, replace bitmap, and re-start</span>
<span class="cm">	 *</span>
<span class="cm">	 * This function is called both to set up the initial bitmap</span>
<span class="cm">	 * and to resize the bitmap while the array is active.</span>
<span class="cm">	 * If this happens as a result of the array being resized,</span>
<span class="cm">	 * chunksize will be zero, and we need to choose a suitable</span>
<span class="cm">	 * chunksize, otherwise we use what we are given.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">bitmap_storage</span> <span class="n">store</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_counts</span> <span class="n">old_counts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunks</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">block</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">old_blocks</span><span class="p">,</span> <span class="n">new_blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunkshift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap_page</span> <span class="o">*</span><span class="n">new_bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chunksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If there is enough space, leave the chunk size unchanged,</span>
<span class="cm">		 * else increase by factor of two until there is enough space.</span>
<span class="cm">		 */</span>
		<span class="kt">long</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">space</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We don&#39;t know how much space there is, so limit</span>
<span class="cm">			 * to current size - in sectors.</span>
<span class="cm">			 */</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunks</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">)</span>
				<span class="n">bytes</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">);</span>
			<span class="n">space</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
			<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">space</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chunkshift</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">;</span>
		<span class="n">chunkshift</span><span class="o">--</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* &#39;chunkshift&#39; is shift from block size to chunk size */</span>
			<span class="n">chunkshift</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chunks</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP_SECTOR_T</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chunkshift</span><span class="p">);</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">)</span>
				<span class="n">bytes</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">chunkshift</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="o">~</span><span class="n">chunksize</span><span class="p">)</span> <span class="o">-</span> <span class="n">BITMAP_BLOCK_SHIFT</span><span class="p">;</span>

	<span class="n">chunks</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP_SECTOR_T</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chunkshift</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">store</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">||</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bitmap_storage_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span>
					   <span class="o">!</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">PAGE_COUNTER_RATIO</span><span class="p">);</span>

	<span class="n">new_bp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_bp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_file_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">store</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">sb_page</span> <span class="o">&amp;&amp;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">sb_page</span><span class="p">),</span>
		       <span class="n">page_address</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">sb_page</span><span class="p">),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">bitmap_super_t</span><span class="p">));</span>
	<span class="n">bitmap_file_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">);</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span> <span class="o">=</span> <span class="n">store</span><span class="p">;</span>

	<span class="n">old_counts</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">bp</span> <span class="o">=</span> <span class="n">new_bp</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">missing_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunkshift</span> <span class="o">=</span> <span class="n">chunkshift</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">;</span>
	<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chunkshift</span> <span class="o">+</span>
						     <span class="n">BITMAP_BLOCK_SHIFT</span><span class="p">);</span>

	<span class="n">blocks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">old_counts</span><span class="p">.</span><span class="n">chunks</span> <span class="o">&lt;&lt;</span> <span class="n">old_counts</span><span class="p">.</span><span class="n">chunkshift</span><span class="p">,</span>
		     <span class="n">chunks</span> <span class="o">&lt;&lt;</span> <span class="n">chunkshift</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc_old</span><span class="p">,</span> <span class="o">*</span><span class="n">bmc_new</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">set</span><span class="p">;</span>

		<span class="n">bmc_old</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_counts</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">old_blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set</span> <span class="o">=</span> <span class="n">bmc_old</span> <span class="o">&amp;&amp;</span> <span class="n">NEEDED</span><span class="p">(</span><span class="o">*</span><span class="n">bmc_old</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmc_new</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">new_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc_new</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* need to set on-disk bits too. */</span>
				<span class="n">sector_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">block</span> <span class="o">+</span> <span class="n">new_blocks</span><span class="p">;</span>
				<span class="n">sector_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="n">chunkshift</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">&lt;&lt;=</span> <span class="n">chunkshift</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bitmap_file_set_bit</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
					<span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">chunkshift</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">bmc_new</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bitmap_count_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span>
						  <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span>
						   <span class="n">block</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">bmc_new</span> <span class="o">|=</span> <span class="n">NEEDED_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_blocks</span> <span class="o">&lt;</span> <span class="n">old_blocks</span><span class="p">)</span>
				<span class="n">old_blocks</span> <span class="o">=</span> <span class="n">new_blocks</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">block</span> <span class="o">+=</span> <span class="n">old_blocks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">chunks</span> <span class="o">&lt;&lt;</span> <span class="n">chunkshift</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bitmap_counter_t</span> <span class="o">*</span><span class="n">bmc</span><span class="p">;</span>
			<span class="n">bmc</span> <span class="o">=</span> <span class="n">bitmap_get_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">new_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bmc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* new space.  It needs to be resynced, so</span>
<span class="cm">				 * we set NEEDED_MASK.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bmc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">bmc</span> <span class="o">=</span> <span class="n">NEEDED_MASK</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">bitmap_count_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span>
							  <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">bitmap_set_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">,</span>
							   <span class="n">block</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">block</span> <span class="o">+=</span> <span class="n">new_blocks</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set_page_attr</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">BITMAP_PAGE_DIRTY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_unplug</span><span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bitmap_resize</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">location_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;file&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%+lld&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">location_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bitmap already configured.  Only option is to clear it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">restore_bitmap_write_access</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
			<span class="n">fput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No bitmap, OK to set a location */</span>
		<span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* nothing to be done */</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;file:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not supported yet */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">strict_strtoll</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">strict_strtoll</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">offset</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">bitmap_create</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="n">bitmap_load</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ensure new bitmap info is stored in</span>
<span class="cm">		 * metadata promptly.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_location</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">location_show</span><span class="p">,</span> <span class="n">location_store</span><span class="p">);</span>

<span class="cm">/* &#39;bitmap/space&#39; is the space available at &#39;location&#39; for the</span>
<span class="cm"> * bitmap.  This allows the kernel to know when it is safe to</span>
<span class="cm"> * resize the bitmap to match a resized array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">space_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">space_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sectors</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span> <span class="cm">/* Bitmap is too big for this small space */</span>

	<span class="cm">/* could make sure it isn&#39;t too big, but that isn&#39;t really</span>
<span class="cm">	 * needed - user-space should be careful.</span>
<span class="cm">	 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_space</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">space_show</span><span class="p">,</span> <span class="n">space_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">timeout_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secs</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jifs</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">%</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="n">secs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jifs</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;.%03u&quot;</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jifs</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">timeout_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* timeout can be set at any time */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">strict_strtoul_scaled</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/* just to make sure we don&#39;t overflow... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">LONG_MAX</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if thread-&gt;timeout is MAX_SCHEDULE_TIMEOUT, then</span>
<span class="cm">		 * the bitmap is all clean and we don&#39;t need to</span>
<span class="cm">		 * adjust the timeout right now</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_timeout</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">time_base</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">timeout_show</span><span class="p">,</span> <span class="n">timeout_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">backlog_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">backlog_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">backlog</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">backlog</span> <span class="o">&gt;</span> <span class="n">COUNTER_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_backlog</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">backlog</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">backlog_show</span><span class="p">,</span> <span class="n">backlog_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">chunksize_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">chunksize_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Can only be changed when no bitmap is active */</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">csize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csize</span> <span class="o">&lt;</span> <span class="mi">512</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">csize</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">csize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_chunksize</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">chunksize_show</span><span class="p">,</span> <span class="n">chunksize_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">metadata_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span>
				      <span class="o">?</span> <span class="s">&quot;external&quot;</span> <span class="o">:</span> <span class="s">&quot;internal&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">metadata_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;external&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;internal&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_metadata</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">metadata_show</span><span class="p">,</span> <span class="n">metadata_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">can_clear_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">?</span>
					     <span class="s">&quot;false&quot;</span> <span class="o">:</span> <span class="s">&quot;true&quot;</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">can_clear_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;false&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">bitmap_can_clear</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">can_clear</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">can_clear_show</span><span class="p">,</span> <span class="n">can_clear_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">behind_writes_used_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes_used</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">behind_writes_used_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">max_backlog_used</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">max_backlog_used</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
       <span class="n">behind_writes_used_show</span><span class="p">,</span> <span class="n">behind_writes_used_reset</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">md_bitmap_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">bitmap_location</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_space</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_timeout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_backlog</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_chunksize</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_metadata</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bitmap_can_clear</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">max_backlog_used</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">md_bitmap_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bitmap&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">md_bitmap_attrs</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
