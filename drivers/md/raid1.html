<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › raid1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>raid1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * raid1.c : Multiple Devices driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999, 2000, 2001 Ingo Molnar, Red Hat</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996, 1997, 1998 Ingo Molnar, Miguel de Icaza, Gadi Oxman</span>
<span class="cm"> *</span>
<span class="cm"> * RAID-1 management functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Better read-balancing code written by Mika Kuoppala &lt;miku@iki.fi&gt;, 2000</span>
<span class="cm"> *</span>
<span class="cm"> * Fixes to reconstruction by Jakob Østergaard&quot; &lt;jakob@ostenfeld.dk&gt;</span>
<span class="cm"> * Various fixes by Neil Brown &lt;neilb@cse.unsw.edu.au&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes by Peter T. Breuer &lt;ptb@it.uc3m.es&gt; 31/1/2003 to support</span>
<span class="cm"> * bitmapped intelligence in resync:</span>
<span class="cm"> *</span>
<span class="cm"> *      - bitmap marked during normal i/o</span>
<span class="cm"> *      - bitmap used to skip nondirty blocks during sync</span>
<span class="cm"> *</span>
<span class="cm"> * Additions to bitmap code, (C) 2003-2004 Paul Clements, SteelEye Technology:</span>
<span class="cm"> * - persistent bitmap code</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * (for example /usr/src/linux/COPYING); if not, write to the Free</span>
<span class="cm"> * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;raid1.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Number of guaranteed r1bios in case of extreme VM load:</span>
<span class="cm"> */</span>
<span class="cp">#define	NR_RAID1_BIOS 256</span>

<span class="cm">/* When there are this many requests queue to be written by</span>
<span class="cm"> * the raid1 thread, we become &#39;congested&#39; to provide back-pressure</span>
<span class="cm"> * for writeback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queued_requests</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">allow_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lower_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="nf">r1bio_pool_alloc</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span><span class="p">,</span> <span class="n">bios</span><span class="p">[</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">]);</span>

	<span class="cm">/* allocate a r1bio with room for raid_disks entries in the bios array */</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r1bio_pool_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RESYNC_BLOCK_SIZE (64*1024)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define RESYNC<em>BLOCK</em>SIZE PAGE_SIZE</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define RESYNC_SECTORS (RESYNC_BLOCK_SIZE &gt;&gt; 9)</span>
<span class="cp">#define RESYNC_PAGES ((RESYNC_BLOCK_SIZE + PAGE_SIZE-1) / PAGE_SIZE)</span>
<span class="cp">#define RESYNC_WINDOW (2048*1024)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="nf">r1buf_pool_alloc</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">r1bio_pool_alloc</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r1_bio</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate bios : 1 for reading, n-1 for writing</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="p">;</span> <span class="n">j</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">,</span> <span class="n">RESYNC_PAGES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_bio</span><span class="p">;</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate RESYNC_PAGES data pages and attach them to</span>
<span class="cm">	 * the first bio.</span>
<span class="cm">	 * If this is a user-requested check/repair, allocate</span>
<span class="cm">	 * RESYNC_PAGES for each bio.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_free_pages</span><span class="p">;</span>

			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* If not user-requests, copy the page pointers to all bios */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">RESYNC_PAGES</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span>
					<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r1_bio</span><span class="p">;</span>

<span class="nl">out_free_pages:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">out_free_bio:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="n">r1bio_pool_free</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r1buf_pool_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">__r1_bio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pool_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1bio</span> <span class="o">=</span> <span class="n">__r1_bio</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span> <span class="p">;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">r1bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">!=</span>
			    <span class="n">r1bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">)</span>
				<span class="n">safe_put_page</span><span class="p">(</span><span class="n">r1bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">r1bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">r1bio_pool_free</span><span class="p">(</span><span class="n">r1bio</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_all_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BIO_SPECIAL</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">))</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="o">*</span><span class="n">bio</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_r1bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">put_all_bios</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mempool_free</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">);</span>

	<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reschedule_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * raid_end_bio_io() is called when we have finished servicing a mirrored</span>
<span class="cm"> * operation and are ready to return a success/failure code to the buffer</span>
<span class="cm"> * cache layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">call_bio_endio</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">--</span><span class="p">;</span>
		<span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wake up any possible resync thread that waits for the device</span>
<span class="cm">		 * to go idle.</span>
<span class="cm">		 */</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_end_bio_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>

	<span class="cm">/* if nobody has done the final endio yet, do it now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">R1BIO_Returned</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid1: sync end %s on sectors %llu-%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">call_bio_endio</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_r1bio</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update disk head position estimator based on IRQ completion info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_head_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">disk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">head_position</span> <span class="o">=</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the disk number which triggered given bio</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_bio_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mirror</span> <span class="o">&lt;</span> <span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">mirror</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">mirror</span><span class="p">]</span> <span class="o">==</span> <span class="n">bio</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mirror</span> <span class="o">==</span> <span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">update_head_pos</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mirror</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid1_end_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">mirror</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * this branch is our &#39;one mirror IO has finished&#39; event handler:</span>
<span class="cm">	 */</span>
	<span class="n">update_head_pos</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If all other devices have failed, we want to return</span>
<span class="cm">		 * the error upwards rather than fail the last device.</span>
<span class="cm">		 * Here we redefine &quot;uptodate&quot; to mean &quot;Don&#39;t want to retry&quot;</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
			<span class="n">uptodate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span>
		<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * oops, read error:</span>
<span class="cm">		 */</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span>
			<span class="n">KERN_ERR</span> <span class="s">&quot;md/raid1:%s: %s: &quot;</span>
			<span class="s">&quot;rescheduling sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
				 <span class="n">b</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* it really is the end of this request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* free extra copy of the data pages */</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_page_count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">safe_put_page</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span><span class="p">);</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clear the bitmap if all writes complete successfully */</span>
	<span class="n">bitmap_endwrite</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			<span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_Degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="n">md_write_end</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r1_bio_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">close_write</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid1_end_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">behind</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">to_put</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mirror</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * &#39;one mirror IO has finished&#39; event handler:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set R1BIO_Uptodate in our master bio, so that we</span>
<span class="cm">		 * will return a good error code for to the higher</span>
<span class="cm">		 * levels even if IO on some other mirrored buffer</span>
<span class="cm">		 * fails.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The &#39;master&#39; represents the composite IO operation</span>
<span class="cm">		 * to user-side. So if something waits for IO, then it</span>
<span class="cm">		 * will wait for the &#39;master&#39; bio.</span>
<span class="cm">		 */</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">mirror</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">to_put</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* Maybe we can clear some bad blocks. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">mirror</span><span class="p">]</span> <span class="o">=</span> <span class="n">IO_MADE_GOOD</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">behind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_remaining</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * In behind mode, we ACK the master bio once the I/O</span>
<span class="cm">		 * has safely reached all non-writemostly</span>
<span class="cm">		 * disks. Setting the Returned bit ensures that this</span>
<span class="cm">		 * gets done only once -- we don&#39;t ever want to return</span>
<span class="cm">		 * -EIO here, instead we&#39;ll wait</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_remaining</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Maybe we can return now */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">R1BIO_Returned</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">mbio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid1: behind end write sectors&quot;</span>
					 <span class="s">&quot; %llu-%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span>
					 <span class="p">(</span><span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">call_bio_endio</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">mirror</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let&#39;s see if all mirrored write operations have finished</span>
<span class="cm">	 * already.</span>
<span class="cm">	 */</span>
	<span class="n">r1_bio_write_done</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_put</span><span class="p">)</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">to_put</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This routine returns the disk from which the requested read should</span>
<span class="cm"> * be done. There is a per-array &#39;next expected sequential IO&#39; sector</span>
<span class="cm"> * number - if this matches on the next IO then we use the last disk.</span>
<span class="cm"> * There is also a per-disk &#39;last know head position&#39; sector that is</span>
<span class="cm"> * maintained from IRQ contexts, both the normal and the resync IO</span>
<span class="cm"> * completion handlers update this position correctly. If there is no</span>
<span class="cm"> * perfect sequential match then we pick the disk whose head is closest.</span>
<span class="cm"> *</span>
<span class="cm"> * If there are 2 mirrors in the same 2 devices, performance degrades</span>
<span class="cm"> * because position is mirror, not device based.</span>
<span class="cm"> *</span>
<span class="cm"> * The rdev for the device selected will have nr_pending incremented.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">sector_t</span> <span class="n">this_sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_good_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">best_dist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">choose_first</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if we can balance. We can balance on the whole</span>
<span class="cm">	 * device if no resync is going on, or below the resync window.</span>
<span class="cm">	 * We take the first readable disk when above the resync window.</span>
<span class="cm">	 */</span>
 <span class="nl">retry:</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">best_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">best_dist</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">this_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">choose_first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">start_disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">choose_first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">start_disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">dist</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">disk</span> <span class="o">=</span> <span class="n">start_disk</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">disk</span> <span class="o">-=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">disk</span><span class="p">]</span> <span class="o">==</span> <span class="n">IO_BLOCKED</span>
		    <span class="o">||</span> <span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span>
		    <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;</span> <span class="n">this_sector</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t balance among write-mostly, just</span>
<span class="cm">			 * use the first as a last resort */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">best_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">this_sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&lt;</span> <span class="n">this_sector</span><span class="p">)</span>
						<span class="cm">/* Cannot use this */</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">this_sector</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
				<span class="n">best_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* This is a reasonable device to use.  It might</span>
<span class="cm">		 * even be best.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">this_sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">best_dist</span> <span class="o">&lt;</span> <span class="n">MaxSector</span><span class="p">)</span>
				<span class="cm">/* already have a better device */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&lt;=</span> <span class="n">this_sector</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* cannot read here. If this is the &#39;primary&#39;</span>
<span class="cm">				 * device, then we must not read beyond</span>
<span class="cm">				 * bad_sectors from another device..</span>
<span class="cm">				 */</span>
				<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">this_sector</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">choose_first</span> <span class="o">&amp;&amp;</span> <span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">bad_sectors</span><span class="p">)</span>
					<span class="n">sectors</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">best_good_sectors</span> <span class="o">&gt;</span> <span class="n">sectors</span><span class="p">)</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sector_t</span> <span class="n">good_sectors</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">this_sector</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">good_sectors</span> <span class="o">&gt;</span> <span class="n">best_good_sectors</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">good_sectors</span><span class="p">;</span>
					<span class="n">best_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">choose_first</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">best_good_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>

		<span class="n">dist</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">this_sector</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">head_position</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">choose_first</span>
		    <span class="cm">/* Don&#39;t change to another disk for sequential reads */</span>
		    <span class="o">||</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_seq_sect</span> <span class="o">==</span> <span class="n">this_sector</span>
		    <span class="o">||</span> <span class="n">dist</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="cm">/* If device is idle, use it */</span>
		    <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">best_dist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
			<span class="n">best_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">best_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">best_disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* cannot risk returning a device that failed</span>
<span class="cm">			 * before we inc&#39;ed nr_pending</span>
<span class="cm">			 */</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">best_good_sectors</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_seq_sect</span> <span class="o">=</span> <span class="n">this_sector</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">best_disk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">best_disk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_mergeable_bvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bvec_merge_data</span> <span class="o">*</span><span class="n">bvm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">biovec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span>
					<span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
					<span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
					<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">(</span>
							  <span class="n">q</span><span class="p">,</span> <span class="n">bvm</span><span class="p">,</span> <span class="n">biovec</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">md_raid1_congested</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BDI_async_congested</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&gt;=</span> <span class="n">max_queued_requests</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">);</span>

			<span class="cm">/* Note the &#39;|| 1&#39; - when read_balance prefers</span>
<span class="cm">			 * non-congested targets, it can be removed</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">BDI_async_congested</span><span class="p">))</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_raid1_congested</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_congested</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mddev_congested</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">md_raid1_congested</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_pending_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Any writes that have been queued but are awaiting</span>
<span class="cm">	 * bitmap updates get flushed here.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="cm">/* flush any pending bitmap writes to</span>
<span class="cm">		 * disk before proceeding w/ I/O */</span>
		<span class="n">bitmap_unplug</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* submit pending writes */</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Barriers....</span>
<span class="cm"> * Sometimes we need to suspend IO while we do something else,</span>
<span class="cm"> * either some resync/recovery, or reconfigure the array.</span>
<span class="cm"> * To do this we raise a &#39;barrier&#39;.</span>
<span class="cm"> * The &#39;barrier&#39; is a counter that can be raised multiple times</span>
<span class="cm"> * to count how many activities are happening which preclude</span>
<span class="cm"> * normal IO.</span>
<span class="cm"> * We can only raise the barrier if there is no pending IO.</span>
<span class="cm"> * i.e. if nr_pending == 0.</span>
<span class="cm"> * We choose only to raise the barrier if no-one is waiting for the</span>
<span class="cm"> * barrier to go down.  This means that as soon as an IO request</span>
<span class="cm"> * is ready, no other operations which require a barrier will start</span>
<span class="cm"> * until the IO request has had a chance.</span>
<span class="cm"> *</span>
<span class="cm"> * So: regular IO calls &#39;wait_barrier&#39;.  When that returns there</span>
<span class="cm"> *    is no backgroup IO happening,  It must arrange to call</span>
<span class="cm"> *    allow_barrier when it has finished its IO.</span>
<span class="cm"> * backgroup IO calls must call raise_barrier.  Once that returns</span>
<span class="cm"> *    there is no normal IO happeing.  It must arrange to call</span>
<span class="cm"> *    lower_barrier when the particular background IO completes.</span>
<span class="cm"> */</span>
<span class="cp">#define RESYNC_DEPTH 32</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raise_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>

	<span class="cm">/* Wait until no block IO is waiting */</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="p">);</span>

	<span class="cm">/* block any new IO from starting */</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Now wait for all pending IO to complete */</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">&lt;</span> <span class="n">RESYNC_DEPTH</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lower_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Wait for the barrier to drop.</span>
<span class="cm">		 * However if there are already pending</span>
<span class="cm">		 * requests (preventing the barrier from</span>
<span class="cm">		 * rising completely), and the</span>
<span class="cm">		 * pre-process bio queue isn&#39;t empty,</span>
<span class="cm">		 * then don&#39;t wait, as we need to empty</span>
<span class="cm">		 * that queue to get the nr_pending</span>
<span class="cm">		 * count down.</span>
<span class="cm">		 */</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
				    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">&amp;&amp;</span>
				     <span class="n">current</span><span class="o">-&gt;</span><span class="n">bio_list</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">bio_list_empty</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">bio_list</span><span class="p">)),</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span>
			<span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">allow_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">freeze_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop syncio and normal IO and wait for everything to</span>
<span class="cm">	 * go quite.</span>
<span class="cm">	 * We increment barrier and nr_waiting, and then</span>
<span class="cm">	 * wait until nr_pending match nr_queued+1</span>
<span class="cm">	 * This is called in the context of one normal IO request</span>
<span class="cm">	 * that has failed. Thus any sync request that might be pending</span>
<span class="cm">	 * will be blocked by nr_pending, and we need to wait for</span>
<span class="cm">	 * pending IO requests to complete or be queued for re-try.</span>
<span class="cm">	 * Thus the number queued (nr_queued) plus this request (1)</span>
<span class="cm">	 * must match the number of pending IOs (nr_pending) before</span>
<span class="cm">	 * we continue.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">++</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_pending</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">,</span>
			    <span class="n">flush_pending_writes</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unfreeze_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reverse the effect of the freeze */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">--</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="o">--</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* duplicate the data pages for behind I/O </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">alloc_behind_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvecs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio_vec</span><span class="p">),</span>
					<span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">bvecs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
		<span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_sync_io</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kmap</span><span class="p">(</span><span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span>
		       <span class="n">kmap</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span> <span class="o">=</span> <span class="n">bvecs</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_page_count</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">do_sync_io:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">)</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">bvecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bv_page</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bvecs</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%dB behind alloc failed, doing sync I/O</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span> <span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">mirror</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">read_bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_flush_fua</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">blocked_rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_clone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors_handled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the new request and wait if the reconstruction</span>
<span class="cm">	 * thread has put up a bar for new requests.</span>
<span class="cm">	 * Continue immediately if no resync is active currently.</span>
<span class="cm">	 */</span>

	<span class="n">md_write_start</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span> <span class="cm">/* wait on superblock update early */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">/</span><span class="mi">512</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* As the suspend_* range is controlled by</span>
<span class="cm">		 * userspace, we want an interruptible</span>
<span class="cm">		 * wait.</span>
<span class="cm">		 */</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">/</span><span class="mi">512</span> <span class="o">&lt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">||</span>
			    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * make_request() can abort the operation when READA is being</span>
<span class="cm">	 * used and no empty request is available.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>

	<span class="cm">/* We might need to issue multiple reads to different</span>
<span class="cm">	 * devices if there are bad blocks around, so we keep</span>
<span class="cm">	 * track of the number of reads in bio-&gt;bi_phys_segments.</span>
<span class="cm">	 * If this is 0, there is only one r1_bio and no locking</span>
<span class="cm">	 * will be needed when requests complete.  If it is</span>
<span class="cm">	 * non-zero, then it is the number of not-completed requests.</span>
<span class="cm">	 */</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_SEG_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * read balancing logic:</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">rdisk</span><span class="p">;</span>

<span class="nl">read_again:</span>
		<span class="n">rdisk</span> <span class="o">=</span> <span class="n">read_balance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_sectors</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdisk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* couldn&#39;t find anywhere to read from */</span>
			<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mirror</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">rdisk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reading from a write-mostly device must</span>
<span class="cm">			 * take care not to over-take any writes</span>
<span class="cm">			 * that are &#39;behind&#39;</span>
<span class="cm">			 */</span>
			<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_wait</span><span class="p">,</span>
				   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span> <span class="o">=</span> <span class="n">rdisk</span><span class="p">;</span>

		<span class="n">read_bio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">read_bio</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
			    <span class="n">max_sectors</span><span class="p">);</span>

		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">rdisk</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_bio</span><span class="p">;</span>

		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid1_end_read_request</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">do_sync</span><span class="p">;</span>
		<span class="n">read_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* could not read all from this device, so we will</span>
<span class="cm">			 * need another r1_bio.</span>
<span class="cm">			 */</span>

			<span class="n">sectors_handled</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">max_sectors</span>
					   <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="cm">/* Cannot call generic_make_request directly</span>
<span class="cm">			 * as that will be queued in __make_request</span>
<span class="cm">			 * and subsequent mempool_alloc might block waiting</span>
<span class="cm">			 * for it.  So hand bio over to raid1d.</span>
<span class="cm">			 */</span>
			<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>

			<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">sectors_handled</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">read_again</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">read_bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * WRITE:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&gt;=</span> <span class="n">max_queued_requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">,</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">&lt;</span> <span class="n">max_queued_requests</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* first select target devices under rcu_lock and</span>
<span class="cm">	 * inc refcount on their rdev.  Record them by setting</span>
<span class="cm">	 * bios[x] to bio</span>
<span class="cm">	 * If there are known/acknowledged bad blocks on any device on</span>
<span class="cm">	 * which we have seen a write error, we want to avoid writing those</span>
<span class="cm">	 * blocks.</span>
<span class="cm">	 * This potentially requires several writes to write around</span>
<span class="cm">	 * the bad blocks.  Each set of writes gets it&#39;s own r1bio</span>
<span class="cm">	 * with a set of bios attached.</span>
<span class="cm">	 */</span>

	<span class="n">disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
 <span class="nl">retry_write:</span>
	<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">is_bad</span><span class="p">;</span>

			<span class="n">is_bad</span> <span class="o">=</span> <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
					     <span class="n">max_sectors</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* mustn&#39;t write here until the bad block is</span>
<span class="cm">				 * acknowledged*/</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span> <span class="o">&amp;&amp;</span> <span class="n">first_bad</span> <span class="o">&lt;=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Cannot write here at all */</span>
				<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bad_sectors</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span>
					<span class="cm">/* mustn&#39;t write more than bad_sectors</span>
<span class="cm">					 * to other devices yet</span>
<span class="cm">					 */</span>
					<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
				<span class="cm">/* We don&#39;t set R1BIO_Degraded as that</span>
<span class="cm">				 * only applies if the disk is</span>
<span class="cm">				 * missing, so it might be re-added,</span>
<span class="cm">				 * and we want to know to recover this</span>
<span class="cm">				 * chunk.</span>
<span class="cm">				 * In this case the device is here,</span>
<span class="cm">				 * and the fact that this chunk is not</span>
<span class="cm">				 * in-sync is recorded in the bad</span>
<span class="cm">				 * block log</span>
<span class="cm">				 */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">good_sectors</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">good_sectors</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span>
					<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">good_sectors</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">blocked_rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wait for this device to become unblocked */</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">md_wait_for_blocked_rdev</span><span class="p">(</span><span class="n">blocked_rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_write</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are splitting this write into multiple parts, so</span>
<span class="cm">		 * we need to prepare for allocating another r1_bio.</span>
<span class="cm">		 */</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sectors_handled</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">max_sectors</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">first_clone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">mbio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mbio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">mbio</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first_clone</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* do behind I/O ?</span>
<span class="cm">			 * Not if there are too many, or cannot</span>
<span class="cm">			 * allocate memory, or a reader on WriteMostly</span>
<span class="cm">			 * is waiting for behind writes to flush */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">)</span>
			     <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_wait</span><span class="p">))</span>
				<span class="n">alloc_behind_pages</span><span class="p">(</span><span class="n">mbio</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>

			<span class="n">bitmap_startwrite</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
					  <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
					  <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="n">first_clone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="cm">/* Yes, I really want the &#39;__&#39; version so that</span>
<span class="cm">			 * we clear any unused pointer in the io_vec, rather</span>
<span class="cm">			 * than leave them unchanged.  This is important</span>
<span class="cm">			 * because when we come to free the pages, we won&#39;t</span>
<span class="cm">			 * know the original bi_idx, so we just free</span>
<span class="cm">			 * them all</span>
<span class="cm">			 */</span>
			<span class="n">__bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">mbio</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_remaining</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbio</span><span class="p">;</span>

		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span>	<span class="o">=</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span>
				   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span>	<span class="o">=</span> <span class="n">raid1_end_write_request</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span> <span class="o">|</span> <span class="n">do_flush_fua</span> <span class="o">|</span> <span class="n">do_sync</span><span class="p">;</span>
		<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">,</span> <span class="n">mbio</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev_check_plugged</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Mustn&#39;t call r1_bio_write_done before this next test,</span>
<span class="cm">	 * as it could result in the bio being freed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors_handled</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r1_bio_write_done</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
		<span class="cm">/* We need another r1_bio.  It has already been counted</span>
<span class="cm">		 * in bio-&gt;bi_phys_segments</span>
<span class="cm">		 */</span>
		<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">sectors_handled</span><span class="p">;</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry_write</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r1_bio_write_done</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>

	<span class="cm">/* In case raid1d snuck in to freeze_array */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; [%d/%d] [&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
		   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			   <span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;U&quot;</span> <span class="o">:</span> <span class="s">&quot;_&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If it is not operational, then we have already marked it as dead</span>
<span class="cm">	 * else if it is the last working disks, ignore the error, let the</span>
<span class="cm">	 * next level up know.</span>
<span class="cm">	 * else mark the drive as failed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t fail the drive, act as though we were just a</span>
<span class="cm">		 * normal single drive.</span>
<span class="cm">		 * However don&#39;t try a recovery from this drive as</span>
<span class="cm">		 * it is very likely to fail.</span>
<span class="cm">		 */</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if recovery is running, make sure it aborts.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
	       <span class="s">&quot;md/raid1:%s: Disk failure on %s, disabling device.</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md/raid1:%s: Operation continuing on %d devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RAID1 conf printout:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(!conf)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; --- wd:%d rd:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; disk %d, wo:%d, o:%d, dev:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
			       <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
			       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">allow_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_spare_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find all failed disks within the RAID1 configuration </span>
<span class="cm">	 * and mark them readable.</span>
<span class="cm">	 * Called under mddev lock, so rcu protection not needed.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">repl</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">repl</span>
		    <span class="o">&amp;&amp;</span> <span class="n">repl</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">==</span> <span class="n">MaxSector</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* replacement has just become active */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Replaced device not technically</span>
<span class="cm">				 * faulty, but we need to be sure</span>
<span class="cm">				 * it gets removed and never re-added</span>
<span class="cm">				 */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_add_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">mirror</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">mirror</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="o">+</span><span class="n">mirror</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

			<span class="n">p</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* As all devices are equivalent, we don&#39;t need a full recovery</span>
<span class="cm">			 * if this was recently any drive of the array</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">p</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Add this device as a replacement */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">mirror</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Some requests might not have seen this new</span>
<span class="cm">		 * merge_bvec_fn.  We must wait for them to complete</span>
<span class="cm">		 * before merging the device fully.</span>
<span class="cm">		 * First we make sure any code which has tested</span>
<span class="cm">		 * our function has submitted the request, then</span>
<span class="cm">		 * we wait for all outstanding requests to complete.</span>
<span class="cm">		 */</span>
		<span class="n">synchronize_sched</span><span class="p">();</span>
		<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Unmerged</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">md_integrity_add_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_remove_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="o">+</span> <span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">number</span><span class="p">;</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Only remove non-faulty devices if recovery</span>
<span class="cm">		 * is not possible.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">synchronize_rcu</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* lost the race, try later */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">number</span><span class="p">].</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We just removed a device that is being replaced.</span>
<span class="cm">			 * Move down the replacement.  We drain all IO before</span>
<span class="cm">			 * doing this to avoid confusion.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">repl</span> <span class="o">=</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">number</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">repl</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">number</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">md_integrity_register</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">abort:</span>

	<span class="n">print_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_sync_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>

	<span class="n">update_head_pos</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * we have read a block, now it needs to be re-written,</span>
<span class="cm">	 * or re-read if the read failed.</span>
<span class="cm">	 * We don&#39;t do much here, just schedule handling by raid1d</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span>
		<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_sync_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirror</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

	<span class="n">mirror</span> <span class="o">=</span> <span class="n">find_bio_disk</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">sync_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">sectors_to_go</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="cm">/* make sure these bits doesn&#39;t get cleared. */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">s</span> <span class="o">+=</span> <span class="n">sync_blocks</span><span class="p">;</span>
			<span class="n">sectors_to_go</span> <span class="o">-=</span> <span class="n">sync_blocks</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sectors_to_go</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">mirror</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
			       <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
			       <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">reschedule_retry</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
			<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">uptodate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r1_sync_page_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="cm">/* success */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* need to record an error - either for the block or the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fix_sync_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Try some synchronous reads of other devices to get</span>
<span class="cm">	 * good data, much like with normal read errors.  Only</span>
<span class="cm">	 * read into the pages we already have so we don&#39;t</span>
<span class="cm">	 * need to re-issue the read request.</span>
<span class="cm">	 * We don&#39;t need to freeze the array, because being in an</span>
<span class="cm">	 * active sync request, there is no normal IO, and</span>
<span class="cm">	 * no overlapping syncs.</span>
<span class="cm">	 * We don&#39;t need to check is_badblock() again as we</span>
<span class="cm">	 * made sure that anything with a bad block in range</span>
<span class="cm">	 * will have bi_end_io clear.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">];</span>
	<span class="n">sector_t</span> <span class="n">sect</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_read</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* No rcu protection needed here devices</span>
<span class="cm">				 * can only be removed when no resync is</span>
<span class="cm">				 * active, and resync is currently active</span>
<span class="cm">				 */</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span>
						 <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
						 <span class="n">READ</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">d</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Cannot read from anywhere, this block is lost.</span>
<span class="cm">			 * Record a bad block on each device.  If that doesn&#39;t</span>
<span class="cm">			 * work just disable and interrupt the recovery.</span>
<span class="cm">			 * Don&#39;t fail devices as that won&#39;t really help.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md/raid1:%s: %s: unrecoverable I/O read error&quot;</span>
			       <span class="s">&quot; for block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
			       <span class="n">bdevname</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
				<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Try next page */</span>
			<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">sect</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="cm">/* write it back and re-read */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">d</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">!=</span> <span class="n">end_sync_read</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
					    <span class="n">WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">d</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">!=</span> <span class="n">end_sync_read</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					    <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span>
					    <span class="n">READ</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">sect</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_checks</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We have read all readable devices.  If we haven&#39;t</span>
<span class="cm">	 * got the block, then there is no hope left.</span>
<span class="cm">	 * If we have, then we want to do a comparison</span>
<span class="cm">	 * and skip the write if everything is the same.</span>
<span class="cm">	 * If any blocks failed to read, then we need to</span>
<span class="cm">	 * attempt an over-write</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">primary</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vcnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">primary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">primary</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">primary</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">primary</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_read</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">primary</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">primary</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">primary</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span> <span class="o">=</span> <span class="n">primary</span><span class="p">;</span>
	<span class="n">vcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">pbio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">primary</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">sbio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">!=</span> <span class="n">end_sync_read</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">vcnt</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">pbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
					   <span class="n">page_address</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
					   <span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_len</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">+=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span>
			      <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* No need to write to this device. */</span>
			<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fixup the bio for reuse */</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="n">vcnt</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">vcnt</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">),</span>
			       <span class="n">page_address</span><span class="p">(</span><span class="n">pbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bv_page</span><span class="p">),</span>
			       <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_request_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="o">*</span><span class="n">wbio</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_Uptodate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="cm">/* ouch - failed to read all of that. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fix_sync_read_error</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process_checks</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * schedule writes</span>
<span class="cm">	 */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_read</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span> <span class="o">||</span>
		      <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">);</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">wbio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if we&#39;re here, all write(s) have completed, so clean up */</span>
		<span class="n">md_done_sync</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a kernel thread which:</span>
<span class="cm"> *</span>
<span class="cm"> *	1.	Retries failed read operations on working mirrors.</span>
<span class="cm"> *	2.	Updates the raid superblock when problems encounter.</span>
<span class="cm"> *	3.	Performs writes following reads for array synchronising.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">read_disk</span><span class="p">,</span>
			   <span class="n">sector_t</span> <span class="n">sect</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">read_disk</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* Note: no rcu protection needed here</span>
<span class="cm">			 * as this is synchronous in the raid1d thread</span>
<span class="cm">			 * which is the thread that might remove</span>
<span class="cm">			 * a device.  If raid1d ever becomes multi-threaded....</span>
<span class="cm">			 */</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			      <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&gt;=</span> <span class="n">sect</span> <span class="o">+</span> <span class="n">s</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
				<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">d</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">read_disk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot read from anywhere - mark it bad */</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">read_disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* write it back and re-read */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="n">read_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">d</span><span class="o">--</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">r1_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
						<span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="n">read_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">d</span><span class="o">--</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r1_sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
						    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">,</span> <span class="n">READ</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">atomic_add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;md/raid1:%s: read error corrected &quot;</span>
					       <span class="s">&quot;(%d sectors at %llu on %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">sect</span> <span class="o">+</span>
					           <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">),</span>
					       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">sect</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bi_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_bio_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_SYNC</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">bi_complete</span><span class="p">;</span>
	<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">narrow_write_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vcnt</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">vec</span><span class="p">;</span>

	<span class="cm">/* bio has the data to be written to device &#39;i&#39; where</span>
<span class="cm">	 * we just recently had a write error.</span>
<span class="cm">	 * We repeatedly clone the bio and trim down to one block,</span>
<span class="cm">	 * then try the write.  Where the write fails we record</span>
<span class="cm">	 * a bad block.</span>
<span class="cm">	 * It is conceivable that the bio doesn&#39;t exactly align with</span>
<span class="cm">	 * blocks.  We must handle this somehow.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We currently own a reference on the rdev.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">block_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sect_to_write</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">block_sectors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector</span> <span class="o">+</span> <span class="n">block_sectors</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">block_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="o">-</span> <span class="n">sector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_BehindIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vcnt</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_page_count</span><span class="p">;</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">behind_bvecs</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcnt</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">;</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sect_to_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">wbio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">sect_to_write</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">sect_to_write</span><span class="p">;</span>
		<span class="cm">/* Write at &#39;sector&#39; for &#39;sectors&#39;*/</span>

		<span class="n">wbio</span> <span class="o">=</span> <span class="n">bio_alloc_mddev</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">vcnt</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio_vec</span><span class="p">));</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="n">vcnt</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">wbio</span><span class="p">,</span> <span class="n">sector</span> <span class="o">-</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">wbio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">submit_bio_wait</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">wbio</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* failure! */</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span>
						<span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>

		<span class="n">bio_put</span><span class="p">(</span><span class="n">wbio</span><span class="p">);</span>
		<span class="n">sect_to_write</span> <span class="o">-=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">sector</span> <span class="o">+=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">block_sectors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_sync_write_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">m</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rdev_clear_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="n">md_done_sync</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_write_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="n">IO_MADE_GOOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">rdev_clear_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					     <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
					     <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This drive got a write error.  We need to</span>
<span class="cm">			 * narrow down and record precise write</span>
<span class="cm">			 * errors.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">narrow_write_error</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
				<span class="cm">/* an I/O failed, we can&#39;t clear the bitmap */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_Degraded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">rdev</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">close_write</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_read_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">R1BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="cm">/* we got a read error. Maybe the drive is bad.  Maybe just</span>
<span class="cm">	 * the block and we can fix it.</span>
<span class="cm">	 * We freeze all other IO, and try reading the block from</span>
<span class="cm">	 * other devices.  When we find one, we re-write</span>
<span class="cm">	 * and check it that fixes the read error.</span>
<span class="cm">	 * This is all done synchronously while the array is</span>
<span class="cm">	 * frozen</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freeze_array</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">fix_read_error</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">,</span>
			       <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="n">unfreeze_array</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">];</span>
	<span class="n">bdevname</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="nl">read_more:</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">read_balance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md/raid1:%s: %s: unrecoverable I/O&quot;</span>
		       <span class="s">&quot; read error for block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">raid_end_bio_io</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">do_sync</span>
			<span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">?</span> <span class="n">IO_BLOCKED</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_trim_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">);</span>
		<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">]</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">disk</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;md/raid1:%s: redirecting sector %llu&quot;</span>
				   <span class="s">&quot; to other mirror: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				   <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid1_end_read_request</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">do_sync</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Drat - have to split this up more */</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">mbio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">sectors_handled</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">max_sectors</span>
					       <span class="o">-</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">master_bio</span> <span class="o">=</span> <span class="n">mbio</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span>
					  <span class="o">-</span> <span class="n">sectors_handled</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
			<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">mbio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors_handled</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">read_more</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid1d</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>

	<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flush_pending_writes</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r1bio</span><span class="p">,</span> <span class="n">retry_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_queued</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mddev</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_IsSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">handle_sync_write_finished</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sync_request_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">handle_write_finished</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R1BIO_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">handle_read_error</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* just a partial read to be scheduled from separate</span>
<span class="cm">			 * context</span>
<span class="cm">			 */</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">]);</span>

		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_CHANGE_PENDING</span><span class="p">))</span>
			<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">buffs</span><span class="p">;</span>

	<span class="n">buffs</span> <span class="o">=</span> <span class="n">RESYNC_WINDOW</span> <span class="o">/</span> <span class="n">RESYNC_BLOCK_SIZE</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">buffs</span><span class="p">,</span> <span class="n">r1buf_pool_alloc</span><span class="p">,</span> <span class="n">r1buf_pool_free</span><span class="p">,</span>
					  <span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perform a &quot;sync&quot; on one &quot;block&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * We need to make sure that no normal I/O request - particularly write</span>
<span class="cm"> * requests - conflict with active sync requests.</span>
<span class="cm"> *</span>
<span class="cm"> * This is achieved by tracking pending requests and a &#39;barrier&#39; concept</span>
<span class="cm"> * that can be installed to exclude normal IO requests.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">sync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">,</span> <span class="kt">int</span> <span class="n">go_faster</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1bio</span> <span class="o">*</span><span class="n">r1_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_sector</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wonly</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_targets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read_targets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sync_blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">good_sectors</span> <span class="o">=</span> <span class="n">RESYNC_SECTORS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_bad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* number of sectors that are bad in all devices */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_resync</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">&gt;=</span> <span class="n">max_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we aborted, we need to abort the</span>
<span class="cm">		 * sync on the &#39;current&#39; bitmap chunk (there will</span>
<span class="cm">		 * only be one in raid1 resync.</span>
<span class="cm">		 * We can find the current addess in mddev-&gt;curr_resync</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&lt;</span> <span class="n">max_sector</span><span class="p">)</span> <span class="cm">/* aborted */</span>
			<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* completed sync */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">bitmap_close_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="n">close_sync</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* before building a request, check if we can skip these blocks..</span>
<span class="cm">	 * This call the bitmap_start_sync doesn&#39;t actually record anything</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We can skip this block, and probably several more */</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sync_blocks</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If there is non-resync activity waiting for a turn,</span>
<span class="cm">	 * and resync is going fast enough,</span>
<span class="cm">	 * then let it though before starting on this new sync request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go_faster</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nr_waiting</span><span class="p">)</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">bitmap_cond_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">);</span>
	<span class="n">r1_bio</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1buf_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">next_resync</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we get a correctably read error during resync or recovery,</span>
<span class="cm">	 * we might want to read from a different device.  So we</span>
<span class="cm">	 * flag all drives that could conceivably be read from for READ,</span>
<span class="cm">	 * and any others (which will be non-In_sync devices) for WRITE.</span>
<span class="cm">	 * If a read fails, we try reading from something else for which READ</span>
<span class="cm">	 * is OK.</span>
<span class="cm">	 */</span>

	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R1BIO_IsSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* take from bio_init */</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIO_POOL_MASK</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
				<span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_write</span><span class="p">;</span>
			<span class="n">write_targets</span> <span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* may need to read from here */</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="n">good_sectors</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">first_bad</span> <span class="o">&gt;</span> <span class="n">sector_nr</span><span class="p">)</span>
					<span class="n">good_sectors</span> <span class="o">=</span> <span class="n">first_bad</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">bad_sectors</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">-</span> <span class="n">first_bad</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">min_bad</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
					    <span class="n">min_bad</span> <span class="o">&gt;</span> <span class="n">bad_sectors</span><span class="p">)</span>
						<span class="n">min_bad</span> <span class="o">=</span> <span class="n">bad_sectors</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">&lt;</span> <span class="n">first_bad</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">wonly</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">wonly</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">disk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
				<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">end_sync_read</span><span class="p">;</span>
				<span class="n">read_targets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disk</span> <span class="o">=</span> <span class="n">wonly</span><span class="p">;</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_targets</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">min_bad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* These sectors are bad on all InSync devices, so we</span>
<span class="cm">		 * need to mark them bad on all write targets</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_write</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">ok</span> <span class="o">=</span> <span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span>
							<span class="n">min_bad</span><span class="p">,</span> <span class="mi">0</span>
					<span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot record the badblocks, so need to</span>
<span class="cm">			 * abort the resync.</span>
<span class="cm">			 * If there are multiple read targets, could just</span>
<span class="cm">			 * fail the really bad ones ???</span>
<span class="cm">			 */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">min_bad</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_bad</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">min_bad</span> <span class="o">&lt;</span> <span class="n">good_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only resync enough to reach the next bad-&gt;good</span>
<span class="cm">		 * transition */</span>
		<span class="n">good_sectors</span> <span class="o">=</span> <span class="n">min_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">read_targets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* extra read targets are also write targets */</span>
		<span class="n">write_targets</span> <span class="o">+=</span> <span class="n">read_targets</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_targets</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">read_targets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There is nowhere to write, so all non-sync</span>
<span class="cm">		 * drives must be failed - so we are finished</span>
<span class="cm">		 */</span>
		<span class="n">sector_t</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">put_buf</span><span class="p">(</span><span class="n">r1_bio</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">;</span> <span class="cm">/* Don&#39;t do IO beyond here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">&gt;</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">good_sectors</span><span class="p">)</span>
		<span class="n">max_sector</span> <span class="o">=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">good_sectors</span><span class="p">;</span>
	<span class="n">nr_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_sector</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_sector</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sync_blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="n">still_degraded</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sync_blocks</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sync_blocks</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">sync_blocks</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">page</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">].</span><span class="n">bv_page</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* stop here */</span>
					<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">i</span><span class="o">--</span><span class="p">;</span>
						<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="cm">/* remove last page from this bio */</span>
						<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="o">--</span><span class="p">;</span>
						<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
						<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span> <span class="n">BIO_SEG_VALID</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">bio_full</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">nr_sectors</span> <span class="o">+=</span> <span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
		<span class="n">sector_nr</span> <span class="o">+=</span> <span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
		<span class="n">sync_blocks</span> <span class="o">-=</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">disk</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&lt;</span> <span class="n">RESYNC_PAGES</span><span class="p">);</span>
 <span class="nl">bio_full:</span>
	<span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">nr_sectors</span><span class="p">;</span>

	<span class="cm">/* For a user-requested sync, we read all readable devices and do a</span>
<span class="cm">	 * compare</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="n">read_targets</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">==</span> <span class="n">end_sync_read</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">);</span>
				<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">[</span><span class="n">r1_bio</span><span class="o">-&gt;</span><span class="n">read_disk</span><span class="p">];</span>
		<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">nr_sectors</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nr_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">raid1_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="nf">setup_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r1conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mirror_info</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">NR_RAID1_BIOS</span><span class="p">,</span> <span class="n">r1bio_pool_alloc</span><span class="p">,</span>
					  <span class="n">r1bio_pool_free</span><span class="p">,</span>
					  <span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">disk_idx</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk_idx</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span>
		    <span class="o">||</span> <span class="n">disk_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">disk_idx</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">disk_idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_list</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">resync_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>

	<span class="n">bio_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_bio_list</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">disk</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">].</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This slot has a replacement. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* No original, just make the replacement</span>
<span class="cm">				 * a recovering spare</span>
<span class="cm">				 */</span>
				<span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span>
					<span class="n">disk</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">disk</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="cm">/* Original is not in_sync - bad */</span>
				<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">head_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * The first working device is used as a</span>
<span class="cm">			 * starting point to read balancing.</span>
<span class="cm">			 */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid1:%s: no operational mirrors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">raid1d</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="s">&quot;raid1&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;md/raid1:%s: couldn&#39;t allocate thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>

 <span class="nl">abort:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">)</span>
			<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
		<span class="n">safe_put_page</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">tmppage</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid1:%s: raid level not set to mirroring (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid1:%s: reshape_position set but not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * copy the already verified devices into our private RAID1</span>
<span class="cm">	 * bookkeeping area. [whatever we allocate in run(),</span>
<span class="cm">	 * should be freed in stop()]</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md/raid1:%s: not clean&quot;</span>
		       <span class="s">&quot; -- starting background reconstruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
		<span class="s">&quot;md/raid1:%s: active with %d out of %d mirrors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span> 
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, everything is just fine now</span>
<span class="cm">	 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>

	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">raid1_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="n">raid1_congested</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_data</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">raid1_mergeable_bvec</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">md_integrity_register</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="cm">/* wait for behind writes to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid1:%s: behind writes in progress - waiting to stop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="cm">/* need to kick something here to make sure I/O goes? */</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_wait</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">behind_writes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no resync is happening, and there is enough space</span>
<span class="cm">	 * on all devices, so we can resize.</span>
<span class="cm">	 * We need to make sure resync covers any new space.</span>
<span class="cm">	 * If the array is shrinking we should possibly wait until</span>
<span class="cm">	 * any io in the removed space completes, but it hardly seems</span>
<span class="cm">	 * worth it.</span>
<span class="cm">	 */</span>
	<span class="n">sector_t</span> <span class="n">newsize</span> <span class="o">=</span> <span class="n">raid1_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&gt;</span> <span class="n">newsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bitmap_resize</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">newsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
	<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid1_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We need to:</span>
<span class="cm">	 * 1/ resize the r1bio_pool</span>
<span class="cm">	 * 2/ resize conf-&gt;mirrors</span>
<span class="cm">	 *</span>
<span class="cm">	 * We allocate a new r1bio_pool if we can.</span>
<span class="cm">	 * Then raise a device barrier and wait until all IO stops.</span>
<span class="cm">	 * Then resize conf-&gt;mirrors and swap in the new r1bio pool.</span>
<span class="cm">	 *</span>
<span class="cm">	 * At the same time, we &quot;pack&quot; the devices so that all the missing</span>
<span class="cm">	 * devices have the higher raid_disk numbers.</span>
<span class="cm">	 */</span>
	<span class="n">mempool_t</span> <span class="o">*</span><span class="n">newpool</span><span class="p">,</span> <span class="o">*</span><span class="n">oldpool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pool_info</span> <span class="o">*</span><span class="n">newpoolinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mirror_info</span> <span class="o">*</span><span class="n">newmirrors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Cannot change chunk_size, layout, or level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">md_allow_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raid_disks</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">raid_disks</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">newpoolinfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newpoolinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpoolinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">newpoolinfo</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">newpoolinfo</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">newpool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">NR_RAID1_BIOS</span><span class="p">,</span> <span class="n">r1bio_pool_alloc</span><span class="p">,</span>
				 <span class="n">r1bio_pool_free</span><span class="p">,</span> <span class="n">newpoolinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newpool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">newpoolinfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newmirrors</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mirror_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">raid_disks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newmirrors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">newpoolinfo</span><span class="p">);</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">newpool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="cm">/* ok, everything is stopped */</span>
	<span class="n">oldpool</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">r1bio_pool</span> <span class="o">=</span> <span class="n">newpool</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">!=</span> <span class="n">d2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">d2</span><span class="p">;</span>
			<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;md/raid1:%s: cannot register rd%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
			<span class="n">newmirrors</span><span class="p">[</span><span class="n">d2</span><span class="o">++</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mirrors</span> <span class="o">=</span> <span class="n">newmirrors</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">poolinfo</span> <span class="o">=</span> <span class="n">newpoolinfo</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">+=</span> <span class="p">(</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just make sure it is in-range */</span>
	<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">oldpool</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid1_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* wake for suspend */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_barrier</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">raise_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">lower_barrier</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid1_takeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* raid1 can take over:</span>
<span class="cm">	 *  raid5 with 2 devices, any layout or chunk size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r1conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid1_personality</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raid1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">level</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_request</span>	<span class="o">=</span> <span class="n">make_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run</span>		<span class="o">=</span> <span class="n">run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span>		<span class="o">=</span> <span class="n">status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>	<span class="o">=</span> <span class="n">error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_add_disk</span>	<span class="o">=</span> <span class="n">raid1_add_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_remove_disk</span><span class="o">=</span> <span class="n">raid1_remove_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spare_active</span>	<span class="o">=</span> <span class="n">raid1_spare_active</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_request</span>	<span class="o">=</span> <span class="n">sync_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">raid1_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">raid1_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reshape</span>	<span class="o">=</span> <span class="n">raid1_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quiesce</span>	<span class="o">=</span> <span class="n">raid1_quiesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">takeover</span>	<span class="o">=</span> <span class="n">raid1_takeover</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">raid_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">register_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid1_personality</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid1_personality</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">raid_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">raid_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RAID1 (mirroring) personality for MD&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-personality-3&quot;</span><span class="p">);</span> <span class="cm">/* RAID1 */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-raid1&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-level-1&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">max_queued_requests</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
