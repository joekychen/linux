<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › dm-ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dm-ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2001, 2002 Sistina Software (UK) Limited.</span>
<span class="cm"> * Copyright (C) 2004 - 2006 Red Hat, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;dm.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dm-ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define DM_MSG_PREFIX &quot;ioctl&quot;</span>
<span class="cp">#define DM_DRIVER_EMAIL &quot;dm-devel@redhat.com&quot;</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * The ioctl interface needs to be able to look up devices by</span>
<span class="cm"> * name or uuid.</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">struct</span> <span class="n">hash_cell</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">name_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">uuid_list</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">new_map</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vers_iter</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dm_target_versions</span> <span class="o">*</span><span class="n">vers</span><span class="p">,</span> <span class="o">*</span><span class="n">old_vers</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define NUM_BUCKETS 64</span>
<span class="cp">#define MASK_BUCKETS (NUM_BUCKETS - 1)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">_name_buckets</span><span class="p">[</span><span class="n">NUM_BUCKETS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">_uuid_buckets</span><span class="p">[</span><span class="n">NUM_BUCKETS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dm_hash_remove_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">keep_open_devices</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Guards access to both hash tables.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_RWSEM</span><span class="p">(</span><span class="n">_hash_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Protects use of mdptr to obtain hash cell name and uuid from mapped device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_buckets</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">buckets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BUCKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">buckets</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm_hash_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_buckets</span><span class="p">(</span><span class="n">_name_buckets</span><span class="p">);</span>
	<span class="n">init_buckets</span><span class="p">(</span><span class="n">_uuid_buckets</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm_hash_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dm_hash_remove_all</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Hash function:</span>
<span class="cm"> * We&#39;re not really concerned with the str hash function being</span>
<span class="cm"> * fast since it&#39;s only used by the ioctl interface.</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hash_str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash_mult</span> <span class="o">=</span> <span class="mi">2654435387U</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">)</span> <span class="o">*</span> <span class="n">hash_mult</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="n">MASK_BUCKETS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Code for looking up a device by name</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="nf">__get_name_cell</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">name_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dm_get</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="nf">__get_uuid_cell</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">_uuid_buckets</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">uuid_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dm_get</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="nf">__get_dev_cell</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">dm_get_md</span><span class="p">(</span><span class="n">huge_decode_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">dm_get_mdptr</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Inserting, removing and renaming a device.</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="nf">alloc_cell</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uuid</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uuid</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid_list</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The kdev_t and uuid of a device can never change once it is</span>
<span class="cm"> * initially inserted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm_hash_insert</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uuid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the new cells.</span>
<span class="cm">	 */</span>
	<span class="n">cell</span> <span class="o">=</span> <span class="n">alloc_cell</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cell</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Insert the cell into both hash tables.</span>
<span class="cm">	 */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_name_cell</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_uuid_cell</span><span class="p">(</span><span class="n">uuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">);</span>
			<span class="n">dm_put</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">uuid_list</span><span class="p">,</span> <span class="n">_uuid_buckets</span> <span class="o">+</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">uuid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dm_get</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">dm_set_mdptr</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">cell</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">bad:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">free_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__hash_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="cm">/* remove from the dev hash */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid_list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">dm_set_mdptr</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_table</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_table_event</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">)</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">);</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="n">free_cell</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm_hash_remove_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">keep_open_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev_skipped</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">dev_skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BUCKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>
			<span class="n">dm_get</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">keep_open_devices</span> <span class="o">&amp;&amp;</span> <span class="n">dm_lock_for_deletion</span><span class="p">(</span><span class="n">md</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
				<span class="n">dev_skipped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">__hash_remove</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

			<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

			<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">keep_open_devices</span><span class="p">))</span>
				<span class="n">dm_destroy</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dm_destroy_immediate</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Some mapped devices may be using other mapped</span>
<span class="cm">			 * devices, so repeat until we make no further</span>
<span class="cm">			 * progress.  If a new mapped device is created</span>
<span class="cm">			 * here it will also get removed.</span>
<span class="cm">			 */</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_skipped</span><span class="p">)</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;remove_all left %d open device(s)&quot;</span><span class="p">,</span> <span class="n">dev_skipped</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the uuid of a hash_cell that isn&#39;t already set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__set_cell_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_uuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">new_uuid</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid_list</span><span class="p">,</span> <span class="n">_uuid_buckets</span> <span class="o">+</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">new_uuid</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Changes the name of a hash_cell and returns the old name for</span>
<span class="cm"> * the caller to free.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">__change_cell_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rename and move the name cell.</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">);</span>
	<span class="n">old_name</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name_list</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">new_name</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">old_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="nf">dm_hash_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">new_data</span><span class="p">,</span> <span class="o">*</span><span class="n">old_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">change_uuid</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_UUID_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * duplicate new.</span>
<span class="cm">	 */</span>
	<span class="n">new_data</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Is new free ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_uuid</span><span class="p">)</span>
		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_uuid_cell</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_name_cell</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unable to change %s on mapped device %s to one that &quot;</span>
		       <span class="s">&quot;already exists: %s&quot;</span><span class="p">,</span>
		       <span class="n">change_uuid</span> <span class="o">?</span> <span class="s">&quot;uuid&quot;</span> <span class="o">:</span> <span class="s">&quot;name&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Is there such a device as &#39;old&#39; ?</span>
<span class="cm">	 */</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_name_cell</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unable to rename non-existent device, %s to %s%s&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">change_uuid</span> <span class="o">?</span> <span class="s">&quot;uuid &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENXIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Does this device already have a uuid?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_uuid</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unable to change uuid of mapped device %s to %s &quot;</span>
		       <span class="s">&quot;because uuid is already set to %s&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">);</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">new_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change_uuid</span><span class="p">)</span>
		<span class="n">__set_cell_uuid</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">new_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">old_name</span> <span class="o">=</span> <span class="n">__change_cell_name</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">new_data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up any dm event waiters.</span>
<span class="cm">	 */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_table</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_table_event</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm_kobject_uevent</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">event_nr</span><span class="p">))</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_UEVENT_GENERATED_FLAG</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">old_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">md</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Implementation of the ioctl commands</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * All the ioctl commands get dispatched to functions with this</span>
<span class="cm"> * prototype.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dm_hash_remove_all</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Round up the ptr to an 8-byte boundary.</span>
<span class="cm"> */</span>
<span class="cp">#define ALIGN_MASK 7</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">align_ptr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">ALIGN_MASK</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ALIGN_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieves the data payload buffer from an already allocated</span>
<span class="cm"> * struct dm_ioctl.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">get_result_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">=</span> <span class="n">align_ptr</span><span class="p">(</span><span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">&lt;</span> <span class="n">param_size</span><span class="p">)</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">param_size</span> <span class="o">-</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">list_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_name_list</span> <span class="o">*</span><span class="n">nl</span><span class="p">,</span> <span class="o">*</span><span class="n">old_nl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through all the devices working out how much</span>
<span class="cm">	 * space we need.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BUCKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">needed</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_name_list</span><span class="p">);</span>
			<span class="n">needed</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">needed</span> <span class="o">+=</span> <span class="n">ALIGN_MASK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab our output buffer.</span>
<span class="cm">	 */</span>
	<span class="n">nl</span> <span class="o">=</span> <span class="n">get_result_buffer</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">needed</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Flags no data */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now loop through filling out the names.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BUCKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">_name_buckets</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">name_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_nl</span><span class="p">)</span>
				<span class="n">old_nl</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">nl</span> <span class="o">-</span>
							   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">old_nl</span><span class="p">);</span>
			<span class="n">disk</span> <span class="o">=</span> <span class="n">dm_disk</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">);</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">disk_devt</span><span class="p">(</span><span class="n">disk</span><span class="p">));</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">old_nl</span> <span class="o">=</span> <span class="n">nl</span><span class="p">;</span>
			<span class="n">nl</span> <span class="o">=</span> <span class="n">align_ptr</span><span class="p">(((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">++</span><span class="n">nl</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">list_version_get_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_type</span> <span class="o">*</span><span class="n">tt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">needed_param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="o">*</span><span class="n">needed</span> <span class="o">=</span> <span class="n">needed_param</span><span class="p">;</span>

    <span class="o">*</span><span class="n">needed</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_versions</span><span class="p">);</span>
    <span class="o">*</span><span class="n">needed</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="o">*</span><span class="n">needed</span> <span class="o">+=</span> <span class="n">ALIGN_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">list_version_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_type</span> <span class="o">*</span><span class="n">tt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">vers_iter</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

    <span class="cm">/* Check space - it might have changed since the first iteration */</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">old_vers</span><span class="p">)</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">old_vers</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span> <span class="o">-</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">old_vers</span><span class="p">);</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">old_vers</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span> <span class="o">=</span> <span class="n">align_ptr</span><span class="p">(((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">++</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vers</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">list_versions</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_versions</span> <span class="o">*</span><span class="n">vers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vers_iter</span> <span class="n">iter_info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through all the devices working out how much</span>
<span class="cm">	 * space we need.</span>
<span class="cm">	 */</span>
	<span class="n">dm_target_iterate</span><span class="p">(</span><span class="n">list_version_get_needed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab our output buffer.</span>
<span class="cm">	 */</span>
	<span class="n">vers</span> <span class="o">=</span> <span class="n">get_result_buffer</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">needed</span><span class="p">;</span>

	<span class="n">iter_info</span><span class="p">.</span><span class="n">param_size</span> <span class="o">=</span> <span class="n">param_size</span><span class="p">;</span>
	<span class="n">iter_info</span><span class="p">.</span><span class="n">old_vers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iter_info</span><span class="p">.</span><span class="n">vers</span> <span class="o">=</span> <span class="n">vers</span><span class="p">;</span>
	<span class="n">iter_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iter_info</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vers</span><span class="o">+</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now loop through filling out the names &amp; versions.</span>
<span class="cm">	 */</span>
	<span class="n">dm_target_iterate</span><span class="p">(</span><span class="n">list_version_get_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter_info</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">iter_info</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;invalid device name&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On successful return, the caller must not attempt to acquire</span>
<span class="cm"> * _hash_lock without first calling dm_table_put, because dm_table_destroy</span>
<span class="cm"> * waits for this dm_table_put and could be called under this lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="nf">dm_get_inactive_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">dm_get_mdptr</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">!=</span> <span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;device has been removed from the dev hash table.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
		<span class="n">dm_table_get</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="nf">dm_get_live_or_inactive_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_QUERY_INACTIVE_TABLE_FLAG</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dm_get_inactive_table</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="o">:</span> <span class="n">dm_get_live_table</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fills in a dm_ioctl structure, ready for sending back to</span>
<span class="cm"> * userland.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">dm_disk</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DM_SUSPEND_FLAG</span> <span class="o">|</span> <span class="n">DM_READONLY_FLAG</span> <span class="o">|</span>
			  <span class="n">DM_ACTIVE_PRESENT_FLAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_suspended_md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_SUSPEND_FLAG</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">disk_devt</span><span class="p">(</span><span class="n">disk</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Yes, this will be out of date by the time it gets back</span>
<span class="cm">	 * to userland, but it is still very useful for</span>
<span class="cm">	 * debugging.</span>
<span class="cm">	 */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">open_count</span> <span class="o">=</span> <span class="n">dm_open_count</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">event_nr</span> <span class="o">=</span> <span class="n">dm_get_event_nr</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_table</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_QUERY_INACTIVE_TABLE_FLAG</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_disk_ro</span><span class="p">(</span><span class="n">disk</span><span class="p">))</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_READONLY_FLAG</span><span class="p">;</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span> <span class="o">=</span> <span class="n">dm_table_get_num_targets</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>

		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_ACTIVE_PRESENT_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_QUERY_INACTIVE_TABLE_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_inactive_table</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_READONLY_FLAG</span><span class="p">;</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span> <span class="o">=</span> <span class="n">dm_table_get_num_targets</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
			<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">DM_ANY_MINOR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">check_name</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_PERSISTENT_DEV_FLAG</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">huge_decode_dev</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_create</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_hash_insert</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">?</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="n">dm_destroy</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Always use UUID for lookups if it&#39;s present, otherwise use name or dev.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="nf">__find_device_hash_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_uuid_cell</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_name_cell</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span> <span class="o">=</span> <span class="n">__get_dev_cell</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sneakily write in both the name and the uuid</span>
<span class="cm">	 * while we have the cell.</span>
<span class="cm">	 */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">)</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="nf">find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">__find_device_hash_cell</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="p">)</span>
		<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">md</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">__find_device_hash_cell</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMDEBUG_LIMIT</span><span class="p">(</span><span class="s">&quot;device doesn&#39;t appear to be in the dev hash table.&quot;</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure the device is not open and nothing further can open it.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_lock_for_deletion</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMDEBUG_LIMIT</span><span class="p">(</span><span class="s">&quot;unable to remove open device %s&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__hash_remove</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm_kobject_uevent</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">KOBJ_REMOVE</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">event_nr</span><span class="p">))</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_UEVENT_GENERATED_FLAG</span><span class="p">;</span>

	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="n">dm_destroy</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check a string doesn&#39;t overrun the chunk of</span>
<span class="cm"> * memory we copied from userland.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">invalid_str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">str</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">str</span><span class="o">++</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_rename</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">new_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">change_uuid</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_UUID_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_data</span> <span class="o">&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span>
	    <span class="n">invalid_str</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param_size</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">strlen</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">change_uuid</span> <span class="o">?</span> <span class="n">DM_UUID_LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">DM_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Invalid new mapped device name or uuid string supplied.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">change_uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">check_name</span><span class="p">(</span><span class="n">new_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">dm_hash_rename</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">new_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_set_geometry</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hd_geometry</span> <span class="n">geometry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indata</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">geostr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">geostr</span> <span class="o">&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span>
	    <span class="n">invalid_str</span><span class="p">(</span><span class="n">geostr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Invalid geometry supplied.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">geostr</span><span class="p">,</span> <span class="s">&quot;%lu %lu %lu %lu%c&quot;</span><span class="p">,</span> <span class="n">indata</span><span class="p">,</span>
		   <span class="n">indata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indata</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">indata</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Unable to interpret geometry settings.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="o">||</span> <span class="n">indata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span>
	    <span class="n">indata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="n">indata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ULONG_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Geometry exceeds range limits.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geometry</span><span class="p">.</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">geometry</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">indata</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">geometry</span><span class="p">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">indata</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">geometry</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">indata</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_set_geometry</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geometry</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">suspend_flags</span> <span class="o">=</span> <span class="n">DM_SUSPEND_LOCKFS_FLAG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_SKIP_LOCKFS_FLAG</span><span class="p">)</span>
		<span class="n">suspend_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_SUSPEND_LOCKFS_FLAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_NOFLUSH_FLAG</span><span class="p">)</span>
		<span class="n">suspend_flags</span> <span class="o">|=</span> <span class="n">DM_SUSPEND_NOFLUSH_FLAG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm_suspended_md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dm_suspend</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">suspend_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">suspend_flags</span> <span class="o">=</span> <span class="n">DM_SUSPEND_LOCKFS_FLAG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">new_map</span><span class="p">,</span> <span class="o">*</span><span class="n">old_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">__find_device_hash_cell</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMDEBUG_LIMIT</span><span class="p">(</span><span class="s">&quot;device doesn&#39;t appear to be in the dev hash table.&quot;</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>

	<span class="n">new_map</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>

	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="cm">/* Do we need to load a new map ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Suspend if it isn&#39;t already suspended */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_SKIP_LOCKFS_FLAG</span><span class="p">)</span>
			<span class="n">suspend_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_SUSPEND_LOCKFS_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_NOFLUSH_FLAG</span><span class="p">)</span>
			<span class="n">suspend_flags</span> <span class="o">|=</span> <span class="n">DM_SUSPEND_NOFLUSH_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm_suspended_md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
			<span class="n">dm_suspend</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">suspend_flags</span><span class="p">);</span>

		<span class="n">old_map</span> <span class="o">=</span> <span class="n">dm_swap_table</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">new_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">old_map</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">new_map</span><span class="p">);</span>
			<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">old_map</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dm_table_get_mode</span><span class="p">(</span><span class="n">new_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">dm_disk</span><span class="p">(</span><span class="n">md</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">dm_disk</span><span class="p">(</span><span class="n">md</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_suspended_md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dm_resume</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dm_kobject_uevent</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">event_nr</span><span class="p">))</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_UEVENT_GENERATED_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_map</span><span class="p">)</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">old_map</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or unset the suspension state of a device.</span>
<span class="cm"> * If the device already is in the requested state we just return its status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_SUSPEND_FLAG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">do_suspend</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">do_resume</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copies device info back to user space, used by</span>
<span class="cm"> * the create and info ioctls.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build up the status struct for each target</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">retrieve_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">outbuf</span><span class="p">,</span> <span class="o">*</span><span class="n">outptr</span><span class="p">;</span>
	<span class="n">status_type_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">outptr</span> <span class="o">=</span> <span class="n">outbuf</span> <span class="o">=</span> <span class="n">get_result_buffer</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_STATUS_TABLE_FLAG</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">STATUSTYPE_TABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">STATUSTYPE_INFO</span><span class="p">;</span>

	<span class="cm">/* Get all the target info */</span>
	<span class="n">num_targets</span> <span class="o">=</span> <span class="n">dm_table_get_num_targets</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_targets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="n">dm_table_get_target</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">remaining</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">outptr</span> <span class="o">-</span> <span class="n">outbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="p">)</span> <span class="n">outptr</span><span class="p">;</span>

		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">sector_start</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">));</span>

		<span class="n">outptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span><span class="p">);</span>
		<span class="n">remaining</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">outptr</span> <span class="o">-</span> <span class="n">outbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get the status/table string from the target driver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">outptr</span><span class="p">,</span> <span class="n">remaining</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">outptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">outptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">outptr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">outptr</span> <span class="o">-</span> <span class="n">outbuf</span><span class="p">);</span>

		<span class="n">outptr</span> <span class="o">=</span> <span class="n">align_ptr</span><span class="p">(</span><span class="n">outptr</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">outptr</span> <span class="o">-</span> <span class="n">outbuf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">used</span><span class="p">)</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span> <span class="o">=</span> <span class="n">num_targets</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for a device to report an event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dev_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for a notification event</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm_wait_event</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">event_nr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The userland program is going to want to know what</span>
<span class="cm">	 * changed to trigger the event, so we may as well tell</span>
<span class="cm">	 * him and save an ioctl.</span>
<span class="cm">	 */</span>
	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_or_inactive_table</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retrieve_status</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">fmode_t</span> <span class="nf">get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fmode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_READONLY_FLAG</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FMODE_READ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">next_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">next</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">**</span><span class="n">spec</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">target_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">last</span> <span class="o">+</span> <span class="n">next</span><span class="p">);</span>
	<span class="o">*</span><span class="n">target_params</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">spec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">spec</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">invalid_str</span><span class="p">(</span><span class="o">*</span><span class="n">target_params</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">populate_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_spec</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">next</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">target_params</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;populate_table: no targets specified&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">next_target</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;unable to find target&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dm_table_add_target</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
					<span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">sector_start</span><span class="p">,</span>
					<span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					<span class="n">target_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;error adding target to table&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dm_table_complete</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">table_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_type</span> <span class="o">*</span><span class="n">immutable_target_type</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_table_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">get_mode</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">target_count</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">populate_table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">immutable_target_type</span> <span class="o">=</span> <span class="n">dm_get_immutable_target_type</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">immutable_target_type</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">immutable_target_type</span> <span class="o">!=</span> <span class="n">dm_table_get_immutable_target_type</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;can&#39;t replace immutable target type %s&quot;</span><span class="p">,</span>
		       <span class="n">immutable_target_type</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Protect md-&gt;type and md-&gt;queue against concurrent table loads. */</span>
	<span class="n">dm_lock_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dm_get_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="o">==</span> <span class="n">DM_TYPE_NONE</span><span class="p">)</span>
		<span class="cm">/* Initial table load: acquire type of table. */</span>
		<span class="n">dm_set_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">dm_table_get_type</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dm_get_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dm_table_get_type</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;can&#39;t change device type after initial table load.&quot;</span><span class="p">);</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">dm_unlock_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup md-&gt;queue to reflect md&#39;s type (may block) */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_setup_md_queue</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;unable to set up device queue for new table.&quot;</span><span class="p">);</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">dm_unlock_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dm_unlock_md_type</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="cm">/* stage inactive table */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">dm_get_mdptr</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">!=</span> <span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;device has been removed from the dev hash table.&quot;</span><span class="p">);</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">)</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>
	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">table_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>

	<span class="n">hc</span> <span class="o">=</span> <span class="n">__find_device_hash_cell</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMDEBUG_LIMIT</span><span class="p">(</span><span class="s">&quot;device doesn&#39;t appear to be in the dev hash table.&quot;</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_table_destroy</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">new_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_INACTIVE_PRESENT_FLAG</span><span class="p">;</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">md</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_hash_lock</span><span class="p">);</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieves a list of devices used by a particular dm device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">retrieve_deps</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">needed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_dev_internal</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_deps</span> <span class="o">*</span><span class="n">deps</span><span class="p">;</span>

	<span class="n">deps</span> <span class="o">=</span> <span class="n">get_result_buffer</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Count the devices.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dm_table_get_devices</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check we have enough space.</span>
<span class="cm">	 */</span>
	<span class="n">needed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">deps</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">deps</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the devices.</span>
<span class="cm">	 */</span>
	<span class="n">deps</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">dm_table_get_devices</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">deps</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dm_dev</span><span class="p">.</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">+</span> <span class="n">needed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">table_deps</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_or_inactive_table</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retrieve_deps</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the status of a device as a text string for each</span>
<span class="cm"> * target.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">table_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">__dev_status</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_or_inactive_table</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retrieve_status</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>
		<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pass a message to the target that&#39;s at the supplied device offset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">target_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">param_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">argc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_target_msg</span> <span class="o">*</span><span class="n">tmsg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">find_device</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmsg</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dm_target_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span>
	    <span class="n">invalid_str</span><span class="p">(</span><span class="n">tmsg</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span> <span class="o">+</span> <span class="n">param_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Invalid target message parameters.&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_split_args</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span> <span class="n">tmsg</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Failed to split target message parameters&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Empty message received.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_argv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">dm_get_live_table</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_argv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_deleting_md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ti</span> <span class="o">=</span> <span class="n">dm_table_find_target</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tmsg</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dm_target_is_valid</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Target message sector outside device.&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;Target type does not support messages&quot;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out_table:</span>
	<span class="n">dm_table_put</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
 <span class="nl">out_argv:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dm_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------</span>
<span class="cm"> * Implementation of open/close/ioctl on the special char</span>
<span class="cm"> * device.</span>
<span class="cm"> *---------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">ioctl_fn</span> <span class="nf">lookup_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">ioctl_fn</span> <span class="n">fn</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">_ioctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">DM_VERSION_CMD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>	<span class="cm">/* version is dealt with elsewhere */</span>
		<span class="p">{</span><span class="n">DM_REMOVE_ALL_CMD</span><span class="p">,</span> <span class="n">remove_all</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_LIST_DEVICES_CMD</span><span class="p">,</span> <span class="n">list_devices</span><span class="p">},</span>

		<span class="p">{</span><span class="n">DM_DEV_CREATE_CMD</span><span class="p">,</span> <span class="n">dev_create</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_REMOVE_CMD</span><span class="p">,</span> <span class="n">dev_remove</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_RENAME_CMD</span><span class="p">,</span> <span class="n">dev_rename</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_SUSPEND_CMD</span><span class="p">,</span> <span class="n">dev_suspend</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_STATUS_CMD</span><span class="p">,</span> <span class="n">dev_status</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_WAIT_CMD</span><span class="p">,</span> <span class="n">dev_wait</span><span class="p">},</span>

		<span class="p">{</span><span class="n">DM_TABLE_LOAD_CMD</span><span class="p">,</span> <span class="n">table_load</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_TABLE_CLEAR_CMD</span><span class="p">,</span> <span class="n">table_clear</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_TABLE_DEPS_CMD</span><span class="p">,</span> <span class="n">table_deps</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_TABLE_STATUS_CMD</span><span class="p">,</span> <span class="n">table_status</span><span class="p">},</span>

		<span class="p">{</span><span class="n">DM_LIST_VERSIONS_CMD</span><span class="p">,</span> <span class="n">list_versions</span><span class="p">},</span>

		<span class="p">{</span><span class="n">DM_TARGET_MSG_CMD</span><span class="p">,</span> <span class="n">target_message</span><span class="p">},</span>
		<span class="p">{</span><span class="n">DM_DEV_SET_GEOMETRY_CMD</span><span class="p">,</span> <span class="n">dev_set_geometry</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">_ioctls</span><span class="p">))</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">_ioctls</span><span class="p">[</span><span class="n">cmd</span><span class="p">].</span><span class="n">fn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * As well as checking the version compatibility this always</span>
<span class="cm"> * copies the kernel interface version out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_version</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">version</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DM_VERSION_MAJOR</span> <span class="o">!=</span> <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">DM_VERSION_MINOR</span> <span class="o">&lt;</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;ioctl interface mismatch: &quot;</span>
		       <span class="s">&quot;kernel(%u.%u.%u), user(%u.%u.%u), cmd(%d)&quot;</span><span class="p">,</span>
		       <span class="n">DM_VERSION_MAJOR</span><span class="p">,</span> <span class="n">DM_VERSION_MINOR</span><span class="p">,</span>
		       <span class="n">DM_VERSION_PATCHLEVEL</span><span class="p">,</span>
		       <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the kernel version.</span>
<span class="cm">	 */</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DM_VERSION_MAJOR</span><span class="p">;</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DM_VERSION_MINOR</span><span class="p">;</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">DM_VERSION_PATCHLEVEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">dmi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">secure_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">secure_data</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_SECURE_DATA_FLAG</span><span class="p">;</span>

	<span class="n">dmi</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secure_data</span> <span class="o">&amp;&amp;</span> <span class="n">clear_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dmi</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="cm">/* Wipe the user buffer so we do not return it to userspace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secure_data</span> <span class="o">&amp;&amp;</span> <span class="n">clear_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">dmi</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secure_data</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">dmi</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_params</span><span class="p">(</span><span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always clear this flag */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_BUFFER_FULL_FLAG</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_UEVENT_GENERATED_FLAG</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DM_SECURE_DATA_FLAG</span><span class="p">;</span>

	<span class="cm">/* Ignores parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DM_REMOVE_ALL_CMD</span> <span class="o">||</span>
	    <span class="n">cmd</span> <span class="o">==</span> <span class="n">DM_LIST_DEVICES_CMD</span> <span class="o">||</span>
	    <span class="n">cmd</span> <span class="o">==</span> <span class="n">DM_LIST_VERSIONS_CMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DM_DEV_CREATE_CMD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;name not supplied when creating device&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;only supply one of name or uuid, cmd(%u)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure strings are terminated */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DM_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">[</span><span class="n">DM_UUID_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctl_ioctl</span><span class="p">(</span><span class="n">uint</span> <span class="n">command</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wipe_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="n">ioctl_fn</span> <span class="n">fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">input_param_size</span><span class="p">;</span>

	<span class="cm">/* only root can play with this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DM_IOCTL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the interface version passed in.  This also</span>
<span class="cm">	 * writes out the kernel&#39;s interface version.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">check_version</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Nothing more to do for the version command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DM_VERSION_CMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">lookup_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMWARN</span><span class="p">(</span><span class="s">&quot;dm_ctl_ioctl: unknown command 0x%x&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Trying to avoid low memory issues when a device is</span>
<span class="cm">	 * suspended.</span>
<span class="cm">	 */</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PF_MEMALLOC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the parameters into kernel space.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">copy_params</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PF_MEMALLOC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">input_param_size</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">wipe_buffer</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DM_SECURE_DATA_FLAG</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">validate_params</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">input_param_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the results back to userland.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wipe_buffer</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">input_param_size</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">dm_ctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">uint</span> <span class="n">command</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ctl_ioctl</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dm_ioctl</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">u</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">dm_compat_ctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">uint</span> <span class="n">command</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dm_ctl_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">u</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define dm_compat_ctl_ioctl NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">_ctl_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	 <span class="o">=</span> <span class="n">dm_ctl_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">dm_compat_ctl_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">_dm_misc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="n">MAPPER_CTRL_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>  		<span class="o">=</span> <span class="n">DM_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nodename</span>	<span class="o">=</span> <span class="n">DM_DIR</span> <span class="s">&quot;/&quot;</span> <span class="n">DM_CONTROL_NODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>  		<span class="o">=</span> <span class="o">&amp;</span><span class="n">_ctl_fops</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">MAPPER_CTRL_MINOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;devname:&quot;</span> <span class="n">DM_DIR</span> <span class="s">&quot;/&quot;</span> <span class="n">DM_CONTROL_NODE</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Create misc character device and link to DM_DIR/control.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">dm_interface_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">dm_hash_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_dm_misc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;misc_register failed for control device&quot;</span><span class="p">);</span>
		<span class="n">dm_hash_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DMINFO</span><span class="p">(</span><span class="s">&quot;%d.%d.%d%s initialised: %s&quot;</span><span class="p">,</span> <span class="n">DM_VERSION_MAJOR</span><span class="p">,</span>
	       <span class="n">DM_VERSION_MINOR</span><span class="p">,</span> <span class="n">DM_VERSION_PATCHLEVEL</span><span class="p">,</span> <span class="n">DM_VERSION_EXTRA</span><span class="p">,</span>
	       <span class="n">DM_DRIVER_EMAIL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dm_interface_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_dm_misc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DMERR</span><span class="p">(</span><span class="s">&quot;misc_deregister failed for control device&quot;</span><span class="p">);</span>

	<span class="n">dm_hash_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dm_copy_name_and_uuid - Copy mapped device name &amp; uuid into supplied buffers</span>
<span class="cm"> * @md: Pointer to mapped_device</span>
<span class="cm"> * @name: Buffer (size DM_NAME_LEN) for name</span>
<span class="cm"> * @uuid: Buffer (size DM_UUID_LEN) for uuid or empty string if uuid not defined</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dm_copy_name_and_uuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mapped_device</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hash_cell</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">dm_get_mdptr</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">!=</span> <span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">?</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm_hash_cells_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
