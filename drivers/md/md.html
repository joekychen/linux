<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › md.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>md.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   md.c : Multiple Devices driver for Linux</span>
<span class="cm">	  Copyright (C) 1998, 1999, 2000 Ingo Molnar</span>

<span class="cm">     completely rewritten, based on the MD driver code from Marc Zyngier</span>

<span class="cm">   Changes:</span>

<span class="cm">   - RAID-1/RAID-5 extensions by Miguel de Icaza, Gadi Oxman, Ingo Molnar</span>
<span class="cm">   - RAID-6 extensions by H. Peter Anvin &lt;hpa@zytor.com&gt;</span>
<span class="cm">   - boot support for linear and striped mode by Harald Hoyer &lt;HarryH@Royal.Net&gt;</span>
<span class="cm">   - kerneld support by Boris Tobotras &lt;boris@xtalk.msk.su&gt;</span>
<span class="cm">   - kmod support by: Cyrus Durgin</span>
<span class="cm">   - RAID0 bugfixes: Mark Anthony Lisher &lt;markal@iname.com&gt;</span>
<span class="cm">   - Devfs support by Richard Gooch &lt;rgooch@atnf.csiro.au&gt;</span>

<span class="cm">   - lots of fixes and improvements to the RAID1/RAID5 and generic</span>
<span class="cm">     RAID code (such as request based resynchronization):</span>

<span class="cm">     Neil Brown &lt;neilb@cse.unsw.edu.au&gt;.</span>

<span class="cm">   - persistent bitmap code</span>
<span class="cm">     Copyright (C) 2003-2004, Paul Clements, SteelEye Technology, Inc.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm">   any later version.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   (for example /usr/src/linux/COPYING); if not, write to the Free</span>
<span class="cm">   Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/raid/md_p.h&gt;</span>
<span class="cp">#include &lt;linux/raid/md_u.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">autostart_arrays</span><span class="p">(</span><span class="kt">int</span> <span class="n">part</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* pers_list is a list of registered personalities protected</span>
<span class="cm"> * by pers_lock.</span>
<span class="cm"> * pers_lock does extra service to protect accesses to</span>
<span class="cm"> * mddev-&gt;thread when the mutex cannot be held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pers_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pers_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">md_print_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">resync_wait</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">md_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">md_misc_wq</span><span class="p">;</span>

<span class="cp">#define MD_BUG(x...) { printk(&quot;md: bug in file %s, line %d\n&quot;, __FILE__, __LINE__); md_print_devices(); }</span>

<span class="cm">/*</span>
<span class="cm"> * Default number of read corrections we&#39;ll attempt on an rdev</span>
<span class="cm"> * before ejecting it from the array. We divide the read error</span>
<span class="cm"> * count by 2 for every hour elapsed between read errors.</span>
<span class="cm"> */</span>
<span class="cp">#define MD_DEFAULT_MAX_CORRECTED_READ_ERRORS 20</span>
<span class="cm">/*</span>
<span class="cm"> * Current RAID-1,4,5 parallel reconstruction &#39;guaranteed speed limit&#39;</span>
<span class="cm"> * is 1000 KB/sec, so the extra system load does not show up that much.</span>
<span class="cm"> * Increase it if you want to have more _guaranteed_ speed. Note that</span>
<span class="cm"> * the RAID driver will use the maximum available bandwidth if the IO</span>
<span class="cm"> * subsystem is idle. There is also an &#39;absolute maximum&#39; reconstruction</span>
<span class="cm"> * speed limit - in case reconstruction slows down your system despite</span>
<span class="cm"> * idle IO detection.</span>
<span class="cm"> *</span>
<span class="cm"> * you can change it via /proc/sys/dev/raid/speed_limit_min and _max.</span>
<span class="cm"> * or /sys/block/mdX/md/sync_speed_{min,max}</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sysctl_speed_limit_min</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sysctl_speed_limit_max</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">speed_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">?</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">:</span> <span class="n">sysctl_speed_limit_min</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">speed_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">?</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">:</span> <span class="n">sysctl_speed_limit_max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">raid_table_header</span><span class="p">;</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">raid_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;speed_limit_min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sysctl_speed_limit_min</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;speed_limit_max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sysctl_speed_limit_max</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">raid_dir_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;raid&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IXUGO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">raid_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">raid_root_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">raid_dir_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>  <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">md_fops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">start_readonly</span><span class="p">;</span>

<span class="cm">/* bio_clone_mddev</span>
<span class="cm"> * like bio_clone, but with a local bio set</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mddev_bio_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="o">**</span><span class="n">mddevp</span><span class="p">;</span>

	<span class="n">mddevp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">mddev</span> <span class="o">=</span> <span class="n">mddevp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">bio_free</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bio_alloc_mddev</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_iovecs</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">**</span><span class="n">mddevp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bio_alloc</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="n">nr_iovecs</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">bio_alloc_bioset</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="n">nr_iovecs</span><span class="p">,</span>
			     <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddevp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
	<span class="n">mddevp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">mddev_bio_destructor</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bio_alloc_mddev</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">bio_clone_mddev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">**</span><span class="n">mddevp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bio_clone</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">bio_alloc_bioset</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span><span class="p">,</span>
			     <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddevp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
	<span class="n">mddevp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">mddev_bio_destructor</span><span class="p">;</span>
	<span class="n">__bio_clone</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_integrity</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">bio_integrity_clone</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">bio_clone_mddev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">md_trim_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* &#39;bio&#39; is a cloned bio which we need to trim to match</span>
<span class="cm">	 * the given offset and size.</span>
<span class="cm">	 * This requires adjusting bi_sector, bi_size, and bi_io_vec</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sofar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_SEG_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">&lt;</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&amp;&amp;</span>
	       <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">].</span><span class="n">bv_len</span> <span class="o">&lt;=</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove this whole bio_vec */</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">].</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">&lt;</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">].</span><span class="n">bv_len</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* avoid any complications with bi_idx being non-zero*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="o">+</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio_vec</span><span class="p">));</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">-=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Make sure vcnt and last bv are not too big */</span>
	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sofar</span> <span class="o">+</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sofar</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sofar</span> <span class="o">+=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_trim_bio</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We have a system wide &#39;event count&#39; that is incremented</span>
<span class="cm"> * on any &#39;interesting&#39; event, and readers of /proc/mdstat</span>
<span class="cm"> * can use &#39;poll&#39; or &#39;select&#39; to find out when the event</span>
<span class="cm"> * count increases.</span>
<span class="cm"> *</span>
<span class="cm"> * Events are:</span>
<span class="cm"> *  start array, stop array, error, add device, remove device,</span>
<span class="cm"> *  start build, activate spare</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">md_event_waiters</span><span class="p">);</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">md_event_count</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">md_new_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_count</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_waiters</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_new_event</span><span class="p">);</span>

<span class="cm">/* Alternate version that can be called from interrupts</span>
<span class="cm"> * when calling sysfs_notify isn&#39;t needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_new_event_inintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_count</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_waiters</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enables to iterate over all existing md arrays</span>
<span class="cm"> * all_mddevs_lock protects this list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">all_mddevs</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">all_mddevs_lock</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * iterates through all used mddevs in the system.</span>
<span class="cm"> * We take care to grab the all_mddevs_lock whenever navigating</span>
<span class="cm"> * the list, and to always hold a refcount when unlocked.</span>
<span class="cm"> * Any code which breaks out of this loop while own</span>
<span class="cm"> * a reference to the current mddev and must mddev_put it.</span>
<span class="cm"> */</span>
<span class="cp">#define for_each_mddev(_mddev,_tmp)					\</span>
<span class="cp">									\</span>
<span class="cp">	for (({ spin_lock(&amp;all_mddevs_lock); 				\</span>
<span class="cp">		_tmp = all_mddevs.next;					\</span>
<span class="cp">		_mddev = NULL;});					\</span>
<span class="cp">	     ({ if (_tmp != &amp;all_mddevs)				\</span>
<span class="cp">			mddev_get(list_entry(_tmp, struct mddev, all_mddevs));\</span>
<span class="cp">		spin_unlock(&amp;all_mddevs_lock);				\</span>
<span class="cp">		if (_mddev) mddev_put(_mddev);				\</span>
<span class="cp">		_mddev = list_entry(_tmp, struct mddev, all_mddevs);	\</span>
<span class="cp">		_tmp != &amp;all_mddevs;});					\</span>
<span class="cp">	     ({ spin_lock(&amp;all_mddevs_lock);				\</span>
<span class="cp">		_tmp = _tmp-&gt;next;})					\</span>
<span class="cp">		)</span>


<span class="cm">/* Rather than calling directly into the personality make_request function,</span>
<span class="cm"> * IO requests come here first so that we can check if the device is</span>
<span class="cm"> * being suspended pending a reconfiguration.</span>
<span class="cm"> * We hold a refcount over the call to -&gt;make_request.  By the time that</span>
<span class="cm"> * call has finished, the bio has been linked into some internal structure</span>
<span class="cm"> * and so is visible to -&gt;quiesce(), so we don&#39;t need the refcount any more.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_io_error</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smp_rmb</span><span class="p">();</span> <span class="cm">/* Ensure implications of  &#39;active&#39; are visible */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">__wait</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active_io</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * save the sectors now since our bio can</span>
<span class="cm">	 * go away inside make_request</span>
<span class="cm">	 */</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="n">bio_sectors</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">make_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">part_stat_lock</span><span class="p">();</span>
	<span class="n">part_stat_inc</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">ios</span><span class="p">[</span><span class="n">rw</span><span class="p">]);</span>
	<span class="n">part_stat_add</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="n">rw</span><span class="p">],</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="n">part_stat_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active_io</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mddev_suspend makes sure no new requests are submitted</span>
<span class="cm"> * to the device, and that any requests that have been submitted</span>
<span class="cm"> * are completely handled.</span>
<span class="cm"> * Once -&gt;stop is called and completes, the module will be completely</span>
<span class="cm"> * unused.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mddev_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active_io</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mddev_suspend</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">mddev_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span> <span class="cm">/* possibly kick off a reshape */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mddev_resume</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">mddev_congested</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mddev_congested</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Generic flush handling for md</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_end_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The pre-request flush has finished */</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">md_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">md_submit_flush_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">submit_flushes</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">flush_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_work</span><span class="p">,</span> <span class="n">md_submit_flush_data</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_pending</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Take two references, one is dropped</span>
<span class="cm">			 * when request finishes, one after</span>
<span class="cm">			 * we reclaim rcu_read_lock</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">bio_alloc_mddev</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">md_end_flush</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_pending</span><span class="p">);</span>
			<span class="n">submit_bio</span><span class="p">(</span><span class="n">WRITE_FLUSH</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_pending</span><span class="p">))</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">md_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_submit_flush_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">flush_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_bio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* an empty barrier - all done */</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_FLUSH</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">make_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_flush_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span>
			    <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_bio</span><span class="p">,</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">,</span> <span class="cm">/*nothing*/</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_work</span><span class="p">,</span> <span class="n">submit_flushes</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">md_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_flush_request</span><span class="p">);</span>

<span class="cm">/* Support for plugging.</span>
<span class="cm"> * This mirrors the plugging support in request_queue, but does not</span>
<span class="cm"> * require having a whole queue or request structures.</span>
<span class="cm"> * We allocate an md_plug_cb for each md device and each thread it gets</span>
<span class="cm"> * plugged on.  This links tot the private plug_handle structure in the</span>
<span class="cm"> * personality data where we keep a count of the number of outstanding</span>
<span class="cm"> * plugs so other code can see if a plug is active.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">md_plug_cb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_plug_cb</span> <span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">plugger_unplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_plug_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_plug_cb</span> <span class="o">*</span><span class="n">mdcb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_plug_cb</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">))</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mdcb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check that an unplug wakeup will come shortly.</span>
<span class="cm"> * If not, wakeup the md thread immediately</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mddev_check_plugged</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="o">*</span><span class="n">plug</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">plug</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_plug_cb</span> <span class="o">*</span><span class="n">mdcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plug</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mdcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">cb_list</span><span class="p">,</span> <span class="n">cb</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">callback</span> <span class="o">==</span> <span class="n">plugger_unplug</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">==</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Already on the list, move to top */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdcb</span> <span class="o">!=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">cb_list</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">md_plug_cb</span><span class="p">,</span>
						    <span class="n">cb</span><span class="p">.</span><span class="n">list</span><span class="p">))</span>
				<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">cb_list</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Not currently on the callback list */</span>
	<span class="n">mdcb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mdcb</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mdcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">plugger_unplug</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdcb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plug</span><span class="o">-&gt;</span><span class="n">cb_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mddev_check_plugged</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="nf">mddev_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mddev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mddev_delayed_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mddev_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_set</span> <span class="o">*</span><span class="n">bs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Array is not configured at all, and not held active,</span>
<span class="cm">		 * so destroy it */</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">);</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We did a probe so need to clean up.  Call</span>
<span class="cm">			 * queue_work inside the spinlock so that</span>
<span class="cm">			 * flush_workqueue() after mddev_find will</span>
<span class="cm">			 * succeed in waiting for the work to be done.</span>
<span class="cm">			 */</span>
			<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">del_work</span><span class="p">,</span> <span class="n">mddev_delayed_delete</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">del_work</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bs</span><span class="p">)</span>
		<span class="n">bioset_free</span><span class="p">(</span><span class="n">bs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mddev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">active_io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flush_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">LEVEL_NONE</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mddev_init</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="nf">mddev_find</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&amp;&amp;</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MD_MAJOR</span><span class="p">)</span>
		<span class="n">unit</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MdpMinorShift</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

 <span class="nl">retry:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">,</span> <span class="n">all_mddevs</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">unit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev_get</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">mddev</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="n">UNTIL_IOCTL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* find an unused unit number */</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">next_minor</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">next_minor</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">is_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">is_free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span> <span class="n">next_minor</span><span class="p">);</span>
			<span class="n">next_minor</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_minor</span> <span class="o">&gt;</span> <span class="n">MINORMASK</span><span class="p">)</span>
				<span class="n">next_minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_minor</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Oh dear, all in use. */</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
				
			<span class="n">is_free</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">,</span> <span class="n">all_mddevs</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">is_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">md_minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="n">UNTIL_STOP</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">==</span> <span class="n">MD_MAJOR</span><span class="p">)</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">md_minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">md_minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MdpMinorShift</span><span class="p">;</span>

	<span class="n">mddev_init</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mddev_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mddev_is_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mddev_trylock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">md_redundancy_group</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mddev_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* These cannot be removed under reconfig_mutex as</span>
<span class="cm">		 * an access to the files will try to take reconfig_mutex</span>
<span class="cm">		 * while holding the file unremovable, which leads to</span>
<span class="cm">		 * a deadlock.</span>
<span class="cm">		 * So hold set sysfs_active while the remove in happeing,</span>
<span class="cm">		 * and anything else which might set -&gt;to_remove or my</span>
<span class="cm">		 * otherwise change the sysfs namespace will fail with</span>
<span class="cm">		 * -EBUSY if sysfs_active is still set.</span>
<span class="cm">		 * We set sysfs_active under reconfig_mutex and elsewhere</span>
<span class="cm">		 * test it under the same mutex to ensure its correct value</span>
<span class="cm">		 * is seen.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">to_remove</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to_remove</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">)</span>
				<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">)</span>
					<span class="n">sysfs_put</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reconfig_mutex</span><span class="p">);</span>

	<span class="cm">/* As we&#39;ve dropped the mutex we need a spinlock to</span>
<span class="cm">	 * make sure the thread doesn&#39;t disappear</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="nf">find_rdev_nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">==</span> <span class="n">nr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="nf">find_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="nf">find_pers</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clevel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">pers</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pers_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">level</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pers</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">clevel</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pers</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the offset of the super block in 512byte sectors */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">sector_t</span> <span class="nf">calc_dev_sboffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">num_sectors</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">MD_NEW_SIZE_SECTORS</span><span class="p">(</span><span class="n">num_sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_disk_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span>
		<span class="n">MD_BUG</span><span class="p">();</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md: out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_rdev_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_rdev_clear</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">super_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: super_written gets error=%d, uptodate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">error</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">));</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">));</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_super_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		   <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* write first size bytes of page to sector of rdev</span>
<span class="cm">	 * Increment mddev-&gt;pending_writes before returning</span>
<span class="cm">	 * and decrement it on completion, waking up sb_wait</span>
<span class="cm">	 * if zero is reached.</span>
<span class="cm">	 * If an error occurred, call md_error</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc_mddev</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span> <span class="o">?</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span> <span class="o">:</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">super_written</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">);</span>
	<span class="n">submit_bio</span><span class="p">(</span><span class="n">WRITE_FLUSH_FUA</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_super_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wait for all superblock writes that were scheduled to complete */</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pending_writes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bi_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span><span class="o">*</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sync_page_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">metadata_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_alloc_mddev</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_SYNC</span><span class="p">;</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata_op</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span> <span class="o">:</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">metadata_op</span><span class="p">)</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">==</span>
		  <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">)))</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">bi_complete</span><span class="p">;</span>
	<span class="n">submit_bio</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sync_page_io</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_disk_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: disabled device %s, could not read superblock.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uuid_equal</span><span class="p">(</span><span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb1</span><span class="p">,</span> <span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> 	<span class="n">sb1</span><span class="o">-&gt;</span><span class="n">set_uuid0</span> <span class="o">==</span> <span class="n">sb2</span><span class="o">-&gt;</span><span class="n">set_uuid0</span> <span class="o">&amp;&amp;</span>
		<span class="n">sb1</span><span class="o">-&gt;</span><span class="n">set_uuid1</span> <span class="o">==</span> <span class="n">sb2</span><span class="o">-&gt;</span><span class="n">set_uuid1</span> <span class="o">&amp;&amp;</span>
		<span class="n">sb1</span><span class="o">-&gt;</span><span class="n">set_uuid2</span> <span class="o">==</span> <span class="n">sb2</span><span class="o">-&gt;</span><span class="n">set_uuid2</span> <span class="o">&amp;&amp;</span>
		<span class="n">sb1</span><span class="o">-&gt;</span><span class="n">set_uuid3</span> <span class="o">==</span> <span class="n">sb2</span><span class="o">-&gt;</span><span class="n">set_uuid3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb_equal</span><span class="p">(</span><span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb1</span><span class="p">,</span> <span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">tmp1</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp2</span><span class="p">;</span>

	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp1</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp2</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp1</span> <span class="o">||</span> <span class="o">!</span><span class="n">tmp2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md.c sb_equal(): failed to allocate memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">tmp1</span> <span class="o">=</span> <span class="o">*</span><span class="n">sb1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tmp2</span> <span class="o">=</span> <span class="o">*</span><span class="n">sb2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * nr_disks is not constant</span>
<span class="cm">	 */</span>
	<span class="n">tmp1</span><span class="o">-&gt;</span><span class="n">nr_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp2</span><span class="o">-&gt;</span><span class="n">nr_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">MD_SB_GENERIC_CONSTANT_WORDS</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">abort:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u32</span> <span class="nf">md_csum_fold</span><span class="p">(</span><span class="n">u32</span> <span class="n">csum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="p">(</span><span class="n">csum</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">csum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">csum</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">csum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_sb_csum</span><span class="p">(</span><span class="n">mdp_super_t</span> <span class="o">*</span> <span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">newcsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">sb32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disk_csum</span><span class="p">,</span> <span class="n">csum</span><span class="p">;</span>

	<span class="n">disk_csum</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MD_SB_BYTES</span><span class="o">/</span><span class="mi">4</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">newcsum</span> <span class="o">+=</span> <span class="n">sb32</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="p">(</span><span class="n">newcsum</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">newcsum</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_ALPHA</span>
	<span class="cm">/* This used to use csum_partial, which was wrong for several</span>
<span class="cm">	 * reasons including that different results are returned on</span>
<span class="cm">	 * different architectures.  It isn&#39;t critical that we get exactly</span>
<span class="cm">	 * the same return value as before (we always csum_fold before</span>
<span class="cm">	 * testing, and that removes any differences).  However as we</span>
<span class="cm">	 * know that csum_partial always returned a 16bit value on</span>
<span class="cm">	 * alphas, do a fold to maximise conformity to previous behaviour.</span>
<span class="cm">	 */</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">md_csum_fold</span><span class="p">(</span><span class="n">disk_csum</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">disk_csum</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Handle superblock details.</span>
<span class="cm"> * We want to be able to handle multiple superblock formats</span>
<span class="cm"> * so we have a common interface to them all, and an array of</span>
<span class="cm"> * different handlers.</span>
<span class="cm"> * We rely on user-space to write the initial superblock, and support</span>
<span class="cm"> * reading and updating of superblocks.</span>
<span class="cm"> * Interface methods are:</span>
<span class="cm"> *   int load_super(struct md_rdev *dev, struct md_rdev *refdev, int minor_version)</span>
<span class="cm"> *      loads and validates a superblock on dev.</span>
<span class="cm"> *      if refdev != NULL, compare superblocks on both devices</span>
<span class="cm"> *    Return:</span>
<span class="cm"> *      0 - dev has a superblock that is compatible with refdev</span>
<span class="cm"> *      1 - dev has a superblock that is compatible and newer than refdev</span>
<span class="cm"> *          so dev should be used as the refdev in future</span>
<span class="cm"> *     -EINVAL superblock incompatible or invalid</span>
<span class="cm"> *     -othererror e.g. -EIO</span>
<span class="cm"> *</span>
<span class="cm"> *   int validate_super(struct mddev *mddev, struct md_rdev *dev)</span>
<span class="cm"> *      Verify that dev is acceptable into mddev.</span>
<span class="cm"> *       The first time, mddev-&gt;raid_disks will be 0, and data from</span>
<span class="cm"> *       dev should be merged in.  Subsequent calls check that dev</span>
<span class="cm"> *       is new enough.  Return 0 or -EINVAL</span>
<span class="cm"> *</span>
<span class="cm"> *   void sync_super(struct mddev *mddev, struct md_rdev *dev)</span>
<span class="cm"> *     Update the superblock for rdev with data in mddev</span>
<span class="cm"> *     This does not write to disc.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">super_type</span>  <span class="p">{</span>
	<span class="kt">char</span>		    <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">module</span>	    <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
	<span class="kt">int</span>		    <span class="p">(</span><span class="o">*</span><span class="n">load_super</span><span class="p">)(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">refdev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">minor_version</span><span class="p">);</span>
	<span class="kt">int</span>		    <span class="p">(</span><span class="o">*</span><span class="n">validate_super</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">void</span>		    <span class="p">(</span><span class="o">*</span><span class="n">sync_super</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>  <span class="p">(</span><span class="o">*</span><span class="n">rdev_size_change</span><span class="p">)(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						<span class="n">sector_t</span> <span class="n">num_sectors</span><span class="p">);</span>
	<span class="kt">int</span>		    <span class="p">(</span><span class="o">*</span><span class="n">allow_new_offset</span><span class="p">)(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new_offset</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Check that the given mddev has no bitmap.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called from the run method of all personalities that do not</span>
<span class="cm"> * support bitmaps. It prints an error message and returns non-zero if mddev</span>
<span class="cm"> * has a bitmap. Otherwise, it returns 0.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">md_check_no_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bitmaps are not supported for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_check_no_bitmap</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * load_super for 0.90.0 </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_90_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">refdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minor_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the position of the superblock (512byte sectors),</span>
<span class="cm">	 * it&#39;s at the end of the disk.</span>
<span class="cm">	 *</span>
<span class="cm">	 * It also happens to be a multiple of 4Kb.</span>
<span class="cm">	 */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">calc_dev_sboffset</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_disk_sb</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">MD_SB_BYTES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">md_magic</span> <span class="o">!=</span> <span class="n">MD_SB_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: invalid raid superblock magic on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">b</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&lt;</span> <span class="mi">90</span> <span class="o">||</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;</span> <span class="mi">91</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Bad version number %d.%d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">,</span>
			<span class="n">b</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md_csum_fold</span><span class="p">(</span><span class="n">calc_sb_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="o">!=</span> <span class="n">md_csum_fold</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: invalid superblock checksum on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">b</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">preferred_minor</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">md_minor</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="n">MD_SB_BYTES</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">LEVEL_MULTIPATH</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">this_disk</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">refdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">;</span>
		<span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">refsb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uuid_equal</span><span class="p">(</span><span class="n">refsb</span><span class="p">,</span> <span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s has different UUID to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b2</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_equal</span><span class="p">(</span><span class="n">refsb</span><span class="p">,</span> <span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s has same UUID&quot;</span>
			       <span class="s">&quot; but different superblock to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">b</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b2</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ev1</span> <span class="o">=</span> <span class="n">md_event</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">ev2</span> <span class="o">=</span> <span class="n">md_event</span><span class="p">(</span><span class="n">refsb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&gt;</span> <span class="n">ev2</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> 
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
	<span class="cm">/* Limit to 4TB as metadata cannot record more than that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* &quot;this cannot possibly happen&quot; ... */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

 <span class="nl">abort:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * validate_super for 0.90.0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_90_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdp_disk_t</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">__u64</span> <span class="n">ev1</span> <span class="o">=</span> <span class="n">md_event</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">patch_version</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">patch_version</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunk_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">ev1</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* bitmap can use 60 K after the 4K superblocks */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">=</span> <span class="n">MD_SB_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_space</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">MD_SB_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;=</span> <span class="mi">91</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_chunk</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_CLEAN</span><span class="p">))</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_hi</span> <span class="o">==</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">cp_events_hi</span> <span class="o">&amp;&amp;</span> 
				<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_lo</span> <span class="o">==</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">cp_events_lo</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">=</span> <span class="n">MD_SB_DISKS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Insist on good event counter while assembling, except</span>
<span class="cm">		 * for spares (which don&#39;t need an event count) */</span>
		<span class="o">++</span><span class="n">ev1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">].</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span>
			    <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MD_DISK_ACTIVE</span><span class="p">)))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if adding to array with a bitmap, then we can accept an</span>
<span class="cm">		 * older device ... but not too old.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
			<span class="cm">/* just a hot-add of a new device, leave raid_disk at -1 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_MULTIPATH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_FAULTY</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">)</span> <span class="cm">/* &amp;&amp;</span>
<span class="cm">			    desc-&gt;raid_disk &lt; mddev-&gt;raid_disks */</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* active but not in sync implies recovery up to</span>
<span class="cm">			 * reshape position.  We don&#39;t know exactly where</span>
<span class="cm">			 * that is, so set to zero for now */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;=</span> <span class="mi">91</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_WRITEMOSTLY</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* MULTIPATH are always insync */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sync_super for 0.90.0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">super_90_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next_spare</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>


	<span class="cm">/* make rdev-&gt;sb match mddev data..</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1/ zero out disks</span>
<span class="cm">	 * 2/ Add info for each disk, keeping track of highest desc_nr (next_spare);</span>
<span class="cm">	 * 3/ any empty disks &lt; next_spare become removed</span>
<span class="cm">	 *</span>
<span class="cm">	 * disks[0] gets initialised to REMOVED because</span>
<span class="cm">	 * we cannot be sure from other fields if it has</span>
<span class="cm">	 * been initialised or not.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">working</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">spare</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nr_disks</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="n">MD_SB_BYTES</span><span class="p">;</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sb</span><span class="p">));</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">md_magic</span> <span class="o">=</span> <span class="n">MD_SB_MAGIC</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">patch_version</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">patch_version</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">gvalid_words</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ignored */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid0</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid1</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid2</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid3</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">ctime</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">md_minor</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">md_minor</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">not_persistent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">cp_events_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">cp_events_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span> <span class="n">MD_SB_CLEAN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_REMOVED</span><span class="p">);</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdp_disk_t</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">desc_nr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">is_active</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;=</span> <span class="mi">91</span><span class="p">)</span>
			<span class="cm">/* we have nowhere to store the recovery_offset,</span>
<span class="cm">			 * but if it is not below the reshape_position,</span>
<span class="cm">			 * we can piggy-back on that.</span>
<span class="cm">			 */</span>
			<span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span>
			<span class="n">desc_nr</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">desc_nr</span> <span class="o">=</span> <span class="n">next_spare</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">desc_nr</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">];</span>
		<span class="n">nr_disks</span><span class="o">++</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">;</span> <span class="cm">/* compatibility */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_FAULTY</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_ACTIVE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">);</span>
			<span class="n">active</span><span class="o">++</span><span class="p">;</span>
			<span class="n">working</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spare</span><span class="o">++</span><span class="p">;</span>
			<span class="n">working</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_WRITEMOSTLY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* now set the &quot;removed&quot; and &quot;faulty&quot; bits on any missing devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdp_disk_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_REMOVED</span><span class="p">);</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_FAULTY</span><span class="p">);</span>
			<span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">nr_disks</span> <span class="o">=</span> <span class="n">nr_disks</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">active_disks</span> <span class="o">=</span> <span class="n">active</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">working_disks</span> <span class="o">=</span> <span class="n">working</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">failed_disks</span> <span class="o">=</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">spare_disks</span> <span class="o">=</span> <span class="n">spare</span><span class="p">;</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">this_disk</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">];</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">calc_sb_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rdev_size_change for 0.90.0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">super_90_rdev_size_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">num_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">&amp;&amp;</span> <span class="n">num_sectors</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* component must fit device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* can&#39;t move bitmap */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">calc_dev_sboffset</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_sectors</span> <span class="o">||</span> <span class="n">num_sectors</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">)</span>
		<span class="n">num_sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
	<span class="cm">/* Limit to 4TB as metadata cannot record more than that.</span>
<span class="cm">	 * 4TB == 2^32 KB, or 2*2^32 sectors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">md_super_write</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="p">,</span>
		       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">md_super_wait</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">super_90_allow_new_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* non-zero offset changes not possible with v0.90 */</span>
	<span class="k">return</span> <span class="n">new_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * version 1 superblock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__le32</span> <span class="nf">calc_sb_1_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span> <span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">disk_csum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">newcsum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">isuper</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span><span class="o">*</span><span class="p">)</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">disk_csum</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newcsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">;</span> <span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span> <span class="p">)</span>
		<span class="n">newcsum</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">isuper</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">newcsum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span> <span class="n">isuper</span><span class="p">);</span>

	<span class="n">csum</span> <span class="o">=</span> <span class="p">(</span><span class="n">newcsum</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">newcsum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">disk_csum</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">md_set_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">acknowledged</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_1_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">refdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minor_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sb_start</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bmask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate the position of the superblock in 512byte sectors.</span>
<span class="cm">	 * It is always aligned to a 4K boundary and</span>
<span class="cm">	 * depeding on minor_version, it can be:</span>
<span class="cm">	 * 0: At least 8K, but less than 12K, from end of device</span>
<span class="cm">	 * 1: At start of device</span>
<span class="cm">	 * 2: 4K from start of device.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sb_start</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">sb_start</span> <span class="o">-=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">sb_start</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="mi">4</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sb_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">sb_start</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">sb_start</span><span class="p">;</span>

	<span class="cm">/* superblock is rarely larger than 1K, but it can be larger,</span>
<span class="cm">	 * and it is safe to read 4k, so we do that</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_disk_sb</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_SB_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">4096</span><span class="o">-</span><span class="mi">256</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">||</span>
	    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">super_offset</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MD_FEATURE_ALL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">calc_sb_1_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: invalid superblock checksum on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: data_size too small on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad0</span> <span class="o">||</span>
	    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
		<span class="cm">/* Some padding is non-zero, might be a new feature */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">preferred_minor</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_RESHAPE_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_NEW_OFFSET</span><span class="p">))</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_offset</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">cnt_corrected_read</span><span class="p">));</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">bmask</span> <span class="o">=</span> <span class="n">queue_logical_block_size</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">&amp;</span> <span class="n">bmask</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">|</span> <span class="n">bmask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor_version</span>
	    <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="n">sb_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="o">/</span><span class="mi">512</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor_version</span>
	    <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">&lt;</span> <span class="n">sb_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="o">/</span><span class="mi">512</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LEVEL_MULTIPATH</span><span class="p">))</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_BAD_BLOCKS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to load the bad block list.</span>
<span class="cm">		 * Currently we limit it to one page.</span>
<span class="cm">		 */</span>
		<span class="n">s32</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">bb_sector</span><span class="p">;</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">bbp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="mi">512</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">bb_sector</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sync_page_io</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">bb_sector</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">bbp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_shift</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bbp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">bbp</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x3ff</span><span class="p">);</span>
			<span class="n">u64</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">sector</span> <span class="o">&lt;&lt;=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_shift</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">&lt;&lt;=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_shift</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bb</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">md_set_badblocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span>
					     <span class="n">sector</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">refdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">ev1</span><span class="p">,</span> <span class="n">ev2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">refsb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid</span><span class="p">,</span> <span class="n">refsb</span><span class="o">-&gt;</span><span class="n">set_uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">refsb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">||</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">refsb</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">||</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span> <span class="o">!=</span> <span class="n">refsb</span><span class="o">-&gt;</span><span class="n">chunksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s has strangely different&quot;</span>
				<span class="s">&quot; superblock to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">refdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b2</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ev1</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">ev2</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">refsb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&gt;</span> <span class="n">ev2</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">sectors</span> <span class="o">-=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">super_1_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">__u64</span> <span class="n">ev1</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">patch_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">ev1</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Default location for bitmap is 1K after superblock</span>
<span class="cm">		 * using 3K - total of 4K</span>
<span class="cm">		 */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_space</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4096</span><span class="o">-</span><span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">resync_offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">4096</span><span class="o">-</span><span class="mi">256</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_BITMAP_OFFSET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__s32</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bitmap_offset</span><span class="p">);</span>
			<span class="cm">/* Metadata doesn&#39;t record how much space is available.</span>
<span class="cm">			 * For 1.0, we assume we can use up to the superblock</span>
<span class="cm">			 * if before, else to 4K beyond superblock.</span>
<span class="cm">			 * For others, assume no change is possible.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span>
					<span class="mi">8</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span>
					<span class="o">-</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_RESHAPE_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_chunk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span>
			      <span class="o">&amp;</span> <span class="n">MD_FEATURE_RESHAPE_BACKWARDS</span><span class="p">)))</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Insist of good event counter while assembling, except for</span>
<span class="cm">		 * spares (which don&#39;t need an event count) */</span>
		<span class="o">++</span><span class="n">ev1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mh">0xfffe</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If adding to array with a bitmap, then we can accept an</span>
<span class="cm">		 * older device, but not too old.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">events_cleared</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev1</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
			<span class="cm">/* just a hot-add of a new device, leave raid_disk at -1 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_MULTIPATH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">role</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&gt;=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">role</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">]);</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xffff</span>: <span class="cm">/* spare */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xfffe</span>: <span class="cm">/* faulty */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">MD_FEATURE_RECOVERY_OFFSET</span><span class="p">))</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">devflags</span> <span class="o">&amp;</span> <span class="n">WriteMostly1</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_FEATURE_REPLACEMENT</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* MULTIPATH are always insync */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">super_1_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* make rdev-&gt;sb match mddev and rdev data. */</span>

	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">pad3</span><span class="p">));</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">resync_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">resync_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">cnt_corrected_read</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">));</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">devflags</span> <span class="o">|=</span> <span class="n">WriteMostly1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">devflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WriteMostly1</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">bitmap_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">__u32</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_BITMAP_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_RECOVERY_OFFSET</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span>
			<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_REPLACEMENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_RESHAPE_ACTIVE</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">);</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_chunk</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span>
				<span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_RESHAPE_BACKWARDS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span>
				<span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_NEW_OFFSET</span><span class="p">);</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">new_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">__u32</span><span class="p">)(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span>
							     <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Nothing to do for bad blocks*/</span> <span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Cannot record bad blocks on this device */</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">;</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">bbp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">);</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MD_FEATURE_BAD_BLOCKS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">seq</span><span class="p">;</span>

<span class="nl">retry:</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">bbp</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u64</span> <span class="n">internal_bb</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">u64</span> <span class="n">store_bb</span> <span class="o">=</span> <span class="p">((</span><span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">internal_bb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span>
						<span class="o">|</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">internal_bb</span><span class="p">));</span>
				<span class="o">*</span><span class="n">bbp</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">store_bb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span>
				      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_offset</span><span class="p">));</span>
			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">bblog_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">max_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">max_dev</span><span class="p">)</span>
			<span class="n">max_dev</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_dev</span> <span class="o">&gt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bmask</span><span class="p">;</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_dev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="n">max_dev</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">bmask</span> <span class="o">=</span> <span class="n">queue_logical_block_size</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">&amp;</span> <span class="n">bmask</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span> <span class="o">|</span> <span class="n">bmask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">max_dev</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">max_dev</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xfffe</span><span class="p">);</span>
	
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xfffe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_roles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">calc_sb_1_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">super_1_rdev_size_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">num_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">&amp;&amp;</span> <span class="n">num_sectors</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* component must fit device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* too confusing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* minor versions 1 and 2; superblock before data */</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">max_sectors</span> <span class="o">-=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_sectors</span> <span class="o">||</span> <span class="n">num_sectors</span> <span class="o">&gt;</span> <span class="n">max_sectors</span><span class="p">)</span>
			<span class="n">num_sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* minor version 0 with bitmap we can&#39;t move */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* minor version 0; superblock after data */</span>
		<span class="n">sector_t</span> <span class="n">sb_start</span><span class="p">;</span>
		<span class="n">sb_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">sb_start</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="mi">4</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">+</span> <span class="n">sb_start</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_sectors</span> <span class="o">||</span> <span class="n">num_sectors</span> <span class="o">&gt;</span> <span class="n">max_sectors</span><span class="p">)</span>
			<span class="n">num_sectors</span> <span class="o">=</span> <span class="n">max_sectors</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">sb_start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">num_sectors</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">super_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span> <span class="o">=</span> <span class="n">calc_sb_1_csum</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">md_super_write</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="p">,</span>
		       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
	<span class="n">md_super_wait</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_sectors</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">super_1_allow_new_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* All necessary checks on new &gt;= old have been done */</span>
	<span class="k">struct</span> <span class="n">bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* with 1.0 metadata, there is no metadata to tread on</span>
<span class="cm">	 * so we can always move back */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* otherwise we must be sure not to step on</span>
<span class="cm">	 * any metadata, so stay:</span>
<span class="cm">	 * 36K beyond start of superblock</span>
<span class="cm">	 * beyond end of badblocks</span>
<span class="cm">	 * beyond write-intent bitmap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">new_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span>
	    <span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file_pages</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">new_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">new_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">super_type</span> <span class="n">super_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;0.90.0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">load_super</span>	    <span class="o">=</span> <span class="n">super_90_load</span><span class="p">,</span>
		<span class="p">.</span><span class="n">validate_super</span>	    <span class="o">=</span> <span class="n">super_90_validate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync_super</span>	    <span class="o">=</span> <span class="n">super_90_sync</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rdev_size_change</span>   <span class="o">=</span> <span class="n">super_90_rdev_size_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allow_new_offset</span>   <span class="o">=</span> <span class="n">super_90_allow_new_offset</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;md-1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">load_super</span>	    <span class="o">=</span> <span class="n">super_1_load</span><span class="p">,</span>
		<span class="p">.</span><span class="n">validate_super</span>	    <span class="o">=</span> <span class="n">super_1_validate</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync_super</span>	    <span class="o">=</span> <span class="n">super_1_sync</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rdev_size_change</span>   <span class="o">=</span> <span class="n">super_1_rdev_size_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allow_new_offset</span>   <span class="o">=</span> <span class="n">super_1_allow_new_offset</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_super</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">super_types</span><span class="p">));</span>

	<span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span><span class="n">sync_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_mddev_units</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev1</span><span class="p">)</span>
		<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev2</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span> <span class="o">==</span>
			    <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pending_raid_disks</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Try to register data integrity profile for an mddev</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when an array is started and after a disk has been kicked</span>
<span class="cm"> * from the array. It only succeeds if all working and active component devices</span>
<span class="cm"> * are integrity capable with matching profiles.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">md_integrity_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">reference</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span> <span class="o">||</span> <span class="n">blk_get_integrity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* shouldn&#39;t register, or already is */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip spares and non-functional disks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reference</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Use the first rdev as the reference */</span>
			<span class="n">reference</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* does this rdev&#39;s profile match the reference profile? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_integrity_compare</span><span class="p">(</span><span class="n">reference</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reference</span> <span class="o">||</span> <span class="o">!</span><span class="n">bdev_get_integrity</span><span class="p">(</span><span class="n">reference</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * All component devices are integrity capable and have matching</span>
<span class="cm">	 * profiles, register the common profile for the md device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_integrity_register</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span>
			<span class="n">bdev_get_integrity</span><span class="p">(</span><span class="n">reference</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: failed to register integrity for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md: data integrity enabled on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bioset_integrity_create</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span><span class="p">,</span> <span class="n">BIO_POOL_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: failed to create integrity pool for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_integrity_register</span><span class="p">);</span>

<span class="cm">/* Disable data integrity if non-capable/non-matching disk is being added */</span>
<span class="kt">void</span> <span class="nf">md_integrity_add_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_integrity</span> <span class="o">*</span><span class="n">bi_rdev</span> <span class="o">=</span> <span class="n">bdev_get_integrity</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">blk_integrity</span> <span class="o">*</span><span class="n">bi_mddev</span> <span class="o">=</span> <span class="n">blk_get_integrity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bi_mddev</span><span class="p">)</span> <span class="cm">/* nothing to do */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* skip spares */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bi_rdev</span> <span class="o">&amp;&amp;</span> <span class="n">blk_integrity_compare</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span>
					     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;disabling data integrity on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">blk_integrity_unregister</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_integrity_add_rdev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bind_rdev_to_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">ko</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prevent duplicates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="cm">/* make sure rdev-&gt;sectors exceeds mddev-&gt;dev_sectors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot change size, so fail</span>
<span class="cm">			 * If mddev-&gt;level &lt;= 0, then we don&#39;t care</span>
<span class="cm">			 * about aligning sizes (e.g. linear)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify rdev-&gt;desc_nr is unique.</span>
<span class="cm">	 * If it is -1, assign a free number, else</span>
<span class="cm">	 * check number is not in use</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">choice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="n">choice</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">find_rdev_nr</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">choice</span><span class="p">))</span>
			<span class="n">choice</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">choice</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_rdev_nr</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s: array is limited to %d devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">strchr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="sc">&#39;!&#39;</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: bind&lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">kobject_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;dev-%s&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ko</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part_to_dev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">ko</span><span class="p">,</span> <span class="s">&quot;block&quot;</span><span class="p">))</span>
		<span class="cm">/* failure here is OK */</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span> <span class="o">=</span> <span class="n">sysfs_get_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">);</span>

	<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">);</span>
	<span class="n">bd_link_disk_holder</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>

	<span class="cm">/* May as well allow recovery to be retried once */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: failed to register dev-%s for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">b</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_delayed_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">del_work</span><span class="p">);</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unbind_rdev_from_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bd_unlink_disk_holder</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: unbind&lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;block&quot;</span><span class="p">);</span>
	<span class="n">sysfs_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* We need to delay this, otherwise we can deadlock when</span>
<span class="cm">	 * writing to &#39;remove&#39; to &quot;dev/state&quot;.  We also need</span>
<span class="cm">	 * to delay it due to rcu usage.</span>
<span class="cm">	 */</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">del_work</span><span class="p">,</span> <span class="n">md_delayed_delete</span><span class="p">);</span>
	<span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">del_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prevent the device from being mounted, repartitioned or</span>
<span class="cm"> * otherwise reused by a RAID array (or any other kernel</span>
<span class="cm"> * subsystem), by bd_claiming the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shared</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">blkdev_get_by_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">,</span>
				 <span class="n">shared</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="p">)</span><span class="n">lock_rdev</span> <span class="o">:</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: could not open %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__bdevname</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="o">|</span><span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">md_autodetect_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">export_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: export_rdev(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
	<span class="n">md_rdev_clear</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="cp">#ifndef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AutoDetected</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">md_autodetect_dev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kick_rdev_from_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unbind_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">export_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">rdev_for_each_safe</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MD_BUG</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_desc</span><span class="p">(</span><span class="n">mdp_disk_t</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; DISK&lt;N:%d,(%d,%d),R:%d,S:%d&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_sb_90</span><span class="p">(</span><span class="n">mdp_super_t</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
		<span class="s">&quot;md:  SB: (V:%d.%d.%d) ID:&lt;%08x.%08x.%08x.%08x&gt; CT:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">patch_version</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid0</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid1</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid2</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid3</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md:     L%d S%08d ND:%d RD:%d md%d LO:%d CS:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">nr_disks</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">md_minor</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunk_size</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md:     UT:%08x ST:%d AD:%d WD:%d&quot;</span>
		<span class="s">&quot; FD:%d SD:%d CSUM:%08x E:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">active_disks</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">working_disks</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">failed_disks</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">spare_disks</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events_lo</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MD_SB_DISKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdp_disk_t</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">||</span>
		    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">||</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;     D %2d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">print_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md:     THIS: &quot;</span><span class="p">);</span>
	<span class="n">print_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">this_disk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_sb_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">mdp_superblock_1</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">uuid</span><span class="p">;</span>

	<span class="n">uuid</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_uuid</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;md:  SB: (V:%u) (F:0x%08x) Array-ID:&lt;%pU&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md:    Name: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> CT:%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">feature_map</span><span class="p">),</span>
		<span class="n">uuid</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">set_name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">)</span>
		       <span class="o">&amp;</span> <span class="n">MD_SUPERBLOCK_1_TIME_SEC_MASK</span><span class="p">);</span>

	<span class="n">uuid</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">device_uuid</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;md:       L%u SZ%llu RD:%u LO:%u CS:%u DO:%llu DS:%llu SO:%llu&quot;</span>
			<span class="s">&quot; RO:%llu</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md:     Dev:%08x UUID: %pU</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md:       (F:0x%08x) UT:%llu Events:%llu ResyncOffset:%llu CSUM:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md:         (MaxDev:%u) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">chunksize</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">super_offset</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">dev_number</span><span class="p">),</span>
		<span class="n">uuid</span><span class="p">,</span>
		<span class="n">sb</span><span class="o">-&gt;</span><span class="n">devflags</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_SUPERBLOCK_1_TIME_SEC_MASK</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">resync_offset</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">sb_csum</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">max_dev</span><span class="p">)</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">major_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: rdev %s, Sect:%08llu F:%d S:%d DN:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
	        <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
	        <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: rdev superblock (MJ:%d):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">major_version</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">major_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">print_sb_90</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">print_sb_1</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: no rdev superblock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_print_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md:	**********************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md:	* &lt;COMPLETE RAID STATE PRINTOUT&gt; *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md:	**********************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">for_each_mddev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
			<span class="n">bitmap_print_sb</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;%s&gt;&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="n">print_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md:	**********************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_sbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nospares</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Update each superblock (in-memory image), but</span>
<span class="cm">	 * if we are allowed to, skip spares which already</span>
<span class="cm">	 * have the right event counter, or have one earlier</span>
<span class="cm">	 * (which would mean they aren&#39;t being marked as dirty</span>
<span class="cm">	 * with the rest of the array)</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_events</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">nospares</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_events</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t update this superblock */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sync_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_update_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nospares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">any_badblocks_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">repeat:</span>
	<span class="cm">/* First make sure individual recovery_offsets are correct */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">)</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">;</span>

	<span class="p">}</span>	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">md_ack_all_badblocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">);</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">force_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* just a clean&lt;-&gt; dirty transition, possibly leave spares alone,</span>
<span class="cm">		 * though if events isn&#39;t the right even/odd, we will have to do</span>
<span class="cm">		 * spares after all</span>
<span class="cm">		 */</span>
		<span class="n">nospares</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">force_change</span><span class="p">)</span>
		<span class="n">nospares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span>
		<span class="cm">/* If the array is degraded, then skipping spares is both</span>
<span class="cm">		 * dangerous and fairly pointless.</span>
<span class="cm">		 * Dangerous because a device that was removed from the array</span>
<span class="cm">		 * might have a event_count that still looks up-to-date,</span>
<span class="cm">		 * so it can be re-added without a resync.</span>
<span class="cm">		 * Pointless because if there are any spares to skip,</span>
<span class="cm">		 * then a recovery will happen and soon that array won&#39;t</span>
<span class="cm">		 * be degraded any more and the spare can go back to sleep then.</span>
<span class="cm">		 */</span>
		<span class="n">nospares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sync_req</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">;</span>

	<span class="cm">/* If this is just a dirty&lt;-&gt;clean transition, and the array is clean</span>
<span class="cm">	 * and &#39;events&#39; is odd, we can roll back to the previous clean state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nospares</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">can_decrease_events</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">can_decrease_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* otherwise we have to go forward and ... */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">can_decrease_events</span> <span class="o">=</span> <span class="n">nospares</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * oops, this 64-bit counter should never wrap.</span>
<span class="cm">		 * Either we are in around ~1 trillion A.C., assuming</span>
<span class="cm">		 * 1 reboot per second, or we have a bug:</span>
<span class="cm">		 */</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">changed</span><span class="p">)</span>
			<span class="n">any_badblocks_changed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FaultRecorded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sync_sbs</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">nospares</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md: updating %s RAID superblock on device (in sync %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">);</span>

	<span class="n">bitmap_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* no noise on spare devices */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">md_super_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span><span class="n">rdev</span><span class="p">,</span>
				       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="p">,</span>
				       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_page</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md: (write) %s&#39;s sb offset: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_events</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">md_super_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">,</span>
					       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">sector</span><span class="p">,</span>
					       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
					       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span><span class="p">);</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md: %s (skipping faulty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;(skipping incremental s/r &quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">LEVEL_MULTIPATH</span><span class="p">)</span>
			<span class="cm">/* only need to write one superblock... */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">md_super_wait</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="cm">/* if there was a failure, MD_CHANGE_DEVS was set, and we re-write super */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">!=</span> <span class="n">sync_req</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* have to write it out again */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FaultRecorded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">any_badblocks_changed</span><span class="p">)</span>
			<span class="n">md_ack_all_badblocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* words written to sysfs files may, or may not, be \n terminated.</span>
<span class="cm"> * We want to accept with case. For this we use cmd_match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmd_match</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See if cmd, written into a sysfs file, matches</span>
<span class="cm">	 * str.  They must either be the same, or cmd can</span>
<span class="cm">	 * have a trailing newline</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">==</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">str</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">||</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">unacked_exist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span><span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sfaulty&quot;</span><span class="p">,</span><span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sin_sync&quot;</span><span class="p">,</span><span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%swrite_mostly&quot;</span><span class="p">,</span><span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">unacked_exist</span>
	     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sblocked&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sspare&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%swrite_error&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%swant_replacement&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sreplacement&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="o">+</span><span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">state_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* can write</span>
<span class="cm">	 *  faulty  - simulates an error</span>
<span class="cm">	 *  remove  - disconnects the device</span>
<span class="cm">	 *  writemostly - sets write_mostly</span>
<span class="cm">	 *  -writemostly - clears write_mostly</span>
<span class="cm">	 *  blocked - sets the Blocked flags</span>
<span class="cm">	 *  -blocked - clears the Blocked and possibly simulates an error</span>
<span class="cm">	 *  insync - sets Insync providing device isn&#39;t active</span>
<span class="cm">	 *  write_error - sets WriteErrorSeen</span>
<span class="cm">	 *  -write_error - clears WriteErrorSeen</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;faulty&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;remove&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
			<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
				<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;writemostly&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-writemostly&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;blocked&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-blocked&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">unacked_exist</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* metadata handler doesn&#39;t understand badblocks,</span>
<span class="cm">			 * so we need to fail the device</span>
<span class="cm">			 */</span>
			<span class="n">md_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;insync&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;write_error&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-write_error&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;want_replacement&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Any non-spare device that is not a replacement can</span>
<span class="cm">		 * become want_replacement at any time, but we then need to</span>
<span class="cm">		 * check if recovery is needed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-want_replacement&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clearing &#39;want_replacement&#39; is always allowed.</span>
<span class="cm">		 * Once replacements starts it is too late though.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;replacement&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Can only set a device as a replacement when array has not</span>
<span class="cm">		 * yet been started.  Once running, replacement is automatic</span>
<span class="cm">		 * from spares, or by assigning &#39;slot&#39;.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;-replacement&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Similarly, can only clear Replacement before start */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_state</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">state_show</span><span class="p">,</span> <span class="n">state_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">errors_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">errors_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_errors</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">errors_show</span><span class="p">,</span> <span class="n">errors_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">slot_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">slot_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">==</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span><span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setting &#39;slot&#39; on an active array requires also</span>
<span class="cm">		 * updating the &#39;rd%d&#39; link, and communicating</span>
<span class="cm">		 * with the personality with -&gt;hot_*_disk.</span>
<span class="cm">		 * For now we only support removing</span>
<span class="cm">		 * failed/spare devices.  This normally happens automatically,</span>
<span class="cm">		 * but not when the metadata is externally managed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="cm">/* personality does all needed checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_remove_disk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span>
			<span class="n">hot_remove_disk</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Activating a spare .. or possibly reactivating</span>
<span class="cm">		 * if we ever get bitmaps working here.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_add_disk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span>
			<span class="n">hot_add_disk</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
			<span class="cm">/* failure here is OK */</span><span class="p">;</span>
		<span class="cm">/* don&#39;t wakeup anyone, leave that to userspace. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="cm">/* assume it is working */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_slot</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">slot_show</span><span class="p">,</span> <span class="n">slot_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">offset_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">offset_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
		<span class="cm">/* Must set offset before size, so overlap checks</span>
<span class="cm">		 * can be sane */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_offset</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">offset_show</span><span class="p">,</span> <span class="n">offset_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">new_offset_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">new_offset_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span>
		<span class="cm">/* reset is always permitted */</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* must not push array size beyond rdev_sectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span>
		    <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Metadata worries about other space details. */</span>

	<span class="cm">/* decreasing the offset is inconsistent with a backwards</span>
<span class="cm">	 * reshape.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Increasing offset is inconsistent with forwards</span>
<span class="cm">	 * reshape.  reshape_direction should be set to</span>
<span class="cm">	 * &#39;backwards&#39; first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">]</span>
	    <span class="p">.</span><span class="n">allow_new_offset</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="n">new_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_offset</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_new_offset</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">new_offset</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">new_offset_show</span><span class="p">,</span> <span class="n">new_offset_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">rdev_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">overlaps</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">s1</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">l1</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s2</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">l2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if two start/length pairs overlap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">l1</span> <span class="o">&lt;=</span> <span class="n">s2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2</span><span class="o">+</span><span class="n">l2</span> <span class="o">&lt;=</span> <span class="n">s1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">strict_blocks_to_sectors</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">&amp;</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* sector conversion overflow */</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">blocks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">blocks</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* unsigned long long to sector_t overflow */</span>

	<span class="o">*</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">rdev_size_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">my_mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">oldsectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_blocks_to_sectors</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">!=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* too confusing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">my_mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">my_mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">super_types</span><span class="p">[</span><span class="n">my_mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
				<span class="n">rdev_size_change</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sectors</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sectors</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">my_mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* component must fit device */</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">oldsectors</span> <span class="o">&amp;&amp;</span> <span class="n">my_mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to check that all other rdevs with the same -&gt;bdev</span>
<span class="cm">		 * do not overlap.  We need to unlock the mddev to avoid</span>
<span class="cm">		 * a deadlock.  We have already changed rdev-&gt;sectors, and if</span>
<span class="cm">		 * we have to change it back, we will have the lock again.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">my_mddev</span><span class="p">);</span>
		<span class="n">for_each_mddev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>

			<span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">==</span> <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">&amp;&amp;</span>
				    <span class="n">rdev</span> <span class="o">!=</span> <span class="n">rdev2</span> <span class="o">&amp;&amp;</span>
				    <span class="n">overlaps</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
					     <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">,</span>
					     <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">overlap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mddev_lock</span><span class="p">(</span><span class="n">my_mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Someone else could have slipped in a size</span>
<span class="cm">			 * change here, but doing so is just silly.</span>
<span class="cm">			 * We put oldsectors back because we *know* it is</span>
<span class="cm">			 * safe, and trust userspace not to race with</span>
<span class="cm">			 * itself</span>
<span class="cm">			 */</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">oldsectors</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_size</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">rdev_size_show</span><span class="p">,</span> <span class="n">rdev_size_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">recovery_start_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">recovery_start</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">recovery_start</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">recovery_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">recovery_start_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">recovery_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span>
		<span class="n">recovery_start</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recovery_start</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">recovery_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recovery_start</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_recovery_start</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">recovery_start</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">recovery_start_show</span><span class="p">,</span> <span class="n">recovery_start_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">badblocks_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unack</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">badblocks_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bb_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">badblocks_show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bb_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">badblocks_store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Maybe that ack was all we needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_bad_blocks</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">bad_blocks</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bb_show</span><span class="p">,</span> <span class="n">bb_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ubb_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">badblocks_show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ubb_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">badblocks_store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="n">rdev_unack_bad_blocks</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">unacknowledged_bad_blocks</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ubb_show</span><span class="p">,</span> <span class="n">ubb_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">rdev_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">rdev_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_slot</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_offset</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_new_offset</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_recovery_start</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_bad_blocks</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rdev_unack_bad_blocks</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">rdev_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span> <span class="o">?</span> <span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">rdev_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rdev_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rdev_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span> <span class="o">?</span> <span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">)</span><span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">ko</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ko</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">rdev_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>		<span class="o">=</span> <span class="n">rdev_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>		<span class="o">=</span> <span class="n">rdev_attr_store</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">rdev_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">rdev_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span>	<span class="o">=</span> <span class="n">rdev_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">md_rdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span><span class="p">.</span><span class="n">tv_sec</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_read_error</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bb_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">);</span>

	<span class="cm">/* Add space to store bad block list.</span>
<span class="cm">	 * This reserves the space even on arrays where it cannot</span>
<span class="cm">	 * be used - I wonder if that matters</span>
<span class="cm">	 */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">seqlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_rdev_init</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * Import a device. If &#39;super_format&#39; &gt;= 0, then sanity check the superblock</span>
<span class="cm"> *</span>
<span class="cm"> * mark the device faulty if:</span>
<span class="cm"> *</span>
<span class="cm"> *   - the device is nonexistent (zero size)</span>
<span class="cm"> *   - the device has no valid superblock</span>
<span class="cm"> *</span>
<span class="cm"> * a faulty rdev _never_ has rdev-&gt;sb set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="nf">md_import_device</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">newdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">super_format</span><span class="p">,</span> <span class="kt">int</span> <span class="n">super_minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: could not alloc mem for new device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">md_rdev_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">alloc_disk_sb</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">newdev</span><span class="p">,</span> <span class="n">super_format</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>

	<span class="n">kobject_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev_ktype</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BLOCK_SIZE_BITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;md: %s has zero or unknown size, marking faulty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">super_format</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">super_types</span><span class="p">[</span><span class="n">super_format</span><span class="p">].</span>
			<span class="n">load_super</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">super_minor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;md: %s does not have a valid v%d.%d &quot;</span>
			       <span class="s">&quot;superblock, not importing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span>
			       <span class="n">super_format</span><span class="p">,</span> <span class="n">super_minor</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;md: could not read %s&#39;s sb, not importing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">abort_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">super_format</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* hot-add for 0.90, or non-persistent: so no badblocks */</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

<span class="nl">abort_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">unlock_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">md_rdev_clear</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check a full RAID array for plausibility</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">analyze_sbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">freshest</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">freshest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rdev_for_each_safe</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
			<span class="n">load_super</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">freshest</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">freshest</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_ERR</span> \
				<span class="s">&quot;md: fatal superblock inconsistency in %s&quot;</span>
				<span class="s">&quot; -- removing from array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
			<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>


	<span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
		<span class="n">validate_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">freshest</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev_for_each_safe</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">||</span>
		     <span class="n">i</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;md: %s: %s: only %d devices permitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span><span class="p">);</span>
			<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">!=</span> <span class="n">freshest</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
			    <span class="n">validate_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: kicking non-fresh %s&quot;</span>
					<span class="s">&quot; from array!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
				<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">LEVEL_MULTIPATH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Read a fixed-point number.</span>
<span class="cm"> * Numbers in sysfs attributes should be in &quot;standard&quot; units where</span>
<span class="cm"> * possible, so time should be in seconds.</span>
<span class="cm"> * However we internally use a a much smaller unit such as </span>
<span class="cm"> * milliseconds or jiffies.</span>
<span class="cm"> * This function takes a decimal number with a possible fractional</span>
<span class="cm"> * component, and produces an integer which is the result of</span>
<span class="cm"> * multiplying that number by 10^&#39;scale&#39;.</span>
<span class="cm"> * all without any floating-point arithmetic.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">strict_strtoul_scaled</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">decimals</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">decimals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
			<span class="n">decimals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">decimals</span> <span class="o">&lt;</span> <span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">decimals</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">decimals</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decimals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">decimals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">decimals</span> <span class="o">&lt;</span> <span class="n">scale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">decimals</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">md_safemode_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">safe_delay_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">msec</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msec</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">msec</span><span class="o">%</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">safe_delay_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul_scaled</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msec</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_delay</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">msec</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">&lt;</span> <span class="n">old_delay</span><span class="p">)</span>
			<span class="n">md_safemode_timeout</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_safe_delay</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">safe_mode_delay</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span><span class="n">safe_delay_show</span><span class="p">,</span> <span class="n">safe_delay_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">level_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">level_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">clevel</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">pers</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">level</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">LEVEL_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request to change the personality.  Need to ensure:</span>
<span class="cm">	 *  - array is not engaged in resync/recovery/reshape</span>
<span class="cm">	 *  - old personality can be suspended</span>
<span class="cm">	 *  - new personality will access other array.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s: %s does not support online personality change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now find the new personality */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clevel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">clevel</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clevel</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="n">clevel</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtol</span><span class="p">(</span><span class="n">clevel</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">))</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">LEVEL_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_module</span><span class="p">(</span><span class="s">&quot;md-%s&quot;</span><span class="p">,</span> <span class="n">clevel</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;md-level-%s&quot;</span><span class="p">,</span> <span class="n">clevel</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="n">pers</span> <span class="o">=</span> <span class="n">find_pers</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">clevel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pers</span> <span class="o">||</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: personality %s not loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clevel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pers</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing to do! */</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">takeover</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s: %s does not support personality takeover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">clevel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>

	<span class="cm">/* -&gt;takeover must set new_* and/or delta_disks</span>
<span class="cm">	 * if it succeeds, and may set them when it fails.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">takeover</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s: %s would not accept array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">clevel</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Looks like we have a winner */</span>
	<span class="n">mddev_suspend</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to add the md_redundancy_group */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;md: cannot register extra attributes for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span> <span class="o">=</span> <span class="n">sysfs_get_dirent</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_action&quot;</span><span class="p">);</span>
	<span class="p">}</span>		
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to remove the md_redundancy_group */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are converting from a no-redundancy array</span>
<span class="cm">		 * to a redundancy array and metadata is managed</span>
<span class="cm">		 * externally so we need to be sure that writes</span>
<span class="cm">		 * won&#39;t block due to a need to transition</span>
<span class="cm">		 *      clean-&gt;dirty</span>
<span class="cm">		 * until external management is started.</span>
<span class="cm">		 */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_raid_disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: cannot register rd%d&quot;</span>
				       <span class="s">&quot; for %s after level change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="n">pers</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">,</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">));</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this is now an array without redundancy, so</span>
<span class="cm">		 * it must always be in_sync</span>
<span class="cm">		 */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pers</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev_resume</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;level&quot;</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_level</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">level_show</span><span class="p">,</span> <span class="n">level_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">layout_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* just a number, not meaningful for all levels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">layout_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_layout</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">layout_show</span><span class="p">,</span> <span class="n">layout_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid_disks_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">update_raid_disks</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid_disks_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">update_raid_disks</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">olddisks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>

		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">olddisks</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">olddisks</span> <span class="o">&gt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">olddisks</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_raid_disks</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">raid_disks_show</span><span class="p">,</span> <span class="n">raid_disks_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">chunk_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">chunk_size_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_chunk_size</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">chunk_size_show</span><span class="p">,</span> <span class="n">chunk_size_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">resync_start_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">resync_start_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_resync_start</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">resync_start</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">resync_start_show</span><span class="p">,</span> <span class="n">resync_start_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The array state can be:</span>
<span class="cm"> *</span>
<span class="cm"> * clear</span>
<span class="cm"> *     No devices, no size, no level</span>
<span class="cm"> *     Equivalent to STOP_ARRAY ioctl</span>
<span class="cm"> * inactive</span>
<span class="cm"> *     May have some settings, but array is not active</span>
<span class="cm"> *        all IO results in error</span>
<span class="cm"> *     When written, doesn&#39;t tear down array, but just stops it</span>
<span class="cm"> * suspended (not supported yet)</span>
<span class="cm"> *     All IO requests will block. The array can be reconfigured.</span>
<span class="cm"> *     Writing this, if accepted, will block until array is quiescent</span>
<span class="cm"> * readonly</span>
<span class="cm"> *     no resync can happen.  no superblocks get written.</span>
<span class="cm"> *     write requests fail</span>
<span class="cm"> * read-auto</span>
<span class="cm"> *     like readonly, but behaves like &#39;clean&#39; on a write request.</span>
<span class="cm"> *</span>
<span class="cm"> * clean - no pending writes, but otherwise active.</span>
<span class="cm"> *     When written to inactive array, starts without resync</span>
<span class="cm"> *     If a write request arrives then</span>
<span class="cm"> *       if metadata is known, mark &#39;dirty&#39; and switch to &#39;active&#39;.</span>
<span class="cm"> *       if not known, block and switch to write-pending</span>
<span class="cm"> *     If written to an active array that has pending writes, then fails.</span>
<span class="cm"> * active</span>
<span class="cm"> *     fully active: IO and resync can be happening.</span>
<span class="cm"> *     When written to inactive array, starts with resync</span>
<span class="cm"> *</span>
<span class="cm"> * write-pending</span>
<span class="cm"> *     clean, but writes are blocked waiting for &#39;active&#39; to be written.</span>
<span class="cm"> *</span>
<span class="cm"> * active-idle</span>
<span class="cm"> *     like active, but no writes have been seen for a while (100msec).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">array_state</span> <span class="p">{</span> <span class="n">clear</span><span class="p">,</span> <span class="n">inactive</span><span class="p">,</span> <span class="n">suspended</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">read_auto</span><span class="p">,</span> <span class="n">clean</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span>
		   <span class="n">write_pending</span><span class="p">,</span> <span class="n">active_idle</span><span class="p">,</span> <span class="n">bad_word</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">array_states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;clear&quot;</span><span class="p">,</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span> <span class="s">&quot;suspended&quot;</span><span class="p">,</span> <span class="s">&quot;readonly&quot;</span><span class="p">,</span> <span class="s">&quot;read-auto&quot;</span><span class="p">,</span> <span class="s">&quot;clean&quot;</span><span class="p">,</span> <span class="s">&quot;active&quot;</span><span class="p">,</span>
	<span class="s">&quot;write-pending&quot;</span><span class="p">,</span> <span class="s">&quot;active-idle&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_word</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">list</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">array_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">array_state</span> <span class="n">st</span> <span class="o">=</span> <span class="n">inactive</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">st</span> <span class="o">=</span> <span class="n">readonly</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">st</span> <span class="o">=</span> <span class="n">read_auto</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">clean</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">write_pending</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span><span class="p">)</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">active_idle</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">st</span> <span class="o">=</span> <span class="n">active</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">clear</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">st</span> <span class="o">=</span> <span class="n">inactive</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">array_states</span><span class="p">[</span><span class="n">st</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_md_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ro</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_open</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">md_set_readonly</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_open</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_md_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">restart_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">array_state_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">array_state</span> <span class="n">st</span> <span class="o">=</span> <span class="n">match_word</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">array_states</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">bad_word</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">clear</span>:
		<span class="cm">/* stopping an active array */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">inactive</span>:
		<span class="cm">/* stopping an active array */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already inactive */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">suspended</span>:
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* not supported yet */</span>
	<span class="k">case</span> <span class="n">readonly</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">md_set_readonly</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">read_auto</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">md_set_readonly</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">restart_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">clean</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">restart_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">active</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">restart_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">write_pending</span>:
	<span class="k">case</span> <span class="n">active_idle</span>:
		<span class="cm">/* these cannot be set */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">==</span> <span class="n">UNTIL_IOCTL</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_array_state</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">array_state</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">array_state_show</span><span class="p">,</span> <span class="n">array_state_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">max_corrected_read_errors_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_corr_read_errors</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">max_corrected_read_errors_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_corr_read_errors</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">max_corr_read_errors</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">max_read_errors</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">max_corrected_read_errors_show</span><span class="p">,</span>
	<span class="n">max_corrected_read_errors_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">null_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">new_dev_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* buf must be %d:%d\n? giving major and minor numbers */</span>
	<span class="cm">/* The new device is added to the array.</span>
<span class="cm">	 * If the array has a persistent superblock, we read the</span>
<span class="cm">	 * superblock to initialise info and check validity.</span>
<span class="cm">	 * Otherwise, only checking done is that in bind_rdev_to_array,</span>
<span class="cm">	 * which mainly checks size.</span>
<span class="cm">	 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">major</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span> <span class="o">||</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">minor</span> <span class="o">!=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev0</span>
				<span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">same_set</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">]</span>
				<span class="p">.</span><span class="n">load_super</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev0</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_new_device</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">new_dev</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">null_show</span><span class="p">,</span> <span class="n">new_dev_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">bitmap_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">end_chunk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* buf should be &lt;chunk&gt; &lt;chunk&gt; ... or &lt;chunk&gt;-&lt;chunk&gt; ... (range) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">end_chunk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* range */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">end_chunk</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">bitmap_dirty_bits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">end_chunk</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bitmap_unplug</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span> <span class="cm">/* flush the bits to disk */</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_bitmap</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">bitmap_set_bits</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">null_show</span><span class="p">,</span> <span class="n">bitmap_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">update_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">num_sectors</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">size_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If array is inactive, we can reduce the component size, but</span>
<span class="cm">	 * not increase it (except from 0).</span>
<span class="cm">	 * If array is active, we can try an on-line resize</span>
<span class="cm">	 */</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">strict_blocks_to_sectors</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">update_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&gt;</span> <span class="n">sectors</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_size</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">component_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">size_show</span><span class="p">,</span> <span class="n">size_store</span><span class="p">);</span>


<span class="cm">/* Metdata version.</span>
<span class="cm"> * This is one of</span>
<span class="cm"> *   &#39;none&#39; for arrays with no metadata (good luck...)</span>
<span class="cm"> *   &#39;external&#39; for arrays with externally managed metadata,</span>
<span class="cm"> * or N.M for internally known formats</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">metadata_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;external:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">metadata_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="cm">/* Changing the details of &#39;external&#39; metadata is</span>
<span class="cm">	 * always permitted.  Otherwise there must be</span>
<span class="cm">	 * no devices attached to the array.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;external:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;external:&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">len</span><span class="o">-</span><span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">))</span>
			<span class="n">namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">[</span><span class="n">namelen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">[</span><span class="n">namelen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">[</span><span class="o">--</span><span class="n">namelen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">major</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">==</span><span class="n">buf</span> <span class="o">||</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">==</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">super_types</span><span class="p">)</span> <span class="o">||</span> <span class="n">super_types</span><span class="p">[</span><span class="n">major</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">major</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_metadata</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">metadata_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">metadata_show</span><span class="p">,</span> <span class="n">metadata_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">action_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;idle&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;frozen&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;reshape&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;resync&quot;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;check&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;repair&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;recover&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reap_sync_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">action_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;frozen&quot;</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;idle&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;frozen&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">reap_sync_thread</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;resync&quot;</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;recover&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;reshape&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">start_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">start_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;degraded&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;check&quot;</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;repair&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mismatch_cnt_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_scan_mode</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_action</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">action_show</span><span class="p">,</span> <span class="n">action_store</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_mismatches</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">mismatch_cnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_min_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed_min</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">?</span> <span class="s">&quot;local&quot;</span><span class="o">:</span> <span class="s">&quot;system&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_min_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">min</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_sync_min</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_speed_min</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sync_min_show</span><span class="p">,</span> <span class="n">sync_min_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_max_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed_max</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">?</span> <span class="s">&quot;local&quot;</span><span class="o">:</span> <span class="s">&quot;system&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_max_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_sync_max</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_speed_max</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sync_max_show</span><span class="p">,</span> <span class="n">sync_max_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">degraded_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_degraded</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">degraded</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_force_parallel_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">parallel_resync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_force_parallel_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">parallel_resync</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* force parallel resync, even with shared block devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_sync_force_parallel</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_force_parallel</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
       <span class="n">sync_force_parallel_show</span><span class="p">,</span> <span class="n">sync_force_parallel_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_speed_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">resync</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">db</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">resync</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_mark_cnt</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">);</span>
	<span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">)</span> <span class="n">dt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">db</span> <span class="o">=</span> <span class="n">resync</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark_cnt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">/</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* K/sec */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_sync_speed</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">sync_speed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">sync_completed_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">max_sectors</span><span class="p">,</span> <span class="n">resync</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>

	<span class="n">resync</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu / %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resync</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_sync_completed</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">sync_completed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">min_sync_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">min_sync_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Must be a multiple of chunk_size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_min_sync</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_min</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">min_sync_show</span><span class="p">,</span> <span class="n">min_sync_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">max_sync_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">max_sync_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;max&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">max</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="cm">/* Must be a multiple of chunk_size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sector_div</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_max_sync</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">sync_max</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">max_sync_show</span><span class="p">,</span> <span class="n">max_sync_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">suspend_lo_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">suspend_lo_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">old</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> 
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;=</span> <span class="n">old</span><span class="p">)</span>
		<span class="cm">/* Shrinking suspended region */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Expanding suspended region - need to wait */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_suspend_lo</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">suspend_lo</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">suspend_lo_show</span><span class="p">,</span> <span class="n">suspend_lo_store</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">suspend_hi_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">suspend_hi_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">old</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;=</span> <span class="n">old</span><span class="p">)</span>
		<span class="cm">/* Shrinking suspended region */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Expanding suspended region - need to wait */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_suspend_hi</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">suspend_hi</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">suspend_hi_show</span><span class="p">,</span> <span class="n">suspend_hi_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">reshape_position_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">reshape_position_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">new</span> <span class="o">=</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_reshape_position</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">reshape_position</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">reshape_position_show</span><span class="p">,</span>
       <span class="n">reshape_position_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">reshape_direction_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">?</span> <span class="s">&quot;backwards&quot;</span> <span class="o">:</span> <span class="s">&quot;forwards&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">reshape_direction_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;forwards&quot;</span><span class="p">))</span>
		<span class="n">backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;backwards&quot;</span><span class="p">))</span>
		<span class="n">backwards</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">==</span> <span class="n">backwards</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* check if we are allowed to change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="n">backwards</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_reshape_direction</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">reshape_direction</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">reshape_direction_show</span><span class="p">,</span>
       <span class="n">reshape_direction_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">array_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">array_size_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">;</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_blocks_to_sectors</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sectors</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
		<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="n">md_array_size</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">array_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">array_size_show</span><span class="p">,</span>
       <span class="n">array_size_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">md_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">md_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_layout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_raid_disks</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_chunk_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_resync_start</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_metadata</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_new_device</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_safe_delay</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_array_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_reshape_position</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_reshape_direction</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_array_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">max_corr_read_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">md_redundancy_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">md_scan_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_mismatches</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_sync_min</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_sync_max</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_sync_speed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_sync_force_parallel</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_sync_completed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_min_sync</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_max_sync</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_suspend_lo</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_suspend_hi</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_bitmap</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">md_degraded</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">md_redundancy_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">md_redundancy_attrs</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">md_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev_get</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">md_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev_get</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">ko</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ko</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">)</span>
		<span class="n">sysfs_put</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_gendisk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">md_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">md_attr_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">md_attr_store</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">md_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">md_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">md_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span>	<span class="o">=</span> <span class="n">md_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">mdp_major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mddev_delayed_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">del_work</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_bitmap_group</span><span class="p">);</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_alloc</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">disks_mutex</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev_find</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">partitioned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">partitioned</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MD_MAJOR</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">partitioned</span> <span class="o">?</span> <span class="n">MdpMinorShift</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="cm">/* wait for any previous instance of this device to be</span>
<span class="cm">	 * completely removed (mddev_delayed_delete).</span>
<span class="cm">	 */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disks_mutex</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to ensure that &#39;name&#39; is not a duplicate.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev2</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mddev2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">,</span> <span class="n">all_mddevs</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev2</span><span class="o">-&gt;</span><span class="n">gendisk</span> <span class="o">&amp;&amp;</span>
			    <span class="n">strcmp</span><span class="p">(</span><span class="n">mddev2</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">blk_alloc_queue</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>

	<span class="n">blk_queue_make_request</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">md_make_request</span><span class="p">);</span>
	<span class="n">blk_set_stacking_limits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">);</span>

	<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">partitioned</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;md_d%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;md%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">md_fops</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">blk_queue_flush</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">);</span>
	<span class="cm">/* Allow extended partitions.  This makes the</span>
<span class="cm">	 * &#39;mdp&#39; device redundant, but we can&#39;t really</span>
<span class="cm">	 * remove it now.</span>
<span class="cm">	 */</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_EXT_DEVT</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="cm">/* As soon as we call add_disk(), another thread could get</span>
<span class="cm">	 * through to md_open, so make sure it doesn&#39;t get too far</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_ktype</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;md&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This isn&#39;t possible, but as kobject_init_and_add is marked</span>
<span class="cm">		 * __must_check, we must do something with the result</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: cannot register %s/md - name in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_bitmap_group</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pointless warning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
 <span class="nl">abort:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disks_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span> <span class="o">=</span> <span class="n">sysfs_get_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;array_state&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="nf">md_probe</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">md_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_named_array</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* val must be &quot;md_*&quot; where * is not all digits.</span>
<span class="cm">	 * We allocate an array with a large free minor number, and</span>
<span class="cm">	 * set the name to val.  val must not already be an active name.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">DISK_NAME_LEN</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">DISK_NAME_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;md_&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">md_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_safemode_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">start_dirty_degraded</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">md_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">pers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="cm">/* cannot run an array with no devices.. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/* Cannot run until previous stop completes properly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Analyze all RAID superblock(s)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">analyze_sbs</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_NONE</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;md-level-%d&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;md-%s&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drop all container device buffers, from now on</span>
<span class="cm">	 * the only valid external interface is through the md</span>
<span class="cm">	 * device.</span>
<span class="cm">	 */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sync_blockdev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>

		<span class="cm">/* perform some consistency tests on the device.</span>
<span class="cm">		 * We don&#39;t want the data to overlap the metadata,</span>
<span class="cm">		 * Internal Bitmap issues have been handled elsewhere.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">meta_bdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Nothing to check */</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span>
			    <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: %s: data overlaps metadata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_size</span><span class="o">/</span><span class="mi">512</span>
			    <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: %s: metadata overlaps data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bio_set</span> <span class="o">=</span> <span class="n">bioset_create</span><span class="p">(</span><span class="n">BIO_POOL_SIZE</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="n">pers</span> <span class="o">=</span> <span class="n">find_pers</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pers</span> <span class="o">||</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">LEVEL_NONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: personality for level %d is not loaded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: personality for level %s is not loaded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="n">pers</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">,</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pers</span><span class="o">-&gt;</span><span class="n">start_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This personality cannot handle reshaping... */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Warn if this is a potentially silly</span>
<span class="cm">		 * configuration.</span>
<span class="cm">		 */</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">warned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev2</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&lt;</span> <span class="n">rdev2</span> <span class="o">&amp;&amp;</span>
				    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span> <span class="o">==</span>
				    <span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;%s: WARNING: %s appears to be&quot;</span>
					       <span class="s">&quot; on the same physical disk as&quot;</span>
					       <span class="s">&quot; %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
					       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span>
					       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b2</span><span class="p">));</span>
					<span class="n">warned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">warned</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;True protection against single-disk&quot;</span>
			       <span class="s">&quot; failure might be compromised.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* may be over-ridden by personality */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ok_start_degraded</span> <span class="o">=</span> <span class="n">start_dirty_degraded</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_readonly</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* read-only, but switch on first write */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: pers-&gt;run() failed ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span><span class="p">,</span> <span class="s">&quot;%s: default size too small,&quot;</span>
			  <span class="s">&quot; but &#39;external_size&#39; not in effect?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;md: invalid array_size %llu &gt; default size %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_create</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to create bitmap (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;md: cannot register extra attributes for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span> <span class="o">=</span> <span class="n">sysfs_get_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;sync_action&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* auto-readonly not meaningful */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_corr_read_errors</span><span class="p">,</span>
		   <span class="n">MD_DEFAULT_MAX_CORRECTED_READ_ERRORS</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">md_safemode_timeout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* 200 msec delay */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
				<span class="cm">/* failure here is OK */</span><span class="p">;</span>
	
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;degraded&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_run</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_md_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_load</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span> <span class="cm">/* possibly kick off a reshape */</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
	<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">restart_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">;</span>

	<span class="cm">/* Complain if it has no devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s switched to read-write mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="cm">/* Kick recovery or resync if necessary */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* similar to deny_write_access, but accounts for our holding a reference</span>
<span class="cm"> * to the file ourselves */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">deny_bitmap_write_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETXTBSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">restore_bitmap_write_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_writecount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">LEVEL_NONE</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">can_decrease_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">LEVEL_NONE</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_min</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_speed_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">merge_check_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">daemon_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">max_write_behind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__md_stop_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">reap_sync_thread</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">);</span>

	<span class="n">bitmap_flush</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">md_super_wait</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mark array as shutdown cleanly */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_stop_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">__md_stop_writes</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_stop_writes</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">md_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">md_redundancy_group</span><span class="p">;</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_stop</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_set_readonly</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">is_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: %s still in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__md_stop_writes</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

		<span class="n">err</span>  <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* mode:</span>
<span class="cm"> *   0 - completely stop and dis-assemble array</span>
<span class="cm"> *   2 - stop but do not disassemble array</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_md_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">is_open</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;md: %s still in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span>
			<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">__md_stop_writes</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* tell userspace to handle &#39;inactive&#39; */</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>

		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

		<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Free resources if final stop</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s stopped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>

		<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">restore_bitmap_write_access</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
			<span class="n">fput</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">export_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

		<span class="n">md_clean</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">==</span> <span class="n">UNTIL_STOP</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blk_integrity_unregister</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autorun_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: running: &quot;</span><span class="p">);</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;%s&gt;&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: do_md_run() returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">do_md_stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lets try to run arrays based on all disks that have arrived</span>
<span class="cm"> * until now. (those are in pending_raid_disks)</span>
<span class="cm"> *</span>
<span class="cm"> * the method: pick the first pending disk, collect all disks with</span>
<span class="cm"> * the same UUID, remove all from the pending list and put them into</span>
<span class="cm"> * the &#39;same_array&#39; list. Then order this list based on superblock</span>
<span class="cm"> * update time (freshest comes first), kick out &#39;old&#39; disks and</span>
<span class="cm"> * compare superblocks. If everything&#39;s fine then run it.</span>
<span class="cm"> *</span>
<span class="cm"> * If &quot;unit&quot; is allocated, then bump its reference count</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">autorun_devices</span><span class="p">(</span><span class="kt">int</span> <span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev0</span><span class="p">,</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: autorun ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_raid_disks</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>
		<span class="n">dev_t</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">candidates</span><span class="p">);</span>
		<span class="n">rdev0</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pending_raid_disks</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">same_set</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: considering %s ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidates</span><span class="p">);</span>
		<span class="n">rdev_for_each_list</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_raid_disks</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">super_90_load</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md:  adding %s ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
				<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">candidates</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * now we have a set of devices, with all of them having</span>
<span class="cm">		 * mostly sane superblocks. It&#39;s time to allocate the</span>
<span class="cm">		 * mddev.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">mdp_major</span><span class="p">,</span>
				    <span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">preferred_minor</span> <span class="o">&lt;&lt;</span> <span class="n">MdpMinorShift</span><span class="p">);</span>
			<span class="n">unit</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MdpMinorShift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span> <span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">preferred_minor</span><span class="p">);</span>
			<span class="n">unit</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">preferred_minor</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: unit number in %s is bad: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">preferred_minor</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">md_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev_find</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="p">)</span>
				<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;md: cannot allocate memory for md drive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span> 
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: %s locked, cannot run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span>
			 <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;md: %s already running, cannot run %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
			<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: created %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rdev_for_each_list</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">candidates</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">))</span>
					<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">autorun_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* on success, candidates will be empty, on error</span>
<span class="cm">		 * it won&#39;t...</span>
<span class="cm">		 */</span>
		<span class="n">rdev_for_each_list</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">candidates</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">);</span>
			<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: ... autorun DONE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_version</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdu_version_t</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">ver</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">MD_MAJOR_VERSION</span><span class="p">;</span>
	<span class="n">ver</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MD_MINOR_VERSION</span><span class="p">;</span>
	<span class="n">ver</span><span class="p">.</span><span class="n">patchlevel</span> <span class="o">=</span> <span class="n">MD_PATCHLEVEL_VERSION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ver</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_array_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdu_array_info_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="n">working</span><span class="p">,</span><span class="n">insync</span><span class="p">,</span><span class="n">failed</span><span class="p">,</span><span class="n">spare</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">nr</span><span class="o">=</span><span class="n">working</span><span class="o">=</span><span class="n">insync</span><span class="o">=</span><span class="n">failed</span><span class="o">=</span><span class="n">spare</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">failed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">working</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">insync</span><span class="o">++</span><span class="p">;</span>	
			<span class="k">else</span>
				<span class="n">spare</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">patch_version</span> <span class="o">=</span> <span class="n">MD_PATCHLEVEL_VERSION</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">ctime</span>         <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">level</span>         <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">size</span>          <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* overflow */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">nr_disks</span>      <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">raid_disks</span>    <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">md_minor</span>      <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">md_minor</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">not_persistent</span><span class="o">=</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">utime</span>         <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">state</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_CLEAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">active_disks</span>  <span class="o">=</span> <span class="n">insync</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">working_disks</span> <span class="o">=</span> <span class="n">working</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">failed_disks</span>  <span class="o">=</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">spare_disks</span>   <span class="o">=</span> <span class="n">spare</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">layout</span>        <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">chunk_size</span>    <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_bitmap_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdu_bitmap_file_t</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* too big for stack allocation */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md_allow_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">file</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">file</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* bitmap disabled, zero the first byte and copy out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">pathname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">copy_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">pathname</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span>
		     <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">pathname</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">pathname</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

<span class="nl">copy_out:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">file</span><span class="p">)))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_disk_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdu_disk_info_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">find_rdev_nr</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_FAULTY</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_ACTIVE</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_WRITEMOSTLY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_REMOVED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_new_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">mdu_disk_info_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">!=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">!=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* expecting a device which has a superblock */</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;md: md_import_device returned %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev0</span>
				<span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">md_rdev</span><span class="p">,</span> <span class="n">same_set</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">]</span>
				<span class="p">.</span><span class="n">load_super</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev0</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
					<span class="s">&quot;md: %s has different UUID to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> 
					<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev0</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b2</span><span class="p">));</span>
				<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * add_new_disk can be used once the array is assembled</span>
<span class="cm">	 * to add &quot;hot spares&quot;.  They must already have a superblock</span>
<span class="cm">	 * written</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_add_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;%s: personality does not support diskops!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span>
						<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;md: md_import_device returned %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* set saved_raid_disk if appropriate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
			    <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
				<span class="n">validate_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This was a hot-add request, but events doesn&#39;t</span>
<span class="cm">			 * match, so reject it.</span>
<span class="cm">			 */</span>
			<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="cm">/* just to be sure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_WRITEMOSTLY</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_remove_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If there is hot_add_disk but no hot_remove_disk</span>
<span class="cm">			 * then added disks for geometry changes,</span>
<span class="cm">			 * and should be added immediately.</span>
<span class="cm">			 */</span>
			<span class="n">super_types</span><span class="p">[</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span>
				<span class="n">validate_super</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_add_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">unbind_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>

		<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* otherwise, add_new_disk is only allowed</span>
<span class="cm">	 * for major_version==0 superblocks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ADD_NEW_DISK not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_FAULTY</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;md: error, md_import_device() returned %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_SYNC</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_DISK_WRITEMOSTLY</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: nonpersistent superblock ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">calc_dev_sboffset</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hot_remove_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">find_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">busy</span><span class="p">;</span>

	<span class="n">kick_rdev_from_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">busy:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: cannot remove active disk %s from %s ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hot_add_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: HOT_ADD may only be used with&quot;</span>
			<span class="s">&quot; version-0 superblocks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_add_disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;%s: personality does not support diskops!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;md: error, md_import_device() returned %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">calc_dev_sboffset</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sb_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			<span class="s">&quot;md: can not hot-add faulty %s disk to %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_export</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bind_rdev_to_array</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort_export</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The rest should better be atomic, we can have disk failures</span>
<span class="cm">	 * noticed in interrupt contexts ...</span>
<span class="cm">	 */</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Kick recovery, maybe this spare has to be added to the</span>
<span class="cm">	 * array immediately.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">abort_export:</span>
	<span class="n">export_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_bitmap_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="cm">/* we should be able to change the bitmap.. */</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span> <span class="cm">/* cannot add when bitmap is present */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">fget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error: failed to get bitmap file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">deny_bitmap_write_access</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error: bitmap file is already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="n">fput</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* file overrides offset */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span> <span class="cm">/* cannot remove what isn&#39;t there */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_create</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_load</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* make sure to put the file */</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">restore_bitmap_write_access</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
			<span class="n">fput</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set_array_info is used two different ways</span>
<span class="cm"> * The original usage is when creating a new array.</span>
<span class="cm"> * In this usage, raid_disks is &gt; 0 and it together with</span>
<span class="cm"> *  level, size, not_persistent,layout,chunksize determine the</span>
<span class="cm"> *  shape of the array.</span>
<span class="cm"> *  This will always create an array with a type-0.90.0 superblock.</span>
<span class="cm"> * The newer usage is when assembling an array.</span>
<span class="cm"> *  In this case raid_disks will be 0, and the major_version field is</span>
<span class="cm"> *  use to determine which style super-blocks are to be found on the devices.</span>
<span class="cm"> *  The minor and patch _version numbers are also kept incase the</span>
<span class="cm"> *  super_block handler wishes to interpret them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_array_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">mdu_array_info_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just setting version number for superblock loading */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">super_types</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">super_types</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* maybe try to auto-load a module? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
				<span class="s">&quot;md: superblock version %d not known</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">patch_version</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">patch_version</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span> <span class="o">=</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">not_persistent</span><span class="p">;</span>
		<span class="cm">/* ensure mddev_put doesn&#39;t delete this now that there</span>
<span class="cm">		 * is some minimal configuration.</span>
<span class="cm">		 */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span>         <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">MD_MAJOR_VERSION</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">MD_MINOR_VERSION</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">patch_version</span> <span class="o">=</span> <span class="n">MD_PATCHLEVEL_VERSION</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span>         <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span>         <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">clevel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span>   <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span>    <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="cm">/* don&#39;t set md_minor, it is determined by which /dev/md* was</span>
<span class="cm">	 * openned</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_CLEAN</span><span class="p">))</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span>    <span class="o">=</span> <span class="o">!</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">not_persistent</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span>	     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span>        <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chunk_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span>     <span class="o">=</span> <span class="n">MD_SB_DISKS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">=</span> <span class="n">MD_SB_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_space</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">MD_SB_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Generate a 128 bit UUID</span>
<span class="cm">	 */</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_set_array_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">array_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">mddev_is_locked</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="s">&quot;%s: unlocked mddev!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">=</span> <span class="n">array_sectors</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_set_array_sectors</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">num_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">resize</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* The &quot;num_sectors&quot; is the number of sectors of each device that</span>
<span class="cm">	 * is used.  This can only make sense for arrays with redundancy.</span>
<span class="cm">	 * linear and raid0 always use whatever space is available. We can only</span>
<span class="cm">	 * consider changing this number if no resync or reconstruction is</span>
<span class="cm">	 * happening, and if the new size is acceptable. It must fit before the</span>
<span class="cm">	 * sb_start or, if that is &lt;data_offset, it must fit before the size</span>
<span class="cm">	 * of each device.  If num_sectors is zero, we find the largest size</span>
<span class="cm">	 * that fits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_sectors</span> <span class="o">&gt;</span> <span class="n">avail</span><span class="p">))</span>
			<span class="n">num_sectors</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&lt;</span> <span class="n">num_sectors</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">num_sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_raid_disks</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="cm">/* change the number of raid disks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_disks</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span> <span class="o">&amp;&amp;</span> <span class="n">raid_disks</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">max_disks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&lt;</span> <span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&gt;</span> <span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * update_array_info is used to change the configuration of an</span>
<span class="cm"> * on-line array.</span>
<span class="cm"> * The version, ctime,level,size,raid_disks,not_persistent, layout,chunk_size</span>
<span class="cm"> * fields in the info are checked against the array.</span>
<span class="cm"> * Any differences that cannot be handled will cause an error.</span>
<span class="cm"> * Normally, only one change can be managed at a time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_array_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">mdu_array_info_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* calculate expected state,ignoring low bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">||</span>
<span class="cm">/*	    mddev-&gt;patch_version != info-&gt;patch_version || */</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ctime</span>         <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ctime</span>         <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span>         <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">level</span>         <span class="o">||</span>
<span class="cm">/*	    mddev-&gt;layout        != info-&gt;layout        || */</span>
	    <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span>	 <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">not_persistent</span><span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chunk_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span> <span class="o">||</span>
	    <span class="cm">/* ignore bottom 8 bits of state, and allow SB_BITMAP_PRESENT to change */</span>
	    <span class="p">((</span><span class="n">state</span><span class="o">^</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffe00</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Check there is only one change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">^</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">))</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Change layout</span>
<span class="cm">		 * we don&#39;t need to do anything at the md level, the</span>
<span class="cm">		 * personality will take care of it all.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">update_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span>    <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">update_raid_disks</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">^</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_SB_BITMAP_PRESENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* add the bitmap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_offset</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">default_space</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">bitmap_create</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">bitmap_load</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
				<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* remove the bitmap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="o">-&gt;</span><span class="n">storage</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bitmap_destroy</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_disk_faulty</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">find_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">md_error</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have a problem here : there is no easy way to give a CHS</span>
<span class="cm"> * virtual geometry. We currently pretend that we have a 2 heads</span>
<span class="cm"> * 4 sectors (with a BIG number of cylinders...). This drives</span>
<span class="cm"> * dosfs just mad... ;-)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ro</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RAID_VERSION</span>:
	<span class="k">case</span> <span class="n">GET_ARRAY_INFO</span>:
	<span class="k">case</span> <span class="n">GET_DISK_INFO</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commands dealing with the RAID driver but not any</span>
<span class="cm">	 * particular array:</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">RAID_VERSION</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PRINT_RAID_DEBUG</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">md_print_devices</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
		<span class="k">case</span> <span class="n">RAID_AUTORUN</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">autostart_arrays</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commands creating/starting a new array:</span>
<span class="cm">	 */</span>

	<span class="n">mddev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
			<span class="s">&quot;md: ioctl lock interrupted, reason %d, cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SET_ARRAY_INFO</span>:
			<span class="p">{</span>
				<span class="n">mdu_array_info_t</span> <span class="n">info</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">update_array_info</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: couldn&#39;t update&quot;</span>
						       <span class="s">&quot; array info. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;md: array %s already has disks!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;md: array %s already initialised!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">set_array_info</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md: couldn&#39;t set&quot;</span>
					       <span class="s">&quot; array info. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commands querying/configuring an existing array:</span>
<span class="cm">	 */</span>
	<span class="cm">/* if we are not initialised yet, only ADD_NEW_DISK, STOP_ARRAY,</span>
<span class="cm">	 * RUN_ARRAY, and GET_ and SET_BITMAP_FILE are allowed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">ADD_NEW_DISK</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">STOP_ARRAY</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">RUN_ARRAY</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">SET_BITMAP_FILE</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">GET_BITMAP_FILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commands even a read-only array can execute:</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">GET_ARRAY_INFO</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">get_array_info</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GET_BITMAP_FILE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">get_bitmap_file</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GET_DISK_INFO</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">get_disk_info</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESTART_ARRAY_RW</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">restart_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STOP_ARRAY</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_stop</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STOP_ARRAY_RO</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">md_set_readonly</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BLKROSET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">arg</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* if the bdev is going readonly the value of mddev-&gt;ro</span>
<span class="cm">			 * does not matter, no writes are coming</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

			<span class="cm">/* are we are already prepared for writes? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

			<span class="cm">/* transitioning to readauto need only happen for</span>
<span class="cm">			 * arrays that call md_write_start</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">restart_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The remaining ioctls are changing the state of the</span>
<span class="cm">	 * superblock, so we do not allow them on read-only arrays.</span>
<span class="cm">	 * However non-MD ioctls (e.g. get-size) will still come through</span>
<span class="cm">	 * here and hit the &#39;default&#39; below, so only disallow</span>
<span class="cm">	 * &#39;md&#39; ioctls, and switch to rw mode if started auto-readonly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MD_MAJOR</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADD_NEW_DISK</span>:
		<span class="p">{</span>
			<span class="n">mdu_disk_info_t</span> <span class="n">info</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">add_new_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">HOT_REMOVE_DISK</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">hot_remove_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HOT_ADD_DISK</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">hot_add_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SET_DISK_FAULTY</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">set_disk_faulty</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">new_decode_dev</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RUN_ARRAY</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">do_md_run</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SET_BITMAP_FILE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">set_bitmap_file</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_unlock</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort_unlock</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done_unlock:</span>
<span class="nl">abort_unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">==</span> <span class="n">UNTIL_IOCTL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
<span class="nl">abort:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HOT_REMOVE_DISK</span>:
	<span class="k">case</span> <span class="n">HOT_ADD_DISK</span>:
	<span class="k">case</span> <span class="n">SET_DISK_FAULTY</span>:
	<span class="k">case</span> <span class="n">SET_BITMAP_FILE</span>:
		<span class="cm">/* These take in integer arg, do not convert */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">md_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Succeed if we can lock the mddev, which confirms that</span>
<span class="cm">	 * it isn&#39;t being stopped right now.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev_find</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are racing with mddev_put which is discarding this</span>
<span class="cm">		 * bd_disk.</span>
<span class="cm">		 */</span>
		<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="cm">/* Wait until bdev-&gt;bd_disk is definitely gone */</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">);</span>
		<span class="cm">/* Then retry the open from the top */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>

	<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">);</span>
	<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_media_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">md_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">md_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">md_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">md_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">md_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">getgeo</span>		<span class="o">=</span> <span class="n">md_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">media_changed</span>  <span class="o">=</span> <span class="n">md_media_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revalidate_disk</span><span class="o">=</span> <span class="n">md_revalidate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * md_thread is a &#39;system-thread&#39;, it&#39;s priority should be very</span>
<span class="cm">	 * high. We avoid resource deadlocks individually in each</span>
<span class="cm">	 * raid personality. (RAID5 does preallocation) We also use RR and</span>
<span class="cm">	 * the very same RT priority as kswapd, thus we will never get</span>
<span class="cm">	 * into a priority inversion deadlock.</span>
<span class="cm">	 *</span>
<span class="cm">	 * we definitely have to have equal or higher priority than</span>
<span class="cm">	 * bdflush, otherwise bdflush will deadlock if there are too</span>
<span class="cm">	 * many dirty RAID5 blocks.</span>
<span class="cm">	 */</span>

	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>

		<span class="cm">/* We need to wait INTERRUPTIBLE so that</span>
<span class="cm">		 * we don&#39;t add to the load-average.</span>
<span class="cm">		 * That means we need to be sure no signals are</span>
<span class="cm">		 * pending</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

		<span class="n">wait_event_interruptible_timeout</span>
			<span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">,</span>
			 <span class="n">test_bit</span><span class="p">(</span><span class="n">THREAD_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			 <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">(),</span>
			 <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">THREAD_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_wakeup_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md: waking up MD thread %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">THREAD_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">md_thread</span> <span class="o">*</span><span class="nf">md_register_thread</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">run</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="p">),</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>

	<span class="kr">thread</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_thread</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="kr">thread</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>

	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span><span class="p">;</span>
	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
	<span class="kr">thread</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">md_thread</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span>
				  <span class="s">&quot;%s_%s&quot;</span><span class="p">,</span>
				  <span class="n">mdname</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
				  <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kr">thread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_unregister_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_thread</span> <span class="o">**</span><span class="n">threadp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="kr">thread</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;interrupting MD-thread pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">));</span>
	<span class="cm">/* Locking ensures that mddev_unlock does not wake_up a</span>
<span class="cm">	 * non-existent thread</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">threadp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">||</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">.</span><span class="n">func</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
	<span class="n">md_new_event_inintr</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* seq_file implementation /proc/mdstat */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_unused</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;unused devices: &quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_raid_disks</span><span class="p">,</span> <span class="n">same_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span>
			      <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;&lt;none&gt;&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span> <span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">max_sectors</span><span class="p">,</span> <span class="n">resync</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dt</span><span class="p">,</span> <span class="n">db</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">rt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">per_milli</span><span class="p">;</span>

	<span class="n">resync</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Should not happen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MD_BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Pick &#39;scale&#39; such that (resync&gt;&gt;scale)*1000 will fit</span>
<span class="cm">	 * in a sector_t, and (max_sectors&gt;&gt;scale) will fit in a</span>
<span class="cm">	 * u32, as those are the requirements for sector_div.</span>
<span class="cm">	 * Thus &#39;scale&#39; must be at least 10</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sector_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span> <span class="n">max_sectors</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1ULL</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">scale</span><span class="o">+</span><span class="mi">32</span><span class="p">)))</span>
			<span class="n">scale</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">resync</span><span class="o">&gt;&gt;</span><span class="n">scale</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">max_sectors</span><span class="o">&gt;&gt;</span><span class="n">scale</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">per_milli</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">per_milli</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;] &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s =%3u.%u%% (%llu/%llu)&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span><span class="o">?</span>
		    <span class="s">&quot;reshape&quot;</span> <span class="o">:</span>
		    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span><span class="o">?</span>
		     <span class="s">&quot;check&quot;</span> <span class="o">:</span>
		     <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">?</span>
		      <span class="s">&quot;resync&quot;</span> <span class="o">:</span> <span class="s">&quot;recovery&quot;</span><span class="p">))),</span>
		   <span class="n">per_milli</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">per_milli</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">resync</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">max_sectors</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * dt: time from mark until now</span>
<span class="cm">	 * db: blocks written from mark until now</span>
<span class="cm">	 * rt: remaining time</span>
<span class="cm">	 *</span>
<span class="cm">	 * rt is a sector_t, so could be 32bit or 64bit.</span>
<span class="cm">	 * So we divide before multiply in case it is 32bit and close</span>
<span class="cm">	 * to the limit.</span>
<span class="cm">	 * We scale the divisor (db) by 32 to avoid losing precision</span>
<span class="cm">	 * near the end of resync when the number of remaining sectors</span>
<span class="cm">	 * is close to &#39;db&#39;.</span>
<span class="cm">	 * We then divide rt by 32 after multiplying by db to compensate.</span>
<span class="cm">	 * The &#39;+1&#39; avoids division by zero if db is very small.</span>
<span class="cm">	 */</span>
	<span class="n">dt</span> <span class="o">=</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt</span><span class="p">)</span> <span class="n">dt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">db</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_mark_cnt</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">))</span>
		<span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark_cnt</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">max_sectors</span> <span class="o">-</span> <span class="n">resync</span><span class="p">;</span>    <span class="cm">/* number of remaining sectors */</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">db</span><span class="o">/</span><span class="mi">32</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rt</span> <span class="o">*=</span> <span class="n">dt</span><span class="p">;</span>
	<span class="n">rt</span> <span class="o">&gt;&gt;=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; finish=%lu.%lumin&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rt</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
		   <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rt</span> <span class="o">%</span> <span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; speed=%ldK/sec&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">dt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">md_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span>
		<span class="cm">/* header */</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">all_mddevs</span><span class="p">);</span>
			<span class="n">mddev_get</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">;</span><span class="cm">/* tail */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">md_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">next_mddev</span><span class="p">,</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">all_mddevs</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">all_mddevs</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">all_mddevs</span><span class="p">)</span>
		<span class="n">next_mddev</span> <span class="o">=</span> <span class="n">mddev_get</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="k">struct</span> <span class="n">mddev</span><span class="p">,</span><span class="n">all_mddevs</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">next_mddev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="p">}</span>		
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mddevs_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next_mddev</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">pers</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Personalities : &quot;</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pers_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;[%s] &quot;</span><span class="p">,</span> <span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq</span><span class="o">-&gt;</span><span class="n">poll_event</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_unused</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev_lock</span><span class="p">(</span><span class="n">mddev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s : %sactive&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
						<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; (read-only)&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; (auto-read-only)&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %s[%d]&quot;</span><span class="p">,</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc_nr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteMostly</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(W)&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(F)&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(S)&quot;</span><span class="p">);</span> <span class="cm">/* spare */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(R)&quot;</span><span class="p">);</span>
			<span class="n">sectors</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">      %llu blocks&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
					   <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">      %llu blocks&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">persistent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">!=</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span><span class="s">&quot; super %d.%d&quot;</span><span class="p">,</span>
					   <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">,</span>
					   <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; super external:%s&quot;</span><span class="p">,</span>
				   <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">metadata_type</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; super non-persistent&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	 		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status_resync</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">resync=DELAYED</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;</span> <span class="n">MaxSector</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">resync=PENDING</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">       &quot;</span><span class="p">);</span>

		<span class="n">bitmap_status</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">md_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">md_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">md_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">md_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">md_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_seq_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">seq</span><span class="o">-&gt;</span><span class="n">poll_event</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mdstat_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_event_waiters</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* always allow read */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">poll_event</span> <span class="o">!=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_event_count</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLERR</span> <span class="o">|</span> <span class="n">POLLPRI</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">md_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>           <span class="o">=</span> <span class="n">md_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>           <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>         <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">mdstat_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">register_md_personality</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pers_list</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s personality registered for level %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">unregister_md_personality</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_personality</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s personality unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pers_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_mddev_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_events</span><span class="p">;</span>

	<span class="n">idle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
		<span class="n">curr_events</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">part_stat_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
			      <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">part_stat_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">part0</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
			      <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">sync_io</span><span class="p">);</span>
		<span class="cm">/* sync IO will cause sync_io to increase before the disk_stats</span>
<span class="cm">		 * as sync_io is counted when a request starts, and</span>
<span class="cm">		 * disk_stats is counted when it completes.</span>
<span class="cm">		 * So resync activity will cause curr_events to be smaller than</span>
<span class="cm">		 * when there was no such activity.</span>
<span class="cm">		 * non-sync IO will cause disk_stat to increase without</span>
<span class="cm">		 * increasing sync_io so curr_events will (eventually)</span>
<span class="cm">		 * be larger than it was before.  Once it becomes</span>
<span class="cm">		 * substantially larger, the test below will cause</span>
<span class="cm">		 * the array to appear non-idle, and resync will slow</span>
<span class="cm">		 * down.</span>
<span class="cm">		 * If there is a lot of outstanding resync activity when</span>
<span class="cm">		 * we set last_event to curr_events, then all that activity</span>
<span class="cm">		 * completing might cause the array to appear non-idle</span>
<span class="cm">		 * and resync will be slowed down even though there might</span>
<span class="cm">		 * not have been non-resync activity.  This will only</span>
<span class="cm">		 * happen once though.  &#39;last_events&#39; will soon reflect</span>
<span class="cm">		 * the state where there is little or no outstanding</span>
<span class="cm">		 * resync requests, and further resync activity will</span>
<span class="cm">		 * always make curr_events less than last_events.</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">||</span> <span class="n">curr_events</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_events</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">last_events</span> <span class="o">=</span> <span class="n">curr_events</span><span class="p">;</span>
			<span class="n">idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">idle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_done_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blocks</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* another &quot;blocks&quot; (512byte) blocks have been synced */</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>stop recovery, signal do_sync ....</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* md_write_start(mddev, bi)</span>
<span class="cm"> * If we need to update some array metadata (e.g. &#39;active&#39; flag</span>
<span class="cm"> * in superblock) before writing, schedule a superblock update</span>
<span class="cm"> * and wait for it to complete.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">md_write_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">did_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to switch to read/write */</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
		<span class="n">did_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
			<span class="n">did_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">did_change</span><span class="p">)</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span>
		   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_write_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* md_allow_write(mddev)</span>
<span class="cm"> * Calling this ensures that the array is marked &#39;active&#39; so that writes</span>
<span class="cm"> * may proceed without blocking.  It is important to call this before</span>
<span class="cm"> * attempting a GFP_KERNEL allocation while holding the mddev lock.</span>
<span class="cm"> * Must be called with mddev_lock held.</span>
<span class="cm"> *</span>
<span class="cm"> * In the -&gt;external case MD_CHANGE_CLEAN can not be cleared until mddev-&gt;lock</span>
<span class="cm"> * is dropped, so return -EAGAIN after notifying userspace.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">md_allow_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode_delay</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
		<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_allow_write</span><span class="p">);</span>

<span class="cp">#define SYNC_MARKS	10</span>
<span class="cp">#define	SYNC_MARK_STEP	(3*HZ)</span>
<span class="kt">void</span> <span class="nf">md_do_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">window</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_sectors</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">io_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mark</span><span class="p">[</span><span class="n">SYNC_MARKS</span><span class="p">];</span>
	<span class="n">sector_t</span> <span class="n">mark_cnt</span><span class="p">[</span><span class="n">SYNC_MARKS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">last_mark</span><span class="p">,</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">last_check</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>

	<span class="cm">/* just incase thread restarts... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span> <span class="cm">/* never try to sync a read-only array */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;data-check&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;requested-resync&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;resync&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;reshape&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;recovery&quot;</span><span class="p">;</span>

	<span class="cm">/* we overload curr_resync somewhat here.</span>
<span class="cm">	 * 0 == not engaged in resync at all</span>
<span class="cm">	 * 2 == checking that there is no conflict with another sync</span>
<span class="cm">	 * 1 == like 2, but have yielded to allow conflicting resync to</span>
<span class="cm">	 *		commense</span>
<span class="cm">	 * other == active in resync - this many blocks</span>
<span class="cm">	 *</span>
<span class="cm">	 * Before starting a resync we must have set curr_resync to</span>
<span class="cm">	 * 2, and then checked that every &quot;conflicting&quot; array has curr_resync</span>
<span class="cm">	 * less than ours.  When we find one that is the same or higher</span>
<span class="cm">	 * we wait on resync_wait.  To avoid deadlock, we reduce curr_resync</span>
<span class="cm">	 * to 1 if we choose to yield (based arbitrarily on address of mddev structure).</span>
<span class="cm">	 * This will mean we have to start checking from the beginning again.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="nl">try_again:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="n">for_each_mddev</span><span class="p">(</span><span class="n">mddev2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev2</span> <span class="o">==</span> <span class="n">mddev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">parallel_resync</span>
			<span class="o">&amp;&amp;</span>  <span class="n">mddev2</span><span class="o">-&gt;</span><span class="n">curr_resync</span>
			<span class="o">&amp;&amp;</span>  <span class="n">match_mddev_units</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">mddev2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span> <span class="o">&lt;</span> <span class="n">mddev2</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* arbitrarily yield */</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span> <span class="o">&gt;</span> <span class="n">mddev2</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="cm">/* no need to wait here, we can wait the next</span>
<span class="cm">					 * time &#39;round when curr_resync == 2</span>
<span class="cm">					 */</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* We need to wait &#39;interruptible&#39; so as not to</span>
<span class="cm">				 * contribute to the load average, and not to</span>
<span class="cm">				 * be caught by &#39;softlockup&#39;</span>
<span class="cm">				 */</span>
				<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
				    <span class="n">mddev2</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: delaying %s of %s&quot;</span>
					       <span class="s">&quot; until %s has finished (they&quot;</span>
					       <span class="s">&quot; share one or more physical units)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">desc</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev2</span><span class="p">));</span>
					<span class="n">mddev_put</span><span class="p">(</span><span class="n">mddev2</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
						<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
					<span class="n">schedule</span><span class="p">();</span>
					<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* resync follows the size requested by the personality,</span>
<span class="cm">		 * which defaults to physical size, but can be virtual size</span>
<span class="cm">		 */</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* we don&#39;t use the checkpoint if there&#39;s a bitmap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* recovery follows the physical size of devices */</span>
		<span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">;</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s of RAID array %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: minimum _guaranteed_  speed:&quot;</span>
		<span class="s">&quot; %d KB/sec/disk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed_min</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: using maximum available idle IO bandwidth &quot;</span>
	       <span class="s">&quot;(but not more than %d KB/sec) for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">speed_max</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">is_mddev_idle</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* this initializes IO event counters */</span>

	<span class="n">io_sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">SYNC_MARKS</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mark</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">mark_cnt</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">io_sectors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark</span> <span class="o">=</span> <span class="n">mark</span><span class="p">[</span><span class="n">last_mark</span><span class="p">];</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark_cnt</span> <span class="o">=</span> <span class="n">mark_cnt</span><span class="p">[</span><span class="n">last_mark</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tune reconstruction:</span>
<span class="cm">	 */</span>
	<span class="n">window</span> <span class="o">=</span> <span class="mi">32</span><span class="o">*</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">512</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: using %dk window, over a total of %lluk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">max_sectors</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">last_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
		       <span class="s">&quot;md: resuming %s of %s from checkpoint.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">desc</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>

		<span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">)</span>
		      <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
		     <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span>
			    <span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* time to update curr_resync_completed */</span>
			<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">,</span>
				   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* As this condition is controlled by user-space,</span>
<span class="cm">			 * we can block indefinitely, so use &#39;_interruptible&#39;</span>
<span class="cm">			 * to avoid triggering warnings.</span>
<span class="cm">			 */</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span> <span class="cm">/* just in case */</span>
			<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">,</span>
						 <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">&gt;</span> <span class="n">j</span>
						 <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">());</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">goto</span> <span class="n">interrupted</span><span class="p">;</span>

		<span class="n">sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skipped</span><span class="p">,</span>
						  <span class="n">currspeed</span> <span class="o">&lt;</span> <span class="n">speed_min</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skipped</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* actual IO requested */</span>
			<span class="n">io_sectors</span> <span class="o">+=</span> <span class="n">sectors</span><span class="p">;</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">j</span> <span class="o">+=</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_mark_cnt</span> <span class="o">=</span> <span class="n">io_sectors</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_check</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* this is the earliest that rebuild will be</span>
<span class="cm">			 * visible in /proc/mdstat</span>
<span class="cm">			 */</span>
			<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last_check</span> <span class="o">+</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="n">io_sectors</span> <span class="o">||</span> <span class="n">j</span> <span class="o">==</span> <span class="n">max_sectors</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">last_check</span> <span class="o">=</span> <span class="n">io_sectors</span><span class="p">;</span>
	<span class="nl">repeat:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">mark</span><span class="p">[</span><span class="n">last_mark</span><span class="p">]</span> <span class="o">+</span> <span class="n">SYNC_MARK_STEP</span> <span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* step marks */</span>
			<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_mark</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SYNC_MARKS</span><span class="p">;</span>

			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark</span> <span class="o">=</span> <span class="n">mark</span><span class="p">[</span><span class="n">next</span><span class="p">];</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark_cnt</span> <span class="o">=</span> <span class="n">mark_cnt</span><span class="p">[</span><span class="n">next</span><span class="p">];</span>
			<span class="n">mark</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">mark_cnt</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="o">=</span> <span class="n">io_sectors</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">);</span>
			<span class="n">last_mark</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">goto</span> <span class="n">interrupted</span><span class="p">;</span>


		<span class="cm">/*</span>
<span class="cm">		 * this loop exits only if either when we are slower than</span>
<span class="cm">		 * the &#39;hard&#39; speed limit, or the system was IO-idle for</span>
<span class="cm">		 * a jiffy.</span>
<span class="cm">		 * the system might be non-idle CPU-wise, but we only care</span>
<span class="cm">		 * about not overloading the IO subsystem. (things like an</span>
<span class="cm">		 * e2fsck being done on the RAID array should execute fast)</span>
<span class="cm">		 */</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">currspeed</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">io_sectors</span><span class="o">-</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark_cnt</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
			<span class="o">/</span><span class="p">((</span><span class="n">jiffies</span><span class="o">-</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mark</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currspeed</span> <span class="o">&gt;</span> <span class="n">speed_min</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">currspeed</span> <span class="o">&gt;</span> <span class="n">speed_max</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span> <span class="o">||</span>
					<span class="o">!</span><span class="n">is_mddev_idle</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s: %s done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">desc</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * this also signals &#39;finished resyncing&#39; to md_stop</span>
<span class="cm">	 */</span>
 <span class="nl">out:</span>
	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_active</span><span class="p">));</span>

	<span class="cm">/* tell personality that we are finished */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skipped</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;md: checkpointing %s of %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">desc</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
					<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span>
						<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">rdev_for_each_rcu</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">)</span>
					<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">;</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">skip:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We completed so min/max setting can be forgotten if used. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_min</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resync_wait</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">interrupted:</span>
	<span class="cm">/*</span>
<span class="cm">	 * got a signal, exit.</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;md: md_do_sync() got signal ... exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_and_add_spares</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_remove_disk</span><span class="p">(</span>
				    <span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">removed</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">removed</span><span class="p">)</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="s">&quot;degraded&quot;</span><span class="p">);</span>


	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">spares</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span>
			    <span class="n">hot_add_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
					<span class="cm">/* failure here is OK */</span><span class="p">;</span>
				<span class="n">spares</span><span class="o">++</span><span class="p">;</span>
				<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">spares</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reap_sync_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="cm">/* resync has finished, collect result */</span>
	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* success...*/</span>
		<span class="cm">/* activate any spares */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">spare_active</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="s">&quot;degraded&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">finish_reshape</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">finish_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="cm">/* If array is no-longer degraded, then any saved_raid_disk</span>
<span class="cm">	 * information must be scrapped.  Also if any device is now</span>
<span class="cm">	 * In_sync we must scrape the saved_raid_disk for that device</span>
<span class="cm">	 * do the superblock for an incrementally recovered device</span>
<span class="cm">	 * written out.</span>
<span class="cm">	 */</span>
	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="cm">/* flag recovery needed just to double check */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">.</span><span class="n">func</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is regularly called by all per-raid-array threads to</span>
<span class="cm"> * deal with generic issues like resync and super-block update.</span>
<span class="cm"> * Raid personalities that don&#39;t have a thread (linear/raid0) do not</span>
<span class="cm"> * need this as they never do any recovery or update the superblock.</span>
<span class="cm"> *</span>
<span class="cm"> * It does not do any resync itself, but rather &quot;forks&quot; off other threads</span>
<span class="cm"> * to do that as needed.</span>
<span class="cm"> * When it is determined that resync is needed, we set MD_RECOVERY_RUNNING in</span>
<span class="cm"> * &quot;-&gt;recovery&quot; and create a thread at -&gt;sync_thread.</span>
<span class="cm"> * When the thread finishes it sets MD_RECOVERY_DONE</span>
<span class="cm"> * and wakeups up this thread which will reap the thread and finish up.</span>
<span class="cm"> * This thread also removes any faulty devices (with nr_pending == 0).</span>
<span class="cm"> *</span>
<span class="cm"> * The overall approach is:</span>
<span class="cm"> *  1/ if the superblock needs updating, update it.</span>
<span class="cm"> *  2/ If a recovery thread is running, don&#39;t do anything else.</span>
<span class="cm"> *  3/ If recovery has finished, clean up, possibly marking spares active.</span>
<span class="cm"> *  4/ If there are any faulty devices, remove them.</span>
<span class="cm"> *  5/ If array is degraded, try to add spares devices</span>
<span class="cm"> *  6/ If array has spares or is not in-sync, start a resync thread.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">md_check_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span>
		<span class="n">bitmap_daemon_work</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: %s in immediate safe mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span>
		<span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_CHANGE_PENDING</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev_trylock</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">spares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Only thing we do on a ro array is remove</span>
<span class="cm">			 * failed devices.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">hot_remove_disk</span><span class="p">(</span>
						    <span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">sysfs_unlink_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">did_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">writes_pending</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">in_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">did_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">did_change</span><span class="p">)</span>
				<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			<span class="n">md_update_sb</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* resync/recovery still happening */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reap_sync_thread</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set RUNNING before clearing NEEDED to avoid</span>
<span class="cm">		 * any transients in the value of &quot;sync_action&quot;.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="cm">/* Clear some bits that don&#39;t mean anything, but</span>
<span class="cm">		 * might be left set</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_FROZEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="cm">/* no recovery is running.</span>
<span class="cm">		 * remove any failed drives, then</span>
<span class="cm">		 * add spares if possible.</span>
<span class="cm">		 * Spare are also removed and re-added, to allow</span>
<span class="cm">		 * the personality to fail the re-add.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* Cannot proceed */</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">spares</span> <span class="o">=</span> <span class="n">remove_and_add_spares</span><span class="p">(</span><span class="n">mddev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
			<span class="cm">/* nothing to be done ... */</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="o">-&gt;</span><span class="n">sync_request</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spares</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We are adding a device or devices to an array</span>
<span class="cm">				 * which has the bitmap stored on all devices.</span>
<span class="cm">				 * So make sure all bitmap pages get written</span>
<span class="cm">				 */</span>
				<span class="n">bitmap_write_all</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">,</span>
								<span class="n">mddev</span><span class="p">,</span>
								<span class="s">&quot;resync&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: could not start resync&quot;</span>
					<span class="s">&quot; thread...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
				<span class="cm">/* leave the spares where they are, it shouldn&#39;t hurt */</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
			<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="nl">unlock:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">)</span>
					<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sysfs_action</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">md_wait_for_blocked_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">blocked_wait</span><span class="p">,</span>
			   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>
	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_wait_for_blocked_rdev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">md_finish_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* called be personality module when reshape completes. */</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">-=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_finish_reshape</span><span class="p">);</span>

<span class="cm">/* Bad block management.</span>
<span class="cm"> * We can record which blocks on each device are &#39;bad&#39; and so just</span>
<span class="cm"> * fail those blocks, or that stripe, rather than the whole device.</span>
<span class="cm"> * Entries in the bad-block table are 64bits wide.  This comprises:</span>
<span class="cm"> * Length of bad-range, in sectors: 0-511 for lengths 1-512</span>
<span class="cm"> * Start of bad-range, sector offset, 54 bits (allows 8 exbibytes)</span>
<span class="cm"> *  A &#39;shift&#39; can be set so that larger blocks are tracked and</span>
<span class="cm"> *  consequently larger devices can be covered.</span>
<span class="cm"> * &#39;Acknowledged&#39; flag - 1 bit. - the most significant bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking of the bad-block table uses a seqlock so md_is_badblock</span>
<span class="cm"> * might need to retry if it is very unlucky.</span>
<span class="cm"> * We will sometimes want to check for bad blocks in a bi_end_io function,</span>
<span class="cm"> * so we use the write_seqlock_irq variant.</span>
<span class="cm"> *</span>
<span class="cm"> * When looking for a bad block we specify a range and want to</span>
<span class="cm"> * know if any block in the range is bad.  So we binary-search</span>
<span class="cm"> * to the last range that starts at-or-before the given endpoint,</span>
<span class="cm"> * (or &quot;before the sector after the target range&quot;)</span>
<span class="cm"> * then see if it ends after the given start.</span>
<span class="cm"> * We return</span>
<span class="cm"> *  0 if there are no known bad blocks in the range</span>
<span class="cm"> *  1 if there are known bad block which are all acknowledged</span>
<span class="cm"> * -1 if there are bad blocks which have not yet been acknowledged in metadata.</span>
<span class="cm"> * plus the start/length of the first bad section we overlap.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">md_is_badblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span>
		   <span class="n">sector_t</span> <span class="o">*</span><span class="n">first_bad</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bad_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* round the start down, and the end up */</span>
		<span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">target</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">target</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;target&#39; is now the first block after the bad range */</span>

<span class="nl">retry:</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hi</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Binary search between lo and hi for &#39;target&#39;</span>
<span class="cm">	 * i.e. for the last range that starts before &#39;target&#39;</span>
<span class="cm">	 */</span>
	<span class="cm">/* INVARIANT: ranges before &#39;lo&#39; and at-or-after &#39;hi&#39;</span>
<span class="cm">	 * are known not to be the last range before target.</span>
<span class="cm">	 * VARIANT: hi-lo is the number of possible</span>
<span class="cm">	 * ranges, and decreases until it reaches 1</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">mid</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">)</span>
			<span class="cm">/* This could still be the one, earlier ranges</span>
<span class="cm">			 * could not. */</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* This and later ranges are definitely out. */</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* &#39;lo&#39; might be the last that started before target, but &#39;hi&#39; isn&#39;t */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need to check all range that end after &#39;s&#39; to see if</span>
<span class="cm">		 * any are unacknowledged.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		       <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* starts before the end, and finishes after</span>
<span class="cm">				 * the start, so they must overlap</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]))</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">first_bad</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">bad_sectors</span> <span class="o">=</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">lo</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_is_badblock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Add a range of bad blocks to the table.</span>
<span class="cm"> * This might extend the table, or might contract it</span>
<span class="cm"> * if two adjacent ranges can be merged.</span>
<span class="cm"> * We binary-search to find the &#39;insertion&#39; point, then</span>
<span class="cm"> * decide how best to handle it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_set_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">acknowledged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* badblocks are disabled */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* round the start down, and the end up */</span>
		<span class="n">sector_t</span> <span class="n">next</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">next</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_seqlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="cm">/* Find the last range that starts at-or-before &#39;s&#39; */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">mid</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="p">)</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span> <span class="o">&amp;&amp;</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we found a range that might merge with the start</span>
<span class="cm">		 * of our new range</span>
<span class="cm">		 */</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
		<span class="n">sector_t</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Yes, we can merge with a previous range */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="p">)</span>
				<span class="cm">/* new range covers old */</span>
				<span class="n">ack</span> <span class="o">=</span> <span class="n">acknowledged</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">acknowledged</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">)</span>
				<span class="n">e</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">BB_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* does not all fit in one range,</span>
<span class="cm">				 * make p[lo] maximal</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">!=</span> <span class="n">BB_MAX_LEN</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">BB_MAX_LEN</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">BB_MAX_LEN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&amp;&amp;</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;hi&#39; points to the first range that starts after &#39;s&#39;.</span>
<span class="cm">		 * Maybe we can merge with the start of that range */</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
		<span class="n">sector_t</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* merging is possible */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* full overlap */</span>
				<span class="n">e</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
				<span class="n">ack</span> <span class="o">=</span> <span class="n">acknowledged</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ack</span> <span class="o">=</span> <span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">acknowledged</span><span class="p">;</span>

			<span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">BB_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">BB_MAX_LEN</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">BB_MAX_LEN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sectors</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
			<span class="n">hi</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we might be able to combine lo and hi */</span>
		<span class="cm">/* Note: &#39;s&#39; is at the end of &#39;lo&#39; */</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">lolen</span> <span class="o">=</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">hilen</span> <span class="o">=</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">newlen</span> <span class="o">=</span> <span class="n">lolen</span> <span class="o">+</span> <span class="n">hilen</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">newlen</span> <span class="o">&lt;</span> <span class="n">BB_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* yes, we can combine them */</span>
			<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]);</span>
			<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]),</span> <span class="n">newlen</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">hi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t merge (it all).</span>
<span class="cm">		 * Need to add a range just before &#39;hi&#39; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MD_MAX_BADBLOCKS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No room for more */</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">this_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">hi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">this_sectors</span> <span class="o">&gt;</span> <span class="n">BB_MAX_LEN</span><span class="p">)</span>
				<span class="n">this_sectors</span> <span class="o">=</span> <span class="n">BB_MAX_LEN</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">this_sectors</span><span class="p">,</span> <span class="n">acknowledged</span><span class="p">);</span>
			<span class="n">sectors</span> <span class="o">-=</span> <span class="n">this_sectors</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">+=</span> <span class="n">this_sectors</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acknowledged</span><span class="p">)</span>
		<span class="n">bb</span><span class="o">-&gt;</span><span class="n">unacked_exist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_sequnlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rdev_set_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">is_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_new</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">md_set_badblocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span>
			      <span class="n">s</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure they get written out promptly */</span>
		<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_CLEAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rdev_set_badblocks</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Remove a range of bad blocks from the table.</span>
<span class="cm"> * This may involve extending the table if we spilt a region,</span>
<span class="cm"> * but it must not fail.  So if the table becomes full, we just</span>
<span class="cm"> * drop the remove request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_clear_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* When clearing we round the start up and the end down.</span>
<span class="cm">		 * This should not matter as the shift should align with</span>
<span class="cm">		 * the block size and no rounding should ever be needed.</span>
<span class="cm">		 * However it is better the think a block is bad when it</span>
<span class="cm">		 * isn&#39;t than to think a block is not bad when it is.</span>
<span class="cm">		 */</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">target</span> <span class="o">&gt;&gt;=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_seqlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="cm">/* Find the last range that starts before &#39;target&#39; */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">mid</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">)</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* p[lo] is the last range that could overlap the</span>
<span class="cm">		 * current range.  Earlier ranges could also overlap,</span>
<span class="cm">		 * but only this one can overlap the end of the range.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Partial overlap, leave the tail of this range */</span>
			<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
			<span class="n">sector_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
			<span class="n">sector_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we need to split this range */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MD_MAX_BADBLOCKS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memmove</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">lo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">lo</span><span class="p">,</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="n">lo</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">target</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
			<span class="cm">/* there is no longer an overlap */</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>
			<span class="n">lo</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		       <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">+</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This range does overlap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Keep the early parts of this range. */</span>
				<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
				<span class="n">sector_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]);</span>
				<span class="n">p</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
				<span class="cm">/* now low doesn&#39;t overlap, so.. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lo</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* &#39;lo&#39; is strictly before, &#39;hi&#39; is strictly after,</span>
<span class="cm">		 * anything between needs to be discarded</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">lo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">hi</span><span class="p">,</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="n">hi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">write_sequnlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rdev_clear_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">is_new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_new</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">md_clear_badblocks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">badblocks</span><span class="p">,</span>
				  <span class="n">s</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rdev_clear_badblocks</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Acknowledge all bad blocks in a list.</span>
<span class="cm"> * This only succeeds if -&gt;changed is clear.  It is used by</span>
<span class="cm"> * in-kernel metadata updates</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">md_ack_all_badblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span><span class="p">)</span>
		<span class="cm">/* no point even trying */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">write_seqlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">unacked_exist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">sector_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BB_MAKE</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bb</span><span class="o">-&gt;</span><span class="n">unacked_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_sequnlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_ack_all_badblocks</span><span class="p">);</span>

<span class="cm">/* sysfs access to bad-blocks list.</span>
<span class="cm"> * We present two files.</span>
<span class="cm"> * &#39;bad-blocks&#39; lists sector numbers and lengths of ranges that</span>
<span class="cm"> *    are recorded as bad.  The list is truncated to fit within</span>
<span class="cm"> *    the one-page limit of sysfs.</span>
<span class="cm"> *    Writing &quot;sector length&quot; to this file adds an acknowledged</span>
<span class="cm"> *    bad block list.</span>
<span class="cm"> * &#39;unacknowledged-bad-blocks&#39; lists bad blocks that have not yet</span>
<span class="cm"> *    been acknowledged.  Writing to this file adds bad blocks</span>
<span class="cm"> *    without acknowledging them.  This is largely for testing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">badblocks_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">BB_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">BB_LEN</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="n">BB_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unack</span> <span class="o">&amp;&amp;</span> <span class="n">ack</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%llu %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">,</span>
				<span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="n">bb</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unack</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bb</span><span class="o">-&gt;</span><span class="n">unacked_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DO_DEBUG 1</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">badblocks_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">badblocks</span> <span class="o">*</span><span class="n">bb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">newline</span><span class="p">;</span>
<span class="cp">#ifdef DO_DEBUG</span>
	<span class="cm">/* Allow clearing via sysfs *only* for testing/debugging.</span>
<span class="cm">	 * Normally only a successful write may clear a badblock</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DO_DEBUG */</span><span class="cp"></span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%llu %d%c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newline</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DO_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md_clear_badblocks</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DO_DEBUG */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md_set_badblocks</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">!</span><span class="n">unack</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">md_notify_reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_mddev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev_trylock</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
				<span class="n">__md_stop_writes</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">safemode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">mddev_unlock</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">need_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * certain more exotic SCSI devices are known to be</span>
<span class="cm">	 * volatile wrt too early system reboots. While the</span>
<span class="cm">	 * right place to handle this issue is the given</span>
<span class="cm">	 * driver, we do want to have a safe RAID driver ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_delay</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">md_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">md_notify_reboot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span>	<span class="o">=</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="cm">/* before any real devices */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">md_geninit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;md: sizeof(mdp_super_t) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mdp_super_t</span><span class="p">));</span>

	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;mdstat&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md_seq_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">md_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">md_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;md&quot;</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md_wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wq</span><span class="p">;</span>

	<span class="n">md_misc_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;md_misc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md_misc_wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_misc_wq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span> <span class="s">&quot;md&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_md</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;mdp&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mdp</span><span class="p">;</span>
	<span class="n">mdp_major</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">blk_register_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">MINORBITS</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			    <span class="n">md_probe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">blk_register_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">mdp_major</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="n">MINORBITS</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			    <span class="n">md_probe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_notifier</span><span class="p">);</span>
	<span class="n">raid_table_header</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">raid_root_table</span><span class="p">);</span>

	<span class="n">md_geninit</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mdp:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span> <span class="s">&quot;md&quot;</span><span class="p">);</span>
<span class="nl">err_md:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">);</span>
<span class="nl">err_misc_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">md_wq</span><span class="p">);</span>
<span class="nl">err_wq:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/*</span>
<span class="cm"> * Searches all registered partitions for autorun RAID arrays</span>
<span class="cm"> * at boot time.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">all_detected_devices</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">detected_devices_node</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">md_autodetect_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">detected_devices_node</span> <span class="o">*</span><span class="n">node_detected_dev</span><span class="p">;</span>

	<span class="n">node_detected_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node_detected_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node_detected_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node_detected_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_detected_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_detected_devices</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;md: md_autodetect_dev: kzalloc failed&quot;</span>
			<span class="s">&quot;, skipping dev(%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">autostart_arrays</span><span class="p">(</span><span class="kt">int</span> <span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">detected_devices_node</span> <span class="o">*</span><span class="n">node_detected_dev</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i_scanned</span><span class="p">,</span> <span class="n">i_passed</span><span class="p">;</span>

	<span class="n">i_scanned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i_passed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: Autodetecting RAID arrays.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_detected_devices</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i_scanned</span> <span class="o">&lt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i_scanned</span><span class="o">++</span><span class="p">;</span>
		<span class="n">node_detected_dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">all_detected_devices</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">detected_devices_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_detected_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">node_detected_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">node_detected_dev</span><span class="p">);</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">md_import_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MD_BUG</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AutoDetected</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">same_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_raid_disks</span><span class="p">);</span>
		<span class="n">i_passed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md: Scanned %d and added %d devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i_scanned</span><span class="p">,</span> <span class="n">i_passed</span><span class="p">);</span>

	<span class="n">autorun_devices</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">md_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">MINORBITS</span><span class="p">);</span>
	<span class="n">blk_unregister_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">mdp_major</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">MINORBITS</span><span class="p">);</span>

	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">,</span><span class="s">&quot;md&quot;</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">mdp_major</span><span class="p">,</span> <span class="s">&quot;mdp&quot;</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md_notifier</span><span class="p">);</span>
	<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">raid_table_header</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;mdstat&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">for_each_mddev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">export_array</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">hold_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">md_misc_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">md_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">md_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">md_exit</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_ro</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">start_readonly</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_ro</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">e</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_readonly</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">start_ro</span><span class="p">,</span> <span class="n">set_ro</span><span class="p">,</span> <span class="n">get_ro</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">start_dirty_degraded</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">new_array</span><span class="p">,</span> <span class="n">add_named_array</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_md_personality</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_md_personality</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_error</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_done_sync</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_write_start</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_write_end</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_register_thread</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_unregister_thread</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_wakeup_thread</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">md_check_recovery</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MD RAID framework&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">MD_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
