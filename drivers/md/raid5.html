<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › md › raid5.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>raid5.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * raid5.c : Multiple Devices driver for Linux</span>
<span class="cm"> *	   Copyright (C) 1996, 1997 Ingo Molnar, Miguel de Icaza, Gadi Oxman</span>
<span class="cm"> *	   Copyright (C) 1999, 2000 Ingo Molnar</span>
<span class="cm"> *	   Copyright (C) 2002, 2003 H. Peter Anvin</span>
<span class="cm"> *</span>
<span class="cm"> * RAID-4/5/6 management functions.</span>
<span class="cm"> * Thanks to Penguin Computing for making the RAID-6 development possible</span>
<span class="cm"> * by donating a test server!</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * (for example /usr/src/linux/COPYING); if not, write to the Free</span>
<span class="cm"> * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * BITMAP UNPLUGGING:</span>
<span class="cm"> *</span>
<span class="cm"> * The sequencing for updating the bitmap reliably is a little</span>
<span class="cm"> * subtle (and I got it wrong the first time) so it deserves some</span>
<span class="cm"> * explanation.</span>
<span class="cm"> *</span>
<span class="cm"> * We group bitmap updates into batches.  Each batch has a number.</span>
<span class="cm"> * We may write out several batches at once, but that isn&#39;t very important.</span>
<span class="cm"> * conf-&gt;seq_write is the number of the last batch successfully written.</span>
<span class="cm"> * conf-&gt;seq_flush is the number of the last batch that was closed to</span>
<span class="cm"> *    new additions.</span>
<span class="cm"> * When we discover that we will need to write to any block in a stripe</span>
<span class="cm"> * (in add_stripe_bio) we update the in-memory bitmap and record in sh-&gt;bm_seq</span>
<span class="cm"> * the number of the batch it will be in. This is seq_flush+1.</span>
<span class="cm"> * When we are ready to do a write, if that batch hasn&#39;t been written yet,</span>
<span class="cm"> *   we plug the array and queue the stripe for later.</span>
<span class="cm"> * When an unplug happens, we increment bm_flush, thus closing the current</span>
<span class="cm"> *   batch.</span>
<span class="cm"> * When we notice that bm_flush &gt; bm_write, we write out all pending updates</span>
<span class="cm"> * to the bitmap, and advance bm_write to where bm_flush was.</span>
<span class="cm"> * This may occasionally write a bit out twice, but is sure never to</span>
<span class="cm"> * miss any bits.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/raid/pq.h&gt;</span>
<span class="cp">#include &lt;linux/async_tx.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/async.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &quot;md.h&quot;</span>
<span class="cp">#include &quot;raid5.h&quot;</span>
<span class="cp">#include &quot;raid0.h&quot;</span>
<span class="cp">#include &quot;bitmap.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Stripe cache</span>
<span class="cm"> */</span>

<span class="cp">#define NR_STRIPES		256</span>
<span class="cp">#define STRIPE_SIZE		PAGE_SIZE</span>
<span class="cp">#define STRIPE_SHIFT		(PAGE_SHIFT - 9)</span>
<span class="cp">#define STRIPE_SECTORS		(STRIPE_SIZE&gt;&gt;9)</span>
<span class="cp">#define	IO_THRESHOLD		1</span>
<span class="cp">#define BYPASS_THRESHOLD	1</span>
<span class="cp">#define NR_HASH			(PAGE_SIZE / sizeof(struct hlist_head))</span>
<span class="cp">#define HASH_MASK		(NR_HASH - 1)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="nf">stripe_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">sect</span> <span class="o">&gt;&gt;</span> <span class="n">STRIPE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HASH_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">stripe_hashtbl</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* bio&#39;s attached to a stripe+device for I/O are linked together in bi_sector</span>
<span class="cm"> * order without overlap.  There may be several bio&#39;s per stripe+device, and</span>
<span class="cm"> * a bio could span several devices.</span>
<span class="cm"> * When walking this list for a particular stripe+device, we must never proceed</span>
<span class="cm"> * beyond a bio that extends past this device, as the next bio might no longer</span>
<span class="cm"> * be valid.</span>
<span class="cm"> * This function is used to determine the &#39;next&#39; bio in the list, given the sector</span>
<span class="cm"> * of the current stripe+device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">r5_next_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We maintain a biased count of active stripes in the bottom 16 bits of</span>
<span class="cm"> * bi_phys_segments, and a count of processed stripes in the upper 16 bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid5_bi_phys_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid5_bi_hw_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">--</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">raid5_bi_phys_segments</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid5_dec_bi_hw_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="n">raid5_bi_hw_segments</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="o">--</span><span class="n">val</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">raid5_bi_phys_segments</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">raid5_set_bi_hw_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="n">raid5_bi_phys_segments</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find first data disk in a raid6 stripe */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid6_d0</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span><span class="p">)</span>
		<span class="cm">/* ddf always start from first device */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* md starts just after Q block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raid6_next_disk</span><span class="p">(</span><span class="kt">int</span> <span class="n">disk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disk</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">disk</span> <span class="o">&lt;</span> <span class="n">raid_disks</span><span class="p">)</span> <span class="o">?</span> <span class="n">disk</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When walking through the disks in a raid5, starting at raid6_d0,</span>
<span class="cm"> * We need to map each disk to a &#39;slot&#39;, where the data disks are slot</span>
<span class="cm"> * 0 .. raid_disks-3, the parity disk is raid_disks-2 and the Q disk</span>
<span class="cm"> * is raid_disks-1.  This help does that mapping.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid6_idx_to_slot</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">syndrome_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="o">*</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">syndrome_disks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">syndrome_disks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">return_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">return_bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span> <span class="o">=</span> <span class="n">return_bi</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">return_bi</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">return_bi</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">print_raid5_conf</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stripe_operations_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">||</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_BIOFILL_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__release_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">delayed_list</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_BIT_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="n">sh</span><span class="o">-&gt;</span><span class="n">bm_seq</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">seq_write</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bitmap_list</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_BIT_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">handle_list</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stripe_operations_active</span><span class="p">(</span><span class="n">sh</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">)</span>
				    <span class="o">&lt;</span> <span class="n">IO_THRESHOLD</span><span class="p">)</span>
					<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">);</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned</span><span class="p">)</span>
					<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__release_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;remove_hash(), stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">hlist_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">insert_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">stripe_hash</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;insert_hash(), stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* find an idle stripe, make sure it is unhashed, and return it. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="nf">get_free_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
	<span class="n">remove_hash</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shrink_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grow_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">raid5_build_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">stripe_set_idx</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">stripe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stripe_operations_active</span><span class="p">(</span><span class="n">sh</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;init_stripe called, stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">remove_hash</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">-</span> <span class="n">previous</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">stripe_set_idx</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sector=%llx i=%d %p %p %p %p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">,</span>
			       <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">raid5_build_block</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">insert_hash</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="nf">__find_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
					 <span class="kt">short</span> <span class="n">generation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">hn</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;__find_stripe, sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">hn</span><span class="p">,</span> <span class="n">stripe_hash</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector</span><span class="p">),</span> <span class="n">hash</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sector</span> <span class="o">&amp;&amp;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">generation</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;__stripe %llu not in cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Need to check if array has failed when deciding whether to:</span>
<span class="cm"> *  - start an array</span>
<span class="cm"> *  - remove non-faulty devices</span>
<span class="cm"> *  - add a spare</span>
<span class="cm"> *  - allow a reshape</span>
<span class="cm"> * This determination is simple when no reshape is happening.</span>
<span class="cm"> * However if there is a reshape, we need to carefully check</span>
<span class="cm"> * both the before and after sections.</span>
<span class="cm"> * This is because some failed devices may only affect one</span>
<span class="cm"> * of the two sections, and some non-in_sync devices may</span>
<span class="cm"> * be insync in the section most affected by failed devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">calc_degraded</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">degraded</span><span class="p">,</span> <span class="n">degraded2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* not in-sync or faulty.</span>
<span class="cm">			 * If the reshape increases the number of devices,</span>
<span class="cm">			 * this is being recovered by the reshape, so</span>
<span class="cm">			 * this &#39;previous&#39; section is not in_sync.</span>
<span class="cm">			 * If the number of devices is being reduced however,</span>
<span class="cm">			 * the device can only be part of the array if</span>
<span class="cm">			 * we are reverting a reshape, so this section will</span>
<span class="cm">			 * be in-sync.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">)</span>
				<span class="n">degraded</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">degraded</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">degraded2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">degraded2</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* not in-sync or faulty.</span>
<span class="cm">			 * If reshape increases the number of devices, this</span>
<span class="cm">			 * section has already been recovered, else it</span>
<span class="cm">			 * almost certainly hasn&#39;t.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&lt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">)</span>
				<span class="n">degraded2</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">degraded2</span> <span class="o">&gt;</span> <span class="n">degraded</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">degraded2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">degraded</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">has_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">degraded</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>

	<span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span>
<span class="nf">get_active_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">previous</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">noquiesce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;get_stripe, sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">,</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">noquiesce</span><span class="p">,</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="cm">/* nothing */</span><span class="p">);</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">__find_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">-</span> <span class="n">previous</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_blocked</span><span class="p">)</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="n">get_free_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">noblock</span> <span class="o">&amp;&amp;</span> <span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_blocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">,</span>
						    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">)</span>
						     <span class="o">&lt;</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span> <span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
						     <span class="o">||</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_blocked</span><span class="p">),</span>
						    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span>
						    <span class="p">);</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">init_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sh</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Determine if &#39;data_offset&#39; or &#39;new_data_offset&#39; should be used</span>
<span class="cm"> * in this stripe_head.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">use_new_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="cm">/* Need a memory barrier to make sure we see the value</span>
<span class="cm">	 * of conf-&gt;generation, or -&gt;data_offset that was set before</span>
<span class="cm">	 * reshape_progress was updated.</span>
<span class="cm">	 */</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* We are in a reshape, and this is a new-generation stripe,</span>
<span class="cm">	 * so use new_data_offset.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">raid5_end_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">raid5_end_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_run_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rw</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">replace_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="o">*</span><span class="n">rbi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="o">*</span><span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_WantFUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">rw</span> <span class="o">=</span> <span class="n">WRITE_FUA</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_WantReplace</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
			<span class="n">replace_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_SyncIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rw</span> <span class="o">|=</span> <span class="n">REQ_SYNC</span><span class="p">;</span>

		<span class="n">bi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">;</span>
		<span class="n">rbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rreq</span><span class="p">;</span> <span class="cm">/* For writing to replacement */</span>

		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">rw</span><span class="p">;</span>
		<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">rw</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid5_end_write_request</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid5_end_write_request</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">raid5_end_read_request</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">rrdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span> <span class="cm">/* Ensure that if rrdev is NULL, rdev won&#39;t be */</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rrdev</span><span class="p">;</span>
			<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">replace_only</span><span class="p">)</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">rrdev</span><span class="p">)</span>
				<span class="cm">/* We raced and saw duplicates */</span>
				<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rrdev</span><span class="p">)</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">rrdev</span><span class="p">;</span>
			<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rrdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="cm">/* We have already checked bad blocks for reads.  Now</span>
<span class="cm">		 * need to check for writes.  We never accept write errors</span>
<span class="cm">		 * on the replacement, so we don&#39;t to check rrdev.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span> <span class="o">&amp;&amp;</span>
		       <span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bad</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span> <span class="o">&amp;&amp;</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* It is very unlikely, but we might</span>
<span class="cm">					 * still need to write out the</span>
<span class="cm">					 * bad block log - better give it</span>
<span class="cm">					 * a chance*/</span>
					<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * Because md_wait_for_blocked_rdev</span>
<span class="cm">				 * will dec nr_pending, we must</span>
<span class="cm">				 * increment it first.</span>
<span class="cm">				 */</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
				<span class="n">md_wait_for_blocked_rdev</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Acknowledged bad block - skip the write */</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">expanding</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">expanded</span>
			    <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">replacing</span><span class="p">)</span>
				<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_IO_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: for %llu schedule op %ld on disc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_new_offset</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">))</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span>
						 <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span>
						 <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">STRIPE_SIZE</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">STRIPE_SIZE</span><span class="p">;</span>
			<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_DOUBLE_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">expanding</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">expanded</span>
			    <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">replacing</span><span class="p">)</span>
				<span class="n">md_sync_acct</span><span class="p">(</span><span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_IO_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: for %llu schedule op %ld on &quot;</span>
				 <span class="s">&quot;replacement disc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_new_offset</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">))</span>
				<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span>
						  <span class="o">+</span> <span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span>
						  <span class="o">+</span> <span class="n">rrdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_UPTODATE</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bv_len</span> <span class="o">=</span> <span class="n">STRIPE_SIZE</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">=</span> <span class="n">STRIPE_SIZE</span><span class="p">;</span>
			<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">generic_make_request</span><span class="p">(</span><span class="n">rbi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rrdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_DEGRADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;skip op %ld on disc %d for sector %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">async_copy_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">frombio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">bio_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">async_tx_flags</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&gt;=</span> <span class="n">sector</span><span class="p">)</span>
		<span class="n">page_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">-</span> <span class="n">sector</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">page_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)(</span><span class="n">sector</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">512</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frombio</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_TX_FENCE</span><span class="p">;</span>
	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvl</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">bvl</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">clen</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">b_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">page_offset</span><span class="p">;</span>
			<span class="n">page_offset</span> <span class="o">+=</span> <span class="n">b_offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">b_offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">page_offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">STRIPE_SIZE</span><span class="p">)</span>
			<span class="n">clen</span> <span class="o">=</span> <span class="n">STRIPE_SIZE</span> <span class="o">-</span> <span class="n">page_offset</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b_offset</span> <span class="o">+=</span> <span class="n">bvl</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
			<span class="n">bio_page</span> <span class="o">=</span> <span class="n">bvl</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frombio</span><span class="p">)</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">async_memcpy</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">bio_page</span><span class="p">,</span> <span class="n">page_offset</span><span class="p">,</span>
						  <span class="n">b_offset</span><span class="p">,</span> <span class="n">clen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">async_memcpy</span><span class="p">(</span><span class="n">bio_page</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">b_offset</span><span class="p">,</span>
						  <span class="n">page_offset</span><span class="p">,</span> <span class="n">clen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* chain the operations */</span>
		<span class="n">submit</span><span class="p">.</span><span class="n">depend_tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="cm">/* hit end of page */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">page_offset</span> <span class="o">+=</span>  <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_complete_biofill</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">stripe_head_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">stripe_head_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">return_bi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="cm">/* clear completed biofills */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* acknowledge completion of a biofill operation */</span>
		<span class="cm">/* and check if we need to reply to a read request,</span>
<span class="cm">		 * new R5_Wantfill requests are held off until</span>
<span class="cm">		 * !STRIPE_BIOFILL_RUN</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Wantfill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">rbi</span><span class="p">,</span> <span class="o">*</span><span class="n">rbi2</span><span class="p">;</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">);</span>
			<span class="n">rbi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">rbi</span> <span class="o">&amp;&amp;</span> <span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rbi2</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">rbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">rbi</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">return_bi</span><span class="p">;</span>
					<span class="n">return_bi</span> <span class="o">=</span> <span class="n">rbi</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rbi</span> <span class="o">=</span> <span class="n">rbi2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_BIOFILL_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">return_io</span><span class="p">(</span><span class="n">return_bi</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_run_biofill</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantfill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">rbi</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rbi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">rbi</span> <span class="o">&amp;&amp;</span> <span class="n">rbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">async_copy_data</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
				<span class="n">rbi</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">rbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_ACK</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ops_complete_biofill</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">async_trigger_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_target_uptodate</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_complete_compute</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">stripe_head_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">stripe_head_ref</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="cm">/* mark the computed target(s) as uptodate */</span>
	<span class="n">mark_target_uptodate</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
	<span class="n">mark_target_uptodate</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_compute_run</span><span class="p">)</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_compute_result</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* return a pointer to the address conversion region of the scribble buffer */</span>
<span class="k">static</span> <span class="n">addr_conv_t</span> <span class="o">*</span><span class="nf">to_addr_conv</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ops_run_compute5</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">xor_srcs</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">xor_dest</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu block: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span>
			<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="o">|</span><span class="n">ASYNC_TX_XOR_ZERO_DST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_memcpy</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set_syndrome_sources - populate source buffers for gen_syndrome</span>
<span class="cm"> * @srcs - (struct page *) array of size sh-&gt;disks</span>
<span class="cm"> * @sh - stripe_head to parse</span>
<span class="cm"> *</span>
<span class="cm"> * Populates srcs in proper layout order for the stripe and returns the</span>
<span class="cm"> * &#39;count&#39; of sources to be used in a call to async_gen_syndrome.  The P</span>
<span class="cm"> * destination buffer is recorded in srcs[count] and the Q destination</span>
<span class="cm"> * is recorded in srcs[count+1]].</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_syndrome_sources</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">srcs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syndrome_disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span> <span class="o">?</span> <span class="n">disks</span> <span class="o">:</span> <span class="p">(</span><span class="n">disks</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">d0_idx</span> <span class="o">=</span> <span class="n">raid6_d0</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">d0_idx</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">raid6_idx_to_slot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="n">syndrome_disks</span><span class="p">);</span>

		<span class="n">srcs</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">raid6_next_disk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">d0_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">syndrome_disks</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ops_run_compute6_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* we should only have one valid target */</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu block: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">dest</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">set_syndrome_sources</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
		<span class="n">blocks</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* regenerating p is not necessary */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dest</span><span class="p">);</span> <span class="cm">/* q should already be set */</span>
		<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
				  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_gen_syndrome</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Compute any data- or p-drive using XOR */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">target</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">blocks</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="o">|</span><span class="n">ASYNC_TX_XOR_ZERO_DST</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
				  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ops_run_compute6_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syndrome_disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span> <span class="o">?</span> <span class="n">disks</span> <span class="o">:</span> <span class="n">disks</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d0_idx</span> <span class="o">=</span> <span class="n">raid6_d0</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">faila</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">failb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target2</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">tgt2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">target2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu block1: %d block2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target2</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">target2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="cm">/* we need to open-code set_syndrome_sources to handle the</span>
<span class="cm">	 * slot number conversion for &#39;faila&#39; and &#39;failb&#39;</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">d0_idx</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">raid6_idx_to_slot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="n">syndrome_disks</span><span class="p">);</span>

		<span class="n">blocks</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span>
			<span class="n">faila</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">target2</span><span class="p">)</span>
			<span class="n">failb</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">raid6_next_disk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">d0_idx</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">faila</span> <span class="o">==</span> <span class="n">failb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failb</span> <span class="o">&lt;</span> <span class="n">faila</span><span class="p">)</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">faila</span><span class="p">,</span> <span class="n">failb</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe: %llu faila: %d failb: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">faila</span><span class="p">,</span> <span class="n">failb</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failb</span> <span class="o">==</span> <span class="n">syndrome_disks</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Q disk is one of the missing disks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">faila</span> <span class="o">==</span> <span class="n">syndrome_disks</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Missing P+Q, just recompute */</span>
			<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
					  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">async_gen_syndrome</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syndrome_disks</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
						  <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">data_target</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>

			<span class="cm">/* Missing D+Q: recompute D from P, then recompute Q */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span>
				<span class="n">data_target</span> <span class="o">=</span> <span class="n">target2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">data_target</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">blocks</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">data_target</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
			<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span>
					  <span class="n">ASYNC_TX_FENCE</span><span class="o">|</span><span class="n">ASYNC_TX_XOR_ZERO_DST</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>

			<span class="n">count</span> <span class="o">=</span> <span class="n">set_syndrome_sources</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
			<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span>
					  <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
					  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">async_gen_syndrome</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
						  <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="n">ops_complete_compute</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
				  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failb</span> <span class="o">==</span> <span class="n">syndrome_disks</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;re missing D+P. */</span>
			<span class="k">return</span> <span class="n">async_raid6_datap_recov</span><span class="p">(</span><span class="n">syndrome_disks</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
						       <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="n">faila</span><span class="p">,</span>
						       <span class="n">blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We&#39;re missing D+D. */</span>
			<span class="k">return</span> <span class="n">async_raid6_2data_recov</span><span class="p">(</span><span class="n">syndrome_disks</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
						       <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="n">faila</span><span class="p">,</span> <span class="n">failb</span><span class="p">,</span>
						       <span class="n">blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_complete_prexor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">stripe_head_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">stripe_head_ref</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ops_run_prexor</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">xor_srcs</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>

	<span class="cm">/* existing parity data subtracted */</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">xor_dest</span> <span class="o">=</span> <span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* Only process blocks that are known to be uptodate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantdrain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_FENCE</span><span class="o">|</span><span class="n">ASYNC_TX_XOR_DROP_DST</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span>
			  <span class="n">ops_complete_prexor</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ops_run_biodrain</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">chosen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Wantdrain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">wbi</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">chosen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">);</span>
			<span class="n">wbi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">=</span> <span class="n">chosen</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">wbi</span> <span class="o">&amp;&amp;</span> <span class="n">wbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wbi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FUA</span><span class="p">)</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_WantFUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wbi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">)</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_SyncIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">async_copy_data</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
				<span class="n">wbi</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">wbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_complete_reconstruct</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">stripe_head_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">stripe_head_ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fua</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">fua</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_WantFUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sync</span> <span class="o">|=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_SyncIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">pd_idx</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fua</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_WantFUA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_SyncIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_drain_run</span><span class="p">)</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_drain_result</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_prexor_drain_run</span><span class="p">)</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_prexor_drain_result</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">!=</span> <span class="n">reconstruct_state_run</span><span class="p">);</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ops_run_reconstruct5</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">xor_srcs</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">xor_dest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prexor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="cm">/* check if prexor is active which means only process blocks</span>
<span class="cm">	 * that are part of a read-modify-write (written)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_prexor_drain_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prexor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xor_dest</span> <span class="o">=</span> <span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">)</span>
				<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xor_dest</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* 1/ if we prexor&#39;d then the dest is reused as a source</span>
<span class="cm">	 * 2/ if we did not prexor then we are redoing the parity</span>
<span class="cm">	 * set ASYNC_TX_XOR_DROP_DST and ASYNC_TX_XOR_ZERO_DST</span>
<span class="cm">	 * for the synchronous xor case</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">ASYNC_TX_ACK</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">prexor</span> <span class="o">?</span> <span class="n">ASYNC_TX_XOR_DROP_DST</span> <span class="o">:</span> <span class="n">ASYNC_TX_XOR_ZERO_DST</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ops_complete_reconstruct</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span>
			  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_memcpy</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ops_run_reconstruct6</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">set_syndrome_sources</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_ACK</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ops_complete_reconstruct</span><span class="p">,</span>
			  <span class="n">sh</span><span class="p">,</span> <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="n">async_gen_syndrome</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_complete_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">stripe_head_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">stripe_head_ref</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_check_result</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_run_check_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">xor_dest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">xor_srcs</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xor_dest</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
	<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xor_dest</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pd_idx</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">qd_idx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">xor_srcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">async_xor_val</span><span class="p">(</span><span class="n">xor_dest</span><span class="p">,</span> <span class="n">xor_srcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_ACK</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ops_complete_check</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">async_trigger_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ops_run_check_pq</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">checkp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">srcs</span> <span class="o">=</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu checkp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">checkp</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">set_syndrome_sources</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checkp</span><span class="p">)</span>
		<span class="n">srcs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="n">ASYNC_TX_ACK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ops_complete_check</span><span class="p">,</span>
			  <span class="n">sh</span><span class="p">,</span> <span class="n">to_addr_conv</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">));</span>
	<span class="n">async_syndrome_val</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span><span class="p">,</span> <span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__raid_run_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ops_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">overlap_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>
	<span class="n">percpu</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_BIOFILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ops_run_biofill</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">overlap_clear</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_COMPUTE_BLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">ops_run_compute5</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">ops_run_compute6_1</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tx</span> <span class="o">=</span> <span class="n">ops_run_compute6_2</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* terminate the chain if reconstruct is not set to be run */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_RECONSTRUCT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span>
			<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_PREXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">ops_run_prexor</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_BIODRAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">ops_run_biodrain</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
		<span class="n">overlap_clear</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_RECONSTRUCT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">ops_run_reconstruct5</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ops_run_reconstruct6</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_OP_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_run</span><span class="p">)</span>
			<span class="n">ops_run_check_p</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_run_q</span><span class="p">)</span>
			<span class="n">ops_run_check_pq</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_run_pq</span><span class="p">)</span>
			<span class="n">ops_run_check_pq</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">percpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlap_clear</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="n">put_cpu</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MULTICORE_RAID456</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_run_ops</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ops_request</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>

	<span class="n">clear_bit_unlock</span><span class="p">(</span><span class="n">STRIPE_OPS_REQ_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">wait_for_ops</span><span class="p">);</span>

	<span class="n">__raid_run_ops</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">ops_request</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid_run_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ops_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* since handle_stripe can be called outside of raid5d context</span>
<span class="cm">	 * we need to ensure sh-&gt;ops.request is de-staged before another</span>
<span class="cm">	 * request arrives</span>
<span class="cm">	 */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">wait_for_ops</span><span class="p">,</span>
		   <span class="o">!</span><span class="n">test_and_set_bit_lock</span><span class="p">(</span><span class="n">STRIPE_OPS_REQ_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ops_request</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">async_schedule</span><span class="p">(</span><span class="n">async_run_ops</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define raid_run_ops __raid_run_ops</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grow_one_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
	<span class="cp">#ifdef CONFIG_MULTICORE_RAID456</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">wait_for_ops</span><span class="p">);</span>
	<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">grow_buffers</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shrink_buffers</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we just created an active stripe so... */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grow_stripes</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devs</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="s">&quot;raid%d-%s&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="s">&quot;raid%d-%p&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;%s-alt&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_name</span><span class="p">],</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">devs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5dev</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">devs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">grow_one_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scribble_len - return the required size of the scribble region</span>
<span class="cm"> * @num - total number of disks in the array</span>
<span class="cm"> *</span>
<span class="cm"> * The size must be enough to contain:</span>
<span class="cm"> * 1/ a struct page pointer for each device in the array +2</span>
<span class="cm"> * 2/ room to convert each entry in (1) to its corresponding dma</span>
<span class="cm"> *    (dma_map_page()) or page (page_address()) address.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: the +2 is for the destination buffers of the ddf/raid6 case where we</span>
<span class="cm"> * calculate over all devices (not just the data blocks), using zeros in place</span>
<span class="cm"> * of the P and Q blocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">scribble_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_conv_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resize_stripes</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make all the stripes able to hold &#39;newsize&#39; devices.</span>
<span class="cm">	 * New slots in each stripe get &#39;page&#39; set to a new page.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This happens in stages:</span>
<span class="cm">	 * 1/ create a new kmem_cache and allocate the required number of</span>
<span class="cm">	 *    stripe_heads.</span>
<span class="cm">	 * 2/ gather all the old stripe_heads and tranfer the pages across</span>
<span class="cm">	 *    to the new stripe_heads.  This will have the side effect of</span>
<span class="cm">	 *    freezing the array as once all stripe_heads have been collected,</span>
<span class="cm">	 *    no IO will be possible.  Old stripe heads are freed once their</span>
<span class="cm">	 *    pages have been transferred over, and the old kmem_cache is</span>
<span class="cm">	 *    freed when all stripes are done.</span>
<span class="cm">	 * 3/ reallocate conf-&gt;disks to be suitable bigger.  If this fails,</span>
<span class="cm">	 *    we simple return a failre status - no need to clean anything up.</span>
<span class="cm">	 * 4/ allocate new pages for the new slots in the new stripe_heads.</span>
<span class="cm">	 *    If this fails, we don&#39;t bother trying the shrink the</span>
<span class="cm">	 *    stripe_heads down again, we just leave them as they are.</span>
<span class="cm">	 *    As each stripe_head is processed the new one is released into</span>
<span class="cm">	 *    active service.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Once step2 is started, we cannot afford to wait for a write,</span>
<span class="cm">	 * so we use GFP_NOIO allocations.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">osh</span><span class="p">,</span> <span class="o">*</span><span class="n">nsh</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">newstripes</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">ndisks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newsize</span> <span class="o">&lt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* never bother to shrink */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">md_allow_write</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Step 1 */</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cache_name</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_name</span><span class="p">],</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">newsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5dev</span><span class="p">),</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nsh</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsh</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nsh</span><span class="o">-&gt;</span><span class="n">raid_conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
		<span class="cp">#ifdef CONFIG_MULTICORE_RAID456</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">wait_for_ops</span><span class="p">);</span>
		<span class="cp">#endif</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstripes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t get enough, give up */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newstripes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nsh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">newstripes</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">nsh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Step 2 - Must use GFP_NOIO now.</span>
<span class="cm">	 * OK, we have enough stripes, start collecting inactive</span>
<span class="cm">	 * stripes and copying them over</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nsh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstripes</span><span class="p">,</span> <span class="n">lru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">,</span>
				    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">),</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span>
				    <span class="p">);</span>
		<span class="n">osh</span> <span class="o">=</span> <span class="n">get_free_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nsh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">osh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">newsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nsh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">,</span> <span class="n">osh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">);</span>

	<span class="cm">/* Step 3.</span>
<span class="cm">	 * At this point, we are holding all the stripes so the array</span>
<span class="cm">	 * is completely stalled, so now is a good time to resize</span>
<span class="cm">	 * conf-&gt;disks and the scribble region</span>
<span class="cm">	 */</span>
	<span class="n">ndisks</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">newsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">disk_info</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndisks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ndisks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">=</span> <span class="n">ndisks</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">get_online_cpus</span><span class="p">();</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">scribble_len</span> <span class="o">=</span> <span class="n">scribble_len</span><span class="p">(</span><span class="n">newsize</span><span class="p">);</span>
	<span class="n">for_each_present_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">scribble</span><span class="p">;</span>

		<span class="n">percpu</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">scribble</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">scribble_len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scribble</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">);</span>
			<span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">=</span> <span class="n">scribble</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_online_cpus</span><span class="p">();</span>

	<span class="cm">/* Step 4, return new stripes to service */</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newstripes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nsh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">newstripes</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">newsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nsh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_NOIO</span><span class="p">);</span>
				<span class="n">nsh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">release_stripe</span><span class="p">(</span><span class="n">nsh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* critical section pass, GFP_NOIO no longer needed */</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_name</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_name</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drop_one_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">get_free_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
	<span class="n">shrink_buffers</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shrink_stripes</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">drop_one_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">slab_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_end_read_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span> <span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;end_read_request %llu/%d, count: %d, uptodate %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">),</span>
		<span class="n">uptodate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* If replacement finished while this request was outstanding,</span>
<span class="cm">		 * &#39;replacement&#39; might be NULL already.</span>
<span class="cm">		 * In that case it moved down to &#39;rdev&#39;.</span>
<span class="cm">		 * rdev is not removed until all requests are finished.</span>
<span class="cm">		 */</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_new_offset</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">))</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Note that this cannot happen on a</span>
<span class="cm">			 * replacement device.  We just fail those on</span>
<span class="cm">			 * any error</span>
<span class="cm">			 */</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span>
				<span class="n">KERN_INFO</span>
				<span class="s">&quot;md/raid:%s: read error corrected&quot;</span>
				<span class="s">&quot; (%lu sectors at %llu on %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span><span class="p">,</span>
				<span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">corrected_errors</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">))</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bdn</span> <span class="o">=</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">set_bad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;md/raid:%s: read error on replacement device &quot;</span>
				<span class="s">&quot;(sector %llu on %s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span><span class="p">,</span>
				<span class="n">bdn</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;md/raid:%s: read error not correctable &quot;</span>
				<span class="s">&quot;(sector %llu on %s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span><span class="p">,</span>
				<span class="n">bdn</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Oh, no!!! */</span>
			<span class="n">set_bad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span>
				<span class="n">KERN_WARNING</span>
				<span class="s">&quot;md/raid:%s: read error NOT corrected!! &quot;</span>
				<span class="s">&quot;(sector %llu on %s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">s</span><span class="p">,</span>
				<span class="n">bdn</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">read_errors</span><span class="p">)</span>
			 <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;md/raid:%s: Too many read errors, failing device %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdn</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">set_bad</span>
			      <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			      <span class="o">&amp;&amp;</span> <span class="n">rdev_set_badblocks</span><span class="p">(</span>
				      <span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
				<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_end_write_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">replacement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rreq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">replacement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* rdev was removed and &#39;replacement&#39;</span>
<span class="cm">				 * replaced it.  rdev is not removed</span>
<span class="cm">				 * until all requests are finished.</span>
<span class="cm">				 */</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;end_write_request %llu/%d, count %d, uptodate: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">),</span>
		<span class="n">uptodate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">replacement</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span>
			<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				     <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_MadeGoodRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				       <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_DOUBLE_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="n">compute_blocknr</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">);</span>
	
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_build_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">bio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bi_vcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bi_max_vecs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vec</span><span class="p">.</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>

	<span class="n">bio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rreq</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rreq</span><span class="p">.</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rvec</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rreq</span><span class="p">.</span><span class="n">bi_vcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rreq</span><span class="p">.</span><span class="n">bi_max_vecs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rreq</span><span class="p">.</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rvec</span><span class="p">.</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">compute_blocknr</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid456: error called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
	       <span class="s">&quot;md/raid:%s: Disk failure on %s, disabling device.</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;md/raid:%s: Operation continuing on %d devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
	       <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
	       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
	       <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Input: a &#39;big&#39; sector number,</span>
<span class="cm"> * Output: index of the data and parity disk, and the sector # in them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">raid5_compute_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">r_sector</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">previous</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">stripe</span><span class="p">,</span> <span class="n">stripe2</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">chunk_number</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pd_idx</span><span class="p">,</span> <span class="n">qd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddf_layout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">new_sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_algo</span>
				 <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors_per_chunk</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_chunk_sectors</span>
					 <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid_disks</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span>
				  <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_disks</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>

	<span class="cm">/* First compute the information on this sector */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the chunk number and the sector offset inside the chunk</span>
<span class="cm">	 */</span>
	<span class="n">chunk_offset</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">r_sector</span><span class="p">,</span> <span class="n">sectors_per_chunk</span><span class="p">);</span>
	<span class="n">chunk_number</span> <span class="o">=</span> <span class="n">r_sector</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the stripe number</span>
<span class="cm">	 */</span>
	<span class="n">stripe</span> <span class="o">=</span> <span class="n">chunk_number</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe</span><span class="p">,</span> <span class="n">data_disks</span><span class="p">);</span>
	<span class="n">stripe2</span> <span class="o">=</span> <span class="n">stripe</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Select the parity disk based on the user selected algorithm.</span>
<span class="cm">	 */</span>
	<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:

		<span class="k">switch</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Q D D D P */</span>
				<span class="n">qd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* D D P Q D */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Q D D D P */</span>
				<span class="n">qd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* D D P Q D */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span><span class="p">;</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_ZERO_RESTART</span>:
			<span class="cm">/* Exactly the same as RIGHT_ASYMMETRIC, but or</span>
<span class="cm">			 * of blocks for computing Q is different.</span>
<span class="cm">			 */</span>
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Q D D D P */</span>
				<span class="n">qd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* D D P Q D */</span>
			<span class="n">ddf_layout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_N_RESTART</span>:
			<span class="cm">/* Same a left_asymmetric, by first stripe is</span>
<span class="cm">			 * D D D P Q  rather than</span>
<span class="cm">			 * Q D D D P</span>
<span class="cm">			 */</span>
			<span class="n">stripe2</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Q D D D P */</span>
				<span class="n">qd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* D D P Q D */</span>
			<span class="n">ddf_layout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_N_CONTINUE</span>:
			<span class="cm">/* Same as left_symmetric but Q is before P */</span>
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="n">ddf_layout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC_6</span>:
			<span class="cm">/* RAID5 left_asymmetric, with Q on last device */</span>
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC_6</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span> <span class="o">&gt;=</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC_6</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">-</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC_6</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe2</span><span class="p">,</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dd_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0_6</span>:
			<span class="n">pd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">dd_idx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="n">qd_idx</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">=</span> <span class="n">pd_idx</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">=</span> <span class="n">qd_idx</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ddf_layout</span> <span class="o">=</span> <span class="n">ddf_layout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Finally, compute the new sector number</span>
<span class="cm">	 */</span>
	<span class="n">new_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">stripe</span> <span class="o">*</span> <span class="n">sectors_per_chunk</span> <span class="o">+</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">new_sector</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">compute_blocknr</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid_disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_disks</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">new_sector</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">check</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors_per_chunk</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_chunk_sectors</span>
					 <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_algo</span>
				 <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">stripe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunk_offset</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">chunk_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dummy1</span><span class="p">,</span> <span class="n">dd_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">r_sector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="n">sh2</span><span class="p">;</span>


	<span class="n">chunk_offset</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">new_sector</span><span class="p">,</span> <span class="n">sectors_per_chunk</span><span class="p">);</span>
	<span class="n">stripe</span> <span class="o">=</span> <span class="n">new_sector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="n">raid_disks</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
			<span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* It is the Q disk */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">algorithm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_ZERO_RESTART</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_N_RESTART</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* Q D D D P */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* D D P Q D */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="n">raid_disks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* Q D D D P */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* D D P Q D */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">+=</span> <span class="n">raid_disks</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
			<span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_ROTATING_N_CONTINUE</span>:
			<span class="cm">/* Like left_symmetric, but P is before Q */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* P D D D Q */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* D D Q P D */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">+=</span> <span class="n">raid_disks</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC_6</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC_6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC_6</span>:
		<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC_6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="n">data_disks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0_6</span>:
			<span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chunk_number</span> <span class="o">=</span> <span class="n">stripe</span> <span class="o">*</span> <span class="n">data_disks</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">r_sector</span> <span class="o">=</span> <span class="n">chunk_number</span> <span class="o">*</span> <span class="n">sectors_per_chunk</span> <span class="o">+</span> <span class="n">chunk_offset</span><span class="p">;</span>

	<span class="n">check</span> <span class="o">=</span> <span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">r_sector</span><span class="p">,</span>
				     <span class="n">previous</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">||</span> <span class="n">dummy1</span> <span class="o">!=</span> <span class="n">dd_idx</span> <span class="o">||</span> <span class="n">sh2</span><span class="p">.</span><span class="n">pd_idx</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span>
		<span class="o">||</span> <span class="n">sh2</span><span class="p">.</span><span class="n">qd_idx</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: compute_blocknr: map not correct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r_sector</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">schedule_reconstruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">rcw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expand</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">,</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcw</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if we are not expanding this is a proper write request, and</span>
<span class="cm">		 * there will be bios with new data to be drained into the</span>
<span class="cm">		 * stripe cache</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expand</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_drain_run</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_BIODRAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_run</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_RECONSTRUCT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantdrain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expand</span><span class="p">)</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">+</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">==</span> <span class="n">disks</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">STRIPE_FULL_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_full_writes</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">)));</span>

		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_prexor_drain_run</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_PREXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_BIODRAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_RECONSTRUCT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pd_idx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			     <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantdrain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* keep the parity disk(s) locked while asynchronous operations</span>
<span class="cm">	 * are in flight</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">qd_idx</span><span class="p">];</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stripe %llu locked: %d ops_request: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Each stripe/dev can have one or more bion attached.</span>
<span class="cm"> * toread/towrite point to the first in a chain.</span>
<span class="cm"> * The bi_next chain must be in order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_stripe_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dd_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">forwrite</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">bip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">firstwrite</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;adding bi b#%llu to stripe s#%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>


	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">forwrite</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">towrite</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">written</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">firstwrite</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">toread</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">((</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">overlap</span><span class="p">;</span>
		<span class="n">bip</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">((</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">overlap</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">bip</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">bip</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bip</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>
	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forwrite</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if page is covered */</span>
		<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">sector</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bi</span><span class="o">=</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">towrite</span><span class="p">;</span>
		     <span class="n">sector</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span> <span class="o">&amp;&amp;</span>
			     <span class="n">bi</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;=</span> <span class="n">sector</span><span class="p">;</span>
		     <span class="n">bi</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">sector</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">sector</span><span class="p">)</span>
				<span class="n">sector</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;added bi b#%llu to stripe s#%llu, disk %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="n">bip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">dd_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">&amp;&amp;</span> <span class="n">firstwrite</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_startwrite</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				  <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">bm_seq</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">seq_flush</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_BIT_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">overlap:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">end_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stripe_set_idx</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">stripe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">previous</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sectors_per_chunk</span> <span class="o">=</span>
		<span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_chunk_sectors</span> <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunk_offset</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">stripe</span><span class="p">,</span> <span class="n">sectors_per_chunk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">previous</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">:</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>

	<span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span>
			     <span class="n">stripe</span> <span class="o">*</span> <span class="p">(</span><span class="n">disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">)</span>
			     <span class="o">*</span><span class="n">sectors_per_chunk</span> <span class="o">+</span> <span class="n">chunk_offset</span><span class="p">,</span>
			     <span class="n">previous</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_failed_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disks</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">return_bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bitmap_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span>
					    <span class="n">rdev</span><span class="p">,</span>
					    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
					    <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="cm">/* fail all writes first */</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">towrite</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">towrite</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">to_write</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bitmap_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">bi</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">nextbi</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">bi</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">md_write_end</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">return_bi</span><span class="p">;</span>
				<span class="o">*</span><span class="n">return_bi</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">nextbi</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* and fail all &#39;written&#39; */</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">written</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">written</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="n">bitmap_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bi</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
		       <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi2</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">bi</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">md_write_end</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
				<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">return_bi</span><span class="p">;</span>
				<span class="o">*</span><span class="n">return_bi</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">bi2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* fail any reads if this device is non-operational and</span>
<span class="cm">		 * the data has not reached the cache yet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantfill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bi</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">toread</span><span class="p">;</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">toread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_Overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">to_read</span><span class="o">--</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">bi</span> <span class="o">&amp;&amp;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
			       <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">nextbi</span> <span class="o">=</span>
					<span class="n">r5_next_bio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sector</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">bi</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">return_bi</span><span class="p">;</span>
					<span class="o">*</span><span class="n">return_bi</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bi</span> <span class="o">=</span> <span class="n">nextbi</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_end</span><span class="p">)</span>
			<span class="n">bitmap_endwrite</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
					<span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* If we were in the middle of a write the parity block might</span>
<span class="cm">		 * still be locked - so just clear all R5_LOCKED flags</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STRIPE_FULL_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_full_writes</span><span class="p">))</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_failed_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_SYNCING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">replacing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* There is nothing more to do for sync/check/repair.</span>
<span class="cm">	 * Don&#39;t even need to abort as that is handled elsewhere</span>
<span class="cm">	 * if needed, and not always wanted e.g. if there is a known</span>
<span class="cm">	 * bad block here.</span>
<span class="cm">	 * For recover/replace we need to record a bad block on all</span>
<span class="cm">	 * non-sync devices, or abort the recovery</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RECOVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* During recovery devices cannot be removed, so</span>
<span class="cm">		 * locking and refcounting of rdevs is not needed</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
						   <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
						   <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">md_done_sync</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="o">!</span><span class="n">abort</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">want_replace</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disk_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Doing recovery so rcu locking not required */</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">disk_idx</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span>
		<span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* fetch_block - checks the given member device to see if its data needs</span>
<span class="cm"> * to be read or computed to satisfy a request.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when no more member devices need to be checked, otherwise returns</span>
<span class="cm"> * 0 to tell the loop in handle_stripe_fill to continue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fetch_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">disk_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">disk_idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">fdev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
				  <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">};</span>

	<span class="cm">/* is the data in this block needed, and can we get it? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">||</span>
	     <span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">expanding</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">replacing</span> <span class="o">&amp;&amp;</span> <span class="n">want_replace</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">disk_idx</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">fdev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="n">fdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">&amp;&amp;</span>
	      <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">to_write</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* we would like to get this block, possibly by computing it,</span>
<span class="cm">		 * otherwise read it if the backing disk is insync</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">==</span> <span class="n">disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">disk_idx</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
				   <span class="n">disk_idx</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span> <span class="p">{</span>
			<span class="cm">/* have disk failed, and we&#39;re requested to fetch it;</span>
<span class="cm">			 * do compute it</span>
<span class="cm">			 */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Computing stripe %llu block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">disk_idx</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_COMPUTE_BLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">disk_idx</span><span class="p">;</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* no 2nd target */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">req_compute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Careful: from this point on &#39;uptodate&#39; is in the eye</span>
<span class="cm">			 * of raid_run_ops which services &#39;compute&#39; operations</span>
<span class="cm">			 * before writes. R5_Wantcompute flags a block that will</span>
<span class="cm">			 * be R5_UPTODATE by the time it is needed for a</span>
<span class="cm">			 * subsequent operation.</span>
<span class="cm">			 */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">==</span> <span class="n">disks</span><span class="o">-</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Computing 2-failure is *very* expensive; only</span>
<span class="cm">			 * do it if failed &gt;= 2</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">other</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">other</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">other</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">disk_idx</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">other</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">other</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Computing stripe %llu blocks %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
			       <span class="n">disk_idx</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_COMPUTE_BLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">disk_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">other</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">disk_idx</span><span class="p">;</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">=</span> <span class="n">other</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">req_compute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Reading block %d (sync=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">disk_idx</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * handle_stripe_fill - read or compute data to satisfy pending requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stripe_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* look for blocks to read/compute, skip this if a compute</span>
<span class="cm">	 * is already in flight, or if the stripe contents are in the</span>
<span class="cm">	 * midst of changing due to a write</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fetch_block</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">disks</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* handle_stripe_clean_event</span>
<span class="cm"> * any written block on an uptodate or failed drive can be returned.</span>
<span class="cm"> * Note that if we &#39;wrote&#39; to a failed drive, it will be UPTODATE, but</span>
<span class="cm"> * never LOCKED, so we don&#39;t need to test &#39;failed&#39; directly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stripe_clean_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disks</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">**</span><span class="n">return_bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">written</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We can return any write requests */</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">wbi</span><span class="p">,</span> <span class="o">*</span><span class="n">wbi2</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">bitmap_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Return write for disc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
				<span class="n">wbi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">wbi</span> <span class="o">&amp;&amp;</span> <span class="n">wbi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&lt;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">wbi2</span> <span class="o">=</span> <span class="n">r5_next_bio</span><span class="p">(</span><span class="n">wbi</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">wbi</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">md_write_end</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
						<span class="n">wbi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="o">*</span><span class="n">return_bi</span><span class="p">;</span>
						<span class="o">*</span><span class="n">return_bi</span> <span class="o">=</span> <span class="n">wbi</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">wbi</span> <span class="o">=</span> <span class="n">wbi2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">bitmap_end</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_end</span><span class="p">)</span>
					<span class="n">bitmap_endwrite</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span>
							<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
							<span class="n">STRIPE_SECTORS</span><span class="p">,</span>
					 <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_DEGRADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
							<span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STRIPE_FULL_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_full_writes</span><span class="p">))</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stripe_dirtying</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rmw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rcw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RAID6 requires &#39;rcw&#39; in current implementation</span>
<span class="cm">		 * Calculate the real rcw later - for now fake it</span>
<span class="cm">		 * look like rcw is cheaper</span>
<span class="cm">		 */</span>
		<span class="n">rcw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">rmw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* would I have to read this buffer for read_modify_write */</span>
		<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">rmw</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rmw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">disks</span><span class="p">;</span>  <span class="cm">/* cannot read it */</span>
		<span class="p">}</span>
		<span class="cm">/* Would I have to read this buffer for reconstruct_write */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="n">rcw</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rcw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">disks</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;for sector %llu, rmw=%d rcw=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">rmw</span><span class="p">,</span> <span class="n">rcw</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rmw</span> <span class="o">&lt;</span> <span class="n">rcw</span> <span class="o">&amp;&amp;</span> <span class="n">rmw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* prefer read-modify-write, but need to get some data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span>
				  <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Read_old block &quot;</span>
						<span class="s">&quot;%d for r-m-w</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcw</span> <span class="o">&lt;=</span> <span class="n">rmw</span> <span class="o">&amp;&amp;</span> <span class="n">rcw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* want reconstruct write, but need to get some data */</span>
		<span class="n">rcw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">i</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rcw</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span> <span class="cm">/* it&#39;s a failed drive */</span>
				<span class="k">if</span> <span class="p">(</span>
				  <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Read_old block &quot;</span>
						<span class="s">&quot;%d for Reconstruct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* now if nothing is locked, and if we have enough data,</span>
<span class="cm">	 * we can start a write request</span>
<span class="cm">	 */</span>
	<span class="cm">/* since handle_stripe can be called at any time we need to handle the</span>
<span class="cm">	 * case where a compute block operation has been submitted and then a</span>
<span class="cm">	 * subsequent call wants to start a write request.  raid_run_ops only</span>
<span class="cm">	 * handles the case where compute block and reconstruct are requested</span>
<span class="cm">	 * simultaneously.  If this is not the case then new writes need to be</span>
<span class="cm">	 * held off until the compute completes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">req_compute</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rcw</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rmw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_BIT_DELAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span>
		<span class="n">schedule_reconstruction</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rcw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_parity_checks5</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">check_state_idle</span>:
		<span class="cm">/* start a new check operation if there are no failures */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">!=</span> <span class="n">disks</span><span class="p">);</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_run</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">check_state_compute_result</span>:
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_idle</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">];</span>

		<span class="cm">/* check that a write has not made the stripe insync */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* either failed parity check, or recovery is happening */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">!=</span> <span class="n">disks</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DEGRADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">check_state_run</span>:
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* we will be called again upon completion */</span>
	<span class="k">case</span> <span class="n">check_state_check_result</span>:
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_idle</span><span class="p">;</span>

		<span class="cm">/* if a failure occurred during the check operation, leave</span>
<span class="cm">		 * STRIPE_INSYNC not set and let the stripe be handled again</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* handle a successful check operation, if parity is correct</span>
<span class="cm">		 * we are done.  Otherwise update the mismatch count and repair</span>
<span class="cm">		 * parity if !MD_RECOVERY_CHECK</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">&amp;</span> <span class="n">SUM_CHECK_P_RESULT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* parity is correct (on disc,</span>
<span class="cm">			 * not in buffer any more)</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="cm">/* don&#39;t try to repair!! */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_compute_run</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_COMPUTE_BLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">;</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">check_state_compute_run</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown check_state: %d sector: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_parity_checks6</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qd_idx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Want to check and possibly repair P and Q.</span>
<span class="cm">	 * However there could be one &#39;failed&#39; device, in which</span>
<span class="cm">	 * case we can only check one of them, possibly using the</span>
<span class="cm">	 * other to generate missing data</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">check_state_idle</span>:
		<span class="cm">/* start a new check operation if there are &lt; 2 failures */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The only possible failed device holds Q, so it</span>
<span class="cm">			 * makes sense to check P (If anything else were failed,</span>
<span class="cm">			 * we would have used P to recreate it).</span>
<span class="cm">			 */</span>
			<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_run</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_failed</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Q is not failed, and we didn&#39;t use it to generate</span>
<span class="cm">			 * anything, so it makes sense to check it</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_run</span><span class="p">)</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_run_pq</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_run_q</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* discard potentially stale zero_sum_result */</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">==</span> <span class="n">check_state_run</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* async_xor_zero_sum destroys the contents of P */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">&gt;=</span> <span class="n">check_state_run</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">&lt;=</span> <span class="n">check_state_run_pq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* async_syndrome_zero_sum preserves P and Q, so</span>
<span class="cm">			 * no need to mark them !uptodate here</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we have 2-disk failure */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">check_state_compute_result</span>:
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_idle</span><span class="p">;</span>

		<span class="cm">/* check that a write has not made the stripe insync */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* now write out any block on a failed drive,</span>
<span class="cm">		 * or P or Q if they were recomputed</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span> <span class="o">&lt;</span> <span class="n">disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* We don&#39;t need Q to recover */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">&amp;</span> <span class="n">SUM_CHECK_P_RESULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">&amp;</span> <span class="n">SUM_CHECK_Q_RESULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">qd_idx</span><span class="p">];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DEGRADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">check_state_run</span>:
	<span class="k">case</span> <span class="n">check_state_run_q</span>:
	<span class="k">case</span> <span class="n">check_state_run_pq</span>:
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* we will be called again upon completion */</span>
	<span class="k">case</span> <span class="n">check_state_check_result</span>:
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_idle</span><span class="p">;</span>

		<span class="cm">/* handle a successful check operation, if parity is correct</span>
<span class="cm">		 * we are done.  Otherwise update the mismatch count and repair</span>
<span class="cm">		 * parity if !MD_RECOVERY_CHECK</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* both parities are correct */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* in contrast to the raid5 case we can validate</span>
<span class="cm">				 * parity, but still have a failure to write</span>
<span class="cm">				 * back</span>
<span class="cm">				 */</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_compute_result</span><span class="p">;</span>
				<span class="cm">/* Returning at this point means that we may go</span>
<span class="cm">				 * off and bring p and/or q uptodate again so</span>
<span class="cm">				 * we make sure to check zero_sum_result again</span>
<span class="cm">				 * to verify if p or q need writeback</span>
<span class="cm">				 */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_mismatches</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
				<span class="cm">/* don&#39;t try to repair!! */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>

				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="n">check_state_compute_run</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_COMPUTE_BLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_request</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">&amp;</span> <span class="n">SUM_CHECK_P_RESULT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
					<span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">pd_idx</span><span class="p">;</span>
					<span class="n">target</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">target2</span><span class="p">;</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">zero_sum_result</span> <span class="o">&amp;</span> <span class="n">SUM_CHECK_Q_RESULT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">qd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
					<span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">qd_idx</span><span class="p">;</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">check_state_compute_run</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown check_state: %d sector: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stripe_expansion</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We have read all the blocks in this stripe and now we need to</span>
<span class="cm">	 * copy some of them into a target stripe for expand.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh2</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">async_submit_ctl</span> <span class="n">submit</span><span class="p">;</span>

			<span class="n">sector_t</span> <span class="n">bn</span> <span class="o">=</span> <span class="n">compute_blocknr</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">sh2</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="cm">/* so far only the early blocks of this stripe</span>
<span class="cm">				 * have been requested.  When later blocks</span>
<span class="cm">				 * get requested, we will try again</span>
<span class="cm">				 */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Expanded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* must have already done this block */</span>
				<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh2</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* place all the copies on one channel */</span>
			<span class="n">init_async_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">tx</span> <span class="o">=</span> <span class="n">async_memcpy</span><span class="p">(</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">page</span><span class="p">,</span>
					  <span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">submit</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Expanded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">sh2</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">&amp;&amp;</span>
				    <span class="n">j</span> <span class="o">!=</span> <span class="n">sh2</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Expanded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh2</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh2</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="cm">/* done submitting copies, wait for them to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
		<span class="n">dma_wait_for_async_tx</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle_stripe - do things to a stripe.</span>
<span class="cm"> *</span>
<span class="cm"> * We lock the stripe by setting STRIPE_ACTIVE and then examine the</span>
<span class="cm"> * state of various bits to see what needs to be done.</span>
<span class="cm"> * Possible results:</span>
<span class="cm"> *    return some read requests which now have data</span>
<span class="cm"> *    return some write requests which are safely on storage</span>
<span class="cm"> *    schedule a read on some buffers</span>
<span class="cm"> *    schedule a write of some buffers</span>
<span class="cm"> *    return confirmation of parity correctness</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">analyse_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">expanding</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">expanded</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now to look around and see what can be done */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">is_bad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;check %d: state 0x%lx read %p write %p written %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">);</span>
		<span class="cm">/* maybe we can reply to a read</span>
<span class="cm">		 *</span>
<span class="cm">		 * new wantfill requests are only permitted while</span>
<span class="cm">		 * ops_complete_biofill is guaranteed to be inactive</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_BIOFILL_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantfill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* now count some things */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">uptodate</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantcompute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">compute</span><span class="o">++</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">compute</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Wantfill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">to_fill</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">toread</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">to_read</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">towrite</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">to_write</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_OVERWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">non_overwrite</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">written</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Prefer to use the replacement for reads, but only</span>
<span class="cm">		 * if it is recovered enough and has no bad blocks.</span>
<span class="cm">		 */</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&gt;=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_ReadRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_NeedReplace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReadRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">is_bad</span> <span class="o">=</span> <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">blocked_rdev</span> <span class="o">==</span> <span class="nb">NULL</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Blocked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">is_bad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">BlockedBadBlocks</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">blocked_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
			<span class="cm">/* Not in-sync */</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_bad</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* also not in-sync */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WriteErrorSeen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* treat as in-sync, but with a read error</span>
<span class="cm">				 * which we can now try to correct</span>
<span class="cm">				 */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">STRIPE_SECTORS</span> <span class="o">&lt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span><span class="p">)</span>
			<span class="cm">/* in sync if before recovery_offset */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Expanded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="cm">/* If we&#39;ve reshaped into here, we assume it is Insync.</span>
<span class="cm">			 * We will shortly update recovery_offset to make</span>
<span class="cm">			 * it official.</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This flag does not apply to &#39;.replacement&#39;</span>
<span class="cm">			 * only to .rdev, so make sure to check that*/</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span> <span class="o">==</span> <span class="n">rdev</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_bad_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This flag does not apply to &#39;.replacement&#39;</span>
<span class="cm">			 * only to .rdev, so make sure to check that*/</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_bad_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_MadeGoodRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev2</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_bad_blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev2</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_MadeGoodRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The ReadError flag will just be confusing now */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">failed_num</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">do_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_SYNCING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If there is a failed device being replaced,</span>
<span class="cm">		 *     we must be recovering.</span>
<span class="cm">		 * else if we are after recovery_cp, we must be syncing</span>
<span class="cm">		 * else if MD_RECOVERY_REQUESTED is set, we also are syncing.</span>
<span class="cm">		 * else we can only be replacing</span>
<span class="cm">		 * sync and recovery both need to read all devices, and so</span>
<span class="cm">		 * use the same flag.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_recovery</span> <span class="o">||</span>
		    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)))</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">replacing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head_state</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">raid_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prexor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disks</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="o">*</span><span class="n">qdev</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit_lock</span><span class="p">(</span><span class="n">STRIPE_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* already being handled, ensure it gets handled</span>
<span class="cm">		 * again when current action finishes */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STRIPE_SYNC_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_SYNCING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;handling stripe %llu, state=%#lx cnt=%d, &quot;</span>
		<span class="s">&quot;pd_idx=%d, qd_idx=%d</span><span class="se">\n</span><span class="s">, check:%d, reconstruct:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
	       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">),</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">,</span>
	       <span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span><span class="p">);</span>

	<span class="n">analyse_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">handle_bad_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">syncing</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">expanding</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">expanded</span> <span class="o">||</span>
		    <span class="n">s</span><span class="p">.</span><span class="n">replacing</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">to_write</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">written</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* There is nothing for the blocked_rdev to block */</span>
		<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
		<span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">to_fill</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_BIOFILL_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_OP_BIOFILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">ops_request</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_BIOFILL_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;locked=%d uptodate=%d to_read=%d&quot;</span>
	       <span class="s">&quot; to_write=%d failed=%d failed_num=%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">s</span><span class="p">.</span><span class="n">locked</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">uptodate</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">to_read</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">to_write</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">failed</span><span class="p">,</span>
	       <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/* check if the array has lost more than max_degraded devices and,</span>
<span class="cm">	 * if so, some requests might need to be failed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">to_read</span><span class="o">+</span><span class="n">s</span><span class="p">.</span><span class="n">to_write</span><span class="o">+</span><span class="n">s</span><span class="p">.</span><span class="n">written</span><span class="p">)</span>
			<span class="n">handle_failed_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">disks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">return_bi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">syncing</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">replacing</span><span class="p">)</span>
			<span class="n">handle_failed_sync</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * might be able to return some write requests if the parity blocks</span>
<span class="cm">	 * are safe, or on a failed drive</span>
<span class="cm">	 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">];</span>
	<span class="n">s</span><span class="p">.</span><span class="n">p_failed</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">);</span>
	<span class="n">qdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">];</span>
	<span class="n">s</span><span class="p">.</span><span class="n">q_failed</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>
		<span class="o">||</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">written</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">p_failed</span> <span class="o">||</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">q_failed</span> <span class="o">||</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))))</span>
		<span class="n">handle_stripe_clean_event</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">disks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">return_bi</span><span class="p">);</span>

	<span class="cm">/* Now we might consider reading some blocks, either to check/generate</span>
<span class="cm">	 * parity, or to satisfy requests</span>
<span class="cm">	 * or to load a block that is being partially written.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">to_read</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">non_overwrite</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">to_write</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">syncing</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">uptodate</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">compute</span> <span class="o">&lt;</span> <span class="n">disks</span><span class="p">))</span>
	    <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">replacing</span>
	    <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">expanding</span><span class="p">)</span>
		<span class="n">handle_stripe_fill</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>

	<span class="cm">/* Now we check to see if any write operations have recently</span>
<span class="cm">	 * completed</span>
<span class="cm">	 */</span>
	<span class="n">prexor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_prexor_drain_result</span><span class="p">)</span>
		<span class="n">prexor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_drain_result</span> <span class="o">||</span>
	    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_prexor_drain_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_idle</span><span class="p">;</span>

		<span class="cm">/* All the &#39;written&#39; buffers and the parity block are ready to</span>
<span class="cm">		 * be written back to disk</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		       <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">].</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span> <span class="o">||</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">written</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Writing block %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prexor</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_Insync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
				     <span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">s</span><span class="p">.</span><span class="n">dec_preread_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now to consider new write requests and what else, if anything</span>
<span class="cm">	 * should be read.  We do not handle new writes when:</span>
<span class="cm">	 * 1/ A &#39;write&#39; operation (copy+xor) is already in flight.</span>
<span class="cm">	 * 2/ A &#39;check&#39; operation is in flight, as it may clobber the parity</span>
<span class="cm">	 *    block.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">to_write</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span><span class="p">)</span>
		<span class="n">handle_stripe_dirtying</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>

	<span class="cm">/* maybe we need to check and possibly fix the parity for this stripe</span>
<span class="cm">	 * Any reads will already have been scheduled, so we just see if enough</span>
<span class="cm">	 * data is available.  The parity check is held off while parity</span>
<span class="cm">	 * dependent operations are in flight.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">check_state</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">syncing</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">handle_parity_checks6</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">handle_parity_checks5</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">disks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">replacing</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Write out to replacement devices where possible */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_NeedReplace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_WantReplace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">s</span><span class="p">.</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="p">.</span><span class="n">syncing</span> <span class="o">||</span> <span class="n">s</span><span class="p">.</span><span class="n">replacing</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_INSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">md_done_sync</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_SYNCING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the failed drives are just a ReadError, then we might need</span>
<span class="cm">	 * to progress the repair/check process</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">failed</span> <span class="o">&lt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">failed</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">failed_num</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReadError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				<span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_ReWrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">s</span><span class="p">.</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* let&#39;s read it back */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">s</span><span class="p">.</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>


	<span class="cm">/* Finish reconstruct operations initiated by the expansion process */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">==</span> <span class="n">reconstruct_state_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh_src</span>
			<span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh_src</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh_src</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* sh cannot be written until sh_src has been read.</span>
<span class="cm">			 * so arrange for sh to be delayed a little</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sh_src</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">);</span>
			<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh_src</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh_src</span><span class="p">)</span>
			<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh_src</span><span class="p">);</span>

		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">=</span> <span class="n">reconstruct_state_idle</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Wantwrite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_LOCKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="p">.</span><span class="n">locked</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">expanded</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to write out all blocks after computing parity */</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="n">stripe_set_idx</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
		<span class="n">schedule_reconstruction</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">expanded</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">reconstruct_state</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="n">md_done_sync</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">expanding</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_COMPUTE_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">handle_stripe_expansion</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>

<span class="nl">finish:</span>
	<span class="cm">/* wait for this device to become unblocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external</span><span class="p">)</span>
			<span class="n">md_wait_for_blocked_rdev</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span><span class="p">,</span>
						 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* Internal metadata will immediately</span>
<span class="cm">			 * be written by raid5d, so we don&#39;t</span>
<span class="cm">			 * need to wait here.</span>
<span class="cm">			 */</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">blocked_rdev</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">handle_bad_blocks</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">disks</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">r5dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_WriteError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We own a safe reference to the rdev */</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev_set_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
							<span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">md_error</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_MadeGood</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
						     <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">R5_MadeGoodRepl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
					<span class="cm">/* rdev have been moved down */</span>
					<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="n">rdev_clear_badblocks</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
						     <span class="n">STRIPE_SECTORS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ops_request</span><span class="p">)</span>
		<span class="n">raid_run_ops</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">ops_request</span><span class="p">);</span>

	<span class="n">ops_run_io</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">dec_preread_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We delay this until after ops_run_io so that if make_request</span>
<span class="cm">		 * is waiting on a flush, it won&#39;t continue until the writes</span>
<span class="cm">		 * have actually been submitted.</span>
<span class="cm">		 */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">IO_THRESHOLD</span><span class="p">)</span>
			<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">return_io</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">return_bi</span><span class="p">);</span>

	<span class="n">clear_bit_unlock</span><span class="p">(</span><span class="n">STRIPE_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_activate_delayed</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IO_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">delayed_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">delayed_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
			<span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_bit_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* device_lock is held */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bitmap_list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bitmap_list</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">__release_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">md_raid5_congested</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* No difference between reads and writes.  Just check</span>
<span class="cm">	 * how busy the stripe_cache is</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_blocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty_careful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">md_raid5_congested</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_congested</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mddev_congested</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bits</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">md_raid5_congested</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We want read requests to align with chunks where possible,</span>
<span class="cm"> * but write requests don&#39;t need to.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_mergeable_bvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bvec_merge_data</span> <span class="o">*</span><span class="n">bvm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">biovec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bio_sectors</span> <span class="o">=</span> <span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bvm</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span> <span class="cm">/* always allow writes to be mergeable */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span>  <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="p">((</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">&amp;&amp;</span> <span class="n">bio_sectors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">biovec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">in_chunk_boundary</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bio_sectors</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="k">return</span>  <span class="n">chunk_sectors</span> <span class="o">&gt;=</span>
		<span class="p">((</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  add bio to the retry LIFO  ( in O(1) ... we are in interrupt )</span>
<span class="cm"> *  later sampled by raid5d.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_bio_to_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned_list</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned_list</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">remove_bio_from_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned_list</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned_list</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * this sets the active strip count to 1 and the processed</span>
<span class="cm">		 * strip count to zero (upper 8 bits)</span>
<span class="cm">		 */</span>
		<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* biased count of active stripes */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bi</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  The &quot;raid5_align_endio&quot; should check if the read succeeded and if it</span>
<span class="cm"> *  did, call bio_endio on the original bio (having bio_put the new bio</span>
<span class="cm"> *  first).</span>
<span class="cm"> *  If the read failed..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_align_endio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span><span class="o">*</span> <span class="n">raid_bi</span>  <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">bio_put</span><span class="p">(</span><span class="n">bi</span><span class="p">);</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">raid_bi</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="p">;</span>
	<span class="n">raid_bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">;</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">uptodate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">raid_bi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_aligned_reads</span><span class="p">))</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid5_align_endio : io error...handing IO for a retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">add_bio_to_retry</span><span class="p">(</span><span class="n">raid_bi</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bio_fits_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blk_recount_segments</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">&gt;</span> <span class="n">queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">merge_bvec_fn</span><span class="p">)</span>
		<span class="cm">/* it&#39;s too hard to apply the merge_bvec_fn at this stage,</span>
<span class="cm">		 * just just give up</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">chunk_aligned_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span> <span class="n">raid_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span><span class="o">*</span> <span class="n">align_bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">end_sector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_chunk_boundary</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">raid_bio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;chunk_aligned_read : non aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * use bio_clone_mddev to make a copy of the bio</span>
<span class="cm">	 */</span>
	<span class="n">align_bi</span> <span class="o">=</span> <span class="n">bio_clone_mddev</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">align_bi</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *   set bi_end_io to a new function, and set bi_private to the</span>
<span class="cm">	 *     original bio.</span>
<span class="cm">	 */</span>
	<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_end_io</span>  <span class="o">=</span> <span class="n">raid5_align_endio</span><span class="p">;</span>
	<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">raid_bio</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	compute position</span>
<span class="cm">	 */</span>
	<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span>  <span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">raid_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">end_sector</span> <span class="o">=</span> <span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">replacement</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;</span> <span class="n">end_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">dd_idx</span><span class="p">].</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&gt;=</span> <span class="n">end_sector</span><span class="p">)))</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">first_bad</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bad_sectors</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">raid_bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">rdev</span><span class="p">;</span>
		<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span>  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BIO_SEG_VALID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio_fits_rdev</span><span class="p">(</span><span class="n">align_bi</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">is_badblock</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">first_bad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_sectors</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* too big in some way, or has a known bad block */</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">align_bi</span><span class="p">);</span>
			<span class="n">rdev_dec_pending</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* No reshape active, so we can trust rdev-&gt;data_offset */</span>
		<span class="n">align_bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">,</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="cm">/* nothing */</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_aligned_reads</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">align_bi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="n">bio_put</span><span class="p">(</span><span class="n">align_bi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* __get_priority_stripe - get the next stripe to process</span>
<span class="cm"> *</span>
<span class="cm"> * Full stripe writes are allowed to pass preread active stripes up until</span>
<span class="cm"> * the bypass_threshold is exceeded.  In general the bypass_count</span>
<span class="cm"> * increments when the handle_list is handled before the hold_list; however, it</span>
<span class="cm"> * will not be incremented when STRIPE_IO_STARTED is sampled set signifying a</span>
<span class="cm"> * stripe with in flight i/o.  The bypass_count will be reset when the</span>
<span class="cm"> * head of the hold_list has changed, i.e. the head was promoted to the</span>
<span class="cm"> * handle_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="nf">__get_priority_stripe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: handle: %s hold: %s full_writes: %d bypass_count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">__func__</span><span class="p">,</span>
		  <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">handle_list</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;empty&quot;</span> <span class="o">:</span> <span class="s">&quot;busy&quot;</span><span class="p">,</span>
		  <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;empty&quot;</span> <span class="o">:</span> <span class="s">&quot;busy&quot;</span><span class="p">,</span>
		  <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_full_writes</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">handle_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">handle_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">sh</span><span class="p">),</span> <span class="n">lru</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">))</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_IO_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_hold</span><span class="p">)</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">last_hold</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">-=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span> <span class="o">&amp;&amp;</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pending_full_writes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">sh</span><span class="p">),</span> <span class="n">lru</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">-=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span> <span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">new_sector</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">logical_sector</span><span class="p">,</span> <span class="n">last_sector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_FLUSH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">md_flush_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">md_write_start</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">&amp;&amp;</span>
	     <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span> <span class="o">&amp;&amp;</span>
	     <span class="n">chunk_aligned_read</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span><span class="n">bi</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">logical_sector</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">STRIPE_SECTORS</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">last_sector</span> <span class="o">=</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_phys_segments</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* over-loaded to count active stripes */</span>

	<span class="k">for</span> <span class="p">(;</span><span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">last_sector</span><span class="p">;</span> <span class="n">logical_sector</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">previous</span><span class="p">;</span>

	<span class="nl">retry:</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* spinlock is needed as reshape_progress may be</span>
<span class="cm">			 * 64bit on a 32bit platform, and so it might be</span>
<span class="cm">			 * possible to see a half-updated value</span>
<span class="cm">			 * Of course reshape_progress could change after</span>
<span class="cm">			 * the lock is dropped, so once we get a reference</span>
<span class="cm">			 * to the stripe that we think it is, we will have</span>
<span class="cm">			 * to check again.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
			    <span class="o">?</span> <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span>
			    <span class="o">:</span> <span class="n">logical_sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">previous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
				    <span class="o">?</span> <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span>
				    <span class="o">:</span> <span class="n">logical_sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
					<span class="n">schedule</span><span class="p">();</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">new_sector</span> <span class="o">=</span> <span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">logical_sector</span><span class="p">,</span>
						  <span class="n">previous</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid456: make_request, sector %llu logical %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_sector</span><span class="p">,</span> 
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">logical_sector</span><span class="p">);</span>

		<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">new_sector</span><span class="p">,</span> <span class="n">previous</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="o">&amp;</span><span class="n">RWA_MASK</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">previous</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* expansion might have moved on while waiting for a</span>
<span class="cm">				 * stripe, so we must do the range check again.</span>
<span class="cm">				 * Expansion could still move past after this</span>
<span class="cm">				 * test, but as we are holding a reference to</span>
<span class="cm">				 * &#39;sh&#39;, we know that if that happens,</span>
<span class="cm">				 *  STRIPE_EXPANDING will get set and the expansion</span>
<span class="cm">				 * won&#39;t proceed until we finish with the stripe.</span>
<span class="cm">				 */</span>
				<span class="kt">int</span> <span class="n">must_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
				    <span class="o">?</span> <span class="n">logical_sector</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span>
				    <span class="o">:</span> <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">)</span>
					<span class="cm">/* mismatch, need to try again */</span>
					<span class="n">must_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">must_retry</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
					<span class="n">schedule</span><span class="p">();</span>
					<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">logical_sector</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">&amp;&amp;</span>
			    <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
				<span class="cm">/* As the suspend_* range is controlled by</span>
<span class="cm">				 * userspace, we want an interruptible</span>
<span class="cm">				 * wait.</span>
<span class="cm">				 */</span>
				<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
				<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">logical_sector</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_lo</span> <span class="o">&amp;&amp;</span>
				    <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">suspend_hi</span><span class="p">)</span>
					<span class="n">schedule</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">add_stripe_bio</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">dd_idx</span><span class="p">,</span> <span class="n">rw</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Stripe is busy expanding or</span>
<span class="cm">				 * add failed due to overlap.  Flush everything</span>
<span class="cm">				 * and wait a while</span>
<span class="cm">				 */</span>
				<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
				<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
				<span class="n">schedule</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">STRIPE_DELAYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">STRIPE_PREREAD_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">);</span>
			<span class="n">mddev_check_plugged</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
			<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* cannot get stripe for read-ahead, just give-up */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">bi</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">rw</span> <span class="o">==</span> <span class="n">WRITE</span> <span class="p">)</span>
			<span class="n">md_write_end</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="n">raid5_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">);</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">reshape_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reshaping is quite different to recovery/resync so it is</span>
<span class="cm">	 * handled quite separately ... here.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On each call to sync_request, we gather one chunk worth of</span>
<span class="cm">	 * destination stripes and flag them as expanding.</span>
<span class="cm">	 * Then we find all the source stripes and request reads.</span>
<span class="cm">	 * As the reads complete, handle_stripe will copy the data</span>
<span class="cm">	 * into the destination stripe and release that stripe.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">first_sector</span><span class="p">,</span> <span class="n">last_sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_disks</span> <span class="o">=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_data_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">writepos</span><span class="p">,</span> <span class="n">readpos</span><span class="p">,</span> <span class="n">safepos</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">stripe_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reshape_sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">stripes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If restarting in the middle, skip the initial sectors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&lt;</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
			   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sector_nr</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">sector_div</span><span class="p">(</span><span class="n">sector_nr</span><span class="p">,</span> <span class="n">new_data_disks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We need to process a full chunk at a time.</span>
<span class="cm">	 * If old and new chunk sizes differ, we need to process the</span>
<span class="cm">	 * largest of these</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="n">reshape_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reshape_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>

	<span class="cm">/* We update the metadata at least every 10 seconds, or when</span>
<span class="cm">	 * the data about to be copied would over-write the source of</span>
<span class="cm">	 * the data at the front of the range.  i.e. one new_stripe</span>
<span class="cm">	 * along from reshape_progress new_maps to after where</span>
<span class="cm">	 * reshape_safe old_maps to</span>
<span class="cm">	 */</span>
	<span class="n">writepos</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">writepos</span><span class="p">,</span> <span class="n">new_data_disks</span><span class="p">);</span>
	<span class="n">readpos</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">readpos</span><span class="p">,</span> <span class="n">data_disks</span><span class="p">);</span>
	<span class="n">safepos</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">safepos</span><span class="p">,</span> <span class="n">data_disks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writepos</span> <span class="o">-=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">sector_t</span><span class="p">,</span> <span class="n">reshape_sectors</span><span class="p">,</span> <span class="n">writepos</span><span class="p">);</span>
		<span class="n">readpos</span> <span class="o">+=</span> <span class="n">reshape_sectors</span><span class="p">;</span>
		<span class="n">safepos</span> <span class="o">+=</span> <span class="n">reshape_sectors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writepos</span> <span class="o">+=</span> <span class="n">reshape_sectors</span><span class="p">;</span>
		<span class="n">readpos</span> <span class="o">-=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">sector_t</span><span class="p">,</span> <span class="n">reshape_sectors</span><span class="p">,</span> <span class="n">readpos</span><span class="p">);</span>
		<span class="n">safepos</span> <span class="o">-=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">sector_t</span><span class="p">,</span> <span class="n">reshape_sectors</span><span class="p">,</span> <span class="n">safepos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Having calculated the &#39;writepos&#39; possibly use it</span>
<span class="cm">	 * to set &#39;stripe_addr&#39; which is where we will write to.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">stripe_addr</span> <span class="o">=</span> <span class="n">writepos</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">reshape_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		       <span class="o">-</span> <span class="n">reshape_sectors</span> <span class="o">-</span> <span class="n">stripe_addr</span>
		       <span class="o">!=</span> <span class="n">sector_nr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">writepos</span> <span class="o">!=</span> <span class="n">sector_nr</span> <span class="o">+</span> <span class="n">reshape_sectors</span><span class="p">);</span>
		<span class="n">stripe_addr</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* &#39;writepos&#39; is the most advanced device address we might write.</span>
<span class="cm">	 * &#39;readpos&#39; is the least advanced device address we might read.</span>
<span class="cm">	 * &#39;safepos&#39; is the least address recorded in the metadata as having</span>
<span class="cm">	 *     been reshaped.</span>
<span class="cm">	 * If there is a min_offset_diff, these are adjusted either by</span>
<span class="cm">	 * increasing the safepos/readpos if diff is negative, or</span>
<span class="cm">	 * increasing writepos if diff is positive.</span>
<span class="cm">	 * If &#39;readpos&#39; is then behind &#39;writepos&#39;, there is no way that we can</span>
<span class="cm">	 * ensure safety in the face of a crash - that must be done by userspace</span>
<span class="cm">	 * making a backup of the data.  So in that case there is no particular</span>
<span class="cm">	 * rush to update metadata.</span>
<span class="cm">	 * Otherwise if &#39;safepos&#39; is behind &#39;writepos&#39;, then we really need to</span>
<span class="cm">	 * update the metadata to advance &#39;safepos&#39; to match &#39;readpos&#39; so that</span>
<span class="cm">	 * we can be safe in the event of a crash.</span>
<span class="cm">	 * So we insist on updating metadata if safepos is behind writepos and</span>
<span class="cm">	 * readpos is beyond writepos.</span>
<span class="cm">	 * In any case, update the metadata every 10 seconds.</span>
<span class="cm">	 * Maybe that number should be configurable, but I&#39;m not sure it is</span>
<span class="cm">	 * worth it.... maybe it could be a multiple of safemode_delay???</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_offset_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">safepos</span> <span class="o">+=</span> <span class="o">-</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_offset_diff</span><span class="p">;</span>
		<span class="n">readpos</span> <span class="o">+=</span> <span class="o">-</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_offset_diff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writepos</span> <span class="o">+=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_offset_diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
	     <span class="o">?</span> <span class="p">(</span><span class="n">safepos</span> <span class="o">&gt;</span> <span class="n">writepos</span> <span class="o">&amp;&amp;</span> <span class="n">readpos</span> <span class="o">&lt;</span> <span class="n">writepos</span><span class="p">)</span>
	     <span class="o">:</span> <span class="p">(</span><span class="n">safepos</span> <span class="o">&lt;</span> <span class="n">writepos</span> <span class="o">&amp;&amp;</span> <span class="n">readpos</span> <span class="o">&gt;</span> <span class="n">writepos</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Cannot proceed until we&#39;ve updated the superblock... */</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			   <span class="n">kthread_should_stop</span><span class="p">());</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stripes</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reshape_sectors</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">skipped_disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">stripe_addr</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_EXPANDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">);</span>
		<span class="cm">/* If any of this stripe is beyond the end of the old</span>
<span class="cm">		 * array, then we need to zero those blocks</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">s</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pd_idx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span>
			    <span class="n">j</span> <span class="o">==</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">qd_idx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">compute_blocknr</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">skipped_disk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">page</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">STRIPE_SIZE</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_Expanded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">R5_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skipped_disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stripes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">-=</span> <span class="n">reshape_sectors</span> <span class="o">*</span> <span class="n">new_data_disks</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">+=</span> <span class="n">reshape_sectors</span> <span class="o">*</span> <span class="n">new_data_disks</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="cm">/* Ok, those stripe are ready. We can start scheduling</span>
<span class="cm">	 * reads on the source stripes.</span>
<span class="cm">	 * The source stripes are determined by mapping the first and last</span>
<span class="cm">	 * block on the destination stripes.</span>
<span class="cm">	 */</span>
	<span class="n">first_sector</span> <span class="o">=</span>
		<span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">stripe_addr</span><span class="o">*</span><span class="p">(</span><span class="n">new_data_disks</span><span class="p">),</span>
				     <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">last_sector</span> <span class="o">=</span>
		<span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="p">((</span><span class="n">stripe_addr</span><span class="o">+</span><span class="n">reshape_sectors</span><span class="p">)</span>
					    <span class="o">*</span> <span class="n">new_data_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
				     <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_sector</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span>
		<span class="n">last_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">first_sector</span> <span class="o">&lt;=</span> <span class="n">last_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">first_sector</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_EXPAND_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_HANDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">first_sector</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now that the sources are clearly marked, we can release</span>
<span class="cm">	 * the destination stripes</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stripes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">stripes</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stripe_head</span><span class="p">,</span> <span class="n">lru</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
		<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If this takes us to the resync_max point where we have to pause,</span>
<span class="cm">	 * then we need to write out the superblock.</span>
<span class="cm">	 */</span>
	<span class="n">sector_nr</span> <span class="o">+=</span> <span class="n">reshape_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sector_nr</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
	    <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cannot proceed until we&#39;ve updated the superblock... */</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span>
			   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync_completed</span> <span class="o">=</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sb_wait</span><span class="p">,</span>
			   <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			   <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">());</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sync_completed&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">reshape_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME go_faster isn&#39;t used */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">sector_t</span> <span class="nf">sync_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">skipped</span><span class="p">,</span> <span class="kt">int</span> <span class="n">go_faster</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">max_sector</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sync_blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sector_nr</span> <span class="o">&gt;=</span> <span class="n">max_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just being told to finish up .. nothing much to do */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">end_reshape</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span> <span class="o">&lt;</span> <span class="n">max_sector</span><span class="p">)</span> <span class="cm">/* aborted */</span>
			<span class="n">bitmap_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">curr_resync</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/* completed sync */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bitmap_close_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow raid5_quiesce to complete */</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">reshape_request</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="n">skipped</span><span class="p">);</span>

	<span class="cm">/* No need to check resync_max as we never do more than one</span>
<span class="cm">	 * stripe, and as resync_max will always be on a chunk boundary,</span>
<span class="cm">	 * if the check in md_do_sync didn&#39;t fire, there is no chance</span>
<span class="cm">	 * of overstepping resync_max here</span>
<span class="cm">	 */</span>

	<span class="cm">/* if there is too many failed drives and we are trying</span>
<span class="cm">	 * to resync, then assert that we are finished, because there is</span>
<span class="cm">	 * nothing we can do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">-</span> <span class="n">sector_nr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">&amp;&amp;</span> <span class="n">sync_blocks</span> <span class="o">&gt;=</span> <span class="n">STRIPE_SECTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we can skip this block, and probably more */</span>
		<span class="n">sync_blocks</span> <span class="o">/=</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span>
		<span class="o">*</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sync_blocks</span> <span class="o">*</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span> <span class="cm">/* keep things rounded to whole stripes */</span>
	<span class="p">}</span>

	<span class="n">bitmap_cond_end_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">);</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* make sure we don&#39;t swamp the stripe cache if someone else</span>
<span class="cm">		 * is trying to get access</span>
<span class="cm">		 */</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Need to check if array will still be degraded after recovery/resync</span>
<span class="cm">	 * We don&#39;t need to check the &#39;failed&#39; flag as when that gets set,</span>
<span class="cm">	 * recovery aborts.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">still_degraded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bitmap_start_sync</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sector_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sync_blocks</span><span class="p">,</span> <span class="n">still_degraded</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STRIPE_SYNC_REQUESTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">handle_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STRIPE_SECTORS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">retry_aligned_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">raid_bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We may not be able to submit a whole bio at once as there</span>
<span class="cm">	 * may not be enough stripe_heads available.</span>
<span class="cm">	 * We cannot pre-allocate enough stripe_heads as we may need</span>
<span class="cm">	 * more than exist in the cache (if we allow ever large chunks).</span>
<span class="cm">	 * So we do one stripe head at a time and record in</span>
<span class="cm">	 * -&gt;bi_hw_segments how many have been done.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We *know* that this entire raid_bio is in one chunk, so</span>
<span class="cm">	 * it will be only one &#39;dd_idx&#39; and only need one call to raid5_compute_sector.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dd_idx</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="n">logical_sector</span><span class="p">,</span> <span class="n">last_sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">logical_sector</span> <span class="o">=</span> <span class="n">raid_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">STRIPE_SECTORS</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">raid5_compute_sector</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">logical_sector</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd_idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">last_sector</span> <span class="o">=</span> <span class="n">raid_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="p">(</span><span class="n">raid_bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">logical_sector</span> <span class="o">&lt;</span> <span class="n">last_sector</span><span class="p">;</span>
	     <span class="n">logical_sector</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
		     <span class="n">sector</span> <span class="o">+=</span> <span class="n">STRIPE_SECTORS</span><span class="p">,</span>
		     <span class="n">scnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scnt</span> <span class="o">&lt;</span> <span class="n">raid5_bi_hw_segments</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">))</span>
			<span class="cm">/* already done this stripe */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sh</span> <span class="o">=</span> <span class="n">get_active_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* failed to get a stripe - must wait */</span>
			<span class="n">raid5_set_bi_hw_segments</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">,</span> <span class="n">scnt</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned</span> <span class="o">=</span> <span class="n">raid_bio</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_stripe_bio</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">raid_bio</span><span class="p">,</span> <span class="n">dd_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
			<span class="n">raid5_set_bi_hw_segments</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">,</span> <span class="n">scnt</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">retry_read_aligned</span> <span class="o">=</span> <span class="n">raid_bio</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">handle_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">raid5_dec_bi_phys_segments</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">raid_bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_aligned_reads</span><span class="p">))</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is our raid5 kernel thread.</span>
<span class="cm"> *</span>
<span class="cm"> * We scan the hash table for stripes which can be handled now.</span>
<span class="cm"> * During the scan, completed stripes are saved for us by the interrupt</span>
<span class="cm"> * handler, so that they will not have to wait for our next wakeup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5d</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stripe_head</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;+++ raid5d active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bitmap_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Now is a good time to flush some bitmap updates */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">seq_flush</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">bitmap_unplug</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">seq_write</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">seq_flush</span><span class="p">;</span>
			<span class="n">activate_bit_delay</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">plug_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">raid5_activate_delayed</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">bio</span> <span class="o">=</span> <span class="n">remove_bio_from_retry</span><span class="p">(</span><span class="n">conf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">ok</span> <span class="o">=</span> <span class="n">retry_aligned_read</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sh</span> <span class="o">=</span> <span class="n">__get_priority_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		
		<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handle_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">release_stripe</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MD_CHANGE_PENDING</span><span class="p">))</span>
			<span class="n">md_check_recovery</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d stripes handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handled</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="n">async_tx_issue_pending_all</span><span class="p">();</span>
	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;--- raid5d inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid5_show_stripe_cache_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">raid5_set_cache_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">32768</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drop_one_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">md_allow_write</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grow_one_stripe</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">raid5_set_cache_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid5_store_stripe_cache_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">raid5_set_cache_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span>
<span class="n">raid5_stripecache_size</span> <span class="o">=</span> <span class="n">__ATTR</span><span class="p">(</span><span class="n">stripe_cache_size</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">raid5_show_stripe_cache_size</span><span class="p">,</span>
				<span class="n">raid5_store_stripe_cache_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid5_show_preread_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">raid5_store_preread_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span>
<span class="n">raid5_preread_bypass_threshold</span> <span class="o">=</span> <span class="n">__ATTR</span><span class="p">(</span><span class="n">preread_bypass_threshold</span><span class="p">,</span>
					<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
					<span class="n">raid5_show_preread_threshold</span><span class="p">,</span>
					<span class="n">raid5_store_preread_threshold</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">stripe_cache_active_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_sysfs_entry</span>
<span class="n">raid5_stripecache_active</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">stripe_cache_active</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">raid5_attrs</span><span class="p">[]</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">raid5_stripecache_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">raid5_stripecache_active</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">raid5_preread_bypass_threshold</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">raid5_attrs_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">raid5_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">sector_t</span>
<span class="nf">raid5_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sectors</span><span class="p">)</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_disks</span><span class="p">)</span>
		<span class="cm">/* size is defined by the smallest of previous and new size */</span>
		<span class="n">raid_disks</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">);</span>

	<span class="n">sectors</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sectors</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sectors</span> <span class="o">*</span> <span class="p">(</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_free_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">get_online_cpus</span><span class="p">();</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">percpu</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">safe_put_page</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="n">unregister_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cpu_notify</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">put_online_cpus</span><span class="p">();</span>

	<span class="n">free_percpu</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shrink_stripes</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">raid5_free_percpu</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">stripe_hashtbl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid456_cpu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nfb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nfb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r5conf</span><span class="p">,</span> <span class="n">cpu_notify</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="o">*</span><span class="n">percpu</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_UP_PREPARE</span>:
	<span class="k">case</span> <span class="n">CPU_UP_PREPARE_FROZEN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">)</span>
			<span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">)</span>
			<span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">scribble_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">safe_put_page</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed memory allocation for cpu%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">safe_put_page</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span><span class="p">);</span>
		<span class="n">percpu</span><span class="o">-&gt;</span><span class="n">spare_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">percpu</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">spare_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raid5_percpu</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">allcpus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">scribble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">allcpus</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">raid5_percpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allcpus</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span> <span class="o">=</span> <span class="n">allcpus</span><span class="p">;</span>

	<span class="n">get_online_cpus</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_present_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spare_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spare_page</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spare_page</span> <span class="o">=</span> <span class="n">spare_page</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">scribble</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">scribble_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scribble</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scribble</span> <span class="o">=</span> <span class="n">scribble</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">cpu_notify</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">raid456_cpu_notify</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">cpu_notify</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">register_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">cpu_notify</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">put_online_cpus</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="nf">setup_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid_disk</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">max_disks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pers_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">!=</span> <span class="mi">5</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">!=</span> <span class="mi">4</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: raid level not set to 4/5/6 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">==</span> <span class="mi">5</span>
	     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">algorithm_valid_raid5</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">==</span> <span class="mi">6</span>
	     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">algorithm_valid_raid6</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: layout %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: not enough configured devices (%d, minimum 4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: invalid chunk size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">handle_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hold_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">delayed_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bitmap_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">inactive_list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">preread_active_stripes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_aligned_reads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bypass_threshold</span> <span class="o">=</span> <span class="n">BYPASS_THRESHOLD</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
	<span class="n">max_disks</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">scribble_len</span> <span class="o">=</span> <span class="n">scribble_len</span><span class="p">(</span><span class="n">max_disks</span><span class="p">);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max_disks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">disk_info</span><span class="p">),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">stripe_hashtbl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid5_alloc_percpu</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raid456: run(%s) called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raid_disk</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="n">max_disks</span>
		    <span class="o">||</span> <span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">disk</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">raid_disk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid:%s: device %s operational as raid&quot;</span>
			       <span class="s">&quot; disk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">raid_disk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">!=</span> <span class="n">raid_disk</span><span class="p">)</span>
			<span class="cm">/* Cannot rely on bitmap to complete recovery */</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span> <span class="o">=</span> <span class="n">NR_STRIPES</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_algo</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memory</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stripe_head</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">max_disks</span> <span class="o">*</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grow_stripes</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;md/raid:%s: couldn&#39;t allocate %dkB for buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">memory</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid:%s: allocated %dkB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">memory</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">pers_name</span><span class="p">,</span> <span class="s">&quot;raid%d&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">raid5d</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span> <span class="n">pers_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;md/raid:%s: couldn&#39;t allocate thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>

 <span class="nl">abort:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">only_parity</span><span class="p">(</span><span class="kt">int</span> <span class="n">raid_disk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">algo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raid_disks</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_degraded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">algo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="n">max_degraded</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="n">max_degraded</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0_6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_disk</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
		    <span class="n">raid_disk</span> <span class="o">==</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC_6</span>:
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC_6</span>:
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC_6</span>:
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC_6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_disk</span> <span class="o">==</span> <span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">working_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dirty_parity_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">reshape_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">long</span> <span class="n">min_offset_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;md/raid:%s: not clean&quot;</span>
		       <span class="s">&quot; -- starting background reconstruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="kt">long</span> <span class="n">diff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
			 <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_offset_diff</span><span class="p">)</span>
			<span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">&amp;&amp;</span>
			 <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">min_offset_diff</span><span class="p">)</span>
			<span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check that we can continue the reshape.</span>
<span class="cm">		 * Difficulties arise if the stripe we would write to</span>
<span class="cm">		 * next is at or after the stripe we would read from next.</span>
<span class="cm">		 * For a reshape that changes the number of devices, this</span>
<span class="cm">		 * is only possible for a very short time, and mdadm makes</span>
<span class="cm">		 * sure that time appears to have past before assembling</span>
<span class="cm">		 * the array.  So we fail if that time hasn&#39;t passed.</span>
<span class="cm">		 * For a reshape that keeps the number of devices the same</span>
<span class="cm">		 * mdadm must be monitoring the reshape can keeping the</span>
<span class="cm">		 * critical areas read-only and backed up.  It will start</span>
<span class="cm">		 * the array in read-only mode, so we check for that.</span>
<span class="cm">		 */</span>
		<span class="n">sector_t</span> <span class="n">here_new</span><span class="p">,</span> <span class="n">here_old</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">old_disks</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_degraded</span> <span class="o">=</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: unsupported reshape &quot;</span>
			       <span class="s">&quot;required - aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">old_disks</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
		<span class="cm">/* reshape_position must be on a new-stripe boundary, and one</span>
<span class="cm">		 * further up in new geometry must map after here in old</span>
<span class="cm">		 * geometry.</span>
<span class="cm">		 */</span>
		<span class="n">here_new</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_div</span><span class="p">(</span><span class="n">here_new</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">*</span>
			       <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">max_degraded</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: reshape_position not &quot;</span>
			       <span class="s">&quot;on a stripe boundary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reshape_offset</span> <span class="o">=</span> <span class="n">here_new</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
		<span class="cm">/* here_new is the stripe we will write to */</span>
		<span class="n">here_old</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span><span class="p">;</span>
		<span class="n">sector_div</span><span class="p">(</span><span class="n">here_old</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">*</span>
			   <span class="p">(</span><span class="n">old_disks</span><span class="o">-</span><span class="n">max_degraded</span><span class="p">));</span>
		<span class="cm">/* here_old is the first stripe that we might need to read</span>
<span class="cm">		 * from */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">here_new</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">!=</span>
			     <span class="n">here_old</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: reshape position is&quot;</span>
				       <span class="s">&quot; confused - aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* We cannot be sure it is safe to start an in-place</span>
<span class="cm">			 * reshape.  It is only safe if user-space is monitoring</span>
<span class="cm">			 * and taking constant backups.</span>
<span class="cm">			 * mdadm always starts a situation like this in</span>
<span class="cm">			 * readonly mode so it can take control before</span>
<span class="cm">			 * allowing any writes.  So just check for that.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">min_offset_diff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&amp;&amp;</span>
			    <span class="n">abs</span><span class="p">(</span><span class="n">min_offset_diff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">)</span>
				<span class="cm">/* not really in-place - so OK */</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: in-place reshape &quot;</span>
				       <span class="s">&quot;must be started in read-only mode &quot;</span>
				       <span class="s">&quot;- aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span>
		    <span class="o">?</span> <span class="p">(</span><span class="n">here_new</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">+</span> <span class="n">min_offset_diff</span> <span class="o">&lt;=</span>
		       <span class="n">here_old</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span>
		    <span class="o">:</span> <span class="p">(</span><span class="n">here_new</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&gt;=</span>
		       <span class="n">here_old</span> <span class="o">*</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">min_offset_diff</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Reading from the same stripe as writing to - bad */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: reshape_position too early for &quot;</span>
			       <span class="s">&quot;auto-recovery - aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid:%s: reshape will continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="cm">/* OK, we should be able to continue; */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">!=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_offset_diff</span> <span class="o">=</span> <span class="n">min_offset_diff</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The replacement is all we have yet */</span>
			<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">replacement</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* replacements and reshape simply do not mix. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md: cannot handle concurrent &quot;</span>
			       <span class="s">&quot;replacement and reshape.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">working_disks</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* This disc is not fully in-sync.  However if it</span>
<span class="cm">		 * just stored parity (beyond the recovery_offset),</span>
<span class="cm">		 * when we don&#39;t need to be concerned about the</span>
<span class="cm">		 * array being dirty.</span>
<span class="cm">		 * When reshape goes &#39;backwards&#39;, we never have</span>
<span class="cm">		 * partially completed devices, so we only need</span>
<span class="cm">		 * to worry about reshape going forwards.</span>
<span class="cm">		 */</span>
		<span class="cm">/* Hack because v0.91 doesn&#39;t store recovery_offset properly. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="n">reshape_offset</span><span class="p">;</span>
			
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">&lt;</span> <span class="n">reshape_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We need to check old and new layout */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">only_parity</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
					 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">only_parity</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">,</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_algo</span><span class="p">,</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">,</span>
				 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dirty_parity_disks</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 0 for a fully functional array, 1 or 2 for a degraded array.</span>
<span class="cm">	 */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_failed</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: not enough operational devices&quot;</span>
			<span class="s">&quot; (%d/%d failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* device size must be a multiple of chunk size */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="n">dirty_parity_disks</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">ok_start_degraded</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;md/raid:%s: starting dirty degraded array&quot;</span>
			       <span class="s">&quot; - data corruption possible.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;md/raid:%s: cannot start dirty degraded array.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;md/raid:%s: raid level %d active with %d out of %d&quot;</span>
		       <span class="s">&quot; devices, algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="o">-</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md/raid:%s: raid level %d active with %d&quot;</span>
		       <span class="s">&quot; out of %d devices, algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">,</span>
		       <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">);</span>

	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">!=</span> <span class="n">MaxSector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span>
							<span class="s">&quot;reshape&quot;</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/* Ok, everything is just fine now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">raid5_attrs_group</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">sd</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raid5_attrs_group</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;raid5: failed to create sysfs attributes for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chunk_size</span><span class="p">;</span>
		<span class="cm">/* read-ahead size must cover two whole stripes, which</span>
<span class="cm">		 * is 2 * (datadisks) * chunksize where &#39;n&#39; is the</span>
<span class="cm">		 * number of raid devices</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">data_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">stripe</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">*</span>
			<span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">)</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">;</span>

		<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">raid5_mergeable_bvec</span><span class="p">);</span>

		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_data</span> <span class="o">=</span> <span class="n">mddev</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="n">raid5_congested</span><span class="p">;</span>

		<span class="n">chunk_size</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">blk_queue_io_min</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>
		<span class="n">blk_queue_io_opt</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">*</span>
				 <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">));</span>

		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">disk_stack_limits</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span>
					  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">abort:</span>
	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">free_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;md/raid:%s: failed to run raid set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">md_unregister_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">congested_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">to_remove</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raid5_attrs_group</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; level %d, %dk chunk, algorithm %d&quot;</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">);</span>
	<span class="n">seq_printf</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; [%d/%d] [&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			       <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span>
			       <span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;U&quot;</span> <span class="o">:</span> <span class="s">&quot;_&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_raid5_conf</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RAID conf printout:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(conf==NULL)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; --- level:%d rd:%d wd:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span>
	       <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">,</span>
	       <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; disk %d, o:%d, dev:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span>
			       <span class="n">bdevname</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_spare_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span>
		    <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">==</span> <span class="n">MaxSector</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Replacement has just become active. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span>
			    <span class="o">||</span> <span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Replaced device not technically faulty,</span>
<span class="cm">				 * but we need to be sure it gets removed</span>
<span class="cm">				 * and never re-added.</span>
<span class="cm">				 */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span>
					<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span>
		    <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">==</span> <span class="n">MaxSector</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sysfs_notify_dirent_safe</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">sysfs_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_remove_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">**</span><span class="n">rdevp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">number</span><span class="p">;</span>

	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span>
		<span class="n">rdevp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span>
		<span class="n">rdevp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">==</span> <span class="n">MaxSector</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Only remove non-faulty devices if recovery</span>
<span class="cm">	 * isn&#39;t possible.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">has_failed</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">==</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">number</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">rdevp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">nr_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* lost the race, try later */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rdevp</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We must have just cleared &#39;rdev&#39; */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span> <span class="cm">/* Make sure other CPUs may see both as identical</span>
<span class="cm">			   * but will never see neither - if they are careful</span>
<span class="cm">			   */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* We might have just removed the Replacement as faulty-</span>
<span class="cm">		 * clear the bit just in case</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">abort:</span>

	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_add_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span> <span class="o">==</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">recovery_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">has_failed</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="cm">/* no point adding a device */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * find the disk ... but prefer rdev-&gt;saved_raid_disk</span>
<span class="cm">	 * if possible.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">&gt;=</span> <span class="n">first</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span><span class="p">].</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">saved_raid_disk</span> <span class="o">!=</span> <span class="n">disk</span><span class="p">)</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span> <span class="o">+</span> <span class="n">disk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WantReplacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">Replacement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fullsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">replacement</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">print_raid5_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no resync is happening, and there is enough space</span>
<span class="cm">	 * on all devices, so we can resize.</span>
<span class="cm">	 * We need to make sure resync covers any new space.</span>
<span class="cm">	 * If the array is shrinking we should possibly wait until</span>
<span class="cm">	 * any io in the removed space completes, but it hardly seems</span>
<span class="cm">	 * worth it.</span>
<span class="cm">	 */</span>
	<span class="n">sector_t</span> <span class="n">newsize</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">sector_t</span><span class="p">)</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">newsize</span> <span class="o">=</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">external_size</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&gt;</span> <span class="n">newsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bitmap_resize</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
	<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">&gt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_NEEDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">resync_max_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_stripe_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Can only proceed if there are plenty of stripe_heads.</span>
<span class="cm">	 * We need a minimum of one full stripe,, and for sensible progress</span>
<span class="cm">	 * it is best to have about 4 times that.</span>
<span class="cm">	 * If we require 4 times, then the default 256 4K stripe_heads will</span>
<span class="cm">	 * allow for chunk sizes up to 256K, which is probably OK.</span>
<span class="cm">	 * If the chunk size is greater, user-space should request more</span>
<span class="cm">	 * stripe_heads first.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">STRIPE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
	    <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">STRIPE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
	    <span class="o">&gt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_nr_stripes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;md/raid:%s: reshape: not enough stripes.  Needed %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">max</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="o">/</span> <span class="n">STRIPE_SIZE</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">==</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_failed</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We might be able to shrink, but the devices must</span>
<span class="cm">		 * be made bigger first.</span>
<span class="cm">		 * For raid6, 4 is the minimum size.</span>
<span class="cm">		 * Otherwise 2 is the minimum</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_stripe_cache</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">resize_stripes</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_start_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spares</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_stripe_cache</span><span class="p">(</span><span class="n">mddev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_failed</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">spares</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spares</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">)</span>
		<span class="cm">/* Not enough devices even to make a degraded array</span>
<span class="cm">		 * of that size</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Refuse to reduce size of the array.  Any reductions in</span>
<span class="cm">	 * array size must be through explicit setting of array_size</span>
<span class="cm">	 * attribute.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">)</span>
	    <span class="o">&lt;</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: array size must be reduced &quot;</span>
		       <span class="s">&quot;before number of disks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_stripes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_chunk_sectors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">prev_algo</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">generation</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Code that selects data_offset needs to see the generation update</span>
<span class="cm">	 * if reshape_progress has been set - so a memory barrier needed.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_safe</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="cm">/* Add some new drives, as many as will fit.</span>
<span class="cm">	 * We know there are enough to make the newly sized array work.</span>
<span class="cm">	 * Don&#39;t add devices if we are reducing the number of</span>
<span class="cm">	 * devices in the array.  This is because it is not possible</span>
<span class="cm">	 * to correctly record the &quot;partially reconstructed&quot; state of</span>
<span class="cm">	 * such devices during the reshape and confusion could result.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">raid5_add_disk</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span>
					    <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">)</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">recovery_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_link_rdev</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">))</span>
						<span class="cm">/* Failure here is OK */</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">raid_disk</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span>
				   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">Faulty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* This is a spare that was manually added */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="cm">/* When a reshape changes the number of devices,</span>
<span class="cm">		 * -&gt;degraded is measured against the larger of the</span>
<span class="cm">		 * pre and post number of devices.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_CHECK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RESHAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span> <span class="o">=</span> <span class="n">md_register_thread</span><span class="p">(</span><span class="n">md_do_sync</span><span class="p">,</span> <span class="n">mddev</span><span class="p">,</span>
						<span class="s">&quot;reshape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span><span class="p">;</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mddev</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_checkpoint</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">sync_thread</span><span class="p">);</span>
	<span class="n">md_new_event</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is called from the reshape thread and should make any</span>
<span class="cm"> * changes needed in &#39;conf&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">end_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">previous_raid_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span><span class="p">;</span>
		<span class="n">rdev_for_each</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">new_data_offset</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">reshape_progress</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>

		<span class="cm">/* read-ahead size must cover two whole stripes, which is</span>
<span class="cm">		 * 2 * (datadisks) * chunksize where &#39;n&#39; is the number of raid devices</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">data_disks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_degraded</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">stripe</span> <span class="o">=</span> <span class="n">data_disks</span> <span class="o">*</span> <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span>
						   <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">)</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">.</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stripe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This is called from the raid5d thread with mddev_lock held.</span>
<span class="cm"> * It makes config changes to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_finish_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">MD_RECOVERY_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">md_set_array_sectors</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="n">raid5_size</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">set_capacity</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">,</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span><span class="p">);</span>
			<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">=</span> <span class="n">calc_degraded</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="p">;</span>
			     <span class="n">d</span> <span class="o">&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span><span class="p">;</span>
			     <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">md_rdev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">rdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">rdev</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">d</span><span class="p">].</span><span class="n">replacement</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">In_sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_position</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">reshape_backwards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* resume for a suspend */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* stop all writes */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="cm">/* &#39;2&#39; tells resync/reshape to pause so that all</span>
<span class="cm">		 * active stripes can drain</span>
<span class="cm">		 */</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">wait_event_lock_irq</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">,</span>
				    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_stripes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">active_aligned_reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">,</span> <span class="cm">/* nothing */</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="cm">/* allow reshape to continue */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* re-enable writes */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiesce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_stripe</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">wait_for_overlap</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid45_takeover_raid0</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r0conf</span> <span class="o">*</span><span class="n">raid0_conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sectors</span><span class="p">;</span>

	<span class="cm">/* for raid0 takeover only one zone is supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid0_conf</span><span class="o">-&gt;</span><span class="n">nr_strip_zones</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;md/raid:%s: cannot takeover raid0 with more than one zone.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mdname</span><span class="p">(</span><span class="n">mddev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sectors</span> <span class="o">=</span> <span class="n">raid0_conf</span><span class="o">-&gt;</span><span class="n">strip_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">zone_end</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="n">raid0_conf</span><span class="o">-&gt;</span><span class="n">strip_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nb_dev</span><span class="p">);</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">dev_sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_N</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* make sure it will be not marked as dirty */</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">recovery_cp</span> <span class="o">=</span> <span class="n">MaxSector</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid5_takeover_raid1</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chunksect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* Should check if there are write-behind devices? */</span>

	<span class="n">chunksect</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* 64K by default */</span>

	<span class="cm">/* The array must be an exact multiple of chunksize */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">chunksect</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chunksect</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">chunksect</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chunksect</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STRIPE_SIZE</span><span class="p">)</span>
		<span class="cm">/* array size does not allow a suitable chunk size */</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span> <span class="o">=</span> <span class="n">chunksect</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid5_takeover_raid6</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_layout</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC_6</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC_6</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC_6</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC_6</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0_6</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_N</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">new_layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid5_check_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For a 2-drive array, the layout and chunk size can be changed</span>
<span class="cm">	 * immediately as not restriping is needed.</span>
<span class="cm">	 * For larger arrays we record the new value - after validation</span>
<span class="cm">	 * to be used by a reshape pass.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">r5conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">algorithm_valid_raid5</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">new_chunk</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_chunk</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_chunk</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* not factor of array size */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* They look valid */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* can make the change immediately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">new_chunk</span> <span class="p">;</span>
			<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">chunk_sectors</span> <span class="o">=</span> <span class="n">new_chunk</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MD_CHANGE_DEVS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">md_wakeup_thread</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raid6_check_reshape</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_chunk</span> <span class="o">=</span> <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_chunk_sectors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">algorithm_valid_raid6</span><span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">new_chunk</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_chunk</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">array_sectors</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_chunk</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* not factor of array size */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* They look valid */</span>
	<span class="k">return</span> <span class="n">check_reshape</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid5_takeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* raid5 can take over:</span>
<span class="cm">	 *  raid0 - if there is only one strip zone - make it a raid4 layout</span>
<span class="cm">	 *  raid1 - if there are two drives.  We need to know the chunk size</span>
<span class="cm">	 *  raid4 - trivial - just use a raid4 layout.</span>
<span class="cm">	 *  raid6 - Providing it is a *_6 layout</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">raid45_takeover_raid0</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">raid5_takeover_raid1</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_N</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">raid5_takeover_raid6</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid4_takeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* raid4 can take over:</span>
<span class="cm">	 *  raid0 - if there is only one strip zone</span>
<span class="cm">	 *  raid5 - if layout is right</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">raid45_takeover_raid0</span><span class="p">(</span><span class="n">mddev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">==</span> <span class="n">ALGORITHM_PARITY_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid5_personality</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">raid6_takeover</span><span class="p">(</span><span class="k">struct</span> <span class="n">mddev</span> <span class="o">*</span><span class="n">mddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Currently can only take over a raid5.  We map the</span>
<span class="cm">	 * personality to an equivalent raid6 personality</span>
<span class="cm">	 * with the Q block at the end.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">new_layout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">raid5_personality</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">degraded</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&gt;</span> <span class="mi">253</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mddev</span><span class="o">-&gt;</span><span class="n">layout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_LEFT_ASYMMETRIC_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_RIGHT_ASYMMETRIC_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_LEFT_SYMMETRIC_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_RIGHT_SYMMETRIC_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_0</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_0_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALGORITHM_PARITY_N</span>:
		<span class="n">new_layout</span> <span class="o">=</span> <span class="n">ALGORITHM_PARITY_N</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_level</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">new_layout</span> <span class="o">=</span> <span class="n">new_layout</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">delta_disks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mddev</span><span class="o">-&gt;</span><span class="n">raid_disks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">setup_conf</span><span class="p">(</span><span class="n">mddev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid6_personality</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raid6&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">level</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_request</span>	<span class="o">=</span> <span class="n">make_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run</span>		<span class="o">=</span> <span class="n">run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span>		<span class="o">=</span> <span class="n">status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>	<span class="o">=</span> <span class="n">error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_add_disk</span>	<span class="o">=</span> <span class="n">raid5_add_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_remove_disk</span><span class="o">=</span> <span class="n">raid5_remove_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spare_active</span>	<span class="o">=</span> <span class="n">raid5_spare_active</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_request</span>	<span class="o">=</span> <span class="n">sync_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">raid5_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">raid5_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reshape</span>	<span class="o">=</span> <span class="n">raid6_check_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_reshape</span>  <span class="o">=</span> <span class="n">raid5_start_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish_reshape</span> <span class="o">=</span> <span class="n">raid5_finish_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quiesce</span>	<span class="o">=</span> <span class="n">raid5_quiesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">takeover</span>	<span class="o">=</span> <span class="n">raid6_takeover</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid5_personality</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raid5&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">level</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_request</span>	<span class="o">=</span> <span class="n">make_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run</span>		<span class="o">=</span> <span class="n">run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span>		<span class="o">=</span> <span class="n">status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>	<span class="o">=</span> <span class="n">error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_add_disk</span>	<span class="o">=</span> <span class="n">raid5_add_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_remove_disk</span><span class="o">=</span> <span class="n">raid5_remove_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spare_active</span>	<span class="o">=</span> <span class="n">raid5_spare_active</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_request</span>	<span class="o">=</span> <span class="n">sync_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">raid5_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">raid5_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reshape</span>	<span class="o">=</span> <span class="n">raid5_check_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_reshape</span>  <span class="o">=</span> <span class="n">raid5_start_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish_reshape</span> <span class="o">=</span> <span class="n">raid5_finish_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quiesce</span>	<span class="o">=</span> <span class="n">raid5_quiesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">takeover</span>	<span class="o">=</span> <span class="n">raid5_takeover</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">md_personality</span> <span class="n">raid4_personality</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raid4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">level</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_request</span>	<span class="o">=</span> <span class="n">make_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run</span>		<span class="o">=</span> <span class="n">run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span>		<span class="o">=</span> <span class="n">status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>	<span class="o">=</span> <span class="n">error</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_add_disk</span>	<span class="o">=</span> <span class="n">raid5_add_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hot_remove_disk</span><span class="o">=</span> <span class="n">raid5_remove_disk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spare_active</span>	<span class="o">=</span> <span class="n">raid5_spare_active</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_request</span>	<span class="o">=</span> <span class="n">sync_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span>		<span class="o">=</span> <span class="n">raid5_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">raid5_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reshape</span>	<span class="o">=</span> <span class="n">raid5_check_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_reshape</span>  <span class="o">=</span> <span class="n">raid5_start_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish_reshape</span> <span class="o">=</span> <span class="n">raid5_finish_reshape</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quiesce</span>	<span class="o">=</span> <span class="n">raid5_quiesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">takeover</span>	<span class="o">=</span> <span class="n">raid4_takeover</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">raid5_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid6_personality</span><span class="p">);</span>
	<span class="n">register_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid5_personality</span><span class="p">);</span>
	<span class="n">register_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid4_personality</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raid5_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid6_personality</span><span class="p">);</span>
	<span class="n">unregister_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid5_personality</span><span class="p">);</span>
	<span class="n">unregister_md_personality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid4_personality</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">raid5_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">raid5_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RAID4/5/6 (striping with parity) personality for MD&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-personality-4&quot;</span><span class="p">);</span> <span class="cm">/* RAID5 */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-raid5&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-raid4&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-level-5&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-level-4&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-personality-8&quot;</span><span class="p">);</span> <span class="cm">/* RAID6 */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-raid6&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;md-level-6&quot;</span><span class="p">);</span>

<span class="cm">/* This used to be two separate modules, they were: */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;raid5&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;raid6&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
