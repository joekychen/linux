<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › moxa.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>moxa.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *           moxa.c  -- MOXA Intellio family multiport serial driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 1999-2000  Moxa Technologies (support@moxa.com).</span>
<span class="cm"> *      Copyright (c) 2007 Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      This code is loosely based on the Linux serial driver, written by</span>
<span class="cm"> *      Linus Torvalds, Theodore T&#39;so and others.</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *    MOXA Intellio Series Driver</span>
<span class="cm"> *      for             : LINUX</span>
<span class="cm"> *      date            : 1999/1/7</span>
<span class="cm"> *      version         : 5.1</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;moxa.h&quot;</span>

<span class="cp">#define MOXA_VERSION		&quot;6.0k&quot;</span>

<span class="cp">#define MOXA_FW_HDRLEN		32</span>

<span class="cp">#define MOXAMAJOR		172</span>

<span class="cp">#define MAX_BOARDS		4	</span><span class="cm">/* Don&#39;t change this value */</span><span class="cp"></span>
<span class="cp">#define MAX_PORTS_PER_BOARD	32	</span><span class="cm">/* Don&#39;t change this value */</span><span class="cp"></span>
<span class="cp">#define MAX_PORTS		(MAX_BOARDS * MAX_PORTS_PER_BOARD)</span>

<span class="cp">#define MOXA_IS_320(brd) ((brd)-&gt;boardType == MOXA_BOARD_C320_ISA || \</span>
<span class="cp">		(brd)-&gt;boardType == MOXA_BOARD_C320_PCI)</span>

<span class="cm">/*</span>
<span class="cm"> *    Define the Moxa PCI vendor and device IDs.</span>
<span class="cm"> */</span>
<span class="cp">#define MOXA_BUS_TYPE_ISA	0</span>
<span class="cp">#define MOXA_BUS_TYPE_PCI	1</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MOXA_BOARD_C218_PCI</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MOXA_BOARD_C218_ISA</span><span class="p">,</span>
	<span class="n">MOXA_BOARD_C320_PCI</span><span class="p">,</span>
	<span class="n">MOXA_BOARD_C320_ISA</span><span class="p">,</span>
	<span class="n">MOXA_BOARD_CP204J</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">moxa_brdname</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;C218 Turbo PCI series&quot;</span><span class="p">,</span>
	<span class="s">&quot;C218 Turbo ISA series&quot;</span><span class="p">,</span>
	<span class="s">&quot;C320 Turbo PCI series&quot;</span><span class="p">,</span>
	<span class="s">&quot;C320 Turbo ISA series&quot;</span><span class="p">,</span>
	<span class="s">&quot;CP-204J series&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">moxa_pcibrds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_C218</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MOXA_BOARD_C218_PCI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_C320</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MOXA_BOARD_C320_PCI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP204J</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MOXA_BOARD_CP204J</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">moxa_pcibrds</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">moxa_port</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">boardType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numPorts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busType</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ready</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">basemem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">intNdx</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">intPend</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">intTable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">moxa_boards</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">mxser_mstatus</span> <span class="p">{</span>
	<span class="n">tcflag_t</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">moxaq_str</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">inq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">outq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">moxa_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tableAddr</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">statusflags</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">DCDState</span><span class="p">;</span>		<span class="cm">/* Protected by the port lock */</span>
	<span class="n">u8</span> <span class="n">lineCtrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lowChkFlag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mon_str</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">tick</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxcnt</span><span class="p">[</span><span class="n">MAX_PORTS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">txcnt</span><span class="p">[</span><span class="n">MAX_PORTS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* statusflags */</span>
<span class="cp">#define TXSTOPPED	1</span>
<span class="cp">#define LOWWAIT 	2</span>
<span class="cp">#define EMPTYWAIT	3</span>

<span class="cp">#define SERIAL_DO_RESTART</span>

<span class="cp">#define WAKEUP_CHARS		256</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ttymajor</span> <span class="o">=</span> <span class="n">MOXAMAJOR</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mon_str</span> <span class="n">moxaLog</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">moxaFuncTout</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">moxaLowWaterChk</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">moxa_openlock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">moxa_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseaddr</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numports</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;William Chen&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MOXA Intellio Family Multiport Board Device Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;c218tunx.cod&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;cp204unx.cod&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;c320tunx.cod&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;card type: C218=2, C320=4&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">,</span> <span class="s">&quot;base address&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">numports</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">numports</span><span class="p">,</span> <span class="s">&quot;numports (ignored for C218)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * static functions:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_set_tty_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">moxa_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * moxa board interface functions:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortSetTermio</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="p">,</span> <span class="n">speed_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortGetLineOut</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortLineCtrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortFlowCtrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortLineStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortFlushData</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortWriteData</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortReadData</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortRxQueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MoxaPortTxFree</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortTxDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaPortTxEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">moxa_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoxaSetFifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * I/O functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">moxafunc_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_wait_finish</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">moxaFuncTout</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncCode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncCode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;moxa function expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxafunc</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncArg</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncCode</span><span class="p">);</span>
	<span class="n">moxa_wait_finish</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxafuncret</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncArg</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncCode</span><span class="p">);</span>
	<span class="n">moxa_wait_finish</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncArg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_low_water_check</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rptr</span><span class="p">,</span> <span class="n">wptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FlagStat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Xoff_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXrptr</span><span class="p">);</span>
		<span class="n">wptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXwptr</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">wptr</span> <span class="o">-</span> <span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">Low_water</span><span class="p">)</span>
			<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SendXon</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TTY operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">MOXA_GETDATACOUNT</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">MOXA_GET_IOQUEUE</span> <span class="o">&amp;&amp;</span>
				<span class="n">cmd</span> <span class="o">!=</span> <span class="n">MOXA_GETMSTATUS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_GETDATACOUNT</span>:
		<span class="n">moxaLog</span><span class="p">.</span><span class="n">tick</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">moxaLog</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">moxaLog</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_FLUSH_QUEUE</span>:
		<span class="n">MoxaPortFlushData</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_GET_IOQUEUE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">moxaq_str</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argm</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">moxaq_str</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">argm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">inq</span> <span class="o">=</span> <span class="n">MoxaPortRxQueue</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">outq</span> <span class="o">=</span> <span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">case</span> <span class="n">MOXA_GET_OQUEUE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_GET_IQUEUE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">MoxaPortRxQueue</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_GETMSTATUS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mxser_mstatus</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argm</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mxser_mstatus</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">argm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">ttyp</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
				        <span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">copy</span><span class="p">;</span>
                                <span class="p">}</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">MoxaPortLineStatus</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">cts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">dsr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">ttyp</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ttyp</span> <span class="o">||</span> <span class="o">!</span><span class="n">ttyp</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cflag</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">tmp</span><span class="p">.</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">ttyp</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">ttyp</span><span class="p">);</span>
<span class="nl">copy:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
	        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_get_serial_info</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
	        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_set_serial_info</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">moxafunc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">,</span> <span class="n">state</span> <span class="o">?</span> <span class="n">FC_SendBreak</span> <span class="o">:</span> <span class="n">FC_StopBreak</span><span class="p">,</span>
			<span class="n">Magic_code</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">moxa_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">moxa_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">moxa_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">moxa_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">moxa_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">moxa_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">moxa_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">moxa_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">moxa_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">moxa_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">moxa_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">moxa_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">moxa_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">moxa_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">moxa_tiocmset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">moxa_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">moxa_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">moxa_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">moxa_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">moxaDriver</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">moxaTimer</span><span class="p">,</span> <span class="n">moxa_poll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * HW init</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_check_fw_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">model</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_check_fw</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">lptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">lptr</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x7980</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_load_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseAddr</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">HW_reset</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>	<span class="cm">/* reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">baseAddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">baseAddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>	<span class="cm">/* download BIOS */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>	<span class="cm">/* restart */</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">C218_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">C218_KeyCode</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">C218_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">CP204J_KeyCode</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">C320_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">C320_KeyCode</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">C320_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">STS_init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: bios upload failed -- CPU/Basic &quot;</span>
					<span class="s">&quot;module not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: bios upload failed -- board not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_load_320b</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseAddr</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">7168</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: invalid 320 bios -- too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">7168</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">C320bapi_len</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>	<span class="cm">/* Select Page 1 */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">7168</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>	<span class="cm">/* Select Page 2 */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">7168</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">7168</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_real_load_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseAddr</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">uptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="n">loadbuf</span><span class="p">,</span> <span class="n">loadlen</span><span class="p">,</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">checksum_ok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">usum</span><span class="p">,</span> <span class="n">keycode</span><span class="p">;</span>

	<span class="n">keycode</span> <span class="o">=</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">==</span> <span class="n">MOXA_BOARD_CP204J</span><span class="p">)</span> <span class="o">?</span> <span class="n">CP204J_KeyCode</span> <span class="o">:</span>
				<span class="n">C218_KeyCode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
		<span class="n">key</span> <span class="o">=</span> <span class="n">C218_key</span><span class="p">;</span>
		<span class="n">loadbuf</span> <span class="o">=</span> <span class="n">C218_LoadBuf</span><span class="p">;</span>
		<span class="n">loadlen</span> <span class="o">=</span> <span class="n">C218DLoad_len</span><span class="p">;</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="n">C218check_sum</span><span class="p">;</span>
		<span class="n">checksum_ok</span> <span class="o">=</span> <span class="n">C218chksum_ok</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">C320_key</span><span class="p">;</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">C320_KeyCode</span><span class="p">;</span>
		<span class="n">loadbuf</span> <span class="o">=</span> <span class="n">C320_LoadBuf</span><span class="p">;</span>
		<span class="n">loadlen</span> <span class="o">=</span> <span class="n">C320DLoad_len</span><span class="p">;</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="n">C320check_sum</span><span class="p">;</span>
		<span class="n">checksum_ok</span> <span class="o">=</span> <span class="n">C320chksum_ok</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">usum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">uptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">wlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len2</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2048</span> <span class="o">:</span> <span class="n">wlen</span><span class="p">;</span>
			<span class="n">wlen</span> <span class="o">-=</span> <span class="n">len2</span><span class="p">;</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">loadbuf</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">len2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="n">len2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">writew</span><span class="p">(</span><span class="n">len2</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">loadlen</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">keycode</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">keycode</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">loadlen</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">usum</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">checksum</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">keycode</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">checksum_ok</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">checksum_ok</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">==</span> <span class="n">Magic_code</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Magic_code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">brd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">busType</span> <span class="o">==</span> <span class="n">MOXA_BUS_TYPE_PCI</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* ASIC board */</span>
			<span class="n">writew</span><span class="p">(</span><span class="mh">0x3800</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_PORT1</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="mh">0x3900</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_PORT2</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">28499</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_CLOCK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="mh">0x3200</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_PORT1</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="mh">0x3400</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_PORT2</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="mi">19999</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">TMS320_CLOCK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Disable_IRQ</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">==</span> <span class="n">Magic_code</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Magic_code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">brd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Module_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Module_no</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">==</span> <span class="n">Magic_code</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Magic_no</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Magic_code</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">intNdx</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">IRQindex</span><span class="p">;</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">intPend</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">IRQpending</span><span class="p">;</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">intTable</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">IRQtable</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_load_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="o">*</span><span class="n">baseAddr</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: bios length is not even</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">moxa_real_load_code</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span> <span class="cm">/* may change numPorts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
		<span class="n">port</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">brd</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">DCDState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Extern_table</span> <span class="o">+</span>
					<span class="n">Extern_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">C218rx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">C218tx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">C218rx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C218buf_pageno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C218rx_pageno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>

			<span class="n">writew</span><span class="p">(</span><span class="n">C218tx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C218buf_pageno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C218tx_pageno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">brd</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">DCDState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Extern_table</span> <span class="o">+</span>
					<span class="n">Extern_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p8rx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p8tx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p8rx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p8buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C320p8rx_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p8tx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p8buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C320p8tx_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p16rx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p16tx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p16rx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p16buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C320p16rx_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p16tx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p16buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C320p16tx_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">24</span>:
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p24rx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p24tx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p24rx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p24buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">)</span> <span class="o">+</span> <span class="n">C320p24rx_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p24tx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p24buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">),</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p32rx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p32tx_mask</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p32tx_ofs</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Ofs_txb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p32rx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p32buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">),</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">C320p32tx_spage</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">C320p32buf_pgno</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">),</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rsn</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">lens</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">lencnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">magic</span><span class="p">;</span>	<span class="cm">/* 0x34303430 */</span>
		<span class="n">u8</span> <span class="n">reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* UNIX = 3 */</span>
		<span class="n">u8</span> <span class="n">model</span><span class="p">;</span>	<span class="cm">/* C218T=1, C320T=2, CP204=3 */</span>
		<span class="n">u8</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">__le16</span> <span class="n">len</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">const</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lens</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MOXA_FW_HDRLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;too short (even header won&#39;t fit)&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x30343034</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;bad magic: %.8x&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;not for linux, type is %u&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">moxa_check_fw_model</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;not for this card, model is %u&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">MOXA_FW_HDRLEN</span><span class="p">;</span>
	<span class="n">lencnt</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lens</span><span class="p">);</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lens</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">[</span><span class="n">a</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">+</span> <span class="n">lens</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;&amp;</span>
				<span class="n">moxa_check_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="p">]))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MOXA firmware: unexpected input &quot;</span>
				<span class="s">&quot;at offset %u, but going on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lens</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">lencnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;too few entries in fw file&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">lens</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;bad length: %u (should be %u)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">MOXA_FW_HDRLEN</span><span class="p">;</span>
	<span class="n">lenp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* bios */</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">rsn</span><span class="p">,</span> <span class="s">&quot;read above&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_load_bios</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* we skip the tty section (lens[1]), since we don&#39;t need it */</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span><span class="p">]</span> <span class="o">+</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">lenp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* comm */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_load_320b</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* skip another tty */</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span><span class="p">]</span> <span class="o">+</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">lenp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_load_code</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">lens</span><span class="p">[</span><span class="n">lenp</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware failed to load, reason: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rsn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_init_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MAX_PORTS_PER_BOARD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate memory for ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">moxa_port_ops</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">CLOCAL</span> <span class="o">|</span> <span class="n">HUPCL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;c218tunx.cod&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;cp204unx.cod&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;c320tunx.cod&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: request_firmware failed. Make sure &quot;</span>
				<span class="s">&quot;you&#39;ve placed &#39;%s&#39; file into your firmware &quot;</span>
				<span class="s">&quot;loader directory (e.g. /lib/firmware)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">file</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">moxa_load_fw</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxaTimer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxaTimer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_board_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">opened</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>

	<span class="cm">/* pci hot-un-plug support */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
				<span class="n">opened</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opened</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">moxa_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board_type</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable pci device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">basemem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_BOARDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;more than %u MOXA Intellio family boards &quot;</span>
				<span class="s">&quot;found. Board is ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAX_BOARDS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">board</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;moxa-base&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t request pci region 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t remap io space 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">board</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">=</span> <span class="n">board_type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_ISA</span>:
	<span class="k">case</span> <span class="n">MOXA_BOARD_C218_PCI</span>:
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MOXA_BOARD_CP204J</span>:
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">busType</span> <span class="o">=</span> <span class="n">MOXA_BUS_TYPE_PCI</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">moxa_init_board</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_base</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">board</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;board &#39;%s&#39; ready (%u ports, firmware loaded)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">moxa_brdname</span><span class="p">[</span><span class="n">board_type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_base:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_reg:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">moxa_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">moxa_board_deinit</span><span class="p">(</span><span class="n">brd</span><span class="p">);</span>

	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">moxa_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;moxa&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">moxa_pcibrds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">moxa_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">moxa_pci_remove</span><span class="p">)</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">moxa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isabrds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span> <span class="o">=</span> <span class="n">moxa_boards</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MOXA Intellio family driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MOXA_VERSION</span><span class="p">);</span>
	<span class="n">moxaDriver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MAX_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">moxaDriver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyMX&quot;</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ttymajor</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">CLOCAL</span> <span class="o">|</span> <span class="n">HUPCL</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">moxaDriver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">moxaDriver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">moxa_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">moxaDriver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;can&#39;t register MOXA Smartio tty driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">moxaDriver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the boards defined from module args. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baseaddr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MOXA_BOARD_C218_ISA</span> <span class="o">||</span>
				<span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MOXA_BOARD_C320_ISA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Moxa board %2d: %s board(baseAddr=%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">isabrds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">moxa_brdname</span><span class="p">[</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
					<span class="n">baseaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">=</span> <span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MOXA_BOARD_C218_ISA</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span>
					<span class="n">numports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">busType</span> <span class="o">=</span> <span class="n">MOXA_BUS_TYPE_ISA</span><span class="p">;</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">baseaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MOXA: can&#39;t remap %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">baseaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">moxa_init_board</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">);</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">basemem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MOXA isa board found at 0x%.8lu and &quot;</span>
					<span class="s">&quot;ready (%u ports, firmware loaded)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">baseaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">);</span>

			<span class="n">brd</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isabrds</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t register MOXA pci driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isabrds</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">moxa_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* ISA boards */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ready</span><span class="p">)</span>
			<span class="n">moxa_board_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxaTimer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">moxaDriver</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t unregister MOXA Intellio family &quot;</span>
				<span class="s">&quot;serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">moxaDriver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">moxa_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">moxa_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">moxa_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
        <span class="n">MoxaPortDisable</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">MoxaPortFlushData</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">moxa_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dcd</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">DCDState</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dcd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">moxa_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">MoxaPortLineCtrl</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">onoff</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="n">MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">brd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">port</span> <span class="o">/</span> <span class="n">MAX_PORTS_PER_BOARD</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">%</span> <span class="n">MAX_PORTS_PER_BOARD</span> <span class="o">&gt;=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span> <span class="o">%</span> <span class="n">MAX_PORTS_PER_BOARD</span><span class="p">];</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">moxa_set_tty_param</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
		<span class="n">MoxaPortLineCtrl</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">MoxaPortEnable</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">MoxaSetFifo</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">tty_port_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">MoxaPortWriteData</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">LOWWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">MoxaPortTxFree</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">MoxaPortFlushData</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chars</span><span class="p">;</span>

	<span class="n">chars</span> <span class="o">=</span> <span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chars</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make it possible to wakeup anything waiting for output</span>
<span class="cm">		 * in tty_ioctl.c, etc.</span>
<span class="cm">		 */</span>
        	<span class="n">set_bit</span><span class="p">(</span><span class="n">EMPTYWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chars</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">rts</span><span class="p">;</span>

	<span class="n">MoxaPortGetLineOut</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtr</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">|=</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="n">dtr</span> <span class="o">=</span> <span class="n">MoxaPortLineStatus</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">|=</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtr</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">|=</span> <span class="n">TIOCM_CD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">rts</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">MoxaPortGetLineOut</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">dtr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">dtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MoxaPortLineCtrl</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">rts</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_openlock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">moxa_set_tty_param</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">C_CLOCAL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">MoxaPortTxDisable</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TXSTOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TXSTOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">MoxaPortTxEnable</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TXSTOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_new_dcdstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dcd</span> <span class="o">=</span> <span class="o">!!</span><span class="n">dcd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">DCDState</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">p</span><span class="o">-&gt;</span><span class="n">DCDState</span> <span class="o">=</span> <span class="n">dcd</span><span class="p">;</span>
        	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">C_CLOCAL</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dcd</span><span class="p">)</span>
			<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_poll_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inited</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EMPTYWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">EMPTYWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOWWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span>
				<span class="n">MoxaPortTxQueue</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOWWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inited</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">MoxaPortRxQueue</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* RX */</span>
			<span class="n">MoxaPortReadData</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">EMPTYWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">statusflags</span><span class="p">);</span>
		<span class="n">MoxaPortFlushData</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* flush RX */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="cm">/* nothing else to do */</span>
		<span class="k">goto</span> <span class="n">put</span><span class="p">;</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span> <span class="cm">/* port irq status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span> <span class="cm">/* ACK port */</span>
	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">IntrTx</span><span class="p">)</span> <span class="cm">/* disable tx intr */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">HostStat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WakeupTx</span><span class="p">,</span>
				<span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">HostStat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inited</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">IntrBreak</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* BREAK */</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
		<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">IntrLine</span><span class="p">)</span>
		<span class="n">moxa_new_dcdstate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FlagStat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DCD_state</span><span class="p">);</span>
<span class="nl">put:</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_board_conf</span> <span class="o">*</span><span class="n">brd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">served</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">card</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span><span class="p">;</span> <span class="n">card</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">moxa_boards</span><span class="p">[</span><span class="n">card</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">served</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">intPend</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">intTable</span> <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">intNdx</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
			<span class="n">moxa_poll_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">],</span> <span class="o">!!</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">intPend</span><span class="p">);</span> <span class="cm">/* ACK */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">moxaLowWaterChk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lowChkFlag</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">lowChkFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">moxa_low_water_check</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">);</span>
				<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">moxaLowWaterChk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">served</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxaTimer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxa_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moxa_set_tty_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rts</span><span class="p">,</span> <span class="n">cts</span><span class="p">,</span> <span class="n">txflow</span><span class="p">,</span> <span class="n">rxflow</span><span class="p">,</span> <span class="n">xany</span><span class="p">,</span> <span class="n">baud</span><span class="p">;</span>

	<span class="n">rts</span> <span class="o">=</span> <span class="n">cts</span> <span class="o">=</span> <span class="n">txflow</span> <span class="o">=</span> <span class="n">rxflow</span> <span class="o">=</span> <span class="n">xany</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="n">cts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">)</span>
		<span class="n">txflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXOFF</span><span class="p">)</span>
		<span class="n">rxflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXANY</span><span class="p">)</span>
		<span class="n">xany</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Clear the features we don&#39;t support */</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>
	<span class="n">MoxaPortFlowCtrl</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">rts</span><span class="p">,</span> <span class="n">cts</span><span class="p">,</span> <span class="n">txflow</span><span class="p">,</span> <span class="n">rxflow</span><span class="p">,</span> <span class="n">xany</span><span class="p">);</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">MoxaPortSetTermio</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">old_termios</span><span class="p">);</span>
	<span class="cm">/* Not put the baud rate into the termios data */</span>
	<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Driver level functions: 					     *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortFlushData</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_FlushQueue</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">lowChkFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">moxa_low_water_check</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *    Moxa Port Number Description:</span>
<span class="cm"> *</span>
<span class="cm"> *      MOXA serial driver supports up to 4 MOXA-C218/C320 boards. And,</span>
<span class="cm"> *      the port number using in MOXA driver functions will be 0 to 31 for</span>
<span class="cm"> *      first MOXA board, 32 to 63 for second, 64 to 95 for third and 96</span>
<span class="cm"> *      to 127 for fourth. For example, if you setup three MOXA boards,</span>
<span class="cm"> *      first board is C218, second board is C320-16 and third board is</span>
<span class="cm"> *      C320-32. The port number of first board (C218 - 8 ports) is from</span>
<span class="cm"> *      0 to 7. The port number of second board (C320 - 16 ports) is form</span>
<span class="cm"> *      32 to 47. The port number of third board (C320 - 32 ports) is from</span>
<span class="cm"> *      64 to 95. And those port numbers form 8 to 31, 48 to 63 and 96 to</span>
<span class="cm"> *      127 will be invalid.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Moxa Functions Description:</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 1:     Driver initialization routine, this routine must be</span>
<span class="cm"> *                      called when initialized driver.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaDriverInit();</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 2:     Moxa driver private IOCTL command processing.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaDriverIoctl(unsigned int cmd, unsigned long arg, int port);</span>
<span class="cm"> *</span>
<span class="cm"> *           unsigned int cmd   : IOCTL command</span>
<span class="cm"> *           unsigned long arg  : IOCTL argument</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    0  (OK)</span>
<span class="cm"> *                      -EINVAL</span>
<span class="cm"> *                      -ENOIOCTLCMD</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 6:     Enable this port to start Tx/Rx data.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortEnable(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 7:     Disable this port</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortDisable(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 10:    Setting baud rate of this port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      speed_t MoxaPortSetBaud(int port, speed_t baud);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           long baud          : baud rate (50 - 115200)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    0       : this port is invalid or baud &lt; 50</span>
<span class="cm"> *                      50 - 115200 : the real baud rate set to the port, if</span>
<span class="cm"> *                                    the argument baud is large than maximun</span>
<span class="cm"> *                                    available baud rate, the real setting</span>
<span class="cm"> *                                    baud rate will be the maximun baud rate.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 12:    Configure the port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortSetTermio(int port, struct ktermios *termio, speed_t baud);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           struct ktermios * termio : termio structure pointer</span>
<span class="cm"> *	     speed_t baud	: baud rate</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    -1      : this port is invalid or termio == NULL</span>
<span class="cm"> *                      0       : setting O.K.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 13:    Get the DTR/RTS state of this port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortGetLineOut(int port, int *dtrState, int *rtsState);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           int * dtrState     : pointer to INT to receive the current DTR</span>
<span class="cm"> *                                state. (if NULL, this function will not</span>
<span class="cm"> *                                write to this address)</span>
<span class="cm"> *           int * rtsState     : pointer to INT to receive the current RTS</span>
<span class="cm"> *                                state. (if NULL, this function will not</span>
<span class="cm"> *                                write to this address)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    -1      : this port is invalid</span>
<span class="cm"> *                      0       : O.K.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 14:    Setting the DTR/RTS output state of this port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortLineCtrl(int port, int dtrState, int rtsState);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           int dtrState       : DTR output state (0: off, 1: on)</span>
<span class="cm"> *           int rtsState       : RTS output state (0: off, 1: on)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 15:    Setting the flow control of this port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortFlowCtrl(int port, int rtsFlow, int ctsFlow, int rxFlow,</span>
<span class="cm"> *                            int txFlow,int xany);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           int rtsFlow        : H/W RTS flow control (0: no, 1: yes)</span>
<span class="cm"> *           int ctsFlow        : H/W CTS flow control (0: no, 1: yes)</span>
<span class="cm"> *           int rxFlow         : S/W Rx XON/XOFF flow control (0: no, 1: yes)</span>
<span class="cm"> *           int txFlow         : S/W Tx XON/XOFF flow control (0: no, 1: yes)</span>
<span class="cm"> *           int xany           : S/W XANY flow control (0: no, 1: yes)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 16:    Get ths line status of this port</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortLineStatus(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    Bit 0 - CTS state (0: off, 1: on)</span>
<span class="cm"> *                      Bit 1 - DSR state (0: off, 1: on)</span>
<span class="cm"> *                      Bit 2 - DCD state (0: off, 1: on)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 19:    Flush the Rx/Tx buffer data of this port.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortFlushData(int port, int mode);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           int mode    </span>
<span class="cm"> *                      0       : flush the Rx buffer </span>
<span class="cm"> *                      1       : flush the Tx buffer </span>
<span class="cm"> *                      2       : flush the Rx and Tx buffer </span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 20:    Write data.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortWriteData(int port, unsigned char * buffer, int length);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *           unsigned char * buffer     : pointer to write data buffer.</span>
<span class="cm"> *           int length         : write data length</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    0 - length      : real write data length</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 21:    Read data.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortReadData(int port, struct tty_struct *tty);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *	     struct tty_struct *tty : tty for data</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    0 - length      : real read data length</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 24:    Get the Tx buffer current queued data bytes</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortTxQueue(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    ..      : Tx buffer current queued data bytes</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 25:    Get the Tx buffer current free space</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortTxFree(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    ..      : Tx buffer current free space</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 26:    Get the Rx buffer current queued data bytes</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortRxQueue(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    ..      : Rx buffer current queued data bytes</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 28:    Disable port data transmission.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortTxDisable(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 29:    Enable port data transmission.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      void MoxaPortTxEnable(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      Function 31:    Get the received BREAK signal count and reset it.</span>
<span class="cm"> *      Syntax:</span>
<span class="cm"> *      int  MoxaPortResetBrkCnt(int port);</span>
<span class="cm"> *           int port           : port number (0 - 127)</span>
<span class="cm"> *</span>
<span class="cm"> *           return:    0 - ..  : BREAK signal count</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lowwater</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">lowwater</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Low_water</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">))</span>
		<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetBreakIrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">HostStat</span><span class="p">)</span> <span class="o">|</span> <span class="n">WakeupBreak</span><span class="p">,</span>
				<span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">HostStat</span><span class="p">);</span>

	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetLineIrq</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_FlushQueue</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_EnableCH</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
	<span class="n">MoxaPortLineStatus</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>

	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetFlowCtl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable flow control */</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_ClrLineIrq</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">HostStat</span><span class="p">);</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_DisableCH</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">speed_t</span> <span class="nf">MoxaPortSetBaud</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">speed_t</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="o">?</span> <span class="mi">460800</span> <span class="o">:</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetBaud</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">baud</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortSetTermio</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termio</span><span class="p">,</span>
		<span class="n">speed_t</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">;</span>
	<span class="n">tcflag_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CS5</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MX_CS5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CS6</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MX_CS6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CS7</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MX_CS7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CS8</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MX_CS8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MX_CS5</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_STOP15</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_STOP2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_STOP1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_PARODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_PAREVEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">MX_PARNONE</span><span class="p">;</span>

	<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetDataMode</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">baud</span> <span class="o">&gt;=</span> <span class="mi">921600</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">MoxaPortSetBaud</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXON</span> <span class="o">|</span> <span class="n">IXOFF</span> <span class="o">|</span> <span class="n">IXANY</span><span class="p">))</span> <span class="p">{</span>
	        <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">],</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncArg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">termio</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">],</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncArg1</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">FC_SetXonXoff</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FuncCode</span><span class="p">);</span>
		<span class="n">moxa_wait_finish</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moxafunc_lock</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">baud</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortGetLineOut</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dtrState</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">rtsState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtrState</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dtrState</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lineCtrl</span> <span class="o">&amp;</span> <span class="n">DTR_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtsState</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rtsState</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lineCtrl</span> <span class="o">&amp;</span> <span class="n">RTS_ON</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortLineCtrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dtr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtr</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">DTR_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">RTS_ON</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">lineCtrl</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">,</span> <span class="n">FC_LineControl</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortFlowCtrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cts</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">txflow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxflow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txany</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">RTS_FlowCtl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cts</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">CTS_FlowCtl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txflow</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">Tx_FlowCtl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxflow</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">Rx_FlowCtl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txany</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">IXM_IXANY</span><span class="p">;</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">,</span> <span class="n">FC_SetFlowCtl</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortLineStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MOXA_IS_320</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">moxafuncret</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_LineStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FlagStat</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0x0B</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">moxa_new_dcdstate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortWriteData</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseAddr</span><span class="p">,</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="o">*</span><span class="n">ofs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">tx_mask</span><span class="p">,</span> <span class="n">spage</span><span class="p">,</span> <span class="n">epage</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pageno</span><span class="p">,</span> <span class="n">pageofs</span><span class="p">,</span> <span class="n">bufhead</span><span class="p">;</span>

	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">baseAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>
	<span class="n">tx_mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
	<span class="n">spage</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_txb</span><span class="p">);</span>
	<span class="n">epage</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_txb</span><span class="p">);</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXwptr</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXrptr</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span> <span class="o">+</span> <span class="n">tx_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">moxaLog</span><span class="p">.</span><span class="n">txcnt</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spage</span> <span class="o">==</span> <span class="n">epage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bufhead</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Ofs_txb</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">spage</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">head</span> <span class="o">-</span> <span class="n">tail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">tx_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span> <span class="o">+</span> <span class="n">bufhead</span> <span class="o">+</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ofs</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tx_mask</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pageno</span> <span class="o">=</span> <span class="n">spage</span> <span class="o">+</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">pageofs</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">&amp;</span> <span class="n">Page_mask</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">Page_size</span> <span class="o">-</span> <span class="n">pageofs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">pageno</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span> <span class="o">+</span> <span class="n">pageofs</span><span class="p">;</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ofs</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pageno</span> <span class="o">==</span> <span class="n">epage</span><span class="p">)</span>
				<span class="n">pageno</span> <span class="o">=</span> <span class="n">spage</span><span class="p">;</span>
			<span class="n">pageofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tx_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXwptr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">CD180TXirq</span><span class="p">);</span>	<span class="cm">/* start to send */</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortReadData</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseAddr</span><span class="p">,</span> <span class="o">*</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="o">*</span><span class="n">ofs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tail</span><span class="p">,</span> <span class="n">rx_mask</span><span class="p">,</span> <span class="n">spage</span><span class="p">,</span> <span class="n">epage</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pageno</span><span class="p">,</span> <span class="n">pageofs</span><span class="p">,</span> <span class="n">bufhead</span><span class="p">,</span> <span class="n">head</span><span class="p">;</span>

	<span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">baseAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">basemem</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXrptr</span><span class="p">);</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXwptr</span><span class="p">);</span>
	<span class="n">rx_mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
	<span class="n">spage</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Page_rxb</span><span class="p">);</span>
	<span class="n">epage</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">EndPage_rxb</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;=</span> <span class="n">head</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">tail</span> <span class="o">-</span> <span class="n">head</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">tail</span> <span class="o">-</span> <span class="n">head</span> <span class="o">+</span> <span class="n">rx_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">moxaLog</span><span class="p">.</span><span class="n">rxcnt</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spage</span> <span class="o">==</span> <span class="n">epage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bufhead</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">Ofs_rxb</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">spage</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span> <span class="o">+</span> <span class="n">bufhead</span> <span class="o">+</span> <span class="n">head</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;=</span> <span class="n">head</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">tail</span> <span class="o">-</span> <span class="n">head</span><span class="p">)</span> <span class="o">:</span>
					<span class="p">(</span><span class="n">rx_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">head</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">tty_prepare_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="p">,</span>
					<span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rx_mask</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pageno</span> <span class="o">=</span> <span class="n">spage</span> <span class="o">+</span> <span class="p">(</span><span class="n">head</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">pageofs</span> <span class="o">=</span> <span class="n">head</span> <span class="o">&amp;</span> <span class="n">Page_mask</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">pageno</span><span class="p">,</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">Control_reg</span><span class="p">);</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="n">DynPage_addr</span> <span class="o">+</span> <span class="n">pageofs</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">tty_prepare_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="p">,</span>
					<span class="n">min</span><span class="p">(</span><span class="n">Page_size</span> <span class="o">-</span> <span class="n">pageofs</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">pageofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pageofs</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Page_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pageofs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">pageno</span> <span class="o">==</span> <span class="n">epage</span><span class="p">)</span>
				<span class="n">pageno</span> <span class="o">=</span> <span class="n">spage</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rx_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXrptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">FlagStat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Xoff_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moxaLowWaterChk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">lowChkFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortTxQueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rptr</span><span class="p">,</span> <span class="n">wptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">rptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXrptr</span><span class="p">);</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXwptr</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">wptr</span> <span class="o">-</span> <span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortTxFree</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rptr</span><span class="p">,</span> <span class="n">wptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">rptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXrptr</span><span class="p">);</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TXwptr</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">TX_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span> <span class="o">-</span> <span class="p">((</span><span class="n">wptr</span> <span class="o">-</span> <span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">MoxaPortRxQueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rptr</span><span class="p">,</span> <span class="n">wptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">rptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXrptr</span><span class="p">);</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RXwptr</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ofsAddr</span> <span class="o">+</span> <span class="n">RX_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">wptr</span> <span class="o">-</span> <span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortTxDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">,</span> <span class="n">FC_SetXoffState</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaPortTxEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">moxafunc</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">,</span> <span class="n">FC_SetXonState</span><span class="p">,</span> <span class="n">Magic_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
		<span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">moxa_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			<span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="mi">921600</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">);</span>
	<span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">);</span>

	<span class="n">MoxaSetFifo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Static local functions: 					     *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoxaSetFifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">moxa_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ofsAddr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tableAddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetRxFIFOTrig</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetTxFIFOCnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetRxFIFOTrig</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">moxafunc</span><span class="p">(</span><span class="n">ofsAddr</span><span class="p">,</span> <span class="n">FC_SetTxFIFOCnt</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
