<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › synclink_gt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>synclink_gt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Device driver for Microgate SyncLink GT serial adapters.</span>
<span class="cm"> *</span>
<span class="cm"> * written by Paul Fulghum for Microgate Corporation</span>
<span class="cm"> * paulkf@microgate.com</span>
<span class="cm"> *</span>
<span class="cm"> * Microgate and SyncLink are trademarks of Microgate Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This code is released under the GNU General Public License (GPL)</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,</span>
<span class="cm"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="cm"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED</span>
<span class="cm"> * OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DEBUG OUTPUT DEFINITIONS</span>
<span class="cm"> *</span>
<span class="cm"> * uncomment lines below to enable specific types of debug output</span>
<span class="cm"> *</span>
<span class="cm"> * DBGINFO   information - most verbose output</span>
<span class="cm"> * DBGERR    serious errors</span>
<span class="cm"> * DBGBH     bottom half service routine debugging</span>
<span class="cm"> * DBGISR    interrupt service routine debugging</span>
<span class="cm"> * DBGDATA   output receive and transmit data</span>
<span class="cm"> * DBGTBUF   output transmit DMA buffers and registers</span>
<span class="cm"> * DBGRBUF   output receive DMA buffers and registers</span>
<span class="cm"> */</span>

<span class="cp">#define DBGINFO(fmt) if (debug_level &gt;= DEBUG_LEVEL_INFO) printk fmt</span>
<span class="cp">#define DBGERR(fmt) if (debug_level &gt;= DEBUG_LEVEL_ERROR) printk fmt</span>
<span class="cp">#define DBGBH(fmt) if (debug_level &gt;= DEBUG_LEVEL_BH) printk fmt</span>
<span class="cp">#define DBGISR(fmt) if (debug_level &gt;= DEBUG_LEVEL_ISR) printk fmt</span>
<span class="cp">#define DBGDATA(info, buf, size, label) if (debug_level &gt;= DEBUG_LEVEL_DATA) trace_block((info), (buf), (size), (label))</span>
<span class="cm">/*#define DBGTBUF(info) dump_tbufs(info)*/</span>
<span class="cm">/*#define DBGRBUF(info) dump_rbufs(info)*/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/hdlc.h&gt;</span>
<span class="cp">#include &lt;linux/synclink.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#if defined(CONFIG_HDLC) || (defined(CONFIG_HDLC_MODULE) &amp;&amp; defined(CONFIG_SYNCLINK_GT_MODULE))</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 1</span>
<span class="cp">#else</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 0</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * module identification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span>     <span class="o">=</span> <span class="s">&quot;SyncLink GT&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tty_driver_name</span> <span class="o">=</span> <span class="s">&quot;synclink_gt&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tty_dev_prefix</span>  <span class="o">=</span> <span class="s">&quot;ttySLG&quot;</span><span class="p">;</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#define MGSL_MAGIC 0x5401</span>
<span class="cp">#define MAX_DEVICES 32</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MICROGATE</span><span class="p">,</span> <span class="n">SYNCLINK_GT_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MICROGATE</span><span class="p">,</span> <span class="n">SYNCLINK_GT2_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MICROGATE</span><span class="p">,</span> <span class="n">SYNCLINK_GT4_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_MICROGATE</span><span class="p">,</span> <span class="n">SYNCLINK_AC_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span> <span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;synclink_gt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">pci_registered</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * module configuration and status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">slgt_device_list</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">slgt_device_count</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ttymajor</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_level</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">MAX_DEVICES</span><span class="p">];</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">maxframe</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="s">&quot;TTY major device number override: 0=auto assigned&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="s">&quot;Debug syslog output: 0=disabled, 1 to 5=increasing detail&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxframe</span><span class="p">,</span> <span class="s">&quot;Maximum frame size used by device (4096 to 65535)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tty support and callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * generic HDLC support and callbacks</span>
<span class="cm"> */</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
<span class="cp">#define dev_to_port(D) (dev_to_hdlc(D)-&gt;priv)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">hdlcdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * device specific structures, macros and functions</span>
<span class="cm"> */</span>

<span class="cp">#define SLGT_MAX_PORTS 4</span>
<span class="cp">#define SLGT_REG_SIZE  256</span>

<span class="cm">/*</span>
<span class="cm"> * conditional wait facility</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cond_wait</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DMA buffer descriptor and access macros</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">slgt_desc</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pbuf</span><span class="p">;</span>  <span class="cm">/* physical address of data buffer */</span>
	<span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>  <span class="cm">/* physical address of next descriptor */</span>

	<span class="cm">/* driver book keeping */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>          <span class="cm">/* virtual  address of data buffer */</span>
    	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pdesc</span><span class="p">;</span> <span class="cm">/* physical address of this descriptor */</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_dma_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">buf_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define set_desc_buffer(a,b) (a).pbuf = cpu_to_le32((unsigned int)(b))</span>
<span class="cp">#define set_desc_next(a,b) (a).next   = cpu_to_le32((unsigned int)(b))</span>
<span class="cp">#define set_desc_count(a,b)(a).count  = cpu_to_le16((unsigned short)(b))</span>
<span class="cp">#define set_desc_eof(a,b)  (a).status = cpu_to_le16((b) ? (le16_to_cpu((a).status) | BIT0) : (le16_to_cpu((a).status) &amp; ~BIT0))</span>
<span class="cp">#define set_desc_status(a, b) (a).status = cpu_to_le16((unsigned short)(b))</span>
<span class="cp">#define desc_count(a)      (le16_to_cpu((a).count))</span>
<span class="cp">#define desc_status(a)     (le16_to_cpu((a).status))</span>
<span class="cp">#define desc_complete(a)   (le16_to_cpu((a).status) &amp; BIT15)</span>
<span class="cp">#define desc_eof(a)        (le16_to_cpu((a).status) &amp; BIT2)</span>
<span class="cp">#define desc_crc_error(a)  (le16_to_cpu((a).status) &amp; BIT1)</span>
<span class="cp">#define desc_abort(a)      (le16_to_cpu((a).status) &amp; BIT0)</span>
<span class="cp">#define desc_residue(a)    ((le16_to_cpu((a).status) &amp; 0x38) &gt;&gt; 3)</span>

<span class="k">struct</span> <span class="n">_input_signal_events</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ri_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri_down</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsr_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsr_down</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcd_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcd_down</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cts_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cts_down</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * device instance data structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">slgt_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">if_ptr</span><span class="p">;</span>		<span class="cm">/* General purpose pointer (used by SPPP) */</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">next_device</span><span class="p">;</span>	<span class="cm">/* device list link */</span>

	<span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">device_name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">port_count</span><span class="p">;</span>  <span class="cm">/* count of ports on adapter */</span>
	<span class="kt">int</span> <span class="n">adapter_num</span><span class="p">;</span> <span class="cm">/* adapter instance number */</span>
	<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>    <span class="cm">/* port instance number */</span>

	<span class="cm">/* array of pointers to port contexts on this adapter */</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">port_array</span><span class="p">[</span><span class="n">SLGT_MAX_PORTS</span><span class="p">];</span>

	<span class="kt">int</span>			<span class="n">line</span><span class="p">;</span>		<span class="cm">/* tty line instance number */</span>

	<span class="k">struct</span> <span class="n">mgsl_icount</span>	<span class="n">icount</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">x_char</span><span class="p">;</span>		<span class="cm">/* xon/xoff character */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">read_status_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 		<span class="n">ignore_status_mask</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span>	<span class="n">status_event_wait_q</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">event_wait_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tx_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">rx_timer</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">gpio_present</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cond_wait</span>        <span class="o">*</span><span class="n">gpio_wait_q</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>	<span class="cm">/* spinlock for synchronizing with ISR */</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">task</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pending_bh</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bh_requested</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bh_running</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">isr_overflow</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">irq_requested</span><span class="p">;</span>	<span class="cm">/* true if IRQ requested */</span>
	<span class="n">bool</span> <span class="n">irq_occurred</span><span class="p">;</span>	<span class="cm">/* for diagnostics use */</span>

	<span class="cm">/* device configuration */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">reg_addr</span><span class="p">;</span>  <span class="cm">/* memory mapped registers address */</span>
	<span class="n">u32</span> <span class="n">phys_reg_addr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reg_addr_requested</span><span class="p">;</span>

	<span class="n">MGSL_PARAMS</span> <span class="n">params</span><span class="p">;</span>       <span class="cm">/* communications parameters */</span>
	<span class="n">u32</span> <span class="n">idle_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_frame_size</span><span class="p">;</span>       <span class="cm">/* as set by device config */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_fill_level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_pio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xsync</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xctrl</span><span class="p">;</span>

	<span class="cm">/* device status */</span>

	<span class="n">bool</span> <span class="n">rx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_restart</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">tx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_active</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">signals</span><span class="p">;</span>    <span class="cm">/* serial signal states */</span>
	<span class="kt">int</span> <span class="n">init_error</span><span class="p">;</span>  <span class="cm">/* initialization error */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_count</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">flag_buf</span><span class="p">[</span><span class="n">MAX_ASYNC_BUFFER_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">char_buf</span><span class="p">[</span><span class="n">MAX_ASYNC_BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">drop_rts_on_tx_done</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">_input_signal_events</span>	<span class="n">input_signal_events</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dcd_chkcount</span><span class="p">;</span>	<span class="cm">/* check counts to prevent */</span>
	<span class="kt">int</span> <span class="n">cts_chkcount</span><span class="p">;</span>	<span class="cm">/* too many IRQs if a signal */</span>
	<span class="kt">int</span> <span class="n">dsr_chkcount</span><span class="p">;</span>	<span class="cm">/* is floating */</span>
	<span class="kt">int</span> <span class="n">ri_chkcount</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">bufs</span><span class="p">;</span>		<span class="cm">/* virtual address of DMA buffer lists */</span>
	<span class="n">dma_addr_t</span> <span class="n">bufs_dma_addr</span><span class="p">;</span> <span class="cm">/* physical address of buffer descriptors */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">rbufs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_current</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_fill_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rbuf_fill_count</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbuf_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">tbufs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbuf_current</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbuf_start</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp_rbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_rbuf_count</span><span class="p">;</span>

	<span class="cm">/* SPPP/Cisco HDLC device parts */</span>

	<span class="kt">int</span> <span class="n">netcount</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">netlock</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">};</span>

<span class="k">static</span> <span class="n">MGSL_PARAMS</span> <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">loopback</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>           <span class="o">=</span> <span class="n">HDLC_FLAG_UNDERRUN_ABORT15</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encoding</span>        <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_speed</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr_filter</span>     <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crc_type</span>        <span class="o">=</span> <span class="n">HDLC_CRC_16_CCITT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="n">HDLC_PREAMBLE_LENGTH_8BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">preamble</span>        <span class="o">=</span> <span class="n">HDLC_PREAMBLE_PATTERN_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data_rate</span>       <span class="o">=</span> <span class="mi">9600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data_bits</span>       <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_bits</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parity</span>          <span class="o">=</span> <span class="n">ASYNC_PARITY_NONE</span>
<span class="p">};</span>


<span class="cp">#define BH_RECEIVE  1</span>
<span class="cp">#define BH_TRANSMIT 2</span>
<span class="cp">#define BH_STATUS   4</span>
<span class="cp">#define IO_PIN_SHUTDOWN_LIMIT 100</span>

<span class="cp">#define DMABUFSIZE 256</span>
<span class="cp">#define DESC_LIST_SIZE 4096</span>

<span class="cp">#define MASK_PARITY  BIT1</span>
<span class="cp">#define MASK_FRAMING BIT0</span>
<span class="cp">#define MASK_BREAK   BIT14</span>
<span class="cp">#define MASK_OVERRUN BIT4</span>

<span class="cp">#define GSR   0x00 </span><span class="cm">/* global status */</span><span class="cp"></span>
<span class="cp">#define JCR   0x04 </span><span class="cm">/* JTAG control */</span><span class="cp"></span>
<span class="cp">#define IODR  0x08 </span><span class="cm">/* GPIO direction */</span><span class="cp"></span>
<span class="cp">#define IOER  0x0c </span><span class="cm">/* GPIO interrupt enable */</span><span class="cp"></span>
<span class="cp">#define IOVR  0x10 </span><span class="cm">/* GPIO value */</span><span class="cp"></span>
<span class="cp">#define IOSR  0x14 </span><span class="cm">/* GPIO interrupt status */</span><span class="cp"></span>
<span class="cp">#define TDR   0x80 </span><span class="cm">/* tx data */</span><span class="cp"></span>
<span class="cp">#define RDR   0x80 </span><span class="cm">/* rx data */</span><span class="cp"></span>
<span class="cp">#define TCR   0x82 </span><span class="cm">/* tx control */</span><span class="cp"></span>
<span class="cp">#define TIR   0x84 </span><span class="cm">/* tx idle */</span><span class="cp"></span>
<span class="cp">#define TPR   0x85 </span><span class="cm">/* tx preamble */</span><span class="cp"></span>
<span class="cp">#define RCR   0x86 </span><span class="cm">/* rx control */</span><span class="cp"></span>
<span class="cp">#define VCR   0x88 </span><span class="cm">/* V.24 control */</span><span class="cp"></span>
<span class="cp">#define CCR   0x89 </span><span class="cm">/* clock control */</span><span class="cp"></span>
<span class="cp">#define BDR   0x8a </span><span class="cm">/* baud divisor */</span><span class="cp"></span>
<span class="cp">#define SCR   0x8c </span><span class="cm">/* serial control */</span><span class="cp"></span>
<span class="cp">#define SSR   0x8e </span><span class="cm">/* serial status */</span><span class="cp"></span>
<span class="cp">#define RDCSR 0x90 </span><span class="cm">/* rx DMA control/status */</span><span class="cp"></span>
<span class="cp">#define TDCSR 0x94 </span><span class="cm">/* tx DMA control/status */</span><span class="cp"></span>
<span class="cp">#define RDDAR 0x98 </span><span class="cm">/* rx DMA descriptor address */</span><span class="cp"></span>
<span class="cp">#define TDDAR 0x9c </span><span class="cm">/* tx DMA descriptor address */</span><span class="cp"></span>
<span class="cp">#define XSR   0x40 </span><span class="cm">/* extended sync pattern */</span><span class="cp"></span>
<span class="cp">#define XCR   0x44 </span><span class="cm">/* extended control */</span><span class="cp"></span>

<span class="cp">#define RXIDLE      BIT14</span>
<span class="cp">#define RXBREAK     BIT14</span>
<span class="cp">#define IRQ_TXDATA  BIT13</span>
<span class="cp">#define IRQ_TXIDLE  BIT12</span>
<span class="cp">#define IRQ_TXUNDER BIT11 </span><span class="cm">/* HDLC */</span><span class="cp"></span>
<span class="cp">#define IRQ_RXDATA  BIT10</span>
<span class="cp">#define IRQ_RXIDLE  BIT9  </span><span class="cm">/* HDLC */</span><span class="cp"></span>
<span class="cp">#define IRQ_RXBREAK BIT9  </span><span class="cm">/* async */</span><span class="cp"></span>
<span class="cp">#define IRQ_RXOVER  BIT8</span>
<span class="cp">#define IRQ_DSR     BIT7</span>
<span class="cp">#define IRQ_CTS     BIT6</span>
<span class="cp">#define IRQ_DCD     BIT5</span>
<span class="cp">#define IRQ_RI      BIT4</span>
<span class="cp">#define IRQ_ALL     0x3ff0</span>
<span class="cp">#define IRQ_MASTER  BIT0</span>

<span class="cp">#define slgt_irq_on(info, mask) \</span>
<span class="cp">	wr_reg16((info), SCR, (unsigned short)(rd_reg16((info), SCR) | (mask)))</span>
<span class="cp">#define slgt_irq_off(info, mask) \</span>
<span class="cp">	wr_reg16((info), SCR, (unsigned short)(rd_reg16((info), SCR) &amp; ~(mask)))</span>

<span class="k">static</span> <span class="n">__u8</span>  <span class="n">rd_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">wr_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__u16</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">wr_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__u32</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">wr_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="n">msc_set_vcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">block_til_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">program_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">change_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">register_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">irq_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">loopback_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">adapter_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">async_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_rbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_rbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rdma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">rx_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">rx_get_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_set_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">free_tbuf_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbuf_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_tbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tdma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tx_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">get_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">enable_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_rate</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">bh_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_rdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_txeom</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_tdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_dma_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_tmp_rbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_tmp_rbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ioctl handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_txidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_txidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">modem_input_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="kt">int</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">wait_mgsl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">if_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">gpio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">gpio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">wait_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">gpio</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_xsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">if_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_xsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_xctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">if_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_xctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * driver functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">claim_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DEBUG OUTPUT CODE</span>
<span class="cm"> */</span>
<span class="cp">#ifndef DBGINFO</span>
<span class="cp">#define DBGINFO(fmt)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DBGERR</span>
<span class="cp">#define DBGERR(fmt)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DBGBH</span>
<span class="cp">#define DBGBH(fmt)</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DBGISR</span>
<span class="cp">#define DBGISR(fmt)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DBGDATA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %s data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">linecount</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">linecount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">linecount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mo">040</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="mo">0176</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">data</span>  <span class="o">+=</span> <span class="n">linecount</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define DBGDATA(info, buf, size, label)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DBGTBUF</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_tbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tbuf_current=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: count=%04X status=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define DBGTBUF(info)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DBGRBUF</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_rbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rbuf_current=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: count=%04X status=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define DBGRBUF(info)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SANITY_CHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;null struct slgt_info for (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devname</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">MGSL_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bad magic number struct slgt_info (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devname</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * line discipline callback wrappers</span>
<span class="cm"> *</span>
<span class="cm"> * The wrappers maintain line discipline references</span>
<span class="cm"> * while calling into the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * ldisc_receive_buf  - pass receive data to line discipline</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ldisc_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tty callbacks */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">slgt_device_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s: open with invalid line #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">line</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">slgt_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">!=</span> <span class="n">line</span><span class="p">)</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s init error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s open, old ref count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">));</span>

	<span class="cm">/* If port is closing, signal caller to try again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_wait</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1st open on this device, init hardware */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">block_til_ready</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s block_til_ready rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* tty layer will release tty struct */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s open rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s close entry, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
 		<span class="n">wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s close exit, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hangup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_termios</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">change_params</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span>
 		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
 		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_release</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_tx_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * use worst case speed of 1200bps to calculate transmit timeout</span>
<span class="cm">	 * based on data in buffers (tbuf_bytes) and FIFO (128 bytes)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">timeout</span>  <span class="o">=</span> <span class="p">(</span><span class="n">tbuf_bytes</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s write count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send accumulated data from send_char() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s write rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s put_char(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;send_xchar&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s send_xchar(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
		 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">,</span> <span class="n">char_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s wait_until_sent entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Set check interval to 1/5 of estimated time to</span>
<span class="cm">	 * send a character, and make it at least 1. The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 * Note: use tight timings here to satisfy the NIST-PCTS.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">)</span> <span class="p">{</span>
	       	<span class="n">char_time</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">char_time</span><span class="p">)</span>
			<span class="n">char_time</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">char_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s wait_until_sent exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">HDLC_MAX_FRAME_SIZE</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s write_room=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s flush_chars entry tx_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s flush_chars start transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s flush_buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * throttle (stop) transmitter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_hold&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tx_hold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span>
	 	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release (start) transmitter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_release&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tx_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Service an IOCTL request</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments</span>
<span class="cm"> *</span>
<span class="cm"> * 	tty	pointer to tty instance data</span>
<span class="cm"> * 	cmd	IOCTL command code</span>
<span class="cm"> * 	arg	command argument/context</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s ioctl() cmd=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_IOCWAITEVENT</span>:
		<span class="k">return</span> <span class="n">wait_mgsl_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="k">return</span> <span class="n">modem_input_wait</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSGPIO</span>:
		<span class="k">return</span> <span class="n">set_gpio</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGGPIO</span>:
		<span class="k">return</span> <span class="n">get_gpio</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCWAITGPIO</span>:
		<span class="k">return</span> <span class="n">wait_gpio</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGXSYNC</span>:
		<span class="k">return</span> <span class="n">get_xsync</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSXSYNC</span>:
		<span class="k">return</span> <span class="n">set_xsync</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGXCTRL</span>:
		<span class="k">return</span> <span class="n">get_xctrl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSXCTRL</span>:
		<span class="k">return</span> <span class="n">set_xctrl</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGPARAMS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSPARAMS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGTXIDLE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSTXIDLE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXENABLE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tx_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCRXENABLE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rx_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXABORT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tx_abort</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGSTATS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_stats</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGIF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_interface</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSIF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_interface</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* kernel counter temps */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * support for 32 bit ioctl calls on 64 bit systems</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">get_params32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MGSL_PARAMS32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MGSL_PARAMS32</span> <span class="n">tmp_params</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_params32</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_params</span><span class="p">));</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="p">(</span><span class="n">compat_ulong_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">loopback</span>        <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">flags</span>           <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">encoding</span>        <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">clock_speed</span>     <span class="o">=</span> <span class="p">(</span><span class="n">compat_ulong_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">addr_filter</span>     <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">crc_type</span>        <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble_length</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">preamble</span>        <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">data_rate</span>       <span class="o">=</span> <span class="p">(</span><span class="n">compat_ulong_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">data_bits</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">stop_bits</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span><span class="p">;</span>
	<span class="n">tmp_params</span><span class="p">.</span><span class="n">parity</span>          <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MGSL_PARAMS32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">set_params32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MGSL_PARAMS32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MGSL_PARAMS32</span> <span class="n">tmp_params</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_params32</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="n">new_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MGSL_PARAMS32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_BASE_CLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span> <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span>            <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span>        <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">loopback</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span>           <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span>        <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">encoding</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span>     <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span>     <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">addr_filter</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span>        <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">crc_type</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">preamble_length</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span>        <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">preamble</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span>       <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span>       <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">data_bits</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span>       <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">stop_bits</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span>          <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">slgt_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;compat_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s compat_ioctl() cmd=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MGSL_IOCSPARAMS32</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">set_params32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MGSL_IOCGPARAMS32</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">get_params32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MGSL_IOCGPARAMS</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSPARAMS</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGTXIDLE</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGSTATS</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCWAITEVENT</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGIF</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSGPIO</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGGPIO</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCWAITGPIO</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGXSYNC</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCGXCTRL</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSTXIDLE</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCTXENABLE</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCRXENABLE</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCTXABORT</span>:
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSIF</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSXSYNC</span>:
	<span class="k">case</span> <span class="n">MGSL_IOCSXCTRL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s compat_ioctl() cmd=%08X rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define slgt_compat_ioctl NULL</span>
<span class="cp">#endif </span><span class="cm">/* ifdef CONFIG_COMPAT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * proc fs support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat_buf</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s: IO=%08X IRQ=%d MaxFrameSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">,</span>
		      <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>

	<span class="cm">/* output current serial signal states */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DTR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DSR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CD&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RI&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">HDLC txok:%d rxok:%d&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txunder:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txabort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxshort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxlong:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxover:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxcrc:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ASYNC tx:%d rx:%d&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append serial signal status to end */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_buf</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">txactive=%d bh_req=%d bh_run=%d pending_bh=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called to print information about devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synclink_gt_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;synclink_gt driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">slgt_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">info</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">line_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synclink_gt_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">synclink_gt_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">synclink_gt_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">synclink_gt_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * return count of bytes in transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">tbuf_bytes</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s chars_in_buffer()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * signal remote device to throttle send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s throttle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * signal remote device to stop throttling send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s unthrottle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set or clear transmit break condition</span>
<span class="cm"> * break_state	-1=set break condition, 0=clear</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;set_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_break(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">break_state</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT6</span><span class="p">;</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer when protocol selected (PPP, frame relay, etc.)</span>
<span class="cm"> * set encoding and frame check sequence (FCS) options</span>
<span class="cm"> *</span>
<span class="cm"> * dev       pointer to network device structure</span>
<span class="cm"> * encoding  serial encoding setting</span>
<span class="cm"> * parity    FCS setting</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">new_encoding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZ</span>:        <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZ</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZI</span>:       <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_MARK</span>:    <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_SPACE</span>:   <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_MANCHESTER</span>: <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">parity</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">PARITY_NONE</span>:            <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_NONE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC16_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_16_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC32_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_32_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">new_encoding</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">=</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* if network interface up, reprogram hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer to send frame</span>
<span class="cm"> *</span>
<span class="cm"> * skb  socket buffer containing HDLC frame</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">hdlcdev_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlc_xmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="cm">/* stop sending until this frame completes */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* update network statistics */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* save start time for transmit timeout detection */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* done with socket buffer, so free it */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface enabled</span>
<span class="cm"> * claim resources and initialize hardware</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* generic HDLC layer open processing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* arbitrate between network and tty opens */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlc_open busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* claim resources and init adapter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assert DTR and RTS, apply hardware settings */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* enable network layer transmit */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* inform generic HDLC layer of current DCD status */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface is disabled</span>
<span class="cm"> * shutdown hardware and release resources</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* shutdown adapter and release resources */</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer to process IOCTL call to network device</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> * ifr  pointer to network interface request structure</span>
<span class="cm"> * cmd  IOCTL command code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>
	<span class="n">sync_serial_settings</span> <span class="n">new_line</span><span class="p">;</span>
	<span class="n">sync_serial_settings</span> <span class="n">__user</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCWANDEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_line</span><span class="p">));</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_GET_IFACE</span>: <span class="cm">/* return current sync_serial_settings */</span>

		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_SYNC_SERIAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* data size wanted */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">){</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_EXT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_INT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXINT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXFROMRX</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_DEFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
		<span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>: <span class="cm">/* set sync_serial_settings */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">CLOCK_EXT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXFROMRX</span>: <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_INT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXINT</span>:    <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_DEFAULT</span>:  <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
					     <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if network interface up, reprogram hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
			<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when transmit timeout is detected</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_tx_timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when transmit completes</span>
<span class="cm"> * reenable network layer transmit if stopped</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when frame received</span>
<span class="cm"> * pass frame to network layer</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> * buf   pointer to buffer contianing frame data</span>
<span class="cm"> * size  count of data bytes in buf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s hdlcdev_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s: can&#39;t alloc skb, drop packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hdlcdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">hdlcdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">hdlcdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">hdlc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">hdlc_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">hdlcdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">hdlcdev_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when adding device instance</span>
<span class="cm"> * do generic HDLC initialization</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">;</span>

	<span class="cm">/* allocate and initialize network and HDLC layer objects */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s hdlc device alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for network layer reporting purposes only */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span> <span class="o">+</span> <span class="n">SLGT_REG_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>

	<span class="cm">/* network layer callbacks and settings */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	    <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdlcdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>   <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="cm">/* generic HDLC layer callbacks and settings */</span>
	<span class="n">hdlc</span>         <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">hdlcdev_attach</span><span class="p">;</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span>   <span class="o">=</span> <span class="n">hdlcdev_xmit</span><span class="p">;</span>

	<span class="cm">/* register objects with HDLC layer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:unable to register hdlc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when removing device instance</span>
<span class="cm"> * do generic HDLC cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ifdef CONFIG_HDLC */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * get async data from rx DMA buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="o">*</span><span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">bufs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">desc_complete</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">end</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">desc_count</span><span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">end</span><span class="p">])</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_index</span><span class="p">;</span>
		<span class="n">p</span>     <span class="o">=</span> <span class="n">bufs</span><span class="p">[</span><span class="n">end</span><span class="p">].</span><span class="n">buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_index</span><span class="p">;</span>

		<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s rx_async count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
		<span class="n">DBGDATA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

			<span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span>
					<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span>
					<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* discard char if tty control flags say so */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
				<span class="n">chars</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* receive buffer not completed */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_index</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">free_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">end</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if entire list searched then no frame available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">chars</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return next bottom half action to perform</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_RECEIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_TRANSMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_STATUS</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Mark BH routine as complete */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perform bottom half processing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_info</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">action</span> <span class="o">=</span> <span class="n">bh_action</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BH_RECEIVE</span>:
			<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s bh receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MGSL_MODE_ASYNC</span>:
				<span class="n">rx_async</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MGSL_MODE_HDLC</span>:
				<span class="k">while</span><span class="p">(</span><span class="n">rx_get_frame</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MGSL_MODE_RAW</span>:
			<span class="k">case</span> <span class="n">MGSL_MODE_MONOSYNC</span>:
			<span class="k">case</span> <span class="n">MGSL_MODE_BISYNC</span>:
			<span class="k">case</span> <span class="n">MGSL_MODE_XSYNC</span>:
				<span class="k">while</span><span class="p">(</span><span class="n">rx_get_buf</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* restart receiver if rx DMA buffers exhausted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_restart</span><span class="p">)</span>
				<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_TRANSMIT</span>:
			<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_STATUS</span>:
			<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s bh status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s unknown action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s bh_handler exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s bh_transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsr_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DSR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_DSR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_down</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;dsr_change %s signals=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">==</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_DSR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cts_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_CTS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_CTS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_down</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;cts_change %s signals=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">==</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_CTS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="p">{</span>
		 			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">))</span>
		 			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dcd_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DCD</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_DCD</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_down</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;dcd_change %s signals=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">==</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_DCD</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ri_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RI</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RI</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_down</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;ri_change %s signals=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">==</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RI</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rxdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_RXDATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDR</span><span class="p">);</span>
		<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;isr_rxdata %s RDR=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc_complete</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="cm">/* all buffers full */</span>
			<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">reg</span><span class="p">;</span>
		<span class="cm">/* async mode saves status byte to buffer for each data byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">BIT10</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* buffer full or end of frame */</span>
			<span class="n">set_desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">set_desc_status</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">BIT15</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">);</span>

	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s isr_serial status=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span> <span class="cm">/* clear pending */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXIDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
				<span class="n">isr_txeom</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_pio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXDATA</span><span class="p">))</span>
			<span class="n">isr_rxdata</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXBREAK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXBREAK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* process break detection if tty control allows */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">&amp;</span> <span class="n">MASK_BREAK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
							<span class="n">do_SAK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_TXIDLE</span> <span class="o">+</span> <span class="n">IRQ_TXUNDER</span><span class="p">))</span>
			<span class="n">isr_txeom</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_pio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXDATA</span><span class="p">))</span>
			<span class="n">isr_rxdata</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXIDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXIDLE</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxidle</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">exithunt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RXOVER</span><span class="p">)</span>
			<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_DSR</span><span class="p">)</span>
		<span class="n">dsr_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_CTS</span><span class="p">)</span>
		<span class="n">cts_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_DCD</span><span class="p">)</span>
		<span class="n">dcd_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_RI</span><span class="p">)</span>
		<span class="n">ri_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">);</span>

	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s isr_rdma status=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

	<span class="cm">/* RDCSR (rx DMA control/status)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 31..07  reserved</span>
<span class="cm">	 * 06      save status byte to DMA buffer</span>
<span class="cm">	 * 05      error</span>
<span class="cm">	 * 04      eol (end of list)</span>
<span class="cm">	 * 03      eob (end of buffer)</span>
<span class="cm">	 * 02      IRQ enable</span>
<span class="cm">	 * 01      reset</span>
<span class="cm">	 * 00      enable</span>
<span class="cm">	 */</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>	<span class="cm">/* clear pending */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s isr_rdma rx_restart=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_tdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">);</span>

	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s isr_tdma status=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

	<span class="cm">/* TDCSR (tx DMA control/status)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 31..06  reserved</span>
<span class="cm">	 * 05      error</span>
<span class="cm">	 * 04      eol (end of list)</span>
<span class="cm">	 * 03      eob (end of buffer)</span>
<span class="cm">	 * 02      IRQ enable</span>
<span class="cm">	 * 01      reset</span>
<span class="cm">	 * 00      enable</span>
<span class="cm">	 */</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>	<span class="cm">/* clear pending */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>another transmit buffer has completed
run bottom half to get more send data from user</p></td><td class="code"><div class="highlight"><pre>		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return true if there are unsent tx DMA buffers, otherwise false</span>
<span class="cm"> *</span>
<span class="cm"> * if there are unsent buffers then info-&gt;tbuf_start</span>
<span class="cm"> * is set to index of first unsent buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">unsent_tbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * search backwards from last loaded buffer (precedes tbuf_current)</span>
<span class="cm">	 * for first unsent buffer (desc_count &gt; 0)</span>
<span class="cm">	 */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txeom</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s txeom status=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXDATA</span> <span class="o">+</span> <span class="n">IRQ_TXIDLE</span> <span class="o">+</span> <span class="n">IRQ_TXUNDER</span><span class="p">);</span>
	<span class="n">tdma_reset</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXUNDER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span> <span class="cm">/* set reset bit */</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="cm">/* clear reset bit */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXUNDER</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_TXIDLE</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unsent_tbufs</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">update_tx_timer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
			<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="cm">/* wake processes waiting for specific transitions */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* interrupt service routine</span>
<span class="cm"> *</span>
<span class="cm"> * 	irq	interrupt number</span>
<span class="cm"> * 	dev_id	device ID supplied during interrupt registration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">slgt_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;slgt_interrupt irq=%d entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">));</span>

	<span class="k">while</span><span class="p">((</span><span class="n">gsr</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">GSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s gsr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">gsr</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT8</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">isr_serial</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT16</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span>
				<span class="n">isr_rdma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT17</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span>
				<span class="n">isr_tdma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">changed</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOSR</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s iosr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">changed</span><span class="p">));</span>
			<span class="cm">/* read latched state of GPIO signals */</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOVR</span><span class="p">);</span>
			<span class="cm">/* clear pending GPIO interrupt bits */</span>
			<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOSR</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">isr_gpio</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">changed</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">port</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_requested</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;%s bh queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBGISR</span><span class="p">((</span><span class="s">&quot;slgt_interrupt irq=%d exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s startup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s can&#39;t allocate tx buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>

	<span class="cm">/* program hardware for current parameters */</span>
	<span class="n">change_params</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  called by close() and hangup() to shutdown hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="cm">/* clear status wait queue because status changes */</span>
	<span class="cm">/* can&#39;t happen after shutting down the hardware */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_timer</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_ALL</span> <span class="o">|</span> <span class="n">IRQ_MASTER</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">);</span>
		<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">flush_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">program_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">sync_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">async_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_DCD</span> <span class="o">|</span> <span class="n">IRQ_CTS</span> <span class="o">|</span> <span class="n">IRQ_DSR</span> <span class="o">|</span> <span class="n">IRQ_RI</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">))</span>
		<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reconfigure adapter based on new parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits_per_char</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s change_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* if B0 rate (hangup) specified then negate DTR and RTS */</span>
	<span class="cm">/* otherwise assert DTR and RTS */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>

	<span class="cm">/* byte size and parity */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="o">?</span> <span class="n">ASYNC_PARITY_ODD</span> <span class="o">:</span> <span class="n">ASYNC_PARITY_EVEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">;</span>

	<span class="cm">/* calculate number of jiffies to transmit a full</span>
<span class="cm">	 * FIFO (32 bytes) at specified data rate</span>
<span class="cm">	 */</span>
	<span class="n">bits_per_char</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">+</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="n">HZ</span><span class="o">*</span><span class="n">bits_per_char</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>		<span class="cm">/* Add .02 seconds of slop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>

	<span class="cm">/* process tty input control flags */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">IRQ_RXOVER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">MASK_PARITY</span> <span class="o">|</span> <span class="n">MASK_FRAMING</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
 		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">MASK_BREAK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">MASK_PARITY</span> <span class="o">|</span> <span class="n">MASK_FRAMING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">MASK_BREAK</span><span class="p">;</span>
		<span class="cm">/* If ignoring parity and break indicators, ignore</span>
<span class="cm">		 * overruns too.  (For real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">MASK_OVERRUN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_icount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_icount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgsl_icount</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_params</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">MGSL_PARAMS</span> <span class="n">tmp_params</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="n">new_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_BASE_CLOCK</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span> <span class="o">=</span> <span class="n">tmp_params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_txidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_txidle=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">,</span> <span class="n">idle_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_txidle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_txidle(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">idle_mode</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">idle_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span>
		<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tx_enable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">enable</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
			<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
			<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * abort transmit HDLC frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tx_abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tdma_reset</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rbuf_fill_level</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s rx_enable(%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">enable</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * enable[31..16] = receive DMA buffer fill level</span>
<span class="cm">	 * 0 = noop (leave fill level unchanged)</span>
<span class="cm">	 * fill level must be multiple of 4 and &lt;= buffer size</span>
<span class="cm">	 */</span>
	<span class="n">rbuf_fill_level</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">enable</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbuf_fill_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rbuf_fill_level</span> <span class="o">&gt;</span> <span class="n">DMABUFSIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rbuf_fill_level</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span> <span class="o">=</span> <span class="n">rbuf_fill_level</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbuf_fill_level</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_pio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PIO mode */</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* DMA mode */</span>
		<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* restart receiver to use new fill level */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable[1..0] = receiver enable command</span>
<span class="cm">	 * 0 = disable</span>
<span class="cm">	 * 1 = enable</span>
<span class="cm">	 * 2 = enable or force hunt mode if already enabled</span>
<span class="cm">	 */</span>
	<span class="n">enable</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
			<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* force hunt mode (write 1 to RCR[3]) */</span>
			<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
			<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  wait for specified event to occur</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_mgsl_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask_ptr</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">_input_signal_events</span> <span class="n">oldsigs</span><span class="p">,</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s wait_mgsl_event(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">mask</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* return immediately if state matches requested events */</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
		<span class="p">(</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="n">MgslEvent_DsrInactive</span><span class="p">)</span> <span class="o">+</span>
 		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="n">MgslEvent_DcdInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="n">MgslEvent_CtsInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">MgslEvent_RiActive</span> <span class="o">:</span><span class="n">MgslEvent_RiInactive</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>

	<span class="cm">/* enable hunt and idle irqs if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MgslEvent_ExitHuntMode</span><span class="o">+</span><span class="n">MgslEvent_IdleReceived</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IRQ_RXIDLE</span><span class="p">))</span>
			<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span> <span class="o">|</span> <span class="n">IRQ_RXIDLE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get current irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">newsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
			<span class="p">(</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">?</span> <span class="n">MgslEvent_DsrInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">?</span> <span class="n">MgslEvent_DcdInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">?</span> <span class="n">MgslEvent_CtsInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">?</span> <span class="n">MgslEvent_RiActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>    <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">?</span> <span class="n">MgslEvent_RiInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>  <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">?</span> <span class="n">MgslEvent_ExitHuntMode</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span>     <span class="o">?</span> <span class="n">MgslEvent_IdleReceived</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MgslEvent_ExitHuntMode</span> <span class="o">+</span> <span class="n">MgslEvent_IdleReceived</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* disable enable exit hunt mode/idle rcvd IRQs */</span>
			<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IRQ_RXIDLE</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">if_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_interface=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span><span class="p">,</span> <span class="n">if_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_interface=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">if_mode</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">=</span> <span class="n">if_mode</span><span class="p">;</span>

	<span class="n">msc_set_vcr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* TCR (tx control) 07  1=RTS driver control */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_RTS_EN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT7</span><span class="p">;</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_xsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">xsync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_xsync=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xsync</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xsync</span><span class="p">,</span> <span class="n">xsync</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set extended sync pattern (1 to 4 bytes) for extended sync mode</span>
<span class="cm"> *</span>
<span class="cm"> * sync pattern is contained in least significant bytes of value</span>
<span class="cm"> * most significant byte of sync pattern is oldest (1st sent/detected)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_xsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xsync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_xsync=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">xsync</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xsync</span> <span class="o">=</span> <span class="n">xsync</span><span class="p">;</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XSR</span><span class="p">,</span> <span class="n">xsync</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_xctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">xctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_xctrl=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xctrl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xctrl</span><span class="p">,</span> <span class="n">xctrl</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set extended control options</span>
<span class="cm"> *</span>
<span class="cm"> * xctrl[31:19] reserved, must be zero</span>
<span class="cm"> * xctrl[18:17] extended sync pattern length in bytes</span>
<span class="cm"> *              00 = 1 byte  in xsr[7:0]</span>
<span class="cm"> *              01 = 2 bytes in xsr[15:0]</span>
<span class="cm"> *              10 = 3 bytes in xsr[23:0]</span>
<span class="cm"> *              11 = 4 bytes in xsr[31:0]</span>
<span class="cm"> * xctrl[16]    1 = enable terminal count, 0=disabled</span>
<span class="cm"> * xctrl[15:0]  receive terminal count for fixed length packets</span>
<span class="cm"> *              value is count minus one (0 = 1 byte packet)</span>
<span class="cm"> *              when terminal count is reached, receiver</span>
<span class="cm"> *              automatically returns to hunt mode and receive</span>
<span class="cm"> *              FIFO contents are flushed to DMA buffers with</span>
<span class="cm"> *              end of frame (EOF) status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_xctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_xctrl=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">xctrl</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xctrl</span> <span class="o">=</span> <span class="n">xctrl</span><span class="p">;</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XCR</span><span class="p">,</span> <span class="n">xctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set general purpose IO pin state and direction</span>
<span class="cm"> *</span>
<span class="cm"> * user_gpio fields:</span>
<span class="cm"> * state   each bit indicates a pin state</span>
<span class="cm"> * smask   set bit indicates pin state to set</span>
<span class="cm"> * dir     each bit indicates a pin direction (0=input, 1=output)</span>
<span class="cm"> * dmask   set bit indicates pin direction to set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_gpio</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">user_gpio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s set_gpio state=%08x smask=%08x dir=%08x dmask=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">smask</span><span class="p">,</span>
		 <span class="n">gpio</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">dmask</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">dmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IODR</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">.</span><span class="n">dmask</span> <span class="o">&amp;</span> <span class="n">gpio</span><span class="p">.</span><span class="n">dir</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">dmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpio</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IODR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">smask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOVR</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">.</span><span class="n">smask</span> <span class="o">&amp;</span> <span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">smask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOVR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get general purpose IO pin state and direction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">gpio</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOVR</span><span class="p">);</span>
	<span class="n">gpio</span><span class="p">.</span><span class="n">smask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">gpio</span><span class="p">.</span><span class="n">dir</span>   <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IODR</span><span class="p">);</span>
	<span class="n">gpio</span><span class="p">.</span><span class="n">dmask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_gpio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s get_gpio state=%08x dir=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">dir</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * conditional wait facility</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">cw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cw</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">cw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_cond_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">cond_wait</span> <span class="o">**</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wait for general purpose I/O pin(s) to enter specified state</span>
<span class="cm"> *</span>
<span class="cm"> * user_gpio fields:</span>
<span class="cm"> * state - bit indicates target pin state</span>
<span class="cm"> * smask - set bit indicates watched pin</span>
<span class="cm"> *</span>
<span class="cm"> * The wait ends when at least one watched pin enters the specified</span>
<span class="cm"> * state. When 0 (no error) is returned, user_gpio-&gt;state is set to the</span>
<span class="cm"> * state of all GPIO pins when the wait ends.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Each pin may be a dedicated input, dedicated output, or</span>
<span class="cm"> * configurable input/output. The number and configuration of pins</span>
<span class="cm"> * varies with the specific adapter model. Only input pins (dedicated</span>
<span class="cm"> * or configured) can be monitored with this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_gpio</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_desc</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cond_wait</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_present</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">user_gpio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s wait_gpio() state=%08x smask=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">smask</span><span class="p">));</span>
	<span class="cm">/* ignore output pins identified by set IODR bit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gpio</span><span class="p">.</span><span class="n">smask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IODR</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">init_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">gpio</span><span class="p">.</span><span class="n">smask</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* enable interrupts for watched pins */</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOER</span><span class="p">,</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOER</span><span class="p">)</span> <span class="o">|</span> <span class="n">gpio</span><span class="p">.</span><span class="n">smask</span><span class="p">);</span>
	<span class="cm">/* get current pin states */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOVR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">smask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">state</span> <span class="o">^</span> <span class="n">gpio</span><span class="p">.</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* already in target state */</span>
		<span class="n">gpio</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wait for target state */</span>
		<span class="n">add_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">gpio</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">wait</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">remove_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable all GPIO interrupts if no waiting processes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_wait_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IOER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_gpio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio</span><span class="p">)))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">modem_input_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get new irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for change in caller specified modem input */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span>  <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  return state of serial control and status signals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">TIOCM_RNG</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tiocmget value=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">result</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set modem control signals (DTR/RTS)</span>
<span class="cm"> *</span>
<span class="cm"> * 	cmd	signal command: TIOCMBIS = set bit TIOCMBIC = clear bit</span>
<span class="cm"> *		TIOCMSET = set/clear signal values</span>
<span class="cm"> * 	value	bit mask for command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tiocmset(%x,%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_DTR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_info</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_info</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>
 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  block current process until the device is ready to open</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">block_til_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">do_clocal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">extra_count</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">cd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s block_til_ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">)){</span>
		<span class="cm">/* nonblock mode is set or port is not enabled */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">do_clocal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Wait for carrier detect and the line to become</span>
<span class="cm">	 * free (i.e., not in use by the callout).  While we are in</span>
<span class="cm">	 * this loop, port-&gt;count is dropped by one, so that</span>
<span class="cm">	 * close() knows when to free things.  We restore it upon</span>
<span class="cm">	 * exit, either normal or abnormal.</span>
<span class="cm">	 */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">extra_count</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span>
			<span class="n">tty_port_raise_dtr_rts</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)){</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
					<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cd</span> <span class="o">=</span> <span class="n">tty_port_carrier_raised</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">do_clocal</span> <span class="o">||</span> <span class="n">cd</span> <span class="p">))</span>
 			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s block_til_ready wait</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">tty_lock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extra_count</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s block_til_ready ready, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_tmp_rbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_tmp_rbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate DMA descriptor lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pbufs</span><span class="p">;</span>

	<span class="cm">/* allocate memory to hold descriptor lists */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DESC_LIST_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs_dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DESC_LIST_SIZE</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">;</span>

	<span class="n">pbufs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs_dma_addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Build circular lists of descriptors</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* physical address of this descriptor */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pdesc</span> <span class="o">=</span> <span class="n">pbufs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="p">));</span>

		<span class="cm">/* physical address of next descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pbufs</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pbufs</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="p">)));</span>
		<span class="n">set_desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DMABUFSIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* physical address of this descriptor */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pdesc</span> <span class="o">=</span> <span class="n">pbufs</span> <span class="o">+</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="p">));</span>

		<span class="cm">/* physical address of next descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pbufs</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pbufs</span> <span class="o">+</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_desc</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DESC_LIST_SIZE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs_dma_addr</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMABUFSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_dma_addr</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pbuf</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_dma_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMABUFSIZE</span><span class="p">,</span> <span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_dma_addr</span><span class="p">);</span>
		<span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_dma_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_desc</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">alloc_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">alloc_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">alloc_tmp_rbuf</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s DMA buffer alloc fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reset_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_dma_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">);</span>
		<span class="n">free_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">);</span>
		<span class="n">free_desc</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_tmp_rbuf</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claim_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">,</span> <span class="n">SLGT_REG_SIZE</span><span class="p">,</span> <span class="s">&quot;synclink_gt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s reg addr conflict, addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressConflict</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">,</span> <span class="n">SLGT_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s can&#39;t map device registers, addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_CantAssignPciResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">,</span> <span class="n">SLGT_REG_SIZE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Add the specified device instance data structure to the</span>
<span class="cm"> * global linked list of devices and increment the device count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">devstr</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">slgt_device_count</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">tty_dev_prefix</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">MAX_DEVICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">])</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">slgt_device_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slgt_device_list</span><span class="p">)</span>
		<span class="n">slgt_device_list</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">slgt_device_list</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">)</span>
			<span class="n">current_dev</span> <span class="o">=</span> <span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYNCLINK_GT_DEVICE_ID</span>:
		<span class="n">devstr</span> <span class="o">=</span> <span class="s">&quot;GT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCLINK_GT2_DEVICE_ID</span>:
		<span class="n">devstr</span> <span class="o">=</span> <span class="s">&quot;GT2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCLINK_GT4_DEVICE_ID</span>:
		<span class="n">devstr</span> <span class="o">=</span> <span class="s">&quot;GT4&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCLINK_AC_DEVICE_ID</span>:
		<span class="n">devstr</span> <span class="o">=</span> <span class="s">&quot;AC&quot;</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">devstr</span> <span class="o">=</span> <span class="s">&quot;(unknown model)&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SyncLink %s %s IO=%08x IRQ=%d MaxFrameSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">devstr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="n">hdlcdev_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">slgt_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">dtr_rts</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  allocate device instance structure, return NULL on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="nf">alloc_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s device alloc failed adapter=%d port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="n">port_num</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slgt_port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">MGSL_MAGIC</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">bh_handler</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span> <span class="o">=</span> <span class="mi">14745600</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span> <span class="o">=</span> <span class="n">DMABUFSIZE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span><span class="o">&amp;</span><span class="n">default_params</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">HDLC_TXIDLE_FLAGS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_num</span> <span class="o">=</span> <span class="n">adapter_num</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>

		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">tx_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_timer</span><span class="p">,</span> <span class="n">rx_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Copy configuration info to device instance data */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">MGSL_BUS_TYPE_PCI</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* assume error, set to 0 on successful init */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">port_array</span><span class="p">[</span><span class="n">SLGT_MAX_PORTS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">SYNCLINK_GT2_DEVICE_ID</span><span class="p">)</span>
		<span class="n">port_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">SYNCLINK_GT4_DEVICE_ID</span><span class="p">)</span>
		<span class="n">port_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* allocate device instances for all ports */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_dev</span><span class="p">(</span><span class="n">adapter_num</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* give copy of port_array to all ports and add to device list  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">,</span> <span class="n">port_array</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port_array</span><span class="p">));</span>
		<span class="n">add_device</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">=</span> <span class="n">port_count</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate and claim adapter resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">claim_resources</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>

		<span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* copy resource information from first port to others */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_addr</span>  <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">;</span>
			<span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span>
					<span class="n">slgt_interrupt</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s request_irq failed IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
				<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">adapter_test</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span><span class="p">;</span>
				<span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">gpio_present</span> <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">gpio_present</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">tty_register_device</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error enabling pci device %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_init</span><span class="p">(</span><span class="n">slgt_device_count</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">slgt_compat_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">set_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">tx_hold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">tx_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">synclink_gt_proc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slgt_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;unload %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">slgt_device_list</span> <span class="p">;</span> <span class="n">info</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">)</span>
			<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">)))</span>
			<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;tty_unregister_driver error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset devices */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">slgt_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* release devices */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">slgt_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="n">hdlcdev_exit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">free_dma_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">free_tmp_rbuf</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_registered</span><span class="p">)</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Driver initialization entry point.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">slgt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>

	<span class="n">serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MAX_DEVICES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s can&#39;t allocate tty driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>

	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">tty_driver_name</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">tty_dev_prefix</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ttymajor</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
		<span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBGERR</span><span class="p">((</span><span class="s">&quot;%s can&#39;t register serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">));</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
		<span class="n">serial_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s, tty major#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">driver_name</span><span class="p">,</span> <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

	<span class="n">slgt_device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s pci_register_driver error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slgt_device_list</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s no devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">driver_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">slgt_cleanup</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">slgt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slgt_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">slgt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">slgt_exit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * register access routines</span>
<span class="cm"> */</span>

<span class="cp">#define CALC_REGADDR() \</span>
<span class="cp">	unsigned long reg_addr = ((unsigned long)info-&gt;reg_addr) + addr; \</span>
<span class="cp">	if (addr &gt;= 0x80) \</span>
<span class="cp">		reg_addr += (info-&gt;port_num) * 32; \</span>
<span class="cp">	else if (addr &gt;= 0x40)	\</span>
<span class="cp">		reg_addr += (info-&gt;port_num) * 16;</span>

<span class="k">static</span> <span class="n">__u8</span> <span class="nf">rd_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wr_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="nf">rd_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wr_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u32</span> <span class="nf">rd_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wr_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set reset bit */</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">,</span> <span class="n">BIT1</span><span class="p">);</span>

	<span class="cm">/* wait for enable bit cleared */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tdma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set reset bit */</span>
	<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">,</span> <span class="n">BIT1</span><span class="p">);</span>

	<span class="cm">/* wait for enable bit cleared */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * enable internal loopback</span>
<span class="cm"> * TxCLK and RxCLK are generated from BRG</span>
<span class="cm"> * and TxD is looped back to RxD internally.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* SCR (serial control) BIT2=loopback enable */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CCR (clock control)</span>
<span class="cm">		 * 07..05  tx clock source (010 = BRG)</span>
<span class="cm">		 * 04..02  rx clock source (010 = BRG)</span>
<span class="cm">		 * 01      auxclk enable   (0 = disable)</span>
<span class="cm">		 * 00      BRG enable      (1 = enable)</span>
<span class="cm">		 *</span>
<span class="cm">		 * 0100 1001</span>
<span class="cm">		 */</span>
		<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">);</span>

		<span class="cm">/* set speed if available, otherwise use default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
			<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">3686400</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  set baud rate generator to specified rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">osc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span><span class="p">;</span>

	<span class="cm">/* div = osc/rate - 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * Round div up if osc/rate is not integer to</span>
<span class="cm">	 * force to next slowest rate.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">osc</span><span class="o">/</span><span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">osc</span> <span class="o">%</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">div</span><span class="p">)</span>
			<span class="n">div</span><span class="o">--</span><span class="p">;</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">BDR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">div</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* disable and reset receiver */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT1</span><span class="p">;</span>          <span class="cm">/* clear enable bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span> <span class="cm">/* set reset bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>                  <span class="cm">/* clear reset bit */</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RXOVER</span> <span class="o">+</span> <span class="n">IRQ_RXDATA</span> <span class="o">+</span> <span class="n">IRQ_RXIDLE</span><span class="p">);</span>

	<span class="cm">/* clear pending rx interrupts */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="n">IRQ_RXIDLE</span> <span class="o">+</span> <span class="n">IRQ_RXOVER</span><span class="p">);</span>

	<span class="n">rdma_reset</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_restart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RXOVER</span> <span class="o">+</span> <span class="n">IRQ_RXDATA</span><span class="p">);</span>

	<span class="cm">/* clear pending rx overrun IRQ */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="n">IRQ_RXOVER</span><span class="p">);</span>

	<span class="cm">/* reset and disable receiver */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT1</span><span class="p">;</span> <span class="cm">/* clear enable bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span> <span class="cm">/* set reset bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>                  <span class="cm">/* clear reset bit */</span>

	<span class="n">rdma_reset</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">reset_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rx request when rx FIFO not empty */</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT14</span><span class="p">));</span>
		<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RXDATA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable saving of rx status */</span>
			<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">,</span> <span class="n">BIT6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* rx request when rx FIFO half full */</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT14</span><span class="p">));</span>
		<span class="cm">/* set 1st descriptor address */</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDDAR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pdesc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enable rx DMA and DMA interrupt */</span>
			<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">,</span> <span class="p">(</span><span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* enable saving of rx status, rx DMA and DMA interrupt */</span>
			<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RDCSR</span><span class="p">,</span> <span class="p">(</span><span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RXOVER</span><span class="p">);</span>

	<span class="cm">/* enable receiver */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT1</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_restart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT2</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_RTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
					<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXDATA</span><span class="p">);</span>
			<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXUNDER</span> <span class="o">+</span> <span class="n">IRQ_TXIDLE</span><span class="p">);</span>
			<span class="cm">/* clear tx idle and underrun status bits */</span>
			<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">IRQ_TXIDLE</span> <span class="o">+</span> <span class="n">IRQ_TXUNDER</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXDATA</span><span class="p">);</span>
			<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXIDLE</span><span class="p">);</span>
			<span class="cm">/* clear tx idle status bit */</span>
			<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="n">IRQ_TXIDLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* set 1st descriptor address and start DMA */</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDDAR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span><span class="p">].</span><span class="n">pdesc</span><span class="p">);</span>
		<span class="n">wr_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">,</span> <span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="n">tdma_reset</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* reset and disable transmitter */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT1</span><span class="p">;</span>          <span class="cm">/* clear enable bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span> <span class="cm">/* set reset bit */</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXDATA</span> <span class="o">+</span> <span class="n">IRQ_TXIDLE</span> <span class="o">+</span> <span class="n">IRQ_TXUNDER</span><span class="p">);</span>

	<span class="cm">/* clear tx idle and underrun status bit */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">IRQ_TXIDLE</span> <span class="o">+</span> <span class="n">IRQ_TXUNDER</span><span class="p">));</span>

	<span class="n">reset_tbufs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reg_addr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">);</span>
	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_ALL</span> <span class="o">|</span> <span class="n">IRQ_MASTER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
  	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_ALL</span> <span class="o">|</span> <span class="n">IRQ_MASTER</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* TCR (tx control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15..13  mode, 010=async</span>
<span class="cm">	 * 12..10  encoding, 000=NRZ</span>
<span class="cm">	 * 09      parity enable</span>
<span class="cm">	 * 08      1=odd parity, 0=even parity</span>
<span class="cm">	 * 07      1=RTS driver control</span>
<span class="cm">	 * 06      1=break enable</span>
<span class="cm">	 * 05..04  character length</span>
<span class="cm">	 *         00=5 bits</span>
<span class="cm">	 *         01=6 bits</span>
<span class="cm">	 *         10=7 bits</span>
<span class="cm">	 *         11=8 bits</span>
<span class="cm">	 * 03      0=1 stop bit, 1=2 stop bits</span>
<span class="cm">	 * 02      reset</span>
<span class="cm">	 * 01      enable</span>
<span class="cm">	 * 00      auto-CTS enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_RTS_EN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">==</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* RCR (rx control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15..13  mode, 010=async</span>
<span class="cm">	 * 12..10  encoding, 000=NRZ</span>
<span class="cm">	 * 09      parity enable</span>
<span class="cm">	 * 08      1=odd parity, 0=even parity</span>
<span class="cm">	 * 07..06  reserved, must be 0</span>
<span class="cm">	 * 05..04  character length</span>
<span class="cm">	 *         00=5 bits</span>
<span class="cm">	 *         01=6 bits</span>
<span class="cm">	 *         10=7 bits</span>
<span class="cm">	 *         11=8 bits</span>
<span class="cm">	 * 03      reserved, must be zero</span>
<span class="cm">	 * 02      reset</span>
<span class="cm">	 * 01      enable</span>
<span class="cm">	 * 00      auto-DCD enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">==</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_DCD</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR (clock control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  011 = tx clock source is BRG/16</span>
<span class="cm">	 * 04..02  010 = rx clock source is BRG</span>
<span class="cm">	 * 01      0 = auxclk disabled</span>
<span class="cm">	 * 00      1 = BRG enabled</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0110 1001</span>
<span class="cm">	 */</span>
	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>

	<span class="n">msc_set_vcr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* SCR (serial control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15  1=tx req on FIFO half empty</span>
<span class="cm">	 * 14  1=rx req on FIFO half full</span>
<span class="cm">	 * 13  tx data  IRQ enable</span>
<span class="cm">	 * 12  tx idle  IRQ enable</span>
<span class="cm">	 * 11  rx break on IRQ enable</span>
<span class="cm">	 * 10  rx data  IRQ enable</span>
<span class="cm">	 * 09  rx break off IRQ enable</span>
<span class="cm">	 * 08  overrun  IRQ enable</span>
<span class="cm">	 * 07  DSR      IRQ enable</span>
<span class="cm">	 * 06  CTS      IRQ enable</span>
<span class="cm">	 * 05  DCD      IRQ enable</span>
<span class="cm">	 * 04  RI       IRQ enable</span>
<span class="cm">	 * 03  0=16x sampling, 1=8x sampling</span>
<span class="cm">	 * 02  1=txd-&gt;rxd internal loopback enable</span>
<span class="cm">	 * 01  reserved, must be zero</span>
<span class="cm">	 * 00  1=master IRQ enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">BIT15</span> <span class="o">+</span> <span class="n">BIT14</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="cm">/* JCR[8] : 1 = x8 async mode feature available */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">JCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">16</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">base_clock</span> <span class="o">%</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">16</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* use 8x sampling */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* use 16x sampling */</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_RXBREAK</span> <span class="o">|</span> <span class="n">IRQ_RXOVER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">enable_loopback</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">slgt_irq_off</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_ALL</span> <span class="o">|</span> <span class="n">IRQ_MASTER</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* TCR (tx control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15..13  mode</span>
<span class="cm">	 *         000=HDLC/SDLC</span>
<span class="cm">	 *         001=raw bit synchronous</span>
<span class="cm">	 *         010=asynchronous/isochronous</span>
<span class="cm">	 *         011=monosync byte synchronous</span>
<span class="cm">	 *         100=bisync byte synchronous</span>
<span class="cm">	 *         101=xsync byte synchronous</span>
<span class="cm">	 * 12..10  encoding</span>
<span class="cm">	 * 09      CRC enable</span>
<span class="cm">	 * 08      CRC32</span>
<span class="cm">	 * 07      1=RTS driver control</span>
<span class="cm">	 * 06      preamble enable</span>
<span class="cm">	 * 05..04  preamble length</span>
<span class="cm">	 * 03      share open/close flag</span>
<span class="cm">	 * 02      reset</span>
<span class="cm">	 * 01      enable</span>
<span class="cm">	 * 00      auto-CTS enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">BIT2</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_XSYNC</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT15</span> <span class="o">+</span> <span class="n">BIT13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_MONOSYNC</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT14</span> <span class="o">+</span> <span class="n">BIT13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_BISYNC</span>:   <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_RAW</span>:      <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_RTS_EN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZB</span>:          <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI_MARK</span>:     <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI</span>:          <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT11</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span>:  <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_DIFF_BIPHASE_LEVEL</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT11</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_16_CCITT</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_32_CCITT</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span> <span class="o">+</span> <span class="n">BIT8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span> <span class="o">!=</span> <span class="n">HDLC_PREAMBLE_PATTERN_NONE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble_length</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_16BITS</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_32BITS</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_64BITS</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* TPR (transmit preamble) */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_FLAGS</span>: <span class="n">val</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_ONES</span>:  <span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_ZEROS</span>: <span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_10</span>:    <span class="n">val</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_01</span>:    <span class="n">val</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>                          <span class="n">val</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TPR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* RCR (rx control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15..13  mode</span>
<span class="cm">	 *         000=HDLC/SDLC</span>
<span class="cm">	 *         001=raw bit synchronous</span>
<span class="cm">	 *         010=asynchronous/isochronous</span>
<span class="cm">	 *         011=monosync byte synchronous</span>
<span class="cm">	 *         100=bisync byte synchronous</span>
<span class="cm">	 *         101=xsync byte synchronous</span>
<span class="cm">	 * 12..10  encoding</span>
<span class="cm">	 * 09      CRC enable</span>
<span class="cm">	 * 08      CRC32</span>
<span class="cm">	 * 07..03  reserved, must be 0</span>
<span class="cm">	 * 02      reset</span>
<span class="cm">	 * 01      enable</span>
<span class="cm">	 * 00      auto-DCD enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_XSYNC</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT15</span> <span class="o">+</span> <span class="n">BIT13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_MONOSYNC</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT14</span> <span class="o">+</span> <span class="n">BIT13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_BISYNC</span>:   <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_RAW</span>:      <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZB</span>:          <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI_MARK</span>:     <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI</span>:          <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT11</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span>:  <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_DIFF_BIPHASE_LEVEL</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT12</span> <span class="o">+</span> <span class="n">BIT11</span> <span class="o">+</span> <span class="n">BIT10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_16_CCITT</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_32_CCITT</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">BIT9</span> <span class="o">+</span> <span class="n">BIT8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_DCD</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR (clock control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  tx clock source</span>
<span class="cm">	 * 04..02  rx clock source</span>
<span class="cm">	 * 01      auxclk enable</span>
<span class="cm">	 * 00      BRG enable</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>when RxC source is DPLL, BRG generates 16X DPLL
reference clock, so take TxC from BRG/16 to get
transmit clock at actual data rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">;</span>	<span class="cm">/* 011, txclk = BRG/16 */</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>	<span class="cm">/* 010, txclk = BRG */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_DPLL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span><span class="p">;</span>	<span class="cm">/* 100, txclk = DPLL Input */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>	<span class="cm">/* 001, txclk = RXC Input */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_BRG</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>	<span class="cm">/* 010, rxclk = BRG */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>	<span class="cm">/* 100, rxclk = DPLL */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>	<span class="cm">/* 001, rxclk = TXC Input */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">+</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">))</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>program DPLL mode</p></td><td class="code"><div class="highlight"><pre>		<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span>:
		<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">BIT7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span>:
		<span class="k">case</span> <span class="n">HDLC_ENCODING_DIFF_BIPHASE_LEVEL</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">BIT6</span><span class="p">;</span>	<span class="c1">// NRZ encodings</span>
		<span class="p">}</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>DPLL requires a 16X reference clock from BRG</p></td><td class="code"><div class="highlight"><pre>		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>

	<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">msc_set_vcr</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* SCR (serial control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15  1=tx req on FIFO half empty</span>
<span class="cm">	 * 14  1=rx req on FIFO half full</span>
<span class="cm">	 * 13  tx data  IRQ enable</span>
<span class="cm">	 * 12  tx idle  IRQ enable</span>
<span class="cm">	 * 11  underrun IRQ enable</span>
<span class="cm">	 * 10  rx data  IRQ enable</span>
<span class="cm">	 * 09  rx idle  IRQ enable</span>
<span class="cm">	 * 08  overrun  IRQ enable</span>
<span class="cm">	 * 07  DSR      IRQ enable</span>
<span class="cm">	 * 06  CTS      IRQ enable</span>
<span class="cm">	 * 05  DCD      IRQ enable</span>
<span class="cm">	 * 04  RI       IRQ enable</span>
<span class="cm">	 * 03  reserved, must be zero</span>
<span class="cm">	 * 02  1=txd-&gt;rxd internal loopback enable</span>
<span class="cm">	 * 01  reserved, must be zero</span>
<span class="cm">	 * 00  1=master IRQ enable</span>
<span class="cm">	 */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SCR</span><span class="p">,</span> <span class="n">BIT15</span> <span class="o">+</span> <span class="n">BIT14</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">enable_loopback</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  set transmit idle mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_set_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tcr</span><span class="p">;</span>

	<span class="cm">/* if preamble enabled (tcr[6] == 1) then tx idle size = 8 bits</span>
<span class="cm">	 * else tcr[5:4] = tx idle size: 00 = 8 bits, 01 = 16 bits</span>
<span class="cm">	 */</span>
	<span class="n">tcr</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">&amp;</span> <span class="n">HDLC_TXIDLE_CUSTOM_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable preamble, set idle size to 16 bits */</span>
		<span class="n">tcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">))</span> <span class="o">|</span> <span class="n">BIT4</span><span class="p">;</span>
		<span class="cm">/* MSB of 16 bit idle specified in tx preamble register (TPR) */</span>
		<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TPR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tcr</span> <span class="o">&amp;</span> <span class="n">BIT6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* preamble is disabled, set idle size to 8 bits */</span>
		<span class="n">tcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">tcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_TXIDLE_CUSTOM_8</span> <span class="o">|</span> <span class="n">HDLC_TXIDLE_CUSTOM_16</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* LSB of custom tx idle specified in tx idle register */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* standard 8 bit idle patterns */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">HDLC_TXIDLE_FLAGS</span>:          <span class="n">val</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_TXIDLE_ALT_ZEROS_ONES</span>:
		<span class="k">case</span> <span class="n">HDLC_TXIDLE_ALT_MARK_SPACE</span>: <span class="n">val</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_TXIDLE_ZEROS</span>:
		<span class="k">case</span> <span class="n">HDLC_TXIDLE_SPACE</span>:          <span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>                         <span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get state of V24 status (input) signals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* clear all serial signals except DTR and RTS */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;=</span> <span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_CTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DCD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RI</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set V.24 Control Register based on current configuration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msc_set_vcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* VCR (V.24 control)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..04  serial IF select</span>
<span class="cm">	 * 03      DTR</span>
<span class="cm">	 * 02      RTS</span>
<span class="cm">	 * 01      LL</span>
<span class="cm">	 * 00      RL</span>
<span class="cm">	 */</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_RS232</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span> <span class="cm">/* 0010 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_V35</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">;</span> <span class="cm">/* 1110 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_RS422</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span> <span class="cm">/* 0100 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_MSB_FIRST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_LL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">&amp;</span> <span class="n">MGSL_INTERFACE_RL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">VCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set state of V24 control (output) signals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">rd_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">VCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT2</span><span class="p">;</span>
	<span class="n">wr_reg8</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">VCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free range of receive DMA buffers (i to last)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset current buffer for reuse */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mark all receive DMA buffers as free</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_rbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pass receive HDLC frame to upper layer</span>
<span class="cm"> *</span>
<span class="cm"> * return true if frame available, otherwise false</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">rx_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr_field</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_16_CCITT</span>: <span class="n">crc_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_CRC_32_CCITT</span>: <span class="n">crc_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">check_again:</span>

	<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr_field</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_complete</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">end</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">addr_field</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">end</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">framesize</span> <span class="o">+=</span> <span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">end</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc_eof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">end</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">end</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">){</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* status</span>
<span class="cm">	 *</span>
<span class="cm">	 * 15      buffer complete</span>
<span class="cm">	 * 14..06  reserved</span>
<span class="cm">	 * 05..04  residue</span>
<span class="cm">	 * 02      eof (end of frame)</span>
<span class="cm">	 * 01      CRC error</span>
<span class="cm">	 * 00      abort</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">desc_status</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">end</span><span class="p">]);</span>

	<span class="cm">/* ignore CRC bit if not using CRC (bit is undefined) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HDLC_CRC_NONE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">addr_field</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr_field</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">check_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">crc_size</span><span class="p">)</span> <span class="o">||</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="o">++</span><span class="p">;</span>
		<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span><span class="p">))</span>
			<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DBGBH</span><span class="p">((</span><span class="s">&quot;%s rx frame status=%04X size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">framesize</span><span class="p">));</span>
	<span class="n">DBGDATA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">start</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">framesize</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span><span class="p">),</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">framesize</span> <span class="o">-=</span> <span class="n">crc_size</span><span class="p">;</span>
			<span class="n">crc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">+</span> <span class="n">crc_size</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy dma buffer(s) to contiguous temp buffer */</span>
			<span class="kt">int</span> <span class="n">copy_count</span> <span class="o">=</span> <span class="n">framesize</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf_count</span> <span class="o">=</span> <span class="n">framesize</span><span class="p">;</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="o">++</span><span class="p">;</span>

			<span class="k">while</span><span class="p">(</span><span class="n">copy_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">partial_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">copy_count</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_fill_level</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">partial_count</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">partial_count</span><span class="p">;</span>
				<span class="n">copy_count</span> <span class="o">-=</span> <span class="n">partial_count</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_count</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span> <span class="o">?</span> <span class="n">RX_CRC_ERROR</span> <span class="o">:</span> <span class="n">RX_OK</span><span class="p">;</span>
				<span class="n">framesize</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
				<span class="n">hdlcdev_rx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
			<span class="k">else</span>
<span class="cp">#endif</span>
				<span class="n">ldisc_receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flag_buf</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pass receive buffer (RAW synchronous mode) to tty layer</span>
<span class="cm"> * return true if buffer available, otherwise false</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">rx_get_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbuf_current</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_complete</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_MODE_MONOSYNC</span>:
	<span class="k">case</span> <span class="n">MGSL_MODE_BISYNC</span>:
	<span class="k">case</span> <span class="n">MGSL_MODE_XSYNC</span>:
		<span class="cm">/* ignore residue in byte synchronous modes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc_residue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBGDATA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;rx_get_buf size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">ldisc_receive_buf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">flag_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">free_rbufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_tbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return number of free transmit DMA buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">free_tbuf_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">;</span>

	<span class="k">do</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* buffer in use */</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">)</span>
			<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">);</span>

	<span class="cm">/* if tx DMA active, last zero count buffer is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">))</span>
		<span class="o">--</span><span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return number of bytes in unsent transmit DMA buffers</span>
<span class="cm"> * and the serial controller tx FIFO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tbuf_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">active_buf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add descriptor counts for all tx DMA buffers.</span>
<span class="cm">	 * If count is zero (cleared by DMA controller after read),</span>
<span class="cm">	 * the buffer is complete or is actively being read from.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Record buf_count of last buffer with zero count starting</span>
<span class="cm">	 * from current ring position. buf_count is mirror</span>
<span class="cm">	 * copy of count and is not cleared by serial controller.</span>
<span class="cm">	 * If DMA controller is active, that buffer is actively</span>
<span class="cm">	 * being read so add to total.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
			<span class="n">total_count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_count</span><span class="p">)</span>
			<span class="n">active_buf_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">);</span>

	<span class="cm">/* read tx DMA status register */</span>
	<span class="n">reg_value</span> <span class="o">=</span> <span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDCSR</span><span class="p">);</span>

	<span class="cm">/* if tx DMA active, last zero count buffer is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span>
		<span class="n">total_count</span> <span class="o">+=</span> <span class="n">active_buf_count</span><span class="p">;</span>

	<span class="cm">/* add tx FIFO count = reg_value[15..8] */</span>
	<span class="n">total_count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* if transmitter active add one byte for shift register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
		<span class="n">total_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">total_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * load data into transmit DMA buffer ring and start transmitter if needed</span>
<span class="cm"> * return true if data accepted, otherwise false (buffers full)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tx_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slgt_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="cm">/* check required buffer space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">DMABUFSIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">free_tbuf_count</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">DBGDATA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;tx&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * copy data to one or more DMA buffers in circular ring</span>
<span class="cm">	 * tbuf_start   = first buffer for this data</span>
<span class="cm">	 * tbuf_current = next free buffer</span>
<span class="cm">	 *</span>
<span class="cm">	 * Copy all data before making data visible to DMA controller by</span>
<span class="cm">	 * setting descriptor count of the first buffer.</span>
<span class="cm">	 * This prevents an active DMA controller from reading the first DMA</span>
<span class="cm">	 * buffers of a frame and stopping before the final buffers are filled.</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">DMABUFSIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DMABUFSIZE</span> <span class="o">:</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">buf</span>  <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * set EOF bit for last buffer of HDLC frame or</span>
<span class="cm">		 * for every buffer in raw mode</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_RAW</span><span class="p">)</span>
			<span class="n">set_desc_eof</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_desc_eof</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* set descriptor count for all but first buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span><span class="p">)</span>
			<span class="n">set_desc_count</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_current</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set first buffer count to make new data visible to DMA controller */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbufs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tbuf_start</span><span class="p">];</span>
	<span class="n">set_desc_count</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>

	<span class="cm">/* start transmitter if needed and update transmit timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
		<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">update_tx_timer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">register_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">patterns</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xaaaa</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">,</span> <span class="mh">0x6969</span><span class="p">,</span> <span class="mh">0x9696</span><span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">patterns</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIR</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">BDR</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">BDR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">patterns</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">gpio_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">rd_reg32</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">JCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">DiagStatus_AddressFailure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irq_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">oldtty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">async_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">slgt_irq_on</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IRQ_TXIDLE</span><span class="p">);</span>

	<span class="cm">/* enable transmitter */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">rd_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT1</span><span class="p">));</span>

	<span class="cm">/* write one byte and wait for tx idle */</span>
	<span class="n">wr_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* assume failure */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_IrqFailure</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">timeout</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span><span class="p">)</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">oldtty</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">DiagStatus_IrqFailure</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">loopback_test_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc_complete</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">desc_count</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">src</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbufs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">dest</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">count</span><span class="o">-=</span><span class="mi">2</span><span class="p">,</span> <span class="n">src</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* src=data byte (src+1)=status byte */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT9</span> <span class="o">+</span> <span class="n">BIT8</span><span class="p">)))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
				<span class="n">dest</span><span class="o">++</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">DBGDATA</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf_count</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">loopback_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TESTFRAMESIZE 20</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">TESTFRAMESIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TESTFRAMESIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">oldtty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">MGSL_PARAMS</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* build and send transmit frame */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">TESTFRAMESIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">count</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TESTFRAMESIZE</span><span class="p">);</span>

	<span class="cm">/* program hardware for HDLC and enabled receiver */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">async_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_load</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* wait for receive complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loopback_test_rx</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* verify received frame length and contents */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf_count</span> <span class="o">!=</span> <span class="n">count</span> <span class="o">||</span>
		  <span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_adapter</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">oldtty</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">DiagStatus_DmaFailure</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adapter_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;testing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;register test failure %s addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_reg_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ test failure %s IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loopback_test</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;loopback test failure %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * transmit timeout handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s tx_timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txtimeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * receive buffer polling timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slgt_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slgt_info</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBGINFO</span><span class="p">((</span><span class="s">&quot;%s rx_timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bh_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
