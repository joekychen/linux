<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › pty.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pty.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> *  Added support for a Unix98-style ptmx device.</span>
<span class="cm"> *    -- C. Scott Ananian &lt;cananian@alumni.princeton.edu&gt;, 14-Jan-1998</span>
<span class="cm"> *</span>
<span class="cm"> *  When reading this code see also fs/devpts. In particular note that the</span>
<span class="cm"> *  driver_data field is used by the devpts side as a binding to the devpts</span>
<span class="cm"> *  inode.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/devpts_fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>


<span class="cp">#ifdef CONFIG_UNIX98_PTYS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">ptm_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">pts_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">devpts_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_UNIX98_PTYS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="n">ptm_driver</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
			<span class="n">devpts_pty_kill</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="n">tty_vhangup</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">tty_lock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The unthrottle routine is called by the line discipline to signal</span>
<span class="cm"> * that it can receive more characters.  For PTY&#39;s, the TTY_THROTTLED</span>
<span class="cm"> * flag is always set, to force the line discipline to always call the</span>
<span class="cm"> * unthrottle routine when there are fewer than TTY_THRESHOLD_UNTHROTTLE</span>
<span class="cm"> * characters in the queue.  This is necessary since each time this</span>
<span class="cm"> * happens, we need to wake up any sleeping processes that could be</span>
<span class="cm"> * (1) trying to send data to the pty, or (2) waiting in wait_until_sent()</span>
<span class="cm"> * for the pty buffer to be drained.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pty_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pty_space	-	report space left for writing</span>
<span class="cm"> *	@to: tty we are writing into</span>
<span class="cm"> *</span>
<span class="cm"> *	The tty buffers allow 64K but we sneak a peak and clip at 8K this</span>
<span class="cm"> *	allows a lot of overspill room for echo and other fun messes to</span>
<span class="cm"> *	be handled properly</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">8192</span> <span class="o">-</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pty_write		-	write to a pty</span>
<span class="cm"> *	@tty: the tty we write from</span>
<span class="cm"> *	@buf: kernel buffer of data</span>
<span class="cm"> *	@count: bytes to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Our &quot;hardware&quot; write method. Data is coming from the ldisc which</span>
<span class="cm"> *	may be in a non sleeping state. We simply throw this at the other</span>
<span class="cm"> *	end of the link as if we were an IRQ handler receiving stuff for</span>
<span class="cm"> *	the other side of the pty/tty pair.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stuff the data into the input queue of the other end */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="cm">/* And shovel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pty_write_room	-	write space</span>
<span class="cm"> *	@tty: tty we are writing from</span>
<span class="cm"> *</span>
<span class="cm"> *	Report how many bytes the ldisc can send into the queue for</span>
<span class="cm"> *	the other device.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pty_space</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pty_chars_in_buffer	-	characters currently in our tx queue</span>
<span class="cm"> *	@tty: our tty</span>
<span class="cm"> *</span>
<span class="cm"> *	Report how much we have in the transmit queue. As everything is</span>
<span class="cm"> *	instantly at the other end this is easy to implement.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the lock flag on a pty */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_set_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_PTY_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_PTY_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send a signal to the slave */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pgrp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pgrp</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">put_pid</span><span class="p">(</span><span class="n">pgrp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pty_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* tty_buffer_flush(to); FIXME */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">|=</span> <span class="n">TIOCPKT_FLUSHWRITE</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_PTY_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSIZE</span> <span class="o">|</span> <span class="n">PARENB</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pty_do_resize		-	resize event</span>
<span class="cm"> *	@tty: tty being resized</span>
<span class="cm"> *	@ws: window size being set.</span>
<span class="cm"> *</span>
<span class="cm"> *	Update the termios variables and send the necessary signals to</span>
<span class="cm"> *	peform a terminal resize correctly</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">pty_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">winsize</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pgrp</span><span class="p">,</span> <span class="o">*</span><span class="n">rpgrp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">pty</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="cm">/* For a PTY we need to lock the tty side */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ws</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Get the PID values and reference them so we can</span>
<span class="cm">	   avoid holding the tty ctrl lock while sending signals.</span>
<span class="cm">	   We need to lock these individually however. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pgrp</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rpgrp</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">pty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgrp</span><span class="p">)</span>
		<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">SIGWINCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpgrp</span> <span class="o">!=</span> <span class="n">pgrp</span> <span class="o">&amp;&amp;</span> <span class="n">rpgrp</span><span class="p">)</span>
		<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">rpgrp</span><span class="p">,</span> <span class="n">SIGWINCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">put_pid</span><span class="p">(</span><span class="n">pgrp</span><span class="p">);</span>
	<span class="n">put_pid</span><span class="p">(</span><span class="n">rpgrp</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span> <span class="o">=</span> <span class="o">*</span><span class="n">ws</span><span class="p">;</span>
	<span class="n">pty</span><span class="o">-&gt;</span><span class="n">winsize</span> <span class="o">=</span> <span class="o">*</span><span class="n">ws</span><span class="p">;</span>	<span class="cm">/* Never used so will go away soon */</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Traditional BSD devices */</span>
<span class="cp">#ifdef CONFIG_LEGACY_PTYS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">o_tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">o_tty</span> <span class="o">=</span> <span class="n">alloc_tty_struct</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">o_tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This cannot in fact currently happen */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_tty</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">initialize_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* We always use new tty termios data so we can do this</span>
<span class="cm">	   the easy way .. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_init_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_deinit_tty</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_init_termios</span><span class="p">(</span><span class="n">o_tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_termios</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Everything allocated ... set up the o_tty structure.</span>
<span class="cm">	 */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">ttys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_tty</span><span class="p">;</span>
	<span class="n">tty_driver_kref_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span>
		<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Establish the links in both directions */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span>   <span class="o">=</span> <span class="n">o_tty</span><span class="p">;</span>
	<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="n">tty_driver_kref_get</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">ttys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_free_termios:</span>
	<span class="n">tty_free_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">err_deinit_tty:</span>
	<span class="n">deinitialize_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="nl">err_free_tty:</span>
	<span class="n">free_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_bsd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCSPTLCK</span>: <span class="cm">/* Set PT Lock (disallow slave open) */</span>
		<span class="k">return</span> <span class="n">pty_set_lock</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSIG</span>:    <span class="cm">/* Send signal to other side of pty */</span>
		<span class="k">return</span> <span class="n">pty_signal</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">legacy_count</span> <span class="o">=</span> <span class="n">CONFIG_LEGACY_PTY_COUNT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">legacy_count</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The master side of a pty can do TIOCSPTLCK and thus</span>
<span class="cm"> * has pty_bsd_ioctl.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">master_pty_ops_bsd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">install</span> <span class="o">=</span> <span class="n">pty_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">pty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">pty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">pty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">pty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">pty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">pty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">pty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">pty_bsd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span> <span class="o">=</span> <span class="n">pty_resize</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">slave_pty_ops_bsd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">install</span> <span class="o">=</span> <span class="n">pty_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">pty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">pty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">pty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">pty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">pty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">pty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">pty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span> <span class="o">=</span> <span class="n">pty_resize</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">legacy_pty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">pty_driver</span><span class="p">,</span> <span class="o">*</span><span class="n">pty_slave_driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">legacy_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pty_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">legacy_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pty_driver</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate pty driver&quot;</span><span class="p">);</span>

	<span class="n">pty_slave_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">legacy_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pty_slave_driver</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate pty slave driver&quot;</span><span class="p">);</span>

	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;pty_master&quot;</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pty&quot;</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">PTY_MASTER_MAJOR</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_PTY</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B38400</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span> <span class="o">|</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">pty_driver</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">pty_slave_driver</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">pty_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_pty_ops_bsd</span><span class="p">);</span>

	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;pty_slave&quot;</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyp&quot;</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">PTY_SLAVE_MAJOR</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_PTY</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">PTY_TYPE_SLAVE</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B38400</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span> <span class="o">|</span>
					<span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">pty_slave_driver</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">pty_driver</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">pty_slave_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slave_pty_ops_bsd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">pty_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register pty driver&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">pty_slave_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register pty slave driver&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">legacy_pty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Unix98 devices */</span>
<span class="cp">#ifdef CONFIG_UNIX98_PTYS</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">ptmx_cdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_unix98_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCSPTLCK</span>: <span class="cm">/* Set PT Lock (disallow slave open) */</span>
		<span class="k">return</span> <span class="n">pty_set_lock</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCGPTN</span>: <span class="cm">/* Get PT Number */</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSIG</span>:    <span class="cm">/* Send signal to other side of pty */</span>
		<span class="k">return</span> <span class="n">pty_signal</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ptm_unix98_lookup	-	find a pty master</span>
<span class="cm"> *	@driver: ptm driver</span>
<span class="cm"> *	@idx: tty index</span>
<span class="cm"> *</span>
<span class="cm"> *	Look up a pty master device. Called under the tty_mutex for now.</span>
<span class="cm"> *	This provides our locking.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="nf">ptm_unix98_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">ptm_inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Master must be open via /dev/ptmx */</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	pts_unix98_lookup	-	find a pty slave</span>
<span class="cm"> *	@driver: pts driver</span>
<span class="cm"> *	@idx: tty index</span>
<span class="cm"> *</span>
<span class="cm"> *	Look up a pty master device. Called under the tty_mutex for now.</span>
<span class="cm"> *	This provides our locking for the tty pointer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="nf">pts_unix98_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">pts_inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">devpts_get_tty</span><span class="p">(</span><span class="n">pts_inode</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
	<span class="cm">/* Master must be open before slave */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tty</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pty_unix98_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty_driver_remove_tty</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="cm">/* We have our own method as we don&#39;t use the tty index */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We have no need to install and remove our tty objects as devpts does all</span>
<span class="cm">   the work for us */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pty_unix98_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">o_tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">o_tty</span> <span class="o">=</span> <span class="n">alloc_tty_struct</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">o_tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This cannot in fact currently happen */</span>
		<span class="k">goto</span> <span class="n">err_free_tty</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">initialize_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>
	<span class="o">*</span><span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">;</span>
	<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span> <span class="o">=</span> <span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tty_driver_kref_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span>
		<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Establish the links in both directions */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span>   <span class="o">=</span> <span class="n">o_tty</span><span class="p">;</span>
	<span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * All structures have been allocated, so now we install them.</span>
<span class="cm">	 * Failures after this point use release_tty to clean up, so</span>
<span class="cm">	 * there&#39;s no need to null out the local pointers.</span>
<span class="cm">	 */</span>
	<span class="n">tty_driver_kref_get</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_free_mem:</span>
	<span class="n">deinitialize_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">o_tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="nl">err_free_tty:</span>
	<span class="n">free_tty_struct</span><span class="p">(</span><span class="n">o_tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptm_unix98_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pts_unix98_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">ptm_unix98_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">ptm_unix98_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">install</span> <span class="o">=</span> <span class="n">pty_unix98_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ptm_unix98_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">pty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">pty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">pty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">pty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">pty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">pty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">pty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">pty_unix98_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">pty_unix98_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span> <span class="o">=</span> <span class="n">pty_resize</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">pty_unix98_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">pts_unix98_lookup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">install</span> <span class="o">=</span> <span class="n">pty_unix98_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pts_unix98_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">pty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">pty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">pty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">pty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">pty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">pty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">pty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">pty_unix98_shutdown</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	ptmx_open		-	open a unix 98 pty master</span>
<span class="cm"> *	@inode: inode of device file</span>
<span class="cm"> *	@filp: file pointer to tty</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate a unix98 pty master device from the ptmx driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: tty_mutex protects the init_dev work. tty-&gt;count should</span>
<span class="cm"> * 		protect the rest.</span>
<span class="cm"> *		allocated_ptys_lock handles the list of free pty numbers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ptmx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_alloc_file</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* find a device that is not in use. */</span>
	<span class="n">tty_lock</span><span class="p">();</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">devpts_new_index</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_file</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_init_dev</span><span class="p">(</span><span class="n">ptm_driver</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devpts_mutex</span><span class="p">);</span>
	<span class="n">tty_lock</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_PTY_LOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="cm">/* LOCK THE SLAVE */</span>

	<span class="n">tty_add_file</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">devpts_pty_new</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>

	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_release:</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="n">tty_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">devpts_kill_index</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
<span class="nl">err_file:</span>
	<span class="n">tty_free_file</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ptmx_fops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">unix98_pty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptm_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_UNIX98_PTY_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptm_driver</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate Unix98 ptm driver&quot;</span><span class="p">);</span>
	<span class="n">pts_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_UNIX98_PTY_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pts_driver</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate Unix98 pts driver&quot;</span><span class="p">);</span>

	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;pty_master&quot;</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ptm&quot;</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">UNIX98_PTY_MASTER_MAJOR</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_PTY</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B38400</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span> <span class="o">|</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span>
		<span class="n">TTY_DRIVER_DYNAMIC_DEV</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DEVPTS_MEM</span><span class="p">;</span>
	<span class="n">ptm_driver</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">pts_driver</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">ptm_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptm_unix98_ops</span><span class="p">);</span>

	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;pty_slave&quot;</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pts&quot;</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">UNIX98_PTY_SLAVE_MAJOR</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_PTY</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">PTY_TYPE_SLAVE</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B38400</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span> <span class="o">|</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span>
		<span class="n">TTY_DRIVER_DYNAMIC_DEV</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DEVPTS_MEM</span><span class="p">;</span>
	<span class="n">pts_driver</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">ptm_driver</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">pts_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pty_unix98_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">ptm_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register Unix98 ptm driver&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">pts_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register Unix98 pts driver&quot;</span><span class="p">);</span>

	<span class="cm">/* Now create the /dev/ptmx special device */</span>
	<span class="n">tty_default_fops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptmx_fops</span><span class="p">);</span>
	<span class="n">ptmx_fops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ptmx_open</span><span class="p">;</span>

	<span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptmx_cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptmx_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptmx_cdev</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">TTYAUX_MAJOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">TTYAUX_MAJOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/dev/ptmx&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register /dev/ptmx driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">device_create</span><span class="p">(</span><span class="n">tty_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">TTYAUX_MAJOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ptmx&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unix98_pty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">legacy_pty_init</span><span class="p">();</span>
	<span class="n">unix98_pty_init</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">pty_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
