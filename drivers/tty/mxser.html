<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › mxser.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>mxser.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *          mxser.c  -- MOXA Smartio/Industio family multiport serial driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 1999-2006  Moxa Technologies (support@moxa.com).</span>
<span class="cm"> *	Copyright (C) 2006-2008  Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      This code is loosely based on the 1.8 moxa driver which is based on</span>
<span class="cm"> *	Linux serial driver, written by Linus Torvalds, Theodore T&#39;so and</span>
<span class="cm"> *	others.</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Fed through a cleanup, indent and remove of non 2.6 code by Alan Cox</span>
<span class="cm"> *	&lt;alan@lxorguk.ukuu.org.uk&gt;. The original 1.8 code is available on</span>
<span class="cm"> *	www.moxa.com.</span>
<span class="cm"> *	- Fixed x86_64 cleanness</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;mxser.h&quot;</span>

<span class="cp">#define	MXSER_VERSION	&quot;2.0.5&quot;		</span><span class="cm">/* 1.14 */</span><span class="cp"></span>
<span class="cp">#define	MXSERMAJOR	 174</span>

<span class="cp">#define MXSER_BOARDS		4	</span><span class="cm">/* Max. boards */</span><span class="cp"></span>
<span class="cp">#define MXSER_PORTS_PER_BOARD	8	</span><span class="cm">/* Max. ports per board */</span><span class="cp"></span>
<span class="cp">#define MXSER_PORTS		(MXSER_BOARDS * MXSER_PORTS_PER_BOARD)</span>
<span class="cp">#define MXSER_ISR_PASS_LIMIT	100</span>

<span class="cm">/*CheckIsMoxaMust return value*/</span>
<span class="cp">#define MOXA_OTHER_UART		0x00</span>
<span class="cp">#define MOXA_MUST_MU150_HWID	0x01</span>
<span class="cp">#define MOXA_MUST_MU860_HWID	0x02</span>

<span class="cp">#define WAKEUP_CHARS		256</span>

<span class="cp">#define UART_MCR_AFE		0x20</span>
<span class="cp">#define UART_LSR_SPECIAL	0x1E</span>

<span class="cp">#define PCI_DEVICE_ID_POS104UL	0x1044</span>
<span class="cp">#define PCI_DEVICE_ID_CB108	0x1080</span>
<span class="cp">#define PCI_DEVICE_ID_CP102UF	0x1023</span>
<span class="cp">#define PCI_DEVICE_ID_CP112UL	0x1120</span>
<span class="cp">#define PCI_DEVICE_ID_CB114	0x1142</span>
<span class="cp">#define PCI_DEVICE_ID_CP114UL	0x1143</span>
<span class="cp">#define PCI_DEVICE_ID_CB134I	0x1341</span>
<span class="cp">#define PCI_DEVICE_ID_CP138U	0x1380</span>


<span class="cp">#define C168_ASIC_ID    1</span>
<span class="cp">#define C104_ASIC_ID    2</span>
<span class="cp">#define C102_ASIC_ID	0xB</span>
<span class="cp">#define CI132_ASIC_ID	4</span>
<span class="cp">#define CI134_ASIC_ID	3</span>
<span class="cp">#define CI104J_ASIC_ID  5</span>

<span class="cp">#define MXSER_HIGHBAUD	1</span>
<span class="cp">#define MXSER_HAS2	2</span>

<span class="cm">/* This is only for PCI */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_high_water</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_trigger</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_low_water</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">max_baud</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Gpci_uart_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">MOXA_OTHER_UART</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">921600L</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MOXA_MUST_MU150_HWID</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">230400L</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MOXA_MUST_MU860_HWID</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">921600L</span><span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define UART_INFO_NUM	ARRAY_SIZE(Gpci_uart_info)</span>

<span class="k">struct</span> <span class="n">mxser_cardinfo</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nports</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mxser_cardinfo</span> <span class="n">mxser_cards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 0*/</span>	<span class="p">{</span> <span class="s">&quot;C168 series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;C104 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CI-104J series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;C168H/PCI series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;C104H/PCI series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/* 5*/</span>	<span class="p">{</span> <span class="s">&quot;C102 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="n">MXSER_HAS2</span> <span class="p">},</span>	<span class="cm">/* C102-ISA */</span>
	<span class="p">{</span> <span class="s">&quot;CI-132 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="n">MXSER_HAS2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CI-134 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-132 series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-114 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/*10*/</span>	<span class="p">{</span> <span class="s">&quot;CT-114 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-102 series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="n">MXSER_HIGHBAUD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-104U series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-168U series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-132U series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/*15*/</span>	<span class="p">{</span> <span class="s">&quot;CP-134U series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-104JU series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Moxa UC7000 Serial&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>		<span class="cm">/* RC7000 */</span>
	<span class="p">{</span> <span class="s">&quot;CP-118U series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-102UL series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/*20*/</span>	<span class="p">{</span> <span class="s">&quot;CP-102U series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-118EL series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-168EL series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-104EL series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CB-108 series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/*25*/</span>	<span class="p">{</span> <span class="s">&quot;CB-114 series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CB-134I series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-138U series&quot;</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;POS-104UL series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-114UL series&quot;</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
<span class="cm">/*30*/</span>	<span class="p">{</span> <span class="s">&quot;CP-102UF series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;CP-112UL series&quot;</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* driver_data correspond to the lines in the structure above</span>
<span class="cm">   see also ISA probe function before you change something */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mxser_pcibrds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_C168</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_C104</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP132</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP114</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CT114</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP102</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP104U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP168U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP132U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP134U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">15</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP104JU</span><span class="p">),.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_RC7000</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">17</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP118U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP102UL</span><span class="p">),.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP102U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP118EL</span><span class="p">),.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">21</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP168EL</span><span class="p">),.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MOXA_CP104EL</span><span class="p">),.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CB108</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CB114</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CB134I</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CP138U</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_POS104UL</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">28</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CP114UL</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">29</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CP102UF</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOXA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CP112UL</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mxser_pcibrds</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">[</span><span class="n">MXSER_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ttymajor</span> <span class="o">=</span> <span class="n">MXSERMAJOR</span><span class="p">;</span>

<span class="cm">/* Variables for insmod */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Casper Yang&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MOXA Smartio/Industio Family Multiport Board Device Driver&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="s">&quot;ISA io addresses to look for a moxa board&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mxser_log</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">tick</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rxcnt</span><span class="p">[</span><span class="n">MXSER_PORTS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txcnt</span><span class="p">[</span><span class="n">MXSER_PORTS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mxser_mon</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rxcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">up_rxcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">up_txcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modem_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hold_reason</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mxser_mon_ext</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_cnt</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_cnt</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">up_rxcnt</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">up_txcnt</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">modem_status</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="kt">long</span> <span class="n">baudrate</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">databits</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">stopbits</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">parity</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">flowctrl</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fifo</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">iftype</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mxser_board</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mxser_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opmode_ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_baud</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rx_high_water</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_trigger</span><span class="p">;</span>		<span class="cm">/* Rx fifo trigger level */</span>
	<span class="kt">int</span> <span class="n">rx_low_water</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud_base</span><span class="p">;</span>		<span class="cm">/* max. speed */</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>		<span class="cm">/* UART type */</span>

	<span class="kt">int</span> <span class="n">x_char</span><span class="p">;</span>		<span class="cm">/* xon/xoff character */</span>
	<span class="kt">int</span> <span class="n">IER</span><span class="p">;</span>		<span class="cm">/* Interrupt Enable Register */</span>
	<span class="kt">int</span> <span class="n">MCR</span><span class="p">;</span>		<span class="cm">/* Modem control register */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">stop_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ldisc_stop_rx</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">custom_divisor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">err_shadow</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">icount</span><span class="p">;</span> <span class="cm">/* kernel counters for 4 input interrupts */</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">read_status_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ignore_status_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xmit_cnt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">normal_termios</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mxser_mon</span> <span class="n">mon_data</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">slock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mxser_board</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mxser_cardinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector_mask</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">chip_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uart_type</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="n">ports</span><span class="p">[</span><span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mxser_mstatus</span> <span class="p">{</span>
	<span class="n">tcflag_t</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mxser_board</span> <span class="n">mxser_boards</span><span class="p">[</span><span class="n">MXSER_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">mxvar_sdriver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mxser_log</span> <span class="n">mxvar_log</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mxser_set_baud_method</span><span class="p">[</span><span class="n">MXSER_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_enable_must_enchance_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_EFRB_ENABLE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_disable_must_enchance_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_EFRB_ENABLE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_set_must_xon1_value</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_BANK_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_BANK0</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_XON1_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_set_must_xoff1_value</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_BANK_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_BANK0</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_XOFF1_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_set_must_fifo_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_BANK_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_BANK1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_high_water</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_RBRTH_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_trigger</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_RBRTI_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_low_water</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_RBRTL_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_set_must_enum_value</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_BANK_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_BANK2</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_ENUM_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_get_must_hardware_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pId</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_BANK_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_BANK2</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pId</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_HWID_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SET_MOXA_MUST_NO_SOFTWARE_FLOW_CONTROL</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_SF_MASK</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_enable_must_tx_software_flow_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_SF_TX_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_SF_TX1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_disable_must_tx_software_flow_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_SF_TX_MASK</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_enable_must_rx_software_flow_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_SF_RX_MASK</span><span class="p">;</span>
	<span class="n">efr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_EFR_SF_RX1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_disable_must_rx_software_flow_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldlcr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">oldlcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOXA_MUST_ENTER_ENCHANCE</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">efr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_EFR_SF_RX_MASK</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">efr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">MOXA_MUST_EFR_REGISTER</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldlcr</span><span class="p">,</span> <span class="n">baseio</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">CheckIsMoxaMust</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldmcr</span><span class="p">,</span> <span class="n">hwid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">mxser_disable_must_enchance_mode</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="n">oldmcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">mxser_set_must_xon1_value</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hwid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">oldmcr</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">MOXA_OTHER_UART</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mxser_get_must_hardware_id</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_INFO_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 0 = OTHER_UART */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwid</span> <span class="o">==</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hwid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">MOXA_OTHER_UART</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_txrx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16450</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_8250</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_trigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_high_water</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_low_water</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_INFO_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">==</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_trigger</span> <span class="o">=</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_trigger</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_low_water</span> <span class="o">=</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_low_water</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_high_water</span> <span class="o">=</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_high_water</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">mxser_get_msr</span><span class="p">(</span><span class="kt">int</span> <span class="n">baseaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mxser_msr</span><span class="p">[</span><span class="n">MXSER_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">baseaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="n">mxser_msr</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">mxser_msr</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">mxser_msr</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">mxser_msr</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">)</span><span class="o">&amp;~</span><span class="p">(</span><span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">),</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_set_baud</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">long</span> <span class="n">newspd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newspd</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_baud</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newspd</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">/</span> <span class="mi">269</span><span class="p">;</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">134</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newspd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">/</span> <span class="n">newspd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">quot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="o">/</span><span class="n">quot</span><span class="p">;</span>
		<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">quot</span><span class="p">)</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* Add .02 seconds of slop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">cval</span> <span class="o">|</span> <span class="n">UART_LCR_DLAB</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>	<span class="cm">/* set DLAB */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_DLL</span><span class="p">);</span>	<span class="cm">/* LS of divisor */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_DLM</span><span class="p">);</span>	<span class="cm">/* MS of divisor */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cval</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>	<span class="cm">/* reset DLAB */</span>

<span class="cp">#ifdef BOTHER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_BAUD</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">==</span> <span class="n">BOTHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">%</span> <span class="n">newspd</span><span class="p">;</span>
		<span class="n">quot</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">%</span> <span class="n">newspd</span> <span class="o">&gt;</span> <span class="n">newspd</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">quot</span> <span class="o">/=</span> <span class="n">newspd</span><span class="p">;</span>
			<span class="n">quot</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">quot</span> <span class="o">/=</span> <span class="n">newspd</span><span class="p">;</span>

		<span class="n">mxser_set_must_enum_value</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">mxser_set_must_enum_value</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called to set the UART divisor registers to match</span>
<span class="cm"> * the specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">cval</span><span class="p">,</span> <span class="n">fcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mxser_set_baud_method</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mxser_set_baud</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

	<span class="cm">/* byte size and parity */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* too keep GCC shut... */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_SPAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_8250</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16450</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">;</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_FCR_GDA_MODE_ENABLE</span><span class="p">;</span>
			<span class="n">mxser_set_must_fifo_value</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">fcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">MOXA_MUST_FCR_GDA_MODE_ENABLE</span><span class="p">;</span>
			<span class="n">mxser_set_must_fifo_value</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_trigger</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_14</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_AFE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">UART_MCR_AFE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span> <span class="o">&amp;&amp;</span>
							<span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span>
							<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
							<span class="n">UART_IER</span><span class="p">);</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
								<span class="n">UART_IER</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
								<span class="n">UART_IER</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up parity check flag</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">UART_LSR_OE</span> <span class="o">|</span> <span class="n">UART_LSR_THRE</span> <span class="o">|</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignore parity and break indicators, ignore</span>
<span class="cm">		 * overruns too.  (For real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span>
						<span class="n">UART_LSR_OE</span> <span class="o">|</span>
						<span class="n">UART_LSR_PE</span> <span class="o">|</span>
						<span class="n">UART_LSR_FE</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span>
						<span class="n">UART_LSR_OE</span> <span class="o">|</span>
						<span class="n">UART_LSR_PE</span> <span class="o">|</span>
						<span class="n">UART_LSR_FE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mxser_set_must_xon1_value</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">mxser_set_must_xoff1_value</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mxser_enable_must_rx_software_flow_control</span><span class="p">(</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mxser_disable_must_rx_software_flow_control</span><span class="p">(</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mxser_enable_must_tx_software_flow_control</span><span class="p">(</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mxser_disable_must_tx_software_flow_control</span><span class="p">(</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">outb</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>	<span class="cm">/* set fcr */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cval</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_check_modem_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* update input line counters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_TERI</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDSR</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCTS</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">modem_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
							<span class="n">UART_IER</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span> <span class="o">&amp;&amp;</span>
						<span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
							<span class="n">UART_IER</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them</span>
<span class="cm">	 * (they will be reenabled in mxser_change_speed())</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span>
			<span class="n">UART_FCR_CLEAR_XMIT</span> <span class="o">|</span>
			<span class="n">MOXA_MUST_FCR_GDA_MODE_ENABLE</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">),</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point there&#39;s no way the LSR could still be 0xFF;</span>
<span class="cm">	 * if it is, then bail out, because there&#39;s likely no UART</span>
<span class="cm">	 * here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UART_LCR_WLEN8</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>	<span class="cm">/* reset DLAB */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">=</span> <span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">=</span> <span class="n">UART_IER_MSI</span> <span class="o">|</span> <span class="n">UART_IER_RLSI</span> <span class="o">|</span> <span class="n">UART_IER_RDI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">MOXA_MUST_IER_EGDAI</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>	<span class="cm">/* enable interrupts */</span>

	<span class="cm">/*</span>
<span class="cm">	 * And clear the interrupt registers again for luck.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and set the speed of the serial port</span>
<span class="cm">	 */</span>
	<span class="n">mxser_change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_shutdown_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear delta_msr_wait queue to avoid mem leaks: we may free the irq</span>
<span class="cm">	 * here so the queue might never be waken up</span>
<span class="cm">	 */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free the xmit buffer, if necessary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>

	<span class="cm">/* clear Rx/Tx FIFO&#39;s */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span> <span class="o">|</span>
				<span class="n">MOXA_MUST_FCR_GDA_MODE_ENABLE</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="cm">/* read data port to reset things */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
		<span class="n">SET_MOXA_MUST_NO_SOFTWARE_FLOW_CONTROL</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.  It</span>
<span class="cm"> * enables interrupts for a serial port, linking in its async structure into</span>
<span class="cm"> * the IRQ chain.   It also performs the serial-specific</span>
<span class="cm"> * initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="n">MXSER_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">line</span> <span class="o">/</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">line</span> <span class="o">%</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tty_port_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">fcr</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">),</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_close_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point we stop accepting input.  To do this, we</span>
<span class="cm">	 * disable the receive line status interrupts, and tell the</span>
<span class="cm">	 * interrupt driver to stop checking the data ready bit in the</span>
<span class="cm">	 * line status register.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_RLSI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_RECV_ISR</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Before we drop DTR, make sure the UART transmitter</span>
<span class="cm">	 * has completely drained; this is especially</span>
<span class="cm">	 * important if there is a transmit FIFO!</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called when the serial port gets closed.  First, we</span>
<span class="cm"> * wait for the last remaining data to be sent.  Then, we unlink its</span>
<span class="cm"> * async structure from the interrupt chain if necessary, and we free</span>
<span class="cm"> * that IRQ if nothing is left in the chain.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">MXSER_PORTS</span> <span class="o">||</span> <span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mxser_close_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">mxser_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">mxser_shutdown_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* Right now the tty_port set is done outside of the close_end helper</span>
<span class="cm">	   as we don&#39;t yet have everyone using refcounts */</span>	
	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					  <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span>
					<span class="n">UART_IER</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&gt;=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">&amp;=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * friends of mxser_ioctl()</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
		<span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span><span class="p">,</span>
		<span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">,</span>
		<span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hub6</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>
	<span class="n">speed_t</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sl_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_info</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">||</span>
			<span class="n">new_serial</span><span class="p">.</span><span class="n">port</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_USR_MASK</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * OK, past this point, all the error checking has been done.</span>
<span class="cm">		 * At this point, we start making changes.....</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_CUST</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">||</span>
				<span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">!=</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">/</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
			<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>

	<span class="n">process_txrx_fifo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>
			<span class="n">mxser_change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">sl_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mxser_activate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mxser_get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> *	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> *	    release the bus after transmitting. This must be done when</span>
<span class="cm"> *	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> *	    transmit holding register is empty.  This functionality</span>
<span class="cm"> *	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">MXSER_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span>
		<span class="n">mxser_check_modem_status</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">UART_MCR_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">MXSER_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mxser_program_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">!=</span> <span class="n">C168_ASIC_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">C104_ASIC_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">C102_ASIC_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">CI132_ASIC_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">CI134_ASIC_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">CI104J_ASIC_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mxser_normal_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xA5</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 9600 bps */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* 8 data bits */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* loop back mode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x61</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CHIP_SK 	0x01	</span><span class="cm">/* Serial Data Clock  in Eprom */</span><span class="cp"></span>
<span class="cp">#define CHIP_DO 	0x02	</span><span class="cm">/* Serial Data Output in Eprom */</span><span class="cp"></span>
<span class="cp">#define CHIP_CS 	0x04	</span><span class="cm">/* Serial Chip Select in Eprom */</span><span class="cp"></span>
<span class="cp">#define CHIP_DI 	0x08	</span><span class="cm">/* Serial Data Input  in Eprom */</span><span class="cp"></span>
<span class="cp">#define EN_CCMD 	0x000	</span><span class="cm">/* Chip&#39;s command register     */</span><span class="cp"></span>
<span class="cp">#define EN0_RSARLO	0x008	</span><span class="cm">/* Remote start address reg 0  */</span><span class="cp"></span>
<span class="cp">#define EN0_RSARHI	0x009	</span><span class="cm">/* Remote start address reg 1  */</span><span class="cp"></span>
<span class="cp">#define EN0_RCNTLO	0x00A	</span><span class="cm">/* Remote byte count reg WR    */</span><span class="cp"></span>
<span class="cp">#define EN0_RCNTHI	0x00B	</span><span class="cm">/* Remote byte count reg WR    */</span><span class="cp"></span>
<span class="cp">#define EN0_DCFG	0x00E	</span><span class="cm">/* Data configuration reg WR   */</span><span class="cp"></span>
<span class="cp">#define EN0_PORT	0x010	</span><span class="cm">/* Rcv missed frame error counter RD */</span><span class="cp"></span>
<span class="cp">#define ENC_PAGE0	0x000	</span><span class="cm">/* Select page 0 of chip registers   */</span><span class="cp"></span>
<span class="cp">#define ENC_PAGE3	0x0C0	</span><span class="cm">/* Select page 3 of chip registers   */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mxser_read_register</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">mxser_program_mode</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x180</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span> <span class="o">|</span> <span class="n">CHIP_DO</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span> <span class="o">|</span> <span class="n">CHIP_DO</span> <span class="o">|</span> <span class="n">CHIP_SK</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>	<span class="cm">/* A? bit of read */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span> <span class="o">|</span> <span class="n">CHIP_SK</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>	<span class="cm">/* A? bit of read */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">CHIP_CS</span> <span class="o">|</span> <span class="n">CHIP_SK</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CHIP_DI</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">|=</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mxser_normal_mode</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_ioctl_special</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MOXA_GET_MAJOR</span>:
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;mxser: &#39;%s&#39; uses deprecated ioctl &quot;</span>
					<span class="s">&quot;%x (GET_MAJOR), fix your userspace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MOXA_CHKPORTENABLE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">)</span>
					<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MOXA_GETDATACOUNT</span>:
		<span class="cm">/* The receive side is locked by port-&gt;slock but it isn&#39;t</span>
<span class="cm">		   clear that an exact snapshot is worth copying here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mxvar_log</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mxvar_log</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOXA_GETMSTATUS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mxser_mstatus</span> <span class="n">ms</span><span class="p">,</span> <span class="n">__user</span> <span class="o">*</span><span class="n">msu</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">));</span>

				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">copy</span><span class="p">;</span>
				
				<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
					<span class="n">ms</span><span class="p">.</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">normal_termios</span><span class="p">.</span><span class="n">c_cflag</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ms</span><span class="p">.</span><span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
					<span class="n">ms</span><span class="p">.</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span>
					<span class="n">ms</span><span class="p">.</span><span class="n">dsr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
					<span class="n">ms</span><span class="p">.</span><span class="n">cts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="nl">copy:</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">msu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">msu</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MOXA_ASPP_MON_EXT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mxser_mon_ext</span> <span class="o">*</span><span class="n">me</span><span class="p">;</span> <span class="cm">/* it&#39;s 2k, stack unfriendly */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">iflag</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">opmode</span><span class="p">;</span>

		<span class="n">me</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">me</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">me</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">rx_cnt</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">mxser_get_msr</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_TERI</span><span class="p">)</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDSR</span><span class="p">)</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">)</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCTS</span><span class="p">)</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>

				<span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">modem_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">rx_cnt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">rxcnt</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">txcnt</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">up_rxcnt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">up_rxcnt</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">up_txcnt</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">up_txcnt</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">modem_status</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">modem_status</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

				<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cflag</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">normal_termios</span><span class="p">.</span><span class="n">c_cflag</span><span class="p">;</span>
					<span class="n">iflag</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">normal_termios</span><span class="p">.</span><span class="n">c_iflag</span><span class="p">;</span>
					<span class="n">me</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">normal_termios</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
					<span class="n">iflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>
					<span class="n">me</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

				<span class="n">me</span><span class="o">-&gt;</span><span class="n">databits</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">stopbits</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARENB</span> <span class="o">|</span> <span class="n">PARODD</span> <span class="o">|</span>
						<span class="n">CMSPAR</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
					<span class="n">me</span><span class="o">-&gt;</span><span class="n">flowctrl</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXON</span> <span class="o">|</span> <span class="n">IXOFF</span><span class="p">))</span>
					<span class="n">me</span><span class="o">-&gt;</span><span class="n">flowctrl</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x0C</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_16550A</span><span class="p">)</span>
					<span class="n">me</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">opmode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">opmode_ioaddr</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">((</span><span class="n">p</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="n">OP_MODE_MASK</span><span class="p">;</span>
				<span class="n">me</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">opmode</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">me</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_cflags_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">async_icount</span> <span class="o">*</span><span class="n">cprev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>	<span class="cm">/* atomic copy */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>	<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">));</span>

	<span class="o">*</span><span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">MXSER_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mxser_ioctl_special</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MOXA_SET_OP_MODE</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">MOXA_GET_OP_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opmode</span><span class="p">;</span>
		<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ModeMask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="p">};</span>
		<span class="kt">int</span> <span class="n">shiftbit</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MOXA_SET_OP_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">opmode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">argp</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">RS232_MODE</span> <span class="o">&amp;&amp;</span>
					<span class="n">opmode</span> <span class="o">!=</span> <span class="n">RS485_2WIRE_MODE</span> <span class="o">&amp;&amp;</span>
					<span class="n">opmode</span> <span class="o">!=</span> <span class="n">RS422_MODE</span> <span class="o">&amp;&amp;</span>
					<span class="n">opmode</span> <span class="o">!=</span> <span class="n">RS485_4WIRE_MODE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">ModeMask</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
			<span class="n">shiftbit</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">opmode_ioaddr</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">opmode</span> <span class="o">&lt;&lt;</span> <span class="n">shiftbit</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">opmode_ioaddr</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shiftbit</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
			<span class="n">opmode</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">opmode_ioaddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shiftbit</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
			<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="n">OP_MODE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">opmode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span> <span class="o">&amp;&amp;</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mxser_get_serial_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mxser_set_serial_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>:	<span class="cm">/* Get line status register */</span>
		<span class="k">return</span>  <span class="n">mxser_get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait for any of the 4 modem inputs (DCD,RI,DSR,CTS) to change</span>
<span class="cm">		 * - mask passed in arg for lines of interest</span>
<span class="cm">		 *   (use |&#39;ed TIOCM_RNG/DSR/CD/CTS for masking)</span>
<span class="cm">		 * Caller should use TIOCGICOUNT to see which one it was</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>	<span class="cm">/* note the counters on entry */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">,</span>
				<span class="n">mxser_cflags_changed</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnow</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">MOXA_HighSpeedOn</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="mi">115200</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MOXA_SDS_RSTICOUNTER</span>:
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">rxcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">txcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MOXA_ASPP_OQUEUE</span>:<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">mxser_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">lsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MOXA_ASPP_MON</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mcr</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mxser_get_msr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">mxser_check_modem_status</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">mcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MOXA_MUST_MCR_XON_FLAG</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NPPI_NOTIFY_XOFFHOLD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_XOFFHOLD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">MOXA_MUST_MCR_TX_XON</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NPPI_NOTIFY_XOFFXENT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_XOFFXENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_CTSHOLD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">hold_reason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NPPI_NOTIFY_CTSHOLD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_mon</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MOXA_ASPP_LSTATUS</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">err_shadow</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MOXA_SET_BAUD_METHOD</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">method</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">mxser_set_baud_method</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)</span>
<span class="cm">	 * Return: write counters to the user passed counter struct</span>
<span class="cm">	 * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for</span>
<span class="cm">	 *     RI where only 0-&gt;1 is counted.</span>
<span class="cm">	 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_stoprx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MOXA_MUST_RECV_ISR</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by the upper-layer tty layer to signal that</span>
<span class="cm"> * incoming characters should be throttled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mxser_stoprx</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="cm">/* startrx */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">MOXA_MUST_RECV_ISR</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mxser_stop() and mxser_start()</span>
<span class="cm"> *</span>
<span class="cm"> * This routines are called before setting or resetting tty-&gt;stopped.</span>
<span class="cm"> * They enable or disable transmitter interrupts, as necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mxser_change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mxser_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle sw stopped */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mxser_disable_must_rx_software_flow_control</span><span class="p">(</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mxser_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mxser_wait_until_sent() --- wait until the transmitter is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">,</span> <span class="n">char_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Just in case.... */</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the check interval to be 1/5 of the estimated time to</span>
<span class="cm">	 * send a single character, and make it at least 1.  The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: we have to use pretty tight timings here to satisfy</span>
<span class="cm">	 * the NIST-PCTS.</span>
<span class="cm">	 */</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="n">char_time</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">char_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">char_time</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the transmitter hasn&#39;t cleared in twice the approximate</span>
<span class="cm">	 * amount of time to send the entire FIFO, it probably won&#39;t</span>
<span class="cm">	 * ever clear.  This assumes the UART isn&#39;t doing flow</span>
<span class="cm">	 * control, which is currently the case.  Hence, if it ever</span>
<span class="cm">	 * takes longer than info-&gt;timeout, this is probably due to a</span>
<span class="cm">	 * UART bug of some kind.  So, we clamp the timeout parameter at</span>
<span class="cm">	 * 2*info-&gt;timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">lsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">char_time</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">mxser_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mxser_rs_break() --- routine which turns the break handling on or off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mxser_rs_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">UART_LCR_SBC</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">gdl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ignored</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recv_room</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="n">recv_room</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recv_room</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span><span class="p">)</span>
		<span class="n">mxser_stoprx</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">!=</span> <span class="n">MOXA_OTHER_UART</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_SPECIAL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">intr_old</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">==</span> <span class="n">MOXA_MUST_MU860_HWID</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MOXA_MUST_LSR_RERR</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">intr_old</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MOXA_MUST_LSR_RERR</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">intr_old</span><span class="p">;</span>

		<span class="n">gdl</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MOXA_MUST_GDL_REGISTER</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">==</span> <span class="n">MOXA_MUST_MU150_HWID</span><span class="p">)</span>
			<span class="n">gdl</span> <span class="o">&amp;=</span> <span class="n">MOXA_MUST_GDL_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdl</span> <span class="o">&gt;=</span> <span class="n">recv_room</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span><span class="p">)</span>
				<span class="n">mxser_stoprx</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">gdl</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">);</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">end_intr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">intr_old:</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="o">--</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">))</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ignored</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
						<span class="n">do_SAK</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_OVERRUN</span><span class="p">;</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">recv_room</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span><span class="p">)</span>
					<span class="n">mxser_stoprx</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">);</span>

<span class="nl">end_intr:</span>
	<span class="n">mxvar_log</span><span class="p">.</span><span class="n">rxcnt</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">rxcnt</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">up_rxcnt</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are called from an interrupt context with &amp;port-&gt;slock</span>
<span class="cm">	 * being held. Drop it temporarily in order to prevent</span>
<span class="cm">	 * recursive locking.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_TX</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mxvar_log</span><span class="p">.</span><span class="n">txcnt</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">txcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">up_txcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_16550A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="o">++</span><span class="p">],</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_TX</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mxvar_log</span><span class="p">.</span><span class="n">txcnt</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">txcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">.</span><span class="n">up_txcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the serial driver&#39;s generic interrupt routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mxser_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">iir</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="n">irqbits</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_cnt</span><span class="p">,</span> <span class="n">pass_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">brd</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MXSER_BOARDS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">irq_stop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">irq_stop</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pass_counter</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MXSER_ISR_PASS_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irqbits</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">==</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">irqbits</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">==</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">irqbits</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">int_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">iir</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">iir</span> <span class="o">&amp;=</span> <span class="n">MOXA_MUST_IIR_MASK</span><span class="p">;</span>
				<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">||</span>
						<span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
							<span class="n">ASYNC_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
					<span class="n">outb</span><span class="p">(</span><span class="mh">0x27</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
					<span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
					<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_PARITY</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_FRAMING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">|=</span>
						<span class="n">NPPI_NOTIFY_HW_OVERRUN</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">|=</span> <span class="n">NPPI_NOTIFY_BREAK</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">==</span> <span class="n">MOXA_MUST_IIR_GDA</span> <span class="o">||</span>
					    <span class="n">iir</span> <span class="o">==</span> <span class="n">MOXA_MUST_IIR_RDA</span> <span class="o">||</span>
					    <span class="n">iir</span> <span class="o">==</span> <span class="n">MOXA_MUST_IIR_RTO</span> <span class="o">||</span>
					    <span class="n">iir</span> <span class="o">==</span> <span class="n">MOXA_MUST_IIR_LSR</span><span class="p">)</span>
						<span class="n">mxser_receive_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
						<span class="n">mxser_receive_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">msr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span>
					<span class="n">mxser_check_modem_status</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
								<span class="n">UART_LSR_THRE</span><span class="p">))</span>
						<span class="n">mxser_transmit_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">)</span>
						<span class="n">mxser_transmit_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">int_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MXSER_ISR_PASS_LIMIT</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">irq_stop:</span>
	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">mxser_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">mxser_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mxser_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">mxser_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">mxser_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">mxser_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">mxser_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">mxser_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">mxser_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">mxser_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">mxser_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">mxser_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">mxser_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">mxser_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">mxser_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">mxser_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">mxser_rs_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">mxser_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">mxser_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">mxser_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">mxser_get_icount</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">mxser_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">mxser_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">mxser_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">mxser_activate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">mxser_shutdown_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The MOXA Smartio/Industio serial driver boot-time initialization code!</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxser_release_ISA_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">brd</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mxser_initbrd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mxser: max. baud rate = %d bps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">max_baud</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">brd</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">stop_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ldisc_stop_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Enhance mode enabled here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">!=</span> <span class="n">MOXA_OTHER_UART</span><span class="p">)</span>
			<span class="n">mxser_enable_must_enchance_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ASYNC_SHARE_IRQ</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">uart_type</span><span class="p">;</span>

		<span class="n">process_txrx_fifo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">normal_termios</span> <span class="o">=</span> <span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mxser_mon</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">err_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

		<span class="cm">/* before set INT ISR, disable all int */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mxser_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;mxser&quot;</span><span class="p">,</span>
			<span class="n">brd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Board %s: Request irq failed, IRQ (%d) may &quot;</span>
			<span class="s">&quot;conflict with another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mxser_get_ISA_conf</span><span class="p">(</span><span class="kt">int</span> <span class="n">cap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">regs</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">scratch2</span><span class="p">;</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">=</span> <span class="n">MOXA_OTHER_UART</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">mxser_read_register</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">C168_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C104_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CI104J_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">C102_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CI132_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CI134_ASIC_ID</span>:
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* some ISA cards have 2 ports, but we want to see them as 4-port (why?)</span>
<span class="cm">	   Flag-hack checks if configuration should be read as 2-port here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MXSER_HAS2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_irqconflict</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">err_irqconflict</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">err_irqconflict</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: interrupt number unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFF8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: invalid interrupt vector</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">regs</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>	<span class="cm">/* interrupt vector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span> <span class="o">=</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span> <span class="o">=</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_baud</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_baud</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">scratch2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cap</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">UART_LCR_DLAB</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">scratch2</span> <span class="o">|</span> <span class="n">UART_LCR_DLAB</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">UART_EFR</span><span class="p">);</span>	<span class="cm">/* EFR is the same as FCR */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">scratch2</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cap</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scratch</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">uart_type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">uart_type</span> <span class="o">=</span> <span class="n">PORT_16450</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span>
			<span class="s">&quot;mxser(IO)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: can&#39;t request ports I/O region: &quot;</span>
				<span class="s">&quot;0x%.8lx-0x%.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">+</span>
				<span class="mi">8</span> <span class="o">*</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mxser(vector)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: can&#39;t request interrupt vector region: &quot;</span>
				<span class="s">&quot;0x%.8lx-0x%.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">+</span>
				<span class="mi">8</span> <span class="o">*</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span>

<span class="nl">err_irqconflict:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: invalid interrupt number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mxser_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddress</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MXSER_BOARDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;too many boards found (maximum %d), board &quot;</span>
				<span class="s">&quot;not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MXSER_BOARDS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">brd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found MOXA %s board (BusNo=%d, DevNo=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mxser_cards</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* io address */</span>
	<span class="n">ioaddress</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mxser(IO)&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dis</span><span class="p">;</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_cards</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioaddress</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* vector */</span>
	<span class="n">ioaddress</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;mxser(vector)&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_zero</span><span class="p">;</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">ioaddress</span><span class="p">;</span>

	<span class="cm">/* irq */</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">=</span> <span class="n">CheckIsMoxaMust</span><span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">uart_type</span> <span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">UART_INFO_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">chip_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_baud</span> <span class="o">=</span>
					<span class="n">Gpci_uart_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max_baud</span><span class="p">;</span>

				<span class="cm">/* exception....CP-102 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MXSER_HIGHBAUD</span><span class="p">)</span>
					<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_baud</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">chip_flag</span> <span class="o">==</span> <span class="n">MOXA_MUST_MU860_HWID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">opmode_ioaddr</span> <span class="o">=</span> <span class="n">ioaddress</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">opmode_ioaddr</span> <span class="o">=</span> <span class="n">ioaddress</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddress</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* default set to RS232 mode */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddress</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>	<span class="cm">/* default set to RS232 mode */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">vector_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">baud_base</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mxser_initbrd will hook ISR. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mxser_initbrd</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rel3</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tty_register_device</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">brd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_rel3:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nl">err_zero:</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nl">err_dis:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mxser_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">brd</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mxser_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mxser&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">mxser_pcibrds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mxser_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mxser_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mxser_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mxser_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mxvar_sdriver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MXSER_PORTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mxvar_sdriver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MOXA Smartio/Industio family driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">MXSER_VERSION</span><span class="p">);</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyMI&quot;</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ttymajor</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span><span class="o">|</span><span class="n">CS8</span><span class="o">|</span><span class="n">CREAD</span><span class="o">|</span><span class="n">HUPCL</span><span class="o">|</span><span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">mxvar_sdriver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="o">|</span><span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mxser_ops</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t install MOXA Smartio/Industio family &quot;</span>
				<span class="s">&quot;tty driver !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start finding ISA boards here */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">brd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">m</span><span class="p">];</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mxser_get_ISA_conf</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">brd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mxser: found MOXA %s board (CAP=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">[</span><span class="n">b</span><span class="p">]);</span>

		<span class="cm">/* mxser_initbrd will hook ISR. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mxser_initbrd</span><span class="p">(</span><span class="n">brd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">MXSER_PORTS_PER_BOARD</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tty_register_device</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">,</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mxser_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mxser: can&#39;t register pci driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unr</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* else: we have some ISA cards under control */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_unr:</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">);</span>
<span class="nl">err_put:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mxser_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mxser_driver</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* ISA remains */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">,</span>
						<span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">mxvar_sdriver</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MXSER_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mxser_release_ISA_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mxser_boards</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mxser_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mxser_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
