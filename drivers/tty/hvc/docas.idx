f | hvsi_lib.c | s | 9.5K | 351 | Jiri Slaby | jslaby@suse.cz | 1333996098 |  | TTY: HVC, use tty from tty_port  The driver already used refcounting. So we just switch it to tty_port helpers. And switch to tty_port->lock for tty.  Signed-off-by: Jiri Slaby <jslaby@suse.cz> Cc: linuxppc-dev@lists.ozlabs.org Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | Makefile | g | 553B |  | Stephen Rothwell | sfr@canb.auug.org.au | 1331249717 |  | tty: powerpc: remove hvc_iseries  The PowerPC legacy iSeries platform is being removed, so this code is no longer needed.  Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org> Signed-off-by: Stephen Rothwell <sfr@canb.auug.org.au> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | hvc_dcc.c | s | 2.3K | 85 | Stephen Boyd | sboyd@codeaurora.org | 1321387333 |  | tty: hvc_dcc: Fix duplicate character inputs  Reading from the DCC grabs a character from the buffer and clears the status bit. Since this is a context-changing operation, instructions following the character read that rely on the status bit being accurate need to be synchronized with an ISB.  In this case, the status bit check needs to execute after the character read otherwise we run the risk of reading the character and checking the status bit before the read can clear the status bit in the first place. When this happens, the user will see the same character they typed twice, instead of once.  Add an ISB after the read and the write, so that the status check is synchronized with the read/write operations.  Signed-off-by: Stephen Boyd <sboyd@codeaurora.org> Cc: stable <stable@vger.kernel.org> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | hvc_tile.c | s | 1.7K | 58 | Greg Kroah-Hartman | gregkh@suse.de | 1294948980 |  | tty: move hvc drivers to drivers/tty/hvc/  As requested by Arnd Bergmann, the hvc drivers are now moved to the drivers/tty/hvc/ directory.  The virtio_console.c driver was also moved, as it required the hvc_console.h file to be able to be built, and it really is a hvc driver.  Cc: Arnd Bergmann <arnd@arndb.de> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | hvc_vio.c | s | 11K | 408 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1332894804 |  | powerpc+sparc/vio: Modernize driver registration  This makes vio_register_driver() get the module owner & name at compile time like PCI drivers do, and adds a name pointer directly in struct vio_driver to avoid having to explicitly initialize the embedded struct device.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> Acked-by: David S. Miller <davem@davemloft.net>
f | hvsi.c | s | 29K | 1005 | Jiri Slaby | jslaby@suse.cz | 1333996106 |  | TTY: hvsi, use tty from tty_port  Now, we switch to the refcounted model and do not need hp->lock to protect hp->tty anymore.  Signed-off-by: Jiri Slaby <jslaby@suse.cz> Cc: linuxppc-dev@lists.ozlabs.org Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | hvc_udbg.c | s | 2.1K | 80 | Linus Torvalds | torvalds@linux-foundation.org | 1332381310 |  | Merge branch 'next' of git://git.kernel.org/pub/scm/linux/kernel/git/benh/powerpc  Pull powerpc merge from Benjamin Herrenschmidt:  "Here's the powerpc batch for this merge window.  It is going to be a   bit more nasty than usual as in touching things outside of   arch/powerpc mostly due to the big iSeriesectomy :-) We finally got   rid of the bugger (legacy iSeries support) which was a PITA to   maintain and that nobody really used anymore.    Here are some of the highlights:     - Legacy iSeries is gone.  Thanks Stephen ! There's still some bits      and pieces remaining if you do a grep -ir series arch/powerpc but      they are harmless and will be removed in the next few weeks      hopefully.     - The 'fadump' functionality (Firmware Assisted Dump) replaces the      previous (equivalent) "pHyp assisted dump"...  it's a rewrite of a      mechanism to get the hypervisor to do crash dumps on pSeries, the      new implementation hopefully being much more reliable.  Thanks      Mahesh Salgaonkar.     - The "EEH" code (pSeries PCI error handling & recovery) got a big      spring cleaning, motivated by the need to be able to implement a      new backend for it on top of some new different type of firwmare.       The work isn't complete yet, but a good chunk of the cleanups is      there.  Note that this adds a field to struct device_node which is      not very nice and which Grant objects to.  I will have a patch soon      that moves that to a powerpc private data structure (hopefully      before rc1) and we'll improve things further later on (hopefully      getting rid of the need for that pointer completely).  Thanks Gavin      Shan.     - I dug into our exception & interrupt handling code to improve the      way we do lazy interrupt handling (and make it work properly with      "edge" triggered interrupt sources), and while at it found & fixed      a wagon of issues in those areas, including adding support for page      fault retry & fatal signals on page faults.     - Your usual random batch of small fixes & updates, including a bunch      of new embedded boards, both Freescale and APM based ones, etc..."  I fixed up some conflicts with the generalized irq-domain changes from Grant Likely, hopefully correctly.  * 'next' of git://git.kernel.org/pub/scm/linux/kernel/git/benh/powerpc: (141 commits)   powerpc/ps3: Do not adjust the wrapper load address   powerpc: Remove the rest of the legacy iSeries include files   powerpc: Remove the remaining CONFIG_PPC_ISERIES pieces   init: Remove CONFIG_PPC_ISERIES   powerpc: Remove FW_FEATURE ISERIES from arch code   tty/hvc_vio: FW_FEATURE_ISERIES is no longer selectable   powerpc/spufs: Fix double unlocks   powerpc/5200: convert mpc5200 to use of_platform_populate()   powerpc/mpc5200: add options to mpc5200_defconfig   powerpc/mpc52xx: add a4m072 board support   powerpc/mpc5200: update mpc5200_defconfig to fit for charon board   Documentation/powerpc/mpc52xx.txt: Checkpatch cleanup   powerpc/44x: Add additional device support for APM821xx SoC and Bluestone board   powerpc/44x: Add support PCI-E for APM821xx SoC and Bluestone board   MAINTAINERS: Update PowerPC 4xx tree   powerpc/44x: The bug fixed support for APM821xx SoC and Bluestone board   powerpc: document the FSL MPIC message register binding   powerpc: add support for MPIC message register API   powerpc/fsl: Added aliased MSIIR register address to MSI node in dts   powerpc/85xx: mpc8548cds - add 36-bit dts   ...
f | hvc_bfin_jtag.c | s | 2.2K | 87 | Mike Frysinger | vapier@gentoo.org | 1297969960 |  | hvc: add Blackfin JTAG console support  This converts the existing bfin_jtag_comm TTY driver to the HVC layer so that the common HVC code can worry about all of the TTY/polling crap and leave the Blackfin code to worry about the Blackfin bits.  Signed-off-by: Mike Frysinger <vapier@gentoo.org> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | hvc_console.h | s | 3.7K | 104 | Jiri Slaby | jslaby@suse.cz | 1333996098 |  | TTY: HVC, use count from tty_port  Now, count is used from tty_port and protected by tty_port->lock.  n_outbuf is left unprotected in hvc_hangup now, because there is no point to hold any lock, since other uses are unprotected too.  Signed-off-by: Jiri Slaby <jslaby@suse.cz> Cc: linuxppc-dev@lists.ozlabs.org Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | hvc_irq.c | s | 893B | 42 | Yong Zhang | yong.zhang0@gmail.com | 1316732937 |  | TTY: irq: Remove IRQF_DISABLED  Since commit [e58aa3d2: genirq: Run irq handlers with interrupts disabled], We run all interrupt handlers with interrupts disabled and we even check and yell when an interrupt handler returns with interrupts enabled (see commit [b738a50a: genirq: Warn when handler enables interrupts]).  So now this flag is a NOOP and can be removed.  Signed-off-by: Yong Zhang <yong.zhang0@gmail.com> Acked-by: Tobias Klauser <tklauser@distanz.ch> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | hvc_iucv.c | s | 37K | 1161 | Lucas De Marchi | lucas.demarchi@profusion.mobi | 1301581583 |  | Fix common misspellings  Fixes generated by 'codespell' and manually reviewed.  Signed-off-by: Lucas De Marchi <lucas.demarchi@profusion.mobi>
f | hvc_beat.c | s | 3.1K | 114 | Alan Cox | alan@linux.intel.com | 1327626890 |  | serial: Kill off NO_IRQ  We transform the offenders into a test of irq <= 0 which will be ok while the ARM people get their platform sorted. Once that is done (or in a while if they don't do it anyway) then we will change them all to !irq checks.  For arch specific drivers that are already using NO_IRQ = 0 we just test against zero so we don't need to re-review them later.  Signed-off-by: Alan Cox <alan@linux.intel.com> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
f | hvc_xen.c | s | 14K | 549 | Konrad Rzeszutek Wilk | konrad.wilk@oracle.com | 1337883781 |  | xen/hvc: Check HVM_PARAM_CONSOLE_[EVTCHN||PFN] for correctness.  We need to make sure that those parameters are setup to be correct. As such the value of 0 is deemed invalid and we find that we bail out. The hypervisor sets by default all of them to be zero and when the hypercall is done does a simple:   a.value = d->arch.hvm_domain.params[a.index];  Which means that if the Xen toolstack forgot to setup the proper HVM_PARAM_CONSOLE_EVTCHN (or the PFN one), we would get the default value of 0 and use that.  CC: stable@kernel.org Fixes-Oracle-Bug: 14091238 Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
f | hvc_console.c | s | 23K | 816 | Jiri Slaby | jslaby@suse.cz | 1334339683 |  | TTY: hvc, fix TTY refcounting  A -next commit "TTY: HVC, use tty from tty_port" switched the driver to use tty_port helper for tty refcounting. But it omitted to remove manual tty refcounting from open, close and hangup. So now we are getting random crashes caused by use-after-free: Unable to handle kernel paging request for data at address 0xc0000003f9d550 Faulting instruction address: 0xc0000000001b7f40 Oops: Kernel access of bad area, sig: 11 [#1] ... NIP: c0000000001b7f40 LR: c0000000001b7f14 CTR: c0000000000e04f0 ... NIP [c0000000001b7f40] .__kmalloc+0x70/0x230 LR [c0000000001b7f14] .__kmalloc+0x44/0x230 Call Trace: [c0000003f68bf930] [c0000003f68bf9b0] 0xc0000003f68bf9b0 (unreliable) [c0000003f68bf9e0] [c0000000001e5424] .alloc_fdmem+0x24/0x70 [c0000003f68bfa60] [c0000000001e54f8] .alloc_fdtable+0x88/0x130 [c0000003f68bfaf0] [c0000000001e5924] .dup_fd+0x384/0x450 [c0000003f68bfbd0] [c00000000009a310] .copy_process+0x880/0x11d0 [c0000003f68bfcd0] [c00000000009aee0] .do_fork+0x70/0x400 [c0000003f68bfdc0] [c0000000000141c4] .sys_clone+0x54/0x70 [c0000003f68bfe30] [c000000000009aa0] .ppc_clone+0x8/0xc  Fix that by complete removal of tty_kref_get/put in open/close/hangup paths.  Signed-off-by: Jiri Slaby <jslaby@suse.cz> Reported-and-tested-by: Michael Neuling <mikey@neuling.org> Cc: Stephen Rothwell <sfr@canb.auug.org.au> Cc: ppc-dev <linuxppc-dev@lists.ozlabs.org> Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | Kconfig | g | 3.3K |  | Linus Torvalds | torvalds@linux-foundation.org | 1332472574 |  | 
f | hvc_opal.c | s | 10K | 363 | Michael Neuling | mikey@neuling.org | 1320646878 |  | powerpc: fix building hvc_opal.c  Fix building following build error:    drivers/tty/hvc/hvc_opal.c:244:12: error: 'THIS_MODULE' undeclared here (not in a function)  Signed-off-by: Michael Neuling <mikey@neuling.org> [ New file from powerpc tree not following the new rules from the   module.h split, both of which were merged today.  - Linus ] Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
f | hvcs.c | s | 45K | 1351 | Jiri Slaby | jslaby@suse.cz | 1333996101 |  | TTY: hvcs, use tty from tty_port  No refcounting, just a switch. The locking in the driver prevents races, so in fact the refcounting is not needed. But while we have a tty in tty_port, don't duplicate that and remove the one from hvcs_struct.  Signed-off-by: Jiri Slaby <jslaby@suse.cz> Cc: linuxppc-dev@lists.ozlabs.org Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
f | hvc_rtas.c | s | 3.6K | 109 | Alan Cox | alan@linux.intel.com | 1327626890 |  | serial: Kill off NO_IRQ  We transform the offenders into a test of irq <= 0 which will be ok while the ARM people get their platform sorted. Once that is done (or in a while if they don't do it anyway) then we will change them all to !irq checks.  For arch specific drivers that are already using NO_IRQ = 0 we just test against zero so we don't need to re-review them later.  Signed-off-by: Alan Cox <alan@linux.intel.com> Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
