<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › hvc › hvsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hvsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2004 Hollis Blanchard &lt;hollisb@us.ibm.com&gt;, IBM</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cm">/* Host Virtual Serial Interface (HVSI) is a protocol between the hosted OS</span>
<span class="cm"> * and the service processor on IBM pSeries servers. On these servers, there</span>
<span class="cm"> * are no serial ports under the OS&#39;s control, and sometimes there is no other</span>
<span class="cm"> * console available either. However, the service processor has two standard</span>
<span class="cm"> * serial ports, so this over-complicated protocol allows the OS to control</span>
<span class="cm"> * those ports by proxy.</span>
<span class="cm"> *</span>
<span class="cm"> * Besides data, the procotol supports the reading/writing of the serial</span>
<span class="cm"> * port&#39;s DTR line, and the reading of the CD line. This is to allow the OS to</span>
<span class="cm"> * control a modem attached to the service processor&#39;s serial port. Note that</span>
<span class="cm"> * the OS cannot change the speed of the port through this protocol.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;asm/hvcall.h&gt;</span>
<span class="cp">#include &lt;asm/hvconsole.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/vio.h&gt;</span>
<span class="cp">#include &lt;asm/param.h&gt;</span>
<span class="cp">#include &lt;asm/hvsi.h&gt;</span>

<span class="cp">#define HVSI_MAJOR	229</span>
<span class="cp">#define HVSI_MINOR	128</span>
<span class="cp">#define MAX_NR_HVSI_CONSOLES 4</span>

<span class="cp">#define HVSI_TIMEOUT (5*HZ)</span>
<span class="cp">#define HVSI_VERSION 1</span>
<span class="cp">#define HVSI_MAX_PACKET 256</span>
<span class="cp">#define HVSI_MAX_READ 16</span>
<span class="cp">#define HVSI_MAX_OUTGOING_DATA 12</span>
<span class="cp">#define N_OUTBUF 12</span>

<span class="cm">/*</span>
<span class="cm"> * we pass data via two 8-byte registers, so we would like our char arrays</span>
<span class="cm"> * properly aligned for those loads.</span>
<span class="cm"> */</span>
<span class="cp">#define __ALIGNED__	__attribute__((__aligned__(sizeof(long))))</span>

<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">writer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">handshaker</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">emptyq</span><span class="p">;</span> <span class="cm">/* woken when outbuf is emptied */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">stateq</span><span class="p">;</span> <span class="cm">/* woken when HVSI state changes */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">throttle_buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">outbuf</span><span class="p">[</span><span class="n">N_OUTBUF</span><span class="p">];</span> <span class="cm">/* to implement write_room and chars_in_buffer */</span>
	<span class="cm">/* inbuf is for packet reassembly. leave a little room for leftovers. */</span>
	<span class="kt">uint8_t</span> <span class="n">inbuf</span><span class="p">[</span><span class="n">HVSI_MAX_PACKET</span> <span class="o">+</span> <span class="n">HVSI_MAX_READ</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">inbuf_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_throttle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_outbuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">vtermno</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">virq</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">seqno</span><span class="p">;</span> <span class="cm">/* HVSI packet sequence number */</span>
	<span class="kt">uint16_t</span> <span class="n">mctrl</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">state</span><span class="p">;</span>  <span class="cm">/* HVSI protocol state */</span>
	<span class="kt">uint8_t</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
	<span class="kt">uint8_t</span> <span class="n">sysrq</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAGIC_SYSRQ */</span><span class="cp"></span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="n">hvsi_ports</span><span class="p">[</span><span class="n">MAX_NR_HVSI_CONSOLES</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">hvsi_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hvsi_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">hvsi_wait</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">HVSI_PROTOCOL_STATE</span> <span class="p">{</span>
	<span class="n">HVSI_CLOSED</span><span class="p">,</span>
	<span class="n">HVSI_WAIT_FOR_VER_RESPONSE</span><span class="p">,</span>
	<span class="n">HVSI_WAIT_FOR_VER_QUERY</span><span class="p">,</span>
	<span class="n">HVSI_OPEN</span><span class="p">,</span>
	<span class="n">HVSI_WAIT_FOR_MCTRL_RESPONSE</span><span class="p">,</span>
	<span class="n">HVSI_FSP_DIED</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define HVSI_CONSOLE 0x1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HVSI_CONSOLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if we&#39;re waiting for an mctrl then we&#39;re already open */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HVSI_OPEN</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HVSI_WAIT_FOR_MCTRL_RESPONSE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;HVSI_CLOSED&quot;</span><span class="p">,</span>
		<span class="s">&quot;HVSI_WAIT_FOR_VER_RESPONSE&quot;</span><span class="p">,</span>
		<span class="s">&quot;HVSI_WAIT_FOR_VER_QUERY&quot;</span><span class="p">,</span>
		<span class="s">&quot;HVSI_OPEN&quot;</span><span class="p">,</span>
		<span class="s">&quot;HVSI_WAIT_FOR_MCTRL_RESPONSE&quot;</span><span class="p">,</span>
		<span class="s">&quot;HVSI_FSP_DIED&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">state_names</span><span class="p">))</span>
		<span class="o">?</span> <span class="n">state_names</span><span class="p">[</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hvsi%i: state = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">print_state</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">stateq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">len_packet</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_header</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">VS_QUERY_RESPONSE_PACKET_HEADER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">got_packet</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">&lt;</span> <span class="n">packet</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* don&#39;t even have the packet header */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">packet</span> <span class="o">+</span> <span class="n">len_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* don&#39;t have the rest of the packet */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* shift remaining bytes in packetbuf down */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">compact_inbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">read_to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">-</span> <span class="n">read_to</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %i chars remain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_to</span> <span class="o">!=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">,</span> <span class="n">read_to</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span> <span class="o">+</span> <span class="n">remaining</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define dbg_dump_packet(packet) dump_packet(packet)</span>
<span class="cp">#define dbg_dump_hex(data, len) dump_hex(data, len)</span>
<span class="cp">#else</span>
<span class="cp">#define dbg_dump_packet(packet) do { } while (0)</span>
<span class="cp">#define dbg_dump_hex(data, len) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_hex</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%.2x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isprint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_packet</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;type 0x%x, len %i, seqno %i:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>

	<span class="n">dump_hex</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">got</span><span class="p">;</span>

	<span class="n">got</span> <span class="o">=</span> <span class="n">hvc_get_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_recv_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">**</span><span class="n">to_handshake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_control</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_control</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">verb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VSV_MODEM_CTL_UPDATE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">HVSI_TSCD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CD went away; no more connection */</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hvsi%i: CD dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">&amp;=</span> <span class="n">TIOCM_CD</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">C_CLOCAL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
					<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSV_CLOSE_PROTOCOL</span>:
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hvsi%i: service processor came back</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">HVSI_CLOSED</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">to_handshake</span> <span class="o">=</span> <span class="n">hp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hvsi%i: unknown HVSI control packet: &quot;</span><span class="p">,</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">dump_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_recv_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_query_response</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_query_response</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HVSI_WAIT_FOR_VER_RESPONSE</span>:
			<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_WAIT_FOR_VER_QUERY</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HVSI_WAIT_FOR_MCTRL_RESPONSE</span>:
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mctrl_word</span> <span class="o">&amp;</span> <span class="n">HVSI_TSDTR</span><span class="p">)</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mctrl_word</span> <span class="o">&amp;</span> <span class="n">HVSI_TSCD</span><span class="p">)</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">|=</span> <span class="n">TIOCM_CD</span><span class="p">;</span>
			<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_OPEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: unexpected query response: &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">dump_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* respond to service processor&#39;s version query */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_version_respond</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">query_seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_query_response</span> <span class="n">packet</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrote</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VS_QUERY_RESPONSE_PACKET_HEADER</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_query_response</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">verb</span> <span class="o">=</span> <span class="n">VSV_SEND_VERSION_NUMBER</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">HVSI_VERSION</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">query_seqno</span> <span class="o">=</span> <span class="n">query_seqno</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: sending %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dbg_dump_hex</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">wrote</span> <span class="o">=</span> <span class="n">hvc_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrote</span> <span class="o">!=</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: couldn&#39;t send query response!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_recv_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_query</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_query</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HVSI_WAIT_FOR_VER_QUERY</span>:
			<span class="n">hvsi_version_respond</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">query</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>
			<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_OPEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: unexpected query: &quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">dump_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_insert_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sysrq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">sysrq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handle_sysrq</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">sysrq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAGIC_SYSRQ */</span><span class="cp"></span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We could get 252 bytes of data at once here. But the tty layer only</span>
<span class="cm"> * throttles us at TTY_THRESHOLD_THROTTLE (128) bytes, so we could overflow</span>
<span class="cm"> * it. Accordingly we won&#39;t send more than 128 bytes at a time to the flip</span>
<span class="cm"> * buffer, which will give the tty buffer a chance to throttle us. Should the</span>
<span class="cm"> * value of TTY_THRESHOLD_THROTTLE change in n_tty.c, this code should be</span>
<span class="cm"> * revisited.</span>
<span class="cm"> */</span>
<span class="cp">#define TTY_THRESHOLD_THROTTLE 128</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">hvsi_recv_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">packet</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">datalen</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">overflow</span> <span class="o">=</span> <span class="n">datalen</span> <span class="o">-</span> <span class="n">TTY_THRESHOLD_THROTTLE</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;queueing %i chars &#39;%.*s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: got &gt;TTY_THRESHOLD_THROTTLE bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">TTY_THRESHOLD_THROTTLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hvsi_insert_chars</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we still have more data to deliver, so we need to save off the</span>
<span class="cm">		 * overflow and send it later</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: deferring overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">throttle_buf</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">TTY_THRESHOLD_THROTTLE</span><span class="p">,</span> <span class="n">overflow</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span> <span class="o">=</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true/false indicating data successfully read from hypervisor.</span>
<span class="cm"> * Used both to get packets for tty connections and to advance the state</span>
<span class="cm"> * machine during console handshaking (in which case tty = NULL and we ignore</span>
<span class="cm"> * incoming data).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_load_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">**</span><span class="n">handshake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chunklen</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">handshake</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chunklen</span> <span class="o">=</span> <span class="n">hvsi_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span><span class="p">,</span> <span class="n">HVSI_MAX_READ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chunklen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 0-length read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: got %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chunklen</span><span class="p">);</span>
	<span class="n">dbg_dump_hex</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span><span class="p">,</span> <span class="n">chunklen</span><span class="p">);</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">+=</span> <span class="n">chunklen</span><span class="p">;</span>

	<span class="cm">/* handle all completed packets */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">packet</span> <span class="o">&lt;</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">got_packet</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">packet</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_header</span><span class="p">(</span><span class="n">packet</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: got malformed packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="cm">/* skip bytes until we find a header or run out of data */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">packet</span> <span class="o">&lt;</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">is_header</span><span class="p">(</span><span class="n">packet</span><span class="p">)))</span>
				<span class="n">packet</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: handling %i-byte packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">len_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">));</span>
		<span class="n">dbg_dump_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">VS_DATA_PACKET_HEADER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_open</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span> <span class="cm">/* no tty buffer to put data in */</span>
				<span class="n">flip</span> <span class="o">=</span> <span class="n">hvsi_recv_data</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">VS_CONTROL_PACKET_HEADER</span>:
				<span class="n">hvsi_recv_control</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">handshake</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">VS_QUERY_RESPONSE_PACKET_HEADER</span>:
				<span class="n">hvsi_recv_response</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">VS_QUERY_PACKET_HEADER</span>:
				<span class="n">hvsi_recv_query</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: unknown HVSI packet type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
				<span class="n">dump_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">packet</span> <span class="o">+=</span> <span class="n">len_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">handshake</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: handshake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">compact_inbuf</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flip</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_send_overflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: delivering %i bytes overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span><span class="p">);</span>

	<span class="n">hvsi_insert_chars</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">throttle_buf</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * must get all pending data because we only get an irq on empty-&gt;non-empty</span>
<span class="cm"> * transition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hvsi_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">handshake</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">again</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">again</span> <span class="o">=</span> <span class="n">hvsi_load_chunk</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handshake</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">handshake</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hvsi%i: attempting re-handshake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handshake</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handshake</span><span class="o">-&gt;</span><span class="n">handshaker</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we weren&#39;t hung up and we weren&#39;t throttled, so we can</span>
<span class="cm">		 * deliver the rest now */</span>
		<span class="n">hvsi_send_overflow</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* for boot console, before the irq handler is running */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">poll_for_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HVSI_TIMEOUT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">hvsi_interrupt</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hp</span><span class="p">);</span> <span class="cm">/* get pending data */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_jiffies</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* wait for irq handler to change our state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">stateq</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">),</span> <span class="n">HVSI_TIMEOUT</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">verb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_query</span> <span class="n">packet</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrote</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VS_QUERY_PACKET_HEADER</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_query</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">verb</span> <span class="o">=</span> <span class="n">verb</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: sending %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dbg_dump_hex</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">wrote</span> <span class="o">=</span> <span class="n">hvc_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrote</span> <span class="o">!=</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: couldn&#39;t send query (%i)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="n">wrote</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_WAIT_FOR_MCTRL_RESPONSE</span><span class="p">);</span>
	<span class="n">hvsi_query</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">VSV_SEND_MODEM_CTL_STATUS</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_wait</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_OPEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: didn&#39;t get modem flags</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_OPEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: mctrl 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* note that we can only set DTR */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_control</span> <span class="n">packet</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wrote</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VS_CONTROL_PACKET_HEADER</span><span class="p">,</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_control</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">verb</span> <span class="o">=</span> <span class="n">VSV_SET_MODEM_CTL</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">HVSI_TSDTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">packet</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">HVSI_TSDTR</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: sending %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dbg_dump_hex</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">wrote</span> <span class="o">=</span> <span class="n">hvc_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrote</span> <span class="o">!=</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: couldn&#39;t set DTR!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_drain_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="n">HVSI_MAX_READ</span><span class="p">]</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HVSI_TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">end_jiffies</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">hvsi_read</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">HVSI_MAX_READ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_handshake</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could have a CLOSE or other data waiting for us before we even try</span>
<span class="cm">	 * to open; try to throw it all away so we don&#39;t get confused. (CLOSE</span>
<span class="cm">	 * is the first message sent up the pipe when the FSP comes online. We</span>
<span class="cm">	 * need to distinguish between &quot;it came up a while ago and we&#39;re the first</span>
<span class="cm">	 * user&quot; and &quot;it was just reset before it saw our handshake packet&quot;.)</span>
<span class="cm">	 */</span>
	<span class="n">hvsi_drain_input</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="n">set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_WAIT_FOR_VER_RESPONSE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_query</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">VSV_SEND_VERSION_NUMBER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: couldn&#39;t send version query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_wait</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_OPEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_handshaker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hvsi_struct</span><span class="p">,</span> <span class="n">handshaker</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hvsi_handshake</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: re-handshaking failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_console</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ttys will re-attempt the handshake via hvsi_open, but</span>
<span class="cm">		 * the console will not.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: lost console!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_put_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_data</span> <span class="n">packet</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">HVSI_MAX_OUTGOING_DATA</span><span class="p">);</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VS_DATA_PACKET_HEADER</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_header</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvc_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return the number of chars written, not the packet length */</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span> <span class="cm">/* return any errors */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_close_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_control</span> <span class="n">packet</span> <span class="n">__ALIGNED__</span><span class="p">;</span>

	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">VS_CONTROL_PACKET_HEADER</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">packet</span><span class="p">.</span><span class="n">verb</span> <span class="o">=</span> <span class="n">VSV_CLOSE_PROTOCOL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: sending %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dbg_dump_hex</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">hvc_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hvsi_ports</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">hp</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HVSI_FSP_DIED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">h_vio_signal</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="n">VIO_IRQ_ENABLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_console</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* this has already been handshaked as the console */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_handshake</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: HVSI handshaking failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_get_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: couldn&#39;t get initial modem flags</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_set_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: couldn&#39;t set DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* wait for hvsi_write_worker to empty hp-&gt;outbuf */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_flush_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">emptyq</span><span class="p">,</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">HVSI_TIMEOUT</span><span class="p">);</span>

	<span class="cm">/* &#39;writer&#39; could still be pending if it didn&#39;t see n_outbuf = 0 yet */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">handshaker</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * it&#39;s also possible that our timeout expired and hvsi_write_worker</span>
<span class="cm">	 * didn&#39;t manage to push outbuf. poof.</span>
<span class="cm">	 */</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span> <span class="cm">/* discard remaining partial packets */</span>

		<span class="cm">/* only close down connection if it is not the console */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_console</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">h_vio_signal</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="n">VIO_IRQ_DISABLE</span><span class="p">);</span> <span class="cm">/* no more irqs */</span>
			<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_CLOSED</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * any data delivered to the tty layer after this will be</span>
<span class="cm">			 * discarded (except for XON/XOFF)</span>
<span class="cm">			 */</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* let any existing irq handlers finish. no more will start. */</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span><span class="p">);</span>

			<span class="cm">/* hvsi_write_worker will re-schedule until outbuf is empty. */</span>
			<span class="n">hvsi_flush_output</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

			<span class="cm">/* tell FSP to stop sending data */</span>
			<span class="n">hvsi_close_protocol</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * drain anything FSP is still in the middle of sending, and let</span>
<span class="cm">			 * hvsi_handshake drain the rest on the next open.</span>
<span class="cm">			 */</span>
			<span class="n">hvsi_drain_input</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi_close %lu: oops, count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hp</span> <span class="o">-</span> <span class="n">hvsi_ports</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called with hp-&gt;lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">hvsi_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* success */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: wrote %i chars</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_state</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">HVSI_FSP_DIED</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hvsi%i: service processor died</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* hvsi_write_worker will keep rescheduling itself until outbuf is empty */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_write_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hvsi_struct</span><span class="p">,</span> <span class="n">writer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">static</span> <span class="kt">long</span> <span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">start_j</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %i chars in buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_open</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We could have a non-open connection if the service processor died</span>
<span class="cm">		 * while we were busily scheduling ourselves. In that case, it could</span>
<span class="cm">		 * be minutes before the service processor comes back, so only try</span>
<span class="cm">		 * again once a second.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hvsi_push</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: outbuf emptied after %li jiffies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_j</span><span class="p">);</span>
		<span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">emptyq</span><span class="p">);</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">N_OUTBUF</span> <span class="o">-</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">origcount</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %i chars in buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_open</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we&#39;re either closing or not yet open; don&#39;t accept data */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: not open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * when the hypervisor buffer (16K) fills, data will stay in hp-&gt;outbuf</span>
<span class="cm">	 * and hvsi_write_worker will be scheduled. subsequent hvsi_write() calls</span>
<span class="cm">	 * will see there is no room in outbuf and return.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hvsi_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hvsi_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">outbuf</span> <span class="o">+</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">+=</span> <span class="n">chunksize</span><span class="p">;</span>

		<span class="n">total</span> <span class="o">+=</span> <span class="n">chunksize</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">+=</span> <span class="n">chunksize</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">chunksize</span><span class="p">;</span>
		<span class="n">hvsi_push</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_outbuf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we weren&#39;t able to write it all to the hypervisor.</span>
<span class="cm">		 * schedule another push attempt.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">!=</span> <span class="n">origcount</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: wanted %i, only wrote %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">origcount</span><span class="p">,</span>
			<span class="n">total</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I have never seen throttle or unthrottle called, so this little throttle</span>
<span class="cm"> * buffering scheme may or may not work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">h_vio_signal</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="n">VIO_IRQ_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">n_throttle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hvsi_send_overflow</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>


	<span class="n">h_vio_signal</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span><span class="p">,</span> <span class="n">VIO_IRQ_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">hvsi_get_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hvsi_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">new_mctrl</span><span class="p">;</span>

	<span class="cm">/* we can only alter DTR */</span>
	<span class="n">clear</span> <span class="o">&amp;=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">&amp;=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">new_mctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clear</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">!=</span> <span class="n">new_mctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hvsi_set_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">new_mctrl</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="n">new_mctrl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">hvsi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">hvsi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">hvsi_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">hvsi_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">hvsi_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">hvsi_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">hvsi_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">hvsi_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">hvsi_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">hvsi_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">hvsi_tiocmset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hvsi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hvsi_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">hvsi_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hvsi_driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;hvsi&quot;</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hvsi&quot;</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">HVSI_MAJOR</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="n">HVSI_MINOR</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SYSTEM</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">hvsi_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">hvsi_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvsi_ops</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hvsi_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hvsi_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span><span class="p">,</span> <span class="n">hvsi_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hvsi&quot;</span><span class="p">,</span> <span class="n">hp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HVSI: couldn&#39;t reserve irq 0x%x (error %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hvsi_wait</span> <span class="o">=</span> <span class="n">wait_for_state</span><span class="p">;</span> <span class="cm">/* irqs active now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">hvsi_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register hvsi console driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HVSI: registered %i devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hvsi_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">hvsi_init</span><span class="p">);</span>

<span class="cm">/***** console (not tty) code: *****/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hvsi_console_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">console</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hvsi_ports</span><span class="p">[</span><span class="n">console</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="n">HVSI_MAX_OUTGOING_DATA</span><span class="p">]</span> <span class="n">__ALIGNED__</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">donecr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_open</span><span class="p">(</span><span class="n">hp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ugh, we have to translate LF -&gt; CRLF ourselves, in place.</span>
<span class="cm">	 * copied from hvc_console.c:</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">donecr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
				<span class="n">donecr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">];</span>
				<span class="n">donecr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">--</span><span class="n">count</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_put_chars</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="nf">hvsi_console_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">console</span><span class="p">,</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">console</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hvsi_driver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hvsi_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">console</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">console</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">console</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">hvsi_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hvsi_ports</span><span class="p">[</span><span class="n">console</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* give the FSP a chance to change the baud rate when we re-open */</span>
	<span class="n">hvsi_close_protocol</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_handshake</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_get_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hvsi_set_mctrl</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HVSI_CONSOLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">hvsi_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hvsi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">hvsi_console_print</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">hvsi_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">hvsi_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hvsi_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">vty</span><span class="p">;</span>

	<span class="n">hvsi_wait</span> <span class="o">=</span> <span class="n">poll_for_state</span><span class="p">;</span> <span class="cm">/* no irqs yet; must poll */</span>

	<span class="cm">/* search device tree for vty nodes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vty</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span> <span class="s">&quot;hvterm-protocol&quot;</span><span class="p">);</span>
			<span class="n">vty</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">vty</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span> <span class="s">&quot;hvterm-protocol&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hvsi_struct</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">vtermno</span><span class="p">,</span> <span class="o">*</span><span class="n">irq</span><span class="p">;</span>

		<span class="n">vtermno</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtermno</span> <span class="o">||</span> <span class="o">!</span><span class="n">irq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hvsi_count</span> <span class="o">&gt;=</span> <span class="n">MAX_NR_HVSI_CONSOLES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">vty</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hvsi_ports</span><span class="p">[</span><span class="n">hvsi_count</span><span class="p">];</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">,</span> <span class="n">hvsi_write_worker</span><span class="p">);</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">handshaker</span><span class="p">,</span> <span class="n">hvsi_handshaker</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">emptyq</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">stateq</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hvsi_count</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf_end</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HVSI_CLOSED</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">vtermno</span> <span class="o">=</span> <span class="o">*</span><span class="n">vtermno</span><span class="p">;</span>
		<span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span> <span class="o">=</span> <span class="n">irq_create_mapping</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">virq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: couldn&#39;t create irq mapping for 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hvsi_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hvsi_count</span><span class="p">)</span>
		<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvsi_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">hvsi_console_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
