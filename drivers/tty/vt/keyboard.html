<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › vt › keyboard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>keyboard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Written for linux by Johan Myreen as a translation from</span>
<span class="cm"> * the assembly version by Linus (with diacriticals added)</span>
<span class="cm"> *</span>
<span class="cm"> * Some additional features added by Christoph Niemann (ChN), March 1993</span>
<span class="cm"> *</span>
<span class="cm"> * Loadable keymaps by Risto Kankkunen, May 1993</span>
<span class="cm"> *</span>
<span class="cm"> * Diacriticals redone &amp; other small changes, aeb@cwi.nl, June 1993</span>
<span class="cm"> * Added decr/incr_console, dynamic keymaps, Unicode support,</span>
<span class="cm"> * dynamic function/string keys, led setting,  Sept 1994</span>
<span class="cm"> * `Sticky&#39; modifier keys, 951006.</span>
<span class="cm"> *</span>
<span class="cm"> * 11-11-96: SAK should now work in the raw mode (Martin Mares)</span>
<span class="cm"> *</span>
<span class="cm"> * Modified to provide &#39;generic&#39; keyboard support by Hamish Macdonald</span>
<span class="cm"> * Merge with the m68k keyboard driver and split-off of the PC low-level</span>
<span class="cm"> * parts by Geert Uytterhoeven, May 1997</span>
<span class="cm"> *</span>
<span class="cm"> * 27-05-97: Added support for the Magic SysRq Key (Martin Mares)</span>
<span class="cm"> * 30-07-98: Dead keys redone, aeb@cwi.nl.</span>
<span class="cm"> * 21-08-02: Converted to input API, major cleanup. (Vojtech Pavlik)</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/consolemap.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/kbd_kern.h&gt;</span>
<span class="cp">#include &lt;linux/kbd_diacr.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">ctrl_alt_del</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Exported functions/variables</span>
<span class="cm"> */</span>

<span class="cp">#define KBD_DEFMODE ((1 &lt;&lt; VC_REPEAT) | (1 &lt;&lt; VC_META))</span>

<span class="cp">#if defined(CONFIG_X86) || defined(CONFIG_PARISC)</span>
<span class="cp">#include &lt;asm/kbdleds.h&gt;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kbd_defleds</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define KBD_DEFLOCK 0</span>

<span class="cm">/*</span>
<span class="cm"> * Handler Tables.</span>
<span class="cm"> */</span>

<span class="cp">#define K_HANDLERS\</span>
<span class="cp">	k_self,		k_fn,		k_spec,		k_pad,\</span>
<span class="cp">	k_dead,		k_cons,		k_cur,		k_shift,\</span>
<span class="cp">	k_meta,		k_ascii,	k_lock,		k_lowercase,\</span>
<span class="cp">	k_slock,	k_dead2,	k_brl,		k_ignore</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">k_handler_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="n">up_flag</span><span class="p">);</span>
<span class="k">static</span> <span class="n">k_handler_fn</span> <span class="n">K_HANDLERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">k_handler_fn</span> <span class="o">*</span><span class="n">k_handler</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">K_HANDLERS</span> <span class="p">};</span>

<span class="cp">#define FN_HANDLERS\</span>
<span class="cp">	fn_null,	fn_enter,	fn_show_ptregs,	fn_show_mem,\</span>
<span class="cp">	fn_show_state,	fn_send_intr,	fn_lastcons,	fn_caps_toggle,\</span>
<span class="cp">	fn_num,		fn_hold,	fn_scroll_forw,	fn_scroll_back,\</span>
<span class="cp">	fn_boot_it,	fn_caps_on,	fn_compose,	fn_SAK,\</span>
<span class="cp">	fn_dec_console, fn_inc_console, fn_spawn_con,	fn_bare_num</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">fn_handler_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">fn_handler_fn</span> <span class="n">FN_HANDLERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">fn_handler_fn</span> <span class="o">*</span><span class="n">fn_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FN_HANDLERS</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Variables exported for vt_ioctl.c</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">vt_spawn_console</span> <span class="n">vt_spawn_con</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">pid</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sig</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Internal Data.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kbd_struct</span> <span class="n">kbd_table</span><span class="p">[</span><span class="n">MAX_NR_CONSOLES</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span><span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span><span class="p">;</span>

<span class="cm">/* maximum values each key_handler can handle */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">255</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">func_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fn_handler</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NR_PAD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">NR_DEAD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">NR_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">NR_ASCII</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NR_LOCK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">255</span><span class="p">,</span> <span class="n">NR_LOCK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">NR_BRL</span> <span class="o">-</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">NR_TYPES</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">max_vals</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_handler</span> <span class="n">kbd_handler</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">kbd_event_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key_down</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">KEY_CNT</span><span class="p">)];</span>	<span class="cm">/* keyboard key bitmap */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shift_down</span><span class="p">[</span><span class="n">NR_SHIFT</span><span class="p">];</span>		<span class="cm">/* shift state counters.. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">dead_key_next</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">npadch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>					<span class="cm">/* -1 or number assembled on pad */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">diacr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">rep</span><span class="p">;</span>					<span class="cm">/* flag telling character repeat */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">shift_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ledstate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>			<span class="cm">/* undefined */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ledioctl</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ledptr</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ledptrs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Notifier list for console keyboard events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ATOMIC_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">keyboard_notifier_list</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">register_keyboard_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_keyboard_notifier</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">unregister_keyboard_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">unregister_keyboard_notifier</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Translation of scancodes to keycodes. We set them on only the first</span>
<span class="cm"> * keyboard in the list that accepts the scancode and keycode.</span>
<span class="cm"> * Explanation for not choosing the first attached keyboard anymore:</span>
<span class="cm"> *  USB keyboards for example have two event devices: one for all &quot;normal&quot;</span>
<span class="cm"> *  keys and one for extra function keys (like &quot;volume up&quot;, &quot;make coffee&quot;,</span>
<span class="cm"> *  etc.). So this means that scancodes for the extra function keys won&#39;t</span>
<span class="cm"> *  be valid for the first event device, but will be for the second.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">getset_keycode_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="n">ke</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">getkeycode_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getset_keycode_data</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">input_get_keycode</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ke</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* stop as soon as we successfully get one */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">getkeycode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getset_keycode_data</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ke</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">),</span>
			<span class="p">.</span><span class="n">keycode</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">error</span>	<span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">ke</span><span class="p">.</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">));</span>

	<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">getkeycode_helper</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">error</span> <span class="o">?:</span> <span class="n">d</span><span class="p">.</span><span class="n">ke</span><span class="p">.</span><span class="n">keycode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setkeycode_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getset_keycode_data</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">input_set_keycode</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ke</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* stop as soon as we successfully set one */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setkeycode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">getset_keycode_data</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ke</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">),</span>
			<span class="p">.</span><span class="n">keycode</span>	<span class="o">=</span> <span class="n">keycode</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">error</span>	<span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">ke</span><span class="p">.</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">));</span>

	<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">setkeycode_helper</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Making beeps and bells. Note that we prefer beeps to bells, but when</span>
<span class="cm"> * shutting the sound off we do both.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kd_sound_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hz</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EV_SND</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SND_TONE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sndbit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_SND</span><span class="p">,</span> <span class="n">SND_TONE</span><span class="p">,</span> <span class="o">*</span><span class="n">hz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hz</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SND_BELL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sndbit</span><span class="p">))</span>
			<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_SND</span><span class="p">,</span> <span class="n">SND_BELL</span><span class="p">,</span> <span class="o">*</span><span class="n">hz</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kd_nosound</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">zero</span><span class="p">;</span>

	<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">kd_sound_helper</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">kd_mksound_timer</span><span class="p">,</span> <span class="n">kd_nosound</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">kd_mksound</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hz</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kd_mksound_timer</span><span class="p">);</span>

	<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hz</span><span class="p">,</span> <span class="n">kd_sound_helper</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hz</span> <span class="o">&amp;&amp;</span> <span class="n">ticks</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kd_mksound_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ticks</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">kd_mksound</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Setting the keyboard rate.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_rate_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kbd_repeat</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
					   <span class="n">EV_REP</span><span class="p">,</span> <span class="n">REP_DELAY</span><span class="p">,</span> <span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
					   <span class="n">EV_REP</span><span class="p">,</span> <span class="n">REP_PERIOD</span><span class="p">,</span> <span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period</span><span class="p">);</span>

		<span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">delay</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">];</span>
		<span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kbd_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_repeat</span> <span class="o">*</span><span class="n">rep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_repeat</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">*</span><span class="n">rep</span> <span class="p">};</span>

	<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kbd_rate_helper</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Copy currently used settings */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper Functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">con_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">puts_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">con_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">?</span> <span class="sc">&#39;O&#39;</span> <span class="o">:</span> <span class="sc">&#39;[&#39;</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">puts_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Many other routines do put_queue, but I think either</span>
<span class="cm"> * they produce ASCII, or they produce some user-assigned</span>
<span class="cm"> * string, and in both cases we might assume that it is</span>
<span class="cm"> * in utf-8 already.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">to_utf8</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">uint</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="cm">/*  0******* */</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 110***** 10****** */</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mh">0xD800</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0xE000</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* 1110**** 10****** 10****** */</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x110000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 11110*** 10****** 10****** 10****** */</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xf0</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called after returning from RAW mode or when changing consoles - recompute</span>
<span class="cm"> * shift_down[] and shift_state from key_down[] maybe called when keymap is</span>
<span class="cm"> * undefined, so that shiftkey release is seen. The caller must hold the</span>
<span class="cm"> * kbd_event_lock.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_compute_shiftstate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">shift_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">shift_down</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shift_down</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">key_down</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key_down</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_down</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">sym</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">key_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">KTYP</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">!=</span> <span class="n">KT_SHIFT</span> <span class="o">&amp;&amp;</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">!=</span> <span class="n">KT_SLOCK</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">sym</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_CAPSSHIFT</span><span class="p">))</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_SHIFT</span><span class="p">);</span>

			<span class="n">shift_down</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">shift_state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* We still have to export this method to vt.c */</span>
<span class="kt">void</span> <span class="nf">compute_shiftstate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">do_compute_shiftstate</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have a combining character DIACR here, followed by the character CH.</span>
<span class="cm"> * If the combination occurs in the table, return the corresponding value.</span>
<span class="cm"> * Otherwise, if CH is a space or equals DIACR, return DIACR.</span>
<span class="cm"> * Otherwise, conclude that DIACR was not combining after all,</span>
<span class="cm"> * queue it and return CH.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">handle_diacr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">diacr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">diacr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">BRL_UC_ROW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">BRL_UC_ROW</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">d</span> <span class="o">|</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">accent_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">diacr</span> <span class="o">==</span> <span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="p">(</span><span class="n">BRL_UC_ROW</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_UNICODE</span><span class="p">)</span>
		<span class="n">to_utf8</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Special function handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diacr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_UNICODE</span><span class="p">)</span>
			<span class="n">to_utf8</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">diacr</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span><span class="n">diacr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">diacr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CRLF</span><span class="p">))</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_caps_toggle</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chg_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CAPSLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_caps_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CAPSLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_show_ptregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">get_irq_regs</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: SCROLLOCK will be set (cleared) by stop_tty (start_tty);</span>
<span class="cm">	 * these routines are also activated by ^S/^Q.</span>
<span class="cm">	 * (And SCROLLOCK can also be set by the ioctl KDSKBLED.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">stop_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_APPLIC</span><span class="p">))</span>
		<span class="n">applkey</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fn_bare_num</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bind this to Shift-NumLock if you work in application keypad mode</span>
<span class="cm"> * but want to be able to change the NumLock flag.</span>
<span class="cm"> * Bind this to NumLock if you prefer that the NumLock key always</span>
<span class="cm"> * changes the NumLock flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_bare_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rep</span><span class="p">)</span>
		<span class="n">chg_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_NUMLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_lastcons</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* switch to the last used console, ChN */</span>
	<span class="n">set_console</span><span class="p">(</span><span class="n">last_console</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_dec_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">fg_console</span><span class="p">;</span>

	<span class="cm">/* Currently switching?  Queue this next switch relative to that. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">want_console</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">want_console</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_NR_CONSOLES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_console</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_inc_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">fg_console</span><span class="p">;</span>

	<span class="cm">/* Currently switching?  Queue this next switch relative to that. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">want_console</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">want_console</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cur</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_console</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_send_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
	<span class="n">con_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_scroll_forw</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scrollfront</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_scroll_back</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scrollback</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_show_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_mem</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_show_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_state</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_boot_it</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctrl_alt_del</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_compose</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dead_key_next</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_spawn_con</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kill_pid</span><span class="p">(</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">sig</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">put_pid</span><span class="p">(</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_spawn_con</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_SAK</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">SAK_work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">SAK_work</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="n">SAK_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fn_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_compute_shiftstate</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Special key handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_ignore</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fn_handler</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_RAW</span> <span class="o">||</span>
	     <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_MEDIUMRAW</span> <span class="o">||</span>
	     <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">value</span> <span class="o">!=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_SAK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* SAK is allowed even in raw mode */</span>
	<span class="n">fn_handler</span><span class="p">[</span><span class="n">value</span><span class="p">](</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_lowercase</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;k_lowercase was called - impossible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_unicode</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* no action, if this is a key release */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diacr</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">handle_diacr</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dead_key_next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dead_key_next</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">diacr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_UNICODE</span><span class="p">)</span>
		<span class="n">to_utf8</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle dead key. Note that we now may have several</span>
<span class="cm"> * dead keys modifying the same character. Very useful</span>
<span class="cm"> * for Vietnamese.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_deadunicode</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">diacr</span> <span class="o">=</span> <span class="p">(</span><span class="n">diacr</span> <span class="o">?</span> <span class="n">handle_diacr</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_self</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">k_unicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">conv_8bit_to_uni</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">up_flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_dead2</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">k_deadunicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Obsolete - for backwards compatibility only</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_dead</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ret_diacr</span><span class="p">[</span><span class="n">NR_DEAD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;`&#39;</span><span class="p">,</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">,</span> <span class="sc">&#39;^&#39;</span><span class="p">,</span> <span class="sc">&#39;~&#39;</span><span class="p">,</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span> <span class="p">};</span>

	<span class="n">k_deadunicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">ret_diacr</span><span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="n">up_flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_cons</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_console</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">func_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
			<span class="n">puts_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">func_table</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;k_fn called with value=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cur_chars</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;BDCA&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">applkey</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">cur_chars</span><span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CKMODE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_pad</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">pad_chars</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;0123456789+-*/</span><span class="se">\015</span><span class="s">,.?()#&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">app_map</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;pqrstuvwxylSRQMnnmPQS&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* no action, if this is a key release */</span>

	<span class="cm">/* kludge... shift forces cursor/number keys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_APPLIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shift_down</span><span class="p">[</span><span class="n">KG_SHIFT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">applkey</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">app_map</span><span class="p">[</span><span class="n">value</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_NUMLOCK</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PCOMMA</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PDOT</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_REMOVE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P0</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_INSERT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P1</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_SELECT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P2</span><span class="p">)</span>:
			<span class="n">k_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_DOWN</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P3</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PGDN</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P4</span><span class="p">)</span>:
			<span class="n">k_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_LEFT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P6</span><span class="p">)</span>:
			<span class="n">k_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_RIGHT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P7</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_FIND</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P8</span><span class="p">)</span>:
			<span class="n">k_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_UP</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P9</span><span class="p">)</span>:
			<span class="n">k_fn</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PGUP</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_P5</span><span class="p">)</span>:
			<span class="n">applkey</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_APPLIC</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">pad_chars</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PENTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CRLF</span><span class="p">))</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_shift</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">shift_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Mimic typewriter:</span>
<span class="cm">	 * a CapsShift key acts like Shift but undoes CapsLock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_CAPSSHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">)</span>
			<span class="n">clr_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CAPSLOCK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * handle the case that two shift or control</span>
<span class="cm">		 * keys are depressed simultaneously</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift_down</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
			<span class="n">shift_down</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shift_down</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift_down</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
		<span class="n">shift_state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">shift_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* kludge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span> <span class="o">&amp;&amp;</span> <span class="n">shift_state</span> <span class="o">!=</span> <span class="n">old_state</span> <span class="o">&amp;&amp;</span> <span class="n">npadch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_UNICODE</span><span class="p">)</span>
			<span class="n">to_utf8</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">npadch</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">npadch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">npadch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_meta</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_META</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;\033&#39;</span><span class="p">);</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_ascii</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* decimal input of code, while Alt depressed */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* hexadecimal input of code, while AltGr depressed */</span>
		<span class="n">value</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npadch</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">npadch</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">npadch</span> <span class="o">=</span> <span class="n">npadch</span> <span class="o">*</span> <span class="n">base</span> <span class="o">+</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span> <span class="o">||</span> <span class="n">rep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chg_vc_kbd_lock</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_slock</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">k_shift</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span> <span class="o">||</span> <span class="n">rep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chg_vc_kbd_slock</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="cm">/* try to make Alt, oops, AltGr and such work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key_maps</span><span class="p">[</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">lockstate</span> <span class="o">^</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chg_vc_kbd_slock</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* by default, 300ms interval for combination release */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">brl_timeout</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">brl_timeout</span><span class="p">,</span> <span class="s">&quot;Braille keys release delay in ms (0 for commit on first key release)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">brl_timeout</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">brl_nbchords</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">brl_nbchords</span><span class="p">,</span> <span class="s">&quot;Number of chords that produce a braille pattern (0 for dead chords)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">brl_nbchords</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_brlcommit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pattern</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chords</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">committed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brl_nbchords</span><span class="p">)</span>
		<span class="n">k_deadunicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">BRL_UC_ROW</span> <span class="o">|</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">committed</span> <span class="o">|=</span> <span class="n">pattern</span><span class="p">;</span>
		<span class="n">chords</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chords</span> <span class="o">==</span> <span class="n">brl_nbchords</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k_unicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">BRL_UC_ROW</span> <span class="o">|</span> <span class="n">committed</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">);</span>
			<span class="n">chords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">committed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">k_brl</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">pressed</span><span class="p">,</span> <span class="n">committing</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">releasestart</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">!=</span> <span class="n">VC_UNICODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;keyboard mode must be unicode for braille patterns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">k_unicode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">BRL_UC_ROW</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pressed</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brl_timeout</span><span class="p">)</span>
			<span class="n">committing</span> <span class="o">=</span> <span class="n">pressed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brl_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">committing</span> <span class="o">||</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
			       <span class="n">releasestart</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">brl_timeout</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">committing</span> <span class="o">=</span> <span class="n">pressed</span><span class="p">;</span>
			<span class="n">releasestart</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pressed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pressed</span> <span class="o">&amp;&amp;</span> <span class="n">committing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k_brlcommit</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">committing</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">committing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">committing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k_brlcommit</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">committing</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">committing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pressed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The leds display either (i) the status of NumLock, CapsLock, ScrollLock,</span>
<span class="cm"> * or (ii) whatever pattern of lights people want to show using KDSETLED,</span>
<span class="cm"> * or (iii) specified bits of specified words in kernel memory.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">getledstate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ledstate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setledstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span><span class="n">kbd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">led</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ledioctl</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledmode</span> <span class="o">=</span> <span class="n">LED_SHOW_IOCTL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledmode</span> <span class="o">=</span> <span class="n">LED_SHOW_FLAGS</span><span class="p">;</span>

	<span class="n">set_leds</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">getleds</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span><span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">fg_console</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledmode</span> <span class="o">==</span> <span class="n">LED_SHOW_IOCTL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ledioctl</span><span class="p">;</span>

	<span class="n">leds</span> <span class="o">=</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledmode</span> <span class="o">==</span> <span class="n">LED_SHOW_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ledptrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ledptrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">ledptrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
					<span class="n">leds</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">leds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">leds</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_update_leds_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EV_LED</span><span class="p">,</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_LED</span><span class="p">,</span> <span class="n">LED_SCROLLL</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_LED</span><span class="p">,</span> <span class="n">LED_NUML</span><span class="p">,</span>    <span class="o">!!</span><span class="p">(</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">));</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_LED</span><span class="p">,</span> <span class="n">LED_CAPSL</span><span class="p">,</span>   <span class="o">!!</span><span class="p">(</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_SYN</span><span class="p">,</span> <span class="n">SYN_REPORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_get_leds	-	helper for braille console</span>
<span class="cm"> *	@console: console to read</span>
<span class="cm"> *	@flag: flag we want to check</span>
<span class="cm"> *</span>
<span class="cm"> *	Check the status of a keyboard led flag and report it back</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_get_leds</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">vt_get_leds</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_set_led_state	-	set LED state of a console</span>
<span class="cm"> *	@console: console to set</span>
<span class="cm"> *	@leds: LED bits</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the LEDs on a console. This is a wrapper for the VT layer</span>
<span class="cm"> *	so that we can keep kbd knowledge internal</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vt_set_led_state</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">leds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="n">setledstate</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">leds</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_kbd_con_start	-	Keyboard side of console start</span>
<span class="cm"> *	@console: console</span>
<span class="cm"> *</span>
<span class="cm"> *	Handle console start. This is a wrapper for the VT layer</span>
<span class="cm"> *	so that we can keep kbd knowledge internal</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXME: We eventually need to hold the kbd lock here to protect</span>
<span class="cm"> *	the LED updating. We can&#39;t do it yet because fn_hold calls stop_tty</span>
<span class="cm"> *	and start_tty under the kbd_event_lock, while normal tty paths</span>
<span class="cm"> *	don&#39;t hold the lock. We probably need to split out an LED lock</span>
<span class="cm"> *	but not during an -rc release!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vt_kbd_con_start</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
<span class="cm">/*	unsigned long flags; */</span>
<span class="cm">/*	spin_lock_irqsave(&amp;kbd_event_lock, flags); */</span>
	<span class="n">clr_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_SCROLLOCK</span><span class="p">);</span>
	<span class="n">set_leds</span><span class="p">();</span>
<span class="cm">/*	spin_unlock_irqrestore(&amp;kbd_event_lock, flags); */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_kbd_con_stop		-	Keyboard side of console stop</span>
<span class="cm"> *	@console: console</span>
<span class="cm"> *</span>
<span class="cm"> *	Handle console stop. This is a wrapper for the VT layer</span>
<span class="cm"> *	so that we can keep kbd knowledge internal</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXME: We eventually need to hold the kbd lock here to protect</span>
<span class="cm"> *	the LED updating. We can&#39;t do it yet because fn_hold calls stop_tty</span>
<span class="cm"> *	and start_tty under the kbd_event_lock, while normal tty paths</span>
<span class="cm"> *	don&#39;t hold the lock. We probably need to split out an LED lock</span>
<span class="cm"> *	but not during an -rc release!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vt_kbd_con_stop</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
<span class="cm">/*	unsigned long flags; */</span>
<span class="cm">/*	spin_lock_irqsave(&amp;kbd_event_lock, flags); */</span>
	<span class="n">set_vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_SCROLLOCK</span><span class="p">);</span>
	<span class="n">set_leds</span><span class="p">();</span>
<span class="cm">/*	spin_unlock_irqrestore(&amp;kbd_event_lock, flags); */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the tasklet that updates LED state on all keyboards</span>
<span class="cm"> * attached to the box. The reason we use tasklet is that we</span>
<span class="cm"> * need to handle the scenario when keyboard handler is not</span>
<span class="cm"> * registered yet but we already getting updates from the VT to</span>
<span class="cm"> * update led state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_bh</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span> <span class="o">=</span> <span class="n">getleds</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">leds</span> <span class="o">!=</span> <span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_handler_for_each_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leds</span><span class="p">,</span>
					      <span class="n">kbd_update_leds_helper</span><span class="p">);</span>
		<span class="n">ledstate</span> <span class="o">=</span> <span class="n">leds</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">DECLARE_TASKLET_DISABLED</span><span class="p">(</span><span class="n">keyboard_tasklet</span><span class="p">,</span> <span class="n">kbd_bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_X86) || defined(CONFIG_IA64) || defined(CONFIG_ALPHA) ||\</span>
<span class="cp">    defined(CONFIG_MIPS) || defined(CONFIG_PPC) || defined(CONFIG_SPARC) ||\</span>
<span class="cp">    defined(CONFIG_PARISC) || defined(CONFIG_SUPERH) ||\</span>
<span class="cp">    (defined(CONFIG_ARM) &amp;&amp; defined(CONFIG_KEYBOARD_ATKBD) &amp;&amp; !defined(CONFIG_ARCH_RPC)) ||\</span>
<span class="cp">    defined(CONFIG_AVR32)</span>

<span class="cp">#define HW_RAW(dev) (test_bit(EV_MSC, dev-&gt;evbit) &amp;&amp; test_bit(MSC_RAW, dev-&gt;mscbit) &amp;&amp;\</span>
<span class="cp">			((dev)-&gt;id.bustype == BUS_I8042) &amp;&amp; ((dev)-&gt;id.vendor == 0x0001) &amp;&amp; ((dev)-&gt;id.product == 0x0001))</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">x86_keycodes</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	 <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
	 <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
	 <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
	 <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>
	 <span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span>
	<span class="mi">284</span><span class="p">,</span><span class="mi">285</span><span class="p">,</span><span class="mi">309</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">312</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span><span class="mi">327</span><span class="p">,</span><span class="mi">328</span><span class="p">,</span><span class="mi">329</span><span class="p">,</span><span class="mi">331</span><span class="p">,</span><span class="mi">333</span><span class="p">,</span><span class="mi">335</span><span class="p">,</span><span class="mi">336</span><span class="p">,</span><span class="mi">337</span><span class="p">,</span><span class="mi">338</span><span class="p">,</span><span class="mi">339</span><span class="p">,</span>
	<span class="mi">367</span><span class="p">,</span><span class="mi">288</span><span class="p">,</span><span class="mi">302</span><span class="p">,</span><span class="mi">304</span><span class="p">,</span><span class="mi">350</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span><span class="mi">334</span><span class="p">,</span><span class="mi">326</span><span class="p">,</span><span class="mi">267</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">268</span><span class="p">,</span><span class="mi">269</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span><span class="mi">347</span><span class="p">,</span><span class="mi">348</span><span class="p">,</span><span class="mi">349</span><span class="p">,</span>
	<span class="mi">360</span><span class="p">,</span><span class="mi">261</span><span class="p">,</span><span class="mi">262</span><span class="p">,</span><span class="mi">263</span><span class="p">,</span><span class="mi">268</span><span class="p">,</span><span class="mi">376</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">321</span><span class="p">,</span><span class="mi">316</span><span class="p">,</span><span class="mi">373</span><span class="p">,</span><span class="mi">286</span><span class="p">,</span><span class="mi">289</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">351</span><span class="p">,</span><span class="mi">355</span><span class="p">,</span>
	<span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">275</span><span class="p">,</span><span class="mi">287</span><span class="p">,</span><span class="mi">279</span><span class="p">,</span><span class="mi">258</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">274</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">294</span><span class="p">,</span><span class="mi">364</span><span class="p">,</span><span class="mi">358</span><span class="p">,</span><span class="mi">363</span><span class="p">,</span><span class="mi">362</span><span class="p">,</span><span class="mi">361</span><span class="p">,</span>
	<span class="mi">291</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">381</span><span class="p">,</span><span class="mi">281</span><span class="p">,</span><span class="mi">290</span><span class="p">,</span><span class="mi">272</span><span class="p">,</span><span class="mi">292</span><span class="p">,</span><span class="mi">305</span><span class="p">,</span><span class="mi">280</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">257</span><span class="p">,</span><span class="mi">306</span><span class="p">,</span><span class="mi">359</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span>
	<span class="mi">264</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">271</span><span class="p">,</span><span class="mi">374</span><span class="p">,</span><span class="mi">379</span><span class="p">,</span><span class="mi">265</span><span class="p">,</span><span class="mi">266</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span><span class="mi">259</span><span class="p">,</span><span class="mi">375</span><span class="p">,</span><span class="mi">260</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span>
	<span class="mi">377</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">277</span><span class="p">,</span><span class="mi">278</span><span class="p">,</span><span class="mi">282</span><span class="p">,</span><span class="mi">283</span><span class="p">,</span><span class="mi">295</span><span class="p">,</span><span class="mi">296</span><span class="p">,</span><span class="mi">297</span><span class="p">,</span><span class="mi">299</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">301</span><span class="p">,</span><span class="mi">293</span><span class="p">,</span><span class="mi">303</span><span class="p">,</span><span class="mi">307</span><span class="p">,</span>
	<span class="mi">308</span><span class="p">,</span><span class="mi">310</span><span class="p">,</span><span class="mi">313</span><span class="p">,</span><span class="mi">314</span><span class="p">,</span><span class="mi">315</span><span class="p">,</span><span class="mi">317</span><span class="p">,</span><span class="mi">318</span><span class="p">,</span><span class="mi">319</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="mi">357</span><span class="p">,</span><span class="mi">322</span><span class="p">,</span><span class="mi">323</span><span class="p">,</span><span class="mi">324</span><span class="p">,</span><span class="mi">325</span><span class="p">,</span><span class="mi">276</span><span class="p">,</span><span class="mi">330</span><span class="p">,</span>
	<span class="mi">332</span><span class="p">,</span><span class="mi">340</span><span class="p">,</span><span class="mi">365</span><span class="p">,</span><span class="mi">342</span><span class="p">,</span><span class="mi">343</span><span class="p">,</span><span class="mi">344</span><span class="p">,</span><span class="mi">345</span><span class="p">,</span><span class="mi">346</span><span class="p">,</span><span class="mi">356</span><span class="p">,</span><span class="mi">270</span><span class="p">,</span><span class="mi">341</span><span class="p">,</span><span class="mi">368</span><span class="p">,</span><span class="mi">369</span><span class="p">,</span><span class="mi">370</span><span class="p">,</span><span class="mi">371</span><span class="p">,</span><span class="mi">372</span> <span class="p">};</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sparc_l1_a_state</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">sun_do_break</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">KEY_PAUSE</span>:
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">);</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x45</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KEY_HANGEUL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">)</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KEY_HANJA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">)</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KEY_SYSRQ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Real AT keyboards (that&#39;s what we&#39;re trying</span>
<span class="cm">		 * to emulate here emit 0xe0 0x2a 0xe0 0x37 when</span>
<span class="cm">		 * pressing PrtSc/SysRq alone, but simply 0x54</span>
<span class="cm">		 * when pressing Alt+PrtSc/SysRq.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">KEY_LEFTALT</span><span class="p">,</span> <span class="n">key_down</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">KEY_RIGHTALT</span><span class="p">,</span> <span class="n">key_down</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x54</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x2a</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0x37</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">code</span> <span class="o">=</span> <span class="n">x86_keycodes</span><span class="p">[</span><span class="n">keycode</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define HW_RAW(dev)	0</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keycode</span> <span class="o">|</span> <span class="n">up_flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_rawcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

	<span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_RAW</span><span class="p">)</span>
		<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_keycode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">down</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hw_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keysym</span><span class="p">,</span> <span class="o">*</span><span class="n">key_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">raw_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_final</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">keyboard_notifier_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="p">,</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">keycode</span><span class="p">,</span> <span class="p">.</span><span class="n">down</span> <span class="o">=</span> <span class="n">down</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No driver data? Strange. Okay we fix it then. */</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_STOP</span><span class="p">)</span>
		<span class="n">sparc_l1_a_state</span> <span class="o">=</span> <span class="n">down</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">rep</span> <span class="o">=</span> <span class="p">(</span><span class="n">down</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">raw_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_RAW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw_mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hw_raw</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emulate_raw</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="o">!</span><span class="n">down</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&lt;</span> <span class="n">BTN_MISC</span> <span class="o">&amp;&amp;</span> <span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;can&#39;t emulate rawmode for keycode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">keycode</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_A</span> <span class="o">&amp;&amp;</span> <span class="n">sparc_l1_a_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sparc_l1_a_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sun_do_break</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_MEDIUMRAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is extended medium raw mode, with keys above 127</span>
<span class="cm">		 * encoded as 0, high 7 bits, low 7 bits, with the 0 bearing</span>
<span class="cm">		 * the &#39;up&#39; flag if needed. 0 is reserved, so this shouldn&#39;t</span>
<span class="cm">		 * interfere with anything else. The two bytes after 0 will</span>
<span class="cm">		 * always have the up flag set not to interfere with older</span>
<span class="cm">		 * applications. This allows for 16384 different keycodes,</span>
<span class="cm">		 * which should be enough.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keycode</span> <span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">down</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">!</span><span class="n">down</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">put_queue</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keycode</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">raw_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">keycode</span><span class="p">,</span> <span class="n">key_down</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">keycode</span><span class="p">,</span> <span class="n">key_down</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rep</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_REPEAT</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t repeat a key if the input buffers are not empty and the</span>
<span class="cm">		 * characters get aren&#39;t echoed locally. This makes key repeat</span>
<span class="cm">		 * usable with slow applications and under heavy loads.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift_final</span> <span class="o">=</span> <span class="p">(</span><span class="n">shift_state</span> <span class="o">|</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span><span class="p">)</span> <span class="o">^</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">lockstate</span><span class="p">;</span>
	<span class="n">param</span><span class="p">.</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span><span class="p">;</span>
	<span class="n">key_map</span> <span class="o">=</span> <span class="n">key_maps</span><span class="p">[</span><span class="n">shift_final</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span>
					<span class="n">KBD_KEYCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span> <span class="o">||</span> <span class="o">!</span><span class="n">key_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span>
					   <span class="n">KBD_UNBOUND_KEYCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="n">do_compute_shiftstate</span><span class="p">();</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&lt;</span> <span class="n">NR_KEYS</span><span class="p">)</span>
		<span class="n">keysym</span> <span class="o">=</span> <span class="n">key_map</span><span class="p">[</span><span class="n">keycode</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;=</span> <span class="n">KEY_BRL_DOT1</span> <span class="o">&amp;&amp;</span> <span class="n">keycode</span> <span class="o">&lt;=</span> <span class="n">KEY_BRL_DOT8</span><span class="p">)</span>
		<span class="n">keysym</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">K</span><span class="p">(</span><span class="n">KT_BRL</span><span class="p">,</span> <span class="n">keycode</span> <span class="o">-</span> <span class="n">KEY_BRL_DOT1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">keysym</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">keysym</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span>
						<span class="n">KBD_UNICODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">down</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">raw_mode</span><span class="p">)</span>
				<span class="n">to_utf8</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keysym</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">-=</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_LETTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">KT_LATIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc_kbd_led</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CAPSLOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">key_map</span> <span class="o">=</span> <span class="n">key_maps</span><span class="p">[</span><span class="n">shift_final</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KG_SHIFT</span><span class="p">)];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key_map</span><span class="p">)</span>
				<span class="n">keysym</span> <span class="o">=</span> <span class="n">key_map</span><span class="p">[</span><span class="n">keycode</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">keysym</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span>
					<span class="n">KBD_KEYSYM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">raw_mode</span> <span class="o">||</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">==</span> <span class="n">VC_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">KT_SPEC</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">KT_SHIFT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">k_handler</span><span class="p">[</span><span class="n">type</span><span class="p">])(</span><span class="n">vc</span><span class="p">,</span> <span class="n">keysym</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">!</span><span class="n">down</span><span class="p">);</span>

	<span class="n">param</span><span class="p">.</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span><span class="p">;</span>
	<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_list</span><span class="p">,</span> <span class="n">KBD_POST_KEYSYM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">KT_SLOCK</span><span class="p">)</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_type</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We are called with interrupts disabled, just take the lock */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">EV_MSC</span> <span class="o">&amp;&amp;</span> <span class="n">event_code</span> <span class="o">==</span> <span class="n">MSC_RAW</span> <span class="o">&amp;&amp;</span> <span class="n">HW_RAW</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">kbd_rawcode</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span>
		<span class="n">kbd_keycode</span><span class="p">(</span><span class="n">event_code</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">HW_RAW</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>
	<span class="n">do_poke_blanked_console</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_console_callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">kbd_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EV_SND</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTN_MISC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">KEY_BRL_DOT1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">KEY_BRL_DOT10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When a keyboard (or other input device) is found, the kbd_connect</span>
<span class="cm"> * function is called. The function then looks at the device, and if it</span>
<span class="cm"> * likes it, it can open it and get events from it. In this (kbd_connect)</span>
<span class="cm"> * function, we should decide which VT to bind that keyboard to initially.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;kbd&quot;</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_handle</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_open_device</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister_handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_unregister_handle:</span>
	<span class="n">input_unregister_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
 <span class="nl">err_free_handle:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_close_device</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">input_unregister_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start keyboard handler on the new keyboard by refreshing LED state to</span>
<span class="cm"> * match the rest of the system.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ledstate</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">kbd_update_leds_helper</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ledstate</span><span class="p">);</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="n">kbd_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">INPUT_DEVICE_ID_MATCH_EVBIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">evbit</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">INPUT_DEVICE_ID_MATCH_EVBIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">evbit</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_SND</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="p">},</span>    <span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">kbd_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_handler</span> <span class="n">kbd_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event</span>		<span class="o">=</span> <span class="n">kbd_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">kbd_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">kbd_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">kbd_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">kbd_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kbd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">kbd_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">kbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ledflagstate</span> <span class="o">=</span> <span class="n">kbd_defleds</span><span class="p">();</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_ledflagstate</span> <span class="o">=</span> <span class="n">kbd_defleds</span><span class="p">();</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ledmode</span> <span class="o">=</span> <span class="n">LED_SHOW_FLAGS</span><span class="p">;</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lockstate</span> <span class="o">=</span> <span class="n">KBD_DEFLOCK</span><span class="p">;</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modeflags</span> <span class="o">=</span> <span class="n">KBD_DEFMODE</span><span class="p">;</span>
		<span class="n">kbd_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">default_utf8</span> <span class="o">?</span> <span class="n">VC_UNICODE</span> <span class="o">:</span> <span class="n">VC_XLATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Ioctl support code */</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_do_diacrit		-	diacritical table updates</span>
<span class="cm"> *	@cmd: ioctl request</span>
<span class="cm"> *	@up: pointer to user data for ioctl</span>
<span class="cm"> *	@perm: permissions check computed by caller</span>
<span class="cm"> *</span>
<span class="cm"> *	Update the diacritical tables atomically and safely. Lock them</span>
<span class="cm"> *	against simultaneous keypresses</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_do_diacrit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbdiacrs</span> <span class="n">__user</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KDGKBDIACR</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kbdiacr</span> <span class="o">*</span><span class="n">diacr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">diacr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_DIACR</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacr</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diacr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* Lock the diacriticals table, make a copy and then</span>
<span class="cm">		   copy it after we unlock */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">asize</span> <span class="o">=</span> <span class="n">accent_table_size</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">asize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">diacr</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span>
						<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">diacr</span><span class="p">);</span>
			<span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span>
						<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
			<span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">result</span> <span class="o">=</span> <span class="n">conv_uni_to_8bit</span><span class="p">(</span>
						<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kb_cnt</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kbdiacr</span><span class="p">,</span> <span class="n">diacr</span><span class="p">,</span>
				<span class="n">asize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacr</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">diacr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">KDGKBDIACRUC</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kbdiacrsuc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_DIACR</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* Lock the diacriticals table, make a copy and then</span>
<span class="cm">		   copy it after we unlock */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">asize</span> <span class="o">=</span> <span class="n">accent_table_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">accent_table</span><span class="p">,</span> <span class="n">asize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">));</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">asize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kb_cnt</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kbdiacruc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				<span class="n">asize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">KDSKBDIACR</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kbdiacrs</span> <span class="n">__user</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kbdiacr</span> <span class="o">*</span><span class="n">diacr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ct</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kb_cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span> <span class="o">&gt;=</span> <span class="n">MAX_DIACR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diacr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacr</span><span class="p">)</span> <span class="o">*</span> <span class="n">ct</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diacr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">diacr</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">kbdiacr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacr</span><span class="p">)</span> <span class="o">*</span> <span class="n">ct</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">diacr</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">accent_table_size</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ct</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">diacr</span> <span class="o">=</span>
					<span class="n">conv_8bit_to_uni</span><span class="p">(</span><span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">diacr</span><span class="p">);</span>
			<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span>
					<span class="n">conv_8bit_to_uni</span><span class="p">(</span><span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
			<span class="n">accent_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">result</span> <span class="o">=</span>
					<span class="n">conv_8bit_to_uni</span><span class="p">(</span><span class="n">diacr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">diacr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">KDSKBDIACRUC</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kbdiacrsuc</span> <span class="n">__user</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ct</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">kb_cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span> <span class="o">&gt;=</span> <span class="n">MAX_DIACR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ct</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">kbdiacruc</span><span class="p">,</span>
					<span class="n">ct</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> 
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ct</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">accent_table</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					<span class="n">ct</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbdiacruc</span><span class="p">));</span>
		<span class="n">accent_table_size</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_do_kdskbmode		-	set keyboard mode ioctl</span>
<span class="cm"> *	@console: the console to use</span>
<span class="cm"> *	@arg: the requested mode</span>
<span class="cm"> *</span>
<span class="cm"> *	Update the keyboard mode bits while holding the correct locks.</span>
<span class="cm"> *	Return 0 for success or an error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_do_kdskbmode</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">K_RAW</span>:
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">VC_RAW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">K_MEDIUMRAW</span>:
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">VC_MEDIUMRAW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">K_XLATE</span>:
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">VC_XLATE</span><span class="p">;</span>
		<span class="n">do_compute_shiftstate</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">K_UNICODE</span>:
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">VC_UNICODE</span><span class="p">;</span>
		<span class="n">do_compute_shiftstate</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">K_OFF</span>:
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">VC_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_do_kdskbmeta		-	set keyboard meta state</span>
<span class="cm"> *	@console: the console to use</span>
<span class="cm"> *	@arg: the requested meta state</span>
<span class="cm"> *</span>
<span class="cm"> *	Update the keyboard meta bits while holding the correct locks.</span>
<span class="cm"> *	Return 0 for success or an error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_do_kdskbmeta</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">K_METABIT</span>:
		<span class="n">clr_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_META</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">K_ESCPREFIX</span>:
		<span class="n">set_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_META</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vt_do_kbkeycode_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kbkeycode</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_kbkc</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbkeycode</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">user_kbkc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbkeycode</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KDGETKEYCODE</span>:
		<span class="n">kc</span> <span class="o">=</span> <span class="n">getkeycode</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">scancode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_kbkc</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KDSETKEYCODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">kc</span> <span class="o">=</span> <span class="n">setkeycode</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">scancode</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">keycode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">kc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define i (tmp.kb_index)</span>
<span class="cp">#define s (tmp.kb_table)</span>
<span class="cp">#define v (tmp.kb_value)</span>

<span class="kt">int</span> <span class="nf">vt_do_kdsk_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kbentry</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_kbe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kbentry</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="o">*</span><span class="n">key_map</span><span class="p">,</span> <span class="o">*</span><span class="n">new_map</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ov</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">user_kbe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbentry</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_TTY_CONFIG</span><span class="p">))</span>
		<span class="n">perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KDGKBENT</span>:
		<span class="cm">/* Ensure another thread doesn&#39;t free it under us */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">key_map</span> <span class="o">=</span> <span class="n">key_maps</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_map</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">val</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">key_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">!=</span> <span class="n">VC_UNICODE</span> <span class="o">&amp;&amp;</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NR_TYPES</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">K_HOLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="n">K_HOLE</span> <span class="o">:</span> <span class="n">K_NOSUCHMAP</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_kbe</span><span class="o">-&gt;</span><span class="n">kb_value</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">KDSKBENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">==</span> <span class="n">K_NOSUCHMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* deallocate map */</span>
			<span class="n">key_map</span> <span class="o">=</span> <span class="n">key_maps</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">key_map</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">key_maps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">key_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">U</span><span class="p">(</span><span class="n">K_ALLOCATED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">key_map</span><span class="p">);</span>
					<span class="n">keymap_count</span><span class="o">--</span><span class="p">;</span>
			    <span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">KTYP</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NR_TYPES</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">KVAL</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_vals</span><span class="p">[</span><span class="n">KTYP</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span> <span class="o">!=</span> <span class="n">VC_UNICODE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* ++Geert: non-PC keyboards may generate keycode zero */</span>
<span class="cp">#if !defined(__mc68000__) &amp;&amp; !defined(__powerpc__)</span>
		<span class="cm">/* assignment to entry 0 only tests validity of args */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">new_map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">plain_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_map</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">key_map</span> <span class="o">=</span> <span class="n">key_maps</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">keymap_count</span> <span class="o">&gt;=</span> <span class="n">MAX_NR_OF_USER_KEYMAPS</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RESOURCE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">new_map</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">key_maps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_map</span><span class="p">;</span>
			<span class="n">key_map</span> <span class="o">=</span> <span class="n">new_map</span><span class="p">;</span>
			<span class="n">key_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">K_ALLOCATED</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NR_KEYS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">key_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">K_HOLE</span><span class="p">);</span>
			<span class="n">keymap_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_map</span><span class="p">);</span>

		<span class="n">ov</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">key_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">ov</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Attention Key.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ov</span> <span class="o">==</span> <span class="n">K_SAK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">K_SAK</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">key_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">KTYP</span><span class="p">(</span><span class="n">ov</span><span class="p">)</span> <span class="o">==</span> <span class="n">KT_SHIFT</span> <span class="o">||</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">KT_SHIFT</span><span class="p">))</span>
			<span class="n">do_compute_shiftstate</span><span class="p">();</span>
<span class="nl">out:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef i</span>
<span class="cp">#undef s</span>
<span class="cp">#undef v</span>

<span class="cm">/* FIXME: This one needs untangling and locking */</span>
<span class="kt">int</span> <span class="nf">vt_do_kdgkb_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kbsentry</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_kdgkb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbsentry</span> <span class="o">*</span><span class="n">kbs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">first_free</span><span class="p">,</span> <span class="o">*</span><span class="n">fj</span><span class="p">,</span> <span class="o">*</span><span class="n">fnw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_TTY_CONFIG</span><span class="p">))</span>
		<span class="n">perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kbs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kbs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we mostly copy too much here (512bytes), but who cares ;) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kbs</span><span class="p">,</span> <span class="n">user_kdgkb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kbsentry</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_func</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KDGKBSENT</span>:
		<span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* sz should have been</span>
<span class="cm">						  a struct member */</span>
		<span class="n">up</span> <span class="o">=</span> <span class="n">user_kdgkb</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">func_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">sz</span><span class="o">--</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">up</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">up</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">kbs</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EOVERFLOW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">KDSKBSENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">q</span> <span class="o">=</span> <span class="n">func_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">first_free</span> <span class="o">=</span> <span class="n">funcbufptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">funcbufsize</span> <span class="o">-</span> <span class="n">funcbufleft</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NR_FUNC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">func_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NR_FUNC</span><span class="p">)</span>
			<span class="n">fj</span> <span class="o">=</span> <span class="n">func_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">fj</span> <span class="o">=</span> <span class="n">first_free</span><span class="p">;</span>

		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">?</span> <span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="n">funcbufleft</span><span class="p">)</span> <span class="p">{</span> 	<span class="cm">/* it fits in current buf */</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NR_FUNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">fj</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">first_free</span> <span class="o">-</span> <span class="n">fj</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_NR_FUNC</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
				<span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		      <span class="n">func_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fj</span><span class="p">;</span>
		    <span class="n">funcbufleft</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* allocate a larger buffer */</span>
		    <span class="n">sz</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		    <span class="k">while</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&lt;</span> <span class="n">funcbufsize</span> <span class="o">-</span> <span class="n">funcbufleft</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
		      <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="n">fnw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">fnw</span><span class="p">)</span> <span class="p">{</span>
		      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		      <span class="k">goto</span> <span class="n">reterr</span><span class="p">;</span>
		    <span class="p">}</span>

		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		      <span class="n">func_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fj</span><span class="p">;</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">fj</span> <span class="o">&gt;</span> <span class="n">funcbufptr</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">fnw</span><span class="p">,</span> <span class="n">funcbufptr</span><span class="p">,</span> <span class="n">fj</span> <span class="o">-</span> <span class="n">funcbufptr</span><span class="p">);</span>
		    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		      <span class="k">if</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
			<span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fnw</span> <span class="o">+</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">funcbufptr</span><span class="p">);</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">first_free</span> <span class="o">&gt;</span> <span class="n">fj</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">fnw</span> <span class="o">+</span> <span class="p">(</span><span class="n">fj</span> <span class="o">-</span> <span class="n">funcbufptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">first_free</span> <span class="o">-</span> <span class="n">fj</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_NR_FUNC</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			  <span class="k">if</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
			    <span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fnw</span> <span class="o">+</span> <span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">funcbufptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">funcbufptr</span> <span class="o">!=</span> <span class="n">func_buf</span><span class="p">)</span>
		      <span class="n">kfree</span><span class="p">(</span><span class="n">funcbufptr</span><span class="p">);</span>
		    <span class="n">funcbufptr</span> <span class="o">=</span> <span class="n">fnw</span><span class="p">;</span>
		    <span class="n">funcbufleft</span> <span class="o">=</span> <span class="n">funcbufleft</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">funcbufsize</span><span class="p">;</span>
		    <span class="n">funcbufsize</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">func_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kbs</span><span class="o">-&gt;</span><span class="n">kb_string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">reterr:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kbs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vt_do_kdskled</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucval</span><span class="p">;</span>

        <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* the ioctls below read/set the flags usually shown in the leds */</span>
	<span class="cm">/* don&#39;t use them - they will go away without warning */</span>
	<span class="k">case</span> <span class="n">KDGKBLED</span>:
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ucval</span> <span class="o">=</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span> <span class="o">|</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">default_ledflagstate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ucval</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">KDSKBLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x77</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">default_ledflagstate</span> <span class="o">=</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">set_leds</span><span class="p">();</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* the ioctls below only set the lights, not the functions */</span>
	<span class="cm">/* for those, see KDGKBLED and KDSKBLED above */</span>
	<span class="k">case</span> <span class="n">KDGETLED</span>:
		<span class="n">ucval</span> <span class="o">=</span> <span class="n">getledstate</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ucval</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">KDSETLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">setledstate</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vt_do_kdgkbmode</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="cm">/* This is a spot read so needs no locking */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">kbdmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VC_RAW</span>:
		<span class="k">return</span> <span class="n">K_RAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VC_MEDIUMRAW</span>:
		<span class="k">return</span> <span class="n">K_MEDIUMRAW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VC_UNICODE</span>:
		<span class="k">return</span> <span class="n">K_UNICODE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VC_OFF</span>:
		<span class="k">return</span> <span class="n">K_OFF</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">K_XLATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_do_kdgkbmeta		-	report meta status</span>
<span class="cm"> *	@console: console to report</span>
<span class="cm"> *</span>
<span class="cm"> *	Report the meta flag status of this console</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_do_kdgkbmeta</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
        <span class="cm">/* Again a spot read so no locking */</span>
	<span class="k">return</span> <span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_META</span><span class="p">)</span> <span class="o">?</span> <span class="n">K_ESCPREFIX</span> <span class="o">:</span> <span class="n">K_METABIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_reset_unicode	-	reset the unicode status</span>
<span class="cm"> *	@console: console being reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Restore the unicode console state to its default</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vt_reset_unicode</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kbd_table</span><span class="p">[</span><span class="n">console</span><span class="p">].</span><span class="n">kbdmode</span> <span class="o">=</span> <span class="n">default_utf8</span> <span class="o">?</span> <span class="n">VC_UNICODE</span> <span class="o">:</span> <span class="n">VC_XLATE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_get_shiftstate	-	shift bit state</span>
<span class="cm"> *</span>
<span class="cm"> *	Report the shift bits from the keyboard state. We have to export</span>
<span class="cm"> *	this to support some oddities in the vt layer.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_get_shift_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* Don&#39;t lock as this is a transient report */</span>
        <span class="k">return</span> <span class="n">shift_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_reset_keyboard	-	reset keyboard state</span>
<span class="cm"> *	@console: console to reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Reset the keyboard bits for a console as part of a general console</span>
<span class="cm"> *	reset event</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vt_reset_keyboard</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_REPEAT</span><span class="p">);</span>
	<span class="n">clr_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CKMODE</span><span class="p">);</span>
	<span class="n">clr_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_APPLIC</span><span class="p">);</span>
	<span class="n">clr_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">VC_CRLF</span><span class="p">);</span>
	<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">lockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">slockstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledmode</span> <span class="o">=</span> <span class="n">LED_SHOW_FLAGS</span><span class="p">;</span>
	<span class="n">kbd</span><span class="o">-&gt;</span><span class="n">ledflagstate</span> <span class="o">=</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">default_ledflagstate</span><span class="p">;</span>
	<span class="cm">/* do not do set_leds here because this causes an endless tasklet loop</span>
<span class="cm">	   when the keyboard hasn&#39;t been initialized yet */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_get_kbd_mode_bit	-	read keyboard status bits</span>
<span class="cm"> *	@console: console to read from</span>
<span class="cm"> *	@bit: mode bit to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Report back a vt mode bit. We do this without locking so the</span>
<span class="cm"> *	caller must be sure that there are no synchronization needs</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">vt_get_kbd_mode_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_set_kbd_mode_bit	-	read keyboard status bits</span>
<span class="cm"> *	@console: console to read from</span>
<span class="cm"> *	@bit: mode bit to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Set a vt mode bit. We do this without locking so the</span>
<span class="cm"> *	caller must be sure that there are no synchronization needs</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">vt_set_kbd_mode_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_clr_kbd_mode_bit	-	read keyboard status bits</span>
<span class="cm"> *	@console: console to read from</span>
<span class="cm"> *	@bit: mode bit to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Report back a vt mode bit. We do this without locking so the</span>
<span class="cm"> *	caller must be sure that there are no synchronization needs</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">vt_clr_kbd_mode_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">console</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kbd_struct</span> <span class="o">*</span> <span class="n">kbd</span> <span class="o">=</span> <span class="n">kbd_table</span> <span class="o">+</span> <span class="n">console</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clr_vc_kbd_mode</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kbd_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
