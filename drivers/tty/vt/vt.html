<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › vt › vt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Hopefully this will be a rather complete VT102 implementation.</span>
<span class="cm"> *</span>
<span class="cm"> * Beeping thanks to John T Kohl.</span>
<span class="cm"> *</span>
<span class="cm"> * Virtual Consoles, Screen Blanking, Screen Dumping, Color, Graphics</span>
<span class="cm"> *   Chars, and VT100 enhancements by Peter MacDonald.</span>
<span class="cm"> *</span>
<span class="cm"> * Copy and paste function by Andrew Haylett,</span>
<span class="cm"> *   some enhancements by Alessandro Rubini.</span>
<span class="cm"> *</span>
<span class="cm"> * Code to check for different video-cards mostly by Galen Hunt,</span>
<span class="cm"> * &lt;g-hunt@ee.utah.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Rudimentary ISO 10646/Unicode/UTF-8 character set support by</span>
<span class="cm"> * Markus Kuhn, &lt;mskuhn@immd4.informatik.uni-erlangen.de&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Dynamic allocation of consoles, aeb@cwi.nl, May 1994</span>
<span class="cm"> * Resizing of consoles, aeb, 940926</span>
<span class="cm"> *</span>
<span class="cm"> * Code for xterm like mouse click reporting by Peter Orbaek 20-Jul-94</span>
<span class="cm"> * &lt;poe@daimi.aau.dk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * User-defined bell sound, new setterm control sequences and printk</span>
<span class="cm"> * redirection by Martin Mares &lt;mj@k332.feld.cvut.cz&gt; 19-Nov-95</span>
<span class="cm"> *</span>
<span class="cm"> * APM screenblank bug fixed Takashi Manabe &lt;manabe@roy.dsl.tutics.tut.jp&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Merge with the abstract console driver by Geert Uytterhoeven</span>
<span class="cm"> * &lt;geert@linux-m68k.org&gt;, Jan 1997.</span>
<span class="cm"> *</span>
<span class="cm"> *   Original m68k console driver modifications by</span>
<span class="cm"> *</span>
<span class="cm"> *     - Arno Griffioen &lt;arno@usn.nl&gt;</span>
<span class="cm"> *     - David Carter &lt;carter@cs.bris.ac.uk&gt;</span>
<span class="cm"> * </span>
<span class="cm"> *   The abstract console driver provides a generic interface for a text</span>
<span class="cm"> *   console. It supports VGA text mode, frame buffer based graphical consoles</span>
<span class="cm"> *   and special graphics processors that are only accessible through some</span>
<span class="cm"> *   registers (e.g. a TMS340x0 GSP).</span>
<span class="cm"> *</span>
<span class="cm"> *   The interface to the hardware is specified using a special structure</span>
<span class="cm"> *   (struct consw) which contains function pointers to console operations</span>
<span class="cm"> *   (see &lt;linux/console.h&gt; for more information).</span>
<span class="cm"> *</span>
<span class="cm"> * Support for changeable cursor shape</span>
<span class="cm"> * by Pavel Machek &lt;pavel@atrey.karlin.mff.cuni.cz&gt;, August 1997</span>
<span class="cm"> *</span>
<span class="cm"> * Ported to i386 and con_scrolldelta fixed</span>
<span class="cm"> * by Emmanuel Marty &lt;core@ggi-project.org&gt;, April 1998</span>
<span class="cm"> *</span>
<span class="cm"> * Resurrected character buffers in videoram plus lots of other trickery</span>
<span class="cm"> * by Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;, July 1998</span>
<span class="cm"> *</span>
<span class="cm"> * Removed old-style timers, introduced console_timer, made timer</span>
<span class="cm"> * deletion SMP-safe.  17Jun00, Andrew Morton</span>
<span class="cm"> *</span>
<span class="cm"> * Removed console_lock, enabled interrupts across all console operations</span>
<span class="cm"> * 13 March 2001, Andrew Morton</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed UTF-8 mode so alternate charset modes always work according</span>
<span class="cm"> * to control sequences interpreted in do_con_trol function</span>
<span class="cm"> * preserving backward VT100 semigraphics compatibility,</span>
<span class="cm"> * malformed UTF sequences represented as sequences of replacement glyphs,</span>
<span class="cm"> * original codes or &#39;?&#39; as a last resort if replacement glyph is undefined</span>
<span class="cm"> * by Adam Tla/lka &lt;atlka@pg.gda.pl&gt;, Aug 2006</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kd.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/selection.h&gt;</span>
<span class="cp">#include &lt;linux/tiocl.h&gt;</span>
<span class="cp">#include &lt;linux/kbd_kern.h&gt;</span>
<span class="cp">#include &lt;linux/consolemap.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/font.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/kdb.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#define MAX_NR_CON_DRIVER 16</span>

<span class="cp">#define CON_DRIVER_FLAG_MODULE 1</span>
<span class="cp">#define CON_DRIVER_FLAG_INIT   2</span>
<span class="cp">#define CON_DRIVER_FLAG_ATTR   4</span>

<span class="k">struct</span> <span class="n">con_driver</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">con</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">con_driver</span> <span class="n">registered_con_driver</span><span class="p">[</span><span class="n">MAX_NR_CON_DRIVER</span><span class="p">];</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">conswitchp</span><span class="p">;</span>

<span class="cm">/* A bitmap for codes &lt;32. A bit of 1 indicates that the code</span>
<span class="cm"> * corresponding to that bit number invokes some special action</span>
<span class="cm"> * (such as cursor movement) and should not be displayed as a</span>
<span class="cm"> * glyph unless the disp_ctrl mode is explicitly enabled.</span>
<span class="cm"> */</span>
<span class="cp">#define CTRL_ACTION 0x0d00ff81</span>
<span class="cp">#define CTRL_ALWAYS 0x0800f501	</span><span class="cm">/* Cannot be overridden by disp_ctrl */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Here is the default bell parameters: 750HZ, 1/8th of a second</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_BELL_PITCH	750</span>
<span class="cp">#define DEFAULT_BELL_DURATION	(HZ/8)</span>

<span class="k">struct</span> <span class="n">vc</span> <span class="n">vc_cons</span> <span class="p">[</span><span class="n">MAX_NR_CONSOLES</span><span class="p">];</span>

<span class="cp">#ifndef VT_SINGLE_DRIVER</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">MAX_NR_CONSOLES</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">con_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rows</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gotoxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_y</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">save_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_terminal</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">con_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_vesa_blanking</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hide_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">console_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">blank_screen_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">printable</span><span class="p">;</span>		<span class="cm">/* Is console ready for printing? */</span>
<span class="kt">int</span> <span class="n">default_utf8</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_utf8</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">global_cursor_default</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">global_cursor_default</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cur_default</span> <span class="o">=</span> <span class="n">CUR_DEFAULT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cur_default</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ignore_poke: don&#39;t unblank the screen when things are typed.  This is</span>
<span class="cm"> * mainly for the privacy of braille terminal users.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ignore_poke</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">do_poke_blanked_console</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">console_blanked</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vesa_blank_mode</span><span class="p">;</span> <span class="cm">/* 0:none 1:suspendV 2:suspendH 3:powerdown */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vesa_off_interval</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">blankinterval</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="n">core_param</span><span class="p">(</span><span class="n">consoleblank</span><span class="p">,</span> <span class="n">blankinterval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">console_work</span><span class="p">,</span> <span class="n">console_callback</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * fg_console is the current virtual console,</span>
<span class="cm"> * last_console is the last used one,</span>
<span class="cm"> * want_console is the console we want to switch to,</span>
<span class="cm"> * saved_* variants are for save/restore around kernel debugger enter/leave</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">fg_console</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">last_console</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">want_console</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_fg_console</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_last_console</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_want_console</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_vc_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_console_blanked</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * For each existing display, we have a pointer to console currently visible</span>
<span class="cm"> * on that display, allowing consoles other than fg_console to be refreshed</span>
<span class="cm"> * appropriately. Unless the low-level driver supplies its own display_fg</span>
<span class="cm"> * variable, we use this one for the &quot;master display&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">master_display_fg</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Unfortunately, we need to delay tty echo when we&#39;re currently writing to the</span>
<span class="cm"> * console since the code is (and always was) not re-entrant, so we schedule</span>
<span class="cm"> * all flip requests to process context with schedule-task() and run it from</span>
<span class="cm"> * console_callback().</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * For the same reason, we defer scrollback to the console callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scrollback_delta</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Hook so that the power management routines can (un)blank</span>
<span class="cm"> * the console on our behalf.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">console_blank_hook</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">blank_screen_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">blank_state</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">blank_timer_expired</span><span class="p">;</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">blank_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">blank_normal_wait</span><span class="p">,</span>
	<span class="n">blank_vesa_wait</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * /sys/class/tty/tty0/</span>
<span class="cm"> *</span>
<span class="cm"> * the attribute &#39;active&#39; contains the name of the current vc</span>
<span class="cm"> * console and it supports poll() to detect vc switches</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">tty0dev</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Notifier list for console events.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ATOMIC_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">vt_notifier_list</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">register_vt_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_vt_notifier</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">unregister_vt_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atomic_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">unregister_vt_notifier</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unicode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="p">,</span> <span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">unicode</span> <span class="p">};</span>
	<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">VT_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span> <span class="p">};</span>
	<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">VT_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Low-Level Functions</span>
<span class="cm"> */</span>

<span class="cp">#define IS_FG(vc)	((vc)-&gt;vc_num == fg_console)</span>

<span class="cp">#ifdef VT_BUF_VRAM_ONLY</span>
<span class="cp">#define DO_UPDATE(vc)	0</span>
<span class="cp">#else</span>
<span class="cp">#define DO_UPDATE(vc)	(CON_IS_VISIBLE(vc) &amp;&amp; !console_blanked)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="nf">screenpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">viewed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viewed</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_screen_pos</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_screen_pos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called  from the keyboard irq path.. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scrolldelta</span><span class="p">(</span><span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME */</span>
	<span class="cm">/* scrolldelta needs some kind of consistency lock, but the BKL was</span>
<span class="cm">	   and still is not protecting versus the scheduled back end */</span>
	<span class="n">scrollback_delta</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">schedule_console_callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">schedule_console_callback</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scrup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">b</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_scroll</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">SM_UP</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="n">t</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">nr</span><span class="p">));</span>
	<span class="n">scr_memmovew</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="n">nr</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="n">nr</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scrdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">step</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">nr</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">b</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_scroll</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">SM_DOWN</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="n">t</span><span class="p">);</span>
	<span class="n">step</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">*</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">scr_memmovew</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">t</span> <span class="o">-</span> <span class="n">nr</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">step</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_update_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef VT_BUF_VRAM_ONLY</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_getxy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">xx</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">%</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
		<span class="n">yy</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nxx</span><span class="p">,</span> <span class="n">nyy</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_getxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nxx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nyy</span><span class="p">);</span>
		<span class="n">xx</span> <span class="o">=</span> <span class="n">nxx</span><span class="p">;</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">nyy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">attrib</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">startx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">xx</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrib</span> <span class="o">!=</span> <span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">)</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putcs</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">startx</span><span class="p">);</span>
				<span class="n">startx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
				<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="n">attrib</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">xx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">q</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putcs</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="n">q</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">startx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">xx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">yy</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_getxy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">start</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_getxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">do_update_region</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Structure of attributes is hardware-dependent */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">build_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_color</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_intensity</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_blink</span><span class="p">,</span>
    <span class="n">u8</span> <span class="n">_underline</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_reverse</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_italic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_build_attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_build_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">_color</span><span class="p">,</span> <span class="n">_intensity</span><span class="p">,</span>
		       <span class="n">_blink</span><span class="p">,</span> <span class="n">_underline</span><span class="p">,</span> <span class="n">_reverse</span><span class="p">,</span> <span class="n">_italic</span><span class="p">);</span>

<span class="cp">#ifndef VT_BUF_VRAM_ONLY</span>
<span class="cm">/*</span>
<span class="cm"> * ++roman: I completely changed the attribute format for monochrome</span>
<span class="cm"> * mode (!can_do_color). The formerly used MDA (monochrome display</span>
<span class="cm"> * adapter) format didn&#39;t allow the combination of certain effects.</span>
<span class="cm"> * Now the attribute is just a bit vector:</span>
<span class="cm"> *  Bit 0..1: intensity (0..2)</span>
<span class="cm"> *  Bit 2   : underline</span>
<span class="cm"> *  Bit 3   : reverse</span>
<span class="cm"> *  Bit 7   : blink</span>
<span class="cm"> */</span>
	<span class="p">{</span>
	<span class="n">u8</span> <span class="n">a</span> <span class="o">=</span> <span class="n">_color</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_intensity</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">_italic</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">_underline</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">_reverse</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">_blink</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_italic</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_itcolor</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_underline</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ulcolor</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_intensity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ulcolor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_reverse</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">|</span> <span class="p">((((</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x77</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_blink</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">^=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_intensity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">^=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">a</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">=</span> <span class="n">build_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span><span class="p">,</span>
	              <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span><span class="p">,</span>
	              <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span> <span class="o">^</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decscnm</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">build_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decscnm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: inverting the screen twice should revert to the original state */</span>
<span class="kt">void</span> <span class="nf">invert_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">viewed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="n">count</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">screenpos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">viewed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_invert_region</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_invert_region</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#ifndef VT_BUF_VRAM_ONLY</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">a</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">a</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			    <span class="n">a</span> <span class="o">^=</span> <span class="mh">0x0800</span><span class="p">;</span>
			    <span class="n">scr_writew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			    <span class="n">q</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
				<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x11ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">scr_writew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
				<span class="n">q</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
				<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0700</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">scr_writew</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
				<span class="n">q</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">do_update_region</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* used by selection: complement pointer position */</span>
<span class="kt">void</span> <span class="nf">complement_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">old_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oldx</span><span class="p">,</span> <span class="n">oldy</span><span class="p">;</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">old_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">old_offset</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">screenpos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">old_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">old_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">new</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">screenpos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">^</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span><span class="p">;</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">oldx</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
			<span class="n">oldy</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">oldy</span><span class="p">,</span> <span class="n">oldx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">nr</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="p">)</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oldattr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_bmove</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">-</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="o">--</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">=</span> <span class="n">oldattr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">nr</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oldattr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_bmove</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="n">nr</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">-</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="o">--</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span>
				     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">=</span> <span class="n">oldattr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">softcursor_original</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_softcursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">type</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">softcursor_original</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">softcursor_original</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span> <span class="p">);</span>
	<span class="n">i</span> <span class="o">^=</span> <span class="p">((</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">softcursor_original</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)))</span> <span class="n">i</span> <span class="o">^=</span> <span class="mh">0x7000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x700</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="n">i</span> <span class="o">^=</span> <span class="mh">0x0700</span><span class="p">;</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hide_softcursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">softcursor_original</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">(</span><span class="n">softcursor_original</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">softcursor_original</span><span class="p">,</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
		<span class="n">softcursor_original</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hide_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">==</span> <span class="n">sel_cons</span><span class="p">)</span>
		<span class="n">clear_selection</span><span class="p">();</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">CM_ERASE</span><span class="p">);</span>
	<span class="n">hide_softcursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FG</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">||</span> <span class="n">console_blanked</span> <span class="o">||</span>
	    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_deccm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">==</span> <span class="n">sel_cons</span><span class="p">)</span>
			<span class="n">clear_selection</span><span class="p">();</span>
		<span class="n">add_softcursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">CM_DRAW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_origin</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_set_origin</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_visible_origin</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">save_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_save_screen</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_save_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Redrawing of screen</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_buffer_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">|</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_writew</span><span class="p">((</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">redraw_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">redraw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* strange ... */</span>
		<span class="cm">/* printk(&quot;redraw_screen: tty %d not allocated ??\n&quot;, new_console+1); */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">old_vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_vc</span> <span class="o">==</span> <span class="n">vc</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
			<span class="n">redraw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_display_fg</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
		<span class="n">fg_console</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">old_vc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">old_vc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">save_screen</span><span class="p">(</span><span class="n">old_vc</span><span class="p">);</span>
			<span class="n">set_origin</span><span class="p">(</span><span class="n">old_vc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty0dev</span><span class="p">)</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty0dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;active&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">redraw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">redraw</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">update</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">old_was_color</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">;</span>

		<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">update</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_switch</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If console changed from mono&lt;-&gt;color, the best we can do</span>
<span class="cm">		 * is to clear the buffer attributes. As it currently stands,</span>
<span class="cm">		 * rebuilding new attributes from the old buffer is not doable</span>
<span class="cm">		 * without overly complex code.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_was_color</span> <span class="o">!=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">clear_buffer_attributes</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Forcibly update if we&#39;re panicing */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">vt_force_oops_output</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
			<span class="n">do_update_region</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_leds</span><span class="p">();</span>
		<span class="n">compute_shiftstate</span><span class="p">();</span>
		<span class="n">notify_update</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Allocation, freeing and resizing of VTs.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">vc_cons_allocated</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span> <span class="o">&amp;&amp;</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">visual_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ++Geert: vc-&gt;vc_sw-&gt;con_init determines console size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span> <span class="o">=</span> <span class="n">conswitchp</span><span class="p">;</span>
<span class="cp">#ifndef VT_SINGLE_DRIVER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">num</span><span class="p">])</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span> <span class="o">=</span> <span class="n">con_driver_map</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_display_fg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">master_display_fg</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_panic_force_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">?</span> <span class="mh">0x7700</span> <span class="o">:</span> <span class="mh">0x0800</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_complement_mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vc_allocate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currcons</span><span class="p">)</span>	<span class="cm">/* return 0 on success */</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currcons</span> <span class="o">&gt;=</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	    <span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="n">param</span><span class="p">;</span>

	    <span class="cm">/* prevent users from taking too much memory */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">currcons</span> <span class="o">&gt;=</span> <span class="n">MAX_NR_USER_CONSOLES</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RESOURCE</span><span class="p">))</span>
	      <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	    <span class="cm">/* due to the granularity of kmalloc, we waste some memory here */</span>
	    <span class="cm">/* the alloc is done in two steps, to optimize the common situation</span>
<span class="cm">	       of a 25x80 console (structsize=216, screenbuf_size=4000) */</span>
	    <span class="cm">/* although the numbers above are not valid since long ago, the</span>
<span class="cm">	       point is still up-to-date and the comment still has its value</span>
<span class="cm">	       even if only as a historical artifact.  --mj, July 1998 */</span>
	    <span class="n">param</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	    <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
	    <span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	    <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">SAK_work</span><span class="p">,</span> <span class="n">vc_SAK</span><span class="p">);</span>
	    <span class="n">visual_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">currcons</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_uni_pagedir_loc</span><span class="p">)</span>
		<span class="n">con_set_default_unimap</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="cm">/* If no drivers have overridden us and the user didn&#39;t pass a</span>
<span class="cm">	       boot option, default to displaying the cursor */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">global_cursor_default</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		    <span class="n">global_cursor_default</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	    <span class="n">vc_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="n">vcs_make_sysfs</span><span class="p">(</span><span class="n">currcons</span><span class="p">);</span>
	    <span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">VT_ALLOCATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">resize_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Resizes the resolution of the display adapater */</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_GRAPHICS</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_resize</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_resize</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change # of rows and columns (0 means unchanged/the size of fg_console)</span>
<span class="cm"> * [this is to be used together with some user program</span>
<span class="cm"> * like resize that changes the hardware videomode]</span>
<span class="cm"> */</span>
<span class="cp">#define VC_RESIZE_MAXCOL (32767)</span>
<span class="cp">#define VC_RESIZE_MAXROW (32767)</span>

<span class="cm">/**</span>
<span class="cm"> *	vc_do_resize	-	resizing method for the tty</span>
<span class="cm"> *	@tty: tty being resized</span>
<span class="cm"> *	@real_tty: real tty (different to tty if a pty/tty pair)</span>
<span class="cm"> *	@vc: virtual console private data</span>
<span class="cm"> *	@cols: columns</span>
<span class="cm"> *	@lines: lines</span>
<span class="cm"> *</span>
<span class="cm"> *	Resize a virtual console, clipping according to the actual constraints.</span>
<span class="cm"> *	If the caller passes a tty structure then update the termios winsize</span>
<span class="cm"> *	information and perform any necessary signal handling.</span>
<span class="cm"> *</span>
<span class="cm"> *	Caller must hold the console semaphore. Takes the termios mutex and</span>
<span class="cm"> *	ctrl_lock of the tty IFF a tty is passed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vc_do_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_origin</span><span class="p">,</span> <span class="n">new_origin</span><span class="p">,</span> <span class="n">new_scr_end</span><span class="p">,</span> <span class="n">rlth</span><span class="p">,</span> <span class="n">rrem</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_rows</span><span class="p">,</span> <span class="n">old_row_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_cols</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">,</span> <span class="n">new_row_size</span><span class="p">,</span> <span class="n">new_screen_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">newscreen</span><span class="p">;</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">user</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_resize_user</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_resize_user</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cols</span> <span class="o">&gt;</span> <span class="n">VC_RESIZE_MAXCOL</span> <span class="o">||</span> <span class="n">lines</span> <span class="o">&gt;</span> <span class="n">VC_RESIZE_MAXROW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">new_cols</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">?</span> <span class="n">cols</span> <span class="o">:</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">);</span>
	<span class="n">new_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span> <span class="o">?</span> <span class="n">lines</span> <span class="o">:</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
	<span class="n">new_row_size</span> <span class="o">=</span> <span class="n">new_cols</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">new_screen_size</span> <span class="o">=</span> <span class="n">new_row_size</span> <span class="o">*</span> <span class="n">new_rows</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_cols</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">&amp;&amp;</span> <span class="n">new_rows</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">newscreen</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">new_screen_size</span><span class="p">,</span> <span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newscreen</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">old_rows</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
	<span class="n">old_row_size</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">resize_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">newscreen</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">=</span> <span class="n">new_rows</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">=</span> <span class="n">new_cols</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">=</span> <span class="n">new_row_size</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">=</span> <span class="n">new_screen_size</span><span class="p">;</span>

	<span class="n">rlth</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">old_row_size</span><span class="p">,</span> <span class="n">new_row_size</span><span class="p">);</span>
	<span class="n">rrem</span> <span class="o">=</span> <span class="n">new_row_size</span> <span class="o">-</span> <span class="n">rlth</span><span class="p">;</span>
	<span class="n">old_origin</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="n">new_origin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">newscreen</span><span class="p">;</span>
	<span class="n">new_scr_end</span> <span class="o">=</span> <span class="n">new_origin</span> <span class="o">+</span> <span class="n">new_screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&gt;</span> <span class="n">new_rows</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&lt;</span> <span class="n">new_rows</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Cursor near the bottom, copy contents from the</span>
<span class="cm">			 * bottom of buffer</span>
<span class="cm">			 */</span>
			<span class="n">old_origin</span> <span class="o">+=</span> <span class="p">(</span><span class="n">old_rows</span> <span class="o">-</span> <span class="n">new_rows</span><span class="p">)</span> <span class="o">*</span> <span class="n">old_row_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Cursor is in no man&#39;s land, copy 1/2 screenful</span>
<span class="cm">			 * from the top and bottom of cursor position</span>
<span class="cm">			 */</span>
			<span class="n">old_origin</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">-</span> <span class="n">new_rows</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">old_row_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">old_origin</span> <span class="o">+</span> <span class="n">old_row_size</span> <span class="o">*</span> <span class="n">min</span><span class="p">(</span><span class="n">old_rows</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">);</span>

	<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">old_origin</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scr_memcpyw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_origin</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">old_origin</span><span class="p">,</span> <span class="n">rlth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrem</span><span class="p">)</span>
			<span class="n">scr_memsetw</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">new_origin</span> <span class="o">+</span> <span class="n">rlth</span><span class="p">),</span>
				    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="n">rrem</span><span class="p">);</span>
		<span class="n">old_origin</span> <span class="o">+=</span> <span class="n">old_row_size</span><span class="p">;</span>
		<span class="n">new_origin</span> <span class="o">+=</span> <span class="n">new_row_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_scr_end</span> <span class="o">&gt;</span> <span class="n">new_origin</span><span class="p">)</span>
		<span class="n">scr_memsetw</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">new_origin</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span>
			    <span class="n">new_scr_end</span> <span class="o">-</span> <span class="n">new_origin</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span> <span class="o">=</span> <span class="n">newscreen</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">=</span> <span class="n">new_screen_size</span><span class="p">;</span>
	<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="cm">/* do part of a reset_terminal() */</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">);</span>
	<span class="n">save_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Rewrite the requested winsize data with the actual</span>
<span class="cm">		   resulting sizes */</span>
		<span class="k">struct</span> <span class="n">winsize</span> <span class="n">ws</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ws</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ws</span><span class="p">));</span>
		<span class="n">ws</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
		<span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
		<span class="n">ws</span><span class="p">.</span><span class="n">ws_ypixel</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_scan_lines</span><span class="p">;</span>
		<span class="n">tty_do_resize</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">update_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">vt_event_post</span><span class="p">(</span><span class="n">VT_EVENT_RESIZE</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vc_resize		-	resize a VT</span>
<span class="cm"> *	@vc: virtual console</span>
<span class="cm"> *	@cols: columns</span>
<span class="cm"> *	@rows: rows</span>
<span class="cm"> *</span>
<span class="cm"> *	Resize a virtual console as seen from the console end of things. We</span>
<span class="cm"> *	use the common vc_do_resize methods to update the structures. The</span>
<span class="cm"> *	caller must hold the console sem to protect console internals and</span>
<span class="cm"> *	vc-&gt;port.tty</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">vc_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rows</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vc_do_resize</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	vt_resize		-	resize a VT</span>
<span class="cm"> *	@tty: tty to resize</span>
<span class="cm"> *	@ws: winsize attributes</span>
<span class="cm"> *</span>
<span class="cm"> *	Resize a virtual terminal. This is called by the tty layer as we</span>
<span class="cm"> *	register our own handler for resizing. The mutual helper does all</span>
<span class="cm"> *	the actual work.</span>
<span class="cm"> *</span>
<span class="cm"> *	Takes the console sem and the called methods then take the tty</span>
<span class="cm"> *	termios_mutex and the tty ctrl_lock in that order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">winsize</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vc_do_resize</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_col</span><span class="p">,</span> <span class="n">ws</span><span class="o">-&gt;</span><span class="n">ws_row</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vc_deallocate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currcons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">currcons</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span> <span class="p">};</span>

		<span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">VT_DEALLOCATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="n">vcs_remove_sysfs</span><span class="p">(</span><span class="n">currcons</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_deinit</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">put_pid</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vt_pid</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">currcons</span> <span class="o">&gt;=</span> <span class="n">MIN_NR_CONSOLES</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	VT102 emulator</span>
<span class="cm"> */</span>

<span class="cp">#define set_kbd(vc, x)	vt_set_kbd_mode_bit((vc)-&gt;vc_num, (x))</span>
<span class="cp">#define clr_kbd(vc, x)	vt_clr_kbd_mode_bit((vc)-&gt;vc_num, (x))</span>
<span class="cp">#define is_kbd(vc, x)	vt_get_kbd_mode_bit((vc)-&gt;vc_num, (x))</span>

<span class="cp">#define decarm		VC_REPEAT</span>
<span class="cp">#define decckm		VC_CKMODE</span>
<span class="cp">#define kbdapplic	VC_APPLIC</span>
<span class="cp">#define lnm		VC_CRLF</span>

<span class="cm">/*</span>
<span class="cm"> * this is what the terminal answers to a ESC-Z or csi0c query.</span>
<span class="cm"> */</span>
<span class="cp">#define VT100ID &quot;\033[?1;2c&quot;</span>
<span class="cp">#define VT102ID &quot;\033[?6c&quot;</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">color_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
				       <span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span> <span class="p">};</span>

<span class="cm">/* the default colour table, for VGA+ colour systems */</span>
<span class="kt">int</span> <span class="n">default_red</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span>
    <span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">default_grn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span>
    <span class="mh">0x55</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">default_blu</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span>
    <span class="mh">0x55</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">default_red</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">default_grn</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">default_blu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * gotoxy() must verify all boundaries, because the arguments</span>
<span class="cm"> * might also be negative. If the given position is out of</span>
<span class="cm"> * bounds, the cursor is placed at the nearest margin.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gotoxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_x</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">=</span> <span class="n">new_x</span><span class="p">;</span>
	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min_y</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span><span class="p">;</span>
		<span class="n">max_y</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max_y</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_y</span> <span class="o">&lt;</span> <span class="n">min_y</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">=</span> <span class="n">min_y</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_y</span> <span class="o">&gt;=</span> <span class="n">max_y</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">=</span> <span class="n">new_y</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">+</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* for absolute user moves, when decom is set */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gotoxay</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decom</span> <span class="o">?</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span> <span class="o">+</span> <span class="n">new_y</span><span class="p">)</span> <span class="o">:</span> <span class="n">new_y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">scrollback</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lines</span><span class="p">)</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">scrolldelta</span><span class="p">(</span><span class="o">-</span><span class="n">lines</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">scrollfront</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lines</span><span class="p">)</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">scrolldelta</span><span class="p">(</span><span class="n">lines</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
    	<span class="cm">/* don&#39;t scroll if above bottom of scrolling region, or</span>
<span class="cm">	 * if below scrolling region</span>
<span class="cm">	 */</span>
    	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">)</span>
		<span class="n">scrup</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ri</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
    	<span class="cm">/* don&#39;t scroll if below top of scrolling region, or</span>
<span class="cm">	 * if above scrolling region</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span><span class="p">)</span>
		<span class="n">scrdown</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="o">--</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bs</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">--</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;\b&#39;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">del</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ignored */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_J</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpar</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* erase from cursor to end of display */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_scr_end</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* do in two stages */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* erase from start to cursor */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* do in two stages */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* erase scroll-back buffer (and whole display) */</span>
			<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span>
				    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
				<span class="n">update_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* erase whole display */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_K</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpar</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* erase from cursor to end of line */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* erase from start of line to cursor */</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* erase whole line */</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scr_memsetw</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_X</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpar</span><span class="p">)</span> <span class="cm">/* erase the following vpar positions */</span>
<span class="p">{</span>					  <span class="cm">/* not vt100? */</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpar</span><span class="p">)</span>
		<span class="n">vpar</span><span class="o">++</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpar</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">)</span> <span class="o">:</span> <span class="n">vpar</span><span class="p">;</span>

	<span class="n">scr_memsetw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_clear</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_m</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* all attributes off */</span>
				<span class="n">default_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* ANSI X3.64-1979 (SCO-ish?)</span>
<span class="cm">				  * Select primary font, don&#39;t display</span>
<span class="cm">				  * control chars if defined, don&#39;t set</span>
<span class="cm">				  * bit 8 on output.</span>
<span class="cm">				  */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">==</span> <span class="mi">0</span>
						<span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span>
						<span class="o">:</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_toggle_meta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* ANSI X3.64-1979 (SCO-ish?)</span>
<span class="cm">				  * Select first alternate font, lets</span>
<span class="cm">				  * chars &lt; 32 be displayed as ROM chars.</span>
<span class="cm">				  */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">IBMPC_MAP</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_toggle_meta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>: <span class="cm">/* ANSI X3.64-1979 (SCO-ish?)</span>
<span class="cm">				  * Select second alternate font, toggle</span>
<span class="cm">				  * high bit before displaying as ROM char.</span>
<span class="cm">				  */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">IBMPC_MAP</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_toggle_meta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">21</span>:
			<span class="k">case</span> <span class="mi">22</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">23</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">25</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">27</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">38</span>: <span class="cm">/* ANSI X3.64-1979 (SCO-ish?)</span>
<span class="cm">				  * Enables underscore, white foreground</span>
<span class="cm">				  * with white underscore (Linux - use</span>
<span class="cm">				  * default foreground).</span>
<span class="cm">				  */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">39</span>: <span class="cm">/* ANSI X3.64-1979 (SCO-ish?)</span>
<span class="cm">				  * Disable underline option.</span>
<span class="cm">				  * Reset colour to default? It did this</span>
<span class="cm">				  * before...</span>
<span class="cm">				  */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">49</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">37</span><span class="p">)</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="n">color_table</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">30</span><span class="p">]</span>
						<span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">40</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">47</span><span class="p">)</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
						<span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">respond_string</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">con_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cursor_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[%d;%dR&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decom</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">respond_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">status_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">respond_string</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\033</span><span class="s">[0n&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>	<span class="cm">/* Terminal ok */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">respond_ID</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">respond_string</span><span class="p">(</span><span class="n">VT102ID</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mouse_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">butt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mrx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[M%c%c%c&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="sc">&#39; &#39;</span> <span class="o">+</span> <span class="n">butt</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="sc">&#39;!&#39;</span> <span class="o">+</span> <span class="n">mrx</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="sc">&#39;!&#39;</span> <span class="o">+</span> <span class="n">mry</span><span class="p">));</span>
	<span class="n">respond_string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* invoked via ioctl(TIOCLINUX) and through set_selection */</span>
<span class="kt">int</span> <span class="nf">mouse_reporting</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_report_mouse</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/* DEC private modes set/reset */</span>
			<span class="k">case</span> <span class="mi">1</span>:			<span class="cm">/* Cursor keys send ^[Ox/^[[x */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">on_off</span><span class="p">)</span>
					<span class="n">set_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">decckm</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">clr_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">decckm</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* 80/132 mode switch unimplemented */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_deccolm</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">				vc_resize(deccolm ? 132 : 80, vc-&gt;vc_rows);</span>
<span class="c">				/* this alone does not suffice; some user mode</span>
<span class="c">				   utility has to change the hardware regs */</span>
<span class="cp">#endif</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:			<span class="cm">/* Inverted screen on/off */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decscnm</span> <span class="o">!=</span> <span class="n">on_off</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decscnm</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
					<span class="n">invert_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:			<span class="cm">/* Origin relative/absolute */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decom</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
				<span class="n">gotoxay</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:			<span class="cm">/* Autowrap on/off */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decawm</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:			<span class="cm">/* Autorepeat on/off */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">on_off</span><span class="p">)</span>
					<span class="n">set_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">decarm</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">clr_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">decarm</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">9</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_report_mouse</span> <span class="o">=</span> <span class="n">on_off</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">25</span>:		<span class="cm">/* Cursor on/off */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_deccm</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1000</span>:
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_report_mouse</span> <span class="o">=</span> <span class="n">on_off</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/* ANSI modes set/reset */</span>
			<span class="k">case</span> <span class="mi">3</span>:			<span class="cm">/* Monitor (display ctrls) */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:			<span class="cm">/* Insert Mode on/off */</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decim</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">20</span>:		<span class="cm">/* Lf, Enter == CrLf/Lf */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">on_off</span><span class="p">)</span>
					<span class="n">set_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">lnm</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">clr_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">lnm</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setterm_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* set color for underline mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">&amp;&amp;</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ulcolor</span> <span class="o">=</span> <span class="n">color_table</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span><span class="p">)</span>
					<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* set color for half intensity mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">&amp;&amp;</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_halfcolor</span> <span class="o">=</span> <span class="n">color_table</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:	<span class="cm">/* store colors as defaults */</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">default_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:	<span class="cm">/* set blanking interval */</span>
			<span class="n">blankinterval</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
			<span class="n">poke_blanked_console</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* set bell frequency in Hz */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_pitch</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_pitch</span> <span class="o">=</span> <span class="n">DEFAULT_BELL_PITCH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* set bell duration in msec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_duration</span> <span class="o">=</span> <span class="n">DEFAULT_BELL_DURATION</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>: <span class="cm">/* bring specified console to the front */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">set_console</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">13</span>: <span class="cm">/* unblank the screen */</span>
			<span class="n">poke_blanked_console</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">14</span>: <span class="cm">/* set vesa powerdown interval */</span>
			<span class="n">vesa_off_interval</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">15</span>: <span class="cm">/* activate the previous console */</span>
			<span class="n">set_console</span><span class="p">(</span><span class="n">last_console</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_at</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">insert_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_L</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scrdown</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_P</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">delete_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi_M</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">nr</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">scrup</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held (except via vc_init-&gt;reset_terminal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">save_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_x</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_y</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_intensity</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_italic</span>         <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_underline</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_blink</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_reverse</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_charset</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_color</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_G0</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_G1</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">restore_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_y</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_intensity</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_intensity</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_italic</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_italic</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_underline</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_underline</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_blink</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_blink</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_reverse</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_reverse</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_charset</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_color</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_color</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_G0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span>	<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_saved_G1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span>	<span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span> <span class="o">:</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
	<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">ESnormal</span><span class="p">,</span> <span class="n">ESesc</span><span class="p">,</span> <span class="n">ESsquare</span><span class="p">,</span> <span class="n">ESgetpars</span><span class="p">,</span> <span class="n">ESgotpars</span><span class="p">,</span> <span class="n">ESfunckey</span><span class="p">,</span>
	<span class="n">EShash</span><span class="p">,</span> <span class="n">ESsetG0</span><span class="p">,</span> <span class="n">ESsetG1</span><span class="p">,</span> <span class="n">ESpercent</span><span class="p">,</span> <span class="n">ESignore</span><span class="p">,</span> <span class="n">ESnonstd</span><span class="p">,</span>
	<span class="n">ESpalette</span> <span class="p">};</span>

<span class="cm">/* console_lock is held (except via vc_init()) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_terminal</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span>		<span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span>		<span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span>	<span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">LAT1_MAP</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span>	<span class="o">=</span> <span class="n">LAT1_MAP</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span>	<span class="o">=</span> <span class="n">GRAF_MAP</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_report_mouse</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span>              <span class="o">=</span> <span class="n">default_utf8</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_toggle_meta</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decscnm</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decom</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decawm</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_deccm</span>		<span class="o">=</span> <span class="n">global_cursor_default</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decim</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vt_reset_keyboard</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">);</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span> <span class="o">=</span> <span class="n">cur_default</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_complement_mask</span><span class="p">;</span>

	<span class="n">default_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x01010100</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>	<span class="o">=</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x01010101</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_pitch</span> <span class="o">=</span> <span class="n">DEFAULT_BELL_PITCH</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_duration</span> <span class="o">=</span> <span class="n">DEFAULT_BELL_DURATION</span><span class="p">;</span>

	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">save_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_clear</span><span class="p">)</span>
	    <span class="n">csi_J</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* console_lock is held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_con_trol</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Control characters can be used in the _middle_</span>
<span class="cm">	 *  of an escape sequence.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_duration</span><span class="p">)</span>
			<span class="n">kd_mksound</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_pitch</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bell_duration</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">bs</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">-=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;\t&#39;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>: <span class="k">case</span> <span class="mi">11</span>: <span class="k">case</span> <span class="mi">12</span>:
		<span class="n">lf</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">lnm</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">cr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>: <span class="k">case</span> <span class="mi">26</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">27</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESesc</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">127</span>:
		<span class="n">del</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span><span class="o">+</span><span class="mi">27</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESsquare</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESesc</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;[&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESsquare</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;]&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnonstd</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;%&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESpercent</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="n">cr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">lf</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="n">ri</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="n">lf</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
			<span class="n">respond_ID</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;7&#39;</span>:
			<span class="n">save_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;8&#39;</span>:
			<span class="n">restore_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;(&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESsetG0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;)&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESsetG1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;#&#39;</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">EShash</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="n">reset_terminal</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:  <span class="cm">/* Numeric keypad */</span>
			<span class="n">clr_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">kbdapplic</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:  <span class="cm">/* Appl. keypad */</span>
			<span class="n">set_kbd</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">kbdapplic</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESnonstd</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="sc">&#39;P&#39;</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* palette escape sequence */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">&lt;</span> <span class="n">NPAR</span><span class="p">;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="o">++</span><span class="p">)</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESpalette</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* reset palette */</span>
			<span class="n">reset_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESpalette</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESsquare</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">&lt;</span> <span class="n">NPAR</span><span class="p">;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESgetpars</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Function key */</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span><span class="o">=</span><span class="n">ESfunckey</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESgetpars</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">&lt;</span> <span class="n">NPAR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">&gt;=</span><span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">&lt;=</span><span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESgotpars</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESgotpars</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
			<span class="n">set_mode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="n">set_mode</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cursor_type</span> <span class="o">=</span> <span class="n">cur_default</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">clear_selection</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_complement_mask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_s_complement_mask</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">status_report</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">cursor_report</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ques</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>: <span class="k">case</span> <span class="sc">&#39;`&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;A&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;B&#39;</span>: <span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;C&#39;</span>: <span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">-</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="n">gotoxay</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="p">,</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>: <span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
			<span class="n">gotoxay</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;J&#39;</span>:
			<span class="n">csi_J</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="n">csi_K</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
			<span class="n">csi_L</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="n">csi_M</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;P&#39;</span>:
			<span class="n">csi_P</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">respond_ID</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_tab_stop</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="n">csi_m</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;q&#39;</span>: <span class="cm">/* DECLL - but only 3 leds */</span>
			<span class="cm">/* map 0,1,2,3 to 0,1,2,4 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">vt_set_led_state</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
			<span class="cm">/* Minimum allowed region is 2 lines */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_top</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_bottom</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">gotoxay</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="n">save_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="n">restore_cur</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
			<span class="n">csi_X</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:
			<span class="n">csi_at</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;]&#39;</span>: <span class="cm">/* setterm functions */</span>
			<span class="n">setterm_command</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESpercent</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;@&#39;</span>:  <span class="cm">/* defined in ISO 2022 */</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:  <span class="cm">/* prelim official escape code */</span>
		<span class="k">case</span> <span class="sc">&#39;8&#39;</span>:  <span class="cm">/* retained for compatibility */</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESfunckey</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EShash</span>:
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DEC screen alignment test. kludge :-) */</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
			<span class="n">csi_J</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_video_erase_char</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">do_update_region</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESsetG0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span> <span class="o">=</span> <span class="n">GRAF_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span> <span class="o">=</span> <span class="n">LAT1_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;U&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span> <span class="o">=</span> <span class="n">IBMPC_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;K&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span> <span class="o">=</span> <span class="n">USER_MAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G0_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESsetG1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span> <span class="o">=</span> <span class="n">GRAF_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span> <span class="o">=</span> <span class="n">LAT1_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;U&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span> <span class="o">=</span> <span class="n">IBMPC_MAP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;K&#39;</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span> <span class="o">=</span> <span class="n">USER_MAP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_charset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_translate</span> <span class="o">=</span> <span class="n">set_translate</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_G1_charset</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">=</span> <span class="n">ESnormal</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* is_double_width() is based on the wcwidth() implementation by</span>
<span class="cm"> * Markus Kuhn -- 2007-05-26 (Unicode 5.0)</span>
<span class="cm"> * Latest version: http://www.cl.cam.ac.uk/~mgk25/ucs/wcwidth.c</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">interval</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">first</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">last</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bisearch</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">ucs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">interval</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span> <span class="o">&lt;</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">first</span> <span class="o">||</span> <span class="n">ucs</span> <span class="o">&gt;</span> <span class="n">table</span><span class="p">[</span><span class="n">max</span><span class="p">].</span><span class="n">last</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;=</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span> <span class="o">+</span> <span class="n">max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span> <span class="o">&gt;</span> <span class="n">table</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">last</span><span class="p">)</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ucs</span> <span class="o">&lt;</span> <span class="n">table</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">first</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_double_width</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">ucs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">interval</span> <span class="n">double_width</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1100</span><span class="p">,</span> <span class="mh">0x115F</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2329</span><span class="p">,</span> <span class="mh">0x232A</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x2E80</span><span class="p">,</span> <span class="mh">0x303E</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x3040</span><span class="p">,</span> <span class="mh">0xA4CF</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xAC00</span><span class="p">,</span> <span class="mh">0xD7A3</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xF900</span><span class="p">,</span> <span class="mh">0xFAFF</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xFE10</span><span class="p">,</span> <span class="mh">0xFE19</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xFE30</span><span class="p">,</span> <span class="mh">0xFE6F</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0xFF60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xFFE0</span><span class="p">,</span> <span class="mh">0xFFE6</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x20000</span><span class="p">,</span> <span class="mh">0x2FFFD</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x30000</span><span class="p">,</span> <span class="mh">0x3FFFD</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">bisearch</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">double_width</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">double_width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* acquires console_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_con_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef VT_BUF_VRAM_ONLY</span>
<span class="cp">#define FLUSH do { } while(0);</span>
<span class="cp">#else</span>
<span class="cp">#define FLUSH if (draw_x &gt;= 0) { \</span>
<span class="cp">	vc-&gt;vc_sw-&gt;con_putcs(vc, (u16 *)draw_from, (u16 *)draw_to - (u16 *)draw_from, vc-&gt;vc_y, draw_x); \</span>
<span class="cp">	draw_x = -1; \</span>
<span class="cp">	}</span>
<span class="cp">#endif</span>

	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">draw_x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currcons</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">draw_from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">draw_to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vc_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">inverse</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">himask</span><span class="p">,</span> <span class="n">charmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">vc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vt: argh, driver_data is NULL !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">currcons</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">currcons</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* could this happen? */</span>
		<span class="n">pr_warn_once</span><span class="p">(</span><span class="s">&quot;con_write: tty %d not allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">currcons</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">himask</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span><span class="p">;</span>
	<span class="n">charmask</span> <span class="o">=</span> <span class="n">himask</span> <span class="o">?</span> <span class="mh">0x1ff</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* undraw cursor first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FG</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="n">param</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">orig</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">orig</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">rescan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">inverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Do no translation at all in control states */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">!=</span> <span class="n">ESnormal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tc</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/* Combine UTF-8 into Unicode in vc_utf_char.</span>
<span class="cm">		     * vc_utf_count is the number of continuation bytes still</span>
<span class="cm">		     * expected to arrive.</span>
<span class="cm">		     * vc_npar is the number of continuation bytes arrived so</span>
<span class="cm">		     * far</span>
<span class="cm">		     */</span>
<span class="nl">rescan_last_byte:</span>
		    <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Continuation byte received */</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">utf8_length_changes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0000007f</span><span class="p">,</span> <span class="mh">0x000007ff</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="mh">0x001fffff</span><span class="p">,</span> <span class="mh">0x03ffffff</span><span class="p">,</span> <span class="mh">0x7fffffff</span> <span class="p">};</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span><span class="p">)</span> <span class="p">{</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="o">++</span><span class="p">;</span>
			    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Still need some bytes */</span>
				<span class="k">continue</span><span class="p">;</span>
			    <span class="p">}</span>
			    <span class="cm">/* Got a whole character */</span>
			    <span class="n">c</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span><span class="p">;</span>
			    <span class="cm">/* Reject overlong sequences */</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="n">utf8_length_changes</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
					<span class="n">c</span> <span class="o">&gt;</span> <span class="n">utf8_length_changes</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span><span class="p">])</span>
				<span class="n">c</span> <span class="o">=</span> <span class="mh">0xfffd</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			    <span class="cm">/* Unexpected continuation byte */</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">c</span> <span class="o">=</span> <span class="mh">0xfffd</span><span class="p">;</span>
			<span class="p">}</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Single ASCII byte or first byte of a sequence received */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span><span class="p">)</span> <span class="p">{</span>
			    <span class="cm">/* Continuation byte expected */</span>
			    <span class="n">rescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">c</span> <span class="o">=</span> <span class="mh">0xfffd</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
			    <span class="cm">/* First byte of a multibyte sequence received */</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_char</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* 254 and 255 are invalid */</span>
				<span class="n">c</span> <span class="o">=</span> <span class="mh">0xfffd</span><span class="p">;</span>
			    <span class="p">}</span>
			    <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Still need some bytes */</span>
				<span class="k">continue</span><span class="p">;</span>
			    <span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Nothing to do if an ASCII byte was received */</span>
		    <span class="p">}</span>
		    <span class="cm">/* End of UTF-8 decoding. */</span>
		    <span class="cm">/* c is the received character, or U+FFFD for invalid sequences. */</span>
		    <span class="cm">/* Replace invalid Unicode code points with U+FFFD too */</span>
		    <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mh">0xd800</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mh">0xdfff</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mh">0xfffe</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="mh">0xfffd</span><span class="p">;</span>
		    <span class="n">tc</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* no utf or alternate charset mode */</span>
		    <span class="n">tc</span> <span class="o">=</span> <span class="n">vc_translate</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">param</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_list</span><span class="p">,</span> <span class="n">VT_PREWRITE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

                <span class="cm">/* If the original code was a control character we</span>
<span class="cm">                 * only allow a glyph to be displayed if the code is</span>
<span class="cm">                 * not normally used (such as for cursor movement) or</span>
<span class="cm">                 * if the disp_ctrl mode has been explicitly enabled.</span>
<span class="cm">                 * Certain characters (as given by the CTRL_ALWAYS</span>
<span class="cm">                 * bitmap) are always displayed as control characters,</span>
<span class="cm">                 * as the console would be pretty useless without</span>
<span class="cm">                 * them; to display an arbitrary font position use the</span>
<span class="cm">                 * direct-to-font zone in UTF-8 mode.</span>
<span class="cm">                 */</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">tc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">||</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span> <span class="o">?</span> <span class="p">(</span><span class="n">CTRL_ALWAYS</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">:</span>
				  <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">||</span> <span class="p">((</span><span class="n">CTRL_ACTION</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">127</span> <span class="o">||</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">128</span><span class="o">+</span><span class="mi">27</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_state</span> <span class="o">==</span> <span class="n">ESnormal</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_double_width</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
					<span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Now try to find out how to display it */</span>
			<span class="n">tc</span> <span class="o">=</span> <span class="n">conv_uni_to_pc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">charmask</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">tc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">continue</span><span class="p">;</span> <span class="cm">/* nothing to display */</span>
				<span class="p">}</span>
				<span class="cm">/* Glyph not found */</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_disp_ctrl</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">charmask</span><span class="p">))</span> <span class="p">{</span>
				    <span class="cm">/* In legacy mode use the glyph we get by a 1:1 mapping.</span>
<span class="cm">				       This would make absolutely no sense with Unicode in mind,</span>
<span class="cm">				       but do this for ASCII characters since a font may lack</span>
<span class="cm">				       Unicode mapping info and we don&#39;t want to end up with</span>
<span class="cm">				       having question marks only. */</span>
				    <span class="n">tc</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				    <span class="cm">/* Display U+FFFD. If it&#39;s not found, display an inverse question mark. */</span>
				    <span class="n">tc</span> <span class="o">=</span> <span class="n">conv_uni_to_pc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mh">0xfffd</span><span class="p">);</span>
				    <span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">inverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">tc</span> <span class="o">=</span> <span class="n">conv_uni_to_pc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39;?&#39;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">tc</span> <span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
				    <span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inverse</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc_attr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* invert vc_attr */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vc_attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vc_attr</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">vc_attr</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">FLUSH</span>
			<span class="p">}</span>

			<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">||</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decim</span><span class="p">)</span>
					<span class="n">FLUSH</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
					<span class="n">lf</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decim</span><span class="p">)</span>
					<span class="n">insert_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">scr_writew</span><span class="p">(</span><span class="n">himask</span> <span class="o">?</span>
					     <span class="p">((</span><span class="n">vc_attr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">himask</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">?</span> <span class="n">himask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">:</span>
					     <span class="p">(</span><span class="n">vc_attr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">tc</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">DO_UPDATE</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">draw_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">draw_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
					<span class="n">draw_from</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_decawm</span><span class="p">;</span>
					<span class="n">draw_to</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">++</span><span class="p">;</span>
					<span class="n">draw_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">width</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

				<span class="n">tc</span> <span class="o">=</span> <span class="n">conv_uni_to_pc</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span> <span class="cm">/* A space is printed in the second column */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">tc</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">inverse</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FLUSH</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rescan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rescan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">inverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">orig</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">rescan_last_byte</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">FLUSH</span>
		<span class="n">do_con_trol</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">FLUSH</span>
	<span class="n">console_conditional_schedule</span><span class="p">();</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="n">notify_update</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="cp">#undef FLUSH</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the console switching callback.</span>
<span class="cm"> *</span>
<span class="cm"> * Doing console switching in a process context allows</span>
<span class="cm"> * us to do the switches asynchronously (needed when we want</span>
<span class="cm"> * to switch due to a keyboard interrupt).  Synchronization</span>
<span class="cm"> * with other console code and prevention of re-entrancy is</span>
<span class="cm"> * ensured with console_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">console_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">console_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">want_console</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">want_console</span> <span class="o">!=</span> <span class="n">fg_console</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">want_console</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
			<span class="n">change_console</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">want_console</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
			<span class="cm">/* we only changed when the console had already</span>
<span class="cm">			   been allocated - a new console is not created</span>
<span class="cm">			   in an interrupt routine */</span>
		<span class="p">}</span>
		<span class="n">want_console</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_poke_blanked_console</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* do not unblank for a LED change */</span>
		<span class="n">do_poke_blanked_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">poke_blanked_console</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scrollback_delta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
		<span class="n">clear_selection</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_TEXT</span><span class="p">)</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_scrolldelta</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">scrollback_delta</span><span class="p">);</span>
		<span class="n">scrollback_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank_timer_expired</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_blank_screen</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">blank_timer_expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">notify_update</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>

	<span class="n">console_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">set_console</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">||</span> <span class="n">vt_dont_switch</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vt_mode</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">VT_AUTO</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_GRAPHICS</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Console switch will fail in console_callback() or</span>
<span class="cm">		 * change_console() so there is no point scheduling</span>
<span class="cm">		 * the callback</span>
<span class="cm">		 *</span>
<span class="cm">		 * Existing set_console() users don&#39;t check the return</span>
<span class="cm">		 * value so this shouldn&#39;t break anything</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">want_console</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">schedule_console_callback</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">console_driver</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VT_CONSOLE</span>

<span class="cm">/**</span>
<span class="cm"> * vt_kmsg_redirect() - Sets/gets the kernel message console</span>
<span class="cm"> * @new:	The new virtual terminal number or -1 if the console should stay</span>
<span class="cm"> * 		unchanged</span>
<span class="cm"> *</span>
<span class="cm"> * By default, the kernel messages are always printed on the current virtual</span>
<span class="cm"> * console. However, the user may modify that default with the</span>
<span class="cm"> * TIOCL_SETKMSGREDIRECT ioctl call.</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets the kernel message console to be @new. It returns the old</span>
<span class="cm"> * virtual console number. The virtual terminal number 0 (both as parameter and</span>
<span class="cm"> * return value) means no redirection (i.e. always printed on the currently</span>
<span class="cm"> * active console).</span>
<span class="cm"> *</span>
<span class="cm"> * The parameter -1 means that only the current console is returned, but the</span>
<span class="cm"> * value is not modified. You may use the macro vt_get_kmsg_redirect() in that</span>
<span class="cm"> * case to make the code more understandable.</span>
<span class="cm"> *</span>
<span class="cm"> * When the kernel is compiled without CONFIG_VT_CONSOLE, this function ignores</span>
<span class="cm"> * the parameter and always returns 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">vt_kmsg_redirect</span><span class="p">(</span><span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">kmsg_con</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kmsg_con</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">kmsg_con</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Console on virtual terminal</span>
<span class="cm"> *</span>
<span class="cm"> * The console must be locked when we get here.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt_console_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">printing_lock</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">ushort</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">myx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kmsg_console</span><span class="p">;</span>

	<span class="cm">/* console busy or not yet initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">printing_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kmsg_console</span> <span class="o">=</span> <span class="n">vt_get_kmsg_redirect</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kmsg_console</span> <span class="o">&amp;&amp;</span> <span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">kmsg_console</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">kmsg_console</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

	<span class="cm">/* read `x&#39; only after setting currcons properly (otherwise</span>
<span class="cm">	   the `x&#39; macro will read the x of the foreground console). */</span>
	<span class="n">myx</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">fg_console</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* impossible */</span>
		<span class="cm">/* printk(&quot;vt_console_print: tty %d not allocated ??\n&quot;, currcons+1); */</span>
		<span class="k">goto</span> <span class="n">quit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vt_force_oops_output</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">quit</span><span class="p">;</span>

	<span class="cm">/* undraw cursor first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FG</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>

	<span class="cm">/* Contrived structure to try to emulate original need_wrap behaviour</span>
<span class="cm">	 * Problems caused when we have need_wrap set on &#39;\n&#39; character */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">13</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putcs</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span><span class="p">)</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">--</span><span class="p">;</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* backspace */</span>
				<span class="n">bs</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
				<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
				<span class="n">myx</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span>
				<span class="n">lf</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">cr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
			<span class="n">myx</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">scr_writew</span><span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">);</span>
		<span class="n">notify_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">myx</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">myx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_putcs</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="o">--</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_need_wrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">notify_update</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

<span class="nl">quit:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">printing_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="nf">vt_console_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">fg_console</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">console_driver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">vt_console_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tty&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">vt_console_print</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">vt_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unblank</span>	<span class="o">=</span> <span class="n">unblank_screen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Handling of Linux-specific VC ioctls</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Generally a bit racy with respect to console_lock();.</span>
<span class="cm"> *</span>
<span class="cm"> * There are some functions which don&#39;t need it.</span>
<span class="cm"> *</span>
<span class="cm"> * There are some functions which can sleep for arbitrary periods</span>
<span class="cm"> * (paste_selection) but we don&#39;t need the lock there anyway.</span>
<span class="cm"> *</span>
<span class="cm"> * set_selection has locking, and definitely needs it</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tioclinux</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">!=</span> <span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">TIOCL_SETSEL</span>:
			<span class="n">console_lock</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_selection</span><span class="p">((</span><span class="k">struct</span> <span class="n">tiocl_selection</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_PASTESEL</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">paste_selection</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_UNBLANKSCREEN</span>:
			<span class="n">console_lock</span><span class="p">();</span>
			<span class="n">unblank_screen</span><span class="p">();</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_SELLOADLUT</span>:
			<span class="n">console_lock</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sel_loadlut</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_GETSHIFTSTATE</span>:

	<span class="cm">/*</span>
<span class="cm">	 * Make it possible to react to Shift+Mousebutton.</span>
<span class="cm">	 * Note that &#39;shift_state&#39; is an undocumented</span>
<span class="cm">	 * kernel-internal variable; programs not closely</span>
<span class="cm">	 * related to the kernel should not use this.</span>
<span class="cm">	 */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">vt_get_shift_state</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_GETMOUSEREPORTING</span>:
			<span class="n">console_lock</span><span class="p">();</span>	<span class="cm">/* May be overkill */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mouse_reporting</span><span class="p">();</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_SETVESABLANK</span>:
			<span class="n">console_lock</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_vesa_blanking</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_GETKMSGREDIRECT</span>:
			<span class="n">data</span> <span class="o">=</span> <span class="n">vt_get_kmsg_redirect</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_SETKMSGREDIRECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">vt_kmsg_redirect</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_GETFGCONSOLE</span>:
			<span class="cm">/* No locking needed as this is a transiently</span>
<span class="cm">			   correct return anyway if the caller hasn&#39;t</span>
<span class="cm">			   disabled switching */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fg_console</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_SCROLLCONSOLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="p">(</span><span class="n">s32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Need the console lock here. Note that lots</span>
<span class="cm">				   of other calls need fixing before the lock</span>
<span class="cm">				   is actually useful ! */</span>
				<span class="n">console_lock</span><span class="p">();</span>
				<span class="n">scrollfront</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">lines</span><span class="p">);</span>
				<span class="n">console_unlock</span><span class="p">();</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_BLANKSCREEN</span>:	<span class="cm">/* until explicitly unblanked, not only poked */</span>
			<span class="n">console_lock</span><span class="p">();</span>
			<span class="n">ignore_poke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">do_blank_screen</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCL_BLANKEDSCREEN</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">console_blanked</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * /dev/ttyN handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">do_con_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">con_flush_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* n_r3964 calls put_char() from interrupt context */</span>
	<span class="k">return</span> <span class="n">do_con_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">32768</span><span class="p">;</span>		<span class="cm">/* No limit, really; we&#39;re not buffering */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* we&#39;re not buffering */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * con_throttle and con_unthrottle are only used for</span>
<span class="cm"> * paste_selection(), which has to stuff in a large number of</span>
<span class="cm"> * characters...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">paste_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn the Scroll-Lock LED on when the tty is stopped</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">console_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">console_num</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">console_num</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vt_kbd_con_stop</span><span class="p">(</span><span class="n">console_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn the Scroll-Lock LED off when the console is started</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">console_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">console_num</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">console_num</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vt_kbd_con_start</span><span class="p">(</span><span class="n">console_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>	<span class="cm">/* from flush_to_ldisc */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if we race with con_close(), vt may be null */</span>
	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">vc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="p">)</span>
		<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the console screen memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currcons</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vc_allocate</span><span class="p">(</span><span class="n">currcons</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

			<span class="cm">/* Still being freed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">console_unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_col</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_row</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">winsize</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_utf</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">|=</span> <span class="n">IUTF8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IUTF8</span><span class="p">;</span>
			<span class="n">console_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do - we defer to shutdown */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">con_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">vc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="n">tty_shutdown</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">default_italic_color</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// green (ASCII)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_underline_color</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// cyan (ASCII)</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">italic</span><span class="p">,</span> <span class="n">default_italic_color</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">underline</span><span class="p">,</span> <span class="n">default_underline_color</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rows</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cols</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>

	<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>
	<span class="n">reset_vc</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_red</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_grn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_blu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_def_color</span>       <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>   <span class="cm">/* white */</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_ulcolor</span>         <span class="o">=</span> <span class="n">default_underline_color</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_itcolor</span>         <span class="o">=</span> <span class="n">default_italic_color</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_halfcolor</span>       <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>   <span class="cm">/* grey */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">paste_wait</span><span class="p">);</span>
	<span class="n">reset_terminal</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">do_clear</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine initializes console interrupts, and does nothing</span>
<span class="cm"> * else. If you want the screen to clear, call tty_write with</span>
<span class="cm"> * the appropriate escape-sequence.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">con_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">display_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">currcons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conswitchp</span><span class="p">)</span>
		<span class="n">display_desc</span> <span class="o">=</span> <span class="n">conswitchp</span><span class="o">-&gt;</span><span class="n">con_startup</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fg_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">=</span> <span class="n">conswitchp</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">display_desc</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">MAX_NR_CONSOLES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conswitchp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blankinterval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_normal_wait</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">blankinterval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">currcons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">currcons</span> <span class="o">&lt;</span> <span class="n">MIN_NR_CONSOLES</span><span class="p">;</span> <span class="n">currcons</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span> <span class="o">=</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span><span class="p">),</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">SAK_work</span><span class="p">,</span> <span class="n">vc_SAK</span><span class="p">);</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">visual_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">currcons</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf_size</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
		<span class="n">vc_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span>
			<span class="n">currcons</span> <span class="o">||</span> <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_save_screen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">currcons</span> <span class="o">=</span> <span class="n">fg_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">master_display_fg</span> <span class="o">=</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">currcons</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">save_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">);</span>
	<span class="n">csi_J</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">update_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Console: %s %s %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">?</span> <span class="s">&quot;colour&quot;</span> <span class="o">:</span> <span class="s">&quot;mono&quot;</span><span class="p">,</span>
		<span class="n">display_desc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
	<span class="n">printable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">console_unlock</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_VT_CONSOLE</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_console_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">con_init</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">con_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">con_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">con_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">con_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">con_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">con_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">con_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">con_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">vt_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">vt_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">con_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">con_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">con_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">con_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resize</span> <span class="o">=</span> <span class="n">vt_resize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">con_shutdown</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">vc0_cdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tty_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;tty%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fg_console</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tty_active</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">vty_init</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">console_fops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc0_cdev</span><span class="p">,</span> <span class="n">console_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc0_cdev</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">TTY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">TTY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/dev/vc/0&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register /dev/tty0 driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tty0dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">tty_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">TTY_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;tty0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tty0dev</span><span class="p">))</span>
		<span class="n">tty0dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">tty0dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_active</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">vcs_init</span><span class="p">();</span>

	<span class="n">console_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MAX_NR_CONSOLES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_driver</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate console driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tty&quot;</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">name_base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_CONSOLE</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_utf8</span><span class="p">)</span>
		<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">|=</span> <span class="n">IUTF8</span><span class="p">;</span>
	<span class="n">console_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_RESET_TERMIOS</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">console_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">con_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">console_driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register console driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kbd_init</span><span class="p">();</span>
	<span class="n">console_map_init</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_MDA_CONSOLE</span>
	<span class="n">mda_console_init</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef VT_SINGLE_DRIVER</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">vtconsole_class</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bind_con_driver</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">deflt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">csw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con_driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="cm">/* check if driver is registered */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="n">csw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">csw</span><span class="o">-&gt;</span><span class="n">con_startup</span><span class="p">();</span>
		<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deflt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conswitchp</span><span class="p">)</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">conswitchp</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

		<span class="n">__module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">conswitchp</span> <span class="o">=</span> <span class="n">csw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_was_color</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">__module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">csw</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span> <span class="o">||</span> <span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CON_IS_VISIBLE</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">save_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">old_was_color</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_deinit</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_screenbuf</span><span class="p">;</span>
		<span class="n">visual_init</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">update_attr</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

		<span class="cm">/* If the console changed between mono &lt;-&gt; color, then</span>
<span class="cm">		 * the attributes in the screenbuf will be wrong.  The</span>
<span class="cm">		 * following resets all attributes to something sane.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_was_color</span> <span class="o">!=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span><span class="p">)</span>
			<span class="n">clear_buffer_attributes</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Console: switching &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deflt</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;consoles %d-%d &quot;</span><span class="p">,</span> <span class="n">first</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;to %s %s %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_can_do_color</span> <span class="o">?</span> <span class="s">&quot;colour&quot;</span> <span class="o">:</span> <span class="s">&quot;mono&quot;</span><span class="p">,</span>
		       <span class="n">desc</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
			<span class="n">update_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_VT_HW_CONSOLE_BINDING</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_is_graphics</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * unbind_con_driver - unbind a console driver</span>
<span class="cm"> * @csw: pointer to console driver to unregister</span>
<span class="cm"> * @first: first in range of consoles that @csw should be unbound from</span>
<span class="cm"> * @last: last in range of consoles that @csw should be unbound from</span>
<span class="cm"> * @deflt: should next bound console driver be default after @csw is unbound?</span>
<span class="cm"> *</span>
<span class="cm"> * To unbind a driver from all possible consoles, pass 0 as @first and</span>
<span class="cm"> * %MAX_NR_CONSOLES as @last.</span>
<span class="cm"> *</span>
<span class="cm"> * @deflt controls whether the console that ends up replacing @csw should be</span>
<span class="cm"> * the default console.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * -ENODEV if @csw isn&#39;t a registered console driver or can&#39;t be unregistered</span>
<span class="cm"> * or 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">unbind_con_driver</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">,</span> <span class="kt">int</span> <span class="n">deflt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">csw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">defcsw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">con_back</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="cm">/* check if driver is registered and if it is unbindable */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="n">csw</span> <span class="o">&amp;&amp;</span>
		    <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* check if backup driver exists */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con_back</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_back</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">con_back</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">defcsw</span> <span class="o">=</span> <span class="n">con_back</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con_is_bound</span><span class="p">(</span><span class="n">csw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">csw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">csw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
			<span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con_is_bound</span><span class="p">(</span><span class="n">defcsw</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">defconsw</span> <span class="o">=</span> <span class="n">conswitchp</span><span class="p">;</span>

		<span class="n">defcsw</span><span class="o">-&gt;</span><span class="n">con_startup</span><span class="p">();</span>
		<span class="n">con_back</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * vgacon may change the default driver to point</span>
<span class="cm">		 * to dummycon, we restore it here...</span>
<span class="cm">		 */</span>
		<span class="n">conswitchp</span> <span class="o">=</span> <span class="n">defconsw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con_is_bound</span><span class="p">(</span><span class="n">csw</span><span class="p">))</span>
		<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">;</span>

	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="cm">/* ignore return value, binding should not fail */</span>
	<span class="n">bind_con_driver</span><span class="p">(</span><span class="n">defcsw</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">deflt</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unbind_con_driver</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">defcsw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">csw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">deflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">con_is_graphics</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">csw</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">defcsw</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">defcsw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">defcsw</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">last</span> <span class="o">==</span> <span class="n">MAX_NR_CONSOLES</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">deflt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">bind_con_driver</span><span class="p">(</span><span class="n">csw</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">deflt</span><span class="p">);</span>

		<span class="n">first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">deflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">deflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">con_is_graphics</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">csw</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">csw</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">last</span> <span class="o">==</span> <span class="n">MAX_NR_CONSOLES</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">deflt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">unbind_con_driver</span><span class="p">(</span><span class="n">csw</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">deflt</span><span class="p">);</span>

		<span class="n">first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">deflt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vt_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vt_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VT_HW_CONSOLE_BINDING */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bind</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">)</span>
		<span class="n">vt_bind</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vt_unbind</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bind</span> <span class="o">=</span> <span class="n">con_is_bound</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bind</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(M)&quot;</span> <span class="o">:</span> <span class="s">&quot;(S)&quot;</span><span class="p">,</span>
			 <span class="n">con</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">device_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_bind</span><span class="p">,</span> <span class="n">store_bind</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vtconsole_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">CON_DRIVER_FLAG_ATTR</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">device_attrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CON_DRIVER_FLAG_ATTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vtconsole_deinit_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_ATTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">device_attrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">con</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CON_DRIVER_FLAG_ATTR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * con_is_bound - checks if driver is bound to the console</span>
<span class="cm"> * @csw: console driver</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS: zero if unbound, nonzero if bound</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers can call this and if zero, they should release</span>
<span class="cm"> * all resources allocated on con_startup()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">con_is_bound</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">csw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bound</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bound</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">con_is_bound</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * con_debug_enter - prepare the console for the kernel debugger</span>
<span class="cm"> * @sw: console driver</span>
<span class="cm"> *</span>
<span class="cm"> * Called when the console is taken over by the kernel debugger, this</span>
<span class="cm"> * function needs to save the current console state, then put the console</span>
<span class="cm"> * into a state suitable for the kernel debugger.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, nonzero if a failure occurred when trying to prepare</span>
<span class="cm"> * the console for the debugger.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">con_debug_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saved_fg_console</span> <span class="o">=</span> <span class="n">fg_console</span><span class="p">;</span>
	<span class="n">saved_last_console</span> <span class="o">=</span> <span class="n">last_console</span><span class="p">;</span>
	<span class="n">saved_want_console</span> <span class="o">=</span> <span class="n">want_console</span><span class="p">;</span>
	<span class="n">saved_vc_mode</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span><span class="p">;</span>
	<span class="n">saved_console_blanked</span> <span class="o">=</span> <span class="n">console_blanked</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">=</span> <span class="n">KD_TEXT</span><span class="p">;</span>
	<span class="n">console_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_debug_enter</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_debug_enter</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_KGDB_KDB</span>
	<span class="cm">/* Set the initial LINES variable if it is not already set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">&lt;</span> <span class="mi">999</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">linecount</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">lns</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setargs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;set&quot;</span><span class="p">,</span>
			<span class="s">&quot;LINES&quot;</span><span class="p">,</span>
			<span class="n">lns</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kdbgetintenv</span><span class="p">(</span><span class="n">setargs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">linecount</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">lns</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
			<span class="n">kdb_set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">setargs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_KGDB_KDB */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">con_debug_enter</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * con_debug_leave - restore console state</span>
<span class="cm"> * @sw: console driver</span>
<span class="cm"> *</span>
<span class="cm"> * Restore the console state to what it was before the kernel debugger</span>
<span class="cm"> * was invoked.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, nonzero if a failure occurred when trying to restore</span>
<span class="cm"> * the console.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">con_debug_leave</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fg_console</span> <span class="o">=</span> <span class="n">saved_fg_console</span><span class="p">;</span>
	<span class="n">last_console</span> <span class="o">=</span> <span class="n">saved_last_console</span><span class="p">;</span>
	<span class="n">want_console</span> <span class="o">=</span> <span class="n">saved_want_console</span><span class="p">;</span>
	<span class="n">console_blanked</span> <span class="o">=</span> <span class="n">saved_console_blanked</span><span class="p">;</span>
	<span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">=</span> <span class="n">saved_vc_mode</span><span class="p">;</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_debug_leave</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_debug_leave</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">con_debug_leave</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * register_con_driver - register console driver to console layer</span>
<span class="cm"> * @csw: console driver</span>
<span class="cm"> * @first: the first console to take over, minimum value is 0</span>
<span class="cm"> * @last: the last console to take over, maximum value is MAX_NR_CONSOLES -1</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION: This function registers a console driver which can later</span>
<span class="cm"> * bind to a range of consoles specified by @first and @last. It will</span>
<span class="cm"> * also initialize the console driver by calling con_startup().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">register_con_driver</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span> <span class="o">=</span> <span class="n">csw</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con_driver</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* already registered */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="n">csw</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">csw</span><span class="o">-&gt;</span><span class="n">con_startup</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">=</span> <span class="n">csw</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">CON_DRIVER_FLAG_MODULE</span> <span class="o">|</span>
			                   <span class="n">CON_DRIVER_FLAG_INIT</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">vtconsole_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vtcon%i&quot;</span><span class="p">,</span>
						<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to create device for %s; &quot;</span>
		       <span class="s">&quot;errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span>
		       <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vtconsole_init_device</span><span class="p">(</span><span class="n">con_driver</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_con_driver</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * unregister_con_driver - unregister console driver from console layer</span>
<span class="cm"> * @csw: console driver</span>
<span class="cm"> *</span>
<span class="cm"> * DESCRIPTION: All drivers that registers to the console layer must</span>
<span class="cm"> * call this function upon exit, or if the console driver is in a state</span>
<span class="cm"> * where it won&#39;t be able to handle console services, such as the</span>
<span class="cm"> * framebuffer console without loaded framebuffer drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver must unbind first prior to unregistration.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">unregister_con_driver</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>

	<span class="cm">/* cannot unregister a bound driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">con_is_bound</span><span class="p">(</span><span class="n">csw</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con_driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">==</span> <span class="n">csw</span> <span class="o">&amp;&amp;</span>
		    <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">CON_DRIVER_FLAG_MODULE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vtconsole_deinit_device</span><span class="p">(</span><span class="n">con_driver</span><span class="p">);</span>
			<span class="n">device_destroy</span><span class="p">(</span><span class="n">vtconsole_class</span><span class="p">,</span>
				       <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">con_driver</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">err:</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_con_driver</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	If we support more console drivers, this function is used</span>
<span class="cm"> *	when a driver wants to take over some existing consoles</span>
<span class="cm"> *	and become default driver for newly opened ones.</span>
<span class="cm"> *</span>
<span class="cm"> *      take_over_console is basically a register followed by unbind</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">take_over_console</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">,</span> <span class="kt">int</span> <span class="n">deflt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_con_driver</span><span class="p">(</span><span class="n">csw</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="cm">/* if we get an busy error we still want to bind the console driver</span>
<span class="cm">	 * and return success, as we may have unbound the console driver</span>
<span class="cm">	 * but not unregistered it.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">bind_con_driver</span><span class="p">(</span><span class="n">csw</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">deflt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * give_up_console is a wrapper to unregister_con_driver. It will only</span>
<span class="cm"> * work if driver is fully unbound.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">give_up_console</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">consw</span> <span class="o">*</span><span class="n">csw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_con_driver</span><span class="p">(</span><span class="n">csw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vtconsole_class_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vtconsole_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;vtconsole&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vtconsole_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to create vt console class; &quot;</span>
		       <span class="s">&quot;errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vtconsole_class</span><span class="p">));</span>
		<span class="n">vtconsole_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add system drivers to sysfs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CON_DRIVER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">con_driver</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">registered_con_driver</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">con</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">vtconsole_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							 <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span>
							 <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vtcon%i&quot;</span><span class="p">,</span>
							 <span class="n">con</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to create &quot;</span>
				       <span class="s">&quot;device for %s; errno = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">con</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">con</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vtconsole_init_device</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">vtconsole_class_init</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Screen blanking</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_vesa_blanking</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">vesa_blank_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_blank_screen</span><span class="p">(</span><span class="kt">int</span> <span class="n">entering_gfx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">console_blanked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blank_state</span> <span class="o">==</span> <span class="n">blank_vesa_wait</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_off</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_blank</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vesa_blank_mode</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* entering graphics mode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entering_gfx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">save_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_blank</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">console_blanked</span> <span class="o">=</span> <span class="n">fg_console</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_off</span><span class="p">;</span>
		<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blank_state</span> <span class="o">!=</span> <span class="n">blank_normal_wait</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_off</span><span class="p">;</span>

	<span class="cm">/* don&#39;t blank graphics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_blanked</span> <span class="o">=</span> <span class="n">fg_console</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">);</span>
	<span class="n">blank_timer_expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">save_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="cm">/* In case we need to reset origin, blanking hook returns 1 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_blank</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">vesa_off_interval</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">vesa_blank_mode</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">console_blanked</span> <span class="o">=</span> <span class="n">fg_console</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">set_origin</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">console_blank_hook</span> <span class="o">&amp;&amp;</span> <span class="n">console_blank_hook</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vesa_off_interval</span> <span class="o">&amp;&amp;</span> <span class="n">vesa_blank_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_vesa_wait</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">vesa_off_interval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vt_event_post</span><span class="p">(</span><span class="n">VT_EVENT_BLANK</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">do_blank_screen</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called by timer as well as from vt_console_driver</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">do_unblank_screen</span><span class="p">(</span><span class="kt">int</span> <span class="n">leaving_gfx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>

	<span class="cm">/* This should now always be called from a &quot;sane&quot; (read: can schedule)</span>
<span class="cm">	 * context for the sake of the low level drivers, except in the special</span>
<span class="cm">	 * case of oops_in_progress</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="n">ignore_poke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_blanked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">fg_console</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* impossible */</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unblank_screen: tty %d not allocated ??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">fg_console</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="cm">/* Try to unblank in oops case too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vt_force_oops_output</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* but leave console_blanked != 0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blankinterval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">blankinterval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_normal_wait</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">console_blanked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_blank</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">leaving_gfx</span><span class="p">)</span> <span class="o">||</span> <span class="n">vt_force_oops_output</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="cm">/* Low-level driver cannot restore -&gt; do it ourselves */</span>
		<span class="n">update_screen</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_blank_hook</span><span class="p">)</span>
		<span class="n">console_blank_hook</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">vt_event_post</span><span class="p">(</span><span class="n">VT_EVENT_UNBLANK</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">do_unblank_screen</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is called by the outside world to cause a forced unblank, mostly for</span>
<span class="cm"> * oopses. Currently, I just call do_unblank_screen(0), but we could eventually</span>
<span class="cm"> * call it with 1 as an argument and so force a mode restore... that may kill</span>
<span class="cm"> * X or at least garbage the screen but would also make the Oops visible...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">unblank_screen</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_unblank_screen</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We defer the timer blanking to work queue so it can take the console mutex</span>
<span class="cm"> * (console operations can still happen at irq time, but only from printk which</span>
<span class="cm"> * has the console mutex. Not perfect yet, but better than no locking</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blank_screen_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">keventd_up</span><span class="p">()))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">blankinterval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blank_timer_expired</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">poke_blanked_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="cm">/* Add this so we quickly catch whoever might call us in a non</span>
<span class="cm">	 * safe context. Nowadays, unblank_screen() isn&#39;t to be called in</span>
<span class="cm">	 * atomic contexts and is allowed to schedule (with the special case</span>
<span class="cm">	 * of oops_in_progress, but that isn&#39;t of any concern for this</span>
<span class="cm">	 * function. --BenH.</span>
<span class="cm">	 */</span>
	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="cm">/* This isn&#39;t perfectly race free, but a race here would be mostly harmless,</span>
<span class="cm">	 * at worse, we&#39;ll do a spurrious blank and it&#39;s unlikely</span>
<span class="cm">	 */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">);</span>
	<span class="n">blank_timer_expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_poke</span> <span class="o">||</span> <span class="o">!</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span> <span class="o">||</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_blanked</span><span class="p">)</span>
		<span class="n">unblank_screen</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">blankinterval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">console_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">blankinterval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="n">blank_state</span> <span class="o">=</span> <span class="n">blank_normal_wait</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Palettes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_CONSOLE_UNLOCKED</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">color_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Load palette into the DAC registers. arg points to a colour</span>
<span class="cm"> * map, 3 bytes per colour, 16 colours, range from 0 to 255.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">con_set_cmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">colormap</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">default_red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
		<span class="n">default_grn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
		<span class="n">default_blu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_red</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_grn</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_blu</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">set_palette</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">con_get_cmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_red</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_grn</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">colormap</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_blu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">colormap</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reset_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_red</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_grn</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_palette</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_blu</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">set_palette</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Font switching</span>
<span class="cm"> *</span>
<span class="cm"> *  Currently we only support fonts up to 32 pixels wide, at a maximum height</span>
<span class="cm"> *  of 32 pixels. Userspace fontdata is stored with 32 bytes (shorts/ints, </span>
<span class="cm"> *  depending on width) reserved for each character which is kinda wasty, but </span>
<span class="cm"> *  this is done in order to maintain compatibility with the EGA/VGA fonts. It </span>
<span class="cm"> *  is up to the actual low-level console-driver convert data into its favorite</span>
<span class="cm"> *  format (maybe we should add a `fontoffset&#39; field to the `display&#39;</span>
<span class="cm"> *  structure so we won&#39;t have to convert the fontdata all the time.</span>
<span class="cm"> *  /Jes</span>
<span class="cm"> */</span>

<span class="cp">#define max_font_size 65536</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_font_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">console_font</span> <span class="n">font</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">font</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">max_font_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">font</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_get</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_get</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">width</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">font</span><span class="p">.</span><span class="n">charcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">font</span><span class="p">.</span><span class="n">charcount</span> <span class="o">&gt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KD_FONT_FLAG_OLD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="n">font</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> 
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;&amp;</span> <span class="n">font</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">||</span>
			 <span class="n">font</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">charcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_font_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">console_font</span> <span class="n">font</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Need to guess font height [compat] */</span>
		<span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">charmap</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
		
		<span class="cm">/* If from KDFONTOP ioctl, don&#39;t allow things which can be done in userland,</span>
<span class="cm">		   so that we can get rid of this soon */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KD_FONT_FLAG_OLD</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span><span class="o">--</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charmap</span><span class="p">[</span><span class="mi">32</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">nonzero</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">nonzero:</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_font_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="n">font</span><span class="p">.</span><span class="n">charcount</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">charcount</span><span class="p">;</span>
	<span class="n">font</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">font</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">font</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_set</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_set</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_font_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">console_font</span> <span class="n">font</span> <span class="o">=</span> <span class="p">{.</span><span class="n">width</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">};</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_FONT_NAME</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">MAX_FONT_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">name</span><span class="p">[</span><span class="n">MAX_FONT_NAME</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_default</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_default</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">font</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">con_font_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">con</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>


	<span class="n">console_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">!=</span> <span class="n">KD_TEXT</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_copy</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">con</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">vc_cons_allocated</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">con</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">)</span>	<span class="cm">/* nothing to do */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_sw</span><span class="o">-&gt;</span><span class="n">con_font_copy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">con</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">con_font_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">console_font_op</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KD_FONT_OP_SET</span>:
		<span class="k">return</span> <span class="n">con_font_set</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">KD_FONT_OP_GET</span>:
		<span class="k">return</span> <span class="n">con_font_get</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">KD_FONT_OP_SET_DEFAULT</span>:
		<span class="k">return</span> <span class="n">con_font_default</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">KD_FONT_OP_COPY</span>:
		<span class="k">return</span> <span class="n">con_font_copy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Interface exported to selection and vcs.</span>
<span class="cm"> */</span>

<span class="cm">/* used by selection */</span>
<span class="n">u16</span> <span class="nf">screen_glyph</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">screenpos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">u16</span> <span class="n">c</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">screen_glyph</span><span class="p">);</span>

<span class="cm">/* used by vcs - note the word offset */</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="nf">screen_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">viewed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">screenpos</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w_offset</span><span class="p">,</span> <span class="n">viewed</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">getconsxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">putconsxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hide_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">gotoxy</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">set_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">vcs_scr_readw</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">org</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">org</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span> <span class="o">&amp;&amp;</span> <span class="n">softcursor_original</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">softcursor_original</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">org</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcs_scr_writew</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">org</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scr_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">org</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">org</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">softcursor_original</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">add_softcursor</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcs_scr_updated</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">notify_update</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Visible symbols for modules</span>
<span class="cm"> */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">color_table</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">default_red</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">default_grn</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">default_blu</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">update_region</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">redraw_screen</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vc_resize</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fg_console</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">console_blank_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">console_blanked</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">global_cursor_default</span><span class="p">);</span>
<span class="cp">#ifndef VT_SINGLE_DRIVER</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">take_over_console</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">give_up_console</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
