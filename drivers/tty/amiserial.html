<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › amiserial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amiserial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Serial driver for the amiga builtin port.</span>
<span class="cm"> *</span>
<span class="cm"> * This code was created by taking serial.c version 4.30 from kernel</span>
<span class="cm"> * release 2.3.22, replacing all hardware related stuff with the</span>
<span class="cm"> * corresponding amiga hardware actions, and removing all irrelevant</span>
<span class="cm"> * code. As a consequence, it uses many of the constants and names</span>
<span class="cm"> * associated with the registers and bits of 16550 compatible UARTS -</span>
<span class="cm"> * but only to keep track of status, etc in the state variables. It</span>
<span class="cm"> * was done this was to make it easier to keep the code in line with</span>
<span class="cm"> * (non hardware specific) changes to serial.c.</span>
<span class="cm"> *</span>
<span class="cm"> * The port is registered with the tty driver as minor device 64, and</span>
<span class="cm"> * therefore other ports should should only use 65 upwards.</span>
<span class="cm"> *</span>
<span class="cm"> * Richard Lucock 28/12/99</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *  Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, </span>
<span class="cm"> * 		1998, 1999  Theodore Ts&#39;o</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Serial driver configuration section.  Here are the various options:</span>
<span class="cm"> *</span>
<span class="cm"> * SERIAL_PARANOIA_CHECK</span>
<span class="cm"> * 		Check the magic number for the async_structure where</span>
<span class="cm"> * 		ever possible.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#undef SERIAL_PARANOIA_CHECK</span>
<span class="cp">#define SERIAL_DO_RESTART</span>

<span class="cm">/* Set of debugging defines */</span>

<span class="cp">#undef SERIAL_DEBUG_INTR</span>
<span class="cp">#undef SERIAL_DEBUG_OPEN</span>
<span class="cp">#undef SERIAL_DEBUG_FLOW</span>
<span class="cp">#undef SERIAL_DEBUG_RS_WAIT_UNTIL_SENT</span>

<span class="cm">/* Sanity checks */</span>

<span class="cp">#if defined(MODULE) &amp;&amp; defined(SERIAL_DEBUG_MCOUNT)</span>
<span class="cp">#define DBG_CNT(s) printk(&quot;(%s): [%x] refc=%d, serc=%d, ttyc=%d -&gt; %s\n&quot;, \</span>
<span class="cp"> tty-&gt;name, (info-&gt;tport.flags), serial_driver-&gt;refcount,info-&gt;count,tty-&gt;count,s)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG_CNT(s)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * End of serial driver configuration section.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_version</span> <span class="o">=</span> <span class="s">&quot;4.30&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>


<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;asm/amigahw.h&gt;</span>
<span class="cp">#include &lt;asm/amigaints.h&gt;</span>

<span class="k">struct</span> <span class="n">serial_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span>		<span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span>		<span class="n">xmit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span>	<span class="n">icount</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">baud_base</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">custom_divisor</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">read_status_mask</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ignore_status_mask</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">quot</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">IER</span><span class="p">;</span> 	<span class="cm">/* Interrupt Enable Register */</span>
	<span class="kt">int</span>			<span class="n">MCR</span><span class="p">;</span> 	<span class="cm">/* Modem control register */</span>
	<span class="kt">int</span>			<span class="n">x_char</span><span class="p">;</span>	<span class="cm">/* xon/xoff character */</span>
<span class="p">};</span>

<span class="cp">#define custom amiga_custom</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_name</span> <span class="o">=</span> <span class="s">&quot;Amiga-builtin serial driver&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="cm">/* number of characters left in xmit buffer before we ask for more */</span>
<span class="cp">#define WAKEUP_CHARS 256</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_ctl_bits</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="n">rs_table</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="cp">#define NR_PORTS ARRAY_SIZE(rs_table)</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define serial_isroot()	(capable(CAP_SYS_ADMIN))</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">serial_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_PARANOIA_CHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badmagic</span> <span class="o">=</span>
		<span class="s">&quot;Warning: bad magic number for serial struct (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badinfo</span> <span class="o">=</span>
		<span class="s">&quot;Warning: null async_struct for (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badinfo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">SERIAL_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badmagic</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* some serial hardware definitions */</span>
<span class="cp">#define SDR_OVRUN   (1&lt;&lt;15)</span>
<span class="cp">#define SDR_RBF     (1&lt;&lt;14)</span>
<span class="cp">#define SDR_TBE     (1&lt;&lt;13)</span>
<span class="cp">#define SDR_TSRE    (1&lt;&lt;12)</span>

<span class="cp">#define SERPER_PARENB    (1&lt;&lt;15)</span>

<span class="cp">#define AC_SETCLR   (1&lt;&lt;15)</span>
<span class="cp">#define AC_UARTBRK  (1&lt;&lt;11)</span>

<span class="cp">#define SER_DTR     (1&lt;&lt;7)</span>
<span class="cp">#define SER_RTS     (1&lt;&lt;6)</span>
<span class="cp">#define SER_DCD     (1&lt;&lt;5)</span>
<span class="cp">#define SER_CTS     (1&lt;&lt;4)</span>
<span class="cp">#define SER_DSR     (1&lt;&lt;3)</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">rtsdtr_ctrl</span><span class="p">(</span><span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ciab</span><span class="p">.</span><span class="n">pra</span> <span class="o">=</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SER_RTS</span> <span class="o">|</span> <span class="n">SER_DTR</span><span class="p">))</span> <span class="o">^</span> <span class="p">(</span><span class="n">SER_RTS</span> <span class="o">|</span> <span class="n">SER_DTR</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">ciab</span><span class="p">.</span><span class="n">pra</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RTS</span> <span class="o">|</span> <span class="n">SER_DTR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_stop() and rs_start()</span>
<span class="cm"> *</span>
<span class="cm"> * This routines are called before setting or resetting tty-&gt;stopped.</span>
<span class="cm"> * They enable or disable transmitter interrupts, as necessary.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_stop&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="cm">/* disable Tx interrupt and remove any pending interrupts */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_start&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span>
	    <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="cm">/* set a pending Tx Interrupt, transmitter should restart now */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ----------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Here starts the interrupt handling routines.  All of the following</span>
<span class="cm"> * subroutines are declared as inline and are folded into</span>
<span class="cm"> * rs_interrupt().  They were separated out for readability&#39;s sake.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: rs_interrupt() is a &quot;fast&quot; interrupt, which means that it</span>
<span class="cm"> * runs with interrupts turned off.  People who may want to modify</span>
<span class="cm"> * rs_interrupt() should try to keep the interrupt handler as fast as</span>
<span class="cm"> * possible.  After you are done making modifications, it is not a bad</span>
<span class="cm"> * idea to do:</span>
<span class="cm"> * </span>
<span class="cm"> * gcc -S -DKERNEL -Wall -Wstrict-prototypes -O6 -fomit-frame-pointer serial.c</span>
<span class="cm"> *</span>
<span class="cm"> * and look at the resulting assemble code in serial.s.</span>
<span class="cm"> *</span>
<span class="cm"> * 				- Ted Ts&#39;o (tytso@mit.edu), 7-Mar-93</span>
<span class="cm"> * -----------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">serdatr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">UART_LSR_DR</span><span class="p">;</span> <span class="cm">/* We obviously have a character! */</span>
	<span class="n">serdatr</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_RBF</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">if</span><span class="p">((</span><span class="n">serdatr</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">status</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">serdatr</span> <span class="o">&amp;</span> <span class="n">SDR_OVRUN</span><span class="p">)</span>
	    <span class="n">status</span> <span class="o">|=</span> <span class="n">UART_LSR_OE</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">serdatr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DR%02x:%02x...&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t handle parity or frame errors - but I have left</span>
<span class="cm">	 * the code in, since I&#39;m not sure that the errors can&#39;t be</span>
<span class="cm">	 * detected.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_LSR_BI</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span>
		      <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_OE</span><span class="p">))</span> <span class="p">{</span>
	  <span class="cm">/*</span>
<span class="cm">	   * For statistics only</span>
<span class="cm">	   */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">);</span>
	    <span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
	    <span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
	  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
	    <span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
	    <span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

	  <span class="cm">/*</span>
<span class="cm">	   * Now check to see if character should be</span>
<span class="cm">	   * ignored, and mask off conditions which</span>
<span class="cm">	   * should be ignored.</span>
<span class="cm">	   */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	  <span class="n">status</span> <span class="o">&amp;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_LSR_BI</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;handling break....&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
	      <span class="n">do_SAK</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
	    <span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
	  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
	    <span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/*</span>
<span class="cm">	     * Overrun is special, since it&#39;s</span>
<span class="cm">	     * reported immediately, and doesn&#39;t</span>
<span class="cm">	     * affect the current character</span>
<span class="cm">	     */</span>
	     <span class="n">oe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">custom</span><span class="p">.</span><span class="n">serdat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span>
	    <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span>
	    <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
	        <span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">serdat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
		     <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
		     <span class="n">SERIAL_XMIT_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;THRE...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_modem_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ciab</span><span class="p">.</span><span class="n">pra</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SER_DCD</span> <span class="o">|</span> <span class="n">SER_CTS</span> <span class="o">|</span> <span class="n">SER_DSR</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dstatus</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">async_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>

	<span class="cm">/* Determine bits that have changed */</span>
	<span class="n">dstatus</span> <span class="o">=</span> <span class="n">status</span> <span class="o">^</span> <span class="n">current_ctl_bits</span><span class="p">;</span>
	<span class="n">current_ctl_bits</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">SER_DSR</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HARD_PPS</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HARDPPS_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">))</span>
				<span class="n">hardpps</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">SER_CTS</span><span class="p">)</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if (defined(SERIAL_DEBUG_OPEN) || defined(SERIAL_DEBUG_INTR))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ttyS%d CD now %s...&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">))</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;doing serial hangup...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_CTS</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if (defined(SERIAL_DEBUG_INTR) || defined(SERIAL_DEBUG_FLOW))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx start...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
				<span class="n">mb</span><span class="p">();</span>
				<span class="cm">/* set a pending Tx Interrupt, transmitter should restart now */</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
				<span class="n">mb</span><span class="p">();</span>
				<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_CTS</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if (defined(SERIAL_DEBUG_INTR) || defined(SERIAL_DEBUG_FLOW))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx stop...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
				<span class="cm">/* disable Tx interrupt and remove any pending interrupts */</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
				<span class="n">mb</span><span class="p">();</span>
				<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>
				<span class="n">mb</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ser_vbl_int</span><span class="p">(</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* vbl is just a periodic interrupt we tie into to update modem status */</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * TBD - is it better to unregister from this interrupt or to</span>
<span class="cm">	 * ignore it if MSI is clear ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_MSI</span><span class="p">)</span>
	  <span class="n">check_modem_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ser_rx_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_rx_int...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">receive_chars</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ser_tx_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span> <span class="o">&amp;</span> <span class="n">SDR_TBE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_tx_int...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	  <span class="n">transmit_chars</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * -------------------------------------------------------------------</span>
<span class="cm"> * Here ends the serial interrupt routines.</span>
<span class="cm"> * -------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------</span>
<span class="cm"> * Low level utility subroutines for the serial driver:  routines to</span>
<span class="cm"> * figure out the appropriate timeout for an interrupt chain, routines</span>
<span class="cm"> * to initialize and startup a serial port, and routines to shutdown a</span>
<span class="cm"> * serial port.  Useful stuff like that.</span>
<span class="cm"> * ---------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">retval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;starting up ttys%d ...&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Clear anything in the input buffer */</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_RBF</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_VERTB</span><span class="p">,</span> <span class="n">ser_vbl_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;serial status&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">serial_isroot</span><span class="p">())</span> <span class="p">{</span>
	      <span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	    <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable both Rx and Tx interrupts */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_RBF</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>

	<span class="cm">/* remember current state of the DCD and CTS bits */</span>
	<span class="n">current_ctl_bits</span> <span class="o">=</span> <span class="n">ciab</span><span class="p">.</span><span class="n">pra</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SER_DCD</span> <span class="o">|</span> <span class="n">SER_CTS</span> <span class="o">|</span> <span class="n">SER_DSR</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_BAUD</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
	  <span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">=</span> <span class="n">SER_DTR</span> <span class="o">|</span> <span class="n">SER_RTS</span><span class="p">;</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the tty-&gt;alt_speed kludge</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_HI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_VHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_SHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_WARP</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and set the speed of the serial port</span>
<span class="cm">	 */</span>
	<span class="n">change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port; interrupts are disabled, and</span>
<span class="cm"> * DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Shutting down serial port %d ....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="cm">/* Disable interrupts */</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear delta_msr_wait queue to avoid mem leaks: we may free the irq</span>
<span class="cm">	 * here so the queue might never be waken up</span>
<span class="cm">	 */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free the IRQ, if necessary</span>
<span class="cm">	 */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_VERTB</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_RBF</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* disable break condition */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">adkcon</span> <span class="o">=</span> <span class="n">AC_UARTBRK</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_DTR</span><span class="o">|</span><span class="n">SER_RTS</span><span class="p">);</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This routine is called to set the UART divisor registers to match</span>
<span class="cm"> * the specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">quot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">baud_base</span><span class="p">,</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">cval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* Byte size is always 8 bits plus parity bit if requested */</span>

	<span class="n">cval</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>
<span class="cp">#ifdef CMSPAR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_SPAR</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>	<span class="cm">/* B0 transition handled in rs_set_termios */</span>
	<span class="n">baud_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_CUST</span><span class="p">)</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span>
			<span class="cm">/* Special case since 134 is really 134.5 */</span>
			<span class="n">quot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">baud_base</span> <span class="o">/</span> <span class="mi">269</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span><span class="p">)</span>
			<span class="n">quot</span> <span class="o">=</span> <span class="n">baud_base</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If the quotient is zero refuse the change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quot</span> <span class="o">&amp;&amp;</span> <span class="n">old_termios</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: Will need updating for new tty in the end */</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">);</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_CUST</span><span class="p">)</span>
			<span class="n">quot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span>
				<span class="cm">/* Special case since 134 is really 134.5 */</span>
				<span class="n">quot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">baud_base</span> <span class="o">/</span> <span class="mi">269</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span><span class="p">)</span>
				<span class="n">quot</span> <span class="o">=</span> <span class="n">baud_base</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* As a last resort, if the quotient is zero, default to 9600 bps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quot</span><span class="p">)</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">baud_base</span> <span class="o">/</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">quot</span> <span class="o">=</span> <span class="n">quot</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="o">*</span><span class="n">HZ</span><span class="o">*</span><span class="n">bits</span><span class="o">*</span><span class="n">quot</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud_base</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>		<span class="cm">/* Add .02 seconds of slop */</span>

	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HARDPPS_CD</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* TBD:</span>
<span class="cm">	 * Does clearing IER_MSI imply that we should disable the VBL interrupt ?</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up parity check flag</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">UART_LSR_OE</span> <span class="o">|</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characters to ignore</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span> <span class="n">UART_LSR_FE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignore parity and break indicators, ignore </span>
<span class="cm">		 * overruns too.  (For real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_OE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * !!! ignore all characters if CREAD is not set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">{</span>
	  <span class="kt">short</span> <span class="n">serper</span><span class="p">;</span>

	<span class="cm">/* Set up the baud rate */</span>
	  <span class="n">serper</span> <span class="o">=</span> <span class="n">quot</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable or disable parity bit */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cval</span> <span class="o">&amp;</span> <span class="n">UART_LCR_PARITY</span><span class="p">)</span>
	  <span class="n">serper</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SERPER_PARENB</span><span class="p">);</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">serper</span> <span class="o">=</span> <span class="n">serper</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CIRC_SPACE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
		       <span class="n">SERIAL_XMIT_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">&amp;=</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span>
	    <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span>
	    <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="cm">/* set a pending Tx Interrupt, transmitter should restart now */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">c</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">CIRC_SPACE_TO_END</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
				      <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="cm">/* set a pending Tx Interrupt, transmitter should restart now */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">CIRC_SPACE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to send a high-priority XON/XOFF character to</span>
<span class="cm"> * the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_send_char&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure transmit interrupts are on */</span>

	        <span class="cm">/* Check this ! */</span>
	        <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">custom</span><span class="p">.</span><span class="n">intenar</span> <span class="o">&amp;</span> <span class="n">IF_TBE</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		    <span class="n">mb</span><span class="p">();</span>
		    <span class="cm">/* set a pending Tx Interrupt, transmitter should restart now */</span>
		    <span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
		    <span class="n">mb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_throttle()</span>
<span class="cm"> * </span>
<span class="cm"> * This routine is called by the upper-layer tty layer to signal that</span>
<span class="cm"> * incoming characters should be throttled.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_THROTTLE</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;throttle %s: %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
	       <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">rs_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SER_RTS</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_THROTTLE</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unthrottle %s: %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
	       <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_RTS</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_ioctl() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>
   
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tty_lock</span><span class="p">();</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">change_spd</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span><span class="n">new_info</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">tty_lock</span><span class="p">();</span>
	<span class="n">change_spd</span> <span class="o">=</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">^</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">irq</span> <span class="o">||</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">port</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span>
			<span class="n">new_serial</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_isroot</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">xmit_fifo_size</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tty_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_USR_MASK</span><span class="p">));</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_and_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">&lt;</span> <span class="mi">9600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, past this point, all the error checking has been done.</span>
<span class="cm">	 * At this point, we start making changes.....</span>
<span class="cm">	 */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">*</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">*</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">check_and_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change_spd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_HI</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_VHI</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_SHI</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_WARP</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>
			<span class="n">change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting. This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SDR_TSRE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ciab</span><span class="p">.</span><span class="n">pra</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span>    <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SER_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SER_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span>  <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span>  <span class="o">&amp;</span> <span class="n">SER_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span>  <span class="o">&amp;</span> <span class="n">SER_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SER_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SER_DTR</span><span class="p">;</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_break() --- routine which turns the break handling on or off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	  <span class="n">custom</span><span class="p">.</span><span class="n">adkcon</span> <span class="o">=</span> <span class="n">AC_SETCLR</span> <span class="o">|</span> <span class="n">AC_UARTBRK</span><span class="p">;</span>
	<span class="k">else</span>
	  <span class="n">custom</span><span class="p">.</span><span class="n">adkcon</span> <span class="o">=</span> <span class="n">AC_UARTBRK</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)</span>
<span class="cm"> * Return: write counters to the user passed counter struct</span>
<span class="cm"> * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for</span>
<span class="cm"> *     RI where only 0-&gt;1 is counted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* kernel counter temps */</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERCONFIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGSTRUCT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGICOUNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
			<span class="k">return</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
			<span class="k">return</span> <span class="n">set_serial_info</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TIOCSERCONFIG</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>: <span class="cm">/* Get line status register */</span>
			<span class="k">return</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">TIOCSERGSTRUCT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span>
					 <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_state</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for any of the 4 modem inputs (DCD,RI,DSR,CTS) to change</span>
<span class="cm">		 * - mask passed in arg for lines of interest</span>
<span class="cm"> 		 *   (use |&#39;ed TIOCM_RNG/DSR/CD/CTS for masking)</span>
<span class="cm">		 * Caller should use TIOCGICOUNT to see which one it was</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* note the counters on entry */</span>
			<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
				<span class="cm">/* see if a signal did it */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span> <span class="cm">/* atomic copy */</span>
				<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span> 
				    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* no change =&gt; error */</span>
				<span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
				     <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
				     <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
				     <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* NOTREACHED */</span>

		<span class="k">case</span> <span class="n">TIOCSERGWILD</span>:
		<span class="k">case</span> <span class="n">TIOCSERSWILD</span>:
			<span class="cm">/* &quot;setserial -W&quot; is called in Debian boot */</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;TIOCSER?WILD ioctl obsolete, ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">change_speed</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_DTR</span><span class="o">|</span><span class="n">SER_RTS</span><span class="p">);</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_RTS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * No need to wake up processes in open wait, since they</span>
<span class="c">	 * sample the CLOCAL flag once, and don&#39;t recheck it.</span>
<span class="c">	 * XXX  It&#39;s not clear whether the current behavior is correct</span>
<span class="c">	 * or not.  Hence, this may change.....</span>
<span class="c">	 */</span>
<span class="c">	if (!(old_termios-&gt;c_cflag &amp; CLOCAL) &amp;&amp;</span>
<span class="c">	    (tty-&gt;termios-&gt;c_cflag &amp; CLOCAL))</span>
<span class="c">		wake_up_interruptible(&amp;info-&gt;open_wait);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_close()</span>
<span class="cm"> * </span>
<span class="cm"> * This routine is called when the serial port gets closed.  First, we</span>
<span class="cm"> * wait for the last remaining data to be sent.  Then, we unlink its</span>
<span class="cm"> * async structure from the interrupt chain if necessary, and we free</span>
<span class="cm"> * that IRQ if nothing is left in the chain.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point we stop accepting input.  To do this, we</span>
<span class="cm">	 * disable the receive line status interrupts, and tell the</span>
<span class="cm">	 * interrupt driver to stop checking the data ready bit in the</span>
<span class="cm">	 * line status register.</span>
<span class="cm">	 */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
	        <span class="cm">/* disable receive interrupts */</span>
	        <span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_RBF</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="cm">/* clear any pending receive interrupt */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_RBF</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Before we drop DTR, make sure the UART transmitter</span>
<span class="cm">		 * has completely drained; this is especially</span>
<span class="cm">		 * important if there is a transmit FIFO!</span>
<span class="cm">		 */</span>
		<span class="n">rs_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_wait_until_sent() --- wait until the transmitter is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">,</span> <span class="n">char_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Just in case.... */</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the check interval to be 1/5 of the estimated time to</span>
<span class="cm">	 * send a single character, and make it at least 1.  The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 * </span>
<span class="cm">	 * Note: we have to use pretty tight timings here to satisfy</span>
<span class="cm">	 * the NIST-PCTS.</span>
<span class="cm">	 */</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="n">char_time</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">char_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
	  <span class="n">char_time</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">char_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the transmitter hasn&#39;t cleared in twice the approximate</span>
<span class="cm">	 * amount of time to send the entire FIFO, it probably won&#39;t</span>
<span class="cm">	 * ever clear.  This assumes the UART isn&#39;t doing flow</span>
<span class="cm">	 * control, which is currently the case.  Hence, if it ever</span>
<span class="cm">	 * takes longer than info-&gt;timeout, this is probably due to a</span>
<span class="cm">	 * UART bug of some kind.  So, we clamp the timeout parameter at</span>
<span class="cm">	 * 2*info-&gt;timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_RS_WAIT_UNTIL_SENT</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;In rs_wait_until_sent(%d) check=%lu...&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">char_time</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jiff=%lu...&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">lsr</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDR_TSRE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_RS_WAIT_UNTIL_SENT</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;serdatr = %d (jiff=%lu)...&quot;</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

<span class="cp">#ifdef SERIAL_DEBUG_RS_WAIT_UNTIL_SENT</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lsr = %d (jiff=%lu)...done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.  It</span>
<span class="cm"> * enables interrupts for a serial port, linking in its async structure into</span>
<span class="cm"> * the IRQ chain.   It also performs the serial-specific</span>
<span class="cm"> * initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * /proc fs routines....</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d: uart:amiga_builtin&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ciab</span><span class="p">.</span><span class="n">pra</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">:</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SER_RTS</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RTS&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_CTS</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CTS&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SER_DTR</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DTR&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_DSR</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DSR&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CD&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">quot</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; baud:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">/</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">quot</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; tx:%d rx:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Last thing is the RS-232 status lines</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_buf</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;serinfo:1.0 driver:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_version</span><span class="p">);</span>
	<span class="n">line_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">rs_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rs_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">rs_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> * rs_init() and friends</span>
<span class="cm"> *</span>
<span class="cm"> * rs_init() is called at boot-time to initialize the serial driver.</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine prints out the appropriate serial driver version</span>
<span class="cm"> * number, and identifies which options were configured into this</span>
<span class="cm"> * driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_serial_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_name</span><span class="p">,</span> <span class="n">serial_version</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">serial_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">rs_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">rs_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">rs_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">rs_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">rs_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">rs_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">rs_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">rs_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">rs_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">rs_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">rs_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">rs_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">rs_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">rs_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">rs_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">rs_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">rs_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">rs_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">rs_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">rs_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rs_proc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amiga_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">ciab</span><span class="p">.</span><span class="n">pra</span> <span class="o">&amp;</span> <span class="n">SER_DCD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amiga_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_state</span><span class="p">,</span>
			<span class="n">tport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raise</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">|=</span> <span class="n">SER_DTR</span><span class="o">|</span><span class="n">SER_RTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_DTR</span><span class="o">|</span><span class="n">SER_RTS</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rtsdtr_ctrl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">MCR</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">amiga_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">amiga_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">amiga_dtr_rts</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The serial driver boot-time initialization code!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amiga_serial_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_PORTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">show_serial_version</span><span class="p">();</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>

	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;amiserial&quot;</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
		<span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial_ops</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_put_tty_driver</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">rs_table</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span><span class="p">;</span> <span class="cm">/* Just to give it a value */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span> <span class="o">=</span> 
	  <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amiga_port_ops</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ttyS0 is the amiga builtin serial port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Hardware set up */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">amiga_colorclock</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set ISRs, and then disable the rx interrupts */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_TBE</span><span class="p">,</span> <span class="n">ser_tx_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;serial TX&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unregister</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_RBF</span><span class="p">,</span> <span class="n">ser_rx_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="s">&quot;serial RX&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_irq</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* turn off Rx and Tx interrupts */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_RBF</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* clear any pending interrupt */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">intreq</span> <span class="o">=</span> <span class="n">IF_RBF</span> <span class="o">|</span> <span class="n">IF_TBE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the appropriate directions for the modem control flags,</span>
<span class="cm">	 * and clear RTS and DTR</span>
<span class="cm">	 */</span>
	<span class="n">ciab</span><span class="p">.</span><span class="n">ddra</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SER_DTR</span> <span class="o">|</span> <span class="n">SER_RTS</span><span class="p">);</span>   <span class="cm">/* outputs */</span>
	<span class="n">ciab</span><span class="p">.</span><span class="n">ddra</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_DCD</span> <span class="o">|</span> <span class="n">SER_CTS</span> <span class="o">|</span> <span class="n">SER_DSR</span><span class="p">);</span>  <span class="cm">/* inputs */</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_TBE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="nl">fail_unregister:</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
<span class="nl">fail_put_tty_driver:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">amiga_serial_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* printk(&quot;Unloading %s: version %s\n&quot;, serial_name, serial_version); */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">)))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SERIAL: failed to unregister serial driver (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">error</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_TBE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_RBF</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">amiga_serial_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">amiga_serial_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;amiga-serial&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amiga_serial_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amiga_serial_driver</span><span class="p">,</span> <span class="n">amiga_serial_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amiga_serial_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amiga_serial_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amiga_serial_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">amiga_serial_exit</span><span class="p">);</span>


<span class="cp">#if defined(CONFIG_SERIAL_CONSOLE) &amp;&amp; !defined(MODULE)</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * Serial console driver</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amiga_serial_putc</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">serdat</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">c</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">custom</span><span class="p">.</span><span class="n">serdatr</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">))</span>
		<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Print a string to the serial port trying not to disturb</span>
<span class="cm"> *	any possible real use of the port...</span>
<span class="cm"> *</span>
<span class="cm"> *	The console must be locked when we get here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">intena</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">intenar</span><span class="p">;</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_TBE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">amiga_serial_putc</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">);</span>
		<span class="n">amiga_serial_putc</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="p">(</span><span class="n">intena</span> <span class="o">&amp;</span> <span class="n">IF_TBE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="nf">serial_console_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">serial_driver</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">sercons</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">serial_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span>	<span class="n">serial_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Register console.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amiserial_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sercons</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">amiserial_console_init</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_CONSOLE &amp;&amp; !MODULE */</span><span class="cp"></span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:amiga-serial&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
