<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › synclinkmp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>synclinkmp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * $Id: synclinkmp.c,v 4.38 2005/07/15 13:29:44 paulkf Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Device driver for Microgate SyncLink Multiport</span>
<span class="cm"> * high speed multiprotocol serial adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * written by Paul Fulghum for Microgate Corporation</span>
<span class="cm"> * paulkf@microgate.com</span>
<span class="cm"> *</span>
<span class="cm"> * Microgate and SyncLink are trademarks of Microgate Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from serial.c written by Theodore Ts&#39;o and Linus Torvalds</span>
<span class="cm"> * This code is released under the GNU General Public License (GPL)</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,</span>
<span class="cm"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="cm"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED</span>
<span class="cm"> * OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#define VERSION(ver,rel,seq) (((ver)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))</span>
<span class="cp">#if defined(__i386__)</span>
<span class="cp">#  define BREAKPOINT() asm(&quot;   int $3&quot;);</span>
<span class="cp">#else</span>
<span class="cp">#  define BREAKPOINT() { }</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_DEVICES 12</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/hdlc.h&gt;</span>
<span class="cp">#include &lt;linux/synclink.h&gt;</span>

<span class="cp">#if defined(CONFIG_HDLC) || (defined(CONFIG_HDLC_MODULE) &amp;&amp; defined(CONFIG_SYNCLINKMP_MODULE))</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 1</span>
<span class="cp">#else</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 0</span>
<span class="cp">#endif</span>

<span class="cp">#define GET_USER(error,value,addr) error = get_user(value,addr)</span>
<span class="cp">#define COPY_FROM_USER(error,dest,src,size) error = copy_from_user(dest,src,size) ? -EFAULT : 0</span>
<span class="cp">#define PUT_USER(error,value,addr) error = put_user(value,addr)</span>
<span class="cp">#define COPY_TO_USER(error,dest,src,size) error = copy_to_user(dest,src,size) ? -EFAULT : 0</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="n">MGSL_PARAMS</span> <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGSL_MODE_HDLC</span><span class="p">,</span>			<span class="cm">/* unsigned long mode */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* unsigned char loopback; */</span>
	<span class="n">HDLC_FLAG_UNDERRUN_ABORT15</span><span class="p">,</span>	<span class="cm">/* unsigned short flags; */</span>
	<span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">,</span>	<span class="cm">/* unsigned char encoding; */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* unsigned long clock_speed; */</span>
	<span class="mh">0xff</span><span class="p">,</span>				<span class="cm">/* unsigned char addr_filter; */</span>
	<span class="n">HDLC_CRC_16_CCITT</span><span class="p">,</span>		<span class="cm">/* unsigned short crc_type; */</span>
	<span class="n">HDLC_PREAMBLE_LENGTH_8BITS</span><span class="p">,</span>	<span class="cm">/* unsigned char preamble_length; */</span>
	<span class="n">HDLC_PREAMBLE_PATTERN_NONE</span><span class="p">,</span>	<span class="cm">/* unsigned char preamble; */</span>
	<span class="mi">9600</span><span class="p">,</span>				<span class="cm">/* unsigned long data_rate; */</span>
	<span class="mi">8</span><span class="p">,</span>				<span class="cm">/* unsigned char data_bits; */</span>
	<span class="mi">1</span><span class="p">,</span>				<span class="cm">/* unsigned char stop_bits; */</span>
	<span class="n">ASYNC_PARITY_NONE</span>		<span class="cm">/* unsigned char parity; */</span>
<span class="p">};</span>

<span class="cm">/* size in bytes of DMA data buffers */</span>
<span class="cp">#define SCABUFSIZE 	1024</span>
<span class="cp">#define SCA_MEM_SIZE	0x40000</span>
<span class="cp">#define SCA_BASE_SIZE   512</span>
<span class="cp">#define SCA_REG_SIZE    16</span>
<span class="cp">#define SCA_MAX_PORTS   4</span>
<span class="cp">#define SCAMAXDESC 	128</span>

<span class="cp">#define	BUFFERLISTSIZE	4096</span>

<span class="cm">/* SCA-I style DMA buffer descriptor */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SCADESC</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">next</span><span class="p">;</span>		<span class="cm">/* lower l6 bits of next descriptor addr */</span>
	<span class="n">u16</span>	<span class="n">buf_ptr</span><span class="p">;</span>	<span class="cm">/* lower 16 bits of buffer addr */</span>
	<span class="n">u8</span>	<span class="n">buf_base</span><span class="p">;</span>	<span class="cm">/* upper 8 bits of buffer addr */</span>
	<span class="n">u8</span>	<span class="n">pad1</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">length</span><span class="p">;</span>		<span class="cm">/* length of buffer */</span>
	<span class="n">u8</span>	<span class="n">status</span><span class="p">;</span>		<span class="cm">/* status of buffer */</span>
	<span class="n">u8</span>	<span class="n">pad2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SCADESC</span><span class="p">,</span> <span class="o">*</span><span class="n">PSCADESC</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SCADESC_EX</span>
<span class="p">{</span>
	<span class="cm">/* device driver bookkeeping section */</span>
	<span class="kt">char</span> 	<span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span>    	<span class="cm">/* virtual address of data buffer */</span>
	<span class="n">u16</span>	<span class="n">phys_entry</span><span class="p">;</span>	<span class="cm">/* lower 16-bits of physical address of this descriptor */</span>
<span class="p">}</span> <span class="n">SCADESC_EX</span><span class="p">,</span> <span class="o">*</span><span class="n">PSCADESC_EX</span><span class="p">;</span>

<span class="cm">/* The queue of BH actions to be performed */</span>

<span class="cp">#define BH_RECEIVE  1</span>
<span class="cp">#define BH_TRANSMIT 2</span>
<span class="cp">#define BH_STATUS   4</span>

<span class="cp">#define IO_PIN_SHUTDOWN_LIMIT 100</span>

<span class="k">struct</span>	<span class="n">_input_signal_events</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ri_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ri_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dsr_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dsr_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dcd_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dcd_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cts_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cts_down</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Device instance data structure</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_synclinkmp_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">if_ptr</span><span class="p">;</span>				<span class="cm">/* General purpose pointer (used by SPPP) */</span>
	<span class="kt">int</span>			<span class="n">magic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span>		<span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">close_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">closing_wait</span><span class="p">;</span>	<span class="cm">/* time to wait before closing */</span>

	<span class="k">struct</span> <span class="n">mgsl_icount</span>	<span class="n">icount</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">x_char</span><span class="p">;</span>		<span class="cm">/* xon/xoff character */</span>
	<span class="n">u16</span>			<span class="n">read_status_mask1</span><span class="p">;</span>  <span class="cm">/* break detection (SR1 indications) */</span>
	<span class="n">u16</span>			<span class="n">read_status_mask2</span><span class="p">;</span>  <span class="cm">/* parity/framing/overun (SR2 indications) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> 		<span class="n">ignore_status_mask1</span><span class="p">;</span>  <span class="cm">/* break detection (SR1 indications) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ignore_status_mask2</span><span class="p">;</span>  <span class="cm">/* parity/framing/overun (SR2 indications) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> 		<span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tx_put</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tx_get</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tx_count</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span>	<span class="n">status_event_wait_q</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">event_wait_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tx_timer</span><span class="p">;</span>	<span class="cm">/* HDLC transmit timeout timer */</span>
	<span class="k">struct</span> <span class="n">_synclinkmp_info</span>	<span class="o">*</span><span class="n">next_device</span><span class="p">;</span>	<span class="cm">/* device list link */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">status_timer</span><span class="p">;</span>	<span class="cm">/* input signal status check timer */</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>		<span class="cm">/* spinlock for synchronizing with ISR */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">task</span><span class="p">;</span>	 		<span class="cm">/* task structure for scheduling bh */</span>

	<span class="n">u32</span> <span class="n">max_frame_size</span><span class="p">;</span>			<span class="cm">/* as set by device config */</span>

	<span class="n">u32</span> <span class="n">pending_bh</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">bh_running</span><span class="p">;</span>				<span class="cm">/* Protection from multiple */</span>
	<span class="kt">int</span> <span class="n">isr_overflow</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bh_requested</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dcd_chkcount</span><span class="p">;</span>			<span class="cm">/* check counts to prevent */</span>
	<span class="kt">int</span> <span class="n">cts_chkcount</span><span class="p">;</span>			<span class="cm">/* too many IRQs if a signal */</span>
	<span class="kt">int</span> <span class="n">dsr_chkcount</span><span class="p">;</span>			<span class="cm">/* is floating */</span>
	<span class="kt">int</span> <span class="n">ri_chkcount</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer_list</span><span class="p">;</span>			<span class="cm">/* virtual address of Rx &amp; Tx buffer lists */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buffer_list_phys</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_count</span><span class="p">;</span>		<span class="cm">/* count of total allocated Rx buffers */</span>
	<span class="n">SCADESC</span> <span class="o">*</span><span class="n">rx_buf_list</span><span class="p">;</span>   		<span class="cm">/* list of receive buffer entries */</span>
	<span class="n">SCADESC_EX</span> <span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">SCAMAXDESC</span><span class="p">];</span> <span class="cm">/* list of receive buffer entries */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_rx_buf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_buf_count</span><span class="p">;</span>		<span class="cm">/* count of total allocated Tx buffers */</span>
	<span class="n">SCADESC</span> <span class="o">*</span><span class="n">tx_buf_list</span><span class="p">;</span>		<span class="cm">/* list of transmit buffer entries */</span>
	<span class="n">SCADESC_EX</span> <span class="n">tx_buf_list_ex</span><span class="p">[</span><span class="n">SCAMAXDESC</span><span class="p">];</span> <span class="cm">/* list of transmit buffer entries */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_tx_buf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp_rx_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_rx_buf_count</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">rx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_overflow</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">tx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idle_mode</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ie0_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ie1_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ie2_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ctrlreg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_signals</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">device_name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>			<span class="cm">/* device instance name */</span>

	<span class="kt">int</span> <span class="n">port_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adapter_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">_synclinkmp_info</span> <span class="o">*</span><span class="n">port_array</span><span class="p">[</span><span class="n">SCA_MAX_PORTS</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_type</span><span class="p">;</span>			<span class="cm">/* expansion bus type (ISA,EISA,PCI) */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_level</span><span class="p">;</span>			<span class="cm">/* interrupt level */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">irq_requested</span><span class="p">;</span>			<span class="cm">/* true if IRQ requested */</span>

	<span class="n">MGSL_PARAMS</span> <span class="n">params</span><span class="p">;</span>			<span class="cm">/* communications parameters */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">serial_signals</span><span class="p">;</span>		<span class="cm">/* current serial signal states */</span>

	<span class="n">bool</span> <span class="n">irq_occurred</span><span class="p">;</span>			<span class="cm">/* for diagnostics use */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init_error</span><span class="p">;</span>		<span class="cm">/* Initialization startup error */</span>

	<span class="n">u32</span> <span class="n">last_mem_alloc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">memory_base</span><span class="p">;</span>		<span class="cm">/* shared memory address (PCI only) */</span>
	<span class="n">u32</span> <span class="n">phys_memory_base</span><span class="p">;</span>
    	<span class="kt">int</span> <span class="n">shared_mem_requested</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sca_base</span><span class="p">;</span>		<span class="cm">/* HD64570 SCA Memory address */</span>
	<span class="n">u32</span> <span class="n">phys_sca_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sca_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sca_base_requested</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">lcr_base</span><span class="p">;</span>		<span class="cm">/* local config registers (PCI only) */</span>
	<span class="n">u32</span> <span class="n">phys_lcr_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lcr_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lcr_mem_requested</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">statctrl_base</span><span class="p">;</span>		<span class="cm">/* status/control register memory */</span>
	<span class="n">u32</span> <span class="n">phys_statctrl_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">statctrl_offset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sca_statctrl_requested</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">misc_ctrl_value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">flag_buf</span><span class="p">[</span><span class="n">MAX_ASYNC_BUFFER_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">char_buf</span><span class="p">[</span><span class="n">MAX_ASYNC_BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">drop_rts_on_tx_done</span><span class="p">;</span>

	<span class="k">struct</span>	<span class="n">_input_signal_events</span>	<span class="n">input_signal_events</span><span class="p">;</span>

	<span class="cm">/* SPPP/Cisco HDLC device parts */</span>
	<span class="kt">int</span> <span class="n">netcount</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">netlock</span><span class="p">;</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="n">SLMP_INFO</span><span class="p">;</span>

<span class="cp">#define MGSL_MAGIC 0x5401</span>

<span class="cm">/*</span>
<span class="cm"> * define serial signal status change macros</span>
<span class="cm"> */</span>
<span class="cp">#define	MISCSTATUS_DCD_LATCHED	(SerialSignal_DCD&lt;&lt;8)	</span><span class="cm">/* indicates change in DCD */</span><span class="cp"></span>
<span class="cp">#define MISCSTATUS_RI_LATCHED	(SerialSignal_RI&lt;&lt;8)	</span><span class="cm">/* indicates change in RI */</span><span class="cp"></span>
<span class="cp">#define MISCSTATUS_CTS_LATCHED	(SerialSignal_CTS&lt;&lt;8)	</span><span class="cm">/* indicates change in CTS */</span><span class="cp"></span>
<span class="cp">#define MISCSTATUS_DSR_LATCHED	(SerialSignal_DSR&lt;&lt;8)	</span><span class="cm">/* change in DSR */</span><span class="cp"></span>

<span class="cm">/* Common Register macros */</span>
<span class="cp">#define LPR	0x00</span>
<span class="cp">#define PABR0	0x02</span>
<span class="cp">#define PABR1	0x03</span>
<span class="cp">#define WCRL	0x04</span>
<span class="cp">#define WCRM	0x05</span>
<span class="cp">#define WCRH	0x06</span>
<span class="cp">#define DPCR	0x08</span>
<span class="cp">#define DMER	0x09</span>
<span class="cp">#define ISR0	0x10</span>
<span class="cp">#define ISR1	0x11</span>
<span class="cp">#define ISR2	0x12</span>
<span class="cp">#define IER0	0x14</span>
<span class="cp">#define IER1	0x15</span>
<span class="cp">#define IER2	0x16</span>
<span class="cp">#define ITCR	0x18</span>
<span class="cp">#define INTVR 	0x1a</span>
<span class="cp">#define IMVR	0x1c</span>

<span class="cm">/* MSCI Register macros */</span>
<span class="cp">#define TRB	0x20</span>
<span class="cp">#define TRBL	0x20</span>
<span class="cp">#define TRBH	0x21</span>
<span class="cp">#define SR0	0x22</span>
<span class="cp">#define SR1	0x23</span>
<span class="cp">#define SR2	0x24</span>
<span class="cp">#define SR3	0x25</span>
<span class="cp">#define FST	0x26</span>
<span class="cp">#define IE0	0x28</span>
<span class="cp">#define IE1	0x29</span>
<span class="cp">#define IE2	0x2a</span>
<span class="cp">#define FIE	0x2b</span>
<span class="cp">#define CMD	0x2c</span>
<span class="cp">#define MD0	0x2e</span>
<span class="cp">#define MD1	0x2f</span>
<span class="cp">#define MD2	0x30</span>
<span class="cp">#define CTL	0x31</span>
<span class="cp">#define SA0	0x32</span>
<span class="cp">#define SA1	0x33</span>
<span class="cp">#define IDL	0x34</span>
<span class="cp">#define TMC	0x35</span>
<span class="cp">#define RXS	0x36</span>
<span class="cp">#define TXS	0x37</span>
<span class="cp">#define TRC0	0x38</span>
<span class="cp">#define TRC1	0x39</span>
<span class="cp">#define RRC	0x3a</span>
<span class="cp">#define CST0	0x3c</span>
<span class="cp">#define CST1	0x3d</span>

<span class="cm">/* Timer Register Macros */</span>
<span class="cp">#define TCNT	0x60</span>
<span class="cp">#define TCNTL	0x60</span>
<span class="cp">#define TCNTH	0x61</span>
<span class="cp">#define TCONR	0x62</span>
<span class="cp">#define TCONRL	0x62</span>
<span class="cp">#define TCONRH	0x63</span>
<span class="cp">#define TMCS	0x64</span>
<span class="cp">#define TEPR	0x65</span>

<span class="cm">/* DMA Controller Register macros */</span>
<span class="cp">#define DARL	0x80</span>
<span class="cp">#define DARH	0x81</span>
<span class="cp">#define DARB	0x82</span>
<span class="cp">#define BAR	0x80</span>
<span class="cp">#define BARL	0x80</span>
<span class="cp">#define BARH	0x81</span>
<span class="cp">#define BARB	0x82</span>
<span class="cp">#define SAR	0x84</span>
<span class="cp">#define SARL	0x84</span>
<span class="cp">#define SARH	0x85</span>
<span class="cp">#define SARB	0x86</span>
<span class="cp">#define CPB	0x86</span>
<span class="cp">#define CDA	0x88</span>
<span class="cp">#define CDAL	0x88</span>
<span class="cp">#define CDAH	0x89</span>
<span class="cp">#define EDA	0x8a</span>
<span class="cp">#define EDAL	0x8a</span>
<span class="cp">#define EDAH	0x8b</span>
<span class="cp">#define BFL	0x8c</span>
<span class="cp">#define BFLL	0x8c</span>
<span class="cp">#define BFLH	0x8d</span>
<span class="cp">#define BCR	0x8e</span>
<span class="cp">#define BCRL	0x8e</span>
<span class="cp">#define BCRH	0x8f</span>
<span class="cp">#define DSR	0x90</span>
<span class="cp">#define DMR	0x91</span>
<span class="cp">#define FCT	0x93</span>
<span class="cp">#define DIR	0x94</span>
<span class="cp">#define DCMD	0x95</span>

<span class="cm">/* combine with timer or DMA register address */</span>
<span class="cp">#define TIMER0	0x00</span>
<span class="cp">#define TIMER1	0x08</span>
<span class="cp">#define TIMER2	0x10</span>
<span class="cp">#define TIMER3	0x18</span>
<span class="cp">#define RXDMA 	0x00</span>
<span class="cp">#define TXDMA 	0x20</span>

<span class="cm">/* SCA Command Codes */</span>
<span class="cp">#define NOOP		0x00</span>
<span class="cp">#define TXRESET		0x01</span>
<span class="cp">#define TXENABLE	0x02</span>
<span class="cp">#define TXDISABLE	0x03</span>
<span class="cp">#define TXCRCINIT	0x04</span>
<span class="cp">#define TXCRCEXCL	0x05</span>
<span class="cp">#define TXEOM		0x06</span>
<span class="cp">#define TXABORT		0x07</span>
<span class="cp">#define MPON		0x08</span>
<span class="cp">#define TXBUFCLR	0x09</span>
<span class="cp">#define RXRESET		0x11</span>
<span class="cp">#define RXENABLE	0x12</span>
<span class="cp">#define RXDISABLE	0x13</span>
<span class="cp">#define RXCRCINIT	0x14</span>
<span class="cp">#define RXREJECT	0x15</span>
<span class="cp">#define SEARCHMP	0x16</span>
<span class="cp">#define RXCRCEXCL	0x17</span>
<span class="cp">#define RXCRCCALC	0x18</span>
<span class="cp">#define CHRESET		0x21</span>
<span class="cp">#define HUNT		0x31</span>

<span class="cm">/* DMA command codes */</span>
<span class="cp">#define SWABORT		0x01</span>
<span class="cp">#define FEICLEAR	0x02</span>

<span class="cm">/* IE0 */</span>
<span class="cp">#define TXINTE 		BIT7</span>
<span class="cp">#define RXINTE 		BIT6</span>
<span class="cp">#define TXRDYE 		BIT1</span>
<span class="cp">#define RXRDYE 		BIT0</span>

<span class="cm">/* IE1 &amp; SR1 */</span>
<span class="cp">#define UDRN   	BIT7</span>
<span class="cp">#define IDLE   	BIT6</span>
<span class="cp">#define SYNCD  	BIT4</span>
<span class="cp">#define FLGD   	BIT4</span>
<span class="cp">#define CCTS   	BIT3</span>
<span class="cp">#define CDCD   	BIT2</span>
<span class="cp">#define BRKD   	BIT1</span>
<span class="cp">#define ABTD   	BIT1</span>
<span class="cp">#define GAPD   	BIT1</span>
<span class="cp">#define BRKE   	BIT0</span>
<span class="cp">#define IDLD	BIT0</span>

<span class="cm">/* IE2 &amp; SR2 */</span>
<span class="cp">#define EOM	BIT7</span>
<span class="cp">#define PMP	BIT6</span>
<span class="cp">#define SHRT	BIT6</span>
<span class="cp">#define PE	BIT5</span>
<span class="cp">#define ABT	BIT5</span>
<span class="cp">#define FRME	BIT4</span>
<span class="cp">#define RBIT	BIT4</span>
<span class="cp">#define OVRN	BIT3</span>
<span class="cp">#define CRCE	BIT2</span>


<span class="cm">/*</span>
<span class="cm"> * Global linked list of SyncLink devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">synclinkmp_device_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">synclinkmp_adapter_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">synclinkmp_device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Set this param to non-zero to load eax with the</span>
<span class="cm"> * .text section address and breakpoint on module load.</span>
<span class="cm"> * This is useful for use with gdb and add-symbol-file command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">break_on_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Driver major number, defaults to zero to get auto</span>
<span class="cm"> * assigned major number. May be forced as module parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ttymajor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Array of user specified options for ISA adapters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">MAX_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">break_on_load</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">maxframe</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;SyncLink MultiPort driver&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_version</span> <span class="o">=</span> <span class="s">&quot;$Revision: 4.38 $&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">synclinkmp_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">synclinkmp_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">synclinkmp_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MICROGATE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MICROGATE_SCA</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">synclinkmp_pci_tbl</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">synclinkmp_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;synclinkmp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">synclinkmp_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">synclinkmp_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">synclinkmp_remove_one</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="cm">/* number of characters left in xmit buffer before we ask for more */</span>
<span class="cp">#define WAKEUP_CHARS 256</span>


<span class="cm">/* tty callbacks */</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
<span class="cp">#define dev_to_port(D) (dev_to_hdlc(D)-&gt;priv)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_rx</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">hdlcdev_init</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_exit</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* ioctl handlers */</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_stats</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">get_txidle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_txidle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tx_enable</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tx_abort</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">rx_enable</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">modem_input_wait</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="kt">int</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">wait_mgsl_event</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">add_device</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">device_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">claim_resources</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_resources</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">startup</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">block_til_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">shutdown</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">program_hw</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">change_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">init_adapter</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">register_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">irq_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">loopback_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">adapter_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">memory_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_adapter</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_port</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">async_mode</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlc_mode</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_stop</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_start</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_reset_buffers</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_free_frame_buffers</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">rx_get_frame</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_start</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_stop</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_load_fifo</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_set_idle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">get_signals</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_signals</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">enable_loopback</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rate</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_rate</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">bh_action</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_receive</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_transmit</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_status</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_timer</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_rxint</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_rxrdy</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_txint</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_txrdy</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_rxdmaok</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_rxdmaerror</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_txdmaok</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_txdmaerror</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isr_io_pin</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_dma_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_buf_list</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_frame_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">SCADESC</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="n">SCADESC_EX</span> <span class="o">*</span><span class="n">list_ex</span><span class="p">,</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">alloc_tmp_rx_buf</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_tmp_rx_buf</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">load_pci_memory</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">trace_block</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">status_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_reg16</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">read_status_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_control_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_active_fifo_level</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="c1">// rx request FIFO activation level in bytes</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_active_fifo_level</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="c1">// tx request FIFO activation level in bytes</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_negate_fifo_level</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="c1">// tx request FIFO negation level in bytes</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">misc_ctrl_value</span> <span class="o">=</span> <span class="mh">0x007e4040</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">lcr1_brdr_value</span> <span class="o">=</span> <span class="mh">0x00800028</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">read_ahead_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="cm">/* DPCR, DMA Priority Control</span>
<span class="cm"> *</span>
<span class="cm"> * 07..05  Not used, must be 0</span>
<span class="cm"> * 04      BRC, bus release condition: 0=all transfers complete</span>
<span class="cm"> *              1=release after 1 xfer on all channels</span>
<span class="cm"> * 03      CCC, channel change condition: 0=every cycle</span>
<span class="cm"> *              1=after each channel completes all xfers</span>
<span class="cm"> * 02..00  PR&lt;2..0&gt;, priority 100=round robin</span>
<span class="cm"> *</span>
<span class="cm"> * 00000100 = 0x00</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma_priority</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Number of bytes that can be written to shared RAM
in a single write operation</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u32</span> <span class="n">sca_pci_load_interval</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * 1st function defined in .text section. Calling this function in</span>
<span class="cm"> * init_module() followed by a breakpoint allows a remote debugger</span>
<span class="cm"> * (gdb) to get the .text address for the add-symbol-file command.</span>
<span class="cm"> * This allows remote debugging of dynamically loadable modules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">synclinkmp_get_text_ptr</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">synclinkmp_get_text_ptr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">synclinkmp_get_text_ptr</span><span class="p">;}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sanity_check</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SANITY_CHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badmagic</span> <span class="o">=</span>
		<span class="s">&quot;Warning: bad magic number for synclinkmp_struct (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badinfo</span> <span class="o">=</span>
		<span class="s">&quot;Warning: null synclinkmp_struct for (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badinfo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">MGSL_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badmagic</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * line discipline callback wrappers</span>
<span class="cm"> *</span>
<span class="cm"> * The wrappers maintain line discipline references</span>
<span class="cm"> * while calling into the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * ldisc_receive_buf  - pass receive data to line discipline</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ldisc_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tty callbacks */</span>

<span class="cm">/* Called when a port is opened.  Init and enable port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">synclinkmp_device_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): open with invalid line #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">line</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">synclinkmp_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">!=</span> <span class="n">line</span><span class="p">)</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s device is not allocated, init error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s open(), old ref count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* If port is closing, signal caller to try again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_wait</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1st open on this device, init hardware */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">block_til_ready</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s block_til_ready() returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s open() success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* tty layer will release tty struct */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when port is closed. Wait for remaining data to be</span>
<span class="cm"> * sent. Disable port and free resources.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s close() entry, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
 		<span class="n">wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s close() exit, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> * This is the same as closing all open descriptors for the port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s hangup()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set new termios settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s set_termios()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">);</span>

	<span class="n">change_params</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span>
 		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
 		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_release</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send a block of data</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * 	tty		pointer to tty information structure</span>
<span class="cm"> * 	buf		pointer to buffer containing send data</span>
<span class="cm"> * 	count		size of send data in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:	number of characters written</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">c</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s write() count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send accumulated data from send_char() calls */</span>
			<span class="cm">/* as frame and wait before accepting more data. */</span>
			<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">min</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">start:</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
		 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="p">}</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s write() returning=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a character to the transmit buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s put_char(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send a high-priority XON/XOFF character</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s send_xchar(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ch</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;send_xchar&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure transmit interrupts are on */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
		 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Wait until the transmitter is empty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">,</span> <span class="n">char_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s wait_until_sent() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Set check interval to 1/5 of estimated time to</span>
<span class="cm">	 * send a character, and make it at least 1. The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 * Note: use tight timings here to satisfy the NIST-PCTS.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="p">)</span> <span class="p">{</span>
	       	<span class="n">char_time</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">char_time</span><span class="p">)</span>
			<span class="n">char_time</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">char_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: determine if there is something similar to USC16C32</span>
<span class="cm">		 * 	 TXSTATUS_ALL_SENT status</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s wait_until_sent() exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return the count of free bytes in transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">HDLC_MAX_FRAME_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s write_room()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enable transmitter and send remaining buffered characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s flush_chars() entry tx_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s flush_chars() entry, starting transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* operating in synchronous (frame oriented) mode */</span>
			<span class="cm">/* copy data from circular tx_buf to */</span>
			<span class="cm">/* transmit DMA buffer. */</span>
			<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
		<span class="p">}</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Discard all data in the send buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s flush_buffer() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* throttle (stop) transmitter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_hold&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_hold()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
	 	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* release (start) transmitter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_release&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_release()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Service an IOCTL request</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * 	tty	pointer to tty instance data</span>
<span class="cm"> * 	cmd	IOCTL command code</span>
<span class="cm"> * 	arg	command argument/context</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:	0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s ioctl() cmd=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">cmd</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGPARAMS</span>:
		<span class="k">return</span> <span class="n">get_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSPARAMS</span>:
		<span class="k">return</span> <span class="n">set_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGTXIDLE</span>:
		<span class="k">return</span> <span class="n">get_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSTXIDLE</span>:
		<span class="k">return</span> <span class="n">set_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXENABLE</span>:
		<span class="k">return</span> <span class="n">tx_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCRXENABLE</span>:
		<span class="k">return</span> <span class="n">rx_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXABORT</span>:
		<span class="k">return</span> <span class="n">tx_abort</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGSTATS</span>:
		<span class="k">return</span> <span class="n">get_stats</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCWAITEVENT</span>:
		<span class="k">return</span> <span class="n">wait_mgsl_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCLOOPTXDONE</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TODO: Not supported, need to document</span>
		<span class="cm">/* Wait for modem input (DCD,RI,DSR,CTS) change</span>
<span class="cm">		 * as specified by mask in arg (TIOCM_RNG/DSR/CD/CTS)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="k">return</span> <span class="n">modem_input_wait</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)</span>
<span class="cm">		 * Return: write counters to the user passed counter struct</span>
<span class="cm">		 * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for</span>
<span class="cm">		 *     RI where only 0-&gt;1 is counted.</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* kernel counter temps */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * /proc fs routines....</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s: SCABase=%08x Mem=%08X StatusControl=%08x LCR=%08X</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">IRQ=%d MaxFrameSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="p">);</span>

	<span class="cm">/* output current serial signal states */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DTR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DSR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CD&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RI&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">HDLC txok:%d rxok:%d&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txunder:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txabort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxshort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxlong:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxover:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxlong:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ASYNC tx:%d rx:%d&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append serial signal status to end */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_buf</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">txactive=%d bh_req=%d bh_run=%d pending_bh=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span><span class="p">,</span>
	 <span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called to print information about devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synclinkmp_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;synclinkmp driver:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">synclinkmp_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">info</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">line_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synclinkmp_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">synclinkmp_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">synclinkmp_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">synclinkmp_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Return the count of bytes in transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s chars_in_buffer()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Signal remote device to throttle send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s throttle() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Signal remote device to stop throttling send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s unthrottle() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* set or clear transmit break condition</span>
<span class="cm"> * break_state	-1=set break condition, 0=clear</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegValue</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s set_break(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">break_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;set_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">RegValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT3</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer when protocol selected (PPP, frame relay, etc.)</span>
<span class="cm"> * set encoding and frame check sequence (FCS) options</span>
<span class="cm"> *</span>
<span class="cm"> * dev       pointer to network device structure</span>
<span class="cm"> * encoding  serial encoding setting</span>
<span class="cm"> * parity    FCS setting</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">new_encoding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZ</span>:        <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZ</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZI</span>:       <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_MARK</span>:    <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_SPACE</span>:   <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_MANCHESTER</span>: <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">parity</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">PARITY_NONE</span>:            <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_NONE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC16_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_16_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC32_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_32_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">new_encoding</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">=</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* if network interface up, reprogram hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer to send frame</span>
<span class="cm"> *</span>
<span class="cm"> * skb  socket buffer containing HDLC frame</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">hdlcdev_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:hdlc_xmit(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* stop sending until this frame completes */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* copy data to device buffers */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* update network statistics */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* done with socket buffer, so free it */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* save start time for transmit timeout detection */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* start hardware transmitter if necessary */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface enabled</span>
<span class="cm"> * claim resources and initialize hardware</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_open(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* generic HDLC layer open processing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* arbitrate between network and tty opens */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: hdlc_open returning busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* claim resources and init adapter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assert DTR and RTS, apply hardware settings */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* enable network layer transmit */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* inform generic HDLC layer of current DCD status */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface is disabled</span>
<span class="cm"> * shutdown hardware and release resources</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_close(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* shutdown adapter and release resources */</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer to process IOCTL call to network device</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> * ifr  pointer to network interface request structure</span>
<span class="cm"> * cmd  IOCTL command code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>
	<span class="n">sync_serial_settings</span> <span class="n">new_line</span><span class="p">;</span>
	<span class="n">sync_serial_settings</span> <span class="n">__user</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_ioctl(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCWANDEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_GET_IFACE</span>: <span class="cm">/* return current sync_serial_settings */</span>

		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_SYNC_SERIAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* data size wanted */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">){</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_EXT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_INT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXINT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXFROMRX</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_DEFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
		<span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>: <span class="cm">/* set sync_serial_settings */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">CLOCK_EXT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXFROMRX</span>: <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_INT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXINT</span>:    <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_DEFAULT</span>:  <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
					     <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if network interface up, reprogram hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
			<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when transmit timeout is detected</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hdlcdev_tx_timeout(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when transmit completes</span>
<span class="cm"> * reenable network layer transmit if stopped</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_done</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when frame received</span>
<span class="cm"> * pass frame to network layer</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> * buf   pointer to buffer contianing frame data</span>
<span class="cm"> * size  count of data bytes in buf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_rx</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hdlcdev_rx(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: can&#39;t alloc skb, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hdlcdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">hdlcdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">hdlcdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">hdlc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">hdlc_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">hdlcdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">hdlcdev_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when adding device instance</span>
<span class="cm"> * do generic HDLC initialization</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_init</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">;</span>

	<span class="cm">/* allocate and initialize network and HDLC layer objects */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:hdlc device allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for network layer reporting purposes only */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">+</span> <span class="n">SCA_BASE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>

	<span class="cm">/* network layer callbacks and settings */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	    <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdlcdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>   <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="cm">/* generic HDLC layer callbacks and settings */</span>
	<span class="n">hdlc</span>         <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">hdlcdev_attach</span><span class="p">;</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span>   <span class="o">=</span> <span class="n">hdlcdev_xmit</span><span class="p">;</span>

	<span class="cm">/* register objects with HDLC layer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:unable to register hdlc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when removing device instance</span>
<span class="cm"> * do generic HDLC cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_exit</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HDLC */</span><span class="cp"></span>


<span class="cm">/* Return next bottom half action to perform.</span>
<span class="cm"> * Return Value:	BH action code or 0 if nothing to do.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh_action</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_RECEIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_TRANSMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_STATUS</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mark BH routine as complete */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform bottom half processing of work items queued by ISR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">SLMP_INFO</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_handler() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">action</span> <span class="o">=</span> <span class="n">bh_action</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Process work item */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_handler() work item action=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">BH_RECEIVE</span>:
			<span class="n">bh_receive</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_TRANSMIT</span>:
			<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_STATUS</span>:
			<span class="n">bh_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown work item ID */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s Unknown work item ID=%08X!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">action</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_handler() exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_receive</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_receive()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span> <span class="n">rx_get_frame</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_transmit</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_transmit() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_status</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s bh_status() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_timer</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">timer</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIMER2</span> <span class="o">:</span> <span class="n">TIMER0</span><span class="p">;</span>

	<span class="cm">/* IER2&lt;7..4&gt; = timer&lt;3..0&gt; interrupt enables (0=disabled) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IER2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* TMCS, Timer Control/Status Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      CMF, Compare match flag (read only) 1=match</span>
<span class="cm">	 * 06      ECMI, CMF Interrupt Enable: 0=disabled</span>
<span class="cm">	 * 05      Reserved, must be 0</span>
<span class="cm">	 * 04      TME, Timer Enable</span>
<span class="cm">	 * 03..00  Reserved, must be 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">timer</span> <span class="o">+</span> <span class="n">TMCS</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_timer()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rxint</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
 	<span class="k">struct</span>	<span class="n">mgsl_icount</span> <span class="o">*</span><span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FLGD</span> <span class="o">+</span> <span class="n">IDLD</span> <span class="o">+</span> <span class="n">CDCD</span> <span class="o">+</span> <span class="n">BRKD</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie2_value</span> <span class="o">&amp;</span> <span class="n">OVRN</span><span class="p">;</span>

	<span class="cm">/* clear status bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status2</span><span class="p">)</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR2</span><span class="p">,</span> <span class="n">status2</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_rxint status=%02X %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">status2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BRKD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* process break detection if tty control</span>
<span class="cm">			 * is not set to ignore it</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">tty</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask1</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask1</span> <span class="o">&amp;</span> <span class="n">BRKD</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
							<span class="n">do_SAK</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FLGD</span><span class="o">|</span><span class="n">IDLD</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FLGD</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">exithunt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IDLD</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxidle</span><span class="o">++</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CDCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* simulate a common modem status change interrupt</span>
<span class="cm">		 * for our handler</span>
<span class="cm">		 */</span>
		<span class="n">get_signals</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
		<span class="n">isr_io_pin</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
			<span class="n">MISCSTATUS_DCD_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_DCD</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle async rx data interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rxrdy</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DataByte</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
 	<span class="k">struct</span>	<span class="n">mgsl_icount</span> <span class="o">*</span><span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_rxrdy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">while</span><span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">CST0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">over</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">DataByte</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">TRB</span><span class="p">);</span>

		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PE</span> <span class="o">+</span> <span class="n">FRME</span> <span class="o">+</span> <span class="n">OVRN</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rxerr=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

			<span class="cm">/* update error statistics */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PE</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FRME</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OVRN</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* discard char if tty control flags say so */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span> <span class="n">tty</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PE</span><span class="p">)</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FRME</span><span class="p">)</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OVRN</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Overrun is special, since it&#39;s</span>
<span class="cm">					 * reported immediately, and doesn&#39;t</span>
<span class="cm">					 * affect the current character</span>
<span class="cm">					 */</span>
					<span class="n">over</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>	<span class="cm">/* end of if (error) */</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">tty</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">DataByte</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="p">)</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rx=%d brk=%d parity=%d frame=%d overrun=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">,</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">tty</span> <span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txeom</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_txeom status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* disable Tx DMA IRQs */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span> <span class="cm">/* clear IRQs and disable DMA */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init DMA channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UDRN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXRESET</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXBUFCLR</span><span class="p">);</span>

	<span class="cm">/* disable and clear tx interrupts */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXRDYE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IDLE</span> <span class="o">+</span> <span class="n">UDRN</span><span class="p">);</span>
	<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">));</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">UDRN</span> <span class="o">+</span> <span class="n">IDLE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UDRN</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IDLE</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
			<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * handle tx status interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txint</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDRN</span> <span class="o">+</span> <span class="n">IDLE</span> <span class="o">+</span> <span class="n">CCTS</span><span class="p">);</span>

	<span class="cm">/* clear status bits */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_txint status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UDRN</span> <span class="o">+</span> <span class="n">IDLE</span><span class="p">))</span>
		<span class="n">isr_txeom</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* simulate a common modem status change interrupt</span>
<span class="cm">		 * for our handler</span>
<span class="cm">		 */</span>
		<span class="n">get_signals</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
		<span class="n">isr_io_pin</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
			<span class="n">MISCSTATUS_CTS_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_CTS</span><span class="p">));</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle async tx data interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txrdy</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_txrdy() tx_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable TXRDY IRQ, enable IDLE IRQ */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXRDYE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">|=</span> <span class="n">IDLE</span><span class="p">;</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="p">)</span>
		<span class="n">tx_load_fifo</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXRDYE</span><span class="p">;</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rxdmaok</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BIT7 = EOT (end of transfer)</span>
<span class="cm">	 * BIT6 = EOM (end of message/frame)</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>

	<span class="cm">/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">status</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_rxdmaok(), status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_rxdmaerror</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BIT5 = BOF (buffer overflow)</span>
<span class="cm">	 * BIT4 = COF (counter overflow)</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="cm">/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">status</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_rxdmaerror(), status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txdmaok</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status_reg1</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* disable Tx DMA IRQs */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span> <span class="cm">/* clear IRQs and disable DMA */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init DMA channel */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_txdmaok(), status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status_reg1</span><span class="p">);</span>

	<span class="cm">/* program TXRDY as FIFO empty flag, enable TXRDY IRQ */</span>
	<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">|=</span> <span class="n">TXRDYE</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_txdmaerror</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BIT5 = BOF (buffer overflow)</span>
<span class="cm">	 * BIT4 = COF (counter overflow)</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="cm">/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">status</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s isr_txdmaerror(), status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* handle input serial signal changes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_io_pin</span><span class="p">(</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span> <span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span>	<span class="n">mgsl_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):isr_io_pin status=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MISCSTATUS_CTS_LATCHED</span> <span class="o">|</span> <span class="n">MISCSTATUS_DCD_LATCHED</span> <span class="o">|</span>
	              <span class="n">MISCSTATUS_DSR_LATCHED</span> <span class="o">|</span> <span class="n">MISCSTATUS_RI_LATCHED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="cm">/* update input line counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_RI_LATCHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span> <span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_up</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_down</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_DSR_LATCHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span> <span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_up</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_down</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_DCD_LATCHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDCD</span><span class="p">;</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_up</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_down</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
					<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_CTS_LATCHED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCTS</span><span class="p">;</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span> <span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_up</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_down</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_DCD_LATCHED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s CD now %s...&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;doing serial hangup...&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
					<span class="n">tty_hangup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MISCSTATUS_CTS_LATCHED</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx start...&quot;</span><span class="p">);</span>
			 			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx stop...&quot;</span><span class="p">);</span>
			 			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt service routine entry point.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> * 	irq		interrupt number that caused interrupt</span>
<span class="cm"> * 	dev_id		device ID supplied during interrupt registration</span>
<span class="cm"> * 	regs		interrupted processor context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">synclinkmp_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span> <span class="n">status0</span><span class="p">,</span> <span class="n">status1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dmastatus</span><span class="p">,</span> <span class="n">dmastatus0</span><span class="p">,</span> <span class="n">dmastatus1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">timerstatus0</span><span class="p">,</span> <span class="n">timerstatus1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(%d): synclinkmp_interrupt(%d)entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>

		<span class="cm">/* get status for SCA0 (ports 0-1) */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ISR0</span><span class="p">);</span>	<span class="cm">/* get ISR0 and ISR1 in one read */</span>
		<span class="n">status0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
		<span class="n">dmastatus0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">timerstatus0</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ISR2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(%d):%s status0=%02x, dmastatus0=%02x, timerstatus0=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
				<span class="n">status0</span><span class="p">,</span> <span class="n">dmastatus0</span><span class="p">,</span> <span class="n">timerstatus0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get status for SCA1 (ports 2-3) */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ISR0</span><span class="p">);</span>
			<span class="n">status1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">dmastatus1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">timerstatus1</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ISR2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s status1=%02x, dmastatus1=%02x, timerstatus1=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
					<span class="n">status1</span><span class="p">,</span><span class="n">dmastatus1</span><span class="p">,</span><span class="n">timerstatus1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dmastatus0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timerstatus0</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="n">status1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dmastatus1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timerstatus1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">status0</span><span class="p">;</span>
				<span class="n">dmastatus</span> <span class="o">=</span> <span class="n">dmastatus0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">status1</span><span class="p">;</span>
				<span class="n">dmastatus</span> <span class="o">=</span> <span class="n">dmastatus1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">shift</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span><span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_rxrdy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_txrdy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT2</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_rxint</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT3</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_txint</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dmastatus</span> <span class="o">&amp;</span> <span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_rxdmaerror</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmastatus</span> <span class="o">&amp;</span> <span class="n">BIT1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_rxdmaok</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmastatus</span> <span class="o">&amp;</span> <span class="n">BIT2</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_txdmaerror</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmastatus</span> <span class="o">&amp;</span> <span class="n">BIT3</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span>
				<span class="n">isr_txdmaok</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timerstatus0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT5</span> <span class="o">|</span> <span class="n">BIT4</span><span class="p">))</span>
			<span class="n">isr_timer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timerstatus0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT7</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">))</span>
			<span class="n">isr_timer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timerstatus1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT5</span> <span class="o">|</span> <span class="n">BIT4</span><span class="p">))</span>
			<span class="n">isr_timer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timerstatus1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT7</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">))</span>
			<span class="n">isr_timer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Request bottom half processing if there&#39;s something</span>
<span class="cm">		 * for it to do and the bh is not already running.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: startup adapter diags require interrupts.</span>
<span class="cm">		 * do not request bottom half processing if the</span>
<span class="cm">		 * device is not open in a normal mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">port</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s queueing bh task.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(%d):synclinkmp_interrupt(%d)exit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize and start device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_releaseup()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s(%d):%s can&#39;t allocate transmit buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>

	<span class="cm">/* program hardware for current parameters */</span>
	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">change_params</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by close() and hangup() to shutdown hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s synclinkmp_shutdown()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="cm">/* clear status wait queue because status changes */</span>
	<span class="cm">/* can&#39;t happen after shutting down the hardware */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_timer</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">);</span>
		<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">program_hw</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlc_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">async_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CDCD</span><span class="o">|</span><span class="n">CCTS</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>

	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reconfigure adapter based on new parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits_per_char</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s change_params()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* if B0 rate (hangup) specified then negate DTR and RTS */</span>
	<span class="cm">/* otherwise assert DTR and RTS */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>

	<span class="cm">/* byte size and parity */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">CS5</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS6</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS7</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS8</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="cm">/* Never happens, but GCC is too dumb to figure it out */</span>
	      <span class="nl">default:</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CMSPAR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_SPACE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* calculate number of jiffies to transmit a full</span>
<span class="cm">	 * FIFO (32 bytes) at specified data rate</span>
<span class="cm">	 */</span>
	<span class="n">bits_per_char</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">+</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if port data rate is set to 460800 or less then</span>
<span class="cm">	 * allow tty settings to override, otherwise keep the</span>
<span class="cm">	 * current data rate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">&lt;=</span> <span class="mi">460800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="n">HZ</span><span class="o">*</span><span class="n">bits_per_char</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>		<span class="cm">/* Add .02 seconds of slop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>

	<span class="cm">/* process tty input control flags */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask2</span> <span class="o">=</span> <span class="n">OVRN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask2</span> <span class="o">|=</span> <span class="n">PE</span> <span class="o">|</span> <span class="n">FRME</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
 		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask1</span> <span class="o">|=</span> <span class="n">BRKD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask2</span> <span class="o">|=</span> <span class="n">PE</span> <span class="o">|</span> <span class="n">FRME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask1</span> <span class="o">|=</span> <span class="n">BRKD</span><span class="p">;</span>
		<span class="cm">/* If ignoring parity and break indicators, ignore</span>
<span class="cm">		 * overruns too.  (For real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask2</span> <span class="o">|=</span> <span class="n">OVRN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s get_params()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_icount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">user_icount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgsl_icount</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s get_params()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">user_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s get_params() user buffer copy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_params</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_params</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">MGSL_PARAMS</span> <span class="n">tmp_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s set_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>
	<span class="n">COPY_FROM_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="n">new_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s set_params() user buffer copy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

 	<span class="n">change_params</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_txidle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s get_txidle()=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">);</span>

	<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">idle_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s get_txidle() user buffer copy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_txidle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s set_txidle(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">idle_mode</span> <span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">idle_mode</span><span class="p">;</span>
	<span class="n">tx_set_idle</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_enable</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_enable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">enable</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="p">)</span>
			<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* abort send HDLC frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_abort</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_abort()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UDRN</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">|=</span> <span class="n">IDLE</span><span class="p">;</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>	<span class="cm">/* disable tx status interrupts */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">IDLE</span> <span class="o">+</span> <span class="n">UDRN</span><span class="p">));</span>	<span class="cm">/* clear pending */</span>

		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* disable DMA channel */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init DMA channel */</span>

   		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXABORT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_enable</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rx_enable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">enable</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="p">)</span>
			<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="p">)</span>
			<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* wait for specified event to occur</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_mgsl_event</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask_ptr</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">_input_signal_events</span> <span class="n">oldsigs</span><span class="p">,</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">COPY_FROM_USER</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s wait_mgsl_event(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* return immediately if state matches requested events */</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
		<span class="p">(</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="n">MgslEvent_DsrInactive</span><span class="p">)</span> <span class="o">+</span>
 		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="n">MgslEvent_DcdInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="n">MgslEvent_CtsInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">MgslEvent_RiActive</span> <span class="o">:</span><span class="n">MgslEvent_RiInactive</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>

	<span class="cm">/* enable hunt and idle irqs if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MgslEvent_ExitHuntMode</span><span class="o">+</span><span class="n">MgslEvent_IdleReceived</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldval</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newval</span> <span class="o">=</span> <span class="n">oldval</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MgslEvent_ExitHuntMode</span> <span class="o">?</span> <span class="n">FLGD</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MgslEvent_IdleReceived</span> <span class="o">?</span> <span class="n">IDLD</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">oldval</span> <span class="o">!=</span> <span class="n">newval</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">=</span> <span class="n">newval</span><span class="p">;</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get current irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">newsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
			<span class="p">(</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">?</span> <span class="n">MgslEvent_DsrInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">?</span> <span class="n">MgslEvent_DcdInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">?</span> <span class="n">MgslEvent_CtsInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">?</span> <span class="n">MgslEvent_RiActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>    <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">?</span> <span class="n">MgslEvent_RiInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>  <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">?</span> <span class="n">MgslEvent_ExitHuntMode</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span>     <span class="o">?</span> <span class="n">MgslEvent_IdleReceived</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MgslEvent_ExitHuntMode</span> <span class="o">+</span> <span class="n">MgslEvent_IdleReceived</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* disable enable exit hunt mode/idle rcvd IRQs */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FLGD</span><span class="o">|</span><span class="n">IDLD</span><span class="p">);</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">PUT_USER</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">modem_input_wait</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get new irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for change in caller specified modem input */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span>  <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the state of the serial control and status signals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">TIOCM_RNG</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tiocmget() value=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">result</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set modem control signals (DTR/RTS)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tiocmset(%x,%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_DTR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SLMP_INFO</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SLMP_INFO</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>
 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Block the current process until the specified port is ready to open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">block_til_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			   <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">do_clocal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">extra_count</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">cd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s block_til_ready()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">)){</span>
		<span class="cm">/* nonblock mode is set or port is not enabled */</span>
		<span class="cm">/* just verify that callout device is not active */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">do_clocal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Wait for carrier detect and the line to become</span>
<span class="cm">	 * free (i.e., not in use by the callout).  While we are in</span>
<span class="cm">	 * this loop, port-&gt;count is dropped by one, so that</span>
<span class="cm">	 * close() knows when to free things.  We restore it upon</span>
<span class="cm">	 * exit, either normal or abnormal.</span>
<span class="cm">	 */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s block_til_ready() before block, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">extra_count</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
			<span class="n">tty_port_raise_dtr_rts</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)){</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
					<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cd</span> <span class="o">=</span> <span class="n">tty_port_carrier_raised</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">do_clocal</span> <span class="o">||</span> <span class="n">cd</span><span class="p">))</span>
 			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s block_til_ready() count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="p">);</span>

		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">tty_lock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extra_count</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s block_til_ready() after, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_dma_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">BuffersPerFrame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">BufferCount</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Force allocation to start at 64K boundary for each port.
This is necessary because <em>all</em> buffer descriptors for a port
<em>must</em> be in the same 64K block. All descriptors on a port
share a common 'base' address (upper 8 bits of 24 bits) programmed
into the CBP register.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCA_MEM_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>

	<span class="cm">/* Calculate the number of DMA buffers necessary to hold the */</span>
	<span class="cm">/* largest allowable frame size. Note: If the max frame size is */</span>
	<span class="cm">/* not an even multiple of the DMA buffer size then we need to */</span>
	<span class="cm">/* round the buffer count per frame up one. */</span>

	<span class="n">BuffersPerFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="o">/</span><span class="n">SCABUFSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">%</span> <span class="n">SCABUFSIZE</span> <span class="p">)</span>
		<span class="n">BuffersPerFrame</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* calculate total number of data buffers (SCABUFSIZE) possible</span>
<span class="cm">	 * in one ports memory (SCA_MEM_SIZE/4) after allocating memory</span>
<span class="cm">	 * for the descriptor list (BUFFERLISTSIZE).</span>
<span class="cm">	 */</span>
	<span class="n">BufferCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCA_MEM_SIZE</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">BUFFERLISTSIZE</span><span class="p">)</span><span class="o">/</span><span class="n">SCABUFSIZE</span><span class="p">;</span>

	<span class="cm">/* limit number of buffers to maximum amount of descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BufferCount</span> <span class="o">&gt;</span> <span class="n">BUFFERLISTSIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">))</span>
		<span class="n">BufferCount</span> <span class="o">=</span> <span class="n">BUFFERLISTSIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">);</span>

	<span class="cm">/* use enough buffers to transmit one max size frame */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">=</span> <span class="n">BuffersPerFrame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* never use more than half the available buffers for transmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">BufferCount</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">=</span> <span class="n">BufferCount</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">&gt;</span> <span class="n">SCAMAXDESC</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">=</span> <span class="n">SCAMAXDESC</span><span class="p">;</span>

	<span class="cm">/* use remaining buffers for receive */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">=</span> <span class="n">BufferCount</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">&gt;</span> <span class="n">SCAMAXDESC</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">=</span> <span class="n">SCAMAXDESC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s Allocating %d TX and %d RX DMA buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">alloc_buf_list</span><span class="p">(</span> <span class="n">info</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">alloc_frame_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
		  			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">,</span>
		  			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">alloc_frame_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list_ex</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">alloc_tmp_rx_buf</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s Can&#39;t allocate DMA buffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_reset_buffers</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocate DMA buffers for the transmit and receive descriptor lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_buf_list</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* build list in adapter shared memory */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span> <span class="o">+=</span> <span class="n">BUFFERLISTSIZE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFFERLISTSIZE</span><span class="p">);</span>

	<span class="cm">/* Save virtual address pointers to the receive and */</span>
	<span class="cm">/* transmit buffer lists. (Receive 1st). These pointers will */</span>
	<span class="cm">/* be used by the processor to access the lists. */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCADESC</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCADESC</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">;</span>

	<span class="cm">/* Build links for circular buffer entry lists (tx and rx)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: links are physical addresses read by the SCA device</span>
<span class="cm">	 * to determine the next buffer entry to use.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calculate and store physical address of this buffer entry */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys_entry</span> <span class="o">=</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCABUFSIZE</span><span class="p">));</span>

		<span class="cm">/* calculate and store physical address of */</span>
		<span class="cm">/* next entry in cirular list of entries */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">SCABUFSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calculate and store physical address of this buffer entry */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys_entry</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">));</span>

		<span class="cm">/* calculate and store physical address of */</span>
		<span class="cm">/* next entry in cirular list of entries */</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">+</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCADESC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocate the frame DMA buffers used by the specified buffer list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_frame_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">SCADESC</span> <span class="o">*</span><span class="n">buf_list</span><span class="p">,</span><span class="n">SCADESC_EX</span> <span class="o">*</span><span class="n">buf_list_ex</span><span class="p">,</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_list_ex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span><span class="p">;</span>
		<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_mem_alloc</span> <span class="o">+=</span> <span class="n">SCABUFSIZE</span><span class="p">;</span>

		<span class="n">buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_dma_bufs</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allocate buffer large enough to hold max_frame_size.</span>
<span class="cm"> * This buffer is used to pass an assembled frame to the line discipline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_tmp_rx_buf</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_tmp_rx_buf</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claim_resources</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">,</span><span class="n">SCA_MEM_SIZE</span><span class="p">,</span><span class="s">&quot;synclinkmp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s mem addr conflict, Addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressConflict</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">shared_mem_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_offset</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="s">&quot;synclinkmp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s lcr mem addr conflict, Addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressConflict</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_mem_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_offset</span><span class="p">,</span><span class="n">SCA_BASE_SIZE</span><span class="p">,</span><span class="s">&quot;synclinkmp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s sca mem addr conflict, Addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressConflict</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_offset</span><span class="p">,</span><span class="n">SCA_REG_SIZE</span><span class="p">,</span><span class="s">&quot;synclinkmp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s stat/ctrl mem addr conflict, Addr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressConflict</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_statctrl_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">,</span>
								<span class="n">SCA_MEM_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s Can&#39;t map shared memory, MemAddr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span> <span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_CantAssignPciResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s Can&#39;t map LCR memory, MemAddr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_CantAssignPciResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_offset</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s Can&#39;t map SCA memory, MemAddr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_CantAssignPciResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_offset</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span><span class="p">,</span>
								<span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s Can&#39;t map SCA Status/Control memory, MemAddr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_CantAssignPciResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">memory_test</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Shared Memory Test failed for device %s MemAddr=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span> <span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_MemoryError</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="n">release_resources</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_resources</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s release_resources() entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_requested</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shared_mem_requested</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">,</span><span class="n">SCA_MEM_SIZE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">shared_mem_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_mem_requested</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_offset</span><span class="p">,</span><span class="mi">128</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_mem_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base_requested</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_offset</span><span class="p">,</span><span class="n">SCA_BASE_SIZE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_statctrl_requested</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_offset</span><span class="p">,</span><span class="n">SCA_REG_SIZE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_statctrl_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">){</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_offset</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_offset</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span><span class="p">){</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_offset</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s release_resources() exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Add the specified device instance data structure to the</span>
<span class="cm"> * global linked list of devices and increment the device count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_device</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">synclinkmp_device_count</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="s">&quot;ttySLM%dp%d&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_num</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">MAX_DEVICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">])</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">synclinkmp_device_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">synclinkmp_device_list</span> <span class="p">)</span>
		<span class="n">synclinkmp_device_list</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">synclinkmp_device_list</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="p">)</span>
			<span class="n">current_dev</span> <span class="o">=</span> <span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&lt;</span> <span class="mi">4096</span> <span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&gt;</span> <span class="mi">65535</span> <span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;SyncLink MultiPort %s: &quot;</span>
		<span class="s">&quot;Mem=(%08x %08X %08x %08X) IRQ=%d MaxFrameSize=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="n">hdlcdev_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">dtr_rts</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Allocate and initialize a device instance structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:	pointer to SLMP_INFO if success, otherwise NULL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="nf">alloc_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SLMP_INFO</span><span class="p">),</span>
		 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d) Error can&#39;t allocate device instance data for adapter %d, port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="n">port_num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">MGSL_MAGIC</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">bh_handler</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span><span class="o">&amp;</span><span class="n">default_params</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">HDLC_TXIDLE_FLAGS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_num</span> <span class="o">=</span> <span class="n">adapter_num</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">port_num</span><span class="p">;</span>

		<span class="cm">/* Copy configuration info to device instance data */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_memory_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Because veremap only works on page boundaries we must map</span>
<span class="cm">		 * a larger area than is actually implemented for the LCR</span>
<span class="cm">		 * memory range. We map a full page starting at the page boundary.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_offset</span>    <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_lcr_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_offset</span>    <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_offset</span>    <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_statctrl_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">MGSL_BUS_TYPE_PCI</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">tx_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_timer</span><span class="p">,</span> <span class="n">status_timeout</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Store the PCI9050 misc control register value because a flaw</span>
<span class="cm">		 * in the PCI9050 prevents LCR registers from being read if</span>
<span class="cm">		 * BIOS assigns an LCR base address with bit 7 set.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Only the misc control register is accessed for which only</span>
<span class="cm">		 * write access is needed, so set an initial value and change</span>
<span class="cm">		 * bits to the device instance data as we write the value</span>
<span class="cm">		 * to the actual misc control register.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">misc_ctrl_value</span> <span class="o">=</span> <span class="mh">0x087e4546</span><span class="p">;</span>

		<span class="cm">/* initial port state is unknown - if startup errors</span>
<span class="cm">		 * occur, init_error will be set to indicate the</span>
<span class="cm">		 * problem. Once the port is fully initialized,</span>
<span class="cm">		 * this value will be set to 0 to indicate the</span>
<span class="cm">		 * port is available.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">device_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">port_array</span><span class="p">[</span><span class="n">SCA_MAX_PORTS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="cm">/* allocate device instances for up to SCA_MAX_PORTS devices */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">SCA_MAX_PORTS</span><span class="p">;</span> <span class="o">++</span><span class="n">port</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_dev</span><span class="p">(</span><span class="n">adapter_num</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span> <span class="o">--</span><span class="n">port</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">port</span> <span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* give copy of port_array to all ports and add to device list  */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">SCA_MAX_PORTS</span><span class="p">;</span> <span class="o">++</span><span class="n">port</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">,</span><span class="n">port_array</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">port_array</span><span class="p">));</span>
		<span class="n">add_device</span><span class="p">(</span> <span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate and claim adapter resources */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">claim_resources</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* copy resource information from first port to others */</span>
		<span class="k">for</span> <span class="p">(</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">SCA_MAX_PORTS</span><span class="p">;</span> <span class="o">++</span><span class="n">port</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span>  <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span>     <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory_base</span>   <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sca_base</span>      <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">statctrl_base</span> <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="p">;</span>
			<span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lcr_base</span>      <span class="o">=</span> <span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lcr_base</span><span class="p">;</span>
			<span class="n">alloc_dma_bufs</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span>
					<span class="n">synclinkmp_interrupt</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
					<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s Can&#39;t request interrupt, IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
				<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">adapter_test</span><span class="p">(</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">set_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">tx_hold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">tx_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">synclinkmp_proc_fops</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">synclinkmp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unloading %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d) failed to unregister tty driver err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset devices */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">synclinkmp_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* release devices */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">synclinkmp_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="n">hdlcdev_exit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">free_dma_bufs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">free_tmp_rx_buf</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="p">)</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">LPR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* set low power mode */</span>
			<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synclinkmp_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Driver initialization entry point.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">synclinkmp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_on_load</span><span class="p">)</span> <span class="p">{</span>
	 	<span class="n">synclinkmp_get_text_ptr</span><span class="p">();</span>
  		<span class="n">BREAKPOINT</span><span class="p">();</span>
	<span class="p">}</span>

 	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synclinkmp_pci_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:failed to register PCI driver, error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>

	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;synclinkmp&quot;</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttySLM&quot;</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ttymajor</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
		<span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):Couldn&#39;t register serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
		<span class="n">serial_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

 	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %s, tty major#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">driver_name</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">,</span>
		<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">synclinkmp_cleanup</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">synclinkmp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">synclinkmp_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">synclinkmp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">synclinkmp_exit</span><span class="p">);</span>

<span class="cm">/* Set the port for internal loopback mode.</span>
<span class="cm"> * The TxCLK and RxCLK signals are generated from the BRG and</span>
<span class="cm"> * the TxD is looped back to the RxD internally.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_loopback</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MD2 (Mode Register 2)</span>
<span class="cm">		 * 01..00  CNCT&lt;1..0&gt; Channel Connection 11=Local Loopback</span>
<span class="cm">		 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">)));</span>

		<span class="cm">/* degate external TxC clock source */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">write_control_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* RXS/TXS (Rx/Tx clock source)</span>
<span class="cm">		 * 07      Reserved, must be 0</span>
<span class="cm">		 * 06..04  Clock Source, 100=BRG</span>
<span class="cm">		 * 03..00  Clock Divisor, 0000=1</span>
<span class="cm">		 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MD2 (Mode Register 2)</span>
<span class="cm">	 	 * 01..00  CNCT&lt;1..0&gt; Channel connection, 0=normal</span>
<span class="cm">		 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">)));</span>

		<span class="cm">/* RXS/TXS (Rx/Tx clock source)</span>
<span class="cm">		 * 07      Reserved, must be 0</span>
<span class="cm">		 * 06..04  Clock Source, 000=RxC/TxC Pin</span>
<span class="cm">		 * 03..00  Clock Divisor, 0000=1</span>
<span class="cm">		 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set LinkSpeed if available, otherwise default to 2Mbps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">3686400</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the baud rate register to the desired speed</span>
<span class="cm"> *</span>
<span class="cm"> *	data_rate	data rate of clock in bits per second</span>
<span class="cm"> *			A data rate of 0 disables the AUX clock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rate</span><span class="p">(</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_rate</span> <span class="p">)</span>
<span class="p">{</span>
       	<span class="n">u32</span> <span class="n">TMCValue</span><span class="p">;</span>
       	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BRValue</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Divisor</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* fBRG = fCLK/(TMC * 2^BR)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Divisor</span> <span class="o">=</span> <span class="mi">14745600</span><span class="o">/</span><span class="n">data_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Divisor</span><span class="p">)</span>
			<span class="n">Divisor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">TMCValue</span> <span class="o">=</span> <span class="n">Divisor</span><span class="p">;</span>

		<span class="n">BRValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TMCValue</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">TMCValue</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BRValue of 0 provides 50/50 duty cycle *only* when</span>
<span class="cm">			 * TMCValue is 1 or 2. BRValue of 1 to 9 always provides</span>
<span class="cm">			 * 50/50 duty cycle.</span>
<span class="cm">			 */</span>
			<span class="n">BRValue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">TMCValue</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* while TMCValue is too big for TMC register, divide</span>
<span class="cm">		 * by 2 and increment BR exponent.</span>
<span class="cm">		 */</span>
		<span class="k">for</span><span class="p">(;</span> <span class="n">TMCValue</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">&amp;&amp;</span> <span class="n">BRValue</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">BRValue</span><span class="o">++</span><span class="p">)</span>
			<span class="n">TMCValue</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BRValue</span><span class="p">));</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BRValue</span><span class="p">));</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TMC</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TMCValue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Disable receiver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_stop</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rx_stop()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">RXRESET</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXRDYE</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>	<span class="cm">/* disable Rx data interrupts */</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable Rx DMA */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init Rx DMA */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable Rx DMA interrupts */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enable the receiver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_start</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rx_start()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">RXRESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HDLC, disabe IRQ on rxdata */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXRDYE</span><span class="p">;</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>

		<span class="cm">/* Reset all Rx DMA buffers and program rx dma */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* disable Rx DMA */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init Rx DMA */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>throttle to 4 shared memory writes at a time to prevent
hogging local bus (keep latency time for DMA requests low).</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">read_status_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">current_rx_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* set current/1st descriptor address */</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">CDA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_entry</span><span class="p">);</span>

		<span class="cm">/* set new last rx descriptor address */</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">EDA</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">phys_entry</span><span class="p">);</span>

		<span class="cm">/* set buffer length (shared by all rx dma data buffers) */</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">BFL</span><span class="p">,</span> <span class="n">SCABUFSIZE</span><span class="p">);</span>

		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* enable Rx DMA interrupts (EOM/BOF) */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">);</span>	<span class="cm">/* clear Rx DMA IRQs, enable Rx DMA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* async, enable IRQ on rxdata */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">|=</span> <span class="n">RXRDYE</span><span class="p">;</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">RXENABLE</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable the transmitter and send a transmit frame if</span>
<span class="cm"> * one is loaded in the DMA buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_start</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_start() tx_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXRESET</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXENABLE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* If auto RTS enabled and RTS is inactive, then assert */</span>
		<span class="cm">/* RTS and set a flag indicating that the driver should */</span>
		<span class="cm">/* negate RTS when the transmission completes. */</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_RTS</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">get_signals</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
					<span class="n">set_signals</span><span class="p">(</span> <span class="n">info</span> <span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC0</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(((</span><span class="n">tx_negate_fifo_level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx_active_fifo_level</span><span class="p">));</span>

			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 		<span class="cm">/* disable DMA channel */</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init DMA channel */</span>
	
			<span class="cm">/* set TX CDA (current descriptor address) */</span>
			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">CDA</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys_entry</span><span class="p">);</span>
	
			<span class="cm">/* set TX EDA (last descriptor address) */</span>
			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">EDA</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list_ex</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_buf</span><span class="p">].</span><span class="n">phys_entry</span><span class="p">);</span>
	
			<span class="cm">/* enable underrun IRQ */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IDLE</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">|=</span> <span class="n">UDRN</span><span class="p">;</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">IDLE</span> <span class="o">+</span> <span class="n">UDRN</span><span class="p">));</span>
	
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>		<span class="cm">/* enable Tx DMA interrupts (EOM) */</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">);</span>		<span class="cm">/* clear Tx DMA IRQs, enable Tx DMA */</span>
	
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_load_fifo</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="cm">/* async, enable IRQ on txdata */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">|=</span> <span class="n">TXRDYE</span><span class="p">;</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* stop the transmitter and DMA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_stop</span><span class="p">(</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tx_stop()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* disable DMA channel */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DCMD</span><span class="p">,</span> <span class="n">SWABORT</span><span class="p">);</span>	<span class="cm">/* reset/init DMA channel */</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">TXRESET</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UDRN</span> <span class="o">+</span> <span class="n">IDLE</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>	<span class="cm">/* disable tx status interrupts */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">IDLE</span> <span class="o">+</span> <span class="n">UDRN</span><span class="p">));</span>	<span class="cm">/* clear pending */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXRDYE</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>	<span class="cm">/* disable tx data interrupts */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fill the transmit FIFO until the FIFO is full or</span>
<span class="cm"> * there is no more data to load.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_load_fifo</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">TwoBytes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* do nothing is now tx data available and no XON/XOFF pending */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* load the Transmit FIFO until FIFOs full or all data sent */</span>

	<span class="k">while</span><span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">SR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* there is more space in the transmit FIFO and */</span>
		<span class="cm">/* there is more data in transmit buffer */</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="p">)</span> <span class="p">{</span>
 			<span class="cm">/* write 16-bits */</span>
			<span class="n">TwoBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
			<span class="n">TwoBytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRB</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">TwoBytes</span><span class="p">));</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* only 1 byte left to transmit or 1 FIFO slot left */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* transmit pending high priority char */</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRB</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRB</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="o">++</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Reset a port to a known state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_port</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sca_base</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">);</span>
		<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* disable all port interrupts */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie2_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE2</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie2_value</span><span class="p">);</span>

		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">CHRESET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Reset all the ports to a known state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_adapter</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCA_MAX_PORTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Program port for asynchronous communications.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_mode</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>

  	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegValue</span><span class="p">;</span>

	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* MD0, Mode Register 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  PRCTL&lt;2..0&gt;, Protocol Mode, 000=async</span>
<span class="cm">	 * 04      AUTO, Auto-enable (RTS/CTS/DCD)</span>
<span class="cm">	 * 03      Reserved, must be 0</span>
<span class="cm">	 * 02      CRCCC, CRC Calculation, 0=disabled</span>
<span class="cm">	 * 01..00  STOP&lt;1..0&gt; Stop bits (00=1,10=2)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT1</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD0</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* MD1, Mode Register 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  BRATE&lt;1..0&gt;, bit rate, 00=1/1 01=1/16 10=1/32 11=1/64</span>
<span class="cm">	 * 05..04  TXCHR&lt;1..0&gt;, tx char size, 00=8 bits,01=7,10=6,11=5</span>
<span class="cm">	 * 03..02  RXCHR&lt;1..0&gt;, rx char size</span>
<span class="cm">	 * 01..00  PMPM&lt;1..0&gt;, Parity mode, 00=none 10=even 11=odd</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0100 0000</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT3</span> <span class="o">+</span> <span class="n">BIT2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">==</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">)</span>
			<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD1</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* MD2, Mode Register 2</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..02  Reserved, must be 0</span>
<span class="cm">	 * 01..00  CNCT&lt;1..0&gt; Channel connection, 00=normal 11=local loopback</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* RXS, Receive clock source</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, must be 0</span>
<span class="cm">	 * 06..04  RXCS&lt;2..0&gt;, clock source, 000=RxC Pin, 100=BRG, 110=DPLL</span>
<span class="cm">	 * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span><span class="o">=</span><span class="n">BIT6</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* TXS, Transmit clock source</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, must be 0</span>
<span class="cm">	 * 06..04  RXCS&lt;2..0&gt;, clock source, 000=TxC Pin, 100=BRG, 110=Receive Clock</span>
<span class="cm">	 * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span><span class="o">=</span><span class="n">BIT6</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* Control Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 6,4,2,0  CLKSEL&lt;3..0&gt;, 0 = TcCLK in, 1 = Auxclk out</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">write_control_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* RRC Receive Ready Control 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  RRC&lt;4..0&gt; Rx FIFO trigger active 0x00 = 1 byte</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RRC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* TRC0 Transmit Ready Control 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger active 0x10 = 16 bytes</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* TRC1 Transmit Ready Control 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger inactive 0x1e = 31 bytes (full-1)</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC1</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">);</span>

	<span class="cm">/* CTL, MSCI control register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  Reserved, set to 0</span>
<span class="cm">	 * 05      UDRNC, underrun control, 0=abort 1=CRC+flag (HDLC/BSC)</span>
<span class="cm">	 * 04      IDLC, idle control, 0=mark 1=idle register</span>
<span class="cm">	 * 03      BRK, break, 0=off 1 =on (async)</span>
<span class="cm">	 * 02      SYNCLD, sync char load enable (BSC) 1=enabled</span>
<span class="cm">	 * 01      GOP, go active on poll (LOOP mode) 1=enabled</span>
<span class="cm">	 * 00      RTS, RTS output control, 0=active 1=inactive</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0001</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">))</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* enable status interrupts */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">|=</span> <span class="n">TXINTE</span> <span class="o">+</span> <span class="n">RXINTE</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>

	<span class="cm">/* enable break detect interrupt */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span> <span class="o">=</span> <span class="n">BRKD</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie1_value</span><span class="p">);</span>

	<span class="cm">/* enable rx overrun interrupt */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie2_value</span> <span class="o">=</span> <span class="n">OVRN</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE2</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie2_value</span><span class="p">);</span>

	<span class="n">set_rate</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Program the SCA for HDLC communications.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlc_mode</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegValue</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DpllDivisor</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Can't use DPLL because SCA outputs recovered clock on RxC when
DPLL mode selected. This causes output contention with RxC receiver.
Use of DPLL would require external hardware to disable RxC receiver
when DPLL mode selected.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">+</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">);</span>

	<span class="cm">/* disable DMA interrupts */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="kt">DIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* MD0, Mode Register 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  PRCTL&lt;2..0&gt;, Protocol Mode, 100=HDLC</span>
<span class="cm">	 * 04      AUTO, Auto-enable (RTS/CTS/DCD)</span>
<span class="cm">	 * 03      Reserved, must be 0</span>
<span class="cm">	 * 02      CRCCC, CRC Calculation, 1=enabled</span>
<span class="cm">	 * 01      CRC1, CRC selection, 0=CRC-16,1=CRC-CCITT-16</span>
<span class="cm">	 * 00      CRC0, CRC initial value, 1 = all 1s</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1000 0001</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_DCD</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">==</span> <span class="n">HDLC_CRC_16_CCITT</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT1</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD0</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* MD1, Mode Register 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  ADDRS&lt;1..0&gt;, Address detect, 00=no addr check</span>
<span class="cm">	 * 05..04  TXCHR&lt;1..0&gt;, tx char size, 00=8 bits</span>
<span class="cm">	 * 03..02  RXCHR&lt;1..0&gt;, rx char size, 00=8 bits</span>
<span class="cm">	 * 01..00  PMPM&lt;1..0&gt;, Parity mode, 00=no parity</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD1</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* MD2, Mode Register 2</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      NRZFM, 0=NRZ, 1=FM</span>
<span class="cm">	 * 06..05  CODE&lt;1..0&gt; Encoding, 00=NRZ</span>
<span class="cm">	 * 04..03  DRATE&lt;1..0&gt; DPLL Divisor, 00=8</span>
<span class="cm">	 * 02      Reserved, must be 0</span>
<span class="cm">	 * 01..00  CNCT&lt;1..0&gt; Channel connection, 0=normal</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI</span>:	  <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span>:  <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* aka FM1 */</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span>: <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* aka FM0 */</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span>: <span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> 	<span class="cm">/* aka Manchester */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	case HDLC_ENCODING_NRZB:	       				/* not supported */</span>
<span class="c">	case HDLC_ENCODING_NRZI_MARK:          				/* not supported */</span>
<span class="c">	case HDLC_ENCODING_DIFF_BIPHASE_LEVEL: 				/* not supported */</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_DPLL_DIV16</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DpllDivisor</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_DPLL_DIV8</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DpllDivisor</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DpllDivisor</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">MD2</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>


	<span class="cm">/* RXS, Receive clock source</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, must be 0</span>
<span class="cm">	 * 06..04  RXCS&lt;2..0&gt;, clock source, 000=RxC Pin, 100=BRG, 110=DPLL</span>
<span class="cm">	 * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_BRG</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXS</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* TXS, Transmit clock source</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, must be 0</span>
<span class="cm">	 * 06..04  RXCS&lt;2..0&gt;, clock source, 000=TxC Pin, 100=BRG, 110=Receive Clock</span>
<span class="cm">	 * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_DPLL</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT6</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXS</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">*</span> <span class="n">DpllDivisor</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>

	<span class="cm">/* GPDATA (General Purpose I/O Data Register)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 6,4,2,0  CLKSEL&lt;3..0&gt;, 0 = TcCLK in, 1 = Auxclk out</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">write_control_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* RRC Receive Ready Control 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  RRC&lt;4..0&gt; Rx FIFO trigger active</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RRC</span><span class="p">,</span> <span class="n">rx_active_fifo_level</span><span class="p">);</span>

	<span class="cm">/* TRC0 Transmit Ready Control 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger active</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC0</span><span class="p">,</span> <span class="n">tx_active_fifo_level</span><span class="p">);</span>

	<span class="cm">/* TRC1 Transmit Ready Control 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger inactive 0x1f = 32 bytes (full)</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TRC1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">tx_negate_fifo_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* DMR, DMA Mode Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, must be 0</span>
<span class="cm">	 * 04      TMOD, Transfer Mode: 1=chained-block</span>
<span class="cm">	 * 03      Reserved, must be 0</span>
<span class="cm">	 * 02      NF, Number of Frames: 1=multi-frame</span>
<span class="cm">	 * 01      CNTE, Frame End IRQ Counter enable: 0=disabled</span>
<span class="cm">	 * 00      Reserved, must be 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0100</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">DMR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">DMR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>

	<span class="cm">/* Set chain pointer base (upper 8 bits of 24 bit addr) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">CPB</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* Set chain pointer base (upper 8 bits of 24 bit addr) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TXDMA</span> <span class="o">+</span> <span class="n">CPB</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer_list_phys</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* enable status interrupts. other code enables/disables</span>
<span class="cm">	 * the individual sources for these two interrupt classes.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span> <span class="o">|=</span> <span class="n">TXINTE</span> <span class="o">+</span> <span class="n">RXINTE</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IE0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ie0_value</span><span class="p">);</span>

	<span class="cm">/* CTL, MSCI control register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  Reserved, set to 0</span>
<span class="cm">	 * 05      UDRNC, underrun control, 0=abort 1=CRC+flag (HDLC/BSC)</span>
<span class="cm">	 * 04      IDLC, idle control, 0=mark 1=idle register</span>
<span class="cm">	 * 03      BRK, break, 0=off 1 =on (async)</span>
<span class="cm">	 * 02      SYNCLD, sync char load enable (BSC) 1=enabled</span>
<span class="cm">	 * 01      GOP, go active on poll (LOOP mode) 1=enabled</span>
<span class="cm">	 * 00      RTS, RTS output control, 0=active 1=inactive</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0001</span>
<span class="cm">	 */</span>
	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">))</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>

	<span class="cm">/* preamble not supported ! */</span>

	<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">enable_loopback</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the transmit HDLC idle mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_set_idle</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Map API idle mode to SCA register bits */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_FLAGS</span>:			<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_ALT_ZEROS_ONES</span>:	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_ZEROS</span>:			<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_ONES</span>:			<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_ALT_MARK_SPACE</span>:	<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_SPACE</span>:			<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_TXIDLE_MARK</span>:			<span class="n">RegValue</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IDL</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Query the adapter for the state of the V24 status (input) signals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_signals</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SR3</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">gpstatus</span> <span class="o">=</span> <span class="n">read_status_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">testbit</span><span class="p">;</span>

	<span class="cm">/* clear all serial signals except DTR and RTS */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>

	<span class="cm">/* set serial signal bits to reflect MISR */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_CTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DCD</span><span class="p">;</span>

	<span class="n">testbit</span> <span class="o">=</span> <span class="n">BIT1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// Port 0..3 RI is GPDATA&lt;1,3,5,7&gt;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpstatus</span> <span class="o">&amp;</span> <span class="n">testbit</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RI</span><span class="p">;</span>

	<span class="n">testbit</span> <span class="o">=</span> <span class="n">BIT0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// Port 0..3 DSR is GPDATA&lt;0,2,4,6&gt;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpstatus</span> <span class="o">&amp;</span> <span class="n">testbit</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DSR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the state of DTR and RTS based on contents of</span>
<span class="cm"> * serial_signals member of device context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_signals</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegValue</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">EnableBit</span><span class="p">;</span>

	<span class="n">RegValue</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">RegValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">RegValue</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CTL</span><span class="p">,</span> <span class="n">RegValue</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Port 0..3 DTR is ctrl reg &lt;1,3,5,7></p></td><td class="code"><div class="highlight"><pre>	<span class="n">EnableBit</span> <span class="o">=</span> <span class="n">BIT1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EnableBit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">|=</span> <span class="n">EnableBit</span><span class="p">;</span>
	<span class="n">write_control_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************/</span>
<span class="cm">/* DMA Buffer Code */</span>
<span class="cm">/*******************/</span>

<span class="cm">/* Set the count for all receive buffers to SCABUFSIZE</span>
<span class="cm"> * and set the current buffer to the first buffer. This effectively</span>
<span class="cm"> * makes all buffers free and discards any data in buffers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_reset_buffers</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rx_free_frame_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Free the buffers used by a received frame</span>
<span class="cm"> *</span>
<span class="cm"> * info   pointer to device instance data</span>
<span class="cm"> * first  index of 1st receive buffer of frame</span>
<span class="cm"> * last   index of last receive buffer of frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_free_frame_buffers</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
	        <span class="cm">/* reset current buffer for reuse */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">first</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	        <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	                <span class="cm">/* set new last rx descriptor address */</span>
			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RXDMA</span> <span class="o">+</span> <span class="n">EDA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">first</span><span class="p">].</span><span class="n">phys_entry</span><span class="p">);</span>
	        <span class="p">}</span>

	        <span class="n">first</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span>
			<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set current buffer to next buffer after last buffer of frame */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">current_rx_buf</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return a received frame from the receive DMA buffers.</span>
<span class="cm"> * Only frames received without errors are returned.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:	true if frame returned, otherwise false</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">rx_get_frame</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">StartIndex</span><span class="p">,</span> <span class="n">EndIndex</span><span class="p">;</span>	<span class="cm">/* index of 1st and last buffers of Rx frame */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ReturnCode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr_field</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
   	<span class="n">SCADESC</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">SCADESC_EX</span> <span class="o">*</span><span class="n">desc_ex</span><span class="p">;</span>

<span class="nl">CheckAgain:</span>
	<span class="cm">/* assume no frame returned, set zero length */</span>
	<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">addr_field</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * current_rx_buf points to the 1st buffer of the next available</span>
<span class="cm">	 * receive frame. To find the last buffer of the frame look for</span>
<span class="cm">	 * a non-zero status field in the buffer entries. (The status</span>
<span class="cm">	 * field is set by the 16C32 after completing a receive frame.</span>
<span class="cm">	 */</span>
	<span class="n">StartIndex</span> <span class="o">=</span> <span class="n">EndIndex</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">current_rx_buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">EndIndex</span><span class="p">];</span>
		<span class="n">desc_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">EndIndex</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">Cleanup</span><span class="p">;</span>	<span class="cm">/* current desc still in use, no frames available */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">addr_field</span> <span class="o">=</span> <span class="n">desc_ex</span><span class="o">-&gt;</span><span class="n">virt_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">framesize</span> <span class="o">+=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="cm">/* Status != 0 means last buffer of frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">EndIndex</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EndIndex</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span>
			<span class="n">EndIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">EndIndex</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">current_rx_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* all buffers have been &#39;used&#39; but none mark	   */</span>
			<span class="cm">/* the end of a frame. Reset buffers and receiver. */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="p">){</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">Cleanup</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* check status of receive frame */</span>

	<span class="cm">/* frame status is byte stored after frame data</span>
<span class="cm">	 *</span>
<span class="cm">	 * 7 EOM (end of msg), 1 = last buffer of frame</span>
<span class="cm">	 * 6 Short Frame, 1 = short frame</span>
<span class="cm">	 * 5 Abort, 1 = frame aborted</span>
<span class="cm">	 * 4 Residue, 1 = last byte is partial</span>
<span class="cm">	 * 3 Overrun, 1 = overrun occurred during frame reception</span>
<span class="cm">	 * 2 CRC,     1 = CRC error detected</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* ignore CRC bit if not using CRC (bit is undefined) */</span>
	<span class="cm">/* Note:CRC is not save to data buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">==</span> <span class="n">HDLC_CRC_NONE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">addr_field</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr_field</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">addr_filter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* discard 0 byte frames, this seems to occur sometime</span>
<span class="cm">		 * when remote is idling flags.</span>
<span class="cm">		 */</span>
		<span class="n">rx_free_frame_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">StartIndex</span><span class="p">,</span> <span class="n">EndIndex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">CheckAgain</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT6</span><span class="o">+</span><span class="n">BIT5</span><span class="o">+</span><span class="n">BIT3</span><span class="o">+</span><span class="n">BIT2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* received frame has errors,</span>
<span class="cm">		 * update counts and mark frame size as 0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT6</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxabort</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT3</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="o">++</span><span class="p">;</span>

		<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s rx_get_frame() status=%04X size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">framesize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_DATA</span> <span class="p">)</span>
		<span class="n">trace_block</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">StartIndex</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">,</span>
			<span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">framesize</span><span class="p">,</span> <span class="n">SCABUFSIZE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy dma buffer(s) to contiguous intermediate buffer */</span>
			<span class="kt">int</span> <span class="n">copy_count</span> <span class="o">=</span> <span class="n">framesize</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">StartIndex</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptmp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf_count</span> <span class="o">=</span> <span class="n">framesize</span><span class="p">;</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="o">++</span><span class="p">;</span>

			<span class="k">while</span><span class="p">(</span><span class="n">copy_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">partial_count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">copy_count</span><span class="p">,</span><span class="n">SCABUFSIZE</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span> <span class="n">ptmp</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list_ex</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">,</span>
					<span class="n">partial_count</span> <span class="p">);</span>
				<span class="n">ptmp</span> <span class="o">+=</span> <span class="n">partial_count</span><span class="p">;</span>
				<span class="n">copy_count</span> <span class="o">-=</span> <span class="n">partial_count</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span> <span class="o">++</span><span class="n">index</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="p">)</span>
					<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
				<span class="n">hdlcdev_rx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">,</span><span class="n">framesize</span><span class="p">);</span>
			<span class="k">else</span>
<span class="cp">#endif</span>
				<span class="n">ldisc_receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">,</span>
						  <span class="n">info</span><span class="o">-&gt;</span><span class="n">flag_buf</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Free the buffers used by this frame. */</span>
	<span class="n">rx_free_frame_buffers</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="n">StartIndex</span><span class="p">,</span> <span class="n">EndIndex</span> <span class="p">);</span>

	<span class="n">ReturnCode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">Cleanup:</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Receiver is enabled, but needs to restarted due to</span>
<span class="cm">		 * rx buffer overflow. If buffers are empty, restart receiver.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_list</span><span class="p">[</span><span class="n">EndIndex</span><span class="p">].</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ReturnCode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* load the transmit DMA buffer with data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_load_dma_buffer</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">copy_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SCADESC</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">SCADESC_EX</span> <span class="o">*</span><span class="n">desc_ex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_DATA</span> <span class="p">)</span>
		<span class="n">trace_block</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">SCABUFSIZE</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Copy source buffer to one or more DMA buffers, starting with</span>
<span class="cm">	 * the first transmit dma buffer.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;;)</span>
	<span class="p">{</span>
		<span class="n">copy_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">SCABUFSIZE</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">desc_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list_ex</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">load_pci_memory</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">desc_ex</span><span class="o">-&gt;</span><span class="n">virt_addr</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">copy_count</span><span class="p">);</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">copy_count</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">copy_count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">copy_count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* set EOM and EOT status */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_buf</span> <span class="o">=</span> <span class="o">++</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">register_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">testval</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">testval</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* assume failure */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressFailure</span><span class="p">;</span>

	<span class="cm">/* Write bit patterns to various registers but do it out of */</span>
	<span class="cm">/* sync, then read back and verify values. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TMC</span><span class="p">,</span> <span class="n">testval</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IDL</span><span class="p">,</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">]);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SA0</span><span class="p">,</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">]);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SA1</span><span class="p">,</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TMC</span><span class="p">)</span> <span class="o">!=</span> <span class="n">testval</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IDL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">])</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SA0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">])</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SA1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">testval</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">%</span><span class="n">count</span><span class="p">])</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">irq_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">timer</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIMER2</span> <span class="o">:</span> <span class="n">TIMER0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* assume failure */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_IrqFailure</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* setup timer0 on SCA0 to interrupt */</span>

	<span class="cm">/* IER2&lt;7..4&gt; = timer&lt;3..0&gt; interrupt enables (1=enabled) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IER2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">BIT6</span> <span class="o">:</span> <span class="n">BIT4</span><span class="p">));</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">timer</span> <span class="o">+</span> <span class="n">TEPR</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* timer expand prescale */</span>
	<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">timer</span> <span class="o">+</span> <span class="n">TCONR</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* timer constant */</span>


	<span class="cm">/* TMCS, Timer Control/Status Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      CMF, Compare match flag (read only) 1=match</span>
<span class="cm">	 * 06      ECMI, CMF Interrupt Enable: 1=enabled</span>
<span class="cm">	 * 05      Reserved, must be 0</span>
<span class="cm">	 * 04      TME, Timer Enable</span>
<span class="cm">	 * 03..00  Reserved, must be 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0101 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">timer</span> <span class="o">+</span> <span class="n">TMCS</span><span class="p">),</span> <span class="mh">0x50</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">timeout</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize individual SCA device (2 ports)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">sca_init</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set wait controller to single mem partition (low), no wait states */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PABR0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* wait controller addr boundary 0 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PABR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* wait controller addr boundary 1 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">WCRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* wait controller low range */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">WCRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* wait controller mid range */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">WCRH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* wait controller high range */</span>

	<span class="cm">/* DPCR, DMA Priority Control</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Not used, must be 0</span>
<span class="cm">	 * 04      BRC, bus release condition: 0=all transfers complete</span>
<span class="cm">	 * 03      CCC, channel change condition: 0=every cycle</span>
<span class="cm">	 * 02..00  PR&lt;2..0&gt;, priority 100=round robin</span>
<span class="cm">	 *</span>
<span class="cm">	 * 00000100 = 0x04</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DPCR</span><span class="p">,</span> <span class="n">dma_priority</span><span class="p">);</span>

	<span class="cm">/* DMA Master Enable, BIT7: 1=enable all channels */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* enable all interrupt classes */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IER0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* TxRDY,RxRDY,TxINT,RxINT (ports 0-1) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IER1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* DMIB,DMIA (channels 0-3) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IER2</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>	<span class="cm">/* TIRQ (timers 0-3) */</span>

	<span class="cm">/* ITCR, interrupt control register</span>
<span class="cm">	 * 07      IPC, interrupt priority, 0=MSCI-&gt;DMA</span>
<span class="cm">	 * 06..05  IAK&lt;1..0&gt;, Acknowledge cycle, 00=non-ack cycle</span>
<span class="cm">	 * 04      VOS, Vector Output, 0=unmodified vector</span>
<span class="cm">	 * 03..00  Reserved, must be 0</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ITCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize adapter hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">init_adapter</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set BIT30 of Local Control Reg 0x50 to reset SCA */</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">MiscCtrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">readval</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">misc_ctrl_value</span> <span class="o">|=</span> <span class="n">BIT30</span><span class="p">;</span>
	<span class="o">*</span><span class="n">MiscCtrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">misc_ctrl_value</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force at least 170ns delay before clearing</span>
<span class="cm">	 * reset bit. Each read from LCR takes at least</span>
<span class="cm">	 * 30ns so 10 times for 300ns to be safe.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">readval</span> <span class="o">=</span> <span class="o">*</span><span class="n">MiscCtrl</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">misc_ctrl_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT30</span><span class="p">;</span>
	<span class="o">*</span><span class="n">MiscCtrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">misc_ctrl_value</span><span class="p">;</span>

	<span class="cm">/* init control reg (all DTRs off, all clksel=input) */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">write_control_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">LCR1BRDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lcr_base</span> <span class="o">+</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="n">lcr1_brdr_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">);</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">read_ahead_count</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="n">lcr1_brdr_value</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">lcr1_brdr_value</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">lcr1_brdr_value</span> <span class="o">|=</span> <span class="n">BIT5</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">lcr1_brdr_value</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">LCR1BRDR</span> <span class="o">=</span> <span class="n">lcr1_brdr_value</span><span class="p">;</span>
		<span class="o">*</span><span class="n">MiscCtrl</span> <span class="o">=</span> <span class="n">misc_ctrl_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sca_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sca_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Loopback an HDLC frame to test the hardware</span>
<span class="cm"> * interrupt and DMA functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">loopback_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TESTFRAMESIZE 20</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">TESTFRAMESIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TESTFRAMESIZE</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">oldtty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="mi">3686400</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* assume failure */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_DmaFailure</span><span class="p">;</span>

	<span class="cm">/* build and send transmit frame */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">TESTFRAMESIZE</span><span class="p">;</span><span class="o">++</span><span class="n">count</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">count</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">TESTFRAMESIZE</span><span class="p">);</span>

	<span class="cm">/* program hardware for HDLC and enabled receiver */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">hdlc_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">enable_loopback</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
       	<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">tx_load_dma_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* wait for receive complete */</span>
	<span class="cm">/* Set a timeout for waiting for interrupt. */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">timeout</span><span class="p">;</span> <span class="o">--</span><span class="n">timeout</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_get_frame</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* verify received frame length and contents */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf_count</span> <span class="o">!=</span> <span class="n">count</span> <span class="o">||</span>
	      <span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tmp_rx_buf</span><span class="p">,</span><span class="n">count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_adapter</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">oldtty</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform diagnostics on hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adapter_test</span><span class="p">(</span> <span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Testing device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">init_adapter</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		<span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			<span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Register test failure for device %s Addr=%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">phys_sca_base</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Interrupt test failure for device %s IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loopback_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">loopback_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">loopback_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">loopback_test</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):DMA test failure for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):device %s passed diagnostics</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test the shared memory on a PCI adapter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">memory_test</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">testval</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">,</span> <span class="mh">0xaaaaaaaa</span><span class="p">,</span>
		<span class="mh">0x66666666</span><span class="p">,</span> <span class="mh">0x99999999</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x12345678</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">testval</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">SCA_MEM_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">;</span>

	<span class="cm">/* Test data lines with test pattern at one location. */</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">testval</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">testval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Test address lines with incrementing pattern over */</span>
	<span class="cm">/* entire address range. */</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memory_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCA_MEM_SIZE</span> <span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load data into PCI adapter shared memory.</span>
<span class="cm"> *</span>
<span class="cm"> * The PCI9050 releases control of the local bus</span>
<span class="cm"> * after completing the current read or write operation.</span>
<span class="cm"> *</span>
<span class="cm"> * While the PCI9050 write FIFO not empty, the</span>
<span class="cm"> * PCI9050 treats all of the writes as a single transaction</span>
<span class="cm"> * and does not release the bus. This causes DMA latency problems</span>
<span class="cm"> * at high speeds when copying large data blocks to the shared memory.</span>
<span class="cm"> *</span>
<span class="cm"> * This function breaks a write into multiple transations by</span>
<span class="cm"> * interleaving a read which flushes the write FIFO and &#39;completes&#39;</span>
<span class="cm"> * the write transation. This allows any pending DMA request to gain control</span>
<span class="cm"> * of the local bus in a timely fasion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_pci_memory</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* A load interval of 16 allows for 4 32-bit writes at */</span>
	<span class="cm">/* 136ns each for a maximum latency of 542ns on the local bus.*/</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">sca_pci_load_interval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interval</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">sca_pci_load_interval</span><span class="p">);</span>
		<span class="n">read_status_reg</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">dest</span> <span class="o">+=</span> <span class="n">sca_pci_load_interval</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">sca_pci_load_interval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span> <span class="o">%</span> <span class="n">sca_pci_load_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_block</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xmit</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s tx data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s rx data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">linecount</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">linecount</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">linecount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">linecount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mo">040</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="mo">0176</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">data</span>  <span class="o">+=</span> <span class="n">linecount</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>	<span class="cm">/* end of trace_block() */</span>

<span class="cm">/* called when HDLC frame times out</span>
<span class="cm"> * update stats and do tx completion processing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SLMP_INFO</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):%s tx_timeout()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txtimeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called to periodically check the DSR/RI modem signal input status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SLMP_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SLMP_INFO</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">delta</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* check for DSR/RI state change */</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">old_signals</span> <span class="o">^</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">old_signals</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MISCSTATUS_DSR_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_DSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MISCSTATUS_RI_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_RI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MISCSTATUS_DCD_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_DCD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MISCSTATUS_CTS_LATCHED</span><span class="o">|</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="o">&amp;</span><span class="n">SerialSignal_CTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">isr_io_pin</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* Register Access Routines -</span>
<span class="cm"> * All registers are memory mapped</span>
<span class="cm"> */</span>
<span class="cp">#define CALC_REGADDR() \</span>
<span class="cp">	unsigned char * RegAddr = (unsigned char*)(info-&gt;sca_base + Addr); \</span>
<span class="cp">	if (info-&gt;port_num &gt; 1) \</span>
<span class="cp">		RegAddr += 256;	    		</span><span class="cm">/* port 0-1 SCA0, 2-3 SCA1 */</span><span class="cp"> \</span>
<span class="cp">	if ( info-&gt;port_num &amp; 1) { \</span>
<span class="cp">		if (Addr &gt; 0x7f) \</span>
<span class="cp">			RegAddr += 0x40;	</span><span class="cm">/* DMA access */</span><span class="cp"> \</span>
<span class="cp">		else if (Addr &gt; 0x1f &amp;&amp; Addr &lt; 0x60) \</span>
<span class="cp">			RegAddr += 0x20;	</span><span class="cm">/* MSCI access */</span><span class="cp"> \</span>
<span class="cp">	}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">RegAddr</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="o">*</span><span class="n">RegAddr</span> <span class="o">=</span> <span class="n">Value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">read_reg16</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">RegAddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_reg16</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">Value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CALC_REGADDR</span><span class="p">();</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">RegAddr</span><span class="p">)</span> <span class="o">=</span> <span class="n">Value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read_status_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">RegAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">RegAddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_control_reg</span><span class="p">(</span><span class="n">SLMP_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">RegAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">statctrl_base</span><span class="p">;</span>
	<span class="o">*</span><span class="n">RegAddr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ctrlreg_value</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">synclinkmp_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error enabling pci device %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">device_init</span><span class="p">(</span> <span class="o">++</span><span class="n">synclinkmp_adapter_count</span><span class="p">,</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">synclinkmp_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
