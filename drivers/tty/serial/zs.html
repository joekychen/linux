<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › zs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>zs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * zs.c: Serial port driver for IOASIC DECstations.</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from drivers/sbus/char/sunserial.c by Paul Mackerras.</span>
<span class="cm"> * Derived from drivers/macintosh/macserial.c by Harald Koerfgen.</span>
<span class="cm"> *</span>
<span class="cm"> * DECstation changes</span>
<span class="cm"> * Copyright (C) 1998-2000 Harald Koerfgen</span>
<span class="cm"> * Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005, 2007  Maciej W. Rozycki</span>
<span class="cm"> *</span>
<span class="cm"> * For the rest of the code the original Copyright applies:</span>
<span class="cm"> * Copyright (C) 1996 Paul Mackerras (Paul.Mackerras@cs.anu.edu.au)</span>
<span class="cm"> * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Note: for IOASIC systems the wiring is as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * mouse/keyboard:</span>
<span class="cm"> * DIN-7 MJ-4  signal        SCC</span>
<span class="cm"> * 2     1     TxD       &lt;-  A.TxD</span>
<span class="cm"> * 3     4     RxD       -&gt;  A.RxD</span>
<span class="cm"> *</span>
<span class="cm"> * EIA-232/EIA-423:</span>
<span class="cm"> * DB-25 MMJ-6 signal        SCC</span>
<span class="cm"> * 2     2     TxD       &lt;-  B.TxD</span>
<span class="cm"> * 3     5     RxD       -&gt;  B.RxD</span>
<span class="cm"> * 4           RTS       &lt;- ~A.RTS</span>
<span class="cm"> * 5           CTS       -&gt; ~B.CTS</span>
<span class="cm"> * 6     6     DSR       -&gt; ~A.SYNC</span>
<span class="cm"> * 8           CD        -&gt; ~B.DCD</span>
<span class="cm"> * 12          DSRS(DCE) -&gt; ~A.CTS  (*)</span>
<span class="cm"> * 15          TxC       -&gt;  B.TxC</span>
<span class="cm"> * 17          RxC       -&gt;  B.RxC</span>
<span class="cm"> * 20    1     DTR       &lt;- ~A.DTR</span>
<span class="cm"> * 22          RI        -&gt; ~A.DCD</span>
<span class="cm"> * 23          DSRS(DTE) &lt;- ~B.RTS</span>
<span class="cm"> *</span>
<span class="cm"> * (*) EIA-232 defines the signal at this pin to be SCD, while DSRS(DCE)</span>
<span class="cm"> *     is shared with DSRS(DTE) at pin 23.</span>
<span class="cm"> *</span>
<span class="cm"> * As you can immediately notice the wiring of the RTS, DTR and DSR signals</span>
<span class="cm"> * is a bit odd.  This makes the handling of port B unnecessarily</span>
<span class="cm"> * complicated and prevents the use of some automatic modes of operation.</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_SERIAL_ZS_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/irqflags.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;asm/dec/interrupts.h&gt;</span>
<span class="cp">#include &lt;asm/dec/ioasic_addrs.h&gt;</span>
<span class="cp">#include &lt;asm/dec/system.h&gt;</span>

<span class="cp">#include &quot;zs.h&quot;</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maciej W. Rozycki &lt;macro@linux-mips.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DECstation Z85C30 serial driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">char</span> <span class="n">zs_name</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;DECstation Z85C30 serial driver version &quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">zs_version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;0.10&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * It would be nice to dynamically allocate everything that</span>
<span class="cm"> * depends on ZS_NUM_SCCS, so we could support any number of</span>
<span class="cm"> * Z85C30s, but for now...</span>
<span class="cm"> */</span>
<span class="cp">#define ZS_NUM_SCCS	2		</span><span class="cm">/* Max # of ZS chips supported.  */</span><span class="cp"></span>
<span class="cp">#define ZS_NUM_CHAN	2		</span><span class="cm">/* 2 channels per chip.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CHAN_A	0		</span><span class="cm">/* Index of the channel A.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CHAN_B	1		</span><span class="cm">/* Index of the channel B.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CHAN_IO_SIZE 8		</span><span class="cm">/* IOMEM space size.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CHAN_IO_STRIDE 4		</span><span class="cm">/* Register alignment.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CHAN_IO_OFFSET 1		</span><span class="cm">/* The SCC resides on the high byte</span>
<span class="cm">					   of the 16-bit IOBUS.  */</span><span class="cp"></span>
<span class="cp">#define ZS_CLOCK        7372800 	</span><span class="cm">/* Z85C30 PCLK input clock rate.  */</span><span class="cp"></span>

<span class="cp">#define to_zport(uport) container_of(uport, struct zs_port, port)</span>

<span class="k">struct</span> <span class="n">zs_parms</span> <span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">scc</span><span class="p">[</span><span class="n">ZS_NUM_SCCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">ZS_NUM_SCCS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zs_scc</span> <span class="n">zs_sccs</span><span class="p">[</span><span class="n">ZS_NUM_SCCS</span><span class="p">];</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">zs_init_regs</span><span class="p">[</span><span class="n">ZS_NUM_REGS</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* write 0 */</span>
	<span class="n">PAR_SPEC</span><span class="p">,</span>			<span class="cm">/* write 1 */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* write 2 */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* write 3 */</span>
	<span class="n">X16CLK</span> <span class="o">|</span> <span class="n">SB1</span><span class="p">,</span>			<span class="cm">/* write 4 */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* write 5 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* write 6, 7, 8 */</span>
	<span class="n">MIE</span> <span class="o">|</span> <span class="n">DLC</span> <span class="o">|</span> <span class="n">NV</span><span class="p">,</span>			<span class="cm">/* write 9 */</span>
	<span class="n">NRZ</span><span class="p">,</span>				<span class="cm">/* write 10 */</span>
	<span class="n">TCBR</span> <span class="o">|</span> <span class="n">RCBR</span><span class="p">,</span>			<span class="cm">/* write 11 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>				<span class="cm">/* BRG time constant, write 12 + 13 */</span>
	<span class="n">BRSRC</span> <span class="o">|</span> <span class="n">BRENABL</span><span class="p">,</span>		<span class="cm">/* write 14 */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* write 15 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Debugging.</span>
<span class="cm"> */</span>
<span class="cp">#undef ZS_DEBUG_REGS</span>


<span class="cm">/*</span>
<span class="cm"> * Reading and writing Z85C30 registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">recovery_delay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_zsreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">ZS_CHAN_IO_OFFSET</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">fast_iob</span><span class="p">();</span>
		<span class="n">recovery_delay</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">recovery_delay</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_zsreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">ZS_CHAN_IO_OFFSET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">fast_iob</span><span class="p">();</span> <span class="n">recovery_delay</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">fast_iob</span><span class="p">();</span>
	<span class="n">recovery_delay</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_zsdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span>
			     <span class="n">ZS_CHAN_IO_STRIDE</span> <span class="o">+</span> <span class="n">ZS_CHAN_IO_OFFSET</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">recovery_delay</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_zsdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span>
			     <span class="n">ZS_CHAN_IO_STRIDE</span> <span class="o">+</span> <span class="n">ZS_CHAN_IO_OFFSET</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">fast_iob</span><span class="p">();</span>
	<span class="n">recovery_delay</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef ZS_DEBUG_REGS</span>
<span class="kt">void</span> <span class="nf">zs_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ZS_NUM_SCCS</span> <span class="o">*</span> <span class="n">ZS_NUM_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">ZS_NUM_CHAN</span><span class="p">].</span><span class="n">zport</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">ZS_NUM_CHAN</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;W%-2d = 0x%02x</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;R%-2d = 0x%02x</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_spin_lock_cond_irq</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_spin_unlock_cond_irq</span><span class="p">(</span><span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_receive_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Rx_CH_AV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span>
		<span class="n">read_zsdata</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_transmit_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Tx_BUF_EMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zs_spin_unlock_cond_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">zs_spin_lock_cond_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_line_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ALL_SNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zs_spin_unlock_cond_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">zs_spin_lock_cond_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_zsregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Let the current transmission finish.  */</span>
	<span class="n">zs_line_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="cm">/* Load &#39;em up.  */</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RxENABLE</span><span class="p">);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TxENAB</span><span class="p">);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R4</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R9</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R10</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BRENABL</span><span class="p">);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R12</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R13</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RxENABLE</span><span class="p">)</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TxENAB</span><span class="p">)</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Status handling routines.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * zs_tx_empty() -- get the transmitter empty status</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting.  This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zs_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">ALL_SNT</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zs_raw_get_ab_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status_a</span><span class="p">,</span> <span class="n">status_b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">;</span>

	<span class="n">status_a</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R0</span><span class="p">);</span>
	<span class="n">status_b</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport_b</span><span class="p">,</span> <span class="n">R0</span><span class="p">);</span>

	<span class="n">mctrl</span> <span class="o">=</span> <span class="p">((</span><span class="n">status_b</span> <span class="o">&amp;</span> <span class="n">CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">status_b</span> <span class="o">&amp;</span> <span class="n">DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">status_a</span> <span class="o">&amp;</span> <span class="n">DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">status_a</span> <span class="o">&amp;</span> <span class="n">SYNC_HUNT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zs_raw_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">zport</span> <span class="o">!=</span> <span class="n">zport_a</span> <span class="o">?</span> <span class="n">zs_raw_get_ab_mctrl</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">zport</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zs_raw_xor_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmask</span><span class="p">,</span> <span class="n">mctrl</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask_a</span><span class="p">,</span> <span class="n">mask_b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">==</span> <span class="n">zport_a</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mask_a</span> <span class="o">=</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">mask_b</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="n">mmask</span> <span class="o">=</span> <span class="p">((</span><span class="n">mask_b</span> <span class="o">&amp;</span> <span class="n">CTSIE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">mask_b</span> <span class="o">&amp;</span> <span class="n">DCDIE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">mask_a</span> <span class="o">&amp;</span> <span class="n">DCDIE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">mask_a</span> <span class="o">&amp;</span> <span class="n">SYNCIE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mctrl</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mmask</span><span class="p">;</span>
		<span class="n">mctrl</span> <span class="o">|=</span> <span class="n">zs_raw_get_ab_mctrl</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">zport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mmask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">mctrl</span> <span class="o">^</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="n">mctrl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">zs_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="n">mctrl</span> <span class="o">=</span> <span class="n">zs_raw_get_mctrl</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">oldloop</span><span class="p">,</span> <span class="n">newloop</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">!=</span> <span class="n">zport_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
			<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DTR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
			<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RTS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTS</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Rarely modified, so don&#39;t poke at hardware unless necessary. */</span>
	<span class="n">oldloop</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">newloop</span> <span class="o">=</span> <span class="n">oldloop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">newloop</span> <span class="o">|=</span> <span class="n">LOOPBAK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">newloop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LOOPBAK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newloop</span> <span class="o">!=</span> <span class="n">oldloop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">newloop</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_raw_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="n">zs_raw_stop_tx</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">zs_raw_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zs_transmit_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">zs_raw_transmit_chars</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRKIE</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RxINT_MASK</span> <span class="o">|</span> <span class="n">TxINT_ENAB</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RxINT_DISAB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">!=</span> <span class="n">zport_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* A-side DCD tracks RI and SYNC tracks DSR.  */</span>
		<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DCDIE</span> <span class="o">|</span> <span class="n">SYNCIE</span><span class="p">);</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRKIE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_INT_ENAB</span><span class="p">;</span>
			<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="cm">/* This-side DCD tracks DCD and CTS tracks CTS.  */</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DCDIE</span> <span class="o">|</span> <span class="n">CTSIE</span><span class="p">);</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_INT_ENAB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* DCD tracks RI and SYNC tracks DSR for the B side.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCDIE</span> <span class="o">|</span> <span class="n">SYNCIE</span><span class="p">)))</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_INT_ENAB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">==</span> <span class="n">zport_a</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>

	<span class="cm">/* Clear Ext interrupts if not being handled already.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EXT_INT_ENAB</span><span class="p">))</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_EXT_INT</span><span class="p">);</span>

	<span class="cm">/* A-side DCD tracks RI and SYNC tracks DSR.  */</span>
	<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">EXT_INT_ENAB</span><span class="p">;</span>
	<span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DCDIE</span> <span class="o">|</span> <span class="n">SYNCIE</span><span class="p">;</span>

	<span class="cm">/* This-side DCD tracks DCD and CTS tracks CTS.  */</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DCDIE</span> <span class="o">|</span> <span class="n">CTSIE</span><span class="p">;</span>

	<span class="n">zs_raw_xor_mctrl</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>

	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">zport_a</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SND_BRK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SND_BRK</span><span class="p">;</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Interrupt handling routines.</span>
<span class="cm"> */</span>
<span class="cp">#define Rx_BRK 0x0100			</span><span class="cm">/* BREAK event software flag.  */</span><span class="cp"></span>
<span class="cp">#define Rx_SYS 0x0200			</span><span class="cm">/* SysRq event software flag.  */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">avail</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Rx_CH_AV</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">avail</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rx_OVR</span> <span class="o">|</span> <span class="n">FRM_ERR</span> <span class="o">|</span> <span class="n">PAR_ERR</span><span class="p">);</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">read_zsdata</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>

		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Handle the null char got when BREAK is removed.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">tty_break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">Rx_OVR</span> <span class="o">|</span> <span class="n">FRM_ERR</span> <span class="o">|</span> <span class="n">PAR_ERR</span> <span class="o">|</span> <span class="n">Rx_SYS</span> <span class="o">|</span> <span class="n">Rx_BRK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tty_break</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Reset the error indication.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rx_OVR</span> <span class="o">|</span> <span class="n">FRM_ERR</span> <span class="o">|</span> <span class="n">PAR_ERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
				<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">ERR_RES</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Rx_SYS</span> <span class="o">|</span> <span class="n">Rx_BRK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* SysRq discards the null char.  */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_SYS</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FRM_ERR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PAR_ERR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_OVR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_BRK</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FRM_ERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PAR_ERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">uart_insert_char</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Rx_OVR</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_raw_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>

	<span class="cm">/* XON/XOFF chars.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_zsdata</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">);</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If nothing to do or stopped or hardware stopped.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zs_raw_stop_tx</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send char.  */</span>
	<span class="n">write_zsdata</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]);</span>
	<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Are we are done?  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
		<span class="n">zs_raw_stop_tx</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="n">zs_raw_transmit_chars</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_status_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">brk</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>

	<span class="cm">/* Get status from Read Register 0.  */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BRKIE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brk</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">BRK_ABRT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brk</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="n">uport</span><span class="p">))</span>
				<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tty_break</span> <span class="o">=</span> <span class="n">Rx_SYS</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tty_break</span> <span class="o">=</span> <span class="n">Rx_BRK</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">brk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">!=</span> <span class="n">zport_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">zs_raw_xor_mctrl</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span>
			<span class="n">uart_handle_cts_change</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span>
					       <span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">TIOCM_CAR</span><span class="p">)</span>
			<span class="n">uart_handle_dcd_change</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span>
					       <span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_CAR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the status condition...  */</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_EXT_INT</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the Z85C30 driver&#39;s generic interrupt routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">zs_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_B</span><span class="p">];</span>
	<span class="n">irqreturn_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">zs_intreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: The read register 3, which holds the irq status,</span>
<span class="cm">	 *       does so for both channels on each chip.  Although</span>
<span class="cm">	 *       the status value itself must be read from the A</span>
<span class="cm">	 *       channel and is only valid when read from channel A.</span>
<span class="cm">	 *       Yes... broken hardware...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="n">zs_intreg</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">R3</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zs_intreg</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We do not like losing characters, so we prioritise</span>
<span class="cm">		 * interrupt sources a little bit differently than</span>
<span class="cm">		 * the SCC would, was it allowed to.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHBRxIP</span><span class="p">)</span>
			<span class="n">zs_receive_chars</span><span class="p">(</span><span class="n">zport_b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHARxIP</span><span class="p">)</span>
			<span class="n">zs_receive_chars</span><span class="p">(</span><span class="n">zport_a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHBEXT</span><span class="p">)</span>
			<span class="n">zs_status_handle</span><span class="p">(</span><span class="n">zport_b</span><span class="p">,</span> <span class="n">zport_a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHAEXT</span><span class="p">)</span>
			<span class="n">zs_status_handle</span><span class="p">(</span><span class="n">zport_a</span><span class="p">,</span> <span class="n">zport_a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHBTxIP</span><span class="p">)</span>
			<span class="n">zs_transmit_chars</span><span class="p">(</span><span class="n">zport_b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_intreg</span> <span class="o">&amp;</span> <span class="n">CHATxIP</span><span class="p">)</span>
			<span class="n">zs_transmit_chars</span><span class="p">(</span><span class="n">zport_a</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Finally, routines used to initialize the serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_guard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">irq_guard</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq_guard</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_guard</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">zs_interrupt</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;scc&quot;</span><span class="p">,</span> <span class="n">scc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq_guard</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;zs: can&#39;t get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear the receive FIFO.  */</span>
	<span class="n">zs_receive_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>

	<span class="cm">/* Clear the interrupt registers.  */</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">ERR_RES</span><span class="p">);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>
	<span class="cm">/* But Ext only if not being handled already.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EXT_INT_ENAB</span><span class="p">))</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_EXT_INT</span><span class="p">);</span>

	<span class="cm">/* Finally, enable sequencing and interrupts.  */</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxINT_MASK</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RxINT_ALL</span> <span class="o">|</span> <span class="n">TxINT_ENAB</span> <span class="o">|</span> <span class="n">EXT_INT_ENAB</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RxENABLE</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BRKIE</span><span class="p">;</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>

	<span class="cm">/* Record the current state of RR0.  */</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="n">zs_raw_get_mctrl</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BRK_ABRT</span><span class="p">;</span>

	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_guard</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxENABLE</span><span class="p">;</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">irq_guard</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq_guard</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_guard</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">scc</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="o">!</span><span class="n">irqs_disabled_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">initialised</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset the pointer first, just in case...  */</span>
		<span class="n">read_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R0</span><span class="p">);</span>
		<span class="cm">/* And let the current transmission finish.  */</span>
		<span class="n">zs_line_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R9</span><span class="p">,</span> <span class="n">FHWRES</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">initialised</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">load_zsregs</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">ZS_CHAN_A</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">brg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="o">!</span><span class="n">irqs_disabled_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Byte size.  */</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxNBITS_MASK</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TxNBITS_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Rx5</span><span class="p">;</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Tx5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Rx6</span><span class="p">;</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Tx6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Rx7</span><span class="p">;</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Tx7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
	<span class="nl">default:</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Rx8</span><span class="p">;</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Tx8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parity and stop bits.  */</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XCLK_MASK</span> <span class="o">|</span> <span class="n">SB_MASK</span> <span class="o">|</span> <span class="n">PAR_ENA</span> <span class="o">|</span> <span class="n">PAR_EVEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SB2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SB1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PAR_ENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PAR_EVEN</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">clk_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">X64CLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">X32CLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">X16CLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="n">X1CLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">clk_mode</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">brg</span> <span class="o">=</span> <span class="n">ZS_BPS_TO_BRG</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">clk_mode</span><span class="p">);</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">brg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">brg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">Rx_OVR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">FRM_ERR</span> <span class="o">|</span> <span class="n">PAR_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">Rx_BRK</span><span class="p">;</span>

	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">FRM_ERR</span> <span class="o">|</span> <span class="n">PAR_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">Rx_BRK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">Rx_OVR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RxENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zport</span> <span class="o">!=</span> <span class="n">zport_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DCDIE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCDIE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CTSIE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CTSIE</span><span class="p">;</span>
		<span class="n">zs_raw_xor_mctrl</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Load up the new values.  */</span>
	<span class="n">load_zsregs</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hack alert!</span>
<span class="cm"> * Required solely so that the initial PROM-based console</span>
<span class="cm"> * works undisturbed in parallel with this one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TxENAB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TxENAB</span><span class="p">;</span>
	<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">zs_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;Z85C30 SCC&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">ZS_CHAN_IO_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span>
						 <span class="n">ZS_CHAN_IO_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;zs: Cannot map MMIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">ZS_CHAN_IO_SIZE</span><span class="p">,</span> <span class="s">&quot;scc&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;zs: Unable to reserve MMIO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">zs_map_port</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">ZS_CHAN_IO_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UART_CONFIG_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zs_request_port</span><span class="p">(</span><span class="n">uport</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_ZS</span><span class="p">;</span>

		<span class="n">zs_reset</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zs_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_ZS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">clk_mode</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">zs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">zs_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">zs_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">zs_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">zs_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">zs_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">zs_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">zs_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">zs_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">zs_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">zs_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">zs_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="n">zs_pm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">zs_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">zs_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">zs_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">zs_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">zs_verify_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize Z85C30 port structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">zs_probe_sccs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_parms</span> <span class="n">zs_parms</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_chips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_SCC0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zs_parms</span><span class="p">.</span><span class="n">scc</span><span class="p">[</span><span class="n">n_chips</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOASIC_SCC0</span><span class="p">;</span>
		<span class="n">zs_parms</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="n">n_chips</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_SCC0</span><span class="p">];</span>
		<span class="n">n_chips</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_SCC1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zs_parms</span><span class="p">.</span><span class="n">scc</span><span class="p">[</span><span class="n">n_chips</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOASIC_SCC1</span><span class="p">;</span>
		<span class="n">zs_parms</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="n">n_chips</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_SCC1</span><span class="p">];</span>
		<span class="n">n_chips</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n_chips</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">n_chips</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">zlock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">side</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">side</span> <span class="o">&lt;</span> <span class="n">ZS_NUM_CHAN</span><span class="p">;</span> <span class="n">side</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">zport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>
			<span class="n">zport</span><span class="o">-&gt;</span><span class="n">clk_mode</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">zs_parms</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="n">ZS_CLOCK</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_ops</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span>	<span class="o">=</span> <span class="n">chip</span> <span class="o">*</span> <span class="n">ZS_NUM_CHAN</span> <span class="o">+</span> <span class="n">side</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="n">dec_kn_slot_base</span> <span class="o">+</span>
					  <span class="n">zs_parms</span><span class="p">.</span><span class="n">scc</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span> <span class="o">+</span>
					  <span class="p">(</span><span class="n">side</span> <span class="o">^</span> <span class="n">ZS_CHAN_B</span><span class="p">)</span> <span class="o">*</span> <span class="n">ZS_CHAN_IO_SIZE</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ZS_NUM_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zs_init_regs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_SERIAL_ZS_CONSOLE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="n">to_zport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="o">!</span><span class="n">irqs_disabled_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zs_transmit_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">irq</span><span class="p">))</span>
		<span class="n">write_zsdata</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print a string to the serial port trying not to disturb</span>
<span class="cm"> * any possible real use of the port...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zs_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">/</span> <span class="n">ZS_NUM_CHAN</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="n">ZS_NUM_CHAN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">zport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txint</span><span class="p">,</span> <span class="n">txenb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Disable transmit interrupts and enable the transmitter. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">txint</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">txenb</span> <span class="o">=</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txint</span> <span class="o">&amp;</span> <span class="n">TxINT_ENAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txint</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TxINT_ENAB</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txenb</span> <span class="o">&amp;</span> <span class="n">TxENAB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">txenb</span> <span class="o">|</span> <span class="n">TxENAB</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">zs_console_putchar</span><span class="p">);</span>

	<span class="cm">/* Restore transmit interrupts and the transmitter enable. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="o">!</span><span class="n">irqs_disabled_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">zs_line_drain</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txenb</span> <span class="o">&amp;</span> <span class="n">TxENAB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TxENAB</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R5</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txint</span> <span class="o">&amp;</span> <span class="n">TxINT_ENAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TxINT_ENAB</span><span class="p">;</span>
		<span class="n">write_zsreg</span><span class="p">(</span><span class="n">zport</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">zport</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup serial console baud/bits/parity.  We do two things here:</span>
<span class="cm"> * - construct a cflag setting for the first uart_open()</span>
<span class="cm"> * - initialise the serial port</span>
<span class="cm"> * Return non-zero if we didn&#39;t find a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">zs_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">/</span> <span class="n">ZS_NUM_CHAN</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="n">ZS_NUM_CHAN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">zport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zs_map_port</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">zs_reset</span><span class="p">(</span><span class="n">zport</span><span class="p">);</span>
	<span class="n">zs_pm</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">zs_reg</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">zs_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">zs_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>	<span class="o">=</span> <span class="n">zs_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Register console.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">zs_serial_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">zs_probe_sccs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_console</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">console_initcall</span><span class="p">(</span><span class="n">zs_serial_console_init</span><span class="p">);</span>

<span class="cp">#define SERIAL_ZS_CONSOLE	&amp;zs_console</span>
<span class="cp">#else</span>
<span class="cp">#define SERIAL_ZS_CONSOLE	NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_ZS_CONSOLE */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">zs_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>		<span class="o">=</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>		<span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>			<span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span>			<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>			<span class="o">=</span> <span class="n">ZS_NUM_SCCS</span> <span class="o">*</span> <span class="n">ZS_NUM_CHAN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span>			<span class="o">=</span> <span class="n">SERIAL_ZS_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* zs_init inits the driver. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">zs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zs_name</span><span class="p">,</span> <span class="n">zs_version</span><span class="p">);</span>

	<span class="cm">/* Find out how many Z85C30 SCCs we have.  */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">zs_probe_sccs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ZS_NUM_SCCS</span> <span class="o">*</span> <span class="n">ZS_NUM_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">ZS_NUM_CHAN</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">ZS_NUM_CHAN</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">)</span>
			<span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_reg</span><span class="p">,</span> <span class="n">uport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">zs_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ZS_NUM_SCCS</span> <span class="o">*</span> <span class="n">ZS_NUM_CHAN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">zs_scc</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zs_sccs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">ZS_NUM_CHAN</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">zs_port</span> <span class="o">*</span><span class="n">zport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">zport</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">ZS_NUM_CHAN</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zport</span><span class="o">-&gt;</span><span class="n">scc</span><span class="p">)</span>
			<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_reg</span><span class="p">,</span> <span class="n">uport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zs_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">zs_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">zs_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
