<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › mpsc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpsc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Generic driver for the MPSC (UART mode) on Marvell parts (e.g., GT64240,</span>
<span class="cm"> * GT64260, MV64340, MV64360, GT96100, ... ).</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Mark A. Greer &lt;mgreer@mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on an old MPSC driver that was in the linuxppc tree.  It appears to</span>
<span class="cm"> * have been created by Chris Zankel (formerly of MontaVista) but there</span>
<span class="cm"> * is no proper Copyright so I&#39;m not sure.  Apparently, parts were also</span>
<span class="cm"> * taken from PPCBoot (now U-Boot).  Also based on drivers/serial/8250.c</span>
<span class="cm"> * by Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * 2004 (c) MontaVista, Software, Inc.  This file is licensed under</span>
<span class="cm"> * the terms of the GNU General Public License version 2.  This program</span>
<span class="cm"> * is licensed &quot;as is&quot; without any warranty of any kind, whether express</span>
<span class="cm"> * or implied.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * The MPSC interface is much like a typical network controller&#39;s interface.</span>
<span class="cm"> * That is, you set up separate rings of descriptors for transmitting and</span>
<span class="cm"> * receiving data.  There is also a pool of buffers with (one buffer per</span>
<span class="cm"> * descriptor) that incoming data are dma&#39;d into or outgoing data are dma&#39;d</span>
<span class="cm"> * out of.</span>
<span class="cm"> *</span>
<span class="cm"> * The MPSC requires two other controllers to be able to work.  The Baud Rate</span>
<span class="cm"> * Generator (BRG) provides a clock at programmable frequencies which determines</span>
<span class="cm"> * the baud rate.  The Serial DMA Controller (SDMA) takes incoming data from the</span>
<span class="cm"> * MPSC and DMA&#39;s it into memory or DMA&#39;s outgoing data and passes it to the</span>
<span class="cm"> * MPSC.  It is actually the SDMA interrupt that the driver uses to keep the</span>
<span class="cm"> * transmit and receive &quot;engines&quot; going (i.e., indicate data has been</span>
<span class="cm"> * transmitted or received).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Some chips have an erratum where several regs cannot be</span>
<span class="cm"> * read.  To work around that, we keep a local copy of those regs in</span>
<span class="cm"> * &#39;mpsc_port_info&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * 2) Some chips have an erratum where the ctlr will hang when the SDMA ctlr</span>
<span class="cm"> * accesses system mem with coherency enabled.  For that reason, the driver</span>
<span class="cm"> * assumes that coherency for that ctlr has been disabled.  This means</span>
<span class="cm"> * that when in a cache coherent system, the driver has to manually manage</span>
<span class="cm"> * the data cache on the areas that it touches because the dma_* macro are</span>
<span class="cm"> * basically no-ops.</span>
<span class="cm"> *</span>
<span class="cm"> * 3) There is an erratum (on PPC) where you can&#39;t use the instruction to do</span>
<span class="cm"> * a DMA_TO_DEVICE/cache clean so DMA_BIDIRECTIONAL/flushes are used in places</span>
<span class="cm"> * where a DMA_TO_DEVICE/clean would have [otherwise] sufficed.</span>
<span class="cm"> *</span>
<span class="cm"> * 4) AFAICT, hardware flow control isn&#39;t supported by the controller --MAG.</span>
<span class="cm"> */</span>


<span class="cp">#if defined(CONFIG_SERIAL_MPSC_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mv643xx.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define	MPSC_NUM_CTLRS		2</span>

<span class="cm">/*</span>
<span class="cm"> * Descriptors and buffers must be cache line aligned.</span>
<span class="cm"> * Buffers lengths must be multiple of cache line size.</span>
<span class="cm"> * Number of Tx &amp; Rx descriptors must be powers of 2.</span>
<span class="cm"> */</span>
<span class="cp">#define	MPSC_RXR_ENTRIES	32</span>
<span class="cp">#define	MPSC_RXRE_SIZE		dma_get_cache_alignment()</span>
<span class="cp">#define	MPSC_RXR_SIZE		(MPSC_RXR_ENTRIES * MPSC_RXRE_SIZE)</span>
<span class="cp">#define	MPSC_RXBE_SIZE		dma_get_cache_alignment()</span>
<span class="cp">#define	MPSC_RXB_SIZE		(MPSC_RXR_ENTRIES * MPSC_RXBE_SIZE)</span>

<span class="cp">#define	MPSC_TXR_ENTRIES	32</span>
<span class="cp">#define	MPSC_TXRE_SIZE		dma_get_cache_alignment()</span>
<span class="cp">#define	MPSC_TXR_SIZE		(MPSC_TXR_ENTRIES * MPSC_TXRE_SIZE)</span>
<span class="cp">#define	MPSC_TXBE_SIZE		dma_get_cache_alignment()</span>
<span class="cp">#define	MPSC_TXB_SIZE		(MPSC_TXR_ENTRIES * MPSC_TXBE_SIZE)</span>

<span class="cp">#define	MPSC_DMA_ALLOC_SIZE	(MPSC_RXR_SIZE + MPSC_RXB_SIZE + MPSC_TXR_SIZE \</span>
<span class="cp">		+ MPSC_TXB_SIZE + dma_get_cache_alignment() </span><span class="cm">/* for alignment */</span><span class="cp">)</span>

<span class="cm">/* Rx and Tx Ring entry descriptors -- assume entry size is &lt;= cacheline size */</span>
<span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bytecnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmdstat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">bytecnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">shadow</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmdstat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Some regs that have the erratum that you can&#39;t read them are are shared</span>
<span class="cm"> * between the two MPSC controllers.  This struct contains those shared regs.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mpsc_shared_regs</span> <span class="p">{</span>
	<span class="n">phys_addr_t</span> <span class="n">mpsc_routing_base_p</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">sdma_intr_base_p</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mpsc_routing_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sdma_intr_base</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">MPSC_MRR_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MPSC_RCRR_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MPSC_TCRR_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SDMA_INTR_CAUSE_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SDMA_INTR_MASK_m</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The main driver data structure */</span>
<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>	<span class="cm">/* Overlay uart_port structure */</span>

	<span class="cm">/* Internal driver state for this ctlr */</span>
	<span class="n">u8</span> <span class="n">ready</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rcv_data</span><span class="p">;</span>
	<span class="n">tcflag_t</span> <span class="n">c_iflag</span><span class="p">;</span>	<span class="cm">/* save termios-&gt;c_iflag */</span>
	<span class="n">tcflag_t</span> <span class="n">c_cflag</span><span class="p">;</span>	<span class="cm">/* save termios-&gt;c_cflag */</span>

	<span class="cm">/* Info passed in from platform */</span>
	<span class="n">u8</span> <span class="n">mirror_regs</span><span class="p">;</span>		<span class="cm">/* Need to mirror regs? */</span>
	<span class="n">u8</span> <span class="n">cache_mgmt</span><span class="p">;</span>		<span class="cm">/* Need manual cache mgmt? */</span>
	<span class="n">u8</span> <span class="n">brg_can_tune</span><span class="p">;</span>	<span class="cm">/* BRG has baud tuning? */</span>
	<span class="n">u32</span> <span class="n">brg_clk_src</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mpsc_max_idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_baud</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_parity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_flow</span><span class="p">;</span>

	<span class="cm">/* Physical addresses of various blocks of registers (from platform) */</span>
	<span class="n">phys_addr_t</span> <span class="n">mpsc_base_p</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">sdma_base_p</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">brg_base_p</span><span class="p">;</span>

	<span class="cm">/* Virtual addresses of various blocks of registers (from platform) */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mpsc_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sdma_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">brg_base</span><span class="p">;</span>

	<span class="cm">/* Descriptor ring and buffer allocations */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dma_region</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_region_p</span><span class="p">;</span>

	<span class="n">dma_addr_t</span> <span class="n">rxr</span><span class="p">;</span>		<span class="cm">/* Rx descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">rxr_p</span><span class="p">;</span>	<span class="cm">/* Phys addr of rxr */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>		<span class="cm">/* Rx Ring I/O buf */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rxb_p</span><span class="p">;</span>		<span class="cm">/* Phys addr of rxb */</span>
	<span class="n">u32</span> <span class="n">rxr_posn</span><span class="p">;</span>		<span class="cm">/* First desc w/ Rx data */</span>

	<span class="n">dma_addr_t</span> <span class="n">txr</span><span class="p">;</span>		<span class="cm">/* Tx descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">txr_p</span><span class="p">;</span>	<span class="cm">/* Phys addr of txr */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>		<span class="cm">/* Tx Ring I/O buf */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">txb_p</span><span class="p">;</span>		<span class="cm">/* Phys addr of txb */</span>
	<span class="kt">int</span> <span class="n">txr_head</span><span class="p">;</span>		<span class="cm">/* Where new data goes */</span>
	<span class="kt">int</span> <span class="n">txr_tail</span><span class="p">;</span>		<span class="cm">/* Where sent data comes off */</span>
	<span class="n">spinlock_t</span> <span class="n">tx_lock</span><span class="p">;</span>	<span class="cm">/* transmit lock */</span>

	<span class="cm">/* Mirrored values of regs we can&#39;t read (if &#39;mirror_regs&#39; set) */</span>
	<span class="n">u32</span> <span class="n">MPSC_MPCR_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MPSC_CHR_1_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MPSC_CHR_2_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">MPSC_CHR_10_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">BRG_BCR_m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpsc_shared_regs</span> <span class="o">*</span><span class="n">shared_regs</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Hooks to platform-specific code */</span>
<span class="kt">int</span> <span class="n">mpsc_platform_register_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">mpsc_platform_unregister_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Hooks back in to mpsc common to be called by platform-specific code */</span>
<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">mpsc_device_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">mpsc_device_remove</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>

<span class="cm">/* Main MPSC Configuration Register Offsets */</span>
<span class="cp">#define	MPSC_MMCRL			0x0000</span>
<span class="cp">#define	MPSC_MMCRH			0x0004</span>
<span class="cp">#define	MPSC_MPCR			0x0008</span>
<span class="cp">#define	MPSC_CHR_1			0x000c</span>
<span class="cp">#define	MPSC_CHR_2			0x0010</span>
<span class="cp">#define	MPSC_CHR_3			0x0014</span>
<span class="cp">#define	MPSC_CHR_4			0x0018</span>
<span class="cp">#define	MPSC_CHR_5			0x001c</span>
<span class="cp">#define	MPSC_CHR_6			0x0020</span>
<span class="cp">#define	MPSC_CHR_7			0x0024</span>
<span class="cp">#define	MPSC_CHR_8			0x0028</span>
<span class="cp">#define	MPSC_CHR_9			0x002c</span>
<span class="cp">#define	MPSC_CHR_10			0x0030</span>
<span class="cp">#define	MPSC_CHR_11			0x0034</span>

<span class="cp">#define	MPSC_MPCR_FRZ			(1 &lt;&lt; 9)</span>
<span class="cp">#define	MPSC_MPCR_CL_5			0</span>
<span class="cp">#define	MPSC_MPCR_CL_6			1</span>
<span class="cp">#define	MPSC_MPCR_CL_7			2</span>
<span class="cp">#define	MPSC_MPCR_CL_8			3</span>
<span class="cp">#define	MPSC_MPCR_SBL_1			0</span>
<span class="cp">#define	MPSC_MPCR_SBL_2			1</span>

<span class="cp">#define	MPSC_CHR_2_TEV			(1&lt;&lt;1)</span>
<span class="cp">#define	MPSC_CHR_2_TA			(1&lt;&lt;7)</span>
<span class="cp">#define	MPSC_CHR_2_TTCS			(1&lt;&lt;9)</span>
<span class="cp">#define	MPSC_CHR_2_REV			(1&lt;&lt;17)</span>
<span class="cp">#define	MPSC_CHR_2_RA			(1&lt;&lt;23)</span>
<span class="cp">#define	MPSC_CHR_2_CRD			(1&lt;&lt;25)</span>
<span class="cp">#define	MPSC_CHR_2_EH			(1&lt;&lt;31)</span>
<span class="cp">#define	MPSC_CHR_2_PAR_ODD		0</span>
<span class="cp">#define	MPSC_CHR_2_PAR_SPACE		1</span>
<span class="cp">#define	MPSC_CHR_2_PAR_EVEN		2</span>
<span class="cp">#define	MPSC_CHR_2_PAR_MARK		3</span>

<span class="cm">/* MPSC Signal Routing */</span>
<span class="cp">#define	MPSC_MRR			0x0000</span>
<span class="cp">#define	MPSC_RCRR			0x0004</span>
<span class="cp">#define	MPSC_TCRR			0x0008</span>

<span class="cm">/* Serial DMA Controller Interface Registers */</span>
<span class="cp">#define	SDMA_SDC			0x0000</span>
<span class="cp">#define	SDMA_SDCM			0x0008</span>
<span class="cp">#define	SDMA_RX_DESC			0x0800</span>
<span class="cp">#define	SDMA_RX_BUF_PTR			0x0808</span>
<span class="cp">#define	SDMA_SCRDP			0x0810</span>
<span class="cp">#define	SDMA_TX_DESC			0x0c00</span>
<span class="cp">#define	SDMA_SCTDP			0x0c10</span>
<span class="cp">#define	SDMA_SFTDP			0x0c14</span>

<span class="cp">#define	SDMA_DESC_CMDSTAT_PE		(1&lt;&lt;0)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_CDL		(1&lt;&lt;1)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_FR		(1&lt;&lt;3)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_OR		(1&lt;&lt;6)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_BR		(1&lt;&lt;9)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_MI		(1&lt;&lt;10)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_A		(1&lt;&lt;11)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_AM		(1&lt;&lt;12)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_CT		(1&lt;&lt;13)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_C		(1&lt;&lt;14)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_ES		(1&lt;&lt;15)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_L		(1&lt;&lt;16)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_F		(1&lt;&lt;17)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_P		(1&lt;&lt;18)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_EI		(1&lt;&lt;23)</span>
<span class="cp">#define	SDMA_DESC_CMDSTAT_O		(1&lt;&lt;31)</span>

<span class="cp">#define SDMA_DESC_DFLT			(SDMA_DESC_CMDSTAT_O \</span>
<span class="cp">		| SDMA_DESC_CMDSTAT_EI)</span>

<span class="cp">#define	SDMA_SDC_RFT			(1&lt;&lt;0)</span>
<span class="cp">#define	SDMA_SDC_SFM			(1&lt;&lt;1)</span>
<span class="cp">#define	SDMA_SDC_BLMR			(1&lt;&lt;6)</span>
<span class="cp">#define	SDMA_SDC_BLMT			(1&lt;&lt;7)</span>
<span class="cp">#define	SDMA_SDC_POVR			(1&lt;&lt;8)</span>
<span class="cp">#define	SDMA_SDC_RIFB			(1&lt;&lt;9)</span>

<span class="cp">#define	SDMA_SDCM_ERD			(1&lt;&lt;7)</span>
<span class="cp">#define	SDMA_SDCM_AR			(1&lt;&lt;15)</span>
<span class="cp">#define	SDMA_SDCM_STD			(1&lt;&lt;16)</span>
<span class="cp">#define	SDMA_SDCM_TXD			(1&lt;&lt;23)</span>
<span class="cp">#define	SDMA_SDCM_AT			(1&lt;&lt;31)</span>

<span class="cp">#define	SDMA_0_CAUSE_RXBUF		(1&lt;&lt;0)</span>
<span class="cp">#define	SDMA_0_CAUSE_RXERR		(1&lt;&lt;1)</span>
<span class="cp">#define	SDMA_0_CAUSE_TXBUF		(1&lt;&lt;2)</span>
<span class="cp">#define	SDMA_0_CAUSE_TXEND		(1&lt;&lt;3)</span>
<span class="cp">#define	SDMA_1_CAUSE_RXBUF		(1&lt;&lt;8)</span>
<span class="cp">#define	SDMA_1_CAUSE_RXERR		(1&lt;&lt;9)</span>
<span class="cp">#define	SDMA_1_CAUSE_TXBUF		(1&lt;&lt;10)</span>
<span class="cp">#define	SDMA_1_CAUSE_TXEND		(1&lt;&lt;11)</span>

<span class="cp">#define	SDMA_CAUSE_RX_MASK	(SDMA_0_CAUSE_RXBUF | SDMA_0_CAUSE_RXERR \</span>
<span class="cp">		| SDMA_1_CAUSE_RXBUF | SDMA_1_CAUSE_RXERR)</span>
<span class="cp">#define	SDMA_CAUSE_TX_MASK	(SDMA_0_CAUSE_TXBUF | SDMA_0_CAUSE_TXEND \</span>
<span class="cp">		| SDMA_1_CAUSE_TXBUF | SDMA_1_CAUSE_TXEND)</span>

<span class="cm">/* SDMA Interrupt registers */</span>
<span class="cp">#define	SDMA_INTR_CAUSE			0x0000</span>
<span class="cp">#define	SDMA_INTR_MASK			0x0080</span>

<span class="cm">/* Baud Rate Generator Interface Registers */</span>
<span class="cp">#define	BRG_BCR				0x0000</span>
<span class="cp">#define	BRG_BTR				0x0004</span>

<span class="cm">/*</span>
<span class="cm"> * Define how this driver is known to the outside (we&#39;ve been assigned a</span>
<span class="cm"> * range on the &quot;Low-density serial ports&quot; major).</span>
<span class="cm"> */</span>
<span class="cp">#define MPSC_MAJOR			204</span>
<span class="cp">#define MPSC_MINOR_START		44</span>
<span class="cp">#define	MPSC_DRIVER_NAME		&quot;MPSC&quot;</span>
<span class="cp">#define	MPSC_DEV_NAME			&quot;ttyMM&quot;</span>
<span class="cp">#define	MPSC_VERSION			&quot;1.00&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="n">mpsc_ports</span><span class="p">[</span><span class="n">MPSC_NUM_CTLRS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpsc_shared_regs</span> <span class="n">mpsc_shared_regs</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">mpsc_reg</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mpsc_start_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpsc_free_ring_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpsc_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Baud Rate Generator Routines (BRG)</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_brg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">clk_src</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_can_tune</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_brg_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_brg_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To set the baud, we adjust the CDV field in the BRG_BCR reg.</span>
<span class="cm"> * From manual: Baud = clk / ((CDV+1)*2) ==&gt; CDV = (clk / (baud*2)) - 1.</span>
<span class="cm"> * However, the input clock is divided by 16 in the MPSC b/c of how</span>
<span class="cm"> * &#39;MPSC_MMCRH&#39; was set up so we have to divide the &#39;clk&#39; used in our</span>
<span class="cm"> * calculation by 16 to account for that.  So the real calculation</span>
<span class="cm"> * that accounts for the way the mpsc is set up is:</span>
<span class="cm"> * CDV = (clk / (baud*2*16)) - 1 ==&gt; CDV = (clk / (baud &lt;&lt; 5)) - 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_baudrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">cdv</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">mpsc_brg_disable</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cdv</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">+</span> <span class="n">BRG_BCR</span><span class="p">);</span>
	<span class="n">mpsc_brg_enable</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Serial DMA Routines (SDMA)</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_burstsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">burst_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_burstsize[%d]: burst_size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">burst_size</span><span class="p">);</span>

	<span class="n">burst_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Divide by 8 b/c reg values are 8-byte chunks */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst_size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* 1 64-bit word */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">burst_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 2 64-bit words */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">burst_size</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* 4 64-bit words */</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* 8 64-bit words */</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">burst_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_init[%d]: burst_size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span>
		<span class="n">burst_size</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03f</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDC</span><span class="p">);</span>
	<span class="n">mpsc_sdma_burstsize</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">burst_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mpsc_sdma_intr_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">old</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_intr_mask[%d]: mask: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">SDMA_INTR_MASK_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">sdma_intr_base</span> <span class="o">+</span> <span class="n">SDMA_INTR_MASK</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">SDMA_INTR_MASK_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">sdma_intr_base</span> <span class="o">+</span> <span class="n">SDMA_INTR_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_intr_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_intr_unmask[%d]: mask: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">SDMA_INTR_MASK_m</span>
		<span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">sdma_intr_base</span> <span class="o">+</span> <span class="n">SDMA_INTR_MASK</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">SDMA_INTR_MASK_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">sdma_intr_base</span> <span class="o">+</span> <span class="n">SDMA_INTR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_intr_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_intr_ack[%d]: Acknowledging IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">SDMA_INTR_CAUSE_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">sdma_intr_base</span> <span class="o">+</span> <span class="n">SDMA_INTR_CAUSE</span>
			<span class="o">+</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_set_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="n">rxre_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_set_rx_ring[%d]: rxre_p: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rxre_p</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">rxre_p</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SCRDP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_set_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="n">txre_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">txre_p</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SFTDP</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">txre_p</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SCTDP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDCM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDCM</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">mpsc_sdma_tx_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDCM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDMA_SDCM_TXD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="n">txre</span><span class="p">,</span> <span class="o">*</span><span class="n">txre_p</span><span class="p">;</span>

	<span class="cm">/* If tx isn&#39;t running &amp; there&#39;s a desc ready to go, start it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">*</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">));</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span> <span class="o">+</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">txre</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_O</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txre_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_p</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">*</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">));</span>

			<span class="n">mpsc_sdma_set_tx_ring</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">txre_p</span><span class="p">);</span>
			<span class="n">mpsc_sdma_cmd</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SDMA_SDCM_STD</span> <span class="o">|</span> <span class="n">SDMA_SDCM_TXD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_sdma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_stop[%d]: Stopping SDMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="cm">/* Abort any SDMA transfers */</span>
	<span class="n">mpsc_sdma_cmd</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpsc_sdma_cmd</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SDMA_SDCM_AR</span> <span class="o">|</span> <span class="n">SDMA_SDCM_AT</span><span class="p">);</span>

	<span class="cm">/* Clear the SDMA current and first TX and RX pointers */</span>
	<span class="n">mpsc_sdma_set_tx_ring</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mpsc_sdma_set_rx_ring</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">mpsc_sdma_intr_mask</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">mpsc_sdma_intr_ack</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Multi-Protocol Serial Controller Routines (MPSC)</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_hw_init[%d]: Initializing hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="cm">/* Set up clock routing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_MRR_m</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1c7</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_MRR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_MRR</span><span class="p">);</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_RCRR_m</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_RCRR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_RCRR</span><span class="p">);</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_TCRR_m</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">MPSC_TCRR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_TCRR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_MRR</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1c7</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_MRR</span><span class="p">);</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_RCRR</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_RCRR</span><span class="p">);</span>

		<span class="n">v</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_TCRR</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span><span class="o">-&gt;</span><span class="n">mpsc_routing_base</span> <span class="o">+</span> <span class="n">MPSC_TCRR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Put MPSC in UART mode &amp; enabel Tx/Rx egines */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x000004c4</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MMCRL</span><span class="p">);</span>

	<span class="cm">/* No preamble, 16x divider, low-latency, */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x04400400</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MMCRH</span><span class="p">);</span>
	<span class="n">mpsc_set_baudrate</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_baud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_1_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_max_idle</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_3</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_5</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_6</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_7</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_8</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_9</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_enter_hunt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_enter_hunt[%d]: Hunting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">|</span> <span class="n">MPSC_CHR_2_EH</span><span class="p">,</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
		<span class="cm">/* Erratum prevents reading CHR_2 so just delay for a while */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">)</span> <span class="o">|</span> <span class="n">MPSC_CHR_2_EH</span><span class="p">,</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPSC_CHR_2_EH</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_freeze[%d]: Freezing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="n">MPSC_MPCR_FRZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPSC_MPCR_FRZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_unfreeze[%d]: Unfrozen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_char_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_set_char_length[%d]: char len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_stop_bit_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_set_stop_bit_length[%d]: stop bits: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_parity</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_set_parity[%d]: parity bits: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">:</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">&amp;=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc000c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Driver Init Routines</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_init_hw[%d]: Initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">mpsc_brg_init</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_clk_src</span><span class="p">);</span>
	<span class="n">mpsc_brg_enable</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">mpsc_sdma_init</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">dma_get_cache_alignment</span><span class="p">());</span>	<span class="cm">/* burst a cacheline */</span>
	<span class="n">mpsc_sdma_stop</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">mpsc_hw_init</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_alloc_ring_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_alloc_ring_mem[%d]: Allocating ring mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_supported</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPSC: Inadequate DMA support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span> <span class="o">=</span> <span class="n">dma_alloc_noncoherent</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">MPSC_DMA_ALLOC_SIZE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region_p</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
				<span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPSC: Can&#39;t alloc Desc region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_free_ring_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_free_ring_mem[%d]: Freeing ring mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_noncoherent</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">MPSC_DMA_ALLOC_SIZE</span><span class="p">,</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region_p</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="n">rxre</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="n">txre</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dp</span><span class="p">,</span> <span class="n">dp_p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="o">*</span><span class="n">bp_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_init_rings[%d]: Initializing rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPSC_DMA_ALLOC_SIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Descriptors &amp; buffers are multiples of cacheline size and must be</span>
<span class="cm">	 * cacheline aligned.</span>
<span class="cm">	 */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">,</span> <span class="n">dma_get_cache_alignment</span><span class="p">());</span>
	<span class="n">dp_p</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region_p</span><span class="p">,</span> <span class="n">dma_get_cache_alignment</span><span class="p">());</span>

	<span class="cm">/*</span>
<span class="cm">	 * Partition dma region into rx ring descriptor, rx buffers,</span>
<span class="cm">	 * tx ring descriptors, and tx buffers.</span>
<span class="cm">	 */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_p</span> <span class="o">=</span> <span class="n">dp_p</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">+=</span> <span class="n">MPSC_RXR_SIZE</span><span class="p">;</span>
	<span class="n">dp_p</span> <span class="o">+=</span> <span class="n">MPSC_RXR_SIZE</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dp_p</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">+=</span> <span class="n">MPSC_RXB_SIZE</span><span class="p">;</span>
	<span class="n">dp_p</span> <span class="o">+=</span> <span class="n">MPSC_RXB_SIZE</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_p</span> <span class="o">=</span> <span class="n">dp_p</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">+=</span> <span class="n">MPSC_TXR_SIZE</span><span class="p">;</span>
	<span class="n">dp_p</span> <span class="o">+=</span> <span class="n">MPSC_TXR_SIZE</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dp_p</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Init rx ring descriptors */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span><span class="p">;</span>
	<span class="n">dp_p</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_p</span><span class="p">;</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb</span><span class="p">;</span>
	<span class="n">bp_p</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb_p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPSC_RXR_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="p">;</span>

		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">MPSC_RXBE_SIZE</span><span class="p">);</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bytecnt</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_O</span>
				<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_EI</span> <span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_F</span>
				<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_L</span><span class="p">);</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dp_p</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">bp_p</span><span class="p">);</span>

		<span class="n">dp</span> <span class="o">+=</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">;</span>
		<span class="n">dp_p</span> <span class="o">+=</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">+=</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">;</span>
		<span class="n">bp_p</span> <span class="o">+=</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_p</span><span class="p">);</span>	<span class="cm">/* Wrap last back to first */</span>

	<span class="cm">/* Init tx ring descriptors */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span><span class="p">;</span>
	<span class="n">dp_p</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_p</span><span class="p">;</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span><span class="p">;</span>
	<span class="n">bp_p</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb_p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPSC_TXR_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="p">;</span>

		<span class="n">txre</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dp_p</span> <span class="o">+</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">);</span>
		<span class="n">txre</span><span class="o">-&gt;</span><span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">bp_p</span><span class="p">);</span>

		<span class="n">dp</span> <span class="o">+=</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">;</span>
		<span class="n">dp_p</span> <span class="o">+=</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">+=</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">;</span>
		<span class="n">bp_p</span> <span class="o">+=</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">txre</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_p</span><span class="p">);</span>	<span class="cm">/* Wrap last back to first */</span>

	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">,</span>
			<span class="n">MPSC_DMA_ALLOC_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span>
					<span class="o">+</span> <span class="n">MPSC_DMA_ALLOC_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_uninit_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_uninit_rings[%d]: Uninitializing rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">dma_region</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_make_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_make_ready[%d]: Making cltr ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpsc_init_hw</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_alloc_ring_mem</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">mpsc_init_rings</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serial_polled</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupt Handling Routines</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="n">rxre</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cmdstat</span><span class="p">,</span> <span class="n">bytes_in</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_rx_intr[%d]: Handling Rx intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">rxre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span><span class="o">*</span><span class="n">MPSC_RXRE_SIZE</span><span class="p">));</span>

	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span>
			<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
		<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through Rx descriptors handling ones that have been completed.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rxre</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">))</span>
				<span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_O</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bytes_in</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bytecnt</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">serial_polled</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">serial_polled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Following use of tty struct directly is deprecated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">bytes_in</span><span class="p">)</span>
					<span class="o">&lt;</span> <span class="n">bytes_in</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span><span class="p">)</span>
				<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If this failed then we will throw away the bytes</span>
<span class="cm">			 * but must do so to clear interrupts.</span>
<span class="cm">			 */</span>
		<span class="p">}</span>

		<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">*</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">);</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span> <span class="o">+</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/*</span>
<span class="cm">		 * Other than for parity error, the manual provides little</span>
<span class="cm">		 * info on what data will be in a frame flagged by any of</span>
<span class="cm">		 * these errors.  For parity error, it is the last byte in</span>
<span class="cm">		 * the buffer that had the error.  As for the rest, I guess</span>
<span class="cm">		 * we&#39;ll assume there is no data in the buffer.</span>
<span class="cm">		 * If there is...it gets lost.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_BR</span>
						<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span>
						<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_BR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Break */</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cmdstat</span> <span class="o">&amp;=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_BR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_OVERRUN</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_PE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bytes_in</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">serial_polled</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">serial_polled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_BR</span>
						<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span>
						<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">)))</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">bytes_in</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>

			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">bytes_in</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">next_frame:</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bytecnt</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_O</span>
				<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_EI</span> <span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_F</span>
				<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_L</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Advance to next descriptor */</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPSC_RXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rxre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">*</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">));</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restart rx engine, if its stopped */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDCM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDMA_SDCM_ERD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mpsc_start_rx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_setup_tx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="n">txre</span><span class="p">;</span>

	<span class="n">txre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">*</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">));</span>

	<span class="n">txre</span><span class="o">-&gt;</span><span class="n">bytecnt</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">txre</span><span class="o">-&gt;</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">txre</span><span class="o">-&gt;</span><span class="n">bytecnt</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>			<span class="cm">/* ensure cmdstat is last field updated */</span>
	<span class="n">txre</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_O</span> <span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_F</span>
			<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_L</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">intr</span><span class="p">)</span> <span class="o">?</span> <span class="n">SDMA_DESC_CMDSTAT_EI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">,</span>
			<span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
		<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span> <span class="o">+</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_copy_tx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Make sure the desc ring isn&#39;t full */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span><span class="p">,</span> <span class="n">MPSC_TXR_ENTRIES</span><span class="p">)</span>
			<span class="o">&lt;</span> <span class="p">(</span><span class="n">MPSC_TXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ideally, we should use the TCS field in</span>
<span class="cm">			 * CHR_1 to put the x_char out immediately but</span>
<span class="cm">			 * errata prevents us from being able to read</span>
<span class="cm">			 * CHR_2 to know that its safe to write to</span>
<span class="cm">			 * CHR_1.  Instead, just put it in-band with</span>
<span class="cm">			 * all the other Tx data.</span>
<span class="cm">			 */</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">*</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">MPSC_TXBE_SIZE</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">));</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">CIRC_CNT_TO_END</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span>
				<span class="n">UART_XMIT_SIZE</span><span class="p">));</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">*</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
				<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* All tx data copied into ring bufs */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span> <span class="o">+</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">mpsc_setup_tx_desc</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Advance to next descriptor */</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPSC_TXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="n">txre</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">*</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">));</span>

		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span> <span class="o">+</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">txre</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDMA_DESC_CMDSTAT_O</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">txre</span><span class="o">-&gt;</span><span class="n">bytecnt</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPSC_TXR_ENTRIES</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* If no more data to tx, fall out of loop */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">==</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">txre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_tx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr</span>
					<span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">*</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">));</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span>
					<span class="n">MPSC_TXRE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
				<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span><span class="p">,</span>
						<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">txre</span> <span class="o">+</span> <span class="n">MPSC_TXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">mpsc_copy_tx_data</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">mpsc_sdma_start_tx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>	<span class="cm">/* start next desc if ready */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the driver&#39;s interrupt handler.  To avoid a race, we first clear</span>
<span class="cm"> * the interrupt, then handle any completed Rx/Tx descriptors.  When done</span>
<span class="cm"> * handling those descriptors, we restart the Rx/Tx engines if they&#39;re stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mpsc_sdma_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_intr[%d]: SDMA Interrupt Received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">mpsc_sdma_intr_ack</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpsc_rx_intr</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpsc_tx_intr</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_sdma_intr[%d]: SDMA Interrupt Handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * serial_core.c Interface routines</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="nf">mpsc_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">uint</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Have no way to set modem control lines AFAICT */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">mpsc_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mflags</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="o">?</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_10_m</span>
		<span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_10</span><span class="p">);</span>

	<span class="n">mflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">mflags</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">mflags</span> <span class="o">|=</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mflags</span> <span class="o">|</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>	<span class="cm">/* No way to tell if DSR asserted */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_stop_tx[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="n">mpsc_freeze</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="n">mpsc_unfreeze</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">mpsc_copy_tx_data</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">mpsc_sdma_start_tx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_start_tx[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_start_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_start_rx[%d]: Starting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rcv_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpsc_enter_hunt</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">mpsc_sdma_cmd</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SDMA_SDCM_ERD</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_stop_rx[%d]: Stopping...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">|</span> <span class="n">MPSC_CHR_2_RA</span><span class="p">,</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
		<span class="cm">/* Erratum prevents reading CHR_2 so just delay for a while */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">)</span> <span class="o">|</span> <span class="n">MPSC_CHR_2_RA</span><span class="p">,</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPSC_CHR_2_RA</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpsc_sdma_cmd</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">SDMA_SDCM_AR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">ulong</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">ctl</span> <span class="o">?</span> <span class="mh">0x00ff0000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_1_m</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_startup[%d]: Starting up MPSC, irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_make_ready</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup IRQ handler */</span>
		<span class="n">mpsc_sdma_intr_ack</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

		<span class="cm">/* If irq&#39;s are shared, need to set flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">==</span> <span class="n">mpsc_ports</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">mpsc_sdma_intr</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
					<span class="s">&quot;mpsc-sdma&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPSC: Can&#39;t get SDMA IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>

		<span class="n">mpsc_sdma_intr_unmask</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">mpsc_sdma_set_rx_ring</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_p</span>
					<span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">*</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_shutdown[%d]: Shutting down MPSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="n">mpsc_sdma_stop</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chr_bits</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">,</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">chr_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_CL_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">chr_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_CL_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">chr_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_CL_7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
	<span class="nl">default:</span>
		<span class="n">chr_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_CL_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">stop_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_SBL_2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">stop_bits</span> <span class="o">=</span> <span class="n">MPSC_MPCR_SBL_1</span><span class="p">;</span>

	<span class="n">par</span> <span class="o">=</span> <span class="n">MPSC_CHR_2_PAR_EVEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
			<span class="n">par</span> <span class="o">=</span> <span class="n">MPSC_CHR_2_PAR_ODD</span><span class="p">;</span>
<span class="cp">#ifdef	CMSPAR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">MPSC_CHR_2_PAR_MARK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">MPSC_CHR_2_PAR_SPACE</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">mpsc_set_char_length</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">chr_bits</span><span class="p">);</span>
	<span class="n">mpsc_set_stop_bit_length</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">);</span>
	<span class="n">mpsc_set_parity</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">mpsc_set_baudrate</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* Characters/events to read */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">SDMA_DESC_CMDSTAT_PE</span>
			<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">SDMA_DESC_CMDSTAT_BR</span><span class="p">;</span>

	<span class="cm">/* Characters/events to ignore */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">SDMA_DESC_CMDSTAT_PE</span>
			<span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_FR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">SDMA_DESC_CMDSTAT_BR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rcv_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rcv_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mpsc_start_rx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rcv_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpsc_stop_rx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rcv_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mpsc_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_type[%d]: port type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="n">MPSC_DRIVER_NAME</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">MPSC_DRIVER_NAME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Should make chip/platform specific call */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpsc_uninit_rings</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">mpsc_free_ring_mem</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_verify_port[%d]: Verifying port data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_MPSC</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">SERIAL_IO_MEM</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">)</span> <span class="cm">/* Not sure */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">iomem_base</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">hub6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
<span class="cm">/* Serial polling routines for writing and reading from the uart while</span>
<span class="cm"> * in an interrupt or debug context.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">poll_buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpsc_put_poll_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
							   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_get_poll_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="n">rxre</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cmdstat</span><span class="p">,</span> <span class="n">bytes_in</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_polled</span><span class="p">)</span>
		<span class="n">serial_polled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_rx_intr[%d]: Handling Rx intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">poll_buf</span><span class="p">[</span><span class="n">poll_ptr</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">poll_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">poll_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">poll_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span><span class="o">*</span><span class="n">MPSC_RXRE_SIZE</span><span class="p">));</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
			       <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * Loop through Rx descriptors handling ones that have</span>
<span class="cm">		 * been completed.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">poll_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		       <span class="o">!</span><span class="p">((</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rxre</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="n">SDMA_DESC_CMDSTAT_O</span><span class="p">)){</span>
			<span class="n">bytes_in</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bytecnt</span><span class="p">);</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxb</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">*</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">);</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bp</span><span class="p">,</span>
				       <span class="n">MPSC_RXBE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
				<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span> <span class="o">+</span> <span class="n">MPSC_RXBE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_BR</span> <span class="o">|</span>
			 <span class="n">SDMA_DESC_CMDSTAT_FR</span> <span class="o">|</span> <span class="n">SDMA_DESC_CMDSTAT_OR</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">poll_buf</span><span class="p">[</span><span class="n">poll_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
				<span class="n">poll_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes_in</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">poll_buf</span><span class="p">[</span><span class="n">poll_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">;</span>
					<span class="n">poll_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">bytes_in</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">bytecnt</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">rxre</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SDMA_DESC_CMDSTAT_O</span> <span class="o">|</span>
						    <span class="n">SDMA_DESC_CMDSTAT_EI</span> <span class="o">|</span>
						    <span class="n">SDMA_DESC_CMDSTAT_F</span> <span class="o">|</span>
						    <span class="n">SDMA_DESC_CMDSTAT_L</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
				       <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
				<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="cm">/* Advance to next descriptor */</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">MPSC_RXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rxre</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_rx_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">rxr_posn</span> <span class="o">*</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">));</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
				       <span class="n">MPSC_RXRE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
				<span class="n">invalidate_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span><span class="p">,</span>
						<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">rxre</span> <span class="o">+</span> <span class="n">MPSC_RXRE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="cm">/* Restart rx engine, if its stopped */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">+</span> <span class="n">SDMA_SDCM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDMA_SDCM_ERD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mpsc_start_rx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poll_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">poll_buf</span><span class="p">[</span><span class="n">poll_ptr</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_put_poll_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_MPCR</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_1</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">MPSC_CHR_2_TTCS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">+</span> <span class="n">MPSC_CHR_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPSC_CHR_2_TTCS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">mpsc_pops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">mpsc_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">mpsc_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">mpsc_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">mpsc_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">mpsc_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">mpsc_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">mpsc_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">mpsc_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">mpsc_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mpsc_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">mpsc_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">mpsc_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">mpsc_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">mpsc_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">mpsc_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">mpsc_verify_port</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
	<span class="p">.</span><span class="n">poll_get_char</span> <span class="o">=</span> <span class="n">mpsc_get_poll_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_put_char</span> <span class="o">=</span> <span class="n">mpsc_put_poll_char</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Console Interface Routines</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_SERIAL_MPSC_CONSOLE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">uint</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="n">add_cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">!=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">mpsc_sdma_intr_ack</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
		<span class="n">mpsc_tx_intr</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">txb</span> <span class="o">+</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">*</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">add_cr</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
				<span class="n">add_cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* add &#39;\r&#39; after &#39;\n&#39; */</span>
					<span class="n">add_cr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">,</span>
				<span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PPC32) &amp;&amp; !defined(CONFIG_NOT_COHERENT_CACHE)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">)</span> <span class="cm">/* GT642[46]0 Res #COMM-2 */</span>
			<span class="n">flush_dcache_range</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bp</span> <span class="o">+</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">mpsc_setup_tx_desc</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPSC_TXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mpsc_sdma_start_tx</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">mpsc_sdma_tx_active</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">txr_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPSC_TXR_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpsc_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">flow</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_console_setup[%d]: options: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MPSC_NUM_CTLRS</span><span class="p">)</span>
		<span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_baud</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_bits</span><span class="p">;</span>
	<span class="n">parity</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_parity</span><span class="p">;</span>
	<span class="n">flow</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_flow</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>	<span class="cm">/* Temporary fix--copied from 8250.c */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">mpsc_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MPSC_DEV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">mpsc_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>	<span class="o">=</span> <span class="n">mpsc_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpsc_late_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_late_console_init: Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpsc_console</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_ENABLED</span><span class="p">))</span>
		<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">mpsc_late_console_init</span><span class="p">);</span>

<span class="cp">#define MPSC_CONSOLE	&amp;mpsc_console</span>
<span class="cp">#else</span>
<span class="cp">#define MPSC_CONSOLE	NULL</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Dummy Platform Driver to extract &amp; map shared register regions</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_resource_err</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MPSC: Platform device resource error in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_shared_map_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
					<span class="n">MPSC_ROUTING_BASE_ORDER</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">MPSC_ROUTING_REG_BLOCK_SIZE</span><span class="p">,</span>
				<span class="s">&quot;mpsc_routing_regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">MPSC_ROUTING_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base_p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpsc_resource_err</span><span class="p">(</span><span class="s">&quot;MPSC routing base&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
					<span class="n">MPSC_SDMA_INTR_BASE_ORDER</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">MPSC_SDMA_INTR_REG_BLOCK_SIZE</span><span class="p">,</span>
				<span class="s">&quot;sdma_intr_regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">MPSC_SDMA_INTR_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base_p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base_p</span><span class="p">,</span>
				<span class="n">MPSC_ROUTING_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">mpsc_resource_err</span><span class="p">(</span><span class="s">&quot;SDMA intr base&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_shared_unmap_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base_p</span><span class="p">,</span>
				<span class="n">MPSC_ROUTING_REG_BLOCK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base_p</span><span class="p">,</span>
				<span class="n">MPSC_SDMA_INTR_REG_BLOCK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">mpsc_routing_base_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">sdma_intr_base_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_shared_drv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_shared_pdata</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_shared_map_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_shared_pdata</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

			<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_MRR_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mrr_val</span><span class="p">;</span>
			<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_RCRR_m</span><span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rcrr_val</span><span class="p">;</span>
			<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_TCRR_m</span><span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">tcrr_val</span><span class="p">;</span>
			<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">SDMA_INTR_CAUSE_m</span> <span class="o">=</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">intr_cause_val</span><span class="p">;</span>
			<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">SDMA_INTR_MASK_m</span> <span class="o">=</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">intr_mask_val</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_shared_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpsc_shared_unmap_regs</span><span class="p">();</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_MRR_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_RCRR_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">MPSC_TCRR_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">SDMA_INTR_CAUSE_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mpsc_shared_regs</span><span class="p">.</span><span class="n">SDMA_INTR_MASK_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpsc_shared_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">mpsc_shared_drv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">mpsc_shared_drv_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MPSC_SHARED_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Driver Interface Routines</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">mpsc_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="n">MPSC_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>	<span class="o">=</span> <span class="n">MPSC_DEV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">MPSC_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="n">MPSC_MINOR_START</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">MPSC_NUM_CTLRS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span>		<span class="o">=</span> <span class="n">MPSC_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_drv_map_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="n">MPSC_BASE_ORDER</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">MPSC_REG_BLOCK_SIZE</span><span class="p">,</span>
			<span class="s">&quot;mpsc_regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">MPSC_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base_p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpsc_resource_err</span><span class="p">(</span><span class="s">&quot;MPSC base&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
					<span class="n">MPSC_SDMA_BASE_ORDER</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">MPSC_SDMA_REG_BLOCK_SIZE</span><span class="p">,</span> <span class="s">&quot;sdma_regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span><span class="n">MPSC_SDMA_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base_p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpsc_resource_err</span><span class="p">(</span><span class="s">&quot;SDMA base&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">IORESOURCE_MEM</span><span class="p">,</span><span class="n">MPSC_BRG_BASE_ORDER</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">MPSC_BRG_REG_BLOCK_SIZE</span><span class="p">,</span> <span class="s">&quot;brg_regs&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">MPSC_BRG_REG_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base_p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mpsc_resource_err</span><span class="p">(</span><span class="s">&quot;BRG base&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_drv_unmap_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base_p</span><span class="p">,</span> <span class="n">MPSC_REG_BLOCK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base_p</span><span class="p">,</span> <span class="n">MPSC_SDMA_REG_BLOCK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base_p</span><span class="p">,</span> <span class="n">MPSC_BRG_REG_BLOCK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">sdma_base_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_base_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpsc_drv_get_platform_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_pdata</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpsc_pdata</span> <span class="o">*</span><span class="p">)</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">brg_clk_freq</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_MPSC</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="n">MPSC_TXBE_SIZE</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_base</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_pops</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mirror_regs</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mirror_regs</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cache_mgmt</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_can_tune</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">brg_can_tune</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">brg_clk_src</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">brg_clk_src</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">mpsc_max_idle</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_idle</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_baud</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">default_baud</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_bits</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">default_bits</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_parity</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">default_parity</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">default_flow</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">default_flow</span><span class="p">;</span>

	<span class="cm">/* Initial values of mirrored regs */</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_1_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chr_1_val</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_2_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chr_2_val</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_CHR_10_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chr_10_val</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">MPSC_MPCR_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mpcr_val</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">BRG_BCR_m</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bcr_val</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">shared_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_shared_regs</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_drv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpsc_port_info</span>	<span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_drv_probe: Adding MPSC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">MPSC_NUM_CTLRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_drv_map_regs</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mpsc_drv_get_platform_data</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpsc_make_ready</span><span class="p">(</span><span class="n">pi</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mpsc_release_port</span><span class="p">((</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">)</span>
							<span class="n">pi</span><span class="p">);</span>
					<span class="n">mpsc_drv_unmap_regs</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mpsc_drv_unmap_regs</span><span class="p">(</span><span class="n">pi</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpsc_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mpsc_drv_exit: Removing MPSC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">MPSC_NUM_CTLRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
		<span class="n">mpsc_release_port</span><span class="p">((</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
		<span class="n">mpsc_drv_unmap_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_ports</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpsc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">mpsc_drv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">mpsc_drv_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">MPSC_CTLR_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mpsc_drv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Serial: MPSC driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpsc_ports</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpsc_ports</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_shared_regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_shared_driver</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_driver</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_shared_driver</span><span class="p">);</span>
				<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mpsc_drv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_shared_driver</span><span class="p">);</span>
	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_reg</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpsc_ports</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpsc_ports</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpsc_shared_regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpsc_shared_regs</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mpsc_drv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mpsc_drv_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mark A. Greer &lt;mgreer@mvista.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic Marvell MPSC serial/UART driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MPSC_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">MPSC_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MPSC_CTLR_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
