<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › jsm › jsm_tty.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>jsm_tty.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/************************************************************************</span>
<span class="cm"> * Copyright 2003 Digi International (www.digi.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 IBM Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY, EXPRESS OR IMPLIED; without even the</span>
<span class="cm"> * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<span class="cm"> * PURPOSE.  See the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 * Temple Place - Suite 330, Boston,</span>
<span class="cm"> * MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * Scott H Kilau &lt;Scott_Kilau@digi.com&gt;</span>
<span class="cm"> * Ananda Venkatarman &lt;mansarov@us.ibm.com&gt;</span>
<span class="cm"> * Modifications:</span>
<span class="cm"> * 01/19/06:	changed jsm_input routine to use the dynamically allocated</span>
<span class="cm"> *		tty_buffer changes. Contributors: Scott Kilau and Ananda V.</span>
<span class="cm"> ***********************************************************************/</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* For udelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;jsm.h&quot;</span>

<span class="k">static</span> <span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">linemap</span><span class="p">,</span> <span class="n">MAXLINES</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">jsm_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">jsm_get_mstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mstat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mstat</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">|</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_mistat</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MCR_DTR</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">TIOCM_CD</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">jsm_tty_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return modem signals to ld.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">jsm_tty_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">jsm_get_mstat</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * jsm_set_modem_info()</span>
<span class="cm"> *</span>
<span class="cm"> * Set modem signals, called by ld.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">assert_modem_signals</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * jsm_tty_write()</span>
<span class="cm"> *</span>
<span class="cm"> * Take data from the user or kernel and send it out to the FEP.</span>
<span class="cm"> * In here exists all the Transparent Print magic as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">jsm_channel</span><span class="p">,</span> <span class="n">uart_port</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">copy_data_from_queue_to_uart</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CH_STOP</span><span class="p">);</span>
	<span class="n">jsm_tty_write</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CH_STOP</span><span class="p">);</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">termios</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">])</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">send_start_character</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">])</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">send_stop_character</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">disable_receiver</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing needed */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">send_break</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">clear_break</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsm_tty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">;</span>

	<span class="cm">/* Get board pointer from our array of majors we have allocated */</span>
	<span class="n">brd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate channel buffers for read/write/error.</span>
<span class="cm">	 * Set flag, so we don&#39;t get trounced on.</span>
<span class="cm">	 */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CH_OPENING</span><span class="p">);</span>

	<span class="cm">/* Drop locks, as malloc with GFP_KERNEL can sleep */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">RQUEUESIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate read queue buf&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_equeue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_equeue</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">EQUEUESIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_equeue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate error queue buf&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CH_OPENING</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize if neither terminal is open.</span>
<span class="cm">	 */</span>
	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">OPEN</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="s">&quot;jsm_open: initializing channel in open...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flush input queues.</span>
<span class="cm">	 */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_r_head</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_r_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_e_head</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_e_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">flush_uart_write</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">flush_uart_read</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_cached_lsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">termios</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_iflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_oflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_lflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_startc</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">];</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_stopc</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">];</span>

	<span class="cm">/* Tell UART to init itself */</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">uart_init</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run param in case we changed anything</span>
<span class="cm">	 */</span>
	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">jsm_carrier</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_open_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">OPEN</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CLOSE</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CH_STOPI</span><span class="p">);</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_open_count</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have HUPCL set, lower DTR and RTS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CLOSE</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;Close. HUPCL set, dropping DTR/RTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Drop RTS/DTR */</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_mostat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">);</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">assert_modem_signals</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Turn off UART interrupts for this port */</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">uart_off</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CLOSE</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_iflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_oflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_c_lflag</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">;</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_startc</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">];</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_stopc</span>	<span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">];</span>

	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">jsm_carrier</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">jsm_tty_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;jsm&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_tty_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsm_tty_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_JSM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">jsm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">jsm_tty_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">jsm_tty_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">jsm_tty_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">jsm_tty_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">jsm_tty_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span>	<span class="o">=</span> <span class="n">jsm_tty_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">jsm_tty_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">jsm_tty_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">jsm_tty_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">jsm_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">jsm_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">jsm_tty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">jsm_tty_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">jsm_tty_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">jsm_tty_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">jsm_config_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * jsm_tty_init()</span>
<span class="cm"> *</span>
<span class="cm"> * Init the tty subsystem.  Called once per board after board has been</span>
<span class="cm"> * downloaded and init&#39;ed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">jsm_tty_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize board structure elements.</span>
<span class="cm">	 */</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">maxports</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate channel memory that might not have been allocated</span>
<span class="cm">	 * when the driver was first loaded.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Okay to malloc with GFP_KERNEL, we are not at</span>
<span class="cm">			 * interrupt context, and there are no locks held.</span>
<span class="cm">			 */</span>
			<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CORE</span><span class="p">,</span> <span class="n">ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="s">&quot;%s:%d Unable to allocate memory for channel struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">re_map_membase</span><span class="p">;</span>

	<span class="cm">/* Set up channel variables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_uart_offset</span> <span class="o">==</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_neo_uart</span> <span class="o">=</span>  <span class="n">vaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">bd_uart_offset</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span> <span class="o">=</span> <span class="n">brd</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_portnum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* .25 second delay */</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_close_delay</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jsm_uart_port_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize board structure elements.</span>
<span class="cm">	 */</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">maxports</span><span class="p">;</span>

	<span class="cm">/* Set up channel variables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="mi">14745600</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_JSM</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">re_map_membase</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jsm_ops</span><span class="p">;</span>
		<span class="n">line</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">linemap</span><span class="p">,</span> <span class="n">MAXLINES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">MAXLINES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;jsm: linemap is full, added device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linemap</span><span class="p">);</span>
		<span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">uart_add_one_port</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">jsm_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;jsm: Port %d failed. Aborting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;jsm: Port %d added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jsm_remove_uart_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">brd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize board structure elements.</span>
<span class="cm">	 */</span>

	<span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">maxports</span><span class="p">;</span>

	<span class="cm">/* Set up channel variables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">nasync</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">linemap</span><span class="p">);</span>
		<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsm_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">jsm_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">uart_port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *Figure the number of characters in the buffer.</span>
<span class="cm">	 *Exit immediately if none.</span>
<span class="cm">	 */</span>

	<span class="n">rmask</span> <span class="o">=</span> <span class="n">RQUEUEMASK</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_head</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_tail</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">;</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *If the device is not open, or CREAD is off, flush</span>
<span class="cm">	 *input data and return immediately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;input. dropping %d bytes on port %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_portnum</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_head</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>

		<span class="cm">/* Force queue flow control to be released, if needed */</span>
		<span class="n">jsm_check_queue_flow_control</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are throttled, simply don&#39;t read any data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_STOPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;Port %d throttled, not reading any data. head: %x tail: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_portnum</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;jsm_input 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * n now contains the most amount of data we can copy,</span>
<span class="cm">	 * bounded either by the flip buffer size or the amount</span>
<span class="cm">	 * of data the card actually has pending...</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">tail</span><span class="p">)</span> <span class="o">?</span> <span class="n">head</span> <span class="o">:</span> <span class="n">RQUEUESIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">tail</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If conditions are such that ld needs to see all</span>
<span class="cm">			 * UART errors, we will have to walk each character</span>
<span class="cm">			 * and error byte and send them to the buffer one at</span>
<span class="cm">			 * a time.</span>
<span class="cm">			 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_INPCK</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Give the Linux ld the flags in the</span>
<span class="cm">				 * format it likes.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_equeue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">),</span>  <span class="n">TTY_BREAK</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_equeue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">),</span> <span class="n">TTY_PARITY</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_equeue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">),</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">+</span><span class="n">tail</span> <span class="o">+</span><span class="n">i</span><span class="p">),</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_rqueue</span> <span class="o">+</span> <span class="n">tail</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tail</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">s</span><span class="p">;</span>
		<span class="cm">/* Flip queue if needed */</span>
		<span class="n">tail</span> <span class="o">&amp;=</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_tail</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_e_tail</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">&amp;</span> <span class="n">rmask</span><span class="p">;</span>
	<span class="n">jsm_check_queue_flow_control</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/* Tell the tty layer its okay to &quot;eat&quot; the data now */</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">IOCTL</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsm_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsm_board</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">virt_carrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phys_carrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CARR</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_mistat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CARR</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;mistat: %x D_CD: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_mistat</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_mistat</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">);</span>
		<span class="n">phys_carrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">virt_carrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CARR</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="s">&quot;DCD: physical: %d virt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phys_carrier</span><span class="p">,</span> <span class="n">virt_carrier</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test for a VIRTUAL carrier transition to HIGH.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_FCAR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">virt_carrier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * When carrier rises, wake any threads waiting</span>
<span class="cm">		 * for carrier in the open routine.</span>
<span class="cm">		 */</span>

		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CARR</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;carrier: virt DCD rose</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">)))</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test for a PHYSICAL carrier transition to HIGH.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_CD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phys_carrier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * When carrier rises, wake any threads waiting</span>
<span class="cm">		 * for carrier in the open routine.</span>
<span class="cm">		 */</span>

		<span class="n">jsm_printk</span><span class="p">(</span><span class="n">CARR</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="s">&quot;carrier: physical DCD rose</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">)))</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Test for a PHYSICAL transition to low, so long as we aren&#39;t</span>
<span class="cm">	 *  currently ignoring physical transitions (which is what &quot;virtual</span>
<span class="cm">	 *  carrier&quot; indicates).</span>
<span class="cm">	 *</span>
<span class="cm">	 *  The transition of the virtual carrier to low really doesn&#39;t</span>
<span class="cm">	 *  matter... it really only means &quot;ignore carrier state&quot;, not</span>
<span class="cm">	 *  &quot;make pretend that carrier is there&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">virt_carrier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_CD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phys_carrier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	When carrier drops:</span>
<span class="cm">		 *</span>
<span class="cm">		 *	Drop carrier on all open units.</span>
<span class="cm">		 *</span>
<span class="cm">		 *	Flush queues, waking up any task waiting in the</span>
<span class="cm">		 *	line discipline.</span>
<span class="cm">		 *</span>
<span class="cm">		 *	Send a hangup to the control terminal.</span>
<span class="cm">		 *</span>
<span class="cm">		 *	Enable all select calls.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">)))</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Make sure that our cached values reflect the current reality.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virt_carrier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">|=</span> <span class="n">CH_FCAR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CH_FCAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phys_carrier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">|=</span> <span class="n">CH_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CH_CD</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">jsm_check_queue_flow_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">jsm_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">board_ops</span> <span class="o">*</span><span class="n">bd_ops</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">bd_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qleft</span><span class="p">;</span>

	<span class="cm">/* Store how much space we have left in the queue */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qleft</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_tail</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_r_head</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">qleft</span> <span class="o">+=</span> <span class="n">RQUEUEMASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if we should enforce flow control on our queue because</span>
<span class="cm">	 * the ld (or user) isn&#39;t reading data out of our queue fast enuf.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: This is done based on what the current flow control of the</span>
<span class="cm">	 * port is set for.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1) HWFLOW (RTS) - Turn off the UART&#39;s Receive interrupt.</span>
<span class="cm">	 *	This will cause the UART&#39;s FIFO to back up, and force</span>
<span class="cm">	 *	the RTS signal to be dropped.</span>
<span class="cm">	 * 2) SWFLOW (IXOFF) - Keep trying to send a stop character to</span>
<span class="cm">	 *	the other side, in hopes it will stop sending data to us.</span>
<span class="cm">	 * 3) NONE - Nothing we can do.  We will simply drop any extra data</span>
<span class="cm">	 *	that gets sent into us when the queue fills up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qleft</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HWFLOW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_RECEIVER_OFF</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">disable_receiver</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CH_RECEIVER_OFF</span><span class="p">);</span>
				<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="s">&quot;Internal queue hit hilevel mark (%d)! Turning off interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">qleft</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* SWFLOW */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_c_iflag</span> <span class="o">&amp;</span> <span class="n">IXOFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span> <span class="o">&lt;=</span> <span class="n">MAX_STOPS_SENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">send_stop_character</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span><span class="o">++</span><span class="p">;</span>
				<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="s">&quot;Sending stop char! Times sent: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if we should unenforce flow control because</span>
<span class="cm">	 * ld (or user) finally read enuf data out of our queue.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: This is done based on what the current flow control of the</span>
<span class="cm">	 * port is set for.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1) HWFLOW (RTS) - Turn back on the UART&#39;s Receive interrupt.</span>
<span class="cm">	 *	This will cause the UART&#39;s FIFO to raise RTS back up,</span>
<span class="cm">	 *	which will allow the other side to start sending data again.</span>
<span class="cm">	 * 2) SWFLOW (IXOFF) - Send a start character to</span>
<span class="cm">	 *	the other side, so it will start sending data to us again.</span>
<span class="cm">	 * 3) NONE - Do nothing. Since we didn&#39;t do anything to turn off the</span>
<span class="cm">	 *	other side, we don&#39;t need to do anything now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qleft</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RQUEUESIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* HWFLOW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">CH_RECEIVER_OFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">enable_receiver</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CH_RECEIVER_OFF</span><span class="p">);</span>
				<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="s">&quot;Internal queue hit lowlevel mark (%d)! Turning on interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">qleft</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* SWFLOW */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_c_iflag</span> <span class="o">&amp;</span> <span class="n">IXOFF</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_stops_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bd_ops</span><span class="o">-&gt;</span><span class="n">send_start_character</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">jsm_printk</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">ch_bd</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="s">&quot;Sending start char!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
