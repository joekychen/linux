<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › sb1250-duart.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sb1250-duart.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Support for the asynchronous serial interface (DUART) included</span>
<span class="cm"> *	in the BCM1250 and derived System-On-a-Chip (SOC) devices.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2007  Maciej W. Rozycki</span>
<span class="cm"> *</span>
<span class="cm"> *	Derived from drivers/char/sb1250_duart.c for which the following</span>
<span class="cm"> *	copyright applies:</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000, 2001, 2002, 2003, 2004  Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	References:</span>
<span class="cm"> *</span>
<span class="cm"> *	&quot;BCM1250/BCM1125/BCM1125H User Manual&quot;, Broadcom Corporation</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_SERIAL_SB1250_DUART_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/war.h&gt;</span>

<span class="cp">#include &lt;asm/sibyte/sb1250.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_uart.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/swarm.h&gt;</span>


<span class="cp">#if defined(CONFIG_SIBYTE_BCM1x55) || defined(CONFIG_SIBYTE_BCM1x80)</span>
<span class="cp">#include &lt;asm/sibyte/bcm1480_regs.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/bcm1480_int.h&gt;</span>

<span class="cp">#define SBD_CHANREGS(line)	A_BCM1480_DUART_CHANREG((line), 0)</span>
<span class="cp">#define SBD_CTRLREGS(line)	A_BCM1480_DUART_CTRLREG((line), 0)</span>
<span class="cp">#define SBD_INT(line)		(K_BCM1480_INT_UART_0 + (line))</span>

<span class="cp">#define DUART_CHANREG_SPACING	BCM1480_DUART_CHANREG_SPACING</span>

<span class="cp">#define R_DUART_IMRREG(line)	R_BCM1480_DUART_IMRREG(line)</span>
<span class="cp">#define R_DUART_INCHREG(line)	R_BCM1480_DUART_INCHREG(line)</span>
<span class="cp">#define R_DUART_ISRREG(line)	R_BCM1480_DUART_ISRREG(line)</span>

<span class="cp">#elif defined(CONFIG_SIBYTE_SB1250) || defined(CONFIG_SIBYTE_BCM112X)</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_regs.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_int.h&gt;</span>

<span class="cp">#define SBD_CHANREGS(line)	A_DUART_CHANREG((line), 0)</span>
<span class="cp">#define SBD_CTRLREGS(line)	A_DUART_CTRLREG(0)</span>
<span class="cp">#define SBD_INT(line)		(K_INT_UART_0 + (line))</span>

<span class="cp">#else</span>
<span class="cp">#error invalid SB1250 UART configuration</span>

<span class="cp">#endif</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maciej W. Rozycki &lt;macro@linux-mips.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;BCM1xxx on-chip DUART serial driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cp">#define DUART_MAX_CHIP 2</span>
<span class="cp">#define DUART_MAX_SIDE 2</span>

<span class="cm">/*</span>
<span class="cm"> * Per-port state.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sbd_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_duart</span>	<span class="o">*</span><span class="n">duart</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span>	<span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">memctrl</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tx_stopped</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">initialised</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Per-DUART state for the shared register space.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span>		<span class="n">sport</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mapctrl</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">map_guard</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_sport(uport) container_of(uport, struct sbd_port, port)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sbd_duart</span> <span class="n">sbd_duarts</span><span class="p">[</span><span class="n">DUART_MAX_CHIP</span><span class="p">];</span>


<span class="cm">/*</span>
<span class="cm"> * Reading and writing SB1250 DUART registers.</span>
<span class="cm"> *</span>
<span class="cm"> * There are three register spaces: two per-channel ones and</span>
<span class="cm"> * a shared one.  We have to define accessors appropriately.</span>
<span class="cm"> * All registers are 64-bit and all but the Baud Rate Clock</span>
<span class="cm"> * registers only define 8 least significant bits.  There is</span>
<span class="cm"> * also a workaround to take into account.  Raw accessors use</span>
<span class="cm"> * the full register width, but cooked ones truncate it</span>
<span class="cm"> * intentionally so that the rest of the driver does not care.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">__read_sbdchn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">csr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">__read_sbdshr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">csr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__write_sbdchn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">__raw_writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__write_sbdshr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">__raw_writeq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In bug 1956, we get glitches that can mess up uart registers.  This</span>
<span class="cm"> * &quot;read-mode-reg after any register access&quot; is an accepted workaround.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__war_sbd1956</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">);</span>
	<span class="n">__read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read_sbdchn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SIBYTE_1956_WAR</span><span class="p">)</span>
		<span class="n">__war_sbd1956</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">read_sbdshr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SIBYTE_1956_WAR</span><span class="p">)</span>
		<span class="n">__war_sbd1956</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_sbdchn</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SIBYTE_1956_WAR</span><span class="p">)</span>
		<span class="n">__war_sbd1956</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_sbdshr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SIBYTE_1956_WAR</span><span class="p">)</span>
		<span class="n">__war_sbd1956</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_receive_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_DUART_RX_RDY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_receive_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sbd_receive_ready</span><span class="p">(</span><span class="n">sport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span>
		<span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_RX_HOLD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span> <span class="nf">sbd_transmit_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_DUART_TX_RDY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span> <span class="nf">sbd_transmit_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">sbd_transmit_ready</span><span class="p">(</span><span class="n">sport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_transmit_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">M_DUART_TX_EMT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_line_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">sbd_transmit_empty</span><span class="p">(</span><span class="n">sport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loops</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">loops</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sbd_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sbd_transmit_empty</span><span class="p">(</span><span class="n">sport</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sbd_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IN_PORT</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mctrl</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_IN_PIN0_VAL</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_IN_PIN4_VAL</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_RIN0_PIN</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_IN_PIN2_VAL</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">M_DUART_SET_OPR2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clr</span> <span class="o">|=</span> <span class="n">M_DUART_CLR_OPR2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">M_DUART_SET_OPR0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clr</span> <span class="o">|=</span> <span class="n">M_DUART_CLR_OPR0</span><span class="p">;</span>
	<span class="n">clr</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">mode2</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">);</span>
	<span class="n">mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DUART_CHAN_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">V_DUART_CHAN_MODE_LCL_LOOP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">V_DUART_CHAN_MODE_NORMAL</span><span class="p">;</span>

	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CLEAR_OPR</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_SET_OPR</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">,</span> <span class="n">mode2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_DIS</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Enable tx interrupts.  */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="n">M_DUART_IMR_TX</span><span class="p">;</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Go!, go!, go!...  */</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_EN</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_AUXCTL_X</span><span class="p">,</span>
		     <span class="n">M_DUART_CIN_CHNG_ENA</span> <span class="o">|</span> <span class="n">M_DUART_CTS_CHNG_ENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">V_DUART_MISC_CMD_START_BREAK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">V_DUART_MISC_CMD_STOP_BREAK</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_icount</span> <span class="o">*</span><span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_RX_RDY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_RX_HOLD</span><span class="p">);</span>

		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

		<span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">M_DUART_RCVD_BRK</span> <span class="o">|</span> <span class="n">M_DUART_FRM_ERR</span> <span class="o">|</span>
			      <span class="n">M_DUART_PARITY_ERR</span> <span class="o">|</span> <span class="n">M_DUART_OVRUN_ERR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_RCVD_BRK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="n">uport</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_FRM_ERR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_PARITY_ERR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_OVRUN_ERR</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_RCVD_BRK</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_FRM_ERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_DUART_PARITY_ERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">uart_insert_char</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">M_DUART_OVRUN_ERR</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop_tx</span><span class="p">;</span>

	<span class="cm">/* XON/XOFF chars.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_TX_HOLD</span><span class="p">,</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If nothing to do or stopped or hardware stopped.  */</span>
	<span class="n">stop_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>

	<span class="cm">/* Send char.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_TX_HOLD</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
			<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Are we are done?  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_tx</span> <span class="o">||</span> <span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Disable tx interrupts.  */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DUART_IMR_TX</span><span class="p">;</span>
		<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_status_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_INCHREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">delta</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M_DUART_IN_PIN0_VAL</span> <span class="o">&lt;&lt;</span> <span class="n">S_DUART_IN_PIN_CHNG</span><span class="p">))</span>
		<span class="n">uart_handle_cts_change</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="n">M_DUART_IN_PIN0_VAL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M_DUART_IN_PIN2_VAL</span> <span class="o">&lt;&lt;</span> <span class="n">S_DUART_IN_PIN_CHNG</span><span class="p">))</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">M_DUART_IN_PIN2_VAL</span> <span class="o">|</span> <span class="n">M_DUART_IN_PIN0_VAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">S_DUART_IN_PIN_CHNG</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sbd_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intstat</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span>
				      <span class="n">R_DUART_ISRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">intstat</span> <span class="o">&amp;=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span>
				       <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">intstat</span> <span class="o">&amp;=</span> <span class="n">M_DUART_ISR_ALL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intstat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">M_DUART_ISR_RX</span><span class="p">)</span>
			<span class="n">sbd_receive_chars</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">M_DUART_ISR_IN</span><span class="p">)</span>
			<span class="n">sbd_status_handle</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">M_DUART_ISR_TX</span><span class="p">)</span>
			<span class="n">sbd_transmit_chars</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">sbd_interrupt</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;sb1250-duart&quot;</span><span class="p">,</span> <span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Clear the receive FIFO.  */</span>
	<span class="n">sbd_receive_drain</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>

	<span class="cm">/* Clear the interrupt registers.  */</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">V_DUART_MISC_CMD_RESET_BREAK_INT</span><span class="p">);</span>
	<span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_INCHREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* Set rx/tx interrupt to FIFO available.  */</span>
	<span class="n">mode1</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">);</span>
	<span class="n">mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">M_DUART_RX_IRQ_SEL_RXFULL</span> <span class="o">|</span> <span class="n">M_DUART_TX_IRQ_SEL_TXEMPT</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">,</span> <span class="n">mode1</span><span class="p">);</span>

	<span class="cm">/* Disable tx, enable rx.  */</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_DIS</span> <span class="o">|</span> <span class="n">M_DUART_RX_EN</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable interrupts.  */</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span>
		     <span class="n">M_DUART_IMR_IN</span> <span class="o">|</span> <span class="n">M_DUART_IMR_RX</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_DIS</span> <span class="o">|</span> <span class="n">M_DUART_RX_DIS</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">sport</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">initialised</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* There is no DUART reset feature, so just set some sane defaults.  */</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">V_DUART_MISC_CMD_RESET_TX</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">V_DUART_MISC_CMD_RESET_RX</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">,</span> <span class="n">V_DUART_BITS_PER_CHAR_8</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_FULL_CTL</span><span class="p">,</span>
		     <span class="n">V_DUART_INT_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_DUART_SIG_FULL</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_OPCR_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_AUXCTL_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">initialised</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode1mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode2mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldmode1</span><span class="p">,</span> <span class="n">oldmode2</span><span class="p">,</span> <span class="n">oldaux</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">brg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">;</span>

	<span class="n">mode1mask</span> <span class="o">|=</span> <span class="o">~</span><span class="p">(</span><span class="n">M_DUART_PARITY_MODE</span> <span class="o">|</span> <span class="n">M_DUART_PARITY_TYPE_ODD</span> <span class="o">|</span>
		       <span class="n">M_DUART_BITS_PER_CHAR</span><span class="p">);</span>
	<span class="n">mode2mask</span> <span class="o">|=</span> <span class="o">~</span><span class="n">M_DUART_STOP_BIT_LEN_2</span><span class="p">;</span>
	<span class="n">auxmask</span> <span class="o">|=</span> <span class="o">~</span><span class="n">M_DUART_CTS_CHNG_ENA</span><span class="p">;</span>

	<span class="cm">/* Byte size.  */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="cm">/* Unsupported, leave unchanged.  */</span>
		<span class="n">mode1mask</span> <span class="o">|=</span> <span class="n">M_DUART_PARITY_MODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">V_DUART_BITS_PER_CHAR_7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
	<span class="nl">default:</span>
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">V_DUART_BITS_PER_CHAR_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parity and stop bits.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">M_DUART_STOP_BIT_LEN_2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode2</span> <span class="o">|=</span> <span class="n">M_DUART_STOP_BIT_LEN_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">V_DUART_PARITY_MODE_ADD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">V_DUART_PARITY_MODE_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">M_DUART_PARITY_TYPE_ODD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode1</span> <span class="o">|=</span> <span class="n">M_DUART_PARITY_TYPE_EVEN</span><span class="p">;</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">);</span>
	<span class="n">brg</span> <span class="o">=</span> <span class="n">V_DUART_BAUD_RATE</span><span class="p">(</span><span class="n">baud</span><span class="p">);</span>
	<span class="cm">/* The actual lower bound is 1221bps, so compensate.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brg</span> <span class="o">&gt;</span> <span class="n">M_DUART_CLK_COUNTER</span><span class="p">)</span>
		<span class="n">brg</span> <span class="o">=</span> <span class="n">M_DUART_CLK_COUNTER</span><span class="p">;</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">M_DUART_OVRUN_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">M_DUART_FRM_ERR</span> <span class="o">|</span>
					   <span class="n">M_DUART_PARITY_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">M_DUART_RCVD_BRK</span><span class="p">;</span>

	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">M_DUART_FRM_ERR</span> <span class="o">|</span>
					     <span class="n">M_DUART_PARITY_ERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">M_DUART_RCVD_BRK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">M_DUART_OVRUN_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">M_DUART_RX_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">M_DUART_RX_DIS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">aux</span> <span class="o">|=</span> <span class="n">M_DUART_CTS_CHNG_ENA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aux</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DUART_CTS_CHNG_ENA</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span><span class="p">)</span>
		<span class="n">command</span> <span class="o">|=</span> <span class="n">M_DUART_TX_DIS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">command</span> <span class="o">|=</span> <span class="n">M_DUART_TX_EN</span><span class="p">;</span>

	<span class="n">oldmode1</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mode1mask</span><span class="p">;</span>
	<span class="n">oldmode2</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mode2mask</span><span class="p">;</span>
	<span class="n">oldaux</span> <span class="o">=</span> <span class="n">read_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_AUXCTL_X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">auxmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span><span class="p">)</span>
		<span class="n">sbd_line_drain</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_DIS</span> <span class="o">|</span> <span class="n">M_DUART_RX_DIS</span><span class="p">);</span>

	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_1</span><span class="p">,</span> <span class="n">mode1</span> <span class="o">|</span> <span class="n">oldmode1</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_MODE_REG_2</span><span class="p">,</span> <span class="n">mode2</span> <span class="o">|</span> <span class="n">oldmode2</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CLK_SEL</span><span class="p">,</span> <span class="n">brg</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_AUXCTL_X</span><span class="p">,</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">oldaux</span><span class="p">);</span>

	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sbd_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;SB1250 DUART&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="o">*</span><span class="n">duart</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">map_guard</span><span class="p">;</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span><span class="p">);</span>
	<span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">map_guard</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">map_guard</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_guard</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">mapctrl</span><span class="p">,</span> <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">KERN_ERR</span> <span class="s">&quot;sbd: Cannot map MMIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="o">*</span><span class="n">duart</span> <span class="o">=</span> <span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span>
						 <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span><span class="p">)</span>
		<span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">mapctrl</span><span class="p">,</span>
						 <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">memctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">KERN_ERR</span> <span class="s">&quot;sbd: Unable to reserve MMIO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="o">*</span><span class="n">duart</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">map_guard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">DUART_CHANREG_SPACING</span><span class="p">,</span>
				<span class="s">&quot;sb1250-duart&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">map_guard</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">map_guard</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_guard</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">mapctrl</span><span class="p">,</span> <span class="n">DUART_CHANREG_SPACING</span><span class="p">,</span>
					<span class="s">&quot;sb1250-duart&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">map_guard</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sbd_map_port</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">map_guard</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">map_guard</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_guard</span><span class="p">)</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">mapctrl</span><span class="p">,</span>
						   <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">DUART_CHANREG_SPACING</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UART_CONFIG_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbd_request_port</span><span class="p">(</span><span class="n">uport</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">uport</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_SB1250_DUART</span><span class="p">;</span>

		<span class="n">sbd_init_port</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbd_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_SB1250_DUART</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">sbd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">sbd_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">sbd_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">sbd_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">sbd_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">sbd_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">sbd_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">sbd_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">sbd_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">sbd_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sbd_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">sbd_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">sbd_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">sbd_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">sbd_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">sbd_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">sbd_verify_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Initialize SB1250 DUART port structures.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sbd_probe_duarts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">probed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">side</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_lines</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set the number of available units based on the SOC type.  */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">soc_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">K_SYS_SOC_TYPE_BCM1x55</span>:
	<span class="k">case</span> <span class="n">K_SYS_SOC_TYPE_BCM1x80</span>:
		<span class="n">max_lines</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Assume at least two serial ports at the normal address.  */</span>
		<span class="n">max_lines</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">probed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">DUART_MAX_CHIP</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">max_lines</span><span class="p">;</span>
	     <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbd_duarts</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">mapctrl</span> <span class="o">=</span> <span class="n">SBD_CTRLREGS</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">side</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">side</span> <span class="o">&lt;</span> <span class="n">DUART_MAX_SIDE</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">max_lines</span><span class="p">;</span>
		     <span class="n">side</span><span class="o">++</span><span class="p">,</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">sport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

			<span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>

			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">SBD_INT</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="mi">100000000</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_ops</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span>	<span class="o">=</span> <span class="n">line</span><span class="p">;</span>
			<span class="n">uport</span><span class="o">-&gt;</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="n">SBD_CHANREGS</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_SERIAL_SB1250_DUART_CONSOLE</span>
<span class="cm">/*</span>
<span class="cm"> * Serial console stuff.  Very basic, polling driver for doing serial</span>
<span class="cm"> * console output.  The console_lock is held by the caller, so we</span>
<span class="cm"> * shouldn&#39;t be interrupted for more console activity.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="n">to_sport</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>

	<span class="n">sbd_transmit_drain</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_TX_HOLD</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbd_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">/</span> <span class="n">DUART_MAX_SIDE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">side</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="n">DUART_MAX_SIDE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">sport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Disable transmit interrupts and enable the transmitter. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">read_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span>
		     <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M_DUART_IMR_TX</span><span class="p">);</span>
	<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_EN</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sbd_console_putchar</span><span class="p">);</span>

	<span class="cm">/* Restore transmit interrupts and the transmitter enable. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sbd_line_drain</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">tx_stopped</span><span class="p">)</span>
		<span class="n">write_sbdchn</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_CMD</span><span class="p">,</span> <span class="n">M_DUART_TX_DIS</span><span class="p">);</span>
	<span class="n">write_sbdshr</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="n">R_DUART_IMRREG</span><span class="p">((</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbd_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">/</span> <span class="n">DUART_MAX_SIDE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">side</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="n">DUART_MAX_SIDE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">chip</span><span class="p">].</span><span class="n">sport</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sbd_map_port</span><span class="p">(</span><span class="n">uport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sbd_init_port</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="n">uport</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">sbd_reg</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">sbd_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;duart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">sbd_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>	<span class="o">=</span> <span class="n">sbd_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_reg</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbd_serial_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sbd_probe_duarts</span><span class="p">();</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbd_console</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">console_initcall</span><span class="p">(</span><span class="n">sbd_serial_console_init</span><span class="p">);</span>

<span class="cp">#define SERIAL_SB1250_DUART_CONSOLE	&amp;sbd_console</span>
<span class="cp">#else</span>
<span class="cp">#define SERIAL_SB1250_DUART_CONSOLE	NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_SB1250_DUART_CONSOLE */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">sbd_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;sb1250_duart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>	<span class="o">=</span> <span class="s">&quot;duart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="n">SB1250_DUART_MINOR_BASE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">DUART_MAX_CHIP</span> <span class="o">*</span> <span class="n">DUART_MAX_SIDE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span>		<span class="o">=</span> <span class="n">SERIAL_SB1250_DUART_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Set up the driver and register it.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sbd_probe_duarts</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbd_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DUART_MAX_CHIP</span> <span class="o">*</span> <span class="n">DUART_MAX_SIDE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="o">*</span><span class="n">duart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">DUART_MAX_SIDE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">DUART_MAX_SIDE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">)</span>
			<span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbd_reg</span><span class="p">,</span> <span class="n">uport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unload the driver.  Unregister stuff, get ready to go away.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sbd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">DUART_MAX_CHIP</span> <span class="o">*</span> <span class="n">DUART_MAX_SIDE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sbd_duart</span> <span class="o">*</span><span class="n">duart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbd_duarts</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">DUART_MAX_SIDE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sbd_port</span> <span class="o">*</span><span class="n">sport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">duart</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">DUART_MAX_SIDE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">uport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sport</span><span class="o">-&gt;</span><span class="n">duart</span><span class="p">)</span>
			<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbd_reg</span><span class="p">,</span> <span class="n">uport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbd_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sbd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sbd_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
