<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › max3107.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>max3107.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  max3107.c - spi uart protocol driver for Maxim 3107</span>
<span class="cm"> *  Based on max3100.c</span>
<span class="cm"> *	by Christian Pellegrin &lt;chripell@evolware.org&gt;</span>
<span class="cm"> *  and	max3110.c</span>
<span class="cm"> *	by Feng Tang &lt;feng.tang@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) Aavamobile 2009</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;max3107.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">baud_table</span> <span class="n">brg26_ext</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">300</span><span class="p">,</span>    <span class="n">MAX3107_BRG26_B300</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">600</span><span class="p">,</span>    <span class="n">MAX3107_BRG26_B600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1200</span><span class="p">,</span>   <span class="n">MAX3107_BRG26_B1200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2400</span><span class="p">,</span>   <span class="n">MAX3107_BRG26_B2400</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4800</span><span class="p">,</span>   <span class="n">MAX3107_BRG26_B4800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9600</span><span class="p">,</span>   <span class="n">MAX3107_BRG26_B9600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19200</span><span class="p">,</span>  <span class="n">MAX3107_BRG26_B19200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">57600</span><span class="p">,</span>  <span class="n">MAX3107_BRG26_B57600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">MAX3107_BRG26_B115200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">230400</span><span class="p">,</span> <span class="n">MAX3107_BRG26_B230400</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">460800</span><span class="p">,</span> <span class="n">MAX3107_BRG26_B460800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">921600</span><span class="p">,</span> <span class="n">MAX3107_BRG26_B921600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">baud_table</span> <span class="n">brg13_int</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">300</span><span class="p">,</span>    <span class="n">MAX3107_BRG13_IB300</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">600</span><span class="p">,</span>    <span class="n">MAX3107_BRG13_IB600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1200</span><span class="p">,</span>   <span class="n">MAX3107_BRG13_IB1200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2400</span><span class="p">,</span>   <span class="n">MAX3107_BRG13_IB2400</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4800</span><span class="p">,</span>   <span class="n">MAX3107_BRG13_IB4800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9600</span><span class="p">,</span>   <span class="n">MAX3107_BRG13_IB9600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">19200</span><span class="p">,</span>  <span class="n">MAX3107_BRG13_IB19200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">57600</span><span class="p">,</span>  <span class="n">MAX3107_BRG13_IB57600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">MAX3107_BRG13_IB115200</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">230400</span><span class="p">,</span> <span class="n">MAX3107_BRG13_IB230400</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">460800</span><span class="p">,</span> <span class="n">MAX3107_BRG13_IB460800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">921600</span><span class="p">,</span> <span class="n">MAX3107_BRG13_IB921600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_new_brg</span><span class="p">(</span><span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">baud_table</span> <span class="o">*</span><span class="n">baud_tbl</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">baud_tbl</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="n">baud_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">baud</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">baud_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">new_brg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform SPI transfer for write/read of device register(s) */</span>
<span class="kt">int</span> <span class="nf">max3107_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="n">spi_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="n">spi_xfer</span><span class="p">;</span>

	<span class="cm">/* Initialize SPI ,message */</span>
	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi_msg</span><span class="p">);</span>

	<span class="cm">/* Initialize SPI transfer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi_xfer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">spi_xfer</span><span class="p">);</span>
	<span class="n">spi_xfer</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">spi_xfer</span><span class="p">.</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">spi_xfer</span><span class="p">.</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">rx</span><span class="p">;</span>
	<span class="n">spi_xfer</span><span class="p">.</span><span class="n">speed_hz</span> <span class="o">=</span> <span class="n">MAX3107_SPI_SPEED</span><span class="p">;</span>

	<span class="cm">/* Add SPI transfer to SPI message */</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi_xfer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi_msg</span><span class="p">);</span>

<span class="cp">#ifdef DBG_TRACE_SPI_DATA</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tx len %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_xfer</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spi_xfer</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; %x&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">spi_xfer</span><span class="p">.</span><span class="n">tx_buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Perform synchronous SPI transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi_sync</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi_msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spi_sync failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DBG_TRACE_SPI_DATA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi_xfer</span><span class="p">.</span><span class="n">rx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rx len %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi_xfer</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spi_xfer</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; %x&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">spi_xfer</span><span class="p">.</span><span class="n">rx_buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_rw</span><span class="p">);</span>

<span class="cm">/* Puts received data to circular buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_data_to_circ_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Insert received data */</span>
	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/* Update RX counter */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle data receiving */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_handlerx</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rxlvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>				<span class="cm">/* SPI transfer buffer length */</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">valid_str</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
		<span class="cm">/* RX is disabled */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxlvl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RX fifo is empty */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rxlvl</span> <span class="o">&gt;=</span> <span class="n">MAX3107_RX_FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Possible RX FIFO overrun %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxlvl</span><span class="p">);</span>
		<span class="cm">/* Ensure sanity of RX level */</span>
		<span class="n">rxlvl</span> <span class="o">=</span> <span class="n">MAX3107_RX_FIFO_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx buffer/str isn&#39;t ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="n">valid_str</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rxlvl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rxlvl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxlvl</span><span class="p">);</span>
		<span class="cm">/* Clear buffer */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX3107_RX_FIFO_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_RXFIFO_BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First disable RX FIFO interrupt */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Disabling RX INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAX3107_IRQ_RXFIFO_BIT</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Just increase the length by amount of words in FIFO since</span>
<span class="cm">		 * buffer was zeroed and SPI transfer of 0x0000 means reading</span>
<span class="cm">		 * from RX FIFO</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">rxlvl</span><span class="p">;</span>
		<span class="cm">/* Append RX level query */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_RXFIFOLVL_REG</span><span class="p">;</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Perform the SPI transfer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer for RX h failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Skip RX FIFO interrupt disabling word if it was added */</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">rxlvl</span><span class="p">);</span>
		<span class="cm">/* Read received words */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxlvl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">valid_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">put_data_to_circ_buf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">valid_str</span><span class="p">,</span> <span class="n">rxlvl</span><span class="p">);</span>
		<span class="cm">/* Get new RX level */</span>
		<span class="n">rxlvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RX still enabled, re-enable RX FIFO interrupt */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enabling RX INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">|=</span> <span class="n">MAX3107_IRQ_RXFIFO_BIT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX FIFO INT enabling failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Push the received data to receivers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Handle data sending */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_handletx</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>				<span class="cm">/* SPI transfer buffer length */</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span><span class="p">)</span>
		<span class="cm">/* Don&#39;t send more data before previous data is sent */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		<span class="cm">/* No data to send or TX is stopped */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Txbuf isn&#39;t ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">;</span>
	<span class="cm">/* Get length of data pending in circular buffer */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Limit to size of TX FIFO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX3107_TX_FIFO_SIZE</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">MAX3107_TX_FIFO_SIZE</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;txlen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* Update TX counter */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* TX FIFO will no longer be empty */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_TXEMPTY_BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First disable TX empty interrupt */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Disabling TE INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAX3107_IRQ_TXEMPTY_BIT</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Add data to send */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_THR_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="n">MAX3107_SPI_TX_DATA_MASK</span><span class="p">);</span>
			<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_TXEMPTY_BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Enable TX empty interrupt */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enabling TE INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">|=</span> <span class="n">MAX3107_IRQ_TXEMPTY_BIT</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable TX */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Enable TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE1_REG</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAX3107_MODE1_TXDIS_BIT</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Perform the SPI transfer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">len</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;SPI transfer TX handling failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Indicate wake up if circular buffer is getting low on data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Handle interrupts</span>
<span class="cm"> * Also reads and returns current RX FIFO level</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">handle_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Buffer for SPI transfers */</span>
	<span class="n">u8</span> <span class="n">irq_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Read IRQ status register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_IRQSTS_REG</span><span class="p">;</span>
	<span class="cm">/* Read status IRQ status register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_STS_IRQSTS_REG</span><span class="p">;</span>
	<span class="cm">/* Read LSR IRQ status register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_LSR_IRQSTS_REG</span><span class="p">;</span>
	<span class="cm">/* Query RX level */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_RXFIFOLVL_REG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;SPI transfer for INTR handling failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IRQSTS %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">);</span>
	<span class="n">rx_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_LSR_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* LSR interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_LSR_RXTO_BIT</span><span class="p">)</span>
			<span class="cm">/* RX timeout interrupt,</span>
<span class="cm">			 * handled by normal RX handling</span>
<span class="cm">			 */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RX TO INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_TXEMPTY_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Tx empty interrupt,</span>
<span class="cm">		 * disable TX and set tx_fifo_empty flag</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TE INT, disabling TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE1_REG</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_TXDIS_BIT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer TX dis failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">MAX3107_IRQ_RXFIFO_BIT</span><span class="p">)</span>
		<span class="cm">/* RX FIFO interrupt,</span>
<span class="cm">		 * handled by normal RX handling</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RFIFO INT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Return RX level */</span>
	<span class="k">return</span> <span class="n">rx_level</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Trigger work thread*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_dowork</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">freezing</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrup isn&#39;t serviced normally!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Work thread */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">rxlvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* SPI transfer buffer length */</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>	<span class="cm">/* Buffer for SPI transfers */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Start by reading current RX FIFO level */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_RXFIFOLVL_REG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer RX lev failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rxlvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxlvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rxlvl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxlvl</span><span class="p">);</span>

		<span class="cm">/* Handle RX */</span>
		<span class="n">max3107_handlerx</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rxlvl</span><span class="p">);</span>
		<span class="n">rxlvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Handle pending interrupts</span>
<span class="cm">			 * We also get new RX FIFO level since new data may</span>
<span class="cm">			 * have been received while pushing received data to</span>
<span class="cm">			 * receivers</span>
<span class="cm">			 */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rxlvl</span> <span class="o">=</span> <span class="n">handle_interrupt</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Handle TX */</span>
		<span class="n">max3107_handletx</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="cm">/* Handle configuration changes */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_commit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mode1_commit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE1_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_commit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_commit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;lcr_commit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_LCR_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_reg</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_commit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_commit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;brg_commit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGDIVMSB_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">MAX3107_SPI_TX_DATA_MASK</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGDIVLSB_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">MAX3107_SPI_TX_DATA_MASK</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGCFG_REG</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_commit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;SPI transfer config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reloop if interrupt handling indicated data in RX FIFO */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rxlvl</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Set sleep mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_set_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Buffer for SPI transfer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;enter, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE1_REG</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAX3107_DISABLE_FORCED_SLEEP</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAX3107_MODE1_FORCESLEEP_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAX3107_ENABLE_FORCED_SLEEP</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_FORCESLEEP_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAX3107_DISABLE_AUTOSLEEP</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAX3107_MODE1_AUTOSLEEP_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAX3107_ENABLE_AUTOSLEEP</span>:
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_AUTOSLEEP_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid sleep mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer sleep mode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MAX3107_DISABLE_AUTOSLEEP</span> <span class="o">||</span>
			<span class="n">mode</span> <span class="o">==</span> <span class="n">MAX3107_DISABLE_FORCED_SLEEP</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">MAX3107_WAKEUP_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Perform full register initialization */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_register_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>	<span class="cm">/* Buffer for SPI transfers */</span>

	<span class="cm">/* 1. Configure baud rate, 9600 as default */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="cm">/* the below is default*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">=</span> <span class="n">MAX3107_BRG26_B9600</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">baud_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">baud_table</span> <span class="o">*</span><span class="p">)</span><span class="n">brg26_ext</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">=</span> <span class="n">MAX3107_BRG13_IB9600</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">baud_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">baud_table</span> <span class="o">*</span><span class="p">)</span><span class="n">brg13_int</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGDIVMSB_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_TX_DATA_MASK</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGDIVLSB_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_TX_DATA_MASK</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_BRGCFG_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* 2. Configure LCR register, 8N1 mode by default */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_reg</span> <span class="o">=</span> <span class="n">MAX3107_LCR_WORD_LEN_8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_LCR_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_reg</span><span class="p">;</span>

	<span class="cm">/* 3. Configure MODE 1 register */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Enable IRQ pin */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_IRQSEL_BIT</span><span class="p">;</span>
	<span class="cm">/* Disable TX */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_TXDIS_BIT</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* RX is enabled */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE1_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span><span class="p">;</span>

	<span class="cm">/* 4. Configure MODE 2 register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE2_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable loopback */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_MODE2_LOOPBACK_BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Reset FIFOs */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_MODE2_FIFORST_BIT</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 5. Configure FIFO trigger level register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_FIFOTRIGLVL_REG</span><span class="p">);</span>
	<span class="cm">/* RX FIFO trigger for 16 words, TX FIFO trigger not used */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAX3107_FIFOTRIGLVL_RX</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAX3107_FIFOTRIGLVL_TX</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* 6. Configure flow control levels */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_FLOWLVL_REG</span><span class="p">);</span>
	<span class="cm">/* Flow control halt level 96, resume level 48 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAX3107_FLOWLVL_RES</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAX3107_FLOWLVL_HALT</span><span class="p">(</span><span class="mi">96</span><span class="p">));</span>

	<span class="cm">/* 7. Configure flow control */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_FLOWCTRL_REG</span><span class="p">);</span>
	<span class="cm">/* Enable auto CTS and auto RTS flow control */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAX3107_FLOWCTRL_AUTOCTS_BIT</span> <span class="o">|</span> <span class="n">MAX3107_FLOWCTRL_AUTORTS_BIT</span><span class="p">);</span>

	<span class="cm">/* 8. Configure RX timeout register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_RXTO_REG</span><span class="p">);</span>
	<span class="cm">/* Timeout after 48 character intervals */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x0030</span><span class="p">;</span>

	<span class="cm">/* 9. Configure LSR interrupt enable register */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_LSR_IRQEN_REG</span><span class="p">);</span>
	<span class="cm">/* Enable RX timeout interrupt */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_LSR_RXTO_BIT</span><span class="p">;</span>

	<span class="cm">/* Perform SPI transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer for init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* 10. Clear IRQ status register by reading it */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_IRQSTS_REG</span><span class="p">;</span>

	<span class="cm">/* 11. Configure interrupt enable register */</span>
	<span class="cm">/* Enable LSR interrupt */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">=</span> <span class="n">MAX3107_IRQ_LSR_BIT</span><span class="p">;</span>
	<span class="cm">/* Enable RX FIFO interrupt */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span> <span class="o">|=</span> <span class="n">MAX3107_IRQ_RXFIFO_BIT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irqen_reg</span><span class="p">;</span>

	<span class="cm">/* 12. Clear FIFO reset that was set in step 6 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_MODE2_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Keep loopback enabled */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_MODE2_LOOPBACK_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Perform SPI transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer for init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* IRQ handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">max3107_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irqno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqno</span> <span class="o">!=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unexpected IRQ */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Indicate irq */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Trigger work thread */</span>
	<span class="n">max3107_dowork</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* HW suspension function</span>
<span class="cm"> *</span>
<span class="cm"> * Currently autosleep is used to decrease current consumption, alternative</span>
<span class="cm"> * approach would be to set the chip to reset mode if UART is not being</span>
<span class="cm"> * used but that would mess the GPIOs</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">max3107_hw_susp</span><span class="p">(</span><span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;enter, suspend %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">suspend</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Suspend requested,</span>
<span class="cm">		 * enable autosleep to decrease current consumption</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">max3107_set_sleep</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MAX3107_ENABLE_AUTOSLEEP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Resume requested,</span>
<span class="cm">		 * disable autosleep</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max3107_set_sleep</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MAX3107_DISABLE_AUTOSLEEP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_hw_susp</span><span class="p">);</span>

<span class="cm">/* Modem status IRQ enabling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Modem status not supported */</span>
<span class="p">}</span>

<span class="cm">/* Data send function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Trigger work thread for sending data */</span>
	<span class="n">max3107_dowork</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Function for checking that there is no pending transfers */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">max3107_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span> <span class="o">&amp;&amp;</span> <span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_fifo_empty</span> <span class="o">&amp;&amp;</span> <span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Function for stopping RX */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Set RX disabled in MODE 1 register */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_reg</span> <span class="o">|=</span> <span class="n">MAX3107_MODE1_RXDIS_BIT</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mode1_commit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Set RX disabled */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Trigger work thread for doing the actual configuration change */</span>
	<span class="n">max3107_dowork</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Function for returning control pin states */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">max3107_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DCD and DSR are not wired and CTS/RTS is handled automatically</span>
<span class="cm">	 * so just indicate DSR and CAR asserted</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">TIOCM_DSR</span> <span class="o">|</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Function for setting control pin states */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DCD and DSR are not wired and CTS/RTS is hadnled automatically</span>
<span class="cm">	 * so do nothing</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/* Function for configuring UART parameters */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_lcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_brg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Get new LCR register values */</span>
	<span class="cm">/* Word size */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS7</span><span class="p">)</span>
		<span class="n">new_lcr</span> <span class="o">|=</span> <span class="n">MAX3107_LCR_WORD_LEN_7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_lcr</span> <span class="o">|=</span> <span class="n">MAX3107_LCR_WORD_LEN_8</span><span class="p">;</span>

	<span class="cm">/* Parity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_lcr</span> <span class="o">|=</span> <span class="n">MAX3107_LCR_PARITY_BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
			<span class="n">new_lcr</span> <span class="o">|=</span> <span class="n">MAX3107_LCR_EVENPARITY_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stop bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2 stop bits */</span>
		<span class="n">new_lcr</span> <span class="o">|=</span> <span class="n">MAX3107_LCR_STOPLEN_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mask termios capabilities we don&#39;t support */</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>

	<span class="cm">/* Set status ignore mask */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">MAX3107_ALL_ERRORS</span><span class="p">;</span>

	<span class="cm">/* Set low latency to immediately handle pushed data */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get new baud rate generator configuration */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">new_brg</span> <span class="o">=</span> <span class="n">get_new_brg</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="cm">/* if can&#39;t find the corrent config, use previous */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_brg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
		<span class="n">new_brg</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>

	<span class="cm">/* Update timeout according to new baud rate */</span>
	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_reg</span> <span class="o">!=</span> <span class="n">new_lcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_reg</span> <span class="o">=</span> <span class="n">new_lcr</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">lcr_commit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">!=</span> <span class="n">new_brg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_cfg</span> <span class="o">=</span> <span class="n">new_brg</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">brg_commit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Trigger work thread for doing the actual configuration change */</span>
	<span class="n">max3107_dowork</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Port shutdown function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Free the interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Flush and destroy work queue */</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Suspend HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Port startup function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max3107_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Initialize work queue */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_freezable_workqueue</span><span class="p">(</span><span class="s">&quot;max3107&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Workqueue creation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">max3107_work</span><span class="p">);</span>

	<span class="cm">/* Setup IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">max3107_irq</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
			<span class="s">&quot;max3107&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ reguest failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resume HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Init registers */</span>
	<span class="n">max3107_register_init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port type function */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">max3107_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">modalias</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port release function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do nothing */</span>
<span class="p">}</span>

<span class="cm">/* Port request function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max3107_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do nothing */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port config function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_MAX3107</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port verify function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max3107_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_UNKNOWN</span> <span class="o">||</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MAX3107</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Port stop TX function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do nothing */</span>
<span class="p">}</span>

<span class="cm">/* Port break control function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">max3107_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We don&#39;t support break control, do nothing */</span>
<span class="p">}</span>


<span class="cm">/* Port functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">max3107_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>       <span class="o">=</span> <span class="n">max3107_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>      <span class="o">=</span> <span class="n">max3107_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>      <span class="o">=</span> <span class="n">max3107_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>        <span class="o">=</span> <span class="n">max3107_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>       <span class="o">=</span> <span class="n">max3107_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>        <span class="o">=</span> <span class="n">max3107_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>      <span class="o">=</span> <span class="n">max3107_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>      <span class="o">=</span> <span class="n">max3107_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>        <span class="o">=</span> <span class="n">max3107_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>       <span class="o">=</span> <span class="n">max3107_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>    <span class="o">=</span> <span class="n">max3107_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>           <span class="o">=</span> <span class="n">max3107_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>   <span class="o">=</span> <span class="n">max3107_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>   <span class="o">=</span> <span class="n">max3107_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>    <span class="o">=</span> <span class="n">max3107_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>    <span class="o">=</span> <span class="n">max3107_verify_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* UART driver data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">max3107_uart_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>    <span class="o">=</span> <span class="s">&quot;ttyMAX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>       <span class="o">=</span> <span class="s">&quot;ttyMAX&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>             <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">driver_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



<span class="cm">/* &#39;Generic&#39; platform data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">max3107_plat</span> <span class="n">generic_plat_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">loopback</span>               <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ext_clk</span>                <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_suspend</span>		<span class="o">=</span> <span class="n">max3107_hw_susp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">polled_mode</span>            <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_time</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*******************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> *	max3107_probe		-	SPI bus probe entry point</span>
<span class="cm"> *	@spi: the spi device</span>
<span class="cm"> *</span>
<span class="cm"> *	SPI wants us to probe this device and if appropriate claim it.</span>
<span class="cm"> *	Perform any platform specific requirements and then initialise</span>
<span class="cm"> *	the device.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">max3107_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">max3107_plat</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Buffer for SPI transfers */</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;enter max3107 probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Allocate port structure */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating port structure failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>

	<span class="cm">/* SPI Rx buffer</span>
<span class="cm">	 * +2 for RX FIFO interrupt</span>
<span class="cm">	 * disabling and RX level query</span>
<span class="cm">	 */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX3107_RX_FIFO_SIZE</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating RX buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX3107_RX_FIFO_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating RX buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* SPI Tx buffer</span>
<span class="cm">	 * SPI transfer buffer</span>
<span class="cm">	 * +3 for TX FIFO empty</span>
<span class="cm">	 * interrupt disabling and</span>
<span class="cm">	 * enabling and TX enabling</span>
<span class="cm">	 */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX3107_TX_FIFO_SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating TX buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize shared data lock */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">data_lock</span><span class="p">);</span>

	<span class="cm">/* SPI intializations */</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">spi</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SPI_MODE_0</span><span class="p">;</span>
	<span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">spi</span><span class="o">-&gt;</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">ext_clk</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">;</span>
	<span class="n">spi_setup</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">=</span> <span class="n">spi</span><span class="p">;</span>

	<span class="cm">/* Check REV ID to ensure we are talking to what we expect */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX3107_REVID_REG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer for REVID read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAX3107_REVID1</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAX3107_REVID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;REVID %x does not match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MAX3107_SPI_RX_DATA_MASK</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable all interrupts */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_IRQEN_REG</span> <span class="o">|</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="cm">/* Configure clock source */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX3107_WRITE_BIT</span> <span class="o">|</span> <span class="n">MAX3107_CLKSRC_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* External clock */</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_CLKSRC_EXTCLK_BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PLL bypass ON */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MAX3107_CLKSRC_PLLBYP_BIT</span><span class="p">;</span>

	<span class="cm">/* Perform SPI transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max3107_rw</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SPI transfer for init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register UART driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Registering UART driver failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">driver_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize UART port data */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">max3107_ops</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_MAX3107</span><span class="p">;</span>

	<span class="cm">/* Add UART port */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adding UART port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Go to suspend mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
<span class="nl">err_free2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span><span class="p">);</span>
<span class="nl">err_free3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
<span class="nl">err_free4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_probe</span><span class="p">);</span>

<span class="cm">/* Driver remove function */</span>
<span class="kt">int</span> <span class="nf">max3107_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;enter max3107 remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Remove port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Removing UART port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* Free TxRx buffer */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rxstr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>

	<span class="cm">/* Free port structure */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_remove</span><span class="p">);</span>

<span class="cm">/* Driver suspend function */</span>
<span class="kt">int</span> <span class="nf">max3107_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;enter suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Suspend UART port */</span>
	<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Go to suspend mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_suspend</span><span class="p">);</span>

<span class="cm">/* Driver resume function */</span>
<span class="kt">int</span> <span class="nf">max3107_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">struct</span> <span class="n">max3107_port</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;enter resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Resume from suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hw_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Resume UART port */</span>
	<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">max3107_resume</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max3107_probe_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">max3107_probe</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">generic_plat_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Spi driver data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">max3107_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;max3107&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">max3107_probe_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">max3107_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">max3107_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">max3107_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Driver init function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">max3107_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;enter max3107 init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Driver exit function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">max3107_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;enter max3107 exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Unregister UART driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver_registered</span><span class="p">)</span>
		<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_uart_driver</span><span class="p">);</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max3107_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">max3107_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">max3107_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MAX3107 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Aavamobile&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;spi:max3107&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
