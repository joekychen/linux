<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › 8250 › 8250_hp300.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>8250_hp300.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the 98626/98644/internal serial interface on hp300/hp400</span>
<span class="cm"> * (based on the National Semiconductor INS8250/NS16550AF/WD16C552 UARTs)</span>
<span class="cm"> *</span>
<span class="cm"> * Ported from 2.2 and modified to use the normal 8250 driver</span>
<span class="cm"> * by Kars de Jong &lt;jongk@linux-m68k.org&gt;, May 2004.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/serial_8250.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dio.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;8250.h&quot;</span>

<span class="cp">#if !defined(CONFIG_HPDCA) &amp;&amp; !defined(CONFIG_HPAPCI)</span>
<span class="cp">#warning CONFIG_8250 defined but neither CONFIG_HPDCA nor CONFIG_HPAPCI defined, are you sure?</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HPAPCI</span>
<span class="k">struct</span> <span class="n">hp300_port</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp300_port</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>	<span class="cm">/* next port */</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>			<span class="cm">/* line (tty) number */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hp300_port</span> <span class="o">*</span><span class="n">hp300_ports</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HPDCA</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">hpdca_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">dio_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">dio_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">hpdca_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">dio_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dio_device_id</span> <span class="n">hpdca_dio_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">DIO_ID_DCA0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DIO_ID_DCA0REM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DIO_ID_DCA1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DIO_ID_DCA1REM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dio_driver</span> <span class="n">hpdca_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>      <span class="o">=</span> <span class="s">&quot;hpdca&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>  <span class="o">=</span> <span class="n">hpdca_dio_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>     <span class="o">=</span> <span class="n">hpdca_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>    <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hpdca_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_ports</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">hp300_uart_scode</span><span class="p">;</span>

<span class="cm">/* Offset to UART registers from base of DCA */</span>
<span class="cp">#define UART_OFFSET	17</span>

<span class="cp">#define DCA_ID		0x01	</span><span class="cm">/* ID (read), reset (write) */</span><span class="cp"></span>
<span class="cp">#define DCA_IC		0x03	</span><span class="cm">/* Interrupt control        */</span><span class="cp"></span>

<span class="cm">/* Interrupt control */</span>
<span class="cp">#define DCA_IC_IE	0x80	</span><span class="cm">/* Master interrupt enable  */</span><span class="cp"></span>

<span class="cp">#define HPDCA_BAUD_BASE 153600</span>

<span class="cm">/* Base address of the Frodo part */</span>
<span class="cp">#define FRODO_BASE	(0x41c000)</span>

<span class="cm">/*</span>
<span class="cm"> * Where we find the 8250-like APCI ports, and how far apart they are.</span>
<span class="cm"> */</span>
<span class="cp">#define FRODO_APCIBASE		0x0</span>
<span class="cp">#define FRODO_APCISPACE		0x20</span>
<span class="cp">#define FRODO_APCI_OFFSET(x)	(FRODO_APCIBASE + ((x) * FRODO_APCISPACE))</span>

<span class="cp">#define HPAPCI_BAUD_BASE 500400</span>

<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
<span class="cm">/*</span>
<span class="cm"> * Parse the bootinfo to find descriptions for headless console and</span>
<span class="cm"> * debug serial ports and register them with the 8250 driver.</span>
<span class="cm"> * This function should be called before serial_console_init() is called</span>
<span class="cm"> * to make sure the serial console will be available for use. IA-64 kernel</span>
<span class="cm"> * calls this function from setup_arch() after the EFI and ACPI tables have</span>
<span class="cm"> * been parsed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp300_setup_serial_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">scode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp300_uart_scode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hp300_uart_scode</span> <span class="o">&gt;</span> <span class="n">DIO_SCMAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DIO_SCINHOLE</span><span class="p">(</span><span class="n">hp300_uart_scode</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scode</span> <span class="o">=</span> <span class="n">hp300_uart_scode</span><span class="p">;</span>

	<span class="cm">/* Memory mapped I/O */</span>
	<span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_SHARE_IRQ</span> <span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* Check for APCI console */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HPAPCI</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Serial console is HP APCI 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">HPAPCI_BAUD_BASE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">FRODO_BASE</span> <span class="o">+</span> <span class="n">FRODO_APCI_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
		<span class="n">port</span><span class="p">.</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyS&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;9600n8&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Serial console is APCI but support is disabled (CONFIG_HPAPCI)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HPDCA</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">dio_scodetophysaddr</span><span class="p">(</span><span class="n">scode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Serial console is HP DCA at select code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scode</span><span class="p">);</span>

		<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">HPDCA_BAUD_BASE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">UART_OFFSET</span><span class="p">);</span>
		<span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
		<span class="n">port</span><span class="p">.</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">DIO_IPL</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>

		<span class="cm">/* Enable board-interrupts */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span> <span class="o">+</span> <span class="n">DCA_IC</span><span class="p">,</span> <span class="n">DCA_IC_IE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DIO_ID</span><span class="p">(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyS&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;9600n8&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Serial console is DCA but support is disabled (CONFIG_HPDCA)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">early_serial_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hp300_setup_serial_console(): early_serial_setup() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_8250_CONSOLE */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_HPDCA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hpdca_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">dio_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">dio_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp300_uart_scode</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">scode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Already got it. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span><span class="p">));</span>

	<span class="cm">/* Memory mapped I/O */</span>
	<span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_SHARE_IRQ</span> <span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ipl</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">HPDCA_BAUD_BASE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">UART_OFFSET</span><span class="p">);</span>
	<span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
	<span class="n">port</span><span class="p">.</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">serial8250_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;8250_hp300: register_serial() DCA scode %d&quot;</span>
		       <span class="s">&quot; irq %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">scode</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable board-interrupts */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span> <span class="o">+</span> <span class="n">DCA_IC</span><span class="p">,</span> <span class="n">DCA_IC_IE</span><span class="p">);</span>
	<span class="n">dio_set_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">line</span><span class="p">);</span>

	<span class="cm">/* Reset the DCA */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span> <span class="o">+</span> <span class="n">DCA_ID</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">num_ports</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp300_8250_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">called</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HPAPCI</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">uport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp300_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">called</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_HP300</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HPDCA</span>
	<span class="n">dio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpdca_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HPAPCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp300_model</span> <span class="o">&lt;</span> <span class="n">HP_400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_ports</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* These models have the Frodo chip.</span>
<span class="cm">	 * Port 0 is reserved for the Apollo Domain keyboard.</span>
<span class="cm">	 * Port 1 is either the console or the DCA.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Port 1 is the console on a 425e, on other machines it&#39;s</span>
<span class="cm">		 * mapped to DCA.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* Create new serial device */</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp300_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span><span class="p">));</span>

		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">FRODO_BASE</span> <span class="o">+</span> <span class="n">FRODO_APCI_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="cm">/* Memory mapped I/O */</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_SHARE_IRQ</span> \
			      <span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
		<span class="cm">/* XXX - no interrupt support yet */</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">HPAPCI_BAUD_BASE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
		<span class="n">uport</span><span class="p">.</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">line</span> <span class="o">=</span> <span class="n">serial8250_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;8250_hp300: register_serial() APCI&quot;</span>
			       <span class="s">&quot; %d irq %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">uport</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">hp300_ports</span><span class="p">;</span>
		<span class="n">hp300_ports</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

		<span class="n">num_ports</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Any boards found? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_ports</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HPDCA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">hpdca_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">dio_dev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dio_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable board-interrupts */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span> <span class="o">+</span> <span class="n">DCA_IC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">serial8250_unregister_port</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hp300_8250_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_HPAPCI</span>
	<span class="k">struct</span> <span class="n">hp300_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">to_free</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">hp300_ports</span><span class="p">;</span> <span class="n">port</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">serial8250_unregister_port</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
		<span class="n">to_free</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">to_free</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp300_ports</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HPDCA</span>
	<span class="n">dio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hpdca_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hp300_8250_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hp300_8250_exit</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HP DCA/APCI serial driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kars de Jong &lt;jongk@linux-m68k.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
