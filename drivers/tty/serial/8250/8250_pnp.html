<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › 8250 › 8250_pnp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>8250_pnp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Probe module for 8250/16550-type ISAPNP serial ports.</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on drivers/char/serial.c, by Linus Torvalds, Theodore Ts&#39;o.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001 Russell King, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  Ported to the Linux PnP Layer - (C) Adam Belay.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;8250.h&quot;</span>

<span class="cp">#define UNKNOWN_DEV 0x3000</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">pnp_dev_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Archtek America Corp. */</span>
	<span class="cm">/* Archtek SmartLink Modem 3334BT Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;AAC000F&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Anchor Datacomm BV */</span>
	<span class="cm">/* SXPro 144 External Data Fax Modem Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;ADC0001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SXPro 288 External Data Fax Modem Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;ADC0002&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* PROLiNK 1456VH ISA PnP K56flex Fax Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;AEI0250&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Actiontec ISA PNP 56K X2 Fax Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;AEI1240&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Rockwell 56K ACF II Fax+Data+Voice Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;AKY1021&quot;</span><span class="p">,</span>		<span class="mi">0</span> <span class="cm">/*SPCI_FL_NO_SHIRQ*/</span>	<span class="p">},</span>
	<span class="cm">/* AZT3005 PnP SOUND DEVICE */</span>
	<span class="p">{</span>	<span class="s">&quot;AZT4001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Best Data Products Inc. Smart One 336F PnP Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;BDP3336&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Boca Research */</span>
	<span class="cm">/* Boca Complete Ofc Communicator 14.4 Data-FAX */</span>
	<span class="p">{</span>	<span class="s">&quot;BRI0A49&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Boca Research 33,600 ACF Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;BRI1400&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Boca 33.6 Kbps Internal FD34FSVD */</span>
	<span class="p">{</span>	<span class="s">&quot;BRI3400&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Boca 33.6 Kbps Internal FD34FSVD */</span>
	<span class="p">{</span>	<span class="s">&quot;BRI0A49&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Best Data Products Inc. Smart One 336F PnP Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;BDP3336&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Computer Peripherals Inc */</span>
	<span class="cm">/* EuroViVa CommCenter-33.6 SP PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;CPI4050&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Creative Labs */</span>
	<span class="cm">/* Creative Labs Phone Blaster 28.8 DSVD PnP Voice */</span>
	<span class="p">{</span>	<span class="s">&quot;CTL3001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Creative Labs Modem Blaster 28.8 DSVD PnP Voice */</span>
	<span class="p">{</span>	<span class="s">&quot;CTL3011&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Davicom ISA 33.6K Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;DAV0336&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Creative */</span>
	<span class="cm">/* Creative Modem Blaster Flash56 DI5601-1 */</span>
	<span class="p">{</span>	<span class="s">&quot;DMB1032&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Creative Modem Blaster V.90 DI5660 */</span>
	<span class="p">{</span>	<span class="s">&quot;DMB2001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* E-Tech */</span>
	<span class="cm">/* E-Tech CyberBULLET PC56RVP */</span>
	<span class="p">{</span>	<span class="s">&quot;ETT0002&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* FUJITSU */</span>
	<span class="cm">/* Fujitsu 33600 PnP-I2 R Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ0202&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu FMV-FX431 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ0205&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu 33600 PnP-I4 R Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ0206&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu Fax Voice 33600 PNP-I5 R Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ0209&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Archtek America Corp. */</span>
	<span class="cm">/* Archtek SmartLink Modem 3334BT Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;GVC000F&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Archtek SmartLink Modem 3334BRV 33.6K Data Fax Voice */</span>
	<span class="p">{</span>	<span class="s">&quot;GVC0303&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes */</span>
	<span class="cm">/* Hayes Optima 288 V.34-V.FC + FAX + Voice Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY0001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Optima 336 V.34 + FAX + Voice PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY000C&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Optima 336B V.34 + FAX + Voice PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY000D&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Accura 56K Ext Fax Modem PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY5670&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Accura 56K Ext Fax Modem PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY5674&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Accura 56K Fax Modem PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;HAY5675&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes 288, V.34 + FAX */</span>
	<span class="p">{</span>	<span class="s">&quot;HAYF000&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Hayes Optima 288 V.34 + FAX + Voice, Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;HAYF001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* IBM */</span>
	<span class="cm">/* IBM Thinkpad 701 Internal Modem Voice */</span>
	<span class="p">{</span>	<span class="s">&quot;IBM0033&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intermec */</span>
	<span class="cm">/* Intermec CV60 touchscreen port */</span>
	<span class="p">{</span>	<span class="s">&quot;PNP4972&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex */</span>
	<span class="cm">/* Intertex 28k8 33k6 Voice EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDC801&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 33k6 56k Voice EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDC901&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 28k8 33k6 Voice SP EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDD801&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 33k6 56k Voice SP EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDD901&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 28k8 33k6 Voice SP INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDF401&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 28k8 33k6 Voice SP EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDF801&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Intertex 33k6 56k Voice SP EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;IXDF901&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Kortex International */</span>
	<span class="cm">/* KORTEX 28800 Externe PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;KOR4522&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* KXPro 33.6 Vocal ASVD PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;KORF661&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Lasat */</span>
	<span class="cm">/* LASAT Internet 33600 PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;LAS4040&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Lasat Safire 560 PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;LAS4540&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Lasat Safire 336  PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;LAS5440&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom, Inc. */</span>
	<span class="cm">/* Microcom TravelPorte FAST V.34 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0281&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte V.34 FAST or FAST+ Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0336&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte FAST EP 28.8 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0339&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte 28.8P Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0342&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte FAST ES 28.8 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0500&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte FAST ES 28.8 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0501&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Microcom DeskPorte 28.8S Internal Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MNP0502&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola */</span>
	<span class="cm">/* Motorola BitSURFR Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1105&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola TA210 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1111&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola HMTA 200 (ISDN) Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1114&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola BitSURFR Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1115&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola Lifestyle 28.8 Internal */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1190&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola V.3400 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1501&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola Lifestyle 28.8 V.34 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1502&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola Power 28.8 V.34 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1505&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola ModemSURFR External 28.8 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1509&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola Premier 33.6 Desktop Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT150A&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola VoiceSURFR 56K External PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT150F&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola ModemSURFR 56K External PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1510&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola ModemSURFR 56K Internal PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1550&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola ModemSURFR Internal 28.8 Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1560&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola Premier 33.6 Internal Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT1580&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola OnlineSURFR 28.8 Internal Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT15B0&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Motorola VoiceSURFR 56K Internal PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MOT15F0&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Com 1 */</span>
	<span class="cm">/*  Deskline K56 Phone System PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MVX00A1&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* PC Rider K56 Phone System PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;MVX00F2&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* NEC 98NOTE SPEAKER PHONE FAX MODEM(33600bps) */</span>
	<span class="p">{</span>	<span class="s">&quot;nEC8241&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Pace 56 Voice Internal Plug &amp; Play Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PMC2430&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Generic */</span>
	<span class="cm">/* Generic standard PC COM port	 */</span>
	<span class="p">{</span>	<span class="s">&quot;PNP0500&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Generic 16550A-compatible COM port */</span>
	<span class="p">{</span>	<span class="s">&quot;PNP0501&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Compaq 14400 Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC000&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Compaq 2400/9600 Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC001&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Dial-Up Networking Serial Cable between 2 PCs */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC031&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Dial-Up Networking Parallel Cable between 2 PCs */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC032&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 9600 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC100&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 14400 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC101&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard 28800 bps Modem*/</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC102&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard Modem*/</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC103&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard 9600 bps Modem*/</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC104&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard 14400 bps Modem*/</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC105&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard 28800 bps Modem*/</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC106&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Standard Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC107&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 9600 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC108&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 14400 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC109&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 28800 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10A&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10B&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 9600 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10C&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 14400 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10D&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard 28800 bps Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10E&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPC10F&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Standard PCMCIA Card Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;PNP2000&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Rockwell */</span>
	<span class="cm">/* Modular Technology */</span>
	<span class="cm">/* Rockwell 33.6 DPF Internal PnP */</span>
	<span class="cm">/* Modular Technology 33.6 Internal PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;ROK0030&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Kortex International */</span>
	<span class="cm">/* KORTEX 14400 Externe PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;ROK0100&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Rockwell 28.8 */</span>
	<span class="p">{</span>	<span class="s">&quot;ROK4120&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Viking Components, Inc */</span>
	<span class="cm">/* Viking 28.8 INTERNAL Fax+Data+Voice PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;ROK4920&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Rockwell */</span>
	<span class="cm">/* British Telecom */</span>
	<span class="cm">/* Modular Technology */</span>
	<span class="cm">/* Rockwell 33.6 DPF External PnP */</span>
	<span class="cm">/* BT Prologue 33.6 External PnP */</span>
	<span class="cm">/* Modular Technology 33.6 External PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;RSS00A0&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Viking 56K FAX INT */</span>
	<span class="p">{</span>	<span class="s">&quot;RSS0262&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* K56 par,VV,Voice,Speakphone,AudioSpan,PnP */</span>
	<span class="p">{</span>       <span class="s">&quot;RSS0250&quot;</span><span class="p">,</span>              <span class="mi">0</span>       <span class="p">},</span>
	<span class="cm">/* SupraExpress 28.8 Data/Fax PnP modem */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1310&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 336i PnP Voice Modem */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1381&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 33.6 Data/Fax PnP modem */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1421&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 33.6 Data/Fax PnP modem */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1590&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 336i Sp ASVD */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1620&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 33.6 Data/Fax PnP modem */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP1760&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* SupraExpress 56i Sp Intl */</span>
	<span class="p">{</span>	<span class="s">&quot;SUP2171&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Phoebe Micro */</span>
	<span class="cm">/* Phoebe Micro 33.6 Data Fax 1433VQH Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;TEX0011&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Archtek America Corp. */</span>
	<span class="cm">/* Archtek SmartLink Modem 3334BT Plug &amp; Play */</span>
	<span class="p">{</span>	<span class="s">&quot;UAC000F&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* 3Com Corp. */</span>
	<span class="cm">/* Gateway Telepath IIvi 33.6 */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0000&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics Sporster 33.6K Fax INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0002&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*  Sportster Vi 14.4 PnP FAX Voicemail */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0004&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 33.6K Voice INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0006&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 33.6K Voice EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0007&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics Courier V.Everything INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR0009&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 33.6K Voice INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR2002&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR2070&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR2080&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K FAX INT */</span>
	<span class="p">{</span>	<span class="s">&quot;USR3031&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K FAX INT */</span>
	<span class="p">{</span>	<span class="s">&quot;USR3050&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR3070&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice EXT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR3080&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice INT PnP */</span>
	<span class="p">{</span>	<span class="s">&quot;USR3090&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Message  */</span>
	<span class="p">{</span>	<span class="s">&quot;USR9100&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K FAX EXT PnP*/</span>
	<span class="p">{</span>	<span class="s">&quot;USR9160&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K FAX INT PnP*/</span>
	<span class="p">{</span>	<span class="s">&quot;USR9170&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice EXT PnP*/</span>
	<span class="p">{</span>	<span class="s">&quot;USR9180&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* U.S. Robotics 56K Voice INT PnP*/</span>
	<span class="p">{</span>	<span class="s">&quot;USR9190&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Wacom tablets */</span>
	<span class="p">{</span>	<span class="s">&quot;WACFXXX&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Compaq touchscreen */</span>
	<span class="p">{</span>       <span class="s">&quot;FPI2002&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Fujitsu Stylistic touchscreens */</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B2&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B3&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Fujitsu Stylistic LT touchscreens */</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B4&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Passive Fujitsu Stylistic touchscreens */</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B6&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B7&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B8&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02B9&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;FUJ02BC&quot;</span><span class="p">,</span>              <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Fujitsu Wacom Tablet PC device */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ02E5&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu P-series tablet PC device */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ02E6&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu Wacom 2FGT Tablet PC device */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ02E7&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Fujitsu Wacom 1FGT Tablet PC device */</span>
	<span class="p">{</span>	<span class="s">&quot;FUJ02E9&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * LG C1 EXPRESS DUAL (C1-PB11A3) touch screen (actually a FUJ02E6 in</span>
<span class="cm">	 * disguise)</span>
<span class="cm">	 */</span>
	<span class="p">{</span>	<span class="s">&quot;LTS0001&quot;</span><span class="p">,</span>		<span class="mi">0</span>       <span class="p">},</span>
	<span class="cm">/* Rockwell&#39;s (PORALiNK) 33600 INT PNP */</span>
	<span class="p">{</span>	<span class="s">&quot;WCI0003&quot;</span><span class="p">,</span>		<span class="mi">0</span>	<span class="p">},</span>
	<span class="cm">/* Unknown PnP modems */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPCXXX&quot;</span><span class="p">,</span>		<span class="n">UNKNOWN_DEV</span>	<span class="p">},</span>
	<span class="cm">/* More unknown PnP modems */</span>
	<span class="p">{</span>	<span class="s">&quot;PNPDXXX&quot;</span><span class="p">,</span>		<span class="n">UNKNOWN_DEV</span>	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>			<span class="mi">0</span>	<span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">pnp_dev_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modem_names</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;MODEM&quot;</span><span class="p">,</span> <span class="s">&quot;Modem&quot;</span><span class="p">,</span> <span class="s">&quot;modem&quot;</span><span class="p">,</span> <span class="s">&quot;FAX&quot;</span><span class="p">,</span> <span class="s">&quot;Fax&quot;</span><span class="p">,</span> <span class="s">&quot;fax&quot;</span><span class="p">,</span>
	<span class="s">&quot;56K&quot;</span><span class="p">,</span> <span class="s">&quot;56k&quot;</span><span class="p">,</span> <span class="s">&quot;K56&quot;</span><span class="p">,</span> <span class="s">&quot;33.6&quot;</span><span class="p">,</span> <span class="s">&quot;28.8&quot;</span><span class="p">,</span> <span class="s">&quot;14.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;33,600&quot;</span><span class="p">,</span> <span class="s">&quot;28,800&quot;</span><span class="p">,</span> <span class="s">&quot;14,400&quot;</span><span class="p">,</span> <span class="s">&quot;33.600&quot;</span><span class="p">,</span> <span class="s">&quot;28.800&quot;</span><span class="p">,</span> <span class="s">&quot;14.400&quot;</span><span class="p">,</span>
	<span class="s">&quot;33600&quot;</span><span class="p">,</span> <span class="s">&quot;28800&quot;</span><span class="p">,</span> <span class="s">&quot;14400&quot;</span><span class="p">,</span> <span class="s">&quot;V.90&quot;</span><span class="p">,</span> <span class="s">&quot;V.34&quot;</span><span class="p">,</span> <span class="s">&quot;V.32&quot;</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">check_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">modem_names</span><span class="p">;</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">check_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">base</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x2f8</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">,</span> <span class="mh">0x2e8</span><span class="p">,</span> <span class="mh">0x3e8</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">base</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnp_possible_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given a complete unknown PnP device, try to use some heuristics to</span>
<span class="cm"> * detect modems. Currently use such heuristic set:</span>
<span class="cm"> *     - dev-&gt;name or dev-&gt;bus-&gt;name must contain &quot;modem&quot; substring;</span>
<span class="cm"> *     - device must have only one IO region (8 byte long) with base address</span>
<span class="cm"> *       0x2e8, 0x3e8, 0x2f8 or 0x3f8.</span>
<span class="cm"> *</span>
<span class="cm"> * Such detection looks very ugly, but can detect at least some of numerous</span>
<span class="cm"> * PnP modems, alternatively we must hardcode all modems in pnp_devices[]</span>
<span class="cm"> * table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">serial_pnp_guess_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">check_name</span><span class="p">(</span><span class="n">pnp_dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">check_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">serial_pnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNKNOWN_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">serial_pnp_guess_board</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_PORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pnp_mem_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">pnp_mem_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_IOREMAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_PNP</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		<span class="s">&quot;Setup PNP port: port %x, mem 0x%lx, irq %d, type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="p">.</span><span class="n">iobase</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">port</span><span class="p">.</span><span class="n">iotype</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_irq_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_SHAREABLE</span><span class="p">)</span>
		<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">UPF_SHARE_IRQ</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="mi">1843200</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">serial8250_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">serial_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>
		<span class="n">serial8250_unregister_port</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_pnp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">line</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">serial8250_suspend_port</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_pnp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">line</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">serial8250_resume_port</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define serial_pnp_suspend NULL</span>
<span class="cp">#define serial_pnp_resume NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">serial_pnp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">serial_pnp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">serial_pnp_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">serial_pnp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">serial_pnp_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pnp_dev_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">serial8250_pnp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_pnp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">serial8250_pnp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_pnp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">serial8250_pnp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">serial8250_pnp_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic 8250/16x50 PnP serial driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
