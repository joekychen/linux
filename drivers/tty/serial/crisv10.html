<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › crisv10.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>crisv10.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Serial port driver for the ETRAX 100LX chip</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 1998-2007  Axis Communications AB</span>
<span class="cm"> *</span>
<span class="cm"> *    Many, many authors. Based once upon a time on serial.c for 16x50.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_version</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.25 $&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;arch/svinto.h&gt;</span>
<span class="cp">#include &lt;arch/system.h&gt;</span>

<span class="cm">/* non-arch dependent serial structures are in linux/serial.h */</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cm">/* while we keep our own stuff (struct e100_serial) in a local .h file */</span>
<span class="cp">#include &quot;crisv10.h&quot;</span>
<span class="cp">#include &lt;asm/fasttimer.h&gt;</span>
<span class="cp">#include &lt;arch/io_interface_mux.h&gt;</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_FAST_TIMER</span>
<span class="cp">#ifndef CONFIG_ETRAX_FAST_TIMER</span>
<span class="cp">#error &quot;Enable FAST_TIMER to use SERIAL_FAST_TIMER&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS) &amp;&amp; \</span>
<span class="cp">           (CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS == 0)</span>
<span class="cp">#error &quot;RX_TIMEOUT_TICKS == 0 not allowed, use 1&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PA) &amp;&amp; defined(CONFIG_ETRAX_RS485_ON_PORT_G)</span>
<span class="cp">#error &quot;Disable either CONFIG_ETRAX_RS485_ON_PA or CONFIG_ETRAX_RS485_ON_PORT_G&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * All of the compatibilty code so we can compile serial.c against</span>
<span class="cm"> * older kernels is hidden in serial_compat.h</span>
<span class="cm"> */</span>
<span class="cp">#if defined(LOCAL_HEADERS)</span>
<span class="cp">#include &quot;serial_compat.h&quot;</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="cm">/* number of characters left in xmit buffer before we ask for more */</span>
<span class="cp">#define WAKEUP_CHARS 256</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define SERIAL<em>DEBUG</em>INTR</h1>

<h1>define SERIAL<em>DEBUG</em>OPEN</h1>

<h1>define SERIAL<em>DEBUG</em>FLOW</h1>

<h1>define SERIAL<em>DEBUG</em>DATA</h1>

<h1>define SERIAL<em>DEBUG</em>THROTTLE</h1>

<h1>define SERIAL<em>DEBUG</em>IO  /* Debug for Extra control and status pins */</h1>

<h1>define SERIAL<em>DEBUG</em>LINE 0 /* What serport we want to debug */</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/* Enable this to use serial interrupts to handle when you</span>
<span class="cm">   expect the first received event on the serial port to</span>
<span class="cm">   be an error, break or similar. Used to be able to flash IRMA</span>
<span class="cm">   from eLinux */</span>
<span class="cp">#define SERIAL_HANDLE_EARLY_ERRORS</span>

<span class="cm">/* Currently 16 descriptors x 128 bytes = 2048 bytes */</span>
<span class="cp">#define SERIAL_DESCR_BUF_SIZE 256</span>

<span class="cp">#define SERIAL_PRESCALE_BASE 3125000 </span><span class="cm">/* 3.125MHz */</span><span class="cp"></span>
<span class="cp">#define DEF_BAUD_BASE SERIAL_PRESCALE_BASE</span>

<span class="cm">/* We don&#39;t want to load the system with massive fast timer interrupt</span>
<span class="cm"> * on high baudrates so limit it to 250 us (4kHz) */</span>
<span class="cp">#define MIN_FLUSH_TIME_USEC 250</span>

<span class="cm">/* Add an x here to log a lot of timer stuff */</span>
<span class="cp">#define TIMERD(x)</span>
<span class="cm">/* Debug details of interrupt handling */</span>
<span class="cp">#define DINTR1(x)  </span><span class="cm">/* irq on/off, errors */</span><span class="cp"></span>
<span class="cp">#define DINTR2(x)    </span><span class="cm">/* tx and rx */</span><span class="cp"></span>
<span class="cm">/* Debug flip buffer stuff */</span>
<span class="cp">#define DFLIP(x)</span>
<span class="cm">/* Debug flow control and overview of data flow */</span>
<span class="cp">#define DFLOW(x)</span>
<span class="cp">#define DBAUD(x)</span>
<span class="cp">#define DLOG_INT_TRIG(x)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define DEBUG<em>LOG</em>INCLUDED</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef DEBUG_LOG_INCLUDED</span>
<span class="cp">#define DEBUG_LOG(line, string, value)</span>
<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">debug_log_info</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>int line;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define DEBUG_LOG_SIZE 4096</span>

<span class="k">struct</span> <span class="n">debug_log_info</span> <span class="n">debug_log</span><span class="p">[</span><span class="n">DEBUG_LOG_SIZE</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">debug_log_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define DEBUG_LOG(_line, _string, _value) do { \</span>
<span class="cp">  if ((_line) == SERIAL_DEBUG_LINE) {\</span>
<span class="cp">    debug_log_func(_line, _string, _value); \</span>
<span class="cp">  }\</span>
<span class="cp">}while(0)</span>

<span class="kt">void</span> <span class="nf">debug_log_func</span><span class="p">(</span><span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_log_pos</span> <span class="o">&lt;</span> <span class="n">DEBUG_LOG_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_log</span><span class="p">[</span><span class="n">debug_log_pos</span><span class="p">].</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">debug_log</span><span class="p">[</span><span class="n">debug_log_pos</span><span class="p">].</span><span class="n">timer_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_TIMER_DATA</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>debug<em>log[debug</em>log_pos].line = line;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">debug_log</span><span class="p">[</span><span class="n">debug_log_pos</span><span class="p">].</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
		<span class="n">debug_log</span><span class="p">[</span><span class="n">debug_log_pos</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">debug_log_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*printk(string, value);*/</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS</span>
<span class="cm">/* Default number of timer ticks before flushing rx fifo</span>
<span class="cm"> * When using &quot;little data, low latency applications: use 0</span>
<span class="cm"> * When using &quot;much data applications (PPP)&quot; use ~5</span>
<span class="cm"> */</span>
<span class="cp">#define CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS 5</span>
<span class="cp">#endif</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_data_to_ns</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ETRAX_RS485</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_write_rs485</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>


<span class="cp">#define DEF_BAUD 115200   </span><span class="cm">/* 115.2 kbit/s */</span><span class="cp"></span>
<span class="cp">#define STD_FLAGS (ASYNC_BOOT_AUTOCONF | ASYNC_SKIP_TEST)</span>
<span class="cp">#define DEF_RX 0x20  </span><span class="cm">/* or SERIAL_CTRL_W &gt;&gt; 8 */</span><span class="cp"></span>
<span class="cm">/* Default value of tx_ctrl register: has txd(bit 7)=1 (idle) as default */</span>
<span class="cp">#define DEF_TX 0x80  </span><span class="cm">/* or SERIAL_CTRL_B */</span><span class="cp"></span>

<span class="cm">/* offsets from R_SERIALx_CTRL */</span>

<span class="cp">#define REG_DATA 0</span>
<span class="cp">#define REG_DATA_STATUS32 0 </span><span class="cm">/* this is the 32 bit register R_SERIALx_READ */</span><span class="cp"></span>
<span class="cp">#define REG_TR_DATA 0</span>
<span class="cp">#define REG_STATUS 1</span>
<span class="cp">#define REG_TR_CTRL 1</span>
<span class="cp">#define REG_REC_CTRL 2</span>
<span class="cp">#define REG_BAUD 3</span>
<span class="cp">#define REG_XOFF 4  </span><span class="cm">/* this is a 32 bit register */</span><span class="cp"></span>

<span class="cm">/* The bitfields are the same for all serial ports */</span>
<span class="cp">#define SER_RXD_MASK         IO_MASK(R_SERIAL0_STATUS, rxd)</span>
<span class="cp">#define SER_DATA_AVAIL_MASK  IO_MASK(R_SERIAL0_STATUS, data_avail)</span>
<span class="cp">#define SER_FRAMING_ERR_MASK IO_MASK(R_SERIAL0_STATUS, framing_err)</span>
<span class="cp">#define SER_PAR_ERR_MASK     IO_MASK(R_SERIAL0_STATUS, par_err)</span>
<span class="cp">#define SER_OVERRUN_MASK     IO_MASK(R_SERIAL0_STATUS, overrun)</span>

<span class="cp">#define SER_ERROR_MASK (SER_OVERRUN_MASK | SER_PAR_ERR_MASK | SER_FRAMING_ERR_MASK)</span>

<span class="cm">/* Values for info-&gt;errorcode */</span>
<span class="cp">#define ERRCODE_SET_BREAK    (TTY_BREAK)</span>
<span class="cp">#define ERRCODE_INSERT        0x100</span>
<span class="cp">#define ERRCODE_INSERT_BREAK (ERRCODE_INSERT | TTY_BREAK)</span>

<span class="cp">#define FORCE_EOP(info)  *R_SET_EOP = 1U &lt;&lt; info-&gt;iseteop;</span>

<span class="cm">/*</span>
<span class="cm"> * General note regarding the use of IO_* macros in this file:</span>
<span class="cm"> *</span>
<span class="cm"> * We will use the bits defined for DMA channel 6 when using various</span>
<span class="cm"> * IO_* macros (e.g. IO_STATE, IO_MASK, IO_EXTRACT) and _assume_ they are</span>
<span class="cm"> * the same for all channels (which of course they are).</span>
<span class="cm"> *</span>
<span class="cm"> * We will also use the bits defined for serial port 0 when writing commands</span>
<span class="cm"> * to the different ports, as these bits too are the same for all ports.</span>
<span class="cm"> */</span>


<span class="cm">/* Mask for the irqs possibly enabled in R_IRQ_MASK1_RD etc. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e100_ser_int_mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0</span>
<span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser0_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser0_ready</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1</span>
<span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser1_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser1_ready</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2</span>
<span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser2_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser2_ready</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3</span>
<span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser3_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser3_ready</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r_alt_ser_baudrate_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* this is the data for the four serial ports in the etrax100 */</span>
<span class="cm">/*  DMA2(ser2), DMA4(ser3), DMA6(ser0) or DMA8(ser1) */</span>
<span class="cm">/* R_DMA_CHx_CLR_INTR, R_DMA_CHx_FIRST, R_DMA_CHx_CMD */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">e100_serial</span> <span class="n">rs_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">baud</span>        <span class="o">=</span> <span class="n">DEF_BAUD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ioport</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">R_SERIAL0_CTRL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">irq</span>         <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="cm">/* uses DMA 6 and 7 */</span>
	  <span class="p">.</span><span class="n">oclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ofirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH6_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ocmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH6_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ostatusadr</span>  <span class="o">=</span> <span class="n">R_DMA_CH6_STATUS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH7_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ifirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH7_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">icmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH7_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idescradr</span>   <span class="o">=</span> <span class="n">R_DMA_CH7_DESCR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span>       <span class="o">=</span> <span class="n">STD_FLAGS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">rx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_RX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_TX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iseteop</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_owner</span>   <span class="o">=</span> <span class="n">dma_ser0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if</span>       <span class="o">=</span> <span class="n">if_serial_0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0_DMA6_OUT</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">SER0_TX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="n">SER0_DMA_TX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 0 dma tr&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0_DMA7_IN</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">SER0_RX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="n">SER0_DMA_RX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 0 dma rec&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#endif</span>

<span class="p">},</span>  <span class="cm">/* ttyS0 */</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">baud</span>        <span class="o">=</span> <span class="n">DEF_BAUD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ioport</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">R_SERIAL1_CTRL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">irq</span>         <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="cm">/* uses DMA 8 and 9 */</span>
	  <span class="p">.</span><span class="n">oclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH8_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ofirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH8_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ocmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH8_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ostatusadr</span>  <span class="o">=</span> <span class="n">R_DMA_CH8_STATUS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH9_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ifirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH9_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">icmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH9_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idescradr</span>   <span class="o">=</span> <span class="n">R_DMA_CH9_DESCR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span>       <span class="o">=</span> <span class="n">STD_FLAGS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">rx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_RX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_TX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iseteop</span>     <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_owner</span>   <span class="o">=</span> <span class="n">dma_ser1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if</span>       <span class="o">=</span> <span class="n">if_serial_1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="s">&quot;ser1&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1_DMA8_OUT</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">SER1_TX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="n">SER1_DMA_TX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 1 dma tr&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1_DMA9_IN</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">SER1_RX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="n">SER1_DMA_RX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 1 dma rec&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#endif</span>
<span class="p">},</span>  <span class="cm">/* ttyS1 */</span>

	<span class="p">{</span> <span class="p">.</span><span class="n">baud</span>        <span class="o">=</span> <span class="n">DEF_BAUD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ioport</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">R_SERIAL2_CTRL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">irq</span>         <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>  <span class="cm">/* uses DMA 2 and 3 */</span>
	  <span class="p">.</span><span class="n">oclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH2_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ofirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH2_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ocmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH2_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ostatusadr</span>  <span class="o">=</span> <span class="n">R_DMA_CH2_STATUS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH3_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ifirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH3_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">icmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH3_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idescradr</span>   <span class="o">=</span> <span class="n">R_DMA_CH3_DESCR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span>       <span class="o">=</span> <span class="n">STD_FLAGS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">rx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_RX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_TX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iseteop</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_owner</span>   <span class="o">=</span> <span class="n">dma_ser2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if</span>       <span class="o">=</span> <span class="n">if_serial_2</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="s">&quot;ser2&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2_DMA2_OUT</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">SER2_TX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="n">SER2_DMA_TX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 2 dma tr&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2_DMA3_IN</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">SER2_RX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="n">SER2_DMA_RX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 2 dma rec&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#endif</span>
 <span class="p">},</span>  <span class="cm">/* ttyS2 */</span>

	<span class="p">{</span> <span class="p">.</span><span class="n">baud</span>        <span class="o">=</span> <span class="n">DEF_BAUD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ioport</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">R_SERIAL3_CTRL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">irq</span>         <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>  <span class="cm">/* uses DMA 4 and 5 */</span>
	  <span class="p">.</span><span class="n">oclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH4_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ofirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH4_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ocmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH4_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ostatusadr</span>  <span class="o">=</span> <span class="n">R_DMA_CH4_STATUS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iclrintradr</span> <span class="o">=</span> <span class="n">R_DMA_CH5_CLR_INTR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ifirstadr</span>   <span class="o">=</span> <span class="n">R_DMA_CH5_FIRST</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">icmdadr</span>     <span class="o">=</span> <span class="n">R_DMA_CH5_CMD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idescradr</span>   <span class="o">=</span> <span class="n">R_DMA_CH5_DESCR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span>       <span class="o">=</span> <span class="n">STD_FLAGS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">rx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_RX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tx_ctrl</span>     <span class="o">=</span> <span class="n">DEF_TX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">iseteop</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_owner</span>   <span class="o">=</span> <span class="n">dma_ser3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if</span>       <span class="o">=</span> <span class="n">if_serial_3</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="s">&quot;ser3&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3_DMA4_OUT</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">SER3_TX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="n">SER3_DMA_TX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 3 dma tr&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3_DMA5_IN</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">SER3_RX_DMA_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="n">SER3_DMA_RX_IRQ_NBR</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="s">&quot;serial 3 dma rec&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_nbr</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_irq_description</span> <span class="o">=</span> <span class="nb">NULL</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
          <span class="p">.</span><span class="n">enabled</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">io_if_description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span>
<span class="cp">#endif</span>
 <span class="p">}</span>   <span class="cm">/* ttyS3 */</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="cp">#define NR_PORTS (sizeof(rs_table)/sizeof(struct e100_serial))</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_FAST_TIMER</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fast_timer</span> <span class="n">fast_timers</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PROC_ENTRY</span>
<span class="cp">#define PROCSTAT(x) x</span>
<span class="k">struct</span> <span class="n">ser_statistics_type</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">overrun_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">early_errors_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ser_ints_ok_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errors_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">processing_flip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">processing_flip_still_room</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">timeout_flush_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_dma_ints</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_dma_ints</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_tot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_tot</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ser_statistics_type</span> <span class="n">ser_stat</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>

<span class="cp">#else</span>

<span class="cp">#define PROCSTAT(x)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ETRAX_SERIAL_PROC_ENTRY */</span><span class="cp"></span>

<span class="cm">/* RS-485 */</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
<span class="cp">#ifdef CONFIG_ETRAX_FAST_TIMER</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fast_timer</span> <span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PA)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rs485_pa_bit</span> <span class="o">=</span> <span class="n">CONFIG_ETRAX_RS485_ON_PA_BIT</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PORT_G)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rs485_port_g_bit</span> <span class="o">=</span> <span class="n">CONFIG_ETRAX_RS485_ON_PORT_G_BIT</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cm">/* Info and macros needed for each ports extra control/status signals. */</span>
<span class="cp">#define E100_STRUCT_PORT(line, pinname) \</span>
<span class="cp"> ((CONFIG_ETRAX_SER##line##_##pinname##_ON_PA_BIT &gt;= 0)? \</span>
<span class="cp">		(R_PORT_PA_DATA): ( \</span>
<span class="cp"> (CONFIG_ETRAX_SER##line##_##pinname##_ON_PB_BIT &gt;= 0)? \</span>
<span class="cp">		(R_PORT_PB_DATA):&amp;dummy_ser[line]))</span>

<span class="cp">#define E100_STRUCT_SHADOW(line, pinname) \</span>
<span class="cp"> ((CONFIG_ETRAX_SER##line##_##pinname##_ON_PA_BIT &gt;= 0)? \</span>
<span class="cp">		(&amp;port_pa_data_shadow): ( \</span>
<span class="cp"> (CONFIG_ETRAX_SER##line##_##pinname##_ON_PB_BIT &gt;= 0)? \</span>
<span class="cp">		(&amp;port_pb_data_shadow):&amp;dummy_ser[line]))</span>
<span class="cp">#define E100_STRUCT_MASK(line, pinname) \</span>
<span class="cp"> ((CONFIG_ETRAX_SER##line##_##pinname##_ON_PA_BIT &gt;= 0)? \</span>
<span class="cp">		(1&lt;&lt;CONFIG_ETRAX_SER##line##_##pinname##_ON_PA_BIT): ( \</span>
<span class="cp"> (CONFIG_ETRAX_SER##line##_##pinname##_ON_PB_BIT &gt;= 0)? \</span>
<span class="cp">		(1&lt;&lt;CONFIG_ETRAX_SER##line##_##pinname##_ON_PB_BIT):DUMMY_##pinname##_MASK))</span>

<span class="cp">#define DUMMY_DTR_MASK 1</span>
<span class="cp">#define DUMMY_RI_MASK  2</span>
<span class="cp">#define DUMMY_DSR_MASK 4</span>
<span class="cp">#define DUMMY_CD_MASK  8</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dummy_ser</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">};</span>

<span class="cm">/* If not all status pins are used or disabled, use mixed mode */</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0</span>

<span class="cp">#define SER0_PA_BITSUM (CONFIG_ETRAX_SER0_DTR_ON_PA_BIT+CONFIG_ETRAX_SER0_RI_ON_PA_BIT+CONFIG_ETRAX_SER0_DSR_ON_PA_BIT+CONFIG_ETRAX_SER0_CD_ON_PA_BIT)</span>

<span class="cp">#if SER0_PA_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_DTR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER0_RI_ON_PA_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_DSR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_CD_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#define SER0_PB_BITSUM (CONFIG_ETRAX_SER0_DTR_ON_PB_BIT+CONFIG_ETRAX_SER0_RI_ON_PB_BIT+CONFIG_ETRAX_SER0_DSR_ON_PB_BIT+CONFIG_ETRAX_SER0_CD_ON_PB_BIT)</span>

<span class="cp">#if SER0_PB_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_DTR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER0_RI_ON_PB_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_DSR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER0_CD_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* PORT0 */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1</span>

<span class="cp">#define SER1_PA_BITSUM (CONFIG_ETRAX_SER1_DTR_ON_PA_BIT+CONFIG_ETRAX_SER1_RI_ON_PA_BIT+CONFIG_ETRAX_SER1_DSR_ON_PA_BIT+CONFIG_ETRAX_SER1_CD_ON_PA_BIT)</span>

<span class="cp">#if SER1_PA_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_DTR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER1_RI_ON_PA_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_DSR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_CD_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#define SER1_PB_BITSUM (CONFIG_ETRAX_SER1_DTR_ON_PB_BIT+CONFIG_ETRAX_SER1_RI_ON_PB_BIT+CONFIG_ETRAX_SER1_DSR_ON_PB_BIT+CONFIG_ETRAX_SER1_CD_ON_PB_BIT)</span>

<span class="cp">#if SER1_PB_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_DTR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER1_RI_ON_PB_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_DSR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER1_CD_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* PORT1 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2</span>

<span class="cp">#define SER2_PA_BITSUM (CONFIG_ETRAX_SER2_DTR_ON_PA_BIT+CONFIG_ETRAX_SER2_RI_ON_PA_BIT+CONFIG_ETRAX_SER2_DSR_ON_PA_BIT+CONFIG_ETRAX_SER2_CD_ON_PA_BIT)</span>

<span class="cp">#if SER2_PA_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_DTR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER2_RI_ON_PA_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_DSR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_CD_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#define SER2_PB_BITSUM (CONFIG_ETRAX_SER2_DTR_ON_PB_BIT+CONFIG_ETRAX_SER2_RI_ON_PB_BIT+CONFIG_ETRAX_SER2_DSR_ON_PB_BIT+CONFIG_ETRAX_SER2_CD_ON_PB_BIT)</span>

<span class="cp">#if SER2_PB_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_DTR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER2_RI_ON_PB_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_DSR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER2_CD_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* PORT2 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3</span>

<span class="cp">#define SER3_PA_BITSUM (CONFIG_ETRAX_SER3_DTR_ON_PA_BIT+CONFIG_ETRAX_SER3_RI_ON_PA_BIT+CONFIG_ETRAX_SER3_DSR_ON_PA_BIT+CONFIG_ETRAX_SER3_CD_ON_PA_BIT)</span>

<span class="cp">#if SER3_PA_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_DTR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER3_RI_ON_PA_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_DSR_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_CD_ON_PA_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#define SER3_PB_BITSUM (CONFIG_ETRAX_SER3_DTR_ON_PB_BIT+CONFIG_ETRAX_SER3_RI_ON_PB_BIT+CONFIG_ETRAX_SER3_DSR_ON_PB_BIT+CONFIG_ETRAX_SER3_CD_ON_PB_BIT)</span>

<span class="cp">#if SER3_PB_BITSUM != -4</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_DTR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#   endif</span>
<span class="cp"># if CONFIG_ETRAX_SER3_RI_ON_PB_BIT == -1</span>
<span class="cp">#   ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#     define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#   endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_DSR_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#  if CONFIG_ETRAX_SER3_CD_ON_PB_BIT == -1</span>
<span class="cp">#    ifndef CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#      define CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED 1</span>
<span class="cp">#    endif</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* PORT3 */</span><span class="cp"></span>


<span class="cp">#if defined(CONFIG_ETRAX_SER0_DTR_RI_DSR_CD_MIXED) || \</span>
<span class="cp">    defined(CONFIG_ETRAX_SER1_DTR_RI_DSR_CD_MIXED) || \</span>
<span class="cp">    defined(CONFIG_ETRAX_SER2_DTR_RI_DSR_CD_MIXED) || \</span>
<span class="cp">    defined(CONFIG_ETRAX_SER3_DTR_RI_DSR_CD_MIXED)</span>
<span class="cp">#define CONFIG_ETRAX_SERX_DTR_RI_DSR_CD_MIXED</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERX_DTR_RI_DSR_CD_MIXED</span>
<span class="cm">/* The pins can be mixed on PA and PB */</span>
<span class="cp">#define CONTROL_PINS_PORT_NOT_USED(line) \</span>
<span class="cp">  &amp;dummy_ser[line], &amp;dummy_ser[line], \</span>
<span class="cp">  &amp;dummy_ser[line], &amp;dummy_ser[line], \</span>
<span class="cp">  &amp;dummy_ser[line], &amp;dummy_ser[line], \</span>
<span class="cp">  &amp;dummy_ser[line], &amp;dummy_ser[line], \</span>
<span class="cp">  DUMMY_DTR_MASK, DUMMY_RI_MASK, DUMMY_DSR_MASK, DUMMY_CD_MASK</span>


<span class="k">struct</span> <span class="n">control_pins</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dtr_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">dtr_shadow</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ri_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">ri_shadow</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dsr_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">dsr_shadow</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cd_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">cd_shadow</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dtr_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ri_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dsr_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cd_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">control_pins</span> <span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* Ser 0 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 1 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 2 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 3 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>  <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CD</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#else  </span><span class="cm">/* CONFIG_ETRAX_SERX_DTR_RI_DSR_CD_MIXED */</span><span class="cp"></span>

<span class="cm">/* All pins are on either PA or PB for each serial port */</span>
<span class="cp">#define CONTROL_PINS_PORT_NOT_USED(line) \</span>
<span class="cp">  &amp;dummy_ser[line], &amp;dummy_ser[line], \</span>
<span class="cp">  DUMMY_DTR_MASK, DUMMY_RI_MASK, DUMMY_DSR_MASK, DUMMY_CD_MASK</span>


<span class="k">struct</span> <span class="n">control_pins</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>          <span class="o">*</span><span class="n">shadow</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dtr_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ri_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dsr_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cd_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define dtr_port port</span>
<span class="cp">#define dtr_shadow shadow</span>
<span class="cp">#define ri_port port</span>
<span class="cp">#define ri_shadow shadow</span>
<span class="cp">#define dsr_port port</span>
<span class="cp">#define dsr_shadow shadow</span>
<span class="cp">#define cd_port port</span>
<span class="cp">#define cd_shadow shadow</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">control_pins</span> <span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* Ser 0 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT0</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 1 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT1</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 2 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT2</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">},</span>

	<span class="cm">/* Ser 3 */</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_PORT3</span>
	<span class="n">E100_STRUCT_PORT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span> <span class="n">E100_STRUCT_SHADOW</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DTR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">RI</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DSR</span><span class="p">),</span>
	<span class="n">E100_STRUCT_MASK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CD</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">CONTROL_PINS_PORT_NOT_USED</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_ETRAX_SERX_DTR_RI_DSR_CD_MIXED */</span><span class="cp"></span>

<span class="cp">#define E100_RTS_MASK 0x20</span>
<span class="cp">#define E100_CTS_MASK 0x40</span>

<span class="cm">/* All serial port signals are active low:</span>
<span class="cm"> * active   = 0 -&gt; 3.3V to RS-232 driver -&gt; -12V on RS-232 level</span>
<span class="cm"> * inactive = 1 -&gt; 0V   to RS-232 driver -&gt; +12V on RS-232 level</span>
<span class="cm"> *</span>
<span class="cm"> * These macros returns the pin value: 0=0V, &gt;=1 = 3.3V on ETRAX chip</span>
<span class="cm"> */</span>

<span class="cm">/* Output */</span>
<span class="cp">#define E100_RTS_GET(info) ((info)-&gt;rx_ctrl &amp; E100_RTS_MASK)</span>
<span class="cm">/* Input */</span>
<span class="cp">#define E100_CTS_GET(info) ((info)-&gt;ioport[REG_STATUS] &amp; E100_CTS_MASK)</span>

<span class="cm">/* These are typically PA or PB and 0 means 0V, 1 means 3.3V */</span>
<span class="cm">/* Is an output */</span>
<span class="cp">#define E100_DTR_GET(info) ((*e100_modem_pins[(info)-&gt;line].dtr_shadow) &amp; e100_modem_pins[(info)-&gt;line].dtr_mask)</span>

<span class="cm">/* Normally inputs */</span>
<span class="cp">#define E100_RI_GET(info) ((*e100_modem_pins[(info)-&gt;line].ri_port) &amp; e100_modem_pins[(info)-&gt;line].ri_mask)</span>
<span class="cp">#define E100_CD_GET(info) ((*e100_modem_pins[(info)-&gt;line].cd_port) &amp; e100_modem_pins[(info)-&gt;line].cd_mask)</span>

<span class="cm">/* Input */</span>
<span class="cp">#define E100_DSR_GET(info) ((*e100_modem_pins[(info)-&gt;line].dsr_port) &amp; e100_modem_pins[(info)-&gt;line].dsr_mask)</span>

<span class="cm">/* Calculate the chartime depending on baudrate, numbor of bits etc. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_char_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcflag_t</span> <span class="n">cflags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="cm">/* calc. number of bits / data byte */</span>
	<span class="cm">/* databits + startbit and 1 stopbit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflags</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS7</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflags</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>     <span class="cm">/* 2 stopbits ? */</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflags</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>     <span class="cm">/* parity bit ? */</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* calc timeout */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span> <span class="o">=</span> <span class="p">((</span><span class="n">bits</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_time_usec</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_time_usec</span> <span class="o">&lt;</span> <span class="n">MIN_FLUSH_TIME_USEC</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_time_usec</span> <span class="o">=</span> <span class="n">MIN_FLUSH_TIME_USEC</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function maps from the Bxxxx defines in asm/termbits.h into real</span>
<span class="cm"> * baud rates.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cflag_to_baud</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span>
		<span class="mi">4800</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">38400</span> <span class="p">};</span>

	<span class="k">static</span> <span class="kt">int</span> <span class="n">ext_baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">230400</span><span class="p">,</span> <span class="mi">460800</span><span class="p">,</span> <span class="mi">921600</span><span class="p">,</span> <span class="mi">1843200</span><span class="p">,</span> <span class="mi">6250000</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ext_baud_table</span><span class="p">[(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* and this maps to an etrax100 hardware baud constant */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">cflag_to_etrax_baud</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="n">baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="n">ext_baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_baud_table</span><span class="p">[(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;serdriver tried setting invalid baud rate, flags %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cflag</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* choose default 9600 instead */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span> <span class="o">|</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* choose same for both TX and RX */</span>
<span class="p">}</span>


<span class="cm">/* Various static support functions */</span>

<span class="cm">/* Functions to set or clear DTR/RTS on the requested line */</span>
<span class="cm">/* It is complicated by the fact that RTS is a serial port register, while</span>
<span class="cm"> * DTR might not be implemented in the HW at all, and if it is, it can be on</span>
<span class="cm"> * any general port.</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_dtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_mask</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser%i dtr %i mask: 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser%i shadow before 0x%02X get: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_shadow</span><span class="p">,</span>
	       <span class="n">E100_DTR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="cm">/* DTR is active low */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mask</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_port</span> <span class="o">=</span> <span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_shadow</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SERIAL_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser%i shadow after 0x%02X get: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">dtr_shadow</span><span class="p">,</span>
	       <span class="n">E100_DTR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* set = 0 means 3.3V on the pin, bitvalue: 0=active, 1=inactive</span>
<span class="cm"> *                                          0=0V    , 1=3.3V</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E100_RTS_MASK</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">E100_RTS_MASK</span><span class="p">);</span>  <span class="cm">/* RTS is active low */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_REC_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef SERIAL_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser%i rts %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/* If this behaves as a modem, RI and CD is an output */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_ri_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* RI is active low */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ri_mask</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ri_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ri_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mask</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ri_port</span> <span class="o">=</span> <span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ri_shadow</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_cd_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* CD is active low */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">cd_mask</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">cd_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">cd_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mask</span><span class="p">);</span>
		<span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">cd_port</span> <span class="o">=</span> <span class="o">*</span><span class="n">e100_modem_pins</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">cd_shadow</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_disable_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* disable the receiver */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_REC_CTRL</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_enable</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_enable_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* enable the receiver */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_REC_CTRL</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_enable</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* the rx DMA uses both the dma_descr and the dma_eop interrupts */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_disable_rxdma_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rxdma_irq(%d): 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ disable_rxdma_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK2_CLR</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_enable_rxdma_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rxdma_irq(%d): 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ enable_rxdma_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK2_SET</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* the tx DMA uses only dma_descr interrupt */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_disable_txdma_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;txdma_irq(%d): 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ disable_txdma_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK2_CLR</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_enable_txdma_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;txdma_irq(%d): 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ enable_txdma_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK2_SET</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_disable_txdma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Disable output DMA channel for the serial port in question</span>
<span class="cm">	 * ( set to something other than serialX)</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;disable_txdma_channel %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">,</span> <span class="n">serial0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">,</span> <span class="n">unused</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">,</span> <span class="n">serial1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">,</span> <span class="n">usb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">,</span> <span class="n">serial2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">,</span> <span class="n">par0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">,</span> <span class="n">serial3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">,</span> <span class="n">par1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">R_GEN_CONFIG</span> <span class="o">=</span> <span class="n">genconfig_shadow</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_enable_txdma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;enable_txdma_channel %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="cm">/* Enable output DMA channel for the serial port in question */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma6</span><span class="p">,</span> <span class="n">serial0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma8</span><span class="p">,</span> <span class="n">serial1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma2</span><span class="p">,</span> <span class="n">serial2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma4</span><span class="p">,</span> <span class="n">serial3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">R_GEN_CONFIG</span> <span class="o">=</span> <span class="n">genconfig_shadow</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_disable_rxdma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Disable input DMA channel for the serial port in question</span>
<span class="cm">	 * ( set to something other than serialX)</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">,</span> <span class="n">serial0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">,</span> <span class="n">unused</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">,</span> <span class="n">serial1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">,</span> <span class="n">usb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">,</span> <span class="n">serial2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">,</span> <span class="n">par0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">genconfig_shadow</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">,</span> <span class="n">serial3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">);</span>
			<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">,</span> <span class="n">par1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">R_GEN_CONFIG</span> <span class="o">=</span> <span class="n">genconfig_shadow</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_enable_rxdma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Enable input DMA channel for the serial port in question */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma7</span><span class="p">,</span> <span class="n">serial0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma9</span><span class="p">,</span> <span class="n">serial1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma3</span><span class="p">,</span> <span class="n">serial2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">genconfig_shadow</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">);</span>
		<span class="n">genconfig_shadow</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_GEN_CONFIG</span><span class="p">,</span> <span class="n">dma5</span><span class="p">,</span> <span class="n">serial3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">R_GEN_CONFIG</span> <span class="o">=</span> <span class="n">genconfig_shadow</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef SERIAL_HANDLE_EARLY_ERRORS</span>
<span class="cm">/* in order to detect and fix errors on the first byte</span>
<span class="cm">   we have to use the serial interrupts as well. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_disable_serial_data_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_irq(%d): 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ disable data_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK1_CLR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_enable_serial_data_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_irq(%d): 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;**** %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">),</span>
	       <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)));</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ enable data_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK1_SET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_disable_serial_tx_ready_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_tx_irq(%d): 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ disable ready_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK1_CLR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ser_tx_irq(%d): 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;**** %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">),</span>
	       <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">)));</span>
<span class="cp">#endif</span>
	<span class="n">DINTR2</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;IRQ enable ready_irq %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK1_SET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">e100_enable_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span>
		<span class="n">e100_enable_rxdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">e100_enable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">e100_disable_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span>
		<span class="n">e100_disable_rxdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">e100_disable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
<span class="cm">/* Enable RS-485 mode on selected port. This is UGLY. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_enable_rs485</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_rs485</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PA)</span>
	<span class="o">*</span><span class="n">R_PORT_PA_DATA</span> <span class="o">=</span> <span class="n">port_pa_data_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rs485_pa_bit</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PORT_G)</span>
	<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span>  <span class="n">port_g_data_shadow</span><span class="p">,</span>
		       <span class="n">rs485_port_g_bit</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_LTC1387)</span>
	<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span> <span class="n">port_g_data_shadow</span><span class="p">,</span>
		       <span class="n">CONFIG_ETRAX_RS485_LTC1387_DXEN_PORT_G_BIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span> <span class="n">port_g_data_shadow</span><span class="p">,</span>
		       <span class="n">CONFIG_ETRAX_RS485_LTC1387_RXEN_PORT_G_BIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span> <span class="o">=</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Maximum delay before RTS equal to 1000 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">delay_rts_before_send</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">delay_rts_before_send</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

<span class="cm">/*	printk(&quot;rts: on send = %i, after = %i, enabled = %i&quot;,</span>
<span class="cm">		    info-&gt;rs485.rts_on_send,</span>
<span class="cm">		    info-&gt;rs485.rts_after_sent,</span>
<span class="cm">		    info-&gt;rs485.enabled</span>
<span class="cm">	);</span>
<span class="cm">*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_write_rs485</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">;</span>

	<span class="cm">/* rs485 is always implicitly enabled if we&#39;re using the ioctl()</span>
<span class="cm">	 * but it doesn&#39;t have to be set in the serial_rs485</span>
<span class="cm">	 * (to be backward compatible with old apps)</span>
<span class="cm">	 * So we store, set and restore it.</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SER_RS485_ENABLED</span><span class="p">;</span>
	<span class="cm">/* rs_write now deals with RS485 if enabled */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">rs_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_value</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_ENABLED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ETRAX_FAST_TIMER</span>
<span class="cm">/* Timer function to toggle RTS when using FAST_TIMER */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs485_toggle_rts_timer_function</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_RTS_AFTER_SEND</span><span class="p">));</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_DISABLE_RECEIVER)</span>
	<span class="n">e100_enable_rx</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">e100_enable_rx_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ETRAX_RS485 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_stop() and rs_start()</span>
<span class="cm"> *</span>
<span class="cm"> * This routines are called before setting or resetting tty-&gt;stopped.</span>
<span class="cm"> * They enable or disable transmitter using the XOFF registers, as necessary.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xoff</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;XOFF rs_stop xmit %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
					 <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span><span class="n">SERIAL_XMIT_SIZE</span><span class="p">)));</span>

		<span class="n">xoff</span> <span class="o">=</span> <span class="n">IO_FIELD</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">xoff_char</span><span class="p">,</span>
				<span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">tx_stop</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">auto_xoff</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_XOFF</span><span class="p">])</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xoff</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;XOFF rs_start xmit %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
					 <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span><span class="n">SERIAL_XMIT_SIZE</span><span class="p">)));</span>
		<span class="n">xoff</span> <span class="o">=</span> <span class="n">IO_FIELD</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">xoff_char</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">tx_stop</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">auto_xoff</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_XOFF</span><span class="p">])</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span> <span class="o">&amp;&amp;</span>
		    <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
			<span class="n">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ----------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Here starts the interrupt handling routines.  All of the following</span>
<span class="cm"> * subroutines are declared as inline and are folded into</span>
<span class="cm"> * rs_interrupt().  They were separated out for readability&#39;s sake.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: rs_interrupt() is a &quot;fast&quot; interrupt, which means that it</span>
<span class="cm"> * runs with interrupts turned off.  People who may want to modify</span>
<span class="cm"> * rs_interrupt() should try to keep the interrupt handler as fast as</span>
<span class="cm"> * possible.  After you are done making modifications, it is not a bad</span>
<span class="cm"> * idea to do:</span>
<span class="cm"> *</span>
<span class="cm"> * gcc -S -DKERNEL -Wall -Wstrict-prototypes -O6 -fomit-frame-pointer serial.c</span>
<span class="cm"> *</span>
<span class="cm"> * and look at the resulting assemble code in serial.s.</span>
<span class="cm"> *</span>
<span class="cm"> * 				- Ted Ts&#39;o (tytso@mit.edu), 7-Mar-93</span>
<span class="cm"> * -----------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is used by the interrupt handler to schedule</span>
<span class="cm"> * processing in the software interrupt portion of the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_sched_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The output DMA channel is free - use it to send as many chars as possible</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> *   We don&#39;t pay attention to info-&gt;x_char, which means if the TTY wants to</span>
<span class="cm"> *   use XON/XOFF it will set info-&gt;x_char but we won&#39;t send any X char!</span>
<span class="cm"> *</span>
<span class="cm"> *   To implement this, we&#39;d just start a DMA send of 1 byte pointing at a</span>
<span class="cm"> *   buffer containing the X char, and skip updating xmit. We&#39;d also have to</span>
<span class="cm"> *   check if the last sent char was the X char when we enter this function</span>
<span class="cm"> *   the next time, to avoid updating xmit with the sent X value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">transmit_chars_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">sentl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etrax_dma_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* This will output too little if tail is not 0 always since</span>
<span class="cm">	 * we don&#39;t reloop to send the other part. Anyway this SHOULD be a</span>
<span class="cm">	 * no-op - transmit_chars_dma would never really be called during sim</span>
<span class="cm">	 * since rs_write does not write into the xmit buffer then.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error in serial.c:transmit_chars-dma(), tail!=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SIMCOUT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
			<span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
				 <span class="n">SERIAL_XMIT_SIZE</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>  <span class="cm">/* move back head */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* acknowledge both dma_descr and dma_eop irq in R_DMA_CHx_CLR_INTR */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">oclrintradr</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_descr</span><span class="p">,</span> <span class="k">do</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="n">SERIAL_DEBUG_LINE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* weirdo... we shouldn&#39;t get here! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Achtung: transmit_chars_dma with !tr_running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">;</span>

	<span class="cm">/* first get the amount of bytes sent during the last DMA transfer,</span>
<span class="cm">	   and update xmit accordingly */</span>

	<span class="cm">/* if the stop bit was not set, all data has been sent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">d_stop</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sentl</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">sw_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* otherwise we find the amount of data sent here */</span>
		<span class="n">sentl</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hw_len</span><span class="p">;</span>

	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;TX %i done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sentl</span><span class="p">));</span>

	<span class="cm">/* update stats */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">sentl</span><span class="p">;</span>

	<span class="cm">/* update xmit buffer */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="n">sentl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* if there is only a few chars left in the buf, wake up the blocked</span>
<span class="cm">	   write if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
		     <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
		     <span class="n">SERIAL_XMIT_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">rs_sched_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RS_EVENT_WRITE_WAKEUP</span><span class="p">);</span>

	<span class="cm">/* find out the largest amount of consecutive bytes we want to send now */</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">CIRC_CNT_TO_END</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t send all in one DMA transfer - divide it so we wake up</span>
<span class="cm">	 * application before all is sent</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="o">*</span><span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* our job here is done, don&#39;t schedule any new DMA transfer */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485) &amp;&amp; defined(CONFIG_ETRAX_FAST_TIMER)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set a short timer to toggle RTS */</span>
			<span class="n">start_one_shot_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">],</span>
			                     <span class="n">rs485_toggle_rts_timer_function</span><span class="p">,</span>
			                     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">,</span>
			                     <span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
			                     <span class="s">&quot;RS-485&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* RS485 */</span><span class="cp"></span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ok we can schedule a dma send of c chars starting at info-&gt;xmit.tail */</span>
	<span class="cm">/* set up the descriptor correctly for output */</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;TX %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">));</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">d_int</span> <span class="o">|</span> <span class="n">d_eol</span> <span class="o">|</span> <span class="n">d_wait</span><span class="p">;</span> <span class="cm">/* Wait needed for tty_wait_until_sent() */</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">sw_len</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">);</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ofirstadr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">descr</span><span class="p">);</span> <span class="cm">/* write to R_DMAx_FIRST */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

	<span class="cm">/* DMA is now running (hopefully) */</span>
<span class="p">}</span> <span class="cm">/* transmit_chars_dma */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">start_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (info-&gt;line == SERIAL_DEBUG_LINE)</span>
<span class="c">		printk(&quot;x\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">sw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">hw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span>
		<span class="n">transmit_chars_dma</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* start_transmit */</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_FAST_TIMER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serial_fast_timer_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serial_fast_timer_expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_timeout_function</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#define START_FLUSH_FAST_TIMER_TIME(info, string, usec) {\</span>
<span class="cp">  unsigned long timer_flags; \</span>
<span class="cp">  local_irq_save(timer_flags); \</span>
<span class="cp">  if (fast_timers[info-&gt;line].function == NULL) { \</span>
<span class="cp">    serial_fast_timer_started++; \</span>
<span class="cp">    TIMERD(DEBUG_LOG(info-&gt;line, &quot;start_timer %i &quot;, info-&gt;line)); \</span>
<span class="cp">    TIMERD(DEBUG_LOG(info-&gt;line, &quot;num started: %i\n&quot;, serial_fast_timer_started)); \</span>
<span class="cp">    start_one_shot_timer(&amp;fast_timers[info-&gt;line], \</span>
<span class="cp">                         flush_timeout_function, \</span>
<span class="cp">                         (unsigned long)info, \</span>
<span class="cp">                         (usec), \</span>
<span class="cp">                         string); \</span>
<span class="cp">  } \</span>
<span class="cp">  else { \</span>
<span class="cp">    TIMERD(DEBUG_LOG(info-&gt;line, &quot;timer %i already running\n&quot;, info-&gt;line)); \</span>
<span class="cp">  } \</span>
<span class="cp">  local_irq_restore(timer_flags); \</span>
<span class="cp">}</span>
<span class="cp">#define START_FLUSH_FAST_TIMER(info, string) START_FLUSH_FAST_TIMER_TIME(info, string, info-&gt;flush_time_usec)</span>

<span class="cp">#else</span>
<span class="cp">#define START_FLUSH_FAST_TIMER_TIME(info, string, usec)</span>
<span class="cp">#define START_FLUSH_FAST_TIMER(info, string)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span>
<span class="nf">alloc_recv_buffer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">append_recv_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">+=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">add_char_and_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alloc_recv_buffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">append_recv_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">handle_descr_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">etrax_dma_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">+</span> <span class="n">recvl</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;%s: Too much pending incoming serial data! Dropping %u bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">recvl</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">recvl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">==</span> <span class="n">ERRCODE_SET_BREAK</span><span class="p">)</span>
		<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">append_recv_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alloc_recv_buffer</span><span class="p">(</span><span class="n">SERIAL_DESCR_BUF_SIZE</span><span class="p">)))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Failed to allocate memory for receive buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">recvl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">handle_all_descr_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etrax_dma_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recvl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rec_descr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_rec_descr</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idescradr</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_rec_descr</span> <span class="o">==</span> <span class="n">SERIAL_RECV_DESCRIPTORS</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_rec_descr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* find out how many bytes were read */</span>

		<span class="cm">/* if the eop bit was not set, all data has been received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">d_eop</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">recvl</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">sw_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* otherwise we find the amount of data received here */</span>
			<span class="n">recvl</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hw_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Reset the status information */</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DFLOW</span><span class="p">(</span>  <span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;RX %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">recvl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;rx 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;rx 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;rx 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="p">);</span>

		<span class="cm">/* update stats */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">recvl</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">+=</span> <span class="n">handle_descr_data</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">recvl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_chars_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* No receive in the simulator.  Will probably be when the rest of</span>
<span class="cm">	 * the serial interface works, and this piece will just be removed.</span>
<span class="cm">	 */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Acknowledge both dma_descr and dma_eop irq in R_DMA_CHx_CLR_INTR */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">iclrintradr</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_descr</span><span class="p">,</span> <span class="k">do</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="cm">/* Something wrong... */</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_HANDLE_EARLY_ERRORS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span>
		<span class="n">e100_enable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">==</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">)</span>
		<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>

	<span class="n">handle_all_descr_data</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Read the status register to detect errors */</span>
	<span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_STATUS</span><span class="p">,</span> <span class="n">xoff_detect</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;XOFF detect stat %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rstat</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we got an error, we must reset it by reading the</span>
<span class="cm">		 * data_in field</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA</span><span class="p">];</span>

		<span class="n">PROCSTAT</span><span class="p">(</span><span class="n">ser_stat</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">errors_cnt</span><span class="o">++</span><span class="p">);</span>
		<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;#dERR: s d 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">((</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_ERROR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_PAR_ERR_MASK</span><span class="p">)</span>
			<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_PARITY</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_OVERRUN_MASK</span><span class="p">)</span>
			<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_FRAMING_ERR_MASK</span><span class="p">)</span>
			<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">START_FLUSH_FAST_TIMER</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;receive_chars&quot;</span><span class="p">);</span>

	<span class="cm">/* Restart the receiving DMA */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_recv_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">etrax_dma_descr</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rec_descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set up the receiving descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SERIAL_RECV_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alloc_recv_buffer</span><span class="p">(</span><span class="n">SERIAL_DESCR_BUF_SIZE</span><span class="p">)))</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Failed to allocate memory for receive buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">d_int</span><span class="p">;</span>
		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sw_len</span> <span class="o">=</span> <span class="n">SERIAL_DESCR_BUF_SIZE</span><span class="p">;</span>
		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Link the last descriptor to the first */</span>
	<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Start with the first descriptor in the list */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_rec_descr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Start the DMA */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ifirstadr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_rec_descr</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

	<span class="cm">/* Input DMA should be running now */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">start_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* No receive in the simulator.  Will probably be when the rest of</span>
<span class="cm">	 * the serial interface works, and this piece will just be removed.</span>
<span class="cm">	 */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset the input dma channel to be sure it works */</span>

		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">IO_STATE_VALUE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">));</span>

		<span class="n">start_recv_dma</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* the bits in the MASK2 register are laid out like this:</span>
<span class="cm">   DMAI_EOP DMAI_DESCR DMAO_EOP DMAO_DESCR</span>
<span class="cm">   where I is the input channel and O is the output channel for the port.</span>
<span class="cm">   info-&gt;irq is the bit number for the DMAO_DESCR so to check the others we</span>
<span class="cm">   shift info-&gt;irq to the left.</span>
<span class="cm">*/</span>

<span class="cm">/* dma output channel interrupt handler</span>
<span class="cm">   this interrupt is called from DMA2(ser2), DMA4(ser3), DMA6(ser0) or</span>
<span class="cm">   DMA8(ser1) when they have finished a descriptor with the intr flag set.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">tr_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ireg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* No receive in the simulator.  Will probably be when the rest of</span>
<span class="cm">	 * the serial interface works, and this piece will just be removed.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;What? tr_interrupt in simulator??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">SIMCOUT</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* find out the line that caused this irq and get it from rs_table */</span>

	<span class="n">ireg</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_IRQ_MASK2_RD</span><span class="p">;</span>  <span class="cm">/* get the active irq bits for the dma channels */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* check for dma_descr (don&#39;t need to check for dma_eop in output dma for serial */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* we can send a new dma bunch. make it so. */</span>
			<span class="n">DINTR2</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tr_interrupt %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="cm">/* Read jiffies_usec first,</span>
<span class="cm">			 * we want this time to be as late as possible</span>
<span class="cm">			 */</span>
 			<span class="n">PROCSTAT</span><span class="p">(</span><span class="n">ser_stat</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">tx_dma_ints</span><span class="o">++</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">transmit_chars_dma</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* FIXME: here we should really check for a change in the</span>
<span class="cm">		   status lines and if so call status_handle(info) */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* tr_interrupt */</span>

<span class="cm">/* dma input channel interrupt handler */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">rec_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ireg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* No receive in the simulator.  Will probably be when the rest of</span>
<span class="cm">	 * the serial interface works, and this piece will just be removed.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&quot;What? rec_interrupt in simulator??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">SIMCOUT</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* find out the line that caused this irq and get it from rs_table */</span>

	<span class="n">ireg</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_IRQ_MASK2_RD</span><span class="p">;</span>  <span class="cm">/* get the active irq bits for the dma channels */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* check for both dma_eop and dma_descr for the input dma channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* we have received something */</span>
			<span class="n">receive_chars_dma</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* FIXME: here we should really check for a change in the</span>
<span class="cm">		   status lines and if so call status_handle(info) */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* rec_interrupt */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">force_eop_if_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We check data_avail bit to determine if data has</span>
<span class="cm">	 * arrived since last time</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>

	<span class="cm">/* error or datavail? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Some error has occurred. If there has been valid data, an</span>
<span class="cm">		 * EOP interrupt will be made automatically. If no data, the</span>
<span class="cm">		 * normal ser_interrupt should be enabled and handle it.</span>
<span class="cm">		 * So do nothing!</span>
<span class="cm">		 */</span>
		<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;timeout err: rstat 0x%03X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">rstat</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_DATA_AVAIL_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ok data, no error, count it */</span>
		<span class="n">TIMERD</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;timeout: rstat 0x%03X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">rstat</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="cm">/* Read data to clear status flags */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA</span><span class="p">];</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">forced_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">START_FLUSH_FAST_TIMER</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;magic&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hit the timeout, force an EOP for the input</span>
<span class="cm">	 * dma channel if we haven&#39;t already</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">forced_eop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">forced_eop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">PROCSTAT</span><span class="p">(</span><span class="n">ser_stat</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">timeout_flush_cnt</span><span class="o">++</span><span class="p">);</span>
		<span class="n">TIMERD</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;timeout EOP %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
		<span class="n">FORCE_EOP</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_to_flip_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* This includes a check for low-latency */</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_flush_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flip what we&#39;ve got (if we can) */</span>
	<span class="n">flush_to_flip_buffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* We might need to flip later, but not to fast</span>
<span class="cm">	 * since the system is busy processing input... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span><span class="p">)</span>
		<span class="n">START_FLUSH_FAST_TIMER_TIME</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;flip&quot;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="cm">/* Force eop last, since data might have come while we&#39;re processing</span>
<span class="cm">	 * and if we started the slow timer above, we won&#39;t start a fast</span>
<span class="cm">	 * below.</span>
<span class="cm">	 */</span>
	<span class="n">force_eop_if_needed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_FAST_TIMER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_timeout_function</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fast_timers</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">serial_fast_timer_expired</span><span class="o">++</span><span class="p">;</span>
	<span class="n">TIMERD</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;flush_timout %i &quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="n">TIMERD</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;num expired: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_fast_timer_expired</span><span class="p">));</span>
	<span class="n">check_flush_timeout</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/* dma fifo/buffer timeout handler</span>
<span class="cm">   forces an end-of-packet for the dma input channel if no chars</span>
<span class="cm">   have been received for CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS/100 s.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">flush_timer</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">timed_flush_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span>
			<span class="n">check_flush_timeout</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* restart flush timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flush_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">CONFIG_ETRAX_SERIAL_RX_TIMEOUT_TICKS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SERIAL_HANDLE_EARLY_ERRORS</span>

<span class="cm">/* If there is an error (ie break) when the DMA is running and</span>
<span class="cm"> * there are no bytes in the fifo the DMA is stopped and we get no</span>
<span class="cm"> * eop interrupt. Thus we have to monitor the first bytes on a DMA</span>
<span class="cm"> * transfer, and if it is without error we can turn the serial</span>
<span class="cm"> * interrupts off.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">BREAK handling on ETRAX 100:</span>
<span class="cm">ETRAX will generate interrupt although there is no stop bit between the</span>
<span class="cm">characters.</span>

<span class="cm">Depending on how long the break sequence is, the end of the breaksequence</span>
<span class="cm">will look differently:</span>
<span class="cm">| indicates start/end of a character.</span>

<span class="cm">B= Break character (0x00) with framing error.</span>
<span class="cm">E= Error byte with parity error received after B characters.</span>
<span class="cm">F= &quot;Faked&quot; valid byte received immediately after B characters.</span>
<span class="cm">V= Valid byte</span>

<span class="cm">1.</span>
<span class="cm">    B          BL         ___________________________ V</span>
<span class="cm">.._|__________|__________|                           |valid data |</span>

<span class="cm">Multiple frame errors with data == 0x00 (B),</span>
<span class="cm">the timing matches up &quot;perfectly&quot; so no extra ending char is detected.</span>
<span class="cm">The RXD pin is 1 in the last interrupt, in that case</span>
<span class="cm">we set info-&gt;errorcode = ERRCODE_INSERT_BREAK, but we can&#39;t really</span>
<span class="cm">know if another byte will come and this really is case 2. below</span>
<span class="cm">(e.g F=0xFF or 0xFE)</span>
<span class="cm">If RXD pin is 0 we can expect another character (see 2. below).</span>


<span class="cm">2.</span>

<span class="cm">    B          B          E or F__________________..__ V</span>
<span class="cm">.._|__________|__________|______    |                 |valid data</span>
<span class="cm">                          &quot;valid&quot; or</span>
<span class="cm">                          parity error</span>

<span class="cm">Multiple frame errors with data == 0x00 (B),</span>
<span class="cm">but the part of the break trigs is interpreted as a start bit (and possibly</span>
<span class="cm">some 0 bits followed by a number of 1 bits and a stop bit).</span>
<span class="cm">Depending on parity settings etc. this last character can be either</span>
<span class="cm">a fake &quot;valid&quot; char (F) or have a parity error (E).</span>

<span class="cm">If the character is valid it will be put in the buffer,</span>
<span class="cm">we set info-&gt;errorcode = ERRCODE_SET_BREAK so the receive interrupt</span>
<span class="cm">will set the flags so the tty will handle it,</span>
<span class="cm">if it&#39;s an error byte it will not be put in the buffer</span>
<span class="cm">and we set info-&gt;errorcode = ERRCODE_INSERT_BREAK.</span>

<span class="cm">To distinguish a V byte in 1. from an F byte in 2. we keep a timestamp</span>
<span class="cm">of the last faulty char (B) and compares it with the current time:</span>
<span class="cm">If the time elapsed time is less then 2*char_time_usec we will assume</span>
<span class="cm">it&#39;s a faked F char and not a Valid char and set</span>
<span class="cm">info-&gt;errorcode = ERRCODE_SET_BREAK.</span>

<span class="cm">Flaws in the above solution:</span>
<span class="cm">~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm">We use the timer to distinguish a F character from a V character,</span>
<span class="cm">if a V character is to close after the break we might make the wrong decision.</span>

<span class="cm">TODO: The break will be delayed until an F or V character is received.</span>

<span class="cm">*/</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="nf">handle_ser_rx_interrupt_no_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_read</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;!NO TTY!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read data and status at the same time */</span>
	<span class="n">data_read</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA_STATUS32</span><span class="p">]);</span>
<span class="nl">more_data:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">xoff_detect</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;XOFF detect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">DINTR2</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx   %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">data_read</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">framing_err</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">par_err</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">overrun</span><span class="p">)</span> <span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* An error */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx err stat_data %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_read</span><span class="p">));</span>
		<span class="n">DLOG_INT_TRIG</span><span class="p">(</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">log_int_trig1_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log_int_trig1_pos</span> <span class="o">=</span> <span class="n">log_int_pos</span><span class="p">;</span>
			<span class="n">log_int</span><span class="p">(</span><span class="n">rdpc</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_in</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">framing_err</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Most likely a break, but we get interrupts over and</span>
<span class="cm">			 * over again.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;#BRK start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">rxd</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* The RX pin is high now, so the break</span>
<span class="cm">				 * must be over, but....</span>
<span class="cm">				 * we can&#39;t really know if we will get another</span>
<span class="cm">				 * last byte ending the break or not.</span>
<span class="cm">				 * And we don&#39;t know if the byte (if any) will</span>
<span class="cm">				 * have an error or look valid.</span>
<span class="cm">				 */</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;# BL BRK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The error does not look like a break, but could be</span>
<span class="cm">			 * the end of one</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;EBRK %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="o">=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span>
					<span class="n">data_in</span><span class="p">,</span> <span class="n">data_read</span><span class="p">);</span>
				<span class="kt">char</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">==</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">par_err</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">overrun</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_OVERRUN</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">framing_err</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_avail</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No error */</span>
		<span class="n">DLOG_INT_TRIG</span><span class="p">(</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">log_int_trig1_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">log_int_pos</span> <span class="o">&gt;=</span> <span class="n">log_int_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">log_int_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">log_int_trig0_pos</span> <span class="o">=</span> <span class="n">log_int_pos</span><span class="p">;</span>
			<span class="n">log_int</span><span class="p">(</span><span class="n">rdpc</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">);</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
			<span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">data_read</span><span class="p">),</span>
			<span class="n">TTY_NORMAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx int but no data_avail  %08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_read</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">data_read</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA_STATUS32</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_read</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_avail</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx   %c in loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_SERIAL0_READ</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">data_read</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">more_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">e100_serial</span><span class="o">*</span> <span class="nf">handle_ser_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Interrupt from serport %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cm">/*	DEBUG_LOG(info-&gt;line, &quot;ser_interrupt stat %03X\n&quot;, rstat | (i &lt;&lt; 8)); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">handle_ser_rx_interrupt_no_dma</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* DMA is used */</span>
	<span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_STATUS</span><span class="p">,</span> <span class="n">xoff_detect</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;XOFF detect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="cm">/* If we got an error, we must reset it by reading the</span>
<span class="cm">		 * data_in field</span>
<span class="cm">		 */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA</span><span class="p">];</span>
		<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx!  %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
		<span class="n">DINTR1</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx err stat %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rstat</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_FRAMING_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Most likely a break, but we get interrupts over and</span>
<span class="cm">			 * over again.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;#BRK start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_RXD_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* The RX pin is high now, so the break</span>
<span class="cm">				 * must be over, but....</span>
<span class="cm">				 * we can&#39;t really know if we will get another</span>
<span class="cm">				 * last byte ending the break or not.</span>
<span class="cm">				 * And we don&#39;t know if the byte (if any) will</span>
<span class="cm">				 * have an error or look valid.</span>
<span class="cm">				 */</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;# BL BRK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The error does not look like a break, but could be</span>
<span class="cm">			 * the end of one</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;EBRK %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">==</span> <span class="n">ERRCODE_INSERT_BREAK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
					<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_PAR_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
					<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_PARITY</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_OVERRUN_MASK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
					<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_FRAMING_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
					<span class="n">add_char_and_flag</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;#iERR s d %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			          <span class="p">((</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">SER_ERROR_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">PROCSTAT</span><span class="p">(</span><span class="n">ser_stat</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">early_errors_cnt</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* It was a valid byte, now let the DMA do the rest */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time_u</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Detect if this character is a new valid char or the</span>
<span class="cm">			 * last char in a break sequence: If LSBits are 0 and</span>
<span class="cm">			 * MSBits are high AND the time is close to the</span>
<span class="cm">			 * previous interrupt we should discard it.</span>
<span class="cm">			 */</span>
			<span class="kt">long</span> <span class="n">elapsed_usec</span> <span class="o">=</span>
			  <span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">curr_time_u</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_rx_active_usec</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">elapsed_usec</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;FBRK %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
				<span class="cm">/* Report as BREAK (error) and let</span>
<span class="cm">				 * receive_chars_dma() handle it</span>
<span class="cm">				 */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">errorcode</span> <span class="o">=</span> <span class="n">ERRCODE_SET_BREAK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;Not end of BRK (V)%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;num brk %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;** OK, disabling ser_interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">e100_disable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">DINTR2</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ser_rx OK %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">break_detected_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">PROCSTAT</span><span class="p">(</span><span class="n">ser_stat</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ser_ints_ok_cnt</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Restarting the DMA never hurts */</span>
	<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>
	<span class="n">START_FLUSH_FAST_TIMER</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;ser_int&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* handle_ser_rx_interrupt */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ser_tx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span><span class="p">;</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tx_int: xchar 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">));</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;stat %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rstat</span><span class="p">));</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_TR_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* We must enable since it is disabled in ser_interrupt */</span>
		<span class="n">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* We only use normal tx interrupt when sending x_char */</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tx_int: xchar sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;stat %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rstat</span><span class="p">));</span>
		<span class="n">e100_disable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
			<span class="n">rs_stop</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
		<span class="cm">/* Enable the DMA channel and tell it to continue */</span>
		<span class="n">e100_enable_txdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="cm">/* Wait 12 cycles before doing the DMA command */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">nop</span><span class="p">();</span>

		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">continue</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Normal char-by-char interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span>
	    <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span>
	    <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tx_int: stopped %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">));</span>
		<span class="n">e100_disable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DINTR2</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tx_int %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">]));</span>
	<span class="cm">/* Send a byte, rs485 timing is critical so turn of ints */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_TR_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485) &amp;&amp; defined(CONFIG_ETRAX_FAST_TIMER)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set a short timer to toggle RTS */</span>
			<span class="n">start_one_shot_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">],</span>
			                     <span class="n">rs485_toggle_rts_timer_function</span><span class="p">,</span>
			                     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">,</span>
			                     <span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
			                     <span class="s">&quot;RS-485&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* RS485 */</span><span class="cp"></span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">e100_disable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;tx_int: stop2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We must enable since it is disabled in ser_interrupt */</span>
		<span class="n">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
		     <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
		     <span class="n">SERIAL_XMIT_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">rs_sched_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">RS_EVENT_WRITE_WAKEUP</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* handle_ser_tx_interrupt */</span>

<span class="cm">/* result of time measurements:</span>
<span class="cm"> * RX duration 54-60 us when doing something, otherwise 6-9 us</span>
<span class="cm"> * ser_int duration: just sending: 8-15 us normally, up to 73 us</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ser_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask1_rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">0</span><span class="p">));</span> <span class="cm">/* ser0 data_avail */</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reentered_ready_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">irq_mask1_rd</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">;</span>
	<span class="cm">/* First handle all rx interrupts with ints disabled */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span><span class="p">;</span>
	<span class="n">irq_mask1_rd</span> <span class="o">&amp;=</span> <span class="n">e100_ser_int_mask</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Which line caused the data irq? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_mask1_rd</span> <span class="o">&amp;</span> <span class="n">data_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">handle_ser_rx_interrupt</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data_mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Handle tx interrupts with interrupts enabled so we</span>
<span class="cm">	 * can take care of new data interrupts while transmitting</span>
<span class="cm">	 * We protect the tx part with the tx_started flag.</span>
<span class="cm">	 * We disable the tr_ready interrupts we are about to handle and</span>
<span class="cm">	 * unblock the serial interrupt so new serial interrupts may come.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we get a new interrupt:</span>
<span class="cm">	 *  - it migth be due to synchronous serial ports.</span>
<span class="cm">	 *  - serial irq will be blocked by general irq handler.</span>
<span class="cm">	 *  - async data will be handled above (sync will be ignored).</span>
<span class="cm">	 *  - tx_started flag will prevent us from trying to send again and</span>
<span class="cm">	 *    we will exit fast - no need to unblock serial irq.</span>
<span class="cm">	 *  - Next (sync) serial interrupt handler will be runned with</span>
<span class="cm">	 *    disabled interrupt due to restore_flags() at end of function,</span>
<span class="cm">	 *    so sync handler will not be preempted or reentered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ready_mask</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>
		<span class="n">tx_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Only the tr_ready interrupts left */</span>
		<span class="n">irq_mask1_rd</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser0_ready</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser1_ready</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser2_ready</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser3_ready</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">irq_mask1_rd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable those we are about to handle */</span>
			<span class="o">*</span><span class="n">R_IRQ_MASK1_CLR</span> <span class="o">=</span> <span class="n">irq_mask1_rd</span><span class="p">;</span>
			<span class="cm">/* Unblock the serial interrupt */</span>
			<span class="o">*</span><span class="n">R_VECT_MASK_SET</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_VECT_MASK_SET</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

			<span class="n">local_irq_enable</span><span class="p">();</span>
			<span class="n">ready_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">0</span><span class="p">));</span> <span class="cm">/* ser0 tr_ready */</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Which line caused the ready irq? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irq_mask1_rd</span> <span class="o">&amp;</span> <span class="n">ready_mask</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">handle_ser_tx_interrupt</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">info</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ready_mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* handle_ser_tx_interrupt enables tr_ready interrupts */</span>
			<span class="n">local_irq_disable</span><span class="p">();</span>
			<span class="cm">/* Handle reentered TX interrupt */</span>
			<span class="n">irq_mask1_rd</span> <span class="o">=</span> <span class="n">reentered_ready_mask</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ready_mask</span><span class="p">;</span>
		<span class="n">ready_mask</span> <span class="o">=</span> <span class="n">irq_mask1_rd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser0_ready</span><span class="p">)</span> <span class="o">|</span>
					     <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser1_ready</span><span class="p">)</span> <span class="o">|</span>
					     <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser2_ready</span><span class="p">)</span> <span class="o">|</span>
					     <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_IRQ_MASK1_RD</span><span class="p">,</span> <span class="n">ser3_ready</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reentered_ready_mask</span> <span class="o">|=</span> <span class="n">ready_mask</span><span class="p">;</span>
			<span class="cm">/* Disable those we are about to handle */</span>
			<span class="o">*</span><span class="n">R_IRQ_MASK1_CLR</span> <span class="o">=</span> <span class="n">ready_mask</span><span class="p">;</span>
			<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">SERIAL_DEBUG_LINE</span><span class="p">,</span> <span class="s">&quot;ser_int reentered with TX %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ready_mask</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* ser_interrupt */</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * -------------------------------------------------------------------</span>
<span class="cm"> * Here ends the serial interrupt routines.</span>
<span class="cm"> * -------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is used to handle the &quot;bottom half&quot; processing for the</span>
<span class="cm"> * serial driver, known also the &quot;software interrupt&quot; processing.</span>
<span class="cm"> * This processing is done at the kernel interrupt level, after the</span>
<span class="cm"> * rs_interrupt() has returned, BUT WITH INTERRUPTS TURNED ON.  This</span>
<span class="cm"> * is where time-consuming activities which can not be done in the</span>
<span class="cm"> * interrupt driver proper are done; the interrupt driver schedules</span>
<span class="cm"> * them using rs_sched_event(), and they get done here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">do_softint</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">e100_serial</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">RS_EVENT_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xmit_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">xmit_page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xmit_page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if it was already initialized, skip this */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">xmit_page</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">xmit_page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">xmit_page</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;starting up ttyS%d (xmit_buf 0x%p)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* Bits and pieces collected from below.  Better to have them</span>
<span class="cm">	   in one ifdef:ed clause than to mix in a lot of ifdefs,</span>
<span class="cm">	   right? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SERIAL_RECV_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rec_descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* No real action in the simulator, but may set info important</span>
<span class="cm">	   to ioctl. */</span>
	<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#else</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them</span>
<span class="cm">	 * (they will be reenabled in change_speed())</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the DMA channels and make sure their interrupts are cleared</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e100_enable_rxdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>

		<span class="cm">/* Wait until reset cycle is complete */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">IO_STATE_VALUE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">));</span>

		<span class="cm">/* Make sure the irqs are cleared */</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">iclrintradr</span> <span class="o">=</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_descr</span><span class="p">,</span> <span class="k">do</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e100_disable_rxdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e100_enable_txdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">IO_STATE_VALUE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">));</span>

		<span class="cm">/* Make sure the irqs are cleared */</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">oclrintradr</span> <span class="o">=</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_descr</span><span class="p">,</span> <span class="k">do</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e100_disable_txdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SERIAL_RECV_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rec_descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and set the speed and other flags of the serial port</span>
<span class="cm">	 * this will start the rx/tx as well</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef SERIAL_HANDLE_EARLY_ERRORS</span>
	<span class="n">e100_enable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* dummy read to reset any serial errors */</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_DATA</span><span class="p">];</span>

	<span class="cm">/* enable the interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span>
		<span class="n">e100_enable_txdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">e100_enable_rx_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* to be sure we don&#39;t lock up the transmitter */</span>

	<span class="cm">/* setup the dma input descriptor and start dma */</span>

	<span class="n">start_receive</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* for safety, make sure the descriptors last result is 0 bytes written */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">sw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">hw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_descr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* enable RTS/DTR last */</span>

	<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">e100_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SVINTO_SIM */</span><span class="cp"></span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port; interrupts are disabled, and</span>
<span class="cm"> * DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etrax_dma_descr</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rec_descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">etrax_recv_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* shut down the transmitter and receiver */</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;shutdown %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
	<span class="n">e100_disable_rx</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_TR_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>

	<span class="cm">/* disable interrupts, reset dma channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_disable_rxdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e100_disable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_disable_txdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e100_disable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SVINTO_SIM */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Shutting down serial port %d (irq %d)....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SERIAL_RECV_DESCRIPTORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* hang up DTR and RTS if HUPCL is enabled */</span>
		<span class="n">e100_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* could check CRTSCTS before doing this */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* change baud rate and other assorted parameters */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xoff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* first some safety checks */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* possibly, the tx/rx should be disabled first to do this safely */</span>

	<span class="cm">/* change baud-rate and write it to the hardware */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Special baudrate */</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* Each port has 8 bits */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alt_source</span> <span class="o">=</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_rec</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_tr</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>
		<span class="cm">/* R_ALT_SER_BAUDRATE selects the source */</span>
		<span class="n">DBAUD</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Custom baudrate: baud_base/divisor %lu/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">==</span> <span class="n">SERIAL_PRESCALE_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 0, 2-65535 (0=65536) */</span>
			<span class="n">u16</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
			<span class="cm">/* R_SERIAL_PRESCALE (upper 16 bits of R_CLOCK_PRESCALE) */</span>
			<span class="cm">/* baudrate is 3.125MHz/custom_divisor */</span>
			<span class="n">alt_source</span> <span class="o">=</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_rec</span><span class="p">,</span> <span class="n">prescale</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_tr</span><span class="p">,</span> <span class="n">prescale</span><span class="p">);</span>
			<span class="n">alt_source</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
			<span class="n">DBAUD</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Writing SERIAL_PRESCALE: divisor %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">divisor</span><span class="p">));</span>
			<span class="o">*</span><span class="n">R_SERIAL_PRESCALE</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">SERIAL_PRESCALE_BASE</span><span class="o">/</span><span class="n">divisor</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ETRAX_EXTERN_PB6CLK_ENABLED</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="o">==</span><span class="n">CONFIG_ETRAX_EXTERN_PB6CLK_FREQ</span><span class="o">/</span><span class="mi">8</span> <span class="o">&amp;&amp;</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="o">==</span><span class="n">CONFIG_ETRAX_EXTERN_PB6CLK_FREQ</span> <span class="o">&amp;&amp;</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* ext_clk selected */</span>
				<span class="n">alt_source</span> <span class="o">=</span>
					<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_rec</span><span class="p">,</span> <span class="k">extern</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_tr</span><span class="p">,</span> <span class="k">extern</span><span class="p">);</span>
				<span class="n">DBAUD</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;using external baudrate: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CONFIG_ETRAX_EXTERN_PB6CLK_FREQ</span><span class="o">/</span><span class="mi">8</span><span class="p">));</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">CONFIG_ETRAX_EXTERN_PB6CLK_FREQ</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="cm">/* Bad baudbase, we don&#39;t support using timer0</span>
<span class="cm">			 * for baudrate.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Bad baud_base/custom_divisor: %lu/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r_alt_ser_baudrate_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">r_alt_ser_baudrate_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="n">alt_source</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
		<span class="o">*</span><span class="n">R_ALT_SER_BAUDRATE</span> <span class="o">=</span> <span class="n">r_alt_ser_baudrate_shadow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Normal baudrate */</span>
		<span class="cm">/* Make sure we use normal baudrate */</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* Each port has 8 bits */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alt_source</span> <span class="o">=</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_rec</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_ALT_SER_BAUDRATE</span><span class="p">,</span> <span class="n">ser0_tr</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>
		<span class="n">r_alt_ser_baudrate_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">r_alt_ser_baudrate_shadow</span> <span class="o">|=</span> <span class="p">(</span><span class="n">alt_source</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
		<span class="o">*</span><span class="n">R_ALT_SER_BAUDRATE</span> <span class="o">=</span> <span class="n">r_alt_ser_baudrate_shadow</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SVINTO_SIM */</span><span class="cp"></span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">cflag_to_baud</span><span class="p">(</span><span class="n">cflag</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_BAUD</span><span class="p">]</span> <span class="o">=</span> <span class="n">cflag_to_etrax_baud</span><span class="p">(</span><span class="n">cflag</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SVINTO_SIM */</span><span class="cp"></span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* start with default settings and then fill in changes */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* 8 bit, no/even parity */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_bitnr</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_par_en</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_par</span><span class="p">));</span>

	<span class="cm">/* 8 bit, no/even parity, 1 stop bit, no cts */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_bitnr</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_par_en</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_par</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">auto_cts</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS7</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set 7 bit mode */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_bitnr</span><span class="p">,</span> <span class="n">tr_7bit</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_bitnr</span><span class="p">,</span> <span class="n">rec_7bit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set 2 stop bit mode */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">stop_bits</span><span class="p">,</span> <span class="n">two_bits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable parity */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_par_en</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_par_en</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable stick parity, PARODD mean Mark which matches ETRAX */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_stick_par</span><span class="p">,</span> <span class="n">stick</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_stick_par</span><span class="p">,</span> <span class="n">stick</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set odd parity (or Mark if CMSPAR) */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_par</span><span class="p">,</span> <span class="n">odd</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_par</span><span class="p">,</span> <span class="n">odd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable automatic CTS handling */</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;FLOW auto_cts enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">auto_cts</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* make sure the tx and rx are enabled */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_TR_CTRL</span><span class="p">,</span> <span class="n">tr_enable</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_REC_CTRL</span><span class="p">,</span> <span class="n">rec_enable</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="cm">/* actually write the control regs to the hardware */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_TR_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_REC_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">;</span>
	<span class="n">xoff</span> <span class="o">=</span> <span class="n">IO_FIELD</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">xoff_char</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">));</span>
	<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">tx_stop</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;FLOW XOFF enabled 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)));</span>
		<span class="n">xoff</span> <span class="o">|=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_SERIAL0_XOFF</span><span class="p">,</span> <span class="n">auto_xoff</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_XOFF</span><span class="p">])</span> <span class="o">=</span> <span class="n">xoff</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_SVINTO_SIM */</span><span class="cp"></span>

	<span class="n">update_char_time</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* change_speed */</span>

<span class="cm">/* start transmitting chars NOW */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">||</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_FLOW</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_flush_chars</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* this protection might not exactly be necessary here */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">start_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_raw_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">c</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* first some sanity checks */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_DATA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="n">SERIAL_DEBUG_LINE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_raw_write (%d), status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">count</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">]);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SVINTO_SIM</span>
	<span class="cm">/* Really simple.  The output is here and now. */</span>
	<span class="n">SIMCOUT</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">local_save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;write count %i &quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;ldisc %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">)));</span>


	<span class="cm">/* The local_irq_disable/restore_flags pairs below are needed</span>
<span class="cm">	 * because the DMA interrupt handler moves the info-&gt;xmit values.</span>
<span class="cm">	 * the memcpy needs to be in the critical region unfortunately,</span>
<span class="cm">	 * because we need to read xmit values, memcpy, write xmit values</span>
<span class="cm">	 * in one atomic operation... this could perhaps be avoided by</span>
<span class="cm">	 * more clever design.</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">CIRC_SPACE_TO_END</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
					      <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
					      <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">)</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* enable transmitter if not running, unless the tty is stopped</span>
<span class="cm">	 * this does not need IRQ protection since if tr_running == 0</span>
<span class="cm">	 * the IRQ&#39;s are not running anyway for this port.</span>
<span class="cm">	 */</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;write ret %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* raw_raw_write() */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* If we are in RS-485 mode, we need to toggle RTS and disable</span>
<span class="cm">		 * the receiver before initiating a DMA transfer</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_ETRAX_FAST_TIMER</span>
		<span class="cm">/* Abort any started timer */</span>
		<span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">del_fast_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fast_timers_rs485</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_RTS_ON_SEND</span><span class="p">));</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_DISABLE_RECEIVER)</span>
		<span class="n">e100_disable_rx</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">e100_enable_rx_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">delay_rts_before_send</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">delay_rts_before_send</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ETRAX_RS485 */</span><span class="cp"></span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">rs_raw_write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="cm">/* If we are in RS-485 mode the following has to be done:</span>
<span class="cm">		 * wait until DMA is ready</span>
<span class="cm">		 * wait on transmit shift register</span>
<span class="cm">		 * toggle RTS</span>
<span class="cm">		 * enable the receiver</span>
<span class="cm">		 */</span>

		<span class="cm">/* Sleep until all sent */</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ETRAX_FAST_TIMER</span>
		<span class="cm">/* Now sleep a little more so that shift register is empty */</span>
		<span class="n">schedule_usleep</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* wait on transmit shift register */</span>
		<span class="k">do</span><span class="p">{</span>
			<span class="n">get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TIOCSER_TEMT</span><span class="p">));</span>

		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_RTS_AFTER_SEND</span><span class="p">));</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485_DISABLE_RECEIVER)</span>
		<span class="n">e100_enable_rx</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">e100_enable_rxdma_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ETRAX_RS485 */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* rs_write */</span>


<span class="cm">/* how much space is available in the xmit buffer? */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">CIRC_SPACE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* How many chars are in the xmit buffer?</span>
<span class="cm"> * This does not include any chars in the transmitter FIFO.</span>
<span class="cm"> * Use wait_until_sent for waiting for FIFO drain.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* discard everything in the xmit buffer */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to send a high-priority XON/XOFF character to</span>
<span class="cm"> * the device</span>
<span class="cm"> *</span>
<span class="cm"> * Since we use DMA we don&#39;t check for info-&gt;x_char in transmit_chars_dma(),</span>
<span class="cm"> * but we do it in handle_ser_tx_interrupt().</span>
<span class="cm"> * We disable DMA channel and enable tx ready interrupt and write the</span>
<span class="cm"> * character when possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Put the DMA on hold and disable the channel */</span>
		<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">hold</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ocmdadr</span><span class="p">)</span> <span class="o">!=</span>
		       <span class="n">IO_STATE_VALUE</span><span class="p">(</span><span class="n">R_DMA_CH6_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">hold</span><span class="p">));</span>
		<span class="n">e100_disable_txdma_channel</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Must make sure transmitter is not stopped before we can transmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="n">rs_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Enable manual transmit interrupt and send from there */</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;rs_send_xchar 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">e100_enable_serial_tx_ready_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_throttle()</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the upper-layer tty layer to signal that</span>
<span class="cm"> * incoming characters should be throttled.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_THROTTLE</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;throttle %s: %lu....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;rs_throttle %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">)));</span>

	<span class="cm">/* Do RTS before XOFF since XOFF might take some time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn off RTS line */</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">rs_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_THROTTLE</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unthrottle %s: %lu....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;rs_unthrottle ldisc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">)));</span>
	<span class="n">DFLOW</span><span class="p">(</span><span class="n">DEBUG_LOG</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;rs_unthrottle flip.count: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">flip</span><span class="p">.</span><span class="n">count</span><span class="p">));</span>
	<span class="cm">/* Do RTS before XOFF since XOFF might take some time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Assert RTS line  */</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_ioctl() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span> <span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* this is all probably wrong, there are a lot of fields</span>
<span class="cm">	 * here that we don&#39;t have in e100_serial and maybe we</span>
<span class="cm">	 * should set them to something else than 0.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">closing_wait</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="n">old_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">old_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_USR_MASK</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">check_and_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, past this point, all the error checking has been done.</span>
<span class="cm">	 * At this point, we start making changes.....</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">check_and_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting. This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elapsed_usec</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span> <span class="o">+</span>
		<span class="n">curr_time_usec</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">||</span>
	    <span class="n">elapsed_usec</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SERIAL_DEBUG_IO</span>
<span class="k">struct</span> <span class="n">state_str</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">state_str</span> <span class="n">control_state_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">TIOCM_DTR</span><span class="p">,</span> <span class="s">&quot;DTR&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_RTS</span><span class="p">,</span> <span class="s">&quot;RTS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_ST</span><span class="p">,</span> <span class="s">&quot;ST?&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_SR</span><span class="p">,</span> <span class="s">&quot;SR?&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_CTS</span><span class="p">,</span> <span class="s">&quot;CTS&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_CD</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_RI</span><span class="p">,</span> <span class="s">&quot;RI&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">TIOCM_DSR</span><span class="p">,</span> <span class="s">&quot;DSR&quot;</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">get_control_state_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">MLines</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">control_state_str</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MLines</span> <span class="o">&amp;</span> <span class="n">control_state_str</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">control_state_str</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Go to manual mode and set the txd pin to 0 */</span>
		<span class="cm">/* Clear bit 7 (txd) and 6 (tr_enable) */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">&amp;=</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set bit 7 (txd) and 6 (tr_enable) */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_TR_CTRL</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">e100_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Handle FEMALE behaviour */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RI</span><span class="p">)</span>
		<span class="n">e100_ri_out</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>
		<span class="n">e100_cd_out</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">e100_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Handle FEMALE behaviour */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RI</span><span class="p">)</span>
		<span class="n">e100_ri_out</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>
		<span class="n">e100_cd_out</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span>
		<span class="p">(</span><span class="o">!</span><span class="n">E100_RTS_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_DTR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_RI_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_DSR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_CD_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_CTS_GET</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef SERIAL_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ser%i: modem state: %i 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

		<span class="n">get_control_state_str</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;state: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERCONFIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGWILD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERSWILD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGSTRUCT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="k">return</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="k">return</span> <span class="n">set_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>: <span class="cm">/* Get line status register */</span>
		<span class="k">return</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">TIOCSERGSTRUCT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span>
				 <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
	<span class="k">case</span> <span class="n">TIOCSERSETRS485</span>:
	<span class="p">{</span>
		<span class="cm">/* In this ioctl we still use the old structure</span>
<span class="cm">		 * rs485_control for backward compatibility</span>
<span class="cm">		 * (if we use serial_rs485, then old user-level code</span>
<span class="cm">		 * wouldn&#39;t work anymore...).</span>
<span class="cm">		 * The use of this ioctl is deprecated: use TIOCSRS485</span>
<span class="cm">		 * instead.*/</span>
		<span class="k">struct</span> <span class="n">rs485_control</span> <span class="n">rs485ctrl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">serial_rs485</span> <span class="n">rs485data</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;The use of this ioctl is deprecated. Use TIOCSRS485 instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs485ctrl</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rs485_control</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rs485ctrl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">rs485data</span><span class="p">.</span><span class="n">delay_rts_before_send</span> <span class="o">=</span> <span class="n">rs485ctrl</span><span class="p">.</span><span class="n">delay_rts_before_send</span><span class="p">;</span>
		<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs485ctrl</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SER_RS485_ENABLED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_ENABLED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs485ctrl</span><span class="p">.</span><span class="n">rts_on_send</span><span class="p">)</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SER_RS485_RTS_ON_SEND</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_RTS_ON_SEND</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs485ctrl</span><span class="p">.</span><span class="n">rts_after_sent</span><span class="p">)</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SER_RS485_RTS_AFTER_SEND</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs485data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_RTS_AFTER_SEND</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">e100_enable_rs485</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs485data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">TIOCSRS485</span>:
	<span class="p">{</span>
		<span class="cm">/* This is the new version of TIOCSRS485, with new</span>
<span class="cm">		 * data structure serial_rs485 */</span>
		<span class="k">struct</span> <span class="n">serial_rs485</span> <span class="n">rs485data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs485data</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rs485_control</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rs485data</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">e100_enable_rs485</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs485data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">TIOCGRS485</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">serial_rs485</span> <span class="o">*</span><span class="n">rs485data</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">);</span>
		<span class="cm">/* This is the ioctl to get RS485 data from user-space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">serial_rs485</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span>
					<span class="n">rs485data</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">serial_rs485</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">TIOCSERWRRS485</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">rs485_write</span> <span class="n">rs485wr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs485wr</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rs485_write</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rs485wr</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">e100_write_rs485</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">rs485wr</span><span class="p">.</span><span class="n">outc</span><span class="p">,</span> <span class="n">rs485wr</span><span class="p">.</span><span class="n">outc_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_close()</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called when the serial port gets closed.  First, we</span>
<span class="cm"> * wait for the last remaining data to be sent.  Then, we unlink its</span>
<span class="cm"> * S structure from the interrupt chain if necessary, and we free</span>
<span class="cm"> * that IRQ if nothing is left in the chain.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rs_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* interrupts are disabled for this entire function */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[%d] rs_close ttyS%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Uh, oh.  tty-&gt;count is 1, which means that the tty</span>
<span class="cm">		 * structure will be freed.  Info-&gt;count should always</span>
<span class="cm">		 * be one in these conditions.  If it&#39;s greater than</span>
<span class="cm">		 * one, we&#39;ve got real problems, since it means the</span>
<span class="cm">		 * serial port won&#39;t be shutdown.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;rs_close: bad serial port count; tty-&gt;count is 1, &quot;</span>
		       <span class="s">&quot;info-&gt;count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rs_close: bad serial port count for ttyS%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CLOSING</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Save the termios structure, since this port may have</span>
<span class="cm">	 * separate termios for callout and dialin.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">normal_termios</span> <span class="o">=</span> <span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now we wait for the transmit buffer to clear; and we notify</span>
<span class="cm">	 * the line discipline to only process XON/XOFF characters.</span>
<span class="cm">	 */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">!=</span> <span class="n">ASYNC_CLOSING_WAIT_NONE</span><span class="p">)</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">closing_wait</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point we stop accepting input.  To do this, we</span>
<span class="cm">	 * disable the serial receiver and the DMA receive interrupt.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef SERIAL_HANDLE_EARLY_ERRORS</span>
	<span class="n">e100_disable_serial_data_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
	<span class="n">e100_disable_rx</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">e100_disable_rx_irq</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Before we drop DTR, make sure the UART transmitter</span>
<span class="cm">		 * has completely drained; this is especially</span>
<span class="cm">		 * important as we have a transmit FIFO!</span>
<span class="cm">		 */</span>
		<span class="n">rs_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="o">|</span><span class="n">ASYNC_CLOSING</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* port closed */</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SER_RS485_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_ENABLED</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PA)</span>
		<span class="o">*</span><span class="n">R_PORT_PA_DATA</span> <span class="o">=</span> <span class="n">port_pa_data_shadow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rs485_pa_bit</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PORT_G)</span>
		<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span> <span class="n">port_g_data_shadow</span><span class="p">,</span>
			       <span class="n">rs485_port_g_bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_LTC1387)</span>
		<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span> <span class="n">port_g_data_shadow</span><span class="p">,</span>
			       <span class="n">CONFIG_ETRAX_RS485_LTC1387_DXEN_PORT_G_BIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_SHADOW_SET</span><span class="p">(</span><span class="n">R_PORT_G_DATA</span><span class="p">,</span> <span class="n">port_g_data_shadow</span><span class="p">,</span>
			       <span class="n">CONFIG_ETRAX_RS485_LTC1387_RXEN_PORT_G_BIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release any allocated DMA irq&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_nbr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DMA irq &#39;%s&#39; freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_nbr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DMA irq &#39;%s&#39; freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_wait_until_sent() --- wait until the transmitter is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">curr_time_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
	<span class="kt">long</span> <span class="n">elapsed_usec</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">curr_time_usec</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check R_DMA_CHx_STATUS bit 0-6=number of available bytes in FIFO</span>
<span class="cm">	 * R_DMA_CHx_HWSW bit 31-16=nbr of bytes left in DMA buffer (0=64k)</span>
<span class="cm">	 */</span>
	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">||</span> <span class="cm">/* More in send queue */</span>
	       <span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ostatusadr</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">)</span> <span class="o">||</span>  <span class="cm">/* more in FIFO */</span>
	       <span class="p">(</span><span class="n">elapsed_usec</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">char_time_usec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">curr_time_usec</span> <span class="o">=</span> <span class="n">GET_JIFFIES_USEC</span><span class="p">();</span>
		<span class="n">elapsed_usec</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">curr_time_usec</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">rs_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_open() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">block_til_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">do_clocal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device is in the middle of being closed, then block</span>
<span class="cm">	 * until it&#39;s done, and then try again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible_tty</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">,</span>
			<span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">));</span>
<span class="cp">#ifdef SERIAL_DO_RESTART</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If non-blocking mode is set, or the port is not enabled,</span>
<span class="cm">	 * then make the check up front and then exit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_clocal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Block waiting for the carrier detect and the line to become</span>
<span class="cm">	 * free (i.e., not in use by the callout).  While we are in</span>
<span class="cm">	 * this loop, info-&gt;count is dropped by one, so that</span>
<span class="cm">	 * rs_close() knows when to free things.  We restore it upon</span>
<span class="cm">	 * exit, either normal or abnormal.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;block_til_ready before block: ttyS%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">extra_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* assert RTS and DTR */</span>
		<span class="n">e100_rts</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">e100_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DO_RESTART</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">do_clocal</span><span class="p">)</span>
			<span class="cm">/* &amp;&amp; (do_clocal || DCD_IS_ASSERTED) */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;block_til_ready blocking: ttyS%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">tty_unlock</span><span class="p">();</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">tty_lock</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra_count</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;block_til_ready after blocking: ttyS%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deinit_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_nbr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_nbr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.</span>
<span class="cm"> * It performs the serial-specific initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">rs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e100_serial</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">allocated_resources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;[%d] rs_open %s, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
 	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the port is in the middle of closing, bail out now</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible_tty</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">,</span>
			<span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">));</span>
<span class="cp">#ifdef SERIAL_DO_RESTART</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If DMA is enabled try to allocate the irq&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">allocated_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_nbr</span><span class="p">,</span>
					<span class="n">rec_interrupt</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_flags</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">,</span>
					<span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA irq &#39;%s&#39; busy; &quot;</span>
					<span class="s">&quot;falling back to non-DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
				<span class="cm">/* Make sure we never try to use DMA in */</span>
				<span class="cm">/* for the port again. */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cris_request_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_nbr</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">,</span>
					<span class="n">DMA_VERBOSE_ON_ERROR</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_owner</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA &#39;%s&#39; busy; &quot;</span>
					<span class="s">&quot;falling back to non-DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
				<span class="cm">/* Make sure we never try to use DMA in */</span>
				<span class="cm">/* for the port again. */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DMA irq &#39;%s&#39; allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_in_irq_description</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_nbr</span><span class="p">,</span>
					       <span class="n">tr_interrupt</span><span class="p">,</span>
					       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_flags</span><span class="p">,</span>
					       <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">,</span>
					       <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA irq &#39;%s&#39; busy; &quot;</span>
					<span class="s">&quot;falling back to non-DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
				<span class="cm">/* Make sure we never try to use DMA out */</span>
				<span class="cm">/* for the port again. */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cris_request_dma</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_nbr</span><span class="p">,</span>
					     <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">,</span>
					     <span class="n">DMA_VERBOSE_ON_ERROR</span><span class="p">,</span>
					     <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_owner</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_nbr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA &#39;%s&#39; busy; &quot;</span>
					<span class="s">&quot;falling back to non-DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
				<span class="cm">/* Make sure we never try to use DMA out */</span>
				<span class="cm">/* for the port again. */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DMA irq &#39;%s&#39; allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_out_irq_description</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start up the serial port</span>
<span class="cm">	 */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">allocated_resources</span><span class="p">)</span>
			<span class="n">deinit_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* FIXME Decrease count info-&gt;count here too? */</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">retval</span> <span class="o">=</span> <span class="n">block_til_ready</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_open returning after block_til_ready with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">retval</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">allocated_resources</span><span class="p">)</span>
			<span class="n">deinit_port</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPLIT_TERMIOS</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">normal_termios</span><span class="p">;</span>
		<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_open ttyS%d successful...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DLOG_INT_TRIG</span><span class="p">(</span> <span class="n">log_int_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DFLIP</span><span class="p">(</span>	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="n">SERIAL_DEBUG_LINE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/*</span>
<span class="cm"> * /proc fs routines....</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d: uart:E100 port:%lX irq:%d&quot;</span><span class="p">,</span>
		   <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_UNKNOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; baud:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; tx:%lu rx:%lu&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; tx_pend:%lu/%lu&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SERIAL_XMIT_SIZE</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rx_pend:%lu/%lu&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span><span class="p">);</span>

<span class="cp">#if 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; stopped:%i&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hw_stopped:%i&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rstat</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">[</span><span class="n">REG_STATUS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rstat</span> <span class="o">&amp;</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_SERIAL0_STATUS</span><span class="p">,</span> <span class="n">xoff_detect</span><span class="p">))</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; xoff_detect:1&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Last thing is the RS-232 status lines</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_RTS_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|RTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_CTS_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|CTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_DTR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|DTR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_DSR_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|DSR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_CD_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|CD&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E100_RI_GET</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;|RI&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">crisv10_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;serinfo:1.0 driver:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_version</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">seq_line_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG_LOG_INCLUDED</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">debug_log_pos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-4i %lu.%lu &quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">debug_log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span><span class="p">,</span>
			 <span class="n">timer_data_to_ns</span><span class="p">(</span><span class="n">debug_log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timer_data</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">debug_log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">,</span> <span class="n">debug_log</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;debug_log %i/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">DEBUG_LOG_SIZE</span><span class="p">);</span>
	<span class="n">debug_log_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">crisv10_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">crisv10_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">crisv10_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">crisv10_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="cm">/* Finally, routines used to initialize the serial driver. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_serial_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;ETRAX 100LX serial-driver %s, &quot;</span>
	       <span class="s">&quot;(c) 2000-2004 Axis Communications AB</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">serial_version</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span> <span class="cm">/* &quot;$Revision: x.yy&quot; */</span>
<span class="p">}</span>

<span class="cm">/* rs_init inits the driver at boot (using the module_init chain) */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">rs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">rs_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">rs_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">rs_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">rs_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">rs_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">rs_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">rs_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">rs_throttle</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">rs_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">rs_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">rs_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">rs_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">rs_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">rs_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">rs_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">rs_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">rs_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">rs_tiocmset</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crisv10_proc_fops</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e100_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_PORTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">show_serial_version</span><span class="p">();</span>

	<span class="cm">/* Setup the timed flush handler system */</span>

<span class="cp">#if !defined(CONFIG_ETRAX_SERIAL_FAST_TIMER)</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flush_timer</span><span class="p">,</span> <span class="n">timed_flush_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flush_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PA)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cris_io_interface_allocate_pins</span><span class="p">(</span><span class="n">if_serial_0</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="n">rs485_pa_bit</span><span class="p">,</span>
			<span class="n">rs485_pa_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ETRAX100LX serial: Could not allocate &quot;</span>
			<span class="s">&quot;RS485 pin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ETRAX_RS485_ON_PORT_G)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cris_io_interface_allocate_pins</span><span class="p">(</span><span class="n">if_serial_0</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="n">rs485_pa_bit</span><span class="p">,</span>
			<span class="n">rs485_port_g_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ETRAX100LX serial: Could not allocate &quot;</span>
			<span class="s">&quot;RS485 pin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>

	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;serial&quot;</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
		<span class="n">B115200</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span> <span class="cm">/* is normally B9600 default... */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>

	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_ops</span><span class="p">);</span>
        <span class="n">serial_driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* do some initializing for the separate ports */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">rs_table</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cris_request_io_interface</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_if</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">io_if_description</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ETRAX100LX async serial: &quot;</span>
					<span class="s">&quot;Could not allocate IO pins for &quot;</span>
					<span class="s">&quot;%s, port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">io_if_description</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">uses_dma_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_ETRAX</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tr_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">forced_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">DEF_BAUD_BASE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">blocked_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">normal_termios</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">first_recv_buffer</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_recv_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">recv_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_tx_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ETRAX_RS485)</span>
		<span class="cm">/* Set sane defaults */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_RTS_ON_SEND</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SER_RS485_RTS_AFTER_SEND</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">delay_rts_before_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rs485</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SER_RS485_ENABLED</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">do_softint</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d at %p is a builtin UART with DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ETRAX_FAST_TIMER</span>
<span class="cp">#ifdef CONFIG_ETRAX_SERIAL_FAST_TIMER</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fast_timers</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fast_timers</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ETRAX_RS485</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fast_timers_rs485</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fast_timers_rs485</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">fast_timer_init</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_SVINTO_SIM</span>
<span class="cp">#ifndef CONFIG_ETRAX_KGDB</span>
	<span class="cm">/* Not needed in simulator.  May only complicate stuff. */</span>
	<span class="cm">/* hook the irq&#39;s for DMA channel 6 and 7, serial output and input, and some more... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">SERIAL_IRQ_NBR</span><span class="p">,</span> <span class="n">ser_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;serial &quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Failed to request irq8&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SVINTO_SIM */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this makes sure that rs_init is called during kernel boot */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rs_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
