<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › 68328serial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>68328serial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* 68328serial.c: Serial port driver for 68328 microcontroller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995       David S. Miller    &lt;davem@caip.rutgers.edu&gt;</span>
<span class="cm"> * Copyright (C) 1998       Kenneth Albanowski &lt;kjahds@kjahds.com&gt;</span>
<span class="cm"> * Copyright (C) 1998, 1999 D. Jeff Dionne     &lt;jeff@uclinux.org&gt;</span>
<span class="cm"> * Copyright (C) 1999       Vladimir Gurevich  &lt;vgurevic@cisco.com&gt;</span>
<span class="cm"> * Copyright (C) 2002-2003  David McCullough   &lt;davidm@snapgear.com&gt;</span>
<span class="cm"> * Copyright (C) 2002       Greg Ungerer       &lt;gerg@snapgear.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * VZ Support/Fixes             Evan Stawnyczy &lt;e@lineo.ca&gt;</span>
<span class="cm"> * Multiple UART support        Daniel Potts &lt;danielp@cse.unsw.edu.au&gt;</span>
<span class="cm"> * Power management support     Daniel Potts &lt;danielp@cse.unsw.edu.au&gt;</span>
<span class="cm"> * VZ Second Serial Port enable Phil Wilshire</span>
<span class="cm"> * 2.4/2.5 port                 David McCullough</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/dbg.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/keyboard.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* (es) */</span>
<span class="cm">/* note: perhaps we can murge these files, so that you can just</span>
<span class="cm"> * 	 define 1 of them, and they can sort that out for themselves</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_M68EZ328)</span>
<span class="cp">#include &lt;asm/MC68EZ328.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#if defined(CONFIG_M68VZ328)</span>
<span class="cp">#include &lt;asm/MC68VZ328.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;asm/MC68328.h&gt;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_M68VZ328 */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_M68EZ328 */</span><span class="cp"></span>

<span class="cm">/* Turn off usage of real serial interrupt code, to &quot;support&quot; Copilot */</span>
<span class="cp">#ifdef CONFIG_XCOPILOT_BUGS</span>
<span class="cp">#undef USE_INTS</span>
<span class="cp">#else</span>
<span class="cp">#define USE_INTS</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * I believe this is the optimal setting that reduces the number of interrupts.</span>
<span class="cm"> * At high speeds the output might become a little &quot;bursted&quot; (use USTCNT_TXHE</span>
<span class="cm"> * if that bothers you), but in most cases it will not, since we try to</span>
<span class="cm"> * transmit characters every time rs_interrupt is called. Thus, quite often</span>
<span class="cm"> * you&#39;ll see that a receive interrupt occures before the transmit one.</span>
<span class="cm"> *                                  -- Vladimir Gurevich</span>
<span class="cm"> */</span>
<span class="cp">#define USTCNT_TX_INTR_MASK (USTCNT_TXEE)</span>

<span class="cm">/*</span>
<span class="cm"> * 68328 and 68EZ328 UARTS are a little bit different. EZ328 has special</span>
<span class="cm"> * &quot;Old data interrupt&quot; which occures whenever the data stay in the FIFO</span>
<span class="cm"> * longer than 30 bits time. This allows us to use FIFO without compromising</span>
<span class="cm"> * latency. &#39;328 does not have this feature and without the real  328-based</span>
<span class="cm"> * board I would assume that RXRE is the safest setting.</span>
<span class="cm"> *</span>
<span class="cm"> * For EZ328 I use RXHE (Half empty) interrupt to reduce the number of</span>
<span class="cm"> * interrupts. RXFE (receive queue full) causes the system to lose data</span>
<span class="cm"> * at least at 115200 baud</span>
<span class="cm"> *</span>
<span class="cm"> * If your board is busy doing other stuff, you might consider to use</span>
<span class="cm"> * RXRE (data ready intrrupt) instead.</span>
<span class="cm"> *</span>
<span class="cm"> * The other option is to make these INTR masks run-time configurable, so</span>
<span class="cm"> * that people can dynamically adapt them according to the current usage.</span>
<span class="cm"> *                                  -- Vladimir Gurevich</span>
<span class="cm"> */</span>

<span class="cm">/* (es) */</span>
<span class="cp">#if defined(CONFIG_M68EZ328) || defined(CONFIG_M68VZ328)</span>
<span class="cp">#define USTCNT_RX_INTR_MASK (USTCNT_RXHE | USTCNT_ODEN)</span>
<span class="cp">#elif defined(CONFIG_M68328)</span>
<span class="cp">#define USTCNT_RX_INTR_MASK (USTCNT_RXRE)</span>
<span class="cp">#else</span>
<span class="cp">#error Please, define the Rx interrupt events for your CPU</span>
<span class="cp">#endif</span>
<span class="cm">/* (/es) */</span>

<span class="cm">/*</span>
<span class="cm"> * This is our internal structure for each serial port&#39;s state.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span>		<span class="n">tport</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">is_cons</span><span class="p">;</span>	<span class="cm">/* Is this our console. */</span>
	<span class="kt">int</span>			<span class="n">magic</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">baud_base</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>		<span class="cm">/* UART type */</span>
	<span class="kt">int</span>			<span class="n">custom_divisor</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">x_char</span><span class="p">;</span>		<span class="cm">/* xon/xoff character */</span>
	<span class="kt">int</span>			<span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xmit_buf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">xmit_head</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">xmit_tail</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">xmit_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SERIAL_MAGIC 0x5301</span>

<span class="cm">/*</span>
<span class="cm"> * Define the number of ports supported and their irqs.</span>
<span class="cm"> */</span>
<span class="cp">#define NR_PORTS 1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m68k_serial</span> <span class="n">m68k_soft</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uart_irqs</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UART_IRQ_NUM</span> <span class="p">};</span>

<span class="cm">/* multiple ports are contiguous in memory */</span>
<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">m68328_uart</span> <span class="o">*</span><span class="p">)</span><span class="n">USTCNT_ADDR</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Setup for console. Argument comes from the boot command line.</span>
<span class="cm"> */</span>

<span class="cm">/* note: this is messy, but it works, again, perhaps defined somewhere else?*/</span>
<span class="cp">#ifdef CONFIG_M68VZ328</span>
<span class="cp">#define CONSOLE_BAUD_RATE	19200</span>
<span class="cp">#define DEFAULT_CBAUD		B19200</span>
<span class="cp">#endif</span>


<span class="cp">#ifndef CONSOLE_BAUD_RATE</span>
<span class="cp">#define	CONSOLE_BAUD_RATE	9600</span>
<span class="cp">#define	DEFAULT_CBAUD		B9600</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">m68328_console_initted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">m68328_console_baud</span>    <span class="o">=</span> <span class="n">CONSOLE_BAUD_RATE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">m68328_console_cbaud</span>   <span class="o">=</span> <span class="n">DEFAULT_CBAUD</span><span class="p">;</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">serial_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_PARANOIA_CHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badmagic</span> <span class="o">=</span>
		<span class="s">&quot;Warning: bad magic number for serial struct %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badinfo</span> <span class="o">=</span>
		<span class="s">&quot;Warning: null m68k_serial for %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badinfo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">SERIAL_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badmagic</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is used to figure out the divisor speeds and the timeouts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span>
	<span class="mi">9600</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">38400</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cm">/* Utility routines */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_baud</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="n">uart_addr</span><span class="p">[</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">ubaud</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FIELD</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="n">UBAUD_PRESCALER</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x38</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">&gt;&gt;=</span> <span class="n">GET_FIELD</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="n">UBAUD_DIVIDE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_stop() and rs_start()</span>
<span class="cm"> *</span>
<span class="cm"> * This routines are called before setting or resetting tty-&gt;stopped.</span>
<span class="cm"> * They enable or disable transmitter interrupts, as necessary.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_stop&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USTCNT_TXEN</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rs_put_char</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">UTX</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
        	<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
        	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="p">}</span>

	<span class="n">UTX_TXDATA</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_start&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;</span> <span class="n">USTCNT_TXEN</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef USE_INTS</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span> <span class="o">|</span> <span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This do { } while() loop will get ALL chars out of Rx FIFO </span>
<span class="cm">         */</span>
<span class="cp">#ifndef CONFIG_XCOPILOT_BUGS</span>
	<span class="k">do</span> <span class="p">{</span>
<span class="cp">#endif	</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">GET_FIELD</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">URX_RXDATA</span><span class="p">);</span>
	
		<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_cons</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">URX_BREAK</span> <span class="o">&amp;</span> <span class="n">rx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* whee, break received */</span>
				<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ^P */</span>
				<span class="n">show_state</span><span class="p">();</span>
				<span class="n">show_free_areas</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">show_buffers</span><span class="p">();</span>
<span class="cm">/*				show_net_buffers(); */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ^R */</span>
				<span class="n">emergency_restart</span><span class="p">();</span>
				<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAGIC_SYSRQ */</span><span class="cp"></span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">clear_and_exit</span><span class="p">;</span>
		
		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">URX_PARITY_ERROR</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">URX_OVRUN</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_OVERRUN</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">URX_FRAME_ERROR</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>

		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_XCOPILOT_BUGS</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">((</span><span class="n">rx</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">urx</span><span class="p">.</span><span class="n">w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">URX_DATA_READY</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

<span class="nl">clear_and_exit:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send next char */</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">txdata</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clear_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* That&#39;s peculiar... TX ints off */</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clear_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send char */</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">txdata</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="o">++</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All done for now... TX ints off */</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clear_and_return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">clear_and_return:</span>
	<span class="cm">/* Clear interrupt (should be auto)*/</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is the serial driver&#39;s generic interrupt routine</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">rs_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">);</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx</span><span class="p">;</span>

	<span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="n">rx</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">urx</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>

<span class="cp">#ifdef USE_INTS</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">URX_DATA_READY</span><span class="p">)</span>
		<span class="n">receive_chars</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">)</span>
		<span class="n">transmit_chars</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">receive_chars</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them</span>
<span class="cm">	 * (they will be reenabled in change_speed())</span>
<span class="cm">	 */</span>

	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">USTCNT_UEN</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">USTCNT_UEN</span> <span class="o">|</span> <span class="n">USTCNT_RXEN</span> <span class="o">|</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">urx</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable sequencing and interrupts</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef USE_INTS</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">USTCNT_UEN</span> <span class="o">|</span> <span class="n">USTCNT_RXEN</span> <span class="o">|</span> 
                 <span class="n">USTCNT_RX_INTR_MASK</span> <span class="o">|</span> <span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">USTCNT_UEN</span> <span class="o">|</span> <span class="n">USTCNT_RXEN</span> <span class="o">|</span> <span class="n">USTCNT_RX_INTR_MASK</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and set the speed of the serial port</span>
<span class="cm">	 */</span>

	<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port; interrupts are disabled, and</span>
<span class="cm"> * DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* All off! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">prescale</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifndef CONFIG_M68VZ328</span>
 <span class="n">hw_baud_table</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 0 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 50 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 75 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 110 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 134 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 150 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 200 */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 300 */</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 600 */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 1200 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 1800 */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 2400 */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 4800 */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 9600 */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 19200 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 38400 */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x38</span><span class="p">},</span> <span class="cm">/* 57600 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x38</span><span class="p">},</span> <span class="cm">/* 115200 */</span>
<span class="p">};</span>
<span class="cp">#else</span>
 <span class="n">hw_baud_table</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 0 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 50 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 75 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 110 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 134 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 150 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 200 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 300 */</span>
                 <span class="p">{</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 600 */</span>
                 <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 1200 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span> <span class="cm">/* 1800 */</span>
                 <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 2400 */</span>
                 <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 4800 */</span>
                 <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 9600 */</span>
                 <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 19200 */</span>
                 <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 38400 */</span>
                 <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x26</span><span class="p">},</span> <span class="cm">/* 57600 */</span>
                 <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x38</span><span class="p">},</span> <span class="cm">/* 115200 */</span>
<span class="p">};</span> 
<span class="cp">#endif</span>
<span class="cm">/* rate = 1036800 / ((65 - prescale) * (1&lt;&lt;divider)) */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called to set the UART divisor registers to match</span>
<span class="cm"> * the specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ustcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ustcnt</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">ustcnt</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USTCNT_TXEN</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">)</span> <span class="o">+</span> <span class="n">B38400</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ubaud</span> <span class="o">=</span> <span class="n">PUT_FIELD</span><span class="p">(</span><span class="n">UBAUD_DIVIDE</span><span class="p">,</span>    <span class="n">hw_baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">divisor</span><span class="p">)</span> <span class="o">|</span> 
		<span class="n">PUT_FIELD</span><span class="p">(</span><span class="n">UBAUD_PRESCALER</span><span class="p">,</span> <span class="n">hw_baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prescale</span><span class="p">);</span>

	<span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USTCNT_PARITYEN</span> <span class="o">|</span> <span class="n">USTCNT_ODD_EVEN</span> <span class="o">|</span> <span class="n">USTCNT_STOP</span> <span class="o">|</span> <span class="n">USTCNT_8_7</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS8</span><span class="p">)</span>
		<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_8_7</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_STOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_PARITYEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
		<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_ODD_EVEN</span><span class="p">;</span>
	
<span class="cp">#ifdef CONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">UTX_NOCTS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">|=</span> <span class="n">UTX_NOCTS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
	
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">=</span> <span class="n">ustcnt</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fair output driver allows a process to speak.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_fair_output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>		<span class="cm">/* Output no more than that */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m68k_soft</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">rs_put_char</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">,</span> <span class="n">left</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Last character is being transmitted now (hopefully). */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * m68k_console_print is registered for printk.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">console_print_68328</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	
	<span class="k">while</span><span class="p">((</span><span class="n">c</span><span class="o">=*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">rs_put_char</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">);</span>
		<span class="n">rs_put_char</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Comment this if you want to have a strict interrupt-driven output */</span>
	<span class="n">rs_fair_output</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_set_ldisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_set_ldisc&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">is_cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_line</span> <span class="o">==</span> <span class="n">N_TTY</span><span class="p">);</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ttyS%d console mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">is_cons</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifndef USE_INTS</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
<span class="cp">#endif</span>

	<span class="cm">/* Enable transmitter */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef USE_INTS</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span> <span class="o">|</span> <span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef USE_INTS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="cm">/* Send char */</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">txdata</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="o">++</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef USE_INTS</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">))</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">console_printn</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">c</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_save_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>		
		<span class="n">c</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">));</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable transmitter */</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>		
<span class="cp">#ifndef USE_INTS</span>
		<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>

		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
<span class="cp">#ifdef USE_INTS</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TX_INTR_MASK</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">))</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UTX_TX_AVAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">txdata</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="o">++</span><span class="p">];</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifndef USE_INTS</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rs_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>
				
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rs_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
				
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
				
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_throttle()</span>
<span class="cm"> * </span>
<span class="cm"> * This routine is called by the upper-layer tty layer to signal that</span>
<span class="cm"> * incoming characters should be throttled.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Turn off RTS line (do this atomic) */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Assert RTS line (do this atomic) */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_ioctl() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span> <span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span> <span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="n">old_info</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">old_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_USR_MASK</span><span class="p">));</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_and_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, past this point, all the error checking has been done.</span>
<span class="cm">	 * At this point, we start making changes.....</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>

<span class="nl">check_and_exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> * 	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> * 	    release the bus after transmitting. This must be done when</span>
<span class="cm"> * 	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> * 	    transmit holding register is empty.  This functionality</span>
<span class="cm"> * 	    allows an RS485 driver to be written in user space. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UTX_CTS_STAT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine sends a break character out the serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef USE_INTS	</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">|=</span> <span class="n">UTX_SEND_BREAK</span><span class="p">;</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">utx</span><span class="p">.</span><span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTX_SEND_BREAK</span><span class="p">;</span>
<span class="cp">#endif		</span>
        <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rs_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERCONFIG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGWILD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERSWILD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSERGSTRUCT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCSBRK</span>:	<span class="cm">/* SVID version: non-zero arg --&gt; no break */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
				<span class="n">send_break</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>	<span class="cm">/* 1/4 second */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCSBRKP</span>:	<span class="cm">/* support for POSIX tcsendbreak() */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_break</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="o">?</span> <span class="n">arg</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">250</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
			<span class="k">return</span> <span class="n">get_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
			<span class="k">return</span> <span class="n">set_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span>
					       <span class="p">(</span><span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>: <span class="cm">/* Get line status register */</span>
			<span class="k">return</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">TIOCSERGSTRUCT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span>
				    <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rs_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rs_close()</span>
<span class="cm"> * </span>
<span class="cm"> * This routine is called when the serial port gets closed.  First, we</span>
<span class="cm"> * wait for the last remaining data to be sent.  Then, we unlink its</span>
<span class="cm"> * S structure from the interrupt chain if necessary, and we free</span>
<span class="cm"> * that IRQ if nothing is left in the chain.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rs_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">;</span>
	<span class="n">m68328_uart</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Uh, oh.  tty-&gt;count is 1, which means that the tty</span>
<span class="cm">		 * structure will be freed.  Info-&gt;count should always</span>
<span class="cm">		 * be one in these conditions.  If it&#39;s greater than</span>
<span class="cm">		 * one, we&#39;ve got real problems, since it means the</span>
<span class="cm">		 * serial port won&#39;t be shutdown.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_close: bad serial port count; tty-&gt;count is 1, &quot;</span>
		       <span class="s">&quot;port-&gt;count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_close: bad serial port count for ttyS%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CLOSING</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now we wait for the transmit buffer to clear; and we notify </span>
<span class="cm">	 * the line discipline to only process XON/XOFF characters.</span>
<span class="cm">	 */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">closing_wait</span> <span class="o">!=</span> <span class="n">ASYNC_CLOSING_WAIT_NONE</span><span class="p">)</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">closing_wait</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point we stop accepting input.  To do this, we</span>
<span class="cm">	 * disable the receive line status interrupts, and tell the</span>
<span class="cm">	 * interrupt driver to stop checking the data ready bit in the</span>
<span class="cm">	 * line status register.</span>
<span class="cm">	 */</span>

	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USTCNT_RXEN</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USTCNT_RXEN</span> <span class="o">|</span> <span class="n">USTCNT_RX_INTR_MASK</span><span class="p">);</span>

	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#warning &quot;This is not and has never been valid so fix it&quot;	</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (tty-&gt;ldisc.num != ldiscs[N_TTY].num) {</span>
<span class="c">		if (tty-&gt;ldisc.close)</span>
<span class="c">			(tty-&gt;ldisc.close)(tty);</span>
<span class="c">		tty-&gt;ldisc = ldiscs[N_TTY];</span>
<span class="c">		tty-&gt;termios-&gt;c_line = N_TTY;</span>
<span class="c">		if (tty-&gt;ldisc.open)</span>
<span class="c">			(tty-&gt;ldisc.open)(tty);</span>
<span class="c">	}</span>
<span class="cp">#endif	</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">));</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="o">|</span><span class="n">ASYNC_CLOSING</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rs_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">rs_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">rs_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.  It</span>
<span class="cm"> * enables interrupts for a serial port, linking in its S structure into</span>
<span class="cm"> * the IRQ chain.   It also performs the serial-specific</span>
<span class="cm"> * initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">rs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m68k_soft</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rs_open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start up serial port</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Finally, routines used to initialize the serial driver. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">show_serial_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MC68328 serial driver version 1.00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">rs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">rs_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">rs_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">rs_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">rs_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">rs_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">rs_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">rs_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">rs_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">rs_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">rs_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">rs_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">rs_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">rs_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ldisc</span> <span class="o">=</span> <span class="n">rs_set_ldisc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">rs_port_ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="cm">/* rs_init inits the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="n">rs68328_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m68k_serial</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_PORTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">show_serial_version</span><span class="p">();</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>
	<span class="cm">/* SPARC: Not all of this is exactly right for us. */</span>
	
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> 
			<span class="n">m68328_console_cbaud</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_register_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t register serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NR_PORTS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m68k_soft</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">);</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">tport</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rs_port_ops</span><span class="p">;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">SERIAL_MAGIC</span><span class="p">;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uart_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">uart_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">is_cons</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Means shortcuts work */</span>
	    
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%d at 0x%08x (irq = %d)&quot;</span><span class="p">,</span> <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> 
		   <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; is a builtin MC68328 UART</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    
<span class="cp">#ifdef CONFIG_M68VZ328</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
			<span class="n">PJSEL</span> <span class="o">&amp;=</span> <span class="mh">0xCF</span><span class="p">;</span>  <span class="cm">/* PSW enable second port output */</span>
<span class="cp">#endif</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">uart_irqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			    <span class="n">rs_interrupt</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span>
			    <span class="s">&quot;M68328_UART&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
                <span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unable to attach 68328 serial interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rs68328_init</span><span class="p">);</span>



<span class="k">static</span> <span class="kt">void</span> <span class="n">m68328_set_baud</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ustcnt</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ustcnt</span> <span class="o">=</span> <span class="n">USTCNT</span><span class="p">;</span>
	<span class="n">USTCNT</span> <span class="o">=</span> <span class="n">ustcnt</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USTCNT_TXEN</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">baud_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">m68328_console_baud</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">baud_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">m68328_console_baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">UBAUD</span> <span class="o">=</span> <span class="n">PUT_FIELD</span><span class="p">(</span><span class="n">UBAUD_DIVIDE</span><span class="p">,</span>    <span class="n">hw_baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">divisor</span><span class="p">)</span> <span class="o">|</span> 
		<span class="n">PUT_FIELD</span><span class="p">(</span><span class="n">UBAUD_PRESCALER</span><span class="p">,</span> <span class="n">hw_baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prescale</span><span class="p">);</span>
	<span class="n">ustcnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USTCNT_PARITYEN</span> <span class="o">|</span> <span class="n">USTCNT_ODD_EVEN</span> <span class="o">|</span> <span class="n">USTCNT_STOP</span> <span class="o">|</span> <span class="n">USTCNT_8_7</span><span class="p">);</span>
	<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_8_7</span><span class="p">;</span>
	<span class="n">ustcnt</span> <span class="o">|=</span> <span class="n">USTCNT_TXEN</span><span class="p">;</span>
	<span class="n">USTCNT</span> <span class="o">=</span> <span class="n">ustcnt</span><span class="p">;</span>
	<span class="n">m68328_console_initted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">m68328_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">CONSOLE_BAUD_RATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">baud_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">baud_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">m68328_console_baud</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">m68328_console_cbaud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m68328_console_cbaud</span> <span class="o">|=</span> <span class="n">CBAUDEX</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">-=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m68328_console_cbaud</span> <span class="o">|=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m68328_set_baud</span><span class="p">();</span> <span class="cm">/* make sure baud rate changes */</span>
	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">m68328_console_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">serial_driver</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">m68328_console_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m68328_console_initted</span><span class="p">)</span>
		<span class="n">m68328_set_baud</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
           <span class="n">rs_put_char</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">);</span>
        <span class="n">rs_put_char</span><span class="p">(</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">m68328_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">m68328_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">m68328_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">m68328_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">m68328_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m68328_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">console_initcall</span><span class="p">(</span><span class="n">m68328_console_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
