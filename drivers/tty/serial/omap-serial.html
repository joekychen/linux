<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › omap-serial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap-serial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for OMAP-UART controller.</span>
<span class="cm"> * Based on drivers/serial/8250.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Govindraj R	&lt;govindraj.raja@ti.com&gt;</span>
<span class="cm"> *	Thara Gopinath	&lt;thara@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: This driver is made separate from 8250 driver as we cannot</span>
<span class="cm"> * over load 8250 driver with omap platform specific configuration for</span>
<span class="cm"> * features like DMA, it makes easier to implement features like DMA and</span>
<span class="cm"> * hardware flow control and software flow control configuration with</span>
<span class="cm"> * this driver as required for the omap-platform.</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_SERIAL_OMAP_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>

<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;plat/dmtimer.h&gt;</span>
<span class="cp">#include &lt;plat/omap-serial.h&gt;</span>

<span class="cp">#define UART_BUILD_REVISION(x, y)	(((x) &lt;&lt; 8) | (y))</span>

<span class="cp">#define OMAP_UART_REV_42 0x0402</span>
<span class="cp">#define OMAP_UART_REV_46 0x0406</span>
<span class="cp">#define OMAP_UART_REV_52 0x0502</span>
<span class="cp">#define OMAP_UART_REV_63 0x0603</span>

<span class="cp">#define DEFAULT_CLK_SPEED 48000000 </span><span class="cm">/* 48Mhz*/</span><span class="cp"></span>

<span class="cm">/* SCR register bitmasks */</span>
<span class="cp">#define OMAP_UART_SCR_RX_TRIG_GRANU1_MASK		(1 &lt;&lt; 7)</span>

<span class="cm">/* FCR register bitmasks */</span>
<span class="cp">#define OMAP_UART_FCR_RX_FIFO_TRIG_SHIFT		6</span>
<span class="cp">#define OMAP_UART_FCR_RX_FIFO_TRIG_MASK			(0x3 &lt;&lt; 6)</span>

<span class="cm">/* MVR register bitmasks */</span>
<span class="cp">#define OMAP_UART_MVR_SCHEME_SHIFT	30</span>

<span class="cp">#define OMAP_UART_LEGACY_MVR_MAJ_MASK	0xf0</span>
<span class="cp">#define OMAP_UART_LEGACY_MVR_MAJ_SHIFT	4</span>
<span class="cp">#define OMAP_UART_LEGACY_MVR_MIN_MASK	0x0f</span>

<span class="cp">#define OMAP_UART_MVR_MAJ_MASK		0x700</span>
<span class="cp">#define OMAP_UART_MVR_MAJ_SHIFT		8</span>
<span class="cp">#define OMAP_UART_MVR_MIN_MASK		0x3f</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">ui</span><span class="p">[</span><span class="n">OMAP_MAX_HSUART_PORTS</span><span class="p">];</span>

<span class="cm">/* Forward declaration of functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">uart_tx_dma_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">serial_omap_rxdma_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uart_no</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">serial_omap_start_rxdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mdr1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">serial_omap_uart_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">offset</span> <span class="o">&lt;&lt;=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">regshift</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">offset</span> <span class="o">&lt;&lt;=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">regshift</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_omap_clear_fifos</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span>
		       <span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * serial_omap_get_divisor - calculate divisor value</span>
<span class="cm"> * @port: uart port info</span>
<span class="cm"> * @baud: baudrate for which divisor needs to be calculated.</span>
<span class="cm"> *</span>
<span class="cm"> * We have written our own function to get the divisor so as to support</span>
<span class="cm"> * 13x mode. 3Mbps Baudrate as an different divisor.</span>
<span class="cm"> * Reference OMAP TRM Chapter 17:</span>
<span class="cm"> * Table 17-1. UART Mode Baud Rates, Divisor Values, and Error Rates</span>
<span class="cm"> * referring to oversampling - divisor value</span>
<span class="cm"> * baudrate 460,800 to 3,686,400 all have divisor 13</span>
<span class="cm"> * except 3,000,000 which has divisor value 16</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">serial_omap_get_divisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="n">OMAP_MODE13X_SPEED</span> <span class="o">&amp;&amp;</span> <span class="n">baud</span> <span class="o">!=</span> <span class="mi">3000000</span><span class="p">)</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="o">/</span><span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="n">divisor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_stop_rxdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">);</span>
		<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">);</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span> <span class="o">=</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_used</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_enable_ms+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span> <span class="o">!=</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if dma is still active. If yes do nothing,</span>
<span class="cm">		 * return. Else stop dma</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_get_dma_active_status</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">);</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span> <span class="o">=</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">;</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_forceidle</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_forceidle</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">serial_omap_stop_rxdma</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_RLSI</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="n">lsr</span> <span class="o">=</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">))</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BRK_ERROR_BITS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For statistics only</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">);</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * We do the SysRQ and SAK checking</span>
<span class="cm">				 * here because otherwise the break</span>
<span class="cm">				 * may get masked by ignore_status_mask</span>
<span class="cm">				 * or read_status_mask.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mask off conditions which should be ignored.</span>
<span class="cm">			 */</span>
			<span class="n">lsr</span> <span class="o">&amp;=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SERIAL_OMAP_CONSOLE</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">==</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">cons</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Recover the break flag from console xmit */</span>
				<span class="n">lsr</span> <span class="o">|=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">lsr_break_flag</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>
		<span class="n">uart_insert_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">UART_LSR_OE</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="nl">ignore_char:</span>
		<span class="n">lsr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_LSR_DR</span> <span class="o">|</span> <span class="n">UART_LSR_BI</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max_count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">serial_omap_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
		<span class="n">serial_omap_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_omap_enable_ier_thri</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">serial_omap_enable_ier_thri</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_noidle</span><span class="p">)</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_noidle</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_used</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span> <span class="o">==</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_tx</span><span class="p">,</span>
				<span class="s">&quot;UART Tx DMA&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">uart_tx_dma_callback</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">serial_omap_enable_ier_thri</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">));</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_used</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">));</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">=</span> <span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is a circular buffer. See if the buffer has wounded back.</span>
<span class="cm">	 * If yes it will have to be transferred in two separate dma</span>
<span class="cm">	 * transfers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">&gt;=</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span> <span class="o">+</span> <span class="n">UART_XMIT_SIZE</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span> <span class="o">+</span>
			<span class="n">UART_XMIT_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span>
				<span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* FIXME: Cache maintenance needed here? */</span>
	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">check_modem_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">msr_saved_flags</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">msr_saved_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span> <span class="o">&amp;&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_MSI</span> <span class="o">&amp;&amp;</span>
	    <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_TERI</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDSR</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">)</span>
			<span class="n">uart_handle_dcd_change</span>
				<span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCTS</span><span class="p">)</span>
			<span class="n">uart_handle_cts_change</span>
				<span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * serial_omap_irq() - This handles the interrupt from one port</span>
<span class="cm"> * @irq: uart port irq number</span>
<span class="cm"> * @dev_id: uart port info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">irqreturn_t</span> <span class="nf">serial_omap_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iir</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iir</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lsr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_RLSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
				<span class="n">receive_chars</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_IER_RDI</span> <span class="o">|</span> <span class="n">UART_IER_RLSI</span><span class="p">);</span>
			<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">serial_omap_start_rxdma</span><span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">))</span>
				<span class="n">receive_chars</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">check_modem_status</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_THRI</span><span class="p">))</span>
		<span class="n">transmit_chars</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port_activity</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_omap_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_tx_empty+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_omap_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">check_modem_status</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_get_mctrl+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_RNG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_set_mctrl+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT1</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT2</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_LOOP</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_break_ctl+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the IRQ</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">serial_omap_irq</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irqflags</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_startup+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them.</span>
<span class="cm">	 * (they will be reenabled in set_termios())</span>
<span class="cm">	 */</span>
	<span class="n">serial_omap_clear_fifos</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="cm">/* For Hardware flow control */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">UART_MCR_RTS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_WLEN8</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Most PC uarts need OUT2 raised to enable interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span> <span class="o">|=</span> <span class="n">TIOCM_OUT2</span><span class="p">;</span>
	<span class="n">serial_omap_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">msr_saved_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
			<span class="n">UART_XMIT_SIZE</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">);</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">));</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">serial_omap_rxdma_poll</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">;</span>
		<span class="cm">/* Currently the buffer size is 4KB. Can increase it */</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_size</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts. Note: Modem status interrupts</span>
<span class="cm">	 * are set via set_termios(), which will be occurring imminently</span>
<span class="cm">	 * anyway, so we don&#39;t enable them here.</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">UART_IER_RLSI</span> <span class="o">|</span> <span class="n">UART_IER_RDI</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>

	<span class="cm">/* Enable module level wake up */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_WER</span><span class="p">,</span> <span class="n">OMAP_UART_WER_MOD_WKUP</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port_activity</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_shutdown+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable interrupts from this port</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIOCM_OUT2</span><span class="p">;</span>
	<span class="n">serial_omap_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable break condition and FIFOs</span>
<span class="cm">	 */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">);</span>
	<span class="n">serial_omap_clear_fifos</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read data port to reset things, and then free the irq</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">UART_XMIT_SIZE</span><span class="p">,</span>	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">serial_omap_stop_rx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_size</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">serial_omap_configure_xonxoff</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_EFR_ECB</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_XON1</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">]);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_XOFF1</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">]);</span>

	<span class="cm">/* clear SW control mode bits */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">&amp;=</span> <span class="n">OMAP_UART_SW_CLR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IXON Flag:</span>
<span class="cm">	 * Enable XON/XOFF flow control on output.</span>
<span class="cm">	 * Transmit XON1, XOFF1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|=</span> <span class="n">OMAP_UART_SW_TX</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IXOFF Flag:</span>
<span class="cm">	 * Enable XON/XOFF flow control on input.</span>
<span class="cm">	 * Receiver compares XON1, XOFF1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXOFF</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|=</span> <span class="n">OMAP_UART_SW_RX</span><span class="p">;</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * IXANY Flag:</span>
<span class="cm">	 * Enable any character to restart output.</span>
<span class="cm">	 * Operation resumes after receiving any</span>
<span class="cm">	 * character after recognition of the XOFF character</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXANY</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_XONANY</span><span class="p">;</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|</span> <span class="n">UART_MCR_TCRTLR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TI752_TCR</span><span class="p">,</span> <span class="n">OMAP_UART_TCR_TRIG</span><span class="p">);</span>
	<span class="cm">/* Enable special char function UARTi.EFR_REG[5] and</span>
<span class="cm">	 * load the new software flow control mode IXON or IXOFF</span>
<span class="cm">	 * and restore the UARTi.EFR_REG[4] ENHANCED_EN value.</span>
<span class="cm">	 */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_SCD</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_MCR_TCRTLR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_uart_qos_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uart_omap_port</span><span class="p">,</span>
						<span class="n">qos_work</span><span class="p">);</span>

	<span class="n">pm_qos_update_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pm_qos_request</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_omap_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">efr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_STOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ask the core to calculate the divisor for us.</span>
<span class="cm">	 */</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="o">/</span><span class="mi">13</span><span class="p">);</span>
	<span class="n">quot</span> <span class="o">=</span> <span class="n">serial_omap_get_divisor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* calculate wakeup latency constraint */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">calc_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">USEC_PER_SEC</span> <span class="o">*</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">calc_latency</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">qos_work</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">dll</span> <span class="o">=</span> <span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">dlh</span> <span class="o">=</span> <span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span> <span class="o">=</span> <span class="n">UART_OMAP_MDR1_DISABLE</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_R_TRIG_01</span> <span class="o">|</span> <span class="n">UART_FCR_T_TRIG_01</span> <span class="o">|</span>
			<span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_DMA_SELECT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, we&#39;re now changing the port state. Do it with</span>
<span class="cm">	 * interrupts disabled.</span>
<span class="cm">	 */</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the per-port timeout.</span>
<span class="cm">	 */</span>
	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">UART_LSR_OE</span> <span class="o">|</span> <span class="n">UART_LSR_THRE</span> <span class="o">|</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characters to ignore</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span> <span class="n">UART_LSR_FE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns too (for real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_OE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore all characters if CREAD is not set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Modem status interrupts</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UART_ENABLE_MS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">))</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>		<span class="cm">/* reset DLAB */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">cval</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">scr</span> <span class="o">=</span> <span class="n">OMAP_UART_SCR_TX_EMPTY</span><span class="p">;</span>

	<span class="cm">/* FIFOs and DMA Settings */</span>

	<span class="cm">/* FCR can be changed only when the</span>
<span class="cm">	 * baud clock is not running</span>
<span class="cm">	 * DLL_REG and DLH_REG set to 0.</span>
<span class="cm">	 */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|</span> <span class="n">UART_MCR_TCRTLR</span><span class="p">);</span>
	<span class="cm">/* FIFO ENABLE, DMA MODE */</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">scr</span> <span class="o">|=</span> <span class="n">OMAP_UART_SCR_RX_TRIG_GRANU1_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TI752_TLR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">scr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set receive FIFO threshold to 1 byte */</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_UART_FCR_RX_FIFO_TRIG_MASK</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP_UART_FCR_RX_FIFO_TRIG_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_SCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">);</span>

	<span class="cm">/* Protocol, Baud Rate, and Interrupt Settings */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i202_MDR1_ACCESS</span><span class="p">)</span>
		<span class="n">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">dll</span><span class="p">);</span>	<span class="cm">/* LS of divisor */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">dlh</span><span class="p">);</span>	<span class="cm">/* MS of divisor */</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="mi">230400</span> <span class="o">&amp;&amp;</span> <span class="n">baud</span> <span class="o">!=</span> <span class="mi">3000000</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span> <span class="o">=</span> <span class="n">UART_OMAP_MDR1_13X_MODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span> <span class="o">=</span> <span class="n">UART_OMAP_MDR1_16X_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i202_MDR1_ACCESS</span><span class="p">)</span>
		<span class="n">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>

	<span class="cm">/* Hardware Flow Control Configuration */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">efr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_EFR_CTS</span> <span class="o">|</span> <span class="n">UART_EFR_RTS</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>

		<span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|</span> <span class="n">UART_MCR_TCRTLR</span><span class="p">);</span>

		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>

		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TI752_TCR</span><span class="p">,</span> <span class="n">OMAP_UART_TCR_TRIG</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">efr</span><span class="p">);</span> <span class="cm">/* Enable AUTORTS and AUTOCTS */</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">);</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">serial_omap_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="cm">/* Software Flow Control Configuration */</span>
	<span class="n">serial_omap_configure_xonxoff</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">termios</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_set_termios+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_omap_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">efr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_pm+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>
	<span class="n">efr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">efr</span> <span class="o">|</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">UART_IERX_SLEEP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">efr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
			<span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pm_runtime_allow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_release_port+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_request_port+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_config_port+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_OMAP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">serial_omap_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we don&#39;t want the core code to modify any port params */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_verify_port+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">serial_omap_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;serial_omap_type+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BOTH_EMPTY (UART_LSR_TEMT | UART_LSR_THRE)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wait_for_xmitr</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">tmout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="cm">/* Wait up to 10ms for the character(s) to be sent. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">lsr_break_flag</span> <span class="o">=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">tmout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BOTH_EMPTY</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BOTH_EMPTY</span><span class="p">);</span>

	<span class="cm">/* Wait up to 1s for flow control if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_CONS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

			<span class="n">up</span><span class="o">-&gt;</span><span class="n">msr_saved_flags</span> <span class="o">|=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SAVE_FLAGS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_poll_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_poll_get_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NO_POLL_CHAR</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CONSOLE_POLL */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SERIAL_OMAP_CONSOLE</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">serial_omap_console_ports</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">serial_omap_reg</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_omap_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">serial_omap_console_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">sysrq</span><span class="p">)</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First save the IER then disable the interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">serial_omap_console_putchar</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, wait for transmitter to become empty</span>
<span class="cm">	 * and restore the IER</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The receive handling will happen properly because the</span>
<span class="cm">	 * receive ready bit will still be set; it is not cleared</span>
<span class="cm">	 * on read.  However, modem control will not, we must</span>
<span class="cm">	 * call it if we have saved something in the saved flags</span>
<span class="cm">	 * while processing with interrupts off.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">msr_saved_flags</span><span class="p">)</span>
		<span class="n">check_modem_status</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">serial_omap_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_omap_console_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">up</span> <span class="o">=</span> <span class="n">serial_omap_console_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">serial_omap_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">OMAP_SERIAL_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">serial_omap_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">serial_omap_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_add_console_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serial_omap_console_ports</span><span class="p">[</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define OMAP_CONSOLE	(&amp;serial_omap_console)</span>

<span class="cp">#else</span>

<span class="cp">#define OMAP_CONSOLE	NULL</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_omap_add_console_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">serial_omap_pops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">serial_omap_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">serial_omap_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">serial_omap_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">serial_omap_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">serial_omap_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">serial_omap_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">serial_omap_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">serial_omap_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">serial_omap_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">serial_omap_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">serial_omap_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="n">serial_omap_pm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">serial_omap_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">serial_omap_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">serial_omap_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">serial_omap_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">serial_omap_verify_port</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
	<span class="p">.</span><span class="n">poll_put_char</span>  <span class="o">=</span> <span class="n">serial_omap_poll_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_get_char</span>  <span class="o">=</span> <span class="n">serial_omap_poll_get_char</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">serial_omap_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;OMAP-SERIAL&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>	<span class="o">=</span> <span class="n">OMAP_SERIAL_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">OMAP_MAX_HSUART_PORTS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span>		<span class="o">=</span> <span class="n">OMAP_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">qos_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_rxdma_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uart_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">ui</span><span class="p">[</span><span class="n">uart_no</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">curr_dma_pos</span><span class="p">,</span> <span class="n">curr_transmitted_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">curr_dma_pos</span> <span class="o">=</span> <span class="n">omap_get_dma_dst_pos</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">curr_dma_pos</span> <span class="o">==</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">prev_rx_dma_pos</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">curr_dma_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port_activity</span><span class="p">)</span> <span class="o">&lt;</span>
						<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_poll_rate</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">serial_omap_stop_rxdma</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_IER_RDI</span> <span class="o">|</span> <span class="n">UART_IER_RLSI</span><span class="p">);</span>
			<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">curr_transmitted_size</span> <span class="o">=</span> <span class="n">curr_dma_pos</span> <span class="o">-</span>
					<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">prev_rx_dma_pos</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">curr_transmitted_size</span><span class="p">;</span>
	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">prev_rx_dma_pos</span> <span class="o">-</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span><span class="p">),</span>
			<span class="n">curr_transmitted_size</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">prev_rx_dma_pos</span> <span class="o">=</span> <span class="n">curr_dma_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_size</span> <span class="o">+</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span> <span class="o">==</span> <span class="n">curr_dma_pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">serial_omap_start_rxdma</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">serial_omap_stop_rxdma</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_IER_RDI</span> <span class="o">|</span> <span class="n">UART_IER_RLSI</span><span class="p">);</span>
			<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_poll_rate</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port_activity</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uart_rx_dma_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_start_rxdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_rx</span><span class="p">,</span>
				<span class="s">&quot;UART Rx DMA&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">uart_rx_dma_callback</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">,</span>
				<span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">prev_rx_dma_pos</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_dma_phys</span><span class="p">;</span>
	<span class="cm">/* FIXME: Cache maintenance needed here? */</span>
	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_poll_rate</span><span class="p">));</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_used</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_continue_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">=</span> <span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is a circular buffer. See if the buffer has wounded back.</span>
<span class="cm">	 * If yes it will have to be transferred in two separate dma</span>
<span class="cm">	 * transfers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">&gt;=</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span> <span class="o">+</span> <span class="n">UART_XMIT_SIZE</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_dma_phys</span> <span class="o">+</span> <span class="n">UART_XMIT_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">,</span>
				<span class="n">OMAP_DMA_DATA_TYPE_S8</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">OMAP_DMA_SYNC_ELEMENT</span><span class="p">,</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_tx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* FIXME: Cache maintenance needed here? */</span>
	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uart_tx_dma_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>

	<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span><span class="p">)</span> <span class="o">&amp;</span> \
			<span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_buf_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">));</span>
		<span class="n">serial_omap_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_used</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span><span class="p">);</span>
		<span class="n">serial_omap_continue_tx</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port_activity</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_serial_fill_features_erratas</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mvr</span><span class="p">,</span> <span class="n">scheme</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">revision</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">mvr</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MVER</span><span class="p">);</span>

	<span class="cm">/* Check revision register scheme */</span>
	<span class="n">scheme</span> <span class="o">=</span> <span class="n">mvr</span> <span class="o">&gt;&gt;</span> <span class="n">OMAP_UART_MVR_SCHEME_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scheme</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Legacy Scheme: OMAP2/3 */</span>
		<span class="cm">/* MINOR_REV[0:4], MAJOR_REV[4:7] */</span>
		<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvr</span> <span class="o">&amp;</span> <span class="n">OMAP_UART_LEGACY_MVR_MAJ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">OMAP_UART_LEGACY_MVR_MAJ_SHIFT</span><span class="p">;</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvr</span> <span class="o">&amp;</span> <span class="n">OMAP_UART_LEGACY_MVR_MIN_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* New Scheme: OMAP4+ */</span>
		<span class="cm">/* MINOR_REV[0:5], MAJOR_REV[8:10] */</span>
		<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvr</span> <span class="o">&amp;</span> <span class="n">OMAP_UART_MVR_MAJ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">OMAP_UART_MVR_MAJ_SHIFT</span><span class="p">;</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvr</span> <span class="o">&amp;</span> <span class="n">OMAP_UART_MVR_MIN_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unknown %s revision, defaulting to highest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* highest possible revision */</span>
		<span class="n">major</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* normalize revision for the driver */</span>
	<span class="n">revision</span> <span class="o">=</span> <span class="n">UART_BUILD_REVISION</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_UART_REV_46</span>:
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_ERRATA_i202_MDR1_ACCESS</span> <span class="o">|</span>
				<span class="n">UART_ERRATA_i291_DMA_FORCEIDLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_UART_REV_52</span>:
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_ERRATA_i202_MDR1_ACCESS</span> <span class="o">|</span>
				<span class="n">UART_ERRATA_i291_DMA_FORCEIDLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_UART_REV_63</span>:
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">|=</span> <span class="n">UART_ERRATA_i202_MDR1_ACCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="nf">of_get_uart_port_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">omap_up_info</span><span class="p">;</span>

	<span class="n">omap_up_info</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">omap_up_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_up_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* out of memory */</span>

	<span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">omap_up_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span>	<span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="o">*</span><span class="n">irq</span><span class="p">,</span> <span class="o">*</span><span class="n">dma_tx</span><span class="p">,</span> <span class="o">*</span><span class="n">dma_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">omap_up_info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
		<span class="n">omap_up_info</span> <span class="o">=</span> <span class="n">of_get_uart_port_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mem resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no irq resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;memory region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_rx</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_rx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">dma_tx</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="s">&quot;tx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">up</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_OMAP</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_omap_pops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">of_alias_get_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get alias/pdev id, errno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_port_line</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;OMAP UART%d&quot;</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						<span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t ioremap UART</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">DEFAULT_CLK_SPEED</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No clock speed specified: using default:&quot;</span>
						<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DEFAULT_CLK_SPEED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_base</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">dma_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_tx</span> <span class="o">=</span> <span class="n">dma_tx</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">uart_dma_rx</span> <span class="o">=</span> <span class="n">dma_rx</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_buf_size</span> <span class="o">=</span> <span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">dma_rx_buf_size</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">dma_rx_timeout</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_poll_rate</span> <span class="o">=</span> <span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">dma_rx_poll_rate</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">));</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_lock</span><span class="p">));</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">tx_dma_channel</span> <span class="o">=</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">uart_dma</span><span class="p">.</span><span class="n">rx_dma_channel</span> <span class="o">=</span> <span class="n">OMAP_UART_DMA_CH_FREE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="n">PM_QOS_CPU_DMA_LAT_DEFAULT_VALUE</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">calc_latency</span> <span class="o">=</span> <span class="n">PM_QOS_CPU_DMA_LAT_DEFAULT_VALUE</span><span class="p">;</span>
	<span class="n">pm_qos_add_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pm_qos_request</span><span class="p">,</span>
		<span class="n">PM_QOS_CPU_DMA_LATENCY</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>
	<span class="n">serial_omap_uart_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">qos_work</span><span class="p">,</span> <span class="n">serial_omap_uart_qos_work</span><span class="p">);</span>

	<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">omap_up_info</span><span class="o">-&gt;</span><span class="n">autosuspend_timeout</span><span class="p">);</span>

	<span class="n">pm_runtime_irq_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">omap_serial_fill_features_erratas</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="n">ui</span><span class="p">[</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
	<span class="n">serial_omap_add_console_port</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add_port</span><span class="p">;</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_add_port:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
<span class="nl">err_port_line:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[UART%d]: failure [%s]: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">pm_qos_remove_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pm_qos_request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Work Around for Errata i202 (2430, 3430, 3630, 4430 and 4460)</span>
<span class="cm"> * The access to uart register after MDR1 Access</span>
<span class="cm"> * causes UART to corrupt data.</span>
<span class="cm"> *</span>
<span class="cm"> * Need a delay =</span>
<span class="cm"> * 5 L4 clock cycles + 5 UART functional clock cycle (@48MHz = ~0.2uS)</span>
<span class="cm"> * give 10 times as much</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mdr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1</span><span class="p">,</span> <span class="n">mdr1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span> <span class="o">|</span>
			<span class="n">UART_FCR_CLEAR_RCVR</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for FIFO to empty: when empty, RX_FIFO_E bit is 0 and</span>
<span class="cm">	 * TX_FIFO_E bit is 1.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">UART_LSR_THRE</span> <span class="o">!=</span> <span class="p">(</span><span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">UART_LSR_THRE</span> <span class="o">|</span> <span class="n">UART_LSR_DR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Should *never* happen. we warn and carry on */</span>
			<span class="n">dev_crit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Errata i202: timedout %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">serial_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_omap_restore_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i202_MDR1_ACCESS</span><span class="p">)</span>
		<span class="n">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1_DISABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1_DISABLE</span><span class="p">);</span>

	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span> <span class="cm">/* Config B mode */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">UART_EFR_ECB</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="cm">/* Operational mode */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span> <span class="cm">/* Config B mode */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">dll</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">dlh</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="cm">/* Operational mode */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">fcr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_A</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_CONF_MODE_B</span><span class="p">);</span> <span class="cm">/* Config B mode */</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_SCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_EFR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">efr</span><span class="p">);</span>
	<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i202_MDR1_ACCESS</span><span class="p">)</span>
		<span class="n">serial_omap_mdr1_errataset</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">UART_OMAP_MDR1</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">mdr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_wakeup</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">context_loss_cnt</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">wakeups_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_wakeup</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">wakeups_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">wakeups_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_wakeup</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">wakeups_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Errata i291 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_forceidle</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i291_DMA_FORCEIDLE</span><span class="p">))</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_forceidle</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="n">PM_QOS_CPU_DMA_LAT_DEFAULT_VALUE</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">qos_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_omap_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_omap_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_uart_port_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">loss_cnt</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">context_loss_cnt</span> <span class="o">!=</span> <span class="n">loss_cnt</span><span class="p">)</span>
				<span class="n">serial_omap_restore_context</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Errata i291 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_noidle</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">errata</span> <span class="o">&amp;</span> <span class="n">UART_ERRATA_i291_DMA_FORCEIDLE</span><span class="p">))</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_noidle</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="n">up</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">calc_latency</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">qos_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">serial_omap_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">serial_omap_suspend</span><span class="p">,</span> <span class="n">serial_omap_resume</span><span class="p">)</span>
	<span class="n">SET_RUNTIME_PM_OPS</span><span class="p">(</span><span class="n">serial_omap_runtime_suspend</span><span class="p">,</span>
				<span class="n">serial_omap_runtime_resume</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_OF)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">omap_serial_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap2-uart&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap3-uart&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap4-uart&quot;</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">omap_serial_of_match</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">serial_omap_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">serial_omap_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">serial_omap_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_omap_dev_pm_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">omap_serial_of_match</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">serial_omap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">serial_omap_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_driver</span><span class="p">);</span>
	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_omap_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">serial_omap_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">serial_omap_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP High Speed UART driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments Inc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
