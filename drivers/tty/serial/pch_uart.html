<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › pch_uart.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pch_uart.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *Copyright (C) 2011 LAPIS Semiconductor Co., Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *You should have received a copy of the GNU General Public License</span>
<span class="cm"> *along with this program; if not, write to the Free Software</span>
<span class="cm"> *Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/pch_dma.h&gt;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PCH_UART_HANDLED_RX_INT_SHIFT</span><span class="p">,</span>
	<span class="n">PCH_UART_HANDLED_TX_INT_SHIFT</span><span class="p">,</span>
	<span class="n">PCH_UART_HANDLED_RX_ERR_INT_SHIFT</span><span class="p">,</span>
	<span class="n">PCH_UART_HANDLED_RX_TRG_INT_SHIFT</span><span class="p">,</span>
	<span class="n">PCH_UART_HANDLED_MS_INT_SHIFT</span><span class="p">,</span>
	<span class="n">PCH_UART_HANDLED_LS_INT_SHIFT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PCH_UART_8LINE</span><span class="p">,</span>
	<span class="n">PCH_UART_2LINE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define PCH_UART_DRIVER_DEVICE &quot;ttyPCH&quot;</span>

<span class="cm">/* Set the max number of UART port</span>
<span class="cm"> * Intel EG20T PCH: 4 port</span>
<span class="cm"> * LAPIS Semiconductor ML7213 IOH: 3 port</span>
<span class="cm"> * LAPIS Semiconductor ML7223 IOH: 2 port</span>
<span class="cm">*/</span>
<span class="cp">#define PCH_UART_NR	4</span>

<span class="cp">#define PCH_UART_HANDLED_RX_INT	(1&lt;&lt;((PCH_UART_HANDLED_RX_INT_SHIFT)&lt;&lt;1))</span>
<span class="cp">#define PCH_UART_HANDLED_TX_INT	(1&lt;&lt;((PCH_UART_HANDLED_TX_INT_SHIFT)&lt;&lt;1))</span>
<span class="cp">#define PCH_UART_HANDLED_RX_ERR_INT	(1&lt;&lt;((\</span>
<span class="cp">					PCH_UART_HANDLED_RX_ERR_INT_SHIFT)&lt;&lt;1))</span>
<span class="cp">#define PCH_UART_HANDLED_RX_TRG_INT	(1&lt;&lt;((\</span>
<span class="cp">					PCH_UART_HANDLED_RX_TRG_INT_SHIFT)&lt;&lt;1))</span>
<span class="cp">#define PCH_UART_HANDLED_MS_INT	(1&lt;&lt;((PCH_UART_HANDLED_MS_INT_SHIFT)&lt;&lt;1))</span>

<span class="cp">#define PCH_UART_HANDLED_LS_INT	(1&lt;&lt;((PCH_UART_HANDLED_LS_INT_SHIFT)&lt;&lt;1))</span>

<span class="cp">#define PCH_UART_RBR		0x00</span>
<span class="cp">#define PCH_UART_THR		0x00</span>

<span class="cp">#define PCH_UART_IER_MASK	(PCH_UART_IER_ERBFI|PCH_UART_IER_ETBEI|\</span>
<span class="cp">				PCH_UART_IER_ELSI|PCH_UART_IER_EDSSI)</span>
<span class="cp">#define PCH_UART_IER_ERBFI	0x00000001</span>
<span class="cp">#define PCH_UART_IER_ETBEI	0x00000002</span>
<span class="cp">#define PCH_UART_IER_ELSI	0x00000004</span>
<span class="cp">#define PCH_UART_IER_EDSSI	0x00000008</span>

<span class="cp">#define PCH_UART_IIR_IP			0x00000001</span>
<span class="cp">#define PCH_UART_IIR_IID		0x00000006</span>
<span class="cp">#define PCH_UART_IIR_MSI		0x00000000</span>
<span class="cp">#define PCH_UART_IIR_TRI		0x00000002</span>
<span class="cp">#define PCH_UART_IIR_RRI		0x00000004</span>
<span class="cp">#define PCH_UART_IIR_REI		0x00000006</span>
<span class="cp">#define PCH_UART_IIR_TOI		0x00000008</span>
<span class="cp">#define PCH_UART_IIR_FIFO256		0x00000020</span>
<span class="cp">#define PCH_UART_IIR_FIFO64		PCH_UART_IIR_FIFO256</span>
<span class="cp">#define PCH_UART_IIR_FE			0x000000C0</span>

<span class="cp">#define PCH_UART_FCR_FIFOE		0x00000001</span>
<span class="cp">#define PCH_UART_FCR_RFR		0x00000002</span>
<span class="cp">#define PCH_UART_FCR_TFR		0x00000004</span>
<span class="cp">#define PCH_UART_FCR_DMS		0x00000008</span>
<span class="cp">#define PCH_UART_FCR_FIFO256		0x00000020</span>
<span class="cp">#define PCH_UART_FCR_RFTL		0x000000C0</span>

<span class="cp">#define PCH_UART_FCR_RFTL1		0x00000000</span>
<span class="cp">#define PCH_UART_FCR_RFTL64		0x00000040</span>
<span class="cp">#define PCH_UART_FCR_RFTL128		0x00000080</span>
<span class="cp">#define PCH_UART_FCR_RFTL224		0x000000C0</span>
<span class="cp">#define PCH_UART_FCR_RFTL16		PCH_UART_FCR_RFTL64</span>
<span class="cp">#define PCH_UART_FCR_RFTL32		PCH_UART_FCR_RFTL128</span>
<span class="cp">#define PCH_UART_FCR_RFTL56		PCH_UART_FCR_RFTL224</span>
<span class="cp">#define PCH_UART_FCR_RFTL4		PCH_UART_FCR_RFTL64</span>
<span class="cp">#define PCH_UART_FCR_RFTL8		PCH_UART_FCR_RFTL128</span>
<span class="cp">#define PCH_UART_FCR_RFTL14		PCH_UART_FCR_RFTL224</span>
<span class="cp">#define PCH_UART_FCR_RFTL_SHIFT		6</span>

<span class="cp">#define PCH_UART_LCR_WLS	0x00000003</span>
<span class="cp">#define PCH_UART_LCR_STB	0x00000004</span>
<span class="cp">#define PCH_UART_LCR_PEN	0x00000008</span>
<span class="cp">#define PCH_UART_LCR_EPS	0x00000010</span>
<span class="cp">#define PCH_UART_LCR_SP		0x00000020</span>
<span class="cp">#define PCH_UART_LCR_SB		0x00000040</span>
<span class="cp">#define PCH_UART_LCR_DLAB	0x00000080</span>
<span class="cp">#define PCH_UART_LCR_NP		0x00000000</span>
<span class="cp">#define PCH_UART_LCR_OP		PCH_UART_LCR_PEN</span>
<span class="cp">#define PCH_UART_LCR_EP		(PCH_UART_LCR_PEN | PCH_UART_LCR_EPS)</span>
<span class="cp">#define PCH_UART_LCR_1P		(PCH_UART_LCR_PEN | PCH_UART_LCR_SP)</span>
<span class="cp">#define PCH_UART_LCR_0P		(PCH_UART_LCR_PEN | PCH_UART_LCR_EPS |\</span>
<span class="cp">				PCH_UART_LCR_SP)</span>

<span class="cp">#define PCH_UART_LCR_5BIT	0x00000000</span>
<span class="cp">#define PCH_UART_LCR_6BIT	0x00000001</span>
<span class="cp">#define PCH_UART_LCR_7BIT	0x00000002</span>
<span class="cp">#define PCH_UART_LCR_8BIT	0x00000003</span>

<span class="cp">#define PCH_UART_MCR_DTR	0x00000001</span>
<span class="cp">#define PCH_UART_MCR_RTS	0x00000002</span>
<span class="cp">#define PCH_UART_MCR_OUT	0x0000000C</span>
<span class="cp">#define PCH_UART_MCR_LOOP	0x00000010</span>
<span class="cp">#define PCH_UART_MCR_AFE	0x00000020</span>

<span class="cp">#define PCH_UART_LSR_DR		0x00000001</span>
<span class="cp">#define PCH_UART_LSR_ERR	(1&lt;&lt;7)</span>

<span class="cp">#define PCH_UART_MSR_DCTS	0x00000001</span>
<span class="cp">#define PCH_UART_MSR_DDSR	0x00000002</span>
<span class="cp">#define PCH_UART_MSR_TERI	0x00000004</span>
<span class="cp">#define PCH_UART_MSR_DDCD	0x00000008</span>
<span class="cp">#define PCH_UART_MSR_CTS	0x00000010</span>
<span class="cp">#define PCH_UART_MSR_DSR	0x00000020</span>
<span class="cp">#define PCH_UART_MSR_RI		0x00000040</span>
<span class="cp">#define PCH_UART_MSR_DCD	0x00000080</span>
<span class="cp">#define PCH_UART_MSR_DELTA	(PCH_UART_MSR_DCTS | PCH_UART_MSR_DDSR |\</span>
<span class="cp">				PCH_UART_MSR_TERI | PCH_UART_MSR_DDCD)</span>

<span class="cp">#define PCH_UART_DLL		0x00</span>
<span class="cp">#define PCH_UART_DLM		0x01</span>

<span class="cp">#define PCH_UART_BRCSR		0x0E</span>

<span class="cp">#define PCH_UART_IID_RLS	(PCH_UART_IIR_REI)</span>
<span class="cp">#define PCH_UART_IID_RDR	(PCH_UART_IIR_RRI)</span>
<span class="cp">#define PCH_UART_IID_RDR_TO	(PCH_UART_IIR_RRI | PCH_UART_IIR_TOI)</span>
<span class="cp">#define PCH_UART_IID_THRE	(PCH_UART_IIR_TRI)</span>
<span class="cp">#define PCH_UART_IID_MS		(PCH_UART_IIR_MSI)</span>

<span class="cp">#define PCH_UART_HAL_PARITY_NONE	(PCH_UART_LCR_NP)</span>
<span class="cp">#define PCH_UART_HAL_PARITY_ODD		(PCH_UART_LCR_OP)</span>
<span class="cp">#define PCH_UART_HAL_PARITY_EVEN	(PCH_UART_LCR_EP)</span>
<span class="cp">#define PCH_UART_HAL_PARITY_FIX1	(PCH_UART_LCR_1P)</span>
<span class="cp">#define PCH_UART_HAL_PARITY_FIX0	(PCH_UART_LCR_0P)</span>
<span class="cp">#define PCH_UART_HAL_5BIT		(PCH_UART_LCR_5BIT)</span>
<span class="cp">#define PCH_UART_HAL_6BIT		(PCH_UART_LCR_6BIT)</span>
<span class="cp">#define PCH_UART_HAL_7BIT		(PCH_UART_LCR_7BIT)</span>
<span class="cp">#define PCH_UART_HAL_8BIT		(PCH_UART_LCR_8BIT)</span>
<span class="cp">#define PCH_UART_HAL_STB1		0</span>
<span class="cp">#define PCH_UART_HAL_STB2		(PCH_UART_LCR_STB)</span>

<span class="cp">#define PCH_UART_HAL_CLR_TX_FIFO	(PCH_UART_FCR_TFR)</span>
<span class="cp">#define PCH_UART_HAL_CLR_RX_FIFO	(PCH_UART_FCR_RFR)</span>
<span class="cp">#define PCH_UART_HAL_CLR_ALL_FIFO	(PCH_UART_HAL_CLR_TX_FIFO | \</span>
<span class="cp">					PCH_UART_HAL_CLR_RX_FIFO)</span>

<span class="cp">#define PCH_UART_HAL_DMA_MODE0		0</span>
<span class="cp">#define PCH_UART_HAL_FIFO_DIS		0</span>
<span class="cp">#define PCH_UART_HAL_FIFO16		(PCH_UART_FCR_FIFOE)</span>
<span class="cp">#define PCH_UART_HAL_FIFO256		(PCH_UART_FCR_FIFOE | \</span>
<span class="cp">					PCH_UART_FCR_FIFO256)</span>
<span class="cp">#define PCH_UART_HAL_FIFO64		(PCH_UART_HAL_FIFO256)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER1		(PCH_UART_FCR_RFTL1)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER64		(PCH_UART_FCR_RFTL64)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER128		(PCH_UART_FCR_RFTL128)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER224		(PCH_UART_FCR_RFTL224)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER16		(PCH_UART_FCR_RFTL16)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER32		(PCH_UART_FCR_RFTL32)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER56		(PCH_UART_FCR_RFTL56)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER4		(PCH_UART_FCR_RFTL4)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER8		(PCH_UART_FCR_RFTL8)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER14		(PCH_UART_FCR_RFTL14)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER_L		(PCH_UART_FCR_RFTL64)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER_M		(PCH_UART_FCR_RFTL128)</span>
<span class="cp">#define PCH_UART_HAL_TRIGGER_H		(PCH_UART_FCR_RFTL224)</span>

<span class="cp">#define PCH_UART_HAL_RX_INT		(PCH_UART_IER_ERBFI)</span>
<span class="cp">#define PCH_UART_HAL_TX_INT		(PCH_UART_IER_ETBEI)</span>
<span class="cp">#define PCH_UART_HAL_RX_ERR_INT		(PCH_UART_IER_ELSI)</span>
<span class="cp">#define PCH_UART_HAL_MS_INT		(PCH_UART_IER_EDSSI)</span>
<span class="cp">#define PCH_UART_HAL_ALL_INT		(PCH_UART_IER_MASK)</span>

<span class="cp">#define PCH_UART_HAL_DTR		(PCH_UART_MCR_DTR)</span>
<span class="cp">#define PCH_UART_HAL_RTS		(PCH_UART_MCR_RTS)</span>
<span class="cp">#define PCH_UART_HAL_OUT		(PCH_UART_MCR_OUT)</span>
<span class="cp">#define PCH_UART_HAL_LOOP		(PCH_UART_MCR_LOOP)</span>
<span class="cp">#define PCH_UART_HAL_AFE		(PCH_UART_MCR_AFE)</span>

<span class="cp">#define PCI_VENDOR_ID_ROHM		0x10DB</span>

<span class="cp">#define BOTH_EMPTY (UART_LSR_TEMT | UART_LSR_THRE)</span>

<span class="cp">#define DEFAULT_UARTCLK   1843200 </span><span class="cm">/*   1.8432 MHz */</span><span class="cp"></span>
<span class="cp">#define CMITC_UARTCLK   192000000 </span><span class="cm">/* 192.0000 MHz */</span><span class="cp"></span>
<span class="cp">#define FRI2_64_UARTCLK  64000000 </span><span class="cm">/*  64.0000 MHz */</span><span class="cp"></span>
<span class="cp">#define FRI2_48_UARTCLK  48000000 </span><span class="cm">/*  48.0000 MHz */</span><span class="cp"></span>
<span class="cp">#define NTC1_UARTCLK     64000000 </span><span class="cm">/*  64.0000 MHz */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pch_uart_buffer</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_type</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">membase</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uartclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_empty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trigger</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trigger_level</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_uart_buffer</span> <span class="n">rxbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">use_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">desc_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">desc_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_dma_slave</span>		<span class="n">param_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_dma_slave</span>		<span class="n">param_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="o">*</span><span class="n">sg_tx_p</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">nent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="n">sg_rx</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">tx_dma_use</span><span class="p">;</span>
	<span class="kt">void</span>				<span class="o">*</span><span class="n">rx_buf_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">rx_buf_dma</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dentry</span>	<span class="o">*</span><span class="n">debugfs</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct pch_uart_driver_data - private data structure for UART-DMA</span>
<span class="cm"> * @port_type:			The number of DMA channel</span>
<span class="cm"> * @line_no:			UART port line number (0, 1, 2...)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pch_uart_driver_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_no</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pch_uart_num_t</span> <span class="p">{</span>
	<span class="n">pch_et20t_uart0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">pch_et20t_uart1</span><span class="p">,</span>
	<span class="n">pch_et20t_uart2</span><span class="p">,</span>
	<span class="n">pch_et20t_uart3</span><span class="p">,</span>
	<span class="n">pch_ml7213_uart0</span><span class="p">,</span>
	<span class="n">pch_ml7213_uart1</span><span class="p">,</span>
	<span class="n">pch_ml7213_uart2</span><span class="p">,</span>
	<span class="n">pch_ml7223_uart0</span><span class="p">,</span>
	<span class="n">pch_ml7223_uart1</span><span class="p">,</span>
	<span class="n">pch_ml7831_uart0</span><span class="p">,</span>
	<span class="n">pch_ml7831_uart1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pch_uart_driver_data</span> <span class="n">drv_dat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">pch_et20t_uart0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_8LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_et20t_uart1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_et20t_uart2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_et20t_uart3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7213_uart0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_8LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7213_uart1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7213_uart2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7223_uart0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_8LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7223_uart1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7831_uart0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_8LINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">pch_ml7831_uart1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">PCH_UART_2LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SERIAL_PCH_UART_CONSOLE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">PCH_UART_NR</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">default_baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user_uartclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">trigger_level_256</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">224</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">trigger_level_64</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">56</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">trigger_level_16</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">14</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">trigger_level_1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="cp">#define PCH_REGS_BUFSIZE	1024</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">port_show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lcr</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PCH_REGS_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;PCH EG20T port[%d] regs:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;=================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;IER: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;IIR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;LCR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;MCR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;LSR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;MSR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;BRCSR: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_BRCSR</span><span class="p">));</span>

	<span class="n">lcr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_LCR_DLAB</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;DLL: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_DLL</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCH_REGS_BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;DLM: </span><span class="se">\t</span><span class="s">0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_DLM</span><span class="p">));</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">lcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PCH_REGS_BUFSIZE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">PCH_REGS_BUFSIZE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">port_regs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">port_show_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="cm">/* Return UART clock, checking for board specific clocks. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_get_uartclk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_uartclk</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">user_uartclk</span><span class="p">;</span>

	<span class="n">cmp</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s">&quot;CM-iTC&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">CMITC_UARTCLK</span><span class="p">;</span>

	<span class="n">cmp</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&amp;&amp;</span> <span class="n">strnstr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s">&quot;FRI2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FRI2_64_UARTCLK</span><span class="p">;</span>

	<span class="n">cmp</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s">&quot;Fish River Island II&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FRI2_48_UARTCLK</span><span class="p">;</span>

	<span class="cm">/* Kontron COMe-mTT10 (nanoETXexpress-TT) */</span>
	<span class="n">cmp</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s">&quot;COMe-mTT&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">strstr</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="s">&quot;nanoETXexpress-TT&quot;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">NTC1_UARTCLK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">DEFAULT_UARTCLK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="n">PCH_UART_IER_MASK</span><span class="p">;</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
	<span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">PCH_UART_IER_MASK</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_hal_set_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parity</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dll</span><span class="p">,</span> <span class="n">dlm</span><span class="p">,</span> <span class="n">lcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">USHRT_MAX</span> <span class="o">&lt;=</span> <span class="n">div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid Baud(div=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dll</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x00FFU</span><span class="p">;</span>
	<span class="n">dlm</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parity</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PCH_UART_LCR_PEN</span> <span class="o">|</span> <span class="n">PCH_UART_LCR_EPS</span> <span class="o">|</span> <span class="n">PCH_UART_LCR_SP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid parity(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parity</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_UART_LCR_WLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid bits(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_UART_LCR_STB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid STB(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lcr</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>
	<span class="n">lcr</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">lcr</span> <span class="o">|=</span> <span class="n">stb</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:baud = %d, div = %04x, lcr = %02x (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">lcr</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_LCR_DLAB</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">dll</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_DLL</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_DLM</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">lcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_hal_fifo_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PCH_UART_FCR_TFR</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_RFR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Invalid flag(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_FCR_FIFOE</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_FCR_FIFOE</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">|</span> <span class="n">flag</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_hal_set_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmamode</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmamode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_UART_FCR_DMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Invalid DMA Mode(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dmamode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PCH_UART_FCR_FIFOE</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_FIFO256</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Invalid FIFO SIZE(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCH_UART_FCR_RFTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Invalid TRIGGER(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">trigger</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span>
		    <span class="n">trigger_level_256</span><span class="p">[</span><span class="n">trigger</span> <span class="o">&gt;&gt;</span> <span class="n">PCH_UART_FCR_RFTL_SHIFT</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span>
		    <span class="n">trigger_level_64</span><span class="p">[</span><span class="n">trigger</span> <span class="o">&gt;&gt;</span> <span class="n">PCH_UART_FCR_RFTL_SHIFT</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span>
		    <span class="n">trigger_level_16</span><span class="p">[</span><span class="n">trigger</span> <span class="o">&gt;&gt;</span> <span class="n">PCH_UART_FCR_RFTL_SHIFT</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span>
		    <span class="n">trigger_level_1</span><span class="p">[</span><span class="n">trigger</span> <span class="o">&gt;&gt;</span> <span class="n">PCH_UART_FCR_RFTL_SHIFT</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fcr</span> <span class="o">=</span>
	    <span class="n">dmamode</span> <span class="o">|</span> <span class="n">fifo_size</span> <span class="o">|</span> <span class="n">trigger</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_RFR</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_TFR</span><span class="p">;</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_FCR_FIFOE</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">PCH_UART_FCR_FIFOE</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_RFR</span> <span class="o">|</span> <span class="n">PCH_UART_FCR_TFR</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">=</span> <span class="n">fcr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pch_uart_hal_get_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmsr</span> <span class="o">=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="n">PCH_UART_MSR_DELTA</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">msr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_hal_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">thr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_THR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_hal_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">rx_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rbr</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="n">lsr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lsr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_size</span> <span class="o">&amp;&amp;</span> <span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	     <span class="n">lsr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rbr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_RBR</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">pch_uart_hal_get_iid</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IIR</span><span class="p">)</span> <span class="o">&amp;</span>\
		      <span class="p">(</span><span class="n">PCH_UART_IIR_IID</span> <span class="o">|</span> <span class="n">PCH_UART_IIR_TOI</span> <span class="o">|</span> <span class="n">PCH_UART_IIR_IP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pch_uart_hal_get_line_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_hal_set_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcr</span><span class="p">;</span>

	<span class="n">lcr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">lcr</span> <span class="o">|=</span> <span class="n">PCH_UART_LCR_SB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCH_UART_LCR_SB</span><span class="p">;</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">lcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:tty is busy now&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pop_tx_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:X character send %02x (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_push_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">room</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:tty is busy now&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">room</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx overrun: dropping %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">size</span> <span class="o">-</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">room</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">room</span><span class="p">;</span>

	<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_rx</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">room</span><span class="p">;</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">room</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_free_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_virt</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_dma</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_dma_slave</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">==</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">chan_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">==</span>
						  <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_request_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dma_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_dma_slave</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
				<span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">dma_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				       <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mh">0xa</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span> <span class="cm">/* Get DMA&#39;s dev</span>
<span class="cm">								information */</span>
	<span class="cm">/* Set Tx DMA */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_tx</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Tx = 0, 2, 4, ... */</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">UART_TX</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:dma_request_channel FAILS(Tx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="cm">/* Set Rx DMA */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_rx</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Rx = Tx + 1 */</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">rx_reg</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">UART_RX</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:dma_request_channel FAILS(Rx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get Consistent memory for DMA */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_dma_rx_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:tty is busy now&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_rx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">dma_push_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desc_rx</span><span class="p">);</span>
	<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_dma_tx_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;=</span> <span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">desc_tx</span><span class="p">);</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nent</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dma_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">);</span>
	<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_tx_stopped</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pop_tx_end</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cnt_to_end</span> <span class="o">=</span>
		    <span class="n">CIRC_CNT_TO_END</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">UART_XMIT_SIZE</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span> <span class="n">cnt_to_end</span><span class="p">);</span>
		<span class="n">pch_uart_hal_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">sz</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">);</span>

<span class="nl">pop_tx_end:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d characters. Remained %d characters.(%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">count</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">count</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_rx_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_uart_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rx_size</span> <span class="o">=</span> <span class="n">pch_uart_hal_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">push_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rx_size</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCH_UART_HANDLED_RX_INT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">handle_rx_to</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_handle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_rx</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_rx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Initialize SG table */</span>

	<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span><span class="p">;</span>

	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_rx</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_virt</span><span class="p">),</span>
		     <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_virt</span> <span class="o">&amp;</span>
		     <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

	<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf_dma</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">,</span>
			<span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">,</span>
			<span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">desc_rx</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">pch_dma_rx_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCH_UART_HANDLED_RX_INT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">handle_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_empty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Tx isn&#39;t started. (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pop_tx_x</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pch_uart_hal_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo_size</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">fifo_size</span><span class="p">;</span>

	<span class="n">tx_size</span> <span class="o">=</span> <span class="n">pop_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">tx_size</span><span class="p">;</span>
		<span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="n">tx_empty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCH_UART_HANDLED_TX_INT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dma_handle_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_empty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Tx isn&#39;t started. (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dma_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:Tx is not completed. (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pop_tx_x</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pch_uart_hal_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo_size</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span>
			     <span class="n">UART_XMIT_SIZE</span><span class="p">),</span> <span class="n">CIRC_CNT_TO_END</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
			     <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">UART_XMIT_SIZE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s 0 bytes return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">fifo_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">fifo_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">fifo_size</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s num=%d size=%d rem=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dma_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span> <span class="cm">/* Initialize SG table */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span>
				    <span class="n">rem</span><span class="p">,</span> <span class="n">fifo_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span>
				    <span class="n">size</span><span class="p">,</span> <span class="n">fifo_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">;</span>
	<span class="n">nent</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:dma_map_sg Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nent</span> <span class="o">=</span> <span class="n">nent</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
			      <span class="n">fifo_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">rem</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">,</span>
					<span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:device_prep_slave_sg Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_sync_sg_for_device</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sg_tx_p</span><span class="p">,</span> <span class="n">nent</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">desc_tx</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">pch_dma_tx_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCH_UART_HANDLED_TX_INT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_err_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fcr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="cm">/* Reset FIFO */</span>
	<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_CLEAR_RCVR</span><span class="p">;</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_FCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">PCH_UART_LSR_ERR</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error data in FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Framing Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Overrun Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pch_uart_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iid</span> <span class="o">=</span> <span class="n">pch_uart_hal_get_iid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iid</span> <span class="o">&amp;</span> <span class="n">PCH_UART_IIR_IP</span><span class="p">)</span> <span class="cm">/* No Interrupt */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCH_UART_IID_RLS</span>:	<span class="cm">/* Receiver Line Status */</span>
			<span class="n">lsr</span> <span class="o">=</span> <span class="n">pch_uart_hal_get_line_status</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCH_UART_LSR_ERR</span> <span class="o">|</span> <span class="n">UART_LSR_FE</span> <span class="o">|</span>
						<span class="n">UART_LSR_PE</span> <span class="o">|</span> <span class="n">UART_LSR_OE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pch_uart_err_ir</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">lsr</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PCH_UART_HANDLED_RX_ERR_INT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PCH_UART_HANDLED_LS_INT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_UART_IID_RDR</span>:	<span class="cm">/* Received Data Ready */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
							<span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_handle_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
					<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
							<span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_UART_IID_RDR_TO</span>:	<span class="cm">/* Received Data Ready</span>
<span class="cm">						   (FIFO Timeout) */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_rx_to</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_UART_IID_THRE</span>:	<span class="cm">/* Transmitter Holding Register</span>
<span class="cm">						   Empty */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_handle_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_UART_IID_MS</span>:	<span class="cm">/* Modem Status */</span>
			<span class="n">msr</span> <span class="o">=</span> <span class="n">pch_uart_hal_get_modem</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* MS ir prioirty is the lowest. So, MS ir</span>
<span class="cm">				     means final interrupt */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">PCH_UART_HANDLED_MS_INT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Never junp to this label */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:iid=%02x (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">iid</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function tests whether the transmitter fifo and shifter for the port</span>
<span class="cm">						described by &#39;port&#39; is empty. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pch_uart_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns the current state of modem control inputs. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pch_uart_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">modem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">modem</span> <span class="o">=</span> <span class="n">pch_uart_hal_get_modem</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modem</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modem</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_RNG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modem</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modem</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_LOOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">UART_MCR_AFE</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_AFE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span><span class="p">)</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">mcr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_MCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dma_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dma_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : Tx DMA is NOT empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TX_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable the modem status interrupts. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_MS_INT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Control the transmission of a break signal. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pch_uart_hal_set_break</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Grab any interrupt resources and initialise any low level driver state. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trigger_level</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>

	<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_ALL_INT</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_uart_hal_set_line</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">default_baud</span><span class="p">,</span>
			      <span class="n">PCH_UART_HAL_PARITY_NONE</span><span class="p">,</span> <span class="n">PCH_UART_HAL_8BIT</span><span class="p">,</span>
			      <span class="n">PCH_UART_HAL_STB1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_FIFO256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_FIFO64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_FIFO16</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="nl">default:</span>
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_FIFO_DIS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCH_UART_HAL_TRIGGER1</span>:
		<span class="n">trigger_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_UART_HAL_TRIGGER_L</span>:
		<span class="n">trigger_level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_UART_HAL_TRIGGER_M</span>:
		<span class="n">trigger_level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCH_UART_HAL_TRIGGER_H</span>:
	<span class="nl">default:</span>
		<span class="n">trigger_level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span> <span class="n">trigger_level</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_uart_hal_set_fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_DMA_MODE0</span><span class="p">,</span>
				    <span class="n">fifo_size</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">pch_uart_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">pch_request_dma</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pch_uart_hal_enable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_RX_INT</span><span class="p">);</span>
	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">CS8</span><span class="p">,</span> <span class="n">default_baud</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_ALL_INT</span><span class="p">);</span>
	<span class="n">pch_uart_hal_fifo_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_CLR_ALL_FIFO</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_uart_hal_set_fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_DMA_MODE0</span><span class="p">,</span>
			      <span class="n">PCH_UART_HAL_FIFO_DIS</span><span class="p">,</span> <span class="n">PCH_UART_HAL_TRIGGER1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pch_uart_hal_set_fifo Failed(ret=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">pch_free_dma</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Change the port parameters, including word length, parity, stop</span>
<span class="cm"> *bits.  Update read_status_mask and ignore_status_mask to indicate</span>
<span class="cm"> *the types of events we are interested in receiving.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">stb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_5BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_6BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_7BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* CS8 */</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_8BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">stb</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_STB2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">stb</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_STB1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
			<span class="n">parity</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_PARITY_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">parity</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_PARITY_EVEN</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">parity</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_PARITY_NONE</span><span class="p">;</span>

	<span class="cm">/* Only UART0 has auto hardware flow function */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">==</span> <span class="mi">256</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_AFE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_AFE</span><span class="p">;</span>

	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span> <span class="cm">/* Mark/Space parity is not supported */</span>

	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">/</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="n">rtn</span> <span class="o">=</span> <span class="n">pch_uart_hal_set_line</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">stb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pch_uart_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t rewrite B0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">))</span>
		<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pch_uart_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">KBUILD_MODNAME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">membase</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">membase</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">membase</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">UART_CONFIG_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">;</span>
		<span class="n">pch_uart_request_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">serinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_LOW_LATENCY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;PCH UART : Use PIO Mode (without DMA)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">serinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UPF_LOW_LATENCY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_PCH_DMA</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : PCH DMA is not Loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCH UART : Use DMA Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
			<span class="n">pch_request_dma</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">pch_uart_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="n">pch_uart_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span> <span class="o">=</span> <span class="n">pch_uart_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span> <span class="o">=</span> <span class="n">pch_uart_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span> <span class="o">=</span> <span class="n">pch_uart_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span> <span class="o">=</span> <span class="n">pch_uart_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span> <span class="o">=</span> <span class="n">pch_uart_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span> <span class="o">=</span> <span class="n">pch_uart_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">pch_uart_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span> <span class="o">=</span> <span class="n">pch_uart_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">pch_uart_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">pch_uart_set_termios</span><span class="p">,</span>
<span class="cm">/*	.pm		= pch_uart_pm,		Not supported yet */</span>
<span class="cm">/*	.set_wake	= pch_uart_set_wake,	Not supported yet */</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pch_uart_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span> <span class="o">=</span> <span class="n">pch_uart_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span> <span class="o">=</span> <span class="n">pch_uart_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span> <span class="o">=</span> <span class="n">pch_uart_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span> <span class="o">=</span> <span class="n">pch_uart_verify_port</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SERIAL_PCH_UART_CONSOLE</span>

<span class="cm">/*</span>
<span class="cm"> *	Wait for transmitter &amp; holding register to empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_xmitr</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">tmout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="cm">/* Wait up to 10ms for the character(s) to be sent. */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_LSR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">==</span> <span class="n">bits</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">tmout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait up to 1s for flow control if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_CONS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmout</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">tmout</span><span class="p">;</span> <span class="n">tmout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_MSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">UART_LSR_THRE</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">PCH_UART_THR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Print a string to the serial port trying not to disturb</span>
<span class="cm"> *	any possible real use of the port...</span>
<span class="cm"> *</span>
<span class="cm"> *	The console_lock must be held when we get here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pch_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">touch_nmi_watchdog</span><span class="p">();</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">sysrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* serial8250_handle_port() already took the lock */</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	First save the IER then disable the interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>

	<span class="n">pch_uart_hal_disable_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PCH_UART_HAL_ALL_INT</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pch_console_putchar</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Finally, wait for transmitter to become empty</span>
<span class="cm">	 *	and restore the IER</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BOTH_EMPTY</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">UART_IER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pch_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="n">default_baud</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether an invalid uart number has been specified, and</span>
<span class="cm">	 * if so, search for the first available port that does have</span>
<span class="cm">	 * console support.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">PCH_UART_NR</span><span class="p">)</span>
		<span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">pch_uart_get_uartclk</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">pch_uart_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">pch_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">PCH_UART_DRIVER_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">pch_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">pch_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span> <span class="o">|</span> <span class="n">CON_ANYTIME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define PCH_CONSOLE	(&amp;pch_console)</span>
<span class="cp">#else</span>
<span class="cp">#define PCH_CONSOLE	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">pch_uart_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">PCH_UART_DRIVER_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">PCH_UART_NR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span> <span class="o">=</span> <span class="n">PCH_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="nf">pch_uart_init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifosize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_uart_driver_data</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/* for debugfs file name */</span>

	<span class="n">board</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drv_dat</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="n">port_type</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_port_alloc_err</span><span class="p">;</span>

	<span class="n">rxbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_port_free_txbuf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_UNKNOWN</span>:
		<span class="n">fifosize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* EG20T/ML7213: UART0 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_8250</span>:
		<span class="n">fifosize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* EG20T:UART1~3  ML7213: UART1~2*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid Port Type(=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">init_port_hal_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mapbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">fifosize</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">pch_uart_get_uartclk</span><span class="p">();</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_MAX_8250</span> <span class="o">+</span> <span class="n">port_type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_PORT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pch_uart_ops</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="n">fifosize</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">line_no</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">PCH_UART_HAL_TRIGGER_M</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trigger_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SERIAL_PCH_UART_CONSOLE</span>
	<span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">line_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_port_hal_free</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;uart%d_regs&quot;</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">line_no</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs_ops</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>

<span class="nl">init_port_hal_free:</span>
<span class="cp">#ifdef CONFIG_SERIAL_PCH_UART_CONSOLE</span>
	<span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">line_no</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxbuf</span><span class="p">);</span>
<span class="nl">init_port_free_txbuf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">init_port_alloc_err:</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_exit_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_uart_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SERIAL_PCH_UART_CONSOLE</span>
	<span class="n">pch_uart_ports</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pch_uart_exit_port</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_uart_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s-pci_enable_device failed(ret=%d) &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pch_uart_pci_suspend NULL</span>
<span class="cp">#define pch_uart_pci_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">pch_uart_pci_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x8811</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_et20t_uart0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x8812</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_et20t_uart1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x8813</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_et20t_uart2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x8814</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_et20t_uart3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x8027</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7213_uart0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x8028</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7213_uart1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x8029</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7213_uart2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x800C</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7223_uart0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x800D</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7223_uart1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x8811</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7831_uart0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ROHM</span><span class="p">,</span> <span class="mh">0x8812</span><span class="p">),</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">pch_ml7831_uart1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pch_uart_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg20t_port</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_error</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">pch_uart_init_port</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">probe_disable_device:</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">probe_error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pch_uart_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pch_uart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pch_uart_pci_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pch_uart_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pch_uart_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pch_uart_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pch_uart_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pch_uart_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* register as UART driver */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* register as PCI driver */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">pch_uart_module_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pch_uart_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_pci_driver</span><span class="p">);</span>
	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_uart_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pch_uart_module_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel EG20T PCH UART PCI Driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">default_baud</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_baud</span><span class="p">,</span>
                 <span class="s">&quot;Default BAUD for initial driver state and console (default 9600)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">user_uartclk</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">user_uartclk</span><span class="p">,</span>
                 <span class="s">&quot;Override UART default or board specific UART clock&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
