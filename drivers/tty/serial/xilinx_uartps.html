<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › xilinx_uartps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xilinx_uartps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Xilinx PS UART driver</span>
<span class="cm"> *</span>
<span class="cm"> * 2011 (c) Xilinx Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it</span>
<span class="cm"> * and/or modify it under the terms of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation;</span>
<span class="cm"> * either version 2 of the License, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define XUARTPS_TTY_NAME	&quot;ttyPS&quot;</span>
<span class="cp">#define XUARTPS_NAME		&quot;xuartps&quot;</span>
<span class="cp">#define XUARTPS_MAJOR		0	</span><span class="cm">/* use dynamic node allocation */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MINOR		0	</span><span class="cm">/* works best with devtmpfs */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_NR_PORTS	2</span>
<span class="cp">#define XUARTPS_FIFO_SIZE	16	</span><span class="cm">/* FIFO size */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_REGISTER_SPACE	0xFFF</span>

<span class="cp">#define xuartps_readl(offset)		ioread32(port-&gt;membase + offset)</span>
<span class="cp">#define xuartps_writel(val, offset)	iowrite32(val, port-&gt;membase + offset)</span>

<span class="cm">/********************************Register Map********************************/</span>
<span class="cm">/** UART</span>
<span class="cm"> *</span>
<span class="cm"> * Register offsets for the UART.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define XUARTPS_CR_OFFSET	0x00  </span><span class="cm">/* Control Register [8:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_OFFSET	0x04  </span><span class="cm">/* Mode Register [10:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IER_OFFSET	0x08  </span><span class="cm">/* Interrupt Enable [10:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IDR_OFFSET	0x0C  </span><span class="cm">/* Interrupt Disable [10:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IMR_OFFSET	0x10  </span><span class="cm">/* Interrupt Mask [10:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_ISR_OFFSET	0x14  </span><span class="cm">/* Interrupt Status [10:0]*/</span><span class="cp"></span>
<span class="cp">#define XUARTPS_BAUDGEN_OFFSET	0x18  </span><span class="cm">/* Baud Rate Generator [15:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_RXTOUT_OFFSET	0x1C  </span><span class="cm">/* RX Timeout [7:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_RXWM_OFFSET	0x20  </span><span class="cm">/* RX FIFO Trigger Level [5:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MODEMCR_OFFSET	0x24  </span><span class="cm">/* Modem Control [5:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MODEMSR_OFFSET	0x28  </span><span class="cm">/* Modem Status [8:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_SR_OFFSET	0x2C  </span><span class="cm">/* Channel Status [11:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_FIFO_OFFSET	0x30  </span><span class="cm">/* FIFO [15:0] or [7:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_BAUDDIV_OFFSET	0x34  </span><span class="cm">/* Baud Rate Divider [7:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_FLOWDEL_OFFSET	0x38  </span><span class="cm">/* Flow Delay [15:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IRRX_PWIDTH_OFFSET 0x3C </span><span class="cm">/* IR Minimum Received Pulse</span>
<span class="cm">						Width [15:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IRTX_PWIDTH_OFFSET 0x40 </span><span class="cm">/* IR Transmitted pulse</span>
<span class="cm">						Width [7:0] */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_TXWM_OFFSET	0x44  </span><span class="cm">/* TX FIFO Trigger Level [5:0] */</span><span class="cp"></span>

<span class="cm">/** Control Register</span>
<span class="cm"> *</span>
<span class="cm"> * The Control register (CR) controls the major functions of the device.</span>
<span class="cm"> *</span>
<span class="cm"> * Control Register Bit Definitions</span>
<span class="cm"> */</span>
<span class="cp">#define XUARTPS_CR_STOPBRK	0x00000100  </span><span class="cm">/* Stop TX break */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_STARTBRK	0x00000080  </span><span class="cm">/* Set TX break */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_TX_DIS	0x00000020  </span><span class="cm">/* TX disabled. */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_TX_EN	0x00000010  </span><span class="cm">/* TX enabled */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_RX_DIS	0x00000008  </span><span class="cm">/* RX disabled. */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_RX_EN	0x00000004  </span><span class="cm">/* RX enabled */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_TXRST	0x00000002  </span><span class="cm">/* TX logic reset */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_RXRST	0x00000001  </span><span class="cm">/* RX logic reset */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_CR_RST_TO	0x00000040  </span><span class="cm">/* Restart Timeout Counter */</span><span class="cp"></span>

<span class="cm">/** Mode Register</span>
<span class="cm"> *</span>
<span class="cm"> * The mode register (MR) defines the mode of transfer as well as the data</span>
<span class="cm"> * format. If this register is modified during transmission or reception,</span>
<span class="cm"> * data validity cannot be guaranteed.</span>
<span class="cm"> *</span>
<span class="cm"> * Mode Register Bit Definitions</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define XUARTPS_MR_CLKSEL		0x00000001  </span><span class="cm">/* Pre-scalar selection */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_CHMODE_L_LOOP	0x00000200  </span><span class="cm">/* Local loop back mode */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_CHMODE_NORM		0x00000000  </span><span class="cm">/* Normal mode */</span><span class="cp"></span>

<span class="cp">#define XUARTPS_MR_STOPMODE_2_BIT	0x00000080  </span><span class="cm">/* 2 stop bits */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_STOPMODE_1_BIT	0x00000000  </span><span class="cm">/* 1 stop bit */</span><span class="cp"></span>

<span class="cp">#define XUARTPS_MR_PARITY_NONE		0x00000020  </span><span class="cm">/* No parity mode */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_PARITY_MARK		0x00000018  </span><span class="cm">/* Mark parity mode */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_PARITY_SPACE		0x00000010  </span><span class="cm">/* Space parity mode */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_PARITY_ODD		0x00000008  </span><span class="cm">/* Odd parity mode */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_PARITY_EVEN		0x00000000  </span><span class="cm">/* Even parity mode */</span><span class="cp"></span>

<span class="cp">#define XUARTPS_MR_CHARLEN_6_BIT	0x00000006  </span><span class="cm">/* 6 bits data */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_CHARLEN_7_BIT	0x00000004  </span><span class="cm">/* 7 bits data */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_MR_CHARLEN_8_BIT	0x00000000  </span><span class="cm">/* 8 bits data */</span><span class="cp"></span>

<span class="cm">/** Interrupt Registers</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupt control logic uses the interrupt enable register (IER) and the</span>
<span class="cm"> * interrupt disable register (IDR) to set the value of the bits in the</span>
<span class="cm"> * interrupt mask register (IMR). The IMR determines whether to pass an</span>
<span class="cm"> * interrupt to the interrupt status register (ISR).</span>
<span class="cm"> * Writing a 1 to IER Enables an interrupt, writing a 1 to IDR disables an</span>
<span class="cm"> * interrupt. IMR and ISR are read only, and IER and IDR are write only.</span>
<span class="cm"> * Reading either IER or IDR returns 0x00.</span>
<span class="cm"> *</span>
<span class="cm"> * All four registers have the same bit definitions.</span>
<span class="cm"> */</span>
<span class="cp">#define XUARTPS_IXR_TOUT	0x00000100 </span><span class="cm">/* RX Timeout error interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_PARITY	0x00000080 </span><span class="cm">/* Parity error interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_FRAMING	0x00000040 </span><span class="cm">/* Framing error interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_OVERRUN	0x00000020 </span><span class="cm">/* Overrun error interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_TXFULL	0x00000010 </span><span class="cm">/* TX FIFO Full interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_TXEMPTY	0x00000008 </span><span class="cm">/* TX FIFO empty interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_ISR_RXEMPTY	0x00000002 </span><span class="cm">/* RX FIFO empty interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_RXTRIG	0x00000001 </span><span class="cm">/* RX FIFO trigger interrupt */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_RXFULL	0x00000004 </span><span class="cm">/* RX FIFO full interrupt. */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_RXEMPTY	0x00000002 </span><span class="cm">/* RX FIFO empty interrupt. */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_IXR_MASK	0x00001FFF </span><span class="cm">/* Valid bit mask */</span><span class="cp"></span>

<span class="cm">/** Channel Status Register</span>
<span class="cm"> *</span>
<span class="cm"> * The channel status register (CSR) is provided to enable the control logic</span>
<span class="cm"> * to monitor the status of bits in the channel interrupt status register,</span>
<span class="cm"> * even if these are masked out by the interrupt mask register.</span>
<span class="cm"> */</span>
<span class="cp">#define XUARTPS_SR_RXEMPTY	0x00000002 </span><span class="cm">/* RX FIFO empty */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_SR_TXEMPTY	0x00000008 </span><span class="cm">/* TX FIFO empty */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_SR_TXFULL	0x00000010 </span><span class="cm">/* TX FIFO full */</span><span class="cp"></span>
<span class="cp">#define XUARTPS_SR_RXTRIG	0x00000001 </span><span class="cm">/* Rx Trigger */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_isr - Interrupt handler</span>
<span class="cm"> * @irq: Irq number</span>
<span class="cm"> * @dev_id: Id of the port</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQHANDLED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">xuartps_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isrstatus</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

	<span class="cm">/* Get the tty which could be NULL so don&#39;t assume it&#39;s valid */</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Read the interrupt status register to determine which</span>
<span class="cm">	 * interrupt(s) is/are active.</span>
<span class="cm">	 */</span>
	<span class="n">isrstatus</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_ISR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* drop byte with parity error if IGNPAR specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_PARITY</span><span class="p">)</span>
		<span class="n">isrstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XUARTPS_IXR_RXTRIG</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_TOUT</span><span class="p">);</span>

	<span class="n">isrstatus</span> <span class="o">&amp;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
	<span class="n">isrstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_TOUT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_RXTRIG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Receive Timeout Interrupt */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_SR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">XUARTPS_SR_RXEMPTY</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XUARTPS_SR_RXEMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_FIFO_OFFSET</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_PARITY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_FRAMING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_OVERRUN</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">uart_insert_char</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">isrstatus</span><span class="p">,</span>
						<span class="n">XUARTPS_IXR_OVERRUN</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
						<span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Dispatch an appropriate handler */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isrstatus</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_TXEMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="n">XUARTPS_IXR_TXEMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_IXR_TXEMPTY</span><span class="p">,</span>
						<span class="n">XUARTPS_IDR_OFFSET</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">numbytes</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">;</span>
			<span class="cm">/* Break if no more data available in the UART buffer */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">numbytes</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="cm">/* Get the data from the UART circular buffer</span>
<span class="cm">				 * and write it to the xuartps&#39;s TX_FIFO</span>
<span class="cm">				 * register.</span>
<span class="cm">				 */</span>
				<span class="n">xuartps_writel</span><span class="p">(</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span>
					<span class="n">tail</span><span class="p">],</span> <span class="n">XUARTPS_FIFO_OFFSET</span><span class="p">);</span>

				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

				<span class="cm">/* Adjust the tail of the UART buffer and wrap</span>
<span class="cm">				 * the buffer if it reaches limit.</span>
<span class="cm">				 */</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> \
						<span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
				<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">isrstatus</span><span class="p">,</span> <span class="n">XUARTPS_ISR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* be sure to release the lock and tty before leaving */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_set_baud_rate - Calculate and set the baud rate</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @baud: Baud rate to set</span>
<span class="cm"> *</span>
<span class="cm"> * Returns baud rate, requested baud when possible, or actual baud when there</span>
<span class="cm"> *	was too much error</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">xuartps_set_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sel_clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">calc_baud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">brgr_val</span><span class="p">,</span> <span class="n">brdiv_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bauderror</span><span class="p">;</span>

	<span class="cm">/* Formula to obtain baud rate is</span>
<span class="cm">	 *	baud_tx/rx rate = sel_clk/CD * (BDIV + 1)</span>
<span class="cm">	 *	input_clk = (Uart User Defined Clock or Apb Clock)</span>
<span class="cm">	 *		depends on UCLKEN in MR Reg</span>
<span class="cm">	 *	sel_clk = input_clk or input_clk/8;</span>
<span class="cm">	 *		depends on CLKS in MR reg</span>
<span class="cm">	 *	CD and BDIV depends on values in</span>
<span class="cm">	 *			baud rate generate register</span>
<span class="cm">	 *			baud rate clock divisor register</span>
<span class="cm">	 */</span>
	<span class="n">sel_clk</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_MR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XUARTPS_MR_CLKSEL</span><span class="p">)</span>
		<span class="n">sel_clk</span> <span class="o">=</span> <span class="n">sel_clk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Find the best values for baud generation */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">brdiv_val</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">brdiv_val</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">;</span> <span class="n">brdiv_val</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">brgr_val</span> <span class="o">=</span> <span class="n">sel_clk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="p">(</span><span class="n">brdiv_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brgr_val</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">brgr_val</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">calc_baud</span> <span class="o">=</span> <span class="n">sel_clk</span> <span class="o">/</span> <span class="p">(</span><span class="n">brgr_val</span> <span class="o">*</span> <span class="p">(</span><span class="n">brdiv_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="n">calc_baud</span><span class="p">)</span>
			<span class="n">bauderror</span> <span class="o">=</span> <span class="n">baud</span> <span class="o">-</span> <span class="n">calc_baud</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bauderror</span> <span class="o">=</span> <span class="n">calc_baud</span> <span class="o">-</span> <span class="n">baud</span><span class="p">;</span>

		<span class="cm">/* use the values when percent error is acceptable */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">bauderror</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">calc_baud</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set the values for the new baud rate */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">brgr_val</span><span class="p">,</span> <span class="n">XUARTPS_BAUDGEN_OFFSET</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">brdiv_val</span><span class="p">,</span> <span class="n">XUARTPS_BAUDDIV_OFFSET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">calc_baud</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------Uart Operations---------------------------*/</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_start_tx -  Start transmitting bytes</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">numbytes</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">fifosize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="cm">/* Set the TX enable bit and clear the TX disable bit to enable the</span>
<span class="cm">	 * transmitter.</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XUARTPS_CR_TX_DIS</span><span class="p">)</span> <span class="o">|</span> <span class="n">XUARTPS_CR_TX_EN</span><span class="p">,</span>
		<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">numbytes</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_SR_OFFSET</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">XUARTPS_SR_TXFULL</span><span class="p">))</span> <span class="o">!=</span> <span class="n">XUARTPS_SR_TXFULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Break if no more data available in the UART buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Get the data from the UART circular buffer and</span>
<span class="cm">		 * write it to the xuartps&#39;s TX_FIFO register.</span>
<span class="cm">		 */</span>
		<span class="n">xuartps_writel</span><span class="p">(</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">],</span>
			<span class="n">XUARTPS_FIFO_OFFSET</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Adjust the tail of the UART buffer and wrap</span>
<span class="cm">		 * the buffer if it reaches limit.</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the TX Empty interrupt */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_IXR_TXEMPTY</span><span class="p">,</span> <span class="n">XUARTPS_IER_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_stop_tx - Stop TX</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="n">XUARTPS_CR_TX_DIS</span><span class="p">;</span>
	<span class="cm">/* Disable the transmitter */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">regval</span><span class="p">,</span> <span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_stop_rx - Stop RX</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">;</span>
	<span class="cm">/* Disable the receiver */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">regval</span><span class="p">,</span> <span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_tx_empty -  Check whether TX is empty</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns TIOCSER_TEMT on success, 0 otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">xuartps_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_ISR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XUARTPS_IXR_TXEMPTY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_break_ctl - Based on the input ctl we have to start or stop</span>
<span class="cm"> *			transmitting char breaks</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @ctl: Value based on which start or stop decision is taken</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_CR_STARTBRK</span> <span class="o">|</span> <span class="n">status</span><span class="p">,</span>
					<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XUARTPS_CR_STOPBRK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_CR_STOPBRK</span> <span class="o">|</span> <span class="n">status</span><span class="p">,</span>
					 <span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_set_termios - termios operations, handling data length, parity,</span>
<span class="cm"> *				stop bits, flow control, baud rate</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @termios: Handle to the input termios structure</span>
<span class="cm"> * @old: Values of the previously saved termios structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">mode_reg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Empty the receive FIFO 1st before making changes */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_SR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">XUARTPS_SR_RXEMPTY</span><span class="p">)</span> <span class="o">!=</span> <span class="n">XUARTPS_SR_RXEMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_FIFO_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the TX and RX to set baud rate */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">XUARTPS_CR_TX_DIS</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">),</span>
			<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Min baud rate = 6bps and Max Baud Rate is 10Mbps for 100Mhz clk */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">);</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">xuartps_set_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">))</span>
		<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the per-port timeout.</span>
<span class="cm">	 */</span>
	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* Set TX/RX Reset */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">XUARTPS_CR_TXRST</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RXRST</span><span class="p">),</span>
			<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Clear the RX disable and TX disable bits and then set the TX enable</span>
<span class="cm">	 * bit and RX enable bit to enable the transmitter and receiver.</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span>
		<span class="p">(</span><span class="n">ctrl_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XUARTPS_CR_TX_DIS</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">))</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">XUARTPS_CR_TX_EN</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_EN</span><span class="p">),</span>
			<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="n">xuartps_writel</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">XUARTPS_RXTOUT_OFFSET</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">XUARTPS_IXR_TXEMPTY</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_RXTRIG</span> <span class="o">|</span>
			<span class="n">XUARTPS_IXR_OVERRUN</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_TOUT</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">XUARTPS_IXR_PARITY</span> <span class="o">|</span>
		<span class="n">XUARTPS_IXR_FRAMING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">XUARTPS_IXR_PARITY</span> <span class="o">|</span>
			<span class="n">XUARTPS_IXR_FRAMING</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_OVERRUN</span><span class="p">;</span>

	<span class="cm">/* ignore all characters if CREAD is not set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">XUARTPS_IXR_RXTRIG</span> <span class="o">|</span>
			<span class="n">XUARTPS_IXR_TOUT</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_PARITY</span> <span class="o">|</span>
			<span class="n">XUARTPS_IXR_FRAMING</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_OVERRUN</span><span class="p">;</span>

	<span class="n">mode_reg</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_MR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Handling Data Size */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_CHARLEN_6_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_CHARLEN_7_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_CHARLEN_8_BIT</span><span class="p">;</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSIZE</span><span class="p">;</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">CS8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handling Parity and Stop Bits length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_STOPMODE_2_BIT</span><span class="p">;</span> <span class="cm">/* 2 STOP bits */</span>
	<span class="k">else</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_STOPMODE_1_BIT</span><span class="p">;</span> <span class="cm">/* 1 STOP bit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mark or Space parity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
				<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_PARITY_MARK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_PARITY_SPACE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
				<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_PARITY_ODD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_PARITY_EVEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">XUARTPS_MR_PARITY_NONE</span><span class="p">;</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">cval</span> <span class="p">,</span> <span class="n">XUARTPS_MR_OFFSET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_startup - Called when an application opens a xuartps port</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative error otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xuartps_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">xuartps_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XUARTPS_NAME</span><span class="p">,</span>
								<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Disable the TX and RX */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_CR_TX_DIS</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">,</span>
						<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Set the Control Register with TX/RX Enable, TX/RX Reset,</span>
<span class="cm">	 * no break chars.</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_CR_TXRST</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RXRST</span><span class="p">,</span>
				<span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Clear the RX disable and TX disable bits and then set the TX enable</span>
<span class="cm">	 * bit and RX enable bit to enable the transmitter and receiver.</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XUARTPS_CR_TX_DIS</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">))</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">XUARTPS_CR_TX_EN</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_EN</span> <span class="o">|</span>
			<span class="n">XUARTPS_CR_STOPBRK</span><span class="p">),</span> <span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Set the Mode Register with normal mode,8 data bits,1 stop bit,</span>
<span class="cm">	 * no parity.</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_MR_CHMODE_NORM</span> <span class="o">|</span> <span class="n">XUARTPS_MR_STOPMODE_1_BIT</span>
		<span class="o">|</span> <span class="n">XUARTPS_MR_PARITY_NONE</span> <span class="o">|</span> <span class="n">XUARTPS_MR_CHARLEN_8_BIT</span><span class="p">,</span>
		 <span class="n">XUARTPS_MR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Set the RX FIFO Trigger level to 14 assuming FIFO size as 16 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">XUARTPS_RXWM_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Receive Timeout register is enabled with value of 10 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">XUARTPS_RXTOUT_OFFSET</span><span class="p">);</span>


	<span class="cm">/* Set the Interrupt Registers with desired interrupts */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_IXR_TXEMPTY</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_PARITY</span> <span class="o">|</span>
		<span class="n">XUARTPS_IXR_FRAMING</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_OVERRUN</span> <span class="o">|</span>
		<span class="n">XUARTPS_IXR_RXTRIG</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_TOUT</span><span class="p">,</span> <span class="n">XUARTPS_IER_OFFSET</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">XUARTPS_IXR_TXEMPTY</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_PARITY</span> <span class="o">|</span>
		<span class="n">XUARTPS_IXR_FRAMING</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_OVERRUN</span> <span class="o">|</span>
		<span class="n">XUARTPS_IXR_RXTRIG</span> <span class="o">|</span> <span class="n">XUARTPS_IXR_TOUT</span><span class="p">),</span> <span class="n">XUARTPS_IDR_OFFSET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_shutdown - Called when an application closes a xuartps port</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_IMR_OFFSET</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">XUARTPS_IDR_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Disable the TX and RX */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">XUARTPS_CR_TX_DIS</span> <span class="o">|</span> <span class="n">XUARTPS_CR_RX_DIS</span><span class="p">,</span>
				 <span class="n">XUARTPS_CR_OFFSET</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_type - Set UART type to xuartps port</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns string on success, NULL otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">xuartps_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_XUARTPS</span> <span class="o">?</span> <span class="n">XUARTPS_NAME</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_verify_port - Verify the port params</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @ser: Handle to the structure whose members are compared</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if success otherwise -EINVAL</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xuartps_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_XUARTPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">UPIO_MEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">!=</span> <span class="n">ser</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">hub6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_request_port - Claim the memory region attached to xuartps port,</span>
<span class="cm"> *				called when the driver adds a xuartps port via</span>
<span class="cm"> *				uart_add_one_port()</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0, -ENOMEM if request fails</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xuartps_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">XUARTPS_REGISTER_SPACE</span><span class="p">,</span>
					 <span class="n">XUARTPS_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">XUARTPS_REGISTER_SPACE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">XUARTPS_REGISTER_SPACE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_release_port - Release the memory region attached to a xuartps</span>
<span class="cm"> *				port, called when the driver removes a xuartps</span>
<span class="cm"> *				port via uart_remove_one_port().</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">XUARTPS_REGISTER_SPACE</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_config_port - Configure xuartps, called when the driver adds a</span>
<span class="cm"> *				xuartps port</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @flags: If any</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UART_CONFIG_TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">xuartps_request_port</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_XUARTPS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_get_mctrl - Get the modem control state</span>
<span class="cm"> *</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the modem control state</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">xuartps_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TIOCM_CTS</span> <span class="o">|</span> <span class="n">TIOCM_DSR</span> <span class="o">|</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* N/A */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* N/A */</span>
<span class="p">}</span>

<span class="cm">/** The UART operations structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">xuartps_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">xuartps_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">xuartps_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">xuartps_enable_ms</span><span class="p">,</span>

	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">xuartps_start_tx</span><span class="p">,</span>	<span class="cm">/* Start transmitting */</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">xuartps_stop_tx</span><span class="p">,</span>	<span class="cm">/* Stop transmission */</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">xuartps_stop_rx</span><span class="p">,</span>	<span class="cm">/* Stop reception */</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">xuartps_tx_empty</span><span class="p">,</span>	<span class="cm">/* Transmitter busy? */</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">xuartps_break_ctl</span><span class="p">,</span>	<span class="cm">/* Start/stop</span>
<span class="cm">						 * transmitting break</span>
<span class="cm">						 */</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">xuartps_set_termios</span><span class="p">,</span>	<span class="cm">/* Set termios */</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">xuartps_startup</span><span class="p">,</span>	<span class="cm">/* App opens xuartps */</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">xuartps_shutdown</span><span class="p">,</span>	<span class="cm">/* App closes xuartps */</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">xuartps_type</span><span class="p">,</span>		<span class="cm">/* Set UART type */</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">xuartps_verify_port</span><span class="p">,</span>	<span class="cm">/* Verification of port</span>
<span class="cm">						 * params</span>
<span class="cm">						 */</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">xuartps_request_port</span><span class="p">,</span>	<span class="cm">/* Claim resources</span>
<span class="cm">						 * associated with a</span>
<span class="cm">						 * xuartps port</span>
<span class="cm">						 */</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">xuartps_release_port</span><span class="p">,</span>	<span class="cm">/* Release resources</span>
<span class="cm">						 * associated with a</span>
<span class="cm">						 * xuartps port</span>
<span class="cm">						 */</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">xuartps_config_port</span><span class="p">,</span>	<span class="cm">/* Configure when driver</span>
<span class="cm">						 * adds a xuartps port</span>
<span class="cm">						 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_port</span> <span class="n">xuartps_port</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_get_port - Configure the port from the platform device resource</span>
<span class="cm"> *			info</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to a uart_port or NULL for failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="nf">xuartps_get_port</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Find the next unused port */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">XUARTPS_NR_PORTS</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mapbase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">XUARTPS_NR_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="cm">/* At this point, we&#39;ve got an empty uart_port struct, initialize it */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">iobase</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* mark port in use */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_UNKNOWN</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM32</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_ops</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="n">XUARTPS_FIFO_SIZE</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span>	<span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------Console driver operations--------------------------*/</span>

<span class="cp">#ifdef CONFIG_SERIAL_XILINX_PS_UART_CONSOLE</span>
<span class="cm">/**</span>
<span class="cm"> * xuartps_console_wait_tx - Wait for the TX to be full</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_console_wait_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_SR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XUARTPS_SR_TXEMPTY</span><span class="p">)</span>
				<span class="o">!=</span> <span class="n">XUARTPS_SR_TXEMPTY</span><span class="p">)</span>
		<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_console_putchar - write the character to the FIFO buffer</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @ch: Character to be written</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xuartps_console_wait_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XUARTPS_FIFO_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_console_write - perform write operation</span>
<span class="cm"> * @port: Handle to the uart port structure</span>
<span class="cm"> * @s: Pointer to character array</span>
<span class="cm"> * @count: No of characters</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xuartps_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">imr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* save and disable interrupt */</span>
	<span class="n">imr</span> <span class="o">=</span> <span class="n">xuartps_readl</span><span class="p">(</span><span class="n">XUARTPS_IMR_OFFSET</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">imr</span><span class="p">,</span> <span class="n">XUARTPS_IDR_OFFSET</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">xuartps_console_putchar</span><span class="p">);</span>
	<span class="n">xuartps_console_wait_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* restore interrupt state, it seems like there may be a h/w bug</span>
<span class="cm">	 * in that the interrupt enable register should not need to be</span>
<span class="cm">	 * written based on the data sheet</span>
<span class="cm">	 */</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="o">~</span><span class="n">imr</span><span class="p">,</span> <span class="n">XUARTPS_IDR_OFFSET</span><span class="p">);</span>
	<span class="n">xuartps_writel</span><span class="p">(</span><span class="n">imr</span><span class="p">,</span> <span class="n">XUARTPS_IER_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_console_setup - Initialize the uart to default config</span>
<span class="cm"> * @co: Console handle</span>
<span class="cm"> * @options: Initial settings of uart</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0, -ENODEV if no device</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xuartps_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">XUARTPS_NR_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;console on ttyPS%i not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">xuartps_uart_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">xuartps_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">XUARTPS_TTY_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">xuartps_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>	<span class="o">=</span> <span class="n">xuartps_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* Specified on the cmdline (e.g. console=ttyPS ) */</span>
	<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_console_init - Initialization call</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative error otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xuartps_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">console_initcall</span><span class="p">(</span><span class="n">xuartps_console_init</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_XILINX_PS_UART_CONSOLE */</span><span class="cp"></span>

<span class="cm">/** Structure Definitions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">xuartps_uart_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>		<span class="cm">/* Owner */</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="n">XUARTPS_NAME</span><span class="p">,</span>		<span class="cm">/* Driver name */</span>
	<span class="p">.</span><span class="n">dev_name</span>	<span class="o">=</span> <span class="n">XUARTPS_TTY_NAME</span><span class="p">,</span>	<span class="cm">/* Node name */</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">XUARTPS_MAJOR</span><span class="p">,</span>	<span class="cm">/* Major number */</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="n">XUARTPS_MINOR</span><span class="p">,</span>	<span class="cm">/* Minor number */</span>
	<span class="p">.</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">XUARTPS_NR_PORTS</span><span class="p">,</span>	<span class="cm">/* Number of UART ports */</span>
<span class="cp">#ifdef CONFIG_SERIAL_XILINX_PS_UART_CONSOLE</span>
	<span class="p">.</span><span class="n">cons</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">xuartps_console</span><span class="p">,</span>	<span class="cm">/* Console */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Platform bus binding</span>
<span class="cm"> */</span>
<span class="cm">/**</span>
<span class="cm"> * xuartps_probe - Platform driver probe</span>
<span class="cm"> * @pdev: Pointer to the platform device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative error otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">xuartps_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">res2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_OF</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;clock&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no clock specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">res2</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Initialize the port structure */</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">xuartps_get_port</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get uart_port structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Register the port.</span>
<span class="cm">		 * This function also registers this device with the tty layer</span>
<span class="cm">		 * and triggers invocation of the config_port() entry point.</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;uart_add_one_port() failed; err=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_remove - called when the platform driver is unregistered</span>
<span class="cm"> * @pdev: Pointer to the platform device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative error otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">xuartps_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Remove the xuartps port from the serial core */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_suspend - suspend event</span>
<span class="cm"> * @pdev: Pointer to the platform device structure</span>
<span class="cm"> * @state: State of the device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xuartps_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Call the API provided in serial_core.c file which handles</span>
<span class="cm">	 * the suspend.</span>
<span class="cm">	 */</span>
	<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_resume - Resume after a previous suspend</span>
<span class="cm"> * @pdev: Pointer to the platform device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xuartps_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xuartps_port</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Match table for of_platform binding */</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">xuartps_of_match</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;xlnx,xuartps&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">xuartps_of_match</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define xuartps_of_match NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">xuartps_platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">xuartps_probe</span><span class="p">,</span>		<span class="cm">/* Probe method */</span>
	<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">xuartps_remove</span><span class="p">),</span>	<span class="cm">/* Detach method */</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">xuartps_suspend</span><span class="p">,</span>		<span class="cm">/* Suspend */</span>
	<span class="p">.</span><span class="n">resume</span>  <span class="o">=</span> <span class="n">xuartps_resume</span><span class="p">,</span>		<span class="cm">/* Resume after a suspend */</span>
	<span class="p">.</span><span class="n">driver</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">XUARTPS_NAME</span><span class="p">,</span>		<span class="cm">/* Driver name */</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">xuartps_of_match</span><span class="p">,</span>
		<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Module Init and Exit</span>
<span class="cm"> */</span>
<span class="cm">/**</span>
<span class="cm"> * xuartps_init - Initial driver registration call</span>
<span class="cm"> *</span>
<span class="cm"> * Returns whether the registration was successful or not</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xuartps_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Register the xuartps driver with the serial core */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Register the platform driver */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_platform_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * xuartps_exit - Driver unregistration call</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xuartps_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The order of unregistration is important. Unregister the</span>
<span class="cm">	 * UART driver before the platform driver crashes the system.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Unregister the platform driver */</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_platform_driver</span><span class="p">);</span>

	<span class="cm">/* Unregister the xuartps driver */</span>
	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xuartps_uart_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">xuartps_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xuartps_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for PS UART&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Xilinx Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
