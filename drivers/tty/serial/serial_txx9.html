<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › serial_txx9.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>serial_txx9.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Derived from many drivers using generic_serial interface,</span>
<span class="cm"> * especially serial_tx3912.c by Steven J. Hill and r39xx_serial.c</span>
<span class="cm"> * (was in Linux/VR tree) by Jim Pick.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999 Harald Koerfgen</span>
<span class="cm"> *  Copyright (C) 2000 Jim Pick &lt;jim@jimpick.com&gt;</span>
<span class="cm"> *  Copyright (C) 2001 Steven J. Hill (sjhill@realitydiluted.com)</span>
<span class="cm"> *  Copyright (C) 2000-2002 Toshiba Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Serial driver for TX3927/TX4927/TX4925/TX4938 internal SIO controller</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_SERIAL_TXX9_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_version</span> <span class="o">=</span> <span class="s">&quot;1.11&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_name</span> <span class="o">=</span> <span class="s">&quot;TX39/49 Serial driver&quot;</span><span class="p">;</span>

<span class="cp">#define PASS_LIMIT	256</span>

<span class="cp">#if !defined(CONFIG_SERIAL_TXX9_STDSERIAL)</span>
<span class="cm">/* &quot;ttyS&quot; is used for standard serial driver */</span>
<span class="cp">#define TXX9_TTY_NAME &quot;ttyTX&quot;</span>
<span class="cp">#define TXX9_TTY_MINOR_START	196</span>
<span class="cp">#define TXX9_TTY_MAJOR	204</span>
<span class="cp">#else</span>
<span class="cm">/* acts like standard serial driver */</span>
<span class="cp">#define TXX9_TTY_NAME &quot;ttyS&quot;</span>
<span class="cp">#define TXX9_TTY_MINOR_START	64</span>
<span class="cp">#define TXX9_TTY_MAJOR	TTY_MAJOR</span>
<span class="cp">#endif</span>

<span class="cm">/* flag aliases */</span>
<span class="cp">#define UPF_TXX9_HAVE_CTS_LINE	UPF_BUGGY_UART</span>
<span class="cp">#define UPF_TXX9_USE_SCLK	UPF_MAGIC_MULTIPLIER</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cm">/* support for Toshiba TC86C001 SIO */</span>
<span class="cp">#define ENABLE_SERIAL_TXX9_PCI</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Number of serial ports</span>
<span class="cm"> */</span>
<span class="cp">#define UART_NR  CONFIG_SERIAL_TXX9_NR_UARTS</span>

<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span>	<span class="n">port</span><span class="p">;</span>
	<span class="cm">/* No additional info for now */</span>
<span class="p">};</span>

<span class="cp">#define TXX9_REGION_SIZE	0x24</span>

<span class="cm">/* TXX9 Serial Registers */</span>
<span class="cp">#define TXX9_SILCR	0x00</span>
<span class="cp">#define TXX9_SIDICR	0x04</span>
<span class="cp">#define TXX9_SIDISR	0x08</span>
<span class="cp">#define TXX9_SICISR	0x0c</span>
<span class="cp">#define TXX9_SIFCR	0x10</span>
<span class="cp">#define TXX9_SIFLCR	0x14</span>
<span class="cp">#define TXX9_SIBGR	0x18</span>
<span class="cp">#define TXX9_SITFIFO	0x1c</span>
<span class="cp">#define TXX9_SIRFIFO	0x20</span>

<span class="cm">/* SILCR : Line Control */</span>
<span class="cp">#define TXX9_SILCR_SCS_MASK	0x00000060</span>
<span class="cp">#define TXX9_SILCR_SCS_IMCLK	0x00000000</span>
<span class="cp">#define TXX9_SILCR_SCS_IMCLK_BG	0x00000020</span>
<span class="cp">#define TXX9_SILCR_SCS_SCLK	0x00000040</span>
<span class="cp">#define TXX9_SILCR_SCS_SCLK_BG	0x00000060</span>
<span class="cp">#define TXX9_SILCR_UEPS	0x00000010</span>
<span class="cp">#define TXX9_SILCR_UPEN	0x00000008</span>
<span class="cp">#define TXX9_SILCR_USBL_MASK	0x00000004</span>
<span class="cp">#define TXX9_SILCR_USBL_1BIT	0x00000000</span>
<span class="cp">#define TXX9_SILCR_USBL_2BIT	0x00000004</span>
<span class="cp">#define TXX9_SILCR_UMODE_MASK	0x00000003</span>
<span class="cp">#define TXX9_SILCR_UMODE_8BIT	0x00000000</span>
<span class="cp">#define TXX9_SILCR_UMODE_7BIT	0x00000001</span>

<span class="cm">/* SIDICR : DMA/Int. Control */</span>
<span class="cp">#define TXX9_SIDICR_TDE	0x00008000</span>
<span class="cp">#define TXX9_SIDICR_RDE	0x00004000</span>
<span class="cp">#define TXX9_SIDICR_TIE	0x00002000</span>
<span class="cp">#define TXX9_SIDICR_RIE	0x00001000</span>
<span class="cp">#define TXX9_SIDICR_SPIE	0x00000800</span>
<span class="cp">#define TXX9_SIDICR_CTSAC	0x00000600</span>
<span class="cp">#define TXX9_SIDICR_STIE_MASK	0x0000003f</span>
<span class="cp">#define TXX9_SIDICR_STIE_OERS		0x00000020</span>
<span class="cp">#define TXX9_SIDICR_STIE_CTSS		0x00000010</span>
<span class="cp">#define TXX9_SIDICR_STIE_RBRKD	0x00000008</span>
<span class="cp">#define TXX9_SIDICR_STIE_TRDY		0x00000004</span>
<span class="cp">#define TXX9_SIDICR_STIE_TXALS	0x00000002</span>
<span class="cp">#define TXX9_SIDICR_STIE_UBRKD	0x00000001</span>

<span class="cm">/* SIDISR : DMA/Int. Status */</span>
<span class="cp">#define TXX9_SIDISR_UBRK	0x00008000</span>
<span class="cp">#define TXX9_SIDISR_UVALID	0x00004000</span>
<span class="cp">#define TXX9_SIDISR_UFER	0x00002000</span>
<span class="cp">#define TXX9_SIDISR_UPER	0x00001000</span>
<span class="cp">#define TXX9_SIDISR_UOER	0x00000800</span>
<span class="cp">#define TXX9_SIDISR_ERI	0x00000400</span>
<span class="cp">#define TXX9_SIDISR_TOUT	0x00000200</span>
<span class="cp">#define TXX9_SIDISR_TDIS	0x00000100</span>
<span class="cp">#define TXX9_SIDISR_RDIS	0x00000080</span>
<span class="cp">#define TXX9_SIDISR_STIS	0x00000040</span>
<span class="cp">#define TXX9_SIDISR_RFDN_MASK	0x0000001f</span>

<span class="cm">/* SICISR : Change Int. Status */</span>
<span class="cp">#define TXX9_SICISR_OERS	0x00000020</span>
<span class="cp">#define TXX9_SICISR_CTSS	0x00000010</span>
<span class="cp">#define TXX9_SICISR_RBRKD	0x00000008</span>
<span class="cp">#define TXX9_SICISR_TRDY	0x00000004</span>
<span class="cp">#define TXX9_SICISR_TXALS	0x00000002</span>
<span class="cp">#define TXX9_SICISR_UBRKD	0x00000001</span>

<span class="cm">/* SIFCR : FIFO Control */</span>
<span class="cp">#define TXX9_SIFCR_SWRST	0x00008000</span>
<span class="cp">#define TXX9_SIFCR_RDIL_MASK	0x00000180</span>
<span class="cp">#define TXX9_SIFCR_RDIL_1	0x00000000</span>
<span class="cp">#define TXX9_SIFCR_RDIL_4	0x00000080</span>
<span class="cp">#define TXX9_SIFCR_RDIL_8	0x00000100</span>
<span class="cp">#define TXX9_SIFCR_RDIL_12	0x00000180</span>
<span class="cp">#define TXX9_SIFCR_RDIL_MAX	0x00000180</span>
<span class="cp">#define TXX9_SIFCR_TDIL_MASK	0x00000018</span>
<span class="cp">#define TXX9_SIFCR_TDIL_MASK	0x00000018</span>
<span class="cp">#define TXX9_SIFCR_TDIL_1	0x00000000</span>
<span class="cp">#define TXX9_SIFCR_TDIL_4	0x00000001</span>
<span class="cp">#define TXX9_SIFCR_TDIL_8	0x00000010</span>
<span class="cp">#define TXX9_SIFCR_TDIL_MAX	0x00000010</span>
<span class="cp">#define TXX9_SIFCR_TFRST	0x00000004</span>
<span class="cp">#define TXX9_SIFCR_RFRST	0x00000002</span>
<span class="cp">#define TXX9_SIFCR_FRSTE	0x00000001</span>
<span class="cp">#define TXX9_SIO_TX_FIFO	8</span>
<span class="cp">#define TXX9_SIO_RX_FIFO	16</span>

<span class="cm">/* SIFLCR : Flow Control */</span>
<span class="cp">#define TXX9_SIFLCR_RCS	0x00001000</span>
<span class="cp">#define TXX9_SIFLCR_TES	0x00000800</span>
<span class="cp">#define TXX9_SIFLCR_RTSSC	0x00000200</span>
<span class="cp">#define TXX9_SIFLCR_RSDE	0x00000100</span>
<span class="cp">#define TXX9_SIFLCR_TSDE	0x00000080</span>
<span class="cp">#define TXX9_SIFLCR_RTSTL_MASK	0x0000001e</span>
<span class="cp">#define TXX9_SIFLCR_RTSTL_MAX	0x0000001e</span>
<span class="cp">#define TXX9_SIFLCR_TBRK	0x00000001</span>

<span class="cm">/* SIBGR : Baudrate Control */</span>
<span class="cp">#define TXX9_SIBGR_BCLK_MASK	0x00000300</span>
<span class="cp">#define TXX9_SIBGR_BCLK_T0	0x00000000</span>
<span class="cp">#define TXX9_SIBGR_BCLK_T2	0x00000100</span>
<span class="cp">#define TXX9_SIBGR_BCLK_T4	0x00000200</span>
<span class="cp">#define TXX9_SIBGR_BCLK_T6	0x00000300</span>
<span class="cp">#define TXX9_SIBGR_BRD_MASK	0x000000ff</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sio_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">UPIO_PORT</span>:
		<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">sio_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UPIO_PORT</span>:
		<span class="n">outl</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">sio_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">sio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">sio_quot_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">quot</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIBGR</span><span class="p">,</span> <span class="n">quot</span> <span class="o">|</span> <span class="n">TXX9_SIBGR_BCLK_T0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIBGR</span><span class="p">,</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXX9_SIBGR_BCLK_T2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIBGR</span><span class="p">,</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXX9_SIBGR_BCLK_T4</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIBGR</span><span class="p">,</span> <span class="p">(</span><span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXX9_SIBGR_BCLK_T6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIBGR</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">|</span> <span class="n">TXX9_SIBGR_BCLK_T6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="nf">to_uart_txx9_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uart_txx9_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">TXX9_SIDICR_TIE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">TXX9_SIDICR_TIE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXX9_SIDISR_RDIS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TXX9-SIO can not control DTR... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span> <span class="n">TXX9_SIFCR_SWRST</span><span class="p">);</span>
	<span class="cm">/* TX4925 BUG WORKAROUND.  Accessing SIOC register</span>
<span class="cm">	 * immediately after soft reset causes bus error. */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SIFCR_SWRST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tmout</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* TX Int by FIFO Empty, RX Int by Receiving 1 char. */</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span>
		<span class="n">TXX9_SIFCR_TDIL_MAX</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RDIL_1</span><span class="p">);</span>
	<span class="cm">/* initial settings */</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SILCR</span><span class="p">,</span>
		<span class="n">TXX9_SILCR_UMODE_8BIT</span> <span class="o">|</span> <span class="n">TXX9_SILCR_USBL_1BIT</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_TXX9_USE_SCLK</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">TXX9_SILCR_SCS_SCLK_BG</span> <span class="o">:</span> <span class="n">TXX9_SILCR_SCS_IMCLK_BG</span><span class="p">));</span>
	<span class="n">sio_quot_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">uart_get_divisor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">9600</span><span class="p">));</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_RTSTL_MAX</span> <span class="cm">/* 15 */</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disr</span> <span class="o">=</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_ignore_status_mask</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIRFIFO</span><span class="p">);</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* mask out RFDN_MASK bit added by previous overrun */</span>
		<span class="n">next_ignore_status_mask</span> <span class="o">=</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXX9_SIDISR_RFDN_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_SIDISR_UBRK</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_UPER</span> <span class="o">|</span>
				     <span class="n">TXX9_SIDISR_UFER</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_UOER</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For statistics only</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UBRK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">disr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TXX9_SIDISR_UFER</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_UPER</span><span class="p">);</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * We do the SysRQ and SAK checking</span>
<span class="cm">				 * here because otherwise the break</span>
<span class="cm">				 * may get masked by ignore_status_mask</span>
<span class="cm">				 * or read_status_mask.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UPER</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UFER</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UOER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * The receiver read buffer still hold</span>
<span class="cm">				 * a char which caused overrun.</span>
<span class="cm">				 * Ignore next char by adding RFDN_MASK</span>
<span class="cm">				 * to ignore_status_mask temporarily.</span>
<span class="cm">				 */</span>
				<span class="n">next_ignore_status_mask</span> <span class="o">|=</span>
					<span class="n">TXX9_SIDISR_RFDN_MASK</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mask off conditions which should be ingored.</span>
<span class="cm">			 */</span>
			<span class="n">disr</span> <span class="o">&amp;=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UBRK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UPER</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UFER</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>

		<span class="n">uart_insert_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">disr</span><span class="p">,</span> <span class="n">TXX9_SIDISR_UOER</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

	<span class="nl">ignore_char:</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="n">next_ignore_status_mask</span><span class="p">;</span>
		<span class="n">disr</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UVALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max_count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">disr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SITFIFO</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">serial_txx9_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">TXX9_SIO_TX_FIFO</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SITFIFO</span><span class="p">,</span> <span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
		<span class="n">serial_txx9_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">serial_txx9_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pass_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDICR_TIE</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXX9_SIDISR_TDIS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_SIDISR_TDIS</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_RDIS</span> <span class="o">|</span>
				<span class="n">TXX9_SIDISR_TOUT</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_RDIS</span><span class="p">)</span>
			<span class="n">receive_chars</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_TDIS</span><span class="p">)</span>
			<span class="n">transmit_chars</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="cm">/* Clear TX/RX Int. Status */</span>
		<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">,</span>
			 <span class="n">TXX9_SIDISR_TDIS</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_RDIS</span> <span class="o">|</span>
			 <span class="n">TXX9_SIDISR_TOUT</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pass_counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">PASS_LIMIT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pass_counter</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_txx9_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SICISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SICISR_TXALS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_txx9_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* no modem control lines */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">TIOCM_CAR</span> <span class="o">|</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SIFLCR_RTSSC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SICISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SICISR_CTSS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_RTSSC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_RTSSC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_TBRK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_TBRK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SERIAL_TXX9_CONSOLE) || defined(CONFIG_CONSOLE_POLL)</span>
<span class="cm">/*</span>
<span class="cm"> *	Wait for transmitter &amp; holding register to empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_xmitr</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="cm">/* Wait up to 10ms for the character(s) to be sent. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tmout</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SICISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SICISR_TXALS</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Wait up to 1s for flow control if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_CONS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmout</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tmout</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SICISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SICISR_CTSS</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
<span class="cm">/*</span>
<span class="cm"> * Console polling routines for writing and reading from the uart while</span>
<span class="cm"> * in an interrupt or debug context.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_get_poll_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	First save the IER then disable the interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_SIDISR_UVALID</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIRFIFO</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Finally, clear RX interrupt status</span>
<span class="cm">	 *	and restore the IER</span>
<span class="cm">	 */</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">,</span> <span class="n">TXX9_SIDISR_RDIS</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_put_poll_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	First save the IER then disable the interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Send the character out.</span>
<span class="cm">	 *	If a LF, also do CR...</span>
<span class="cm">	 */</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SITFIFO</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SITFIFO</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Finally, wait for transmitter to become empty</span>
<span class="cm">	 *	and restore the IER</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CONSOLE_POLL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them.</span>
<span class="cm">	 * (they will be reenabled in set_termios())</span>
<span class="cm">	 */</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span>
		<span class="n">TXX9_SIFCR_TFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_FRSTE</span><span class="p">);</span>
	<span class="cm">/* clear reset */</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span>
		 <span class="n">TXX9_SIFCR_TFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_FRSTE</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDISR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">serial_txx9_interrupt</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">serial_txx9_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Enable RX/TX */</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_RSDE</span> <span class="o">|</span> <span class="n">TXX9_SIFLCR_TSDE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">TXX9_SIDICR_RIE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable interrupts from this port</span>
<span class="cm">	 */</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable all intrs */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">serial_txx9_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable break condition</span>
<span class="cm">	 */</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_TBRK</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SERIAL_TXX9_CONSOLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">cons</span> <span class="o">&amp;&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">==</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">cons</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* reset FIFOs */</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span>
		<span class="n">TXX9_SIFCR_TFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_FRSTE</span><span class="p">);</span>
	<span class="cm">/* clear reset */</span>
	<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span>
		 <span class="n">TXX9_SIFCR_TFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RFRST</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_FRSTE</span><span class="p">);</span>

	<span class="cm">/* Disable RX/TX */</span>
	<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">TXX9_SIFLCR_RSDE</span> <span class="o">|</span> <span class="n">TXX9_SIFLCR_TSDE</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_txx9_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cval</span><span class="p">,</span> <span class="n">fcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t support modem control lines.</span>
<span class="cm">	 */</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CMSPAR</span><span class="p">);</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">CLOCAL</span><span class="p">;</span>

	<span class="n">cval</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SILCR</span><span class="p">);</span>
	<span class="cm">/* byte size and parity */</span>
	<span class="n">cval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXX9_SILCR_UMODE_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_UMODE_7BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS5</span>:	<span class="cm">/* not supported */</span>
	<span class="k">case</span> <span class="n">CS6</span>:	<span class="cm">/* not supported */</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_UMODE_8BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXX9_SILCR_USBL_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_USBL_2BIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_USBL_1BIT</span><span class="p">;</span>
	<span class="n">cval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TXX9_SILCR_UPEN</span> <span class="o">|</span> <span class="n">TXX9_SILCR_UEPS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_UPEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">TXX9_SILCR_UEPS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ask the core to calculate the divisor for us.</span>
<span class="cm">	 */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="o">/</span><span class="mi">16</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">quot</span> <span class="o">=</span> <span class="n">uart_get_divisor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* Set up FIFOs */</span>
	<span class="cm">/* TX Int by FIFO Empty, RX Int by Receiving 1 char. */</span>
	<span class="n">fcr</span> <span class="o">=</span> <span class="n">TXX9_SIFCR_TDIL_MAX</span> <span class="o">|</span> <span class="n">TXX9_SIFCR_RDIL_1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, we&#39;re now changing the port state.  Do it with</span>
<span class="cm">	 * interrupts disabled.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the per-port timeout.</span>
<span class="cm">	 */</span>
	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">TXX9_SIDISR_UOER</span> <span class="o">|</span>
		<span class="n">TXX9_SIDISR_TDIS</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_RDIS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_UFER</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_UPER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_UBRK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characteres to ignore</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_UPER</span> <span class="o">|</span> <span class="n">TXX9_SIDISR_UFER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_UBRK</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns too (for real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_UOER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore all characters if CREAD is not set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">TXX9_SIDISR_RDIS</span><span class="p">;</span>

	<span class="cm">/* CTS flow control flag */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_TXX9_HAVE_CTS_LINE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sio_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span>
			<span class="n">TXX9_SIFLCR_RCS</span> <span class="o">|</span> <span class="n">TXX9_SIFLCR_TES</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sio_mask</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span>
			 <span class="n">TXX9_SIFLCR_RCS</span> <span class="o">|</span> <span class="n">TXX9_SIFLCR_TES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SILCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>
	<span class="n">sio_quot_set</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>

	<span class="n">serial_txx9_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mctrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_txx9_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If oldstate was -1 this is called from</span>
<span class="cm">	 * uart_configure_port().  In this case do not initialize the</span>
<span class="cm">	 * port now, because the port was already initialized (for</span>
<span class="cm">	 * non-console port) or should not be initialized here (for</span>
<span class="cm">	 * console port).  If we initialized the port here we lose</span>
<span class="cm">	 * serial console settings.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldstate</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">serial_txx9_initialize</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_request_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">TXX9_REGION_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_IOREMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UPIO_PORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_release_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">TXX9_REGION_SIZE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_IOREMAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">);</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UPIO_PORT</span>:
		<span class="n">release_region</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">serial_txx9_release_resource</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">serial_txx9_request_resource</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the region that we can probe for.  This in turn</span>
<span class="cm">	 * tells us whether we can probe for the type of port.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">serial_txx9_request_resource</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_TXX9</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="n">TXX9_SIO_TX_FIFO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SERIAL_TXX9_CONSOLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">==</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">cons</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">serial_txx9_initialize</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">serial_txx9_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;txx9&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">serial_txx9_pops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">serial_txx9_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">serial_txx9_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">serial_txx9_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">serial_txx9_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">serial_txx9_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">serial_txx9_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">serial_txx9_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">serial_txx9_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">serial_txx9_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">serial_txx9_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">serial_txx9_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="n">serial_txx9_pm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">serial_txx9_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">serial_txx9_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">serial_txx9_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">serial_txx9_config_port</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
	<span class="p">.</span><span class="n">poll_get_char</span>	<span class="o">=</span> <span class="n">serial_txx9_get_poll_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_put_char</span>	<span class="o">=</span> <span class="n">serial_txx9_put_poll_char</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">UART_NR</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">serial_txx9_register_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_pops</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">||</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">)</span>
			<span class="n">uart_add_one_port</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SERIAL_TXX9_CONSOLE</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">serial_txx9_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">to_uart_txx9_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SITFIFO</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Print a string to the serial port trying not to disturb</span>
<span class="cm"> *	any possible real use of the port...</span>
<span class="cm"> *</span>
<span class="cm"> *	The console_lock must be held when we get here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_txx9_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ier</span><span class="p">,</span> <span class="n">flcr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	First save the UER then disable the interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Disable flow-control if enabled (and unnecessary)</span>
<span class="cm">	 */</span>
	<span class="n">flcr</span> <span class="o">=</span> <span class="n">sio_in</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_CONS_FLOW</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flcr</span> <span class="o">&amp;</span> <span class="n">TXX9_SIFLCR_TES</span><span class="p">))</span>
		<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">flcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXX9_SIFLCR_TES</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">serial_txx9_console_putchar</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Finally, wait for transmitter to become empty</span>
<span class="cm">	 *	and restore the IER</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_xmitr</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIFLCR</span><span class="p">,</span> <span class="n">flcr</span><span class="p">);</span>
	<span class="n">sio_out</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">TXX9_SIDICR</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">serial_txx9_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether an invalid uart number has been specified, and</span>
<span class="cm">	 * if so, search for the first available port that does have</span>
<span class="cm">	 * console support.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">UART_NR</span><span class="p">)</span>
		<span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">serial_txx9_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">serial_txx9_reg</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">serial_txx9_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">TXX9_TTY_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">serial_txx9_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">serial_txx9_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">serial_txx9_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">serial_txx9_console_init</span><span class="p">);</span>

<span class="cp">#define SERIAL_TXX9_CONSOLE	&amp;serial_txx9_console</span>
<span class="cp">#else</span>
<span class="cp">#define SERIAL_TXX9_CONSOLE	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">serial_txx9_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>		<span class="o">=</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>		<span class="o">=</span> <span class="n">TXX9_TTY_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>			<span class="o">=</span> <span class="n">TXX9_TTY_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span>			<span class="o">=</span> <span class="n">TXX9_TTY_MINOR_START</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>			<span class="o">=</span> <span class="n">UART_NR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cons</span>			<span class="o">=</span> <span class="n">SERIAL_TXX9_CONSOLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_serial_txx9_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">serial_txx9_ports</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_pops</span><span class="p">;</span>
	<span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">UPF_BOOT_AUTOCONF</span> <span class="o">|</span> <span class="n">UPF_FIXED_PORT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">serial_txx9_mutex</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	serial_txx9_register_port - register a serial port</span>
<span class="cm"> *	@port: serial port template</span>
<span class="cm"> *</span>
<span class="cm"> *	Configure the serial port specified by the request.</span>
<span class="cm"> *</span>
<span class="cm"> *	The port is then probed and if necessary the IRQ is autodetected</span>
<span class="cm"> *	If this fails an error is returned.</span>
<span class="cm"> *</span>
<span class="cm"> *	On success the port is ready to use and the line number is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">serial_txx9_register_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_match_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">UART_NR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Find unused port */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">||</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span>      <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span>  <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span>   <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">iotype</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span>
			<span class="o">|</span> <span class="n">UPF_BOOT_AUTOCONF</span> <span class="o">|</span> <span class="n">UPF_FIXED_PORT</span><span class="p">;</span>
		<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span>  <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	serial_txx9_unregister_port - remove a txx9 serial port at runtime</span>
<span class="cm"> *	@line: serial line number</span>
<span class="cm"> *</span>
<span class="cm"> *	Remove one serial port.  This may not be called from interrupt</span>
<span class="cm"> *	context.  We hand the port back to the our control.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">serial_txx9_unregister_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">uart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">line</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_mutex</span><span class="p">);</span>
	<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_UNKNOWN</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">uart</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register a set of serial devices attached to a platform device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">serial_txx9_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">membase</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iotype</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">;</span>
		<span class="n">port</span><span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">serial_txx9_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register port at index %d &quot;</span>
				<span class="s">&quot;(IO%lx MEM%llx IRQ%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove serial ports registered against a platform device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">serial_txx9_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">serial_txx9_unregister_port</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serial_txx9_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">serial_txx9_plat_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">serial_txx9_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">serial_txx9_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">serial_txx9_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">serial_txx9_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef ENABLE_SERIAL_TXX9_PCI</span>
<span class="cm">/*</span>
<span class="cm"> * Probe one serial board.  Unfortunately, there is no rhyme nor reason</span>
<span class="cm"> * to the arrangement of serial ports on a PCI card.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">pciserial_txx9_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_pops</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">UPF_TXX9_HAVE_CTS_LINE</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="mi">66670000</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_PORT</span><span class="p">;</span>
	<span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">serial_txx9_register_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Couldn&#39;t register serial port %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">line</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">line</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">line</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pciserial_txx9_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serial_txx9_unregister_port</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pciserial_txx9_suspend_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">uart_suspend_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pciserial_txx9_resume_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">uart_resume_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">serial_txx9_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOSHIBA_2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TOSHIBA_TC86C001_MISC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">serial_txx9_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;serial_txx9&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pciserial_txx9_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pciserial_txx9_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pciserial_txx9_suspend_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pciserial_txx9_resume_one</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">serial_txx9_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">serial_txx9_pci_tbl</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ENABLE_SERIAL_TXX9_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">serial_txx9_plat_devs</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">serial_txx9_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

 	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_name</span><span class="p">,</span> <span class="n">serial_version</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">serial_txx9_plat_devs</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;serial_txx9&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_txx9_plat_devs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unreg_uart_drv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">serial_txx9_plat_devs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_dev</span><span class="p">;</span>

	<span class="n">serial_txx9_register_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">serial_txx9_plat_devs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_plat_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">del_dev</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_SERIAL_TXX9_PCI</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

 <span class="nl">del_dev:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">serial_txx9_plat_devs</span><span class="p">);</span>
 <span class="nl">put_dev:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">serial_txx9_plat_devs</span><span class="p">);</span>
 <span class="nl">unreg_uart_drv:</span>
	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">serial_txx9_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef ENABLE_SERIAL_TXX9_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_plat_driver</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">serial_txx9_plat_devs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uart_txx9_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial_txx9_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iobase</span> <span class="o">||</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span><span class="p">)</span>
			<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_txx9_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">serial_txx9_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">serial_txx9_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TX39/49 serial driver&quot;</span><span class="p">);</span>

<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">TXX9_TTY_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
