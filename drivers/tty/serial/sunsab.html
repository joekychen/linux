<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › serial › sunsab.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sunsab.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sunsab.c: ASYNC Driver for the SIEMENS SAB82532 DUSCC.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997  Eddie C. Dost  (ecd@skynet.be)</span>
<span class="cm"> * Copyright (C) 2002, 2006  David S. Miller (davem@davemloft.net)</span>
<span class="cm"> *</span>
<span class="cm"> * Rewrote buffer handling to use CIRC(Circular Buffer) macros.</span>
<span class="cm"> *   Maxim Krasnyanskiy &lt;maxk@qualcomm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed to use tty_get_baud_rate, and to allow for arbitrary baud</span>
<span class="cm"> * rates to be programmed into the UART.  Also eliminated a lot of</span>
<span class="cm"> * duplicated code in the console setup.</span>
<span class="cm"> *   Theodore Ts&#39;o &lt;tytso@mit.edu&gt;, 2001-Oct-12</span>
<span class="cm"> *</span>
<span class="cm"> * Ported to new 2.5.x UART layer.</span>
<span class="cm"> *   David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cp">#if defined(CONFIG_SERIAL_SUNSAB_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/sunserialcore.h&gt;</span>

<span class="cp">#include &quot;sunsab.h&quot;</span>

<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_port</span>		<span class="n">port</span><span class="p">;</span>		<span class="cm">/* Generic UART port	*/</span>
	<span class="k">union</span> <span class="n">sab82532_async_regs</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>	<span class="cm">/* Chip registers	*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">irqflags</span><span class="p">;</span>	<span class="cm">/* IRQ state flags	*/</span>
	<span class="kt">int</span>				<span class="n">dsr</span><span class="p">;</span>		<span class="cm">/* Current DSR state	*/</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">cec_timeout</span><span class="p">;</span>	<span class="cm">/* Chip poll timeout... */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">tec_timeout</span><span class="p">;</span>	<span class="cm">/* likewise		*/</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">interrupt_mask0</span><span class="p">;</span><span class="cm">/* ISR0 masking		*/</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">interrupt_mask1</span><span class="p">;</span><span class="cm">/* ISR1 masking		*/</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">pvr_dtr_bit</span><span class="p">;</span>	<span class="cm">/* Which PVR bit is DTR */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">pvr_dsr_bit</span><span class="p">;</span>	<span class="cm">/* Which PVR bit is DSR */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">gis_shift</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">type</span><span class="p">;</span>		<span class="cm">/* SAB82532 version	*/</span>

	<span class="cm">/* Setting configuration bits while the transmitter is active</span>
<span class="cm">	 * can cause garbage characters to get emitted by the chip.</span>
<span class="cm">	 * Therefore, we cache such writes here and do the real register</span>
<span class="cm">	 * write the next time the transmitter becomes idle.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">cached_ebrg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">cached_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">cached_pvr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>			<span class="n">cached_dafo</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This assumes you have a 29.4912 MHz clock for your UART.</span>
<span class="cm"> */</span>
<span class="cp">#define SAB_BASE_BAUD ( 29491200 / 16 )</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sab82532_version</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;V1.0&quot;</span><span class="p">,</span> <span class="s">&quot;V2.0&quot;</span><span class="p">,</span> <span class="s">&quot;V3.2&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x03)&quot;</span><span class="p">,</span>
	<span class="s">&quot;V(0x04)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x05)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x06)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x07)&quot;</span><span class="p">,</span>
	<span class="s">&quot;V(0x08)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x09)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x0a)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x0b)&quot;</span><span class="p">,</span>
	<span class="s">&quot;V(0x0c)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x0d)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x0e)&quot;</span><span class="p">,</span> <span class="s">&quot;V(0x0f)&quot;</span>
<span class="p">};</span>

<span class="cp">#define SAB82532_MAX_TEC_TIMEOUT 200000	</span><span class="cm">/* 1 character time (at 50 baud) */</span><span class="cp"></span>
<span class="cp">#define SAB82532_MAX_CEC_TIMEOUT  50000	</span><span class="cm">/* 2.5 TX CLKs (at 50 baud) */</span><span class="cp"></span>

<span class="cp">#define SAB82532_RECV_FIFO_SIZE	32      </span><span class="cm">/* Standard async fifo sizes */</span><span class="cp"></span>
<span class="cp">#define SAB82532_XMIT_FIFO_SIZE	32</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">sunsab_tec_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">tec_timeout</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">star</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAB82532_STAR_TEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">sunsab_cec_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">cec_timeout</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">star</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAB82532_STAR_CEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span>
<span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span>
	      <span class="k">union</span> <span class="n">sab82532_irq_status</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">saw_console_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>		<span class="cm">/* Unopened serial console */</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>

	<span class="cm">/* Read number of BYTES (Character + Status) available. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_RPF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">SAB82532_RECV_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">free_fifo</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_TCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rbcl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAB82532_RECV_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">free_fifo</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue a FIFO read command in case we where idle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_TIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_RFRD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">tty</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_RFO</span><span class="p">)</span>
		<span class="n">free_fifo</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Read the FIFO. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Issue Receive Message Complete command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_RMC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Count may be zero for BRK, so we check for it here */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_BRK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">==</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">cons</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="n">saw_console_brk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">flag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAB82532_ISR0_PERR</span> <span class="o">|</span>
						<span class="n">SAB82532_ISR0_FERR</span> <span class="o">|</span>
						<span class="n">SAB82532_ISR0_RFO</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">unlikely</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_BRK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For statistics only</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_BRK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SAB82532_ISR0_PERR</span> <span class="o">|</span>
						     <span class="n">SAB82532_ISR0_FERR</span><span class="p">);</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * We do the SysRQ and SAK checking</span>
<span class="cm">				 * here because otherwise the break</span>
<span class="cm">				 * may get masked by ignore_status_mask</span>
<span class="cm">				 * or read_status_mask.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_PERR</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_FERR</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_RFO</span><span class="p">)</span>
				<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mask off conditions which should be ingored.</span>
<span class="cm">			 */</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_BRK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_PERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_FERR</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_RFO</span><span class="p">)</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saw_console_brk</span><span class="p">)</span>
		<span class="n">sun_do_break</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">tty</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sunsab_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sunsab_tx_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">sab82532_irq_status</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_ALLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">|=</span> <span class="n">SAB82532_IMR1_ALLS</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_ALLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* bde@nwlink.com says this check causes problems */</span>
<span class="c">	if (!(stat-&gt;sreg.isr1 &amp; SAB82532_ISR1_XPR))</span>
<span class="c">		return;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">star</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAB82532_STAR_XFW</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="n">sunsab_tx_idle</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span> <span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">|=</span> <span class="n">SAB82532_IMR1_XPR</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SAB82532_IMR1_ALLS</span><span class="o">|</span><span class="n">SAB82532_IMR1_XPR</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SAB82532_ALLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>

	<span class="cm">/* Stuff 32 bytes into Transmit FIFO. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span>
		       <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">xfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue a Transmit Frame command. */</span>
	<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_XF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
		<span class="n">sunsab_stop_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">sab82532_irq_status</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_CDSC</span><span class="p">)</span>
		<span class="n">uart_handle_dcd_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				       <span class="o">!</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">vstr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAB82532_VSTR_CD</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_CSC</span><span class="p">)</span>
		<span class="n">uart_handle_cts_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">star</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAB82532_STAR_CTS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pvr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dsr_bit</span><span class="p">)</span> <span class="o">^</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pvr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dsr_bit</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sunsab_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sab82532_irq_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gis</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">status</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gis</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">gis</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">gis_shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">isr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">isr1</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAB82532_ISR0_TCD</span> <span class="o">|</span> <span class="n">SAB82532_ISR0_TIME</span> <span class="o">|</span>
					 <span class="n">SAB82532_ISR0_RFO</span> <span class="o">|</span> <span class="n">SAB82532_ISR0_RPF</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_BRK</span><span class="p">))</span>
			<span class="n">tty</span> <span class="o">=</span> <span class="n">receive_chars</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr0</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR0_CDSC</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="n">SAB82532_ISR1_CSC</span><span class="p">))</span>
			<span class="n">check_status</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">sreg</span><span class="p">.</span><span class="n">isr1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAB82532_ISR1_ALLS</span> <span class="o">|</span> <span class="n">SAB82532_ISR1_XPR</span><span class="p">))</span>
			<span class="n">transmit_chars</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sunsab_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Do not need a lock for a state test like this.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_ALLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAB82532_MODE_FRTS</span><span class="p">;</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">|=</span> <span class="n">SAB82532_MODE_RTS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_MODE_FRTS</span> <span class="o">|</span>
				    <span class="n">SAB82532_MODE_RTS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_pvr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dtr_bit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_pvr</span> <span class="o">|=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dtr_bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_REGS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span>
		<span class="n">sunsab_tx_idle</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is held by caller and interrupts are disabled.  */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sunsab_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pvr</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dsr_bit</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">vstr</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SAB82532_VSTR_CD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">star</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SAB82532_STAR_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">|=</span> <span class="n">SAB82532_IMR1_XPR</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_tx_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_REGS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">SAB82532_REGS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_pvr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">pvr</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">dafo</span><span class="p">);</span>

		<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_ebrg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">bgr</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">ccr2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_ebrg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">ccr2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SAB82532_IMR1_ALLS</span><span class="o">|</span><span class="n">SAB82532_IMR1_XPR</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SAB82532_ALLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">],</span>
		       <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">xfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_empty</span><span class="p">(</span><span class="n">xmit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue a Transmit Frame command.  */</span>
	<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_XF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sunsab_tec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">tic</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span> <span class="o">|=</span> <span class="n">SAB82532_IMR0_TCD</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock held by caller.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For now we always receive these interrupts.  */</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SAB82532_DAFO_XBRK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAB82532_DAFO_XBRK</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_REGS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span>
		<span class="n">sunsab_tx_idle</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sunsab_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">sunsab_interrupt</span><span class="p">,</span>
			      <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;sab&quot;</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for any commands or immediate characters</span>
<span class="cm">	 */</span>
	<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">sunsab_tec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers.</span>
<span class="cm">	 */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_RRES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>
	<span class="n">sunsab_cec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CMDR_XRES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">cmdr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">isr0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">isr1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART </span>
<span class="cm">	 */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr0</span><span class="p">);</span>				<span class="cm">/* power-down */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CCR0_MCE</span> <span class="o">|</span> <span class="n">SAB82532_CCR0_SC_NRZ</span> <span class="o">|</span>
	       <span class="n">SAB82532_CCR0_SM_ASYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr0</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CCR1_ODS</span> <span class="o">|</span> <span class="n">SAB82532_CCR1_BCR</span> <span class="o">|</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr1</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CCR2_BDF</span> <span class="o">|</span> <span class="n">SAB82532_CCR2_SSEL</span> <span class="o">|</span>
	       <span class="n">SAB82532_CCR2_TOE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr2</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr3</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_CCR4_MCK4</span> <span class="o">|</span> <span class="n">SAB82532_CCR4_EBRG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ccr4</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAB82532_MODE_RTS</span> <span class="o">|</span> <span class="n">SAB82532_MODE_FCTS</span> <span class="o">|</span>
			   <span class="n">SAB82532_MODE_RAC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_RFC_DPS</span><span class="o">|</span><span class="n">SAB82532_RFC_RFTH_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">rfc</span><span class="p">);</span>
	
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">ccr0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SAB82532_CCR0_PU</span><span class="p">;</span>	<span class="cm">/* power-up */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">ccr0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAB82532_IMR0_PERR</span> <span class="o">|</span> <span class="n">SAB82532_IMR0_FERR</span> <span class="o">|</span>
			       <span class="n">SAB82532_IMR0_PLLA</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr0</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAB82532_IMR1_BRKT</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_ALLS</span> <span class="o">|</span>
			       <span class="n">SAB82532_IMR1_XOFF</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_TIN</span> <span class="o">|</span>
			       <span class="n">SAB82532_IMR1_CSC</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_XON</span> <span class="o">|</span>
			       <span class="n">SAB82532_IMR1_XPR</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_ALLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Disable Interrupts */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr0</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>

	<span class="cm">/* Disable break condition */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">dafo</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAB82532_DAFO_XBRK</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">dafo</span><span class="p">);</span>

	<span class="cm">/* Disable Receiver */</span>	
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAB82532_MODE_RAC</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the chip is powered down here the system hangs/crashes during</span>
<span class="cm">	 * reboot or shutdown.  This needs to be investigated further,</span>
<span class="cm">	 * similar behaviour occurs in 2.4 when the driver is configured</span>
<span class="cm">	 * as a module only.  One hint may be that data is sometimes</span>
<span class="cm">	 * transmitted at 9600 baud during shutdown (regardless of the</span>
<span class="cm">	 * speed the chip was configured for when the port was open).</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Power Down */	</span>
<span class="c">	tmp = readb(&amp;up-&gt;regs-&gt;rw.ccr0);</span>
<span class="c">	tmp &amp;= ~SAB82532_CCR0_PU;</span>
<span class="c">	writeb(tmp, &amp;up-&gt;regs-&gt;rw.ccr0);</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is used to figure out the divisor speeds.</span>
<span class="cm"> *</span>
<span class="cm"> * The formula is:    Baud = SAB_BASE_BAUD / ((N + 1) * (1 &lt;&lt; M)),</span>
<span class="cm"> *</span>
<span class="cm"> * with               0 &lt;= N &lt; 64 and 0 &lt;= M &lt; 16</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_ebrg</span><span class="p">(</span><span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n_ret</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">m_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">n_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">m_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
     
	<span class="cm">/*</span>
<span class="cm">	 * We scale numbers by 10 so that we get better accuracy</span>
<span class="cm">	 * without having to use floating point.  Here we increment m</span>
<span class="cm">	 * until n is within the valid range.</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAB_BASE_BAUD</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">640</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We try very hard to avoid speeds with M == 0 since they may</span>
<span class="cm">	 * not work correctly for XTAL frequences above 10 MHz.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">m</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">n_ret</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">m_ret</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Internal routine, port-&gt;lock is held and local interrupts are disabled.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_convert_to_sab</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iflag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">quot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dafo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="cm">/* Byte size and parity */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">CS5</span>: <span class="n">dafo</span> <span class="o">=</span> <span class="n">SAB82532_DAFO_CHL5</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS6</span>: <span class="n">dafo</span> <span class="o">=</span> <span class="n">SAB82532_DAFO_CHL6</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS7</span>: <span class="n">dafo</span> <span class="o">=</span> <span class="n">SAB82532_DAFO_CHL7</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS8</span>: <span class="n">dafo</span> <span class="o">=</span> <span class="n">SAB82532_DAFO_CHL8</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="cm">/* Never happens, but GCC is too dumb to figure it out */</span>
	      <span class="nl">default:</span>  <span class="n">dafo</span> <span class="o">=</span> <span class="n">SAB82532_DAFO_CHL5</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dafo</span> <span class="o">|=</span> <span class="n">SAB82532_DAFO_STOP</span><span class="p">;</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dafo</span> <span class="o">|=</span> <span class="n">SAB82532_DAFO_PARE</span><span class="p">;</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dafo</span> <span class="o">|=</span> <span class="n">SAB82532_DAFO_PAR_ODD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dafo</span> <span class="o">|=</span> <span class="n">SAB82532_DAFO_PAR_EVEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_dafo</span> <span class="o">=</span> <span class="n">dafo</span><span class="p">;</span>

	<span class="n">calc_ebrg</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_ebrg</span> <span class="o">=</span> <span class="n">n</span> <span class="o">|</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">tec_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cec_timeout</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">tec_timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* CTS flow control flags */</span>
	<span class="cm">/* We encode read_status_mask and ignore_status_mask like so:</span>
<span class="cm">	 *</span>
<span class="cm">	 * ---------------------</span>
<span class="cm">	 * | ... | ISR1 | ISR0 |</span>
<span class="cm">	 * ---------------------</span>
<span class="cm">	 *  ..    15   8 7    0</span>
<span class="cm">	 */</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAB82532_ISR0_TCD</span> <span class="o">|</span> <span class="n">SAB82532_ISR0_TIME</span> <span class="o">|</span>
				     <span class="n">SAB82532_ISR0_RFO</span> <span class="o">|</span> <span class="n">SAB82532_ISR0_RPF</span> <span class="o">|</span>
				     <span class="n">SAB82532_ISR0_CDSC</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR1_CSC</span> <span class="o">|</span>
				      <span class="n">SAB82532_ISR1_ALLS</span> <span class="o">|</span>
				      <span class="n">SAB82532_ISR1_XPR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR0_PERR</span> <span class="o">|</span>
					      <span class="n">SAB82532_ISR0_FERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR1_BRK</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characteres to ignore</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR0_PERR</span> <span class="o">|</span>
						<span class="n">SAB82532_ISR0_FERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR1_BRK</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns too (for real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">SAB82532_ISR0_RFO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore all characters if CREAD is not set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SAB82532_ISR0_RPF</span> <span class="o">|</span>
						<span class="n">SAB82532_ISR0_TCD</span><span class="p">);</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">cflag</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">quot</span><span class="p">)));</span>

	<span class="cm">/* Now schedule a register update when the chip&#39;s</span>
<span class="cm">	 * transmitter is idle.</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">|=</span> <span class="n">SAB82532_MODE_RAC</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">SAB82532_REGS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAB82532_XPR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">irqflags</span><span class="p">))</span>
		<span class="n">sunsab_tx_idle</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* port-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">termios</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4000000</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">quot</span> <span class="o">=</span> <span class="n">uart_get_divisor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sunsab_convert_to_sab</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sunsab_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
	
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;SAB82532 %s&quot;</span><span class="p">,</span> <span class="n">sab82532_version</span><span class="p">[</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sunsab_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sunsab_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ser</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">sunsab_pops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">sunsab_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">sunsab_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">sunsab_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">sunsab_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">sunsab_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span>	<span class="o">=</span> <span class="n">sunsab_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">sunsab_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">sunsab_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">sunsab_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">sunsab_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sunsab_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">sunsab_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">sunsab_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">sunsab_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">sunsab_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">sunsab_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">sunsab_verify_port</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">sunsab_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>		<span class="o">=</span> <span class="s">&quot;sunsab&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>		<span class="o">=</span> <span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>			<span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">sunsab_ports</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SERIAL_SUNSAB_CONSOLE</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_console_putchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="n">sunsab_tec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">tic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sunsab_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sunsab_ports</span><span class="p">[</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">sysrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oops_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">uart_console_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sunsab_console_putchar</span><span class="p">);</span>
	<span class="n">sunsab_tec_wait</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sunsab_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sunsab_ports</span><span class="p">[</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The console framework calls us for each and every port</span>
<span class="cm">	 * registered. Defer the console setup until the requested</span>
<span class="cm">	 * port has been properly discovered. A bit of a hack,</span>
<span class="cm">	 * though...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_SUNSAB</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Console: ttyS%d (SAB82532)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">sunsab_reg</span><span class="p">.</span><span class="n">minor</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">sunserial_console_termios</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B150</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B300</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B600</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B1200</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B2400</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">2400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B4800</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">case</span> <span class="n">B9600</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B19200</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">19200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B38400</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B57600</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B115200</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B230400</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B460800</span>: <span class="n">baud</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * Temporary fix.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the hardware</span>
<span class="cm">	 */</span>
	<span class="n">sunsab_startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span> <span class="o">=</span> <span class="n">SAB82532_IMR0_PERR</span> <span class="o">|</span> <span class="n">SAB82532_IMR0_FERR</span> <span class="o">|</span>
				<span class="n">SAB82532_IMR0_PLLA</span> <span class="o">|</span> <span class="n">SAB82532_IMR0_CDSC</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr0</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span> <span class="o">=</span> <span class="n">SAB82532_IMR1_BRKT</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_ALLS</span> <span class="o">|</span>
				<span class="n">SAB82532_IMR1_XOFF</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_TIN</span> <span class="o">|</span>
				<span class="n">SAB82532_IMR1_CSC</span> <span class="o">|</span> <span class="n">SAB82532_IMR1_XON</span> <span class="o">|</span>
				<span class="n">SAB82532_IMR1_XPR</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">interrupt_mask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">imr1</span><span class="p">);</span>

	<span class="n">quot</span> <span class="o">=</span> <span class="n">uart_get_divisor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	<span class="n">sunsab_convert_to_sab</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">con</span><span class="o">-&gt;</span><span class="n">cflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>
	<span class="n">sunsab_set_mctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">sunsab_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span>	<span class="s">&quot;ttyS&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span>	<span class="n">sunsab_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span>	<span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>	<span class="o">=</span>	<span class="n">sunsab_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span>	<span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>	<span class="o">=</span>	<span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="nf">SUNSAB_CONSOLE</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sunsab_console</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define SUNSAB_CONSOLE()	(NULL)</span>
<span class="cp">#define sunsab_console_init()	do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sunsab_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">),</span>
				      <span class="s">&quot;sab&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">fifosize</span> <span class="o">=</span> <span class="n">SAB82532_XMIT_FIFO_SIZE</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">SAB82532_IPC_IC_ACT_LOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">ipc</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sunsab_pops</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_SUNSAB</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">SAB_BASE_BAUD</span><span class="p">;</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">vstr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">pcr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">pim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">line</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dsr_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dtr_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">gis_shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dsr_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">pvr_dtr_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">up</span><span class="o">-&gt;</span><span class="n">gis_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_pvr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_pvr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">pvr</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">|=</span> <span class="n">SAB82532_MODE_FRTS</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span> <span class="o">|=</span> <span class="n">SAB82532_MODE_RTS</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">cached_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">up</span><span class="o">-&gt;</span><span class="n">tec_timeout</span> <span class="o">=</span> <span class="n">SAB82532_MAX_TEC_TIMEOUT</span><span class="p">;</span>
	<span class="n">up</span><span class="o">-&gt;</span><span class="n">cec_timeout</span> <span class="o">=</span> <span class="n">SAB82532_MAX_CEC_TIMEOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sab_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">inst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">up</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sunsab_ports</span><span class="p">[</span><span class="n">inst</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sunsab_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">inst</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sunsab_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">op</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">),</span>
			      <span class="p">(</span><span class="n">inst</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="n">sunserial_console_match</span><span class="p">(</span><span class="n">SUNSAB_CONSOLE</span><span class="p">(),</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span>
				<span class="nb">false</span><span class="p">);</span>

	<span class="n">sunserial_console_match</span><span class="p">(</span><span class="n">SUNSAB_CONSOLE</span><span class="p">(),</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">line</span><span class="p">,</span>
				<span class="nb">false</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">inst</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		   <span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">));</span>
<span class="nl">out1:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		   <span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sab_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_sunsab_port</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
	<span class="n">uart_remove_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		   <span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">));</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		   <span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">port</span><span class="p">.</span><span class="n">membase</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">sab82532_async_regs</span><span class="p">));</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">sab_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;se&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;sab82532&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">sab_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sab_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sab&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">sab_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sab_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sab_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sunsab_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">)</span>
		<span class="n">num_channels</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;sab82532&quot;</span><span class="p">))</span>
			<span class="n">num_channels</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sunsab_ports</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_sunsab_port</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">num_channels</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sunsab_ports</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sunserial_register_minors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sunsab_ports</span><span class="p">);</span>
			<span class="n">sunsab_ports</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sab_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sunsab_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sab_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sunsab_reg</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sunserial_unregister_minors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sunsab_reg</span><span class="p">,</span> <span class="n">sunsab_reg</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sunsab_ports</span><span class="p">);</span>
	<span class="n">sunsab_ports</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sunsab_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sunsab_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eddie C. Dost and David S. Miller&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun SAB82532 serial port driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
